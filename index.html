<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V12 - Ultimate AI & R6</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

    <style>
        :root {
            --primary: #0078d7;
            --bg-light: #f5f7fa;
            --panel-bg: #ffffff;
            --border: #dcdcdc;
            --text: #333;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: #333; height: 100vh; display: flex; flex-direction: column; }

        /* --- TOP BAR --- */
        #top-bar {
            height: 35px; background: var(--primary); color: white; display: flex; align-items: center; padding: 0 15px; font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100;
        }
        .logo { font-weight: 800; margin-right: 20px; letter-spacing: 1px; }
        .menu-btn { margin-right: 15px; cursor: pointer; opacity: 0.8; transition:0.2s; }
        .menu-btn:hover { opacity: 1; font-weight: bold; }

        /* --- RIBBON (ARA√áLAR) --- */
        #ribbon {
            height: 85px; background: var(--panel-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 10px; overflow-x: auto; gap: 8px; flex-shrink: 0;
        }
        .tool-group { display: flex; gap: 5px; padding: 0 10px; border-right: 1px solid #eee; height: 100%; align-items: center; }
        
        .tool-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 55px; height: 65px; border-radius: 5px; cursor: pointer; color: #555;
            transition: 0.2s; border: 1px solid transparent;
        }
        .tool-btn:hover { background: #f0f8ff; border-color: #cce4f7; }
        .tool-btn.active { background: #e3f2fd; border-color: var(--primary); color: var(--primary); }
        .tool-btn span { font-size: 22px; margin-bottom: 4px; }
        .tool-btn label { font-size: 10px; font-weight: 500; }

        /* --- MAIN LAYOUT --- */
        #layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* SOL TOOLBOX */
        #left-panel {
            width: 220px; background: var(--panel-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 10; transition: 0.3s;
        }
        #left-panel.closed { transform: translateX(-100%); margin-right: -220px; }
        
        .panel-header { padding: 8px 12px; background: #f0f0f0; font-weight: bold; font-size: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        
        #parts-grid { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; overflow-y: auto; }
        .part-item {
            background: white; border: 1px solid #eee; border-radius: 6px; padding: 8px;
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: 0.2s;
        }
        .part-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .part-preview { width: 30px; height: 30px; border-radius: 4px; margin-bottom: 5px; }

        /* ORTA EKRAN (VIEWPORT) */
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; }
        
        /* SAƒû PANEL (PROPERTIES) */
        #right-panel {
            width: 250px; background: var(--panel-bg); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 10; transition: 0.3s;
        }
        #right-panel.closed { transform: translateX(100%); margin-left: -250px; }
        
        .prop-list { padding: 10px; overflow-y: auto; flex: 1; }
        .prop-row { margin-bottom: 10px; display: flex; align-items: center; font-size: 11px; }
        .prop-row label { width: 80px; color: #666; }
        .prop-input { flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 3px; }

        /* OYUN KONTROLLERƒ∞ (HUD) */
        #game-ui { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 50; }
        
        #joystick-zone {
            position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px;
            background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.4);
            border-radius: 50%; pointer-events: auto; backdrop-filter: blur(2px);
        }
        #stick {
            position: absolute; top: 50%; left: 50%; width: 60px; height: 60px;
            background: rgba(255,255,255,0.9); border-radius: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        #jump-btn {
            position: absolute; bottom: 60px; right: 40px; width: 90px; height: 90px;
            background: rgba(0,120,215,0.8); border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 30px;
            border: 4px solid rgba(255,255,255,0.5); pointer-events: auto; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #jump-btn:active { transform: scale(0.95); background: rgba(0,120,215,1); }

        /* AI CHAT PENCERESƒ∞ */
        #ai-window {
            position: absolute; bottom: 10px; right: 260px; width: 300px; height: 380px;
            background: white; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            display: none; flex-direction: column; z-index: 100; border: 1px solid #ccc;
            overflow: hidden; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity:0; } to { transform: translateY(0); opacity:1; } }
        
        .ai-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; display:flex; justify-content: space-between; cursor: move; }
        .ai-content { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; font-size: 13px; }
        .ai-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; background: white; }
        .ai-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; }
        .ai-send { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; }
        
        .msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; max-width: 80%; line-height: 1.4; }
        .msg.bot { background: #eef; color: #333; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }

    </style>
</head>
<body onload="App.init()">

    <div id="top-bar">
        <div class="logo">LunX Studio V12</div>
        <div class="menu-btn">Dosya</div>
        <div class="menu-btn">D√ºzenle</div>
        <div class="menu-btn">G√∂r√ºn√ºm</div>
        <div style="flex:1"></div>
        <div style="font-size:11px; opacity:0.7">FPS: <span id="fps-c">60</span></div>
    </div>

    <div id="ribbon">
        <div class="tool-group">
            <div class="tool-btn active" onclick="Editor.setMode('select')" id="btn-select"><span>üëÜ</span><label>Se√ß</label></div>
            <div class="tool-btn" onclick="Editor.setMode('translate')" id="btn-translate"><span>‚ÜîÔ∏è</span><label>Ta≈üƒ±</label></div>
            <div class="tool-btn" onclick="Editor.setMode('scale')" id="btn-scale"><span>‚§¢</span><label>Boyut</label></div>
            <div class="tool-btn" onclick="Editor.setMode('rotate')" id="btn-rotate"><span>üîÑ</span><label>D√∂nd√ºr</label></div>
        </div>
        <div class="tool-group">
            <div class="tool-btn" onclick="World.addPart('cube')"><span>üì¶</span><label>K√ºp</label></div>
            <div class="tool-btn" onclick="World.addPart('sphere')"><span>‚ö™</span><label>K√ºre</label></div>
            <div class="tool-btn" onclick="World.addPart('cylinder')"><span>üõ¢Ô∏è</span><label>Silindir</label></div>
        </div>
        <div class="tool-group">
            <div class="tool-btn" onclick="AI.toggle()"><span>ü§ñ</span><label>AI Chat</label></div>
        </div>
        <div style="flex:1"></div>
        <div class="tool-group" style="border:none">
            <div class="tool-btn" onclick="Game.start()" style="color:green"><span>‚ñ∂Ô∏è</span><label>Oyna</label></div>
            <div class="tool-btn" onclick="Game.stop()" style="color:red"><span>‚èπÔ∏è</span><label>Durdur</label></div>
        </div>
    </div>

    <div id="layout">
        
        <div id="left-panel">
            <div class="panel-header">
                <span>Toolbox</span>
                <span onclick="UI.toggle('left-panel')" style="cursor:pointer">‚úï</span>
            </div>
            <div id="parts-grid">
                </div>
        </div>

        <div id="viewport">
            
            <div id="game-ui">
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>

            <div id="ai-window">
                <div class="ai-header">
                    <span>LunAIX Asistan</span>
                    <span onclick="AI.toggle()" style="cursor:pointer">_</span>
                </div>
                <div class="ai-content" id="chat-history">
                    <div class="msg bot">Merhaba! "Kƒ±rmƒ±zƒ± bir ev yap" veya "Duvar olu≈ütur" diyebilirsin.</div>
                </div>
                <div class="ai-input-area">
                    <input type="text" class="ai-input" id="ai-txt" placeholder="Buraya yaz..." onkeydown="if(event.key==='Enter') AI.send()">
                    <button class="ai-send" onclick="AI.send()">‚û§</button>
                </div>
            </div>

        </div>

        <div id="right-panel">
            <div class="panel-header">
                <span>√ñzellikler</span>
                <span onclick="UI.toggle('right-panel')" style="cursor:pointer">‚úï</span>
            </div>
            <div class="prop-list" id="props-content">
                <div style="color:#999; text-align:center; margin-top:20px;">Nesne se√ßilmedi</div>
            </div>
        </div>
    </div>

    <script>
        /* ==========================================
           CORE ENGINE & INITIALIZATION
           ========================================== */
        const App = {
            scene: null, camera: null, renderer: null,
            controls: null, transform: null,
            clock: new THREE.Clock(),
            objects: [], // Tƒ±klanabilir nesneler
            raycaster: new THREE.Raycaster(),
            mouse: new THREE.Vector2(),
            
            init: () => {
                // Sahne Kurulumu
                const vp = document.getElementById('viewport');
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0x87CEEB);
                App.scene.fog = new THREE.Fog(0x87CEEB, 20, 200);

                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                App.camera.position.set(10, 10, 10);

                App.renderer = new THREE.WebGLRenderer({ antialias: true });
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                // I≈üƒ±klar
                const ambient = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                App.scene.add(ambient);
                
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(20, 50, 20);
                dirLight.castShadow = true;
                dirLight.shadow.mapSize.width = 2048;
                dirLight.shadow.mapSize.height = 2048;
                App.scene.add(dirLight);

                // Kontroller
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                
                // Gizmo olaylarƒ±: s√ºr√ºklerken kamerayƒ± kilitle
                App.transform.addEventListener('dragging-changed', e => App.controls.enabled = !e.value);
                App.transform.addEventListener('change', () => UI.updateProps(Editor.selected));
                App.scene.add(App.transform);

                // Zemin (Baseplate)
                World.createBaseplate();

                // Olay Dinleyicileri
                window.addEventListener('resize', App.resize);
                vp.addEventListener('pointerdown', Editor.onPointerDown);
                
                // Toolbox Doldur
                UI.initToolbox();
                
                // Animasyon D√∂ng√ºs√º
                App.loop();
            },
            
            resize: () => {
                const vp = document.getElementById('viewport');
                App.camera.aspect = vp.clientWidth / vp.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = App.clock.getDelta();

                if (Game.active) Game.update(dt);
                
                App.renderer.render(App.scene, App.camera);
            }
        };

        /* ==========================================
           GAME LOGIC & R6 CHARACTER
           ========================================== */
        const Game = {
            active: false,
            player: null,
            velocity: new THREE.Vector3(),
            onGround: false,
            inputs: { x: 0, y: 0 }, // Joystick values
            
            start: () => {
                if (Game.active) return;
                Game.active = true;
                
                // UI Ge√ßi≈üi
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('left-panel').classList.add('closed');
                document.getElementById('right-panel').classList.add('closed');
                document.getElementById('game-ui').style.display = 'block';
                App.transform.detach();
                
                setTimeout(App.resize, 300);

                // Karakteri olu≈ütur
                Game.spawnPlayer();
                
                // Joystick eventleri
                const zone = document.getElementById('joystick-zone');
                zone.addEventListener('pointerdown', Game.joyStart);
                window.addEventListener('pointermove', Game.joyMove);
                window.addEventListener('pointerup', Game.joyEnd);
                document.getElementById('jump-btn').addEventListener('pointerdown', Game.jump);
            },

            stop: () => {
                Game.active = false;
                
                // UI Geri y√ºkle
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('left-panel').classList.remove('closed');
                document.getElementById('right-panel').classList.remove('closed');
                document.getElementById('game-ui').style.display = 'none';
                
                setTimeout(App.resize, 300);

                // Oyuncuyu sil
                if(Game.player) App.scene.remove(Game.player);
                Game.player = null;
                
                // Kamerayƒ± resetle
                App.camera.position.set(10,10,10);
                App.controls.target.set(0,0,0);
                App.controls.update();
            },

            spawnPlayer: () => {
                const group = new THREE.Group();
                
                // Materyaller
                const skin = new THREE.MeshPhongMaterial({color: 0xf1c40f}); // Sarƒ±
                const torsoMat = new THREE.MeshPhongMaterial({color: 0x0078d7}); // Mavi
                const legMat = new THREE.MeshPhongMaterial({color: 0x2ecc71}); // Ye≈üil

                // Par√ßalar (R6 Stil)
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), torsoMat);
                torso.position.y = 3; torso.castShadow = true;
                
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), skin);
                head.position.y = 4.6; head.castShadow = true;

                // Kollar ve Bacaklar (Pivot noktalarƒ± i√ßin parent kullanacaƒüƒ±z veya offset)
                const createLimb = (geo, mat, x, y) => {
                    const limb = new THREE.Mesh(geo, mat);
                    limb.position.set(x, y, 0);
                    limb.castShadow = true;
                    return limb;
                };

                const lArm = createLimb(new THREE.BoxGeometry(1, 2, 1), skin, -1.5, 3); lArm.name="LA";
                const rArm = createLimb(new THREE.BoxGeometry(1, 2, 1), skin, 1.5, 3); rArm.name="RA";
                const lLeg = createLimb(new THREE.BoxGeometry(1, 2, 1), legMat, -0.5, 1); lLeg.name="LL";
                const rLeg = createLimb(new THREE.BoxGeometry(1, 2, 1), legMat, 0.5, 1); rLeg.name="RL";

                group.add(torso, head, lArm, rArm, lLeg, rLeg);
                group.position.set(0, 10, 0);
                
                App.scene.add(group);
                Game.player = group;
                Game.velocity.set(0,0,0);
            },

            update: (dt) => {
                if(!Game.player) return;

                const p = Game.player;
                const speed = 15;
                
                // 1. Yer√ßekimi
                if (!Game.onGround) Game.velocity.y -= 50 * dt;
                p.position.y += Game.velocity.y * dt;

                // Basit Zemin √áarpƒ±≈ümasƒ±
                if (p.position.y <= 0) {
                    p.position.y = 0;
                    Game.velocity.y = 0;
                    Game.onGround = true;
                } else {
                    Game.onGround = false;
                }

                // 2. Hareket (Kamera Y√∂n√ºne G√∂re)
                const inputX = Game.inputs.x;
                const inputY = Game.inputs.y; // ƒ∞leri negatif, Geri pozitif

                if (Math.abs(inputX) > 0.1 || Math.abs(inputY) > 0.1) {
                    // Kameranƒ±n Y eksenini sƒ±fƒ±rla
                    const camDir = new THREE.Vector3();
                    App.camera.getWorldDirection(camDir);
                    camDir.y = 0; camDir.normalize();

                    const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x);
                    
                    // Hareket vekt√∂r√º: (ƒ∞leri * -inputY) + (Saƒü * inputX)
                    // Not: Joystick yukarƒ± negatif verir, o y√ºzden - ile √ßarpƒ±p ileri yapƒ±yoruz
                    const moveVec = camDir.clone().multiplyScalar(-inputY).add(camRight.clone().multiplyScalar(inputX));
                    moveVec.normalize();

                    p.position.add(moveVec.multiplyScalar(speed * dt));

                    // Karakteri gidi≈ü y√∂n√ºne √ßevir
                    const angle = Math.atan2(moveVec.x, moveVec.z);
                    p.rotation.y = angle;

                    // 3. Animasyon (R6 Y√ºr√ºme)
                    const time = Date.now() * 0.01;
                    const legSwing = Math.sin(time) * 0.8;
                    const armSwing = Math.sin(time) * 0.8;

                    p.getObjectByName("LL").rotation.x = -legSwing;
                    p.getObjectByName("RL").rotation.x = legSwing;
                    p.getObjectByName("LA").rotation.x = legSwing; // Ters kol
                    p.getObjectByName("RA").rotation.x = -legSwing;
                    
                    // G√∂vde zƒ±plamasƒ± (Bobbing)
                    p.position.y += Math.abs(Math.sin(time*2)) * 0.05;

                } else {
                    // Durma Hali
                    ["LL", "RL", "LA", "RA"].forEach(n => p.getObjectByName(n).rotation.x = 0);
                }

                // 4. Kamera Takibi
                const targetPos = p.position.clone().add(new THREE.Vector3(0, 4, 0));
                App.controls.target.lerp(targetPos, 0.1);
                App.controls.update();
            },

            // Joystick Logic
            joyStart: (e) => { Game.dragging = true; Game.joyOrigin = {x: e.clientX, y: e.clientY}; },
            joyMove: (e) => {
                if(!Game.dragging) return;
                const maxDist = 50;
                const dx = e.clientX - Game.joyOrigin.x;
                const dy = e.clientY - Game.joyOrigin.y;
                
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), maxDist);
                const angle = Math.atan2(dy, dx);
                
                const finalX = Math.cos(angle) * dist;
                const finalY = Math.sin(angle) * dist;
                
                document.getElementById('stick').style.transform = `translate(${finalX}px, ${finalY}px)`;
                
                // Inputlarƒ± Normalize Et (-1 ile 1 arasƒ±)
                Game.inputs.x = finalX / maxDist;
                Game.inputs.y = finalY / maxDist; // Yukarƒ± √ßekince negatif (ƒ∞leri gitmek i√ßin kodda tersine √ßevirdik)
            },
            joyEnd: () => {
                Game.dragging = false;
                Game.inputs = {x:0, y:0};
                document.getElementById('stick').style.transform = `translate(0,0)`;
            },
            jump: () => { if(Game.onGround) Game.velocity.y = 25; }
        };

        /* ==========================================
           EDITOR & WORLD BUILDING
           ========================================== */
        const Editor = {
            selected: null,
            mode: 'select', // select, translate, rotate, scale

            setMode: (m) => {
                Editor.mode = m;
                if(m === 'select') App.transform.detach();
                else {
                    App.transform.setMode(m);
                    if(Editor.selected) App.transform.attach(Editor.selected);
                }
                
                // Buton rengini g√ºncelle
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                const btnId = 'btn-' + m;
                if(document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
            },

            onPointerDown: (event) => {
                if(Game.active) return; // Oyun modunda se√ßme yapma

                // Mouse koordinatlarƒ±nƒ± normalize et
                const rect = App.renderer.domElement.getBoundingClientRect();
                App.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                App.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                App.raycaster.setFromCamera(App.mouse, App.camera);
                
                // Sadece olu≈üturduƒüumuz objeleri kontrol et
                const intersects = App.raycaster.intersectObjects(App.objects);

                if (intersects.length > 0) {
                    // ƒ∞lk nesneyi se√ß
                    const object = intersects[0].object;
                    if (object.name === "Baseplate") return; // Zemini se√ßme
                    
                    Editor.select(object);
                } else {
                    Editor.deselect();
                }
            },

            select: (obj) => {
                Editor.selected = obj;
                if(Editor.mode !== 'select') App.transform.attach(obj);
                
                // Highlight efekti (basit√ße hex color deƒüi≈üimi yapmƒ±yoruz, materyal emisyonu eklenebilir ama basit tutuyoruz)
                UI.updateProps(obj);
            },
            
            deselect: () => {
                Editor.selected = null;
                App.transform.detach();
                UI.updateProps(null);
            }
        };

        const World = {
            createBaseplate: () => {
                const geo = new THREE.BoxGeometry(100, 1, 100);
                const tex = World.createTexture('grid', 0x444444);
                const mat = new THREE.MeshStandardMaterial({map: tex, color: 0x555555});
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.y = -0.5;
                mesh.name = "Baseplate";
                mesh.receiveShadow = true;
                App.scene.add(mesh);
                App.objects.push(mesh); // Raycaster i√ßin ekle
            },

            createTexture: (type, color) => {
                const cvs = document.createElement('canvas');
                cvs.width = 64; cvs.height = 64;
                const ctx = cvs.getContext('2d');
                ctx.fillStyle = '#' + new THREE.Color(color).getHexString();
                ctx.fillRect(0,0,64,64);
                
                if(type === 'brick') {
                    ctx.strokeStyle = "rgba(0,0,0,0.1)";
                    ctx.beginPath(); ctx.moveTo(0,32); ctx.lineTo(64,32); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(32,0); ctx.lineTo(32,32); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0,32); ctx.lineTo(0,64); ctx.stroke();
                } else if (type === 'grid') {
                    ctx.strokeStyle = "rgba(255,255,255,0.1)";
                    ctx.strokeRect(0,0,64,64);
                }
                
                const tex = new THREE.CanvasTexture(cvs);
                tex.magFilter = THREE.NearestFilter;
                return tex;
            },

            addPart: (type, params={}) => {
                let geo;
                if(type==='cube') geo = new THREE.BoxGeometry(4,4,4);
                else if(type==='sphere') geo = new THREE.SphereGeometry(2.5, 32, 32);
                else if(type==='cylinder') geo = new THREE.CylinderGeometry(2,2,4,32);
                
                const color = params.color || Math.random() * 0xffffff;
                const tex = World.createTexture(params.tex || 'smooth', color);
                const mat = new THREE.MeshStandardMaterial({color: color, map: tex});
                
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(params.pos || new THREE.Vector3(0, 5, 0));
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.name = "Part_" + Math.floor(Math.random()*1000);
                
                App.scene.add(mesh);
                App.objects.push(mesh);
                
                Editor.select(mesh);
                return mesh;
            }
        };

        /* ==========================================
           UI MANAGER
           ========================================== */
        const UI = {
            toggle: (id) => {
                document.getElementById(id).classList.toggle('closed');
                setTimeout(App.resize, 350);
            },

            initToolbox: () => {
                const container = document.getElementById('parts-grid');
                const items = [
                    {name: "Tuƒüla", type: "cube", tex: "brick", color: 0xcc4444},
                    {name: "√áim", type: "cube", tex: "smooth", color: 0x44cc44},
                    {name: "Tahta", type: "cube", tex: "brick", color: 0x8B4513},
                    {name: "Metal", type: "cube", tex: "smooth", color: 0xaaaaaa},
                    {name: "K√ºre", type: "sphere", tex: "smooth", color: 0xffcc00},
                    {name: "Silindir", type: "cylinder", tex: "smooth", color: 0x00ccff}
                ];

                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'part-item';
                    div.innerHTML = `<div class="part-preview" style="background:#${new THREE.Color(item.color).getHexString()}"></div><span>${item.name}</span>`;
                    div.onclick = () => World.addPart(item.type, {color: item.color, tex: item.tex});
                    container.appendChild(div);
                });
            },

            updateProps: (obj) => {
                const p = document.getElementById('props-content');
                if(!obj) {
                    p.innerHTML = '<div style="color:#999; text-align:center; margin-top:20px;">Nesne se√ßilmedi</div>';
                    return;
                }
                
                p.innerHTML = '';
                
                const addInput = (lbl, val, cb) => {
                    const row = document.createElement('div'); row.className='prop-row';
                    row.innerHTML = `<label>${lbl}</label>`;
                    const inp = document.createElement('input'); 
                    inp.className='prop-input'; inp.value=val;
                    inp.onchange = (e) => cb(e.target.value);
                    row.appendChild(inp); p.appendChild(row);
                };

                addInput("ƒ∞sim", obj.name, v => obj.name=v);
                addInput("X Poz", obj.position.x.toFixed(2), v => { obj.position.x=parseFloat(v); });
                addInput("Y Poz", obj.position.y.toFixed(2), v => { obj.position.y=parseFloat(v); });
                addInput("Z Poz", obj.position.z.toFixed(2), v => { obj.position.z=parseFloat(v); });
            }
        };

        /* ==========================================
           AI SYSTEM
           ========================================== */
        const AI = {
            toggle: () => {
                const win = document.getElementById('ai-window');
                win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
            },
            
            send: () => {
                const inp = document.getElementById('ai-txt');
                const txt = inp.value.trim();
                if(!txt) return;
                
                AI.addMsg(txt, 'user');
                inp.value = '';

                // AI Cevap Sim√ºlasyonu
                setTimeout(() => {
                    const lower = txt.toLowerCase();
                    let resp = "Bunu hen√ºz anlamadƒ±m.";
                    
                    if(lower.includes('ev')) {
                        // Basit Ev Yapƒ±sƒ±
                        World.addPart('cube', {pos:new THREE.Vector3(0,5,0), color:0xcc4444});
                        resp = "Basit bir ev (k√ºp) olu≈üturdum.";
                    } else if (lower.includes('sil') || lower.includes('kaldƒ±r')) {
                         if(Editor.selected) {
                             App.scene.remove(Editor.selected);
                             Editor.deselect();
                             resp = "Se√ßili nesne silindi.";
                         } else {
                             resp = "√ñnce bir nesne se√ßmelisin.";
                         }
                    } else if (lower.includes('merhaba')) {
                        resp = "Merhaba! LunX Studio'da ne yapmak istersin?";
                    }

                    AI.addMsg(resp, 'bot');
                }, 600);
            },

            addMsg: (txt, type) => {
                const c = document.getElementById('chat-history');
                const div = document.createElement('div');
                div.className = `msg ${type}`;
                div.innerText = txt;
                c.appendChild(div);
                c.scrollTop = c.scrollHeight;
            }
        };

    </script>
</body>
</html>
