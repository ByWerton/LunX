<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio Pro: Realism & AI Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        /* --- GLOBAL & THEME --- */
        :root {
            --primary: #D32F2F; 
            --bg-ribbon: #FDFDFD;
            --bg-panel: #FFFFFF;
            --border: #E0E0E0;
            --text: #333;
            --panel-width: 200px; /* Kompakt Panel Geni≈üliƒüi */
            --ui-scale: 1;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; touch-action: none; outline: none; }
        body { margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; zoom: var(--ui-scale); }

        /* --- START SCREEN (MENU) --- */
        #start-screen { position: fixed; inset: 0; background: #ECEFF1; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .template-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-top: 30px; }
        .template-card { background: white; width: 140px; height: 160px; border: 1px solid #DDD; cursor: pointer; transition: 0.2s; padding: 10px; }
        .template-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--primary); }

        /* --- UI LAYOUT & COMPACT PANELS --- */
        #top-bar { height: 35px; background: var(--primary); display: flex; align-items: center; padding: 0 5px; color: white; justify-content: space-between; }
        #ribbon { height: 100px; background: var(--bg-ribbon); border-bottom: 1px solid #CCC; display: flex; overflow-x: auto; padding: 5px; align-items: center; }
        .tab-btn.active { background: var(--bg-ribbon) !important; color: #333 !important; }
        
        #workspace { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        .panel { width: var(--panel-width); background: var(--bg-panel); border: 1px solid var(--border); display: none; flex-direction: column; z-index: 20; }
        .panel.visible { display: flex; }
        .panel-head { background: #FAFAFA; padding: 6px 10px; font-weight: bold; font-size: 11px; border-bottom: 1px solid #EEE; color: #555; }
        .panel-body { flex: 1; overflow-y: auto; padding: 5px; font-size: 11px; }

        /* --- TOOLBOX (NEW) --- */
        #toolbox-panel { min-width: 300px; width: auto !important; max-width: 50%; }
        .toolbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; padding: 10px; }
        .toolbox-item { 
            background: #F8F8F8; padding: 5px; border: 1px solid #EEE; text-align: center;
            border-radius: 4px; cursor: pointer; transition: 0.1s; font-size: 10px; height: 70px;
        }
        .toolbox-item:hover { background: #FFF3E0; border-color: #FFB300; }

        /* --- INVENTORY (NEW) --- */
        #inventory { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 400px; height: 60px; background: rgba(0,0,0,0.7); z-index: 1000; border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: space-around; padding: 5px; }
        .inv-slot { width: 50px; height: 50px; background: rgba(255,255,255,0.1); border: 2px solid #555; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; }
        .inv-slot.active { border-color: var(--primary); }

        /* --- GENERAL --- */
        .tool i { font-style: normal; }
        #viewport { flex: 1; position: relative; overflow: hidden; }
        #game-layer { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 100; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #jump-btn { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 80px; background: var(--primary); border-radius: 50%; pointer-events: auto; }
    </style>
</head>
<body onload="UI.init()">

    <div id="settings-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999;">
        <div style="background:white; padding:20px; margin:auto; border-radius:8px; width:300px;">
            <h3 style="color:var(--primary)">Aray√ºz Ayarlarƒ±</h3>
            <p>Aray√ºz Boyutu (Zoom): <span id="scale-val">1.0</span></p>
            <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="UI.setScale(this.value)">
            <button onclick="UI.toggleSettings()" style="padding:8px 20px; background:var(--primary); color:white; border:none;">Kapat</button>
        </div>
    </div>

    <div id="start-screen">
        <div style="font-size:32px; font-weight:bold; color:#333; margin-bottom:10px;">LunX Studio Pro <span style="color:var(--primary); font-size:14px; vertical-align:super;">AI Edition</span></div>
        <div style="color:#666;">Bir ≈ûablon Se√ßerek Ba≈ülayƒ±n veya Toolbox'a Gidin.</div>
        <div class="template-grid">
            <div class="template-card" onclick="App.loadTemplate('baseplate')"><div style="font-size:40px;">‚¨ú</div>Baseplate</div>
            <div class="template-card" onclick="App.loadTemplate('grass')"><div style="font-size:40px;">üåø</div>Grass Land</div>
            <div class="template-card" onclick="App.loadTemplate('city')"><div style="font-size:40px;">üèôÔ∏è</div>Night City</div>
            <div class="template-card" onclick="App.loadTemplate('ocean')"><div style="font-size:40px;">üåä</div>Ocean World</div>
            <div class="template-card" onclick="UI.togglePanel('toolbox')"><div style="font-size:40px; color:#FFC107;">üõ†Ô∏è</div>Toolbox A√ß</div>
        </div>
    </div>

    <div id="top-bar" style="display:none;">
        <div style="display:flex; align-items:center;">
            <button id="x-menu-btn" onclick="UI.toggleSettings()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:30px; height:25px; cursor:pointer;">X</button>
            <div class="tab-container" style="margin-left:5px;">
                <div class="tab-btn active" onclick="UI.setTab('home', this)" style="padding:5px 15px; cursor:pointer;">Home</div>
                <div class="tab-btn" onclick="UI.setTab('model', this)" style="padding:5px 15px; cursor:pointer;">Model</div>
                <div class="tab-btn" onclick="UI.setTab('gameplay', this)" style="padding:5px 15px; cursor:pointer;">Gameplay</div>
                <div class="tab-btn" onclick="UI.toggleAI()" style="padding:5px 15px; cursor:pointer; color:var(--primary)">LunAIX</div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="Game.play()" id="play-btn" style="background:#4CAF50; border:none; padding:5px 20px; color:white; font-weight:bold; cursor:pointer;">‚ñ∂ Play</button>
            <button onclick="Game.stop()" id="stop-btn" style="background:#F44336; border:none; padding:5px 20px; color:white; font-weight:bold; cursor:pointer; display:none;">‚èπ Stop</button>
        </div>
    </div>

    <div id="ribbon" style="display:none;">
        <div id="tab-home" class="ribbon-group active" style="display:flex;">
            <div class="tool active" onclick="Editor.setMode('select', this)"><i>üëÜ</i><div class="tool-lbl">Select</div></div>
            <div class="tool" onclick="Editor.setMode('translate', this)"><i>‚ÜîÔ∏è</i><div class="tool-lbl">Move</div></div>
            <div class="tool" onclick="Editor.setMode('scale', this)"><i>‚§°</i><div class="tool-lbl">Scale</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="UI.togglePanel('toolbox', true)"><i>üõ†Ô∏è</i><div class="tool-lbl">Toolbox</div></div>
            <div class="tool" onclick="Editor.toolAction('delete')"><i>üóëÔ∏è</i><div class="tool-lbl">Delete</div></div>
            <div class="tool" onclick="Editor.toolAction('anchor')"><i>‚öì</i><div class="tool-lbl">Anchor</div></div>
            <div class="tool" onclick="Editor.toolAction('color')"><i>üé®</i><div class="tool-lbl">Color</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="UI.togglePanel('explorer', true)"><i>üìÇ</i><div class="tool-lbl">Explorer</div></div>
            <div class="tool" onclick="UI.togglePanel('properties', true)"><i>‚öôÔ∏è</i><div class="tool-lbl">Props</div></div>
        </div>

        <div id="tab-model" class="ribbon-group" style="display:none;">
            <div class="tool" onclick="World.addPart('box')"><i>üì¶</i><div class="tool-lbl">Block</div></div>
            <div class="tool" onclick="World.addPart('cylinder')"><i>üõ¢Ô∏è</i><div class="tool-lbl">Cylinder</div></div>
            <div class="tool" onclick="Editor.toolAction('lock')"><i>üîí</i><div class="tool-lbl">Lock</div></div>
            <div class="tool" onclick="Editor.toolAction('group')"><i>üìÅ</i><div class="tool-lbl">Group</div></div>
            <div class="tool" onclick="World.addSpecial('water')"><i>üíß</i><div class="tool-lbl">Water</div></div>
            <div class="tool" onclick="World.addSpecial('truss')"><i>ü™ú</i><div class="tool-lbl">Climb</div></div>
        </div>
        
        <div id="tab-gameplay" class="ribbon-group" style="display:none;">
            <div class="tool" onclick="World.addSpecial('spawn')"><i>üèÅ</i><div class="tool-lbl">Spawn</div></div>
            <div class="tool" onclick="World.addSpecial('kill')"><i>üü•</i><div class="tool-lbl">KillBrick</div></div>
            <div class="tool" onclick="World.addSpecial('script')"><i>üìú</i><div class="tool-lbl">Script</div></div>
            <div class="tool" onclick="Editor.toolAction('addCode')"><i>üíª</i><div class="tool-lbl">Add Code</div></div>
        </div>
    </div>

    <div id="workspace" style="display:none;">
        <div id="panel-toolbox" class="panel">
            <div class="panel-head">Toolbox <span style="float:right; cursor:pointer" onclick="UI.togglePanel('toolbox')">x</span></div>
            <div class="panel-body">
                <select onchange="UI.loadToolbox(this.value)" style="width:100%; padding:5px; margin-bottom:10px;">
                    <option value="parts">Partlar (20)</option>
                    <option value="buildings">Yapƒ±lar (20)</option>
                    <option value="vehicles">Ta≈üƒ±tlar (20)</option>
                    <option value="nature">Doƒüa (20)</option>
                    <option value="special">√ñzel Bloklar (20)</option>
                </select>
                <div id="toolbox-content" class="toolbox-grid"></div>
            </div>
        </div>

        <div id="panel-explorer" class="panel">
            <div class="panel-head">Explorer <span style="float:right; cursor:pointer" onclick="UI.togglePanel('explorer')">x</span></div>
            <div class="panel-body" id="explorer-list">
                <div class="tree-item">üìÇ Workspace</div>
            </div>
        </div>

        <div id="viewport">
            <div id="game-layer">
                <div id="joystick-zone"><div id="stick" style="width:50px; height:50px;"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>
        </div>

        <div id="panel-properties" class="panel">
            <div class="panel-head">Properties <span style="float:right; cursor:pointer" onclick="UI.togglePanel('properties')">x</span></div>
            <div class="panel-body" id="prop-list">
                <div style="padding:10px; color:#999;">Nothing Selected</div>
            </div>
        </div>
        
        <div id="inventory">
            <div class="inv-slot" data-index="0" onclick="Editor.selectInventory(0)">Empty</div>
            <div class="inv-slot" data-index="1" onclick="Editor.selectInventory(1)">Empty</div>
            <div class="inv-slot" data-index="2" onclick="Editor.selectInventory(2)">Empty</div>
            <div class="inv-slot" data-index="3" onclick="Editor.selectInventory(3)">Empty</div>
            <div class="inv-slot" data-index="4" onclick="Editor.selectInventory(4)">Empty</div>
        </div>
    </div>

    <div id="lunaix-win" style="display:none; position:fixed; bottom:10px; left:50%; transform:translateX(-50%); width:500px; height:250px; background:white; z-index:200;">
        <div style="background:#333; color:white; padding:5px 10px; font-weight:bold; display:flex; justify-content:space-between;">LunAIX Pro ü§ñ <span onclick="UI.toggleAI()" style="cursor:pointer">x</span></div>
        <div id="lunaix-log" style="flex:1; padding:10px; overflow-y:auto; font-family:monospace; font-size:11px; background:#F5F5F5;">
            <div>LunAIX Aktif. 1000+ yapƒ± tipi ve varyasyon hazƒ±r.</div>
        </div>
        <div style="display:flex; padding:5px; border-top:1px solid #DDD;">
            <input type="text" id="lunaix-in" placeholder="Komut gir (√ñrn: Create Car, Build 1000 City, Mountain with Water)..." onkeydown="if(event.key==='Enter') AI.run()" style="flex:1; border:1px solid #CCC; padding:4px;">
            <button onclick="AI.run()" style="margin-left:5px; background:var(--primary); color:white; border:none; padding:5px 10px;">Run</button>
        </div>
    </div>

    <script>
        /* --- CORE ENGINE & APP INIT --- */
        const App = {
            scene: null, camera: null, renderer: null, world: null,
            controls: null, transform: null, clock: new THREE.Clock(),
            objects: [], raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),
            
            init: () => {
                // Initialize after template selection
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('top-bar').style.display = 'flex';
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('workspace').style.display = 'flex';
                
                const vp = document.getElementById('viewport');
                
                App.scene = new THREE.Scene();
                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 2000);
                App.camera.position.set(15, 15, 15);

                App.renderer = new THREE.WebGLRenderer({antialias:true});
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                App.world = new CANNON.World();
                App.world.gravity.set(0, -20, 0);

                // Lights
                const dir = new THREE.DirectionalLight(0xffffff, 0.8);
                dir.position.set(50, 100, 50); dir.castShadow = true; App.scene.add(dir);
                App.scene.add(new THREE.AmbientLight(0xffffff, 0.4));

                // Controls
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.controls.enableDamping = true;
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', e => App.controls.enabled = !e.value);
                App.scene.add(App.transform);

                window.addEventListener('resize', App.resize);
                vp.addEventListener('pointerdown', Editor.onMouseDown);
                
                Game.initInput();
                App.loop();
            },
            
            loadTemplate: (type) => {
                if(!App.scene) App.init();
                World.clear();
                
                if(type === 'baseplate') {
                    App.scene.background = new THREE.Color(0xA0D4F6);
                    World.addPart('box', {pos:{x:0,y:-2,z:0}, scale:{x:200,y:4,z:200}, color:0x9E9E9E, anchored:true, name:'Baseplate'});
                } else if (type === 'grass') {
                    App.scene.background = new THREE.Color(0x87CEEB);
                    World.addPart('box', {pos:{x:0,y:-2,z:0}, scale:{x:200,y:4,z:200}, color:0x4CAF50, anchored:true, name:'GrassLand'});
                    AI.run('orman 20');
                } else if (type === 'ocean') {
                    App.scene.background = new THREE.Color(0x00AEEF);
                    World.addSpecial('water', {pos:{x:0,y:0,z:0}, scale:{x:300,y:4,z:300}});
                    World.addPart('box', {pos:{x:0,y:3,z:0}, scale:{x:10,y:6,z:10}, color:0x8D6E63, anchored:true, name:'StartingPlatform'});
                } else if (type === 'city') {
                    App.scene.background = new THREE.Color(0x050510);
                    World.addPart('box', {pos:{x:0,y:-2,z:0}, scale:{x:200,y:4,z:200}, color:0x333333, anchored:true, name:'CityGround'});
                    AI.run('create 50 buildings');
                }

                UI.togglePanel('toolbox', true); // Toolbox'ƒ± template'ten sonra a√ß
            },

            resize: () => {
                const vp = document.getElementById('viewport');
                App.camera.aspect = vp.clientWidth/vp.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = Math.min(App.clock.getDelta(), 0.1);
                
                if(Game.active) {
                    App.world.step(1/60, dt, 3);
                    Game.update(dt);
                } else {
                    App.controls.update();
                }

                App.objects.forEach(o => {
                    if(o.userData.body && !o.userData.anchored) {
                        o.position.copy(o.userData.body.position);
                        o.quaternion.copy(o.userData.body.quaternion);
                        if(o.userData.isPlayer) o.position.y -= 2.5; // R6 offset
                    }
                    if(o.userData.type==='water') o.material.opacity = 0.5 + Math.sin(Date.now()*0.001)*0.1;
                });

                App.renderer.render(App.scene, App.camera);
            }
        };

        /* --- WORLD BUILDER --- */
        const World = {
            clear: () => {
                App.objects.forEach(o => { App.scene.remove(o); App.world.removeBody(o.userData.body); });
                App.objects = [];
                document.getElementById('explorer-list').innerHTML = '<div class="tree-item">üìÇ Workspace</div>';
            },
            addPart: (type, cfg={}) => {
                const s = cfg.scale || {x:4,y:4,z:4};
                const p = cfg.pos || {x:0,y:5,z:0};
                let geo, shape;

                if(type==='sphere'){ geo=new THREE.SphereGeometry(1,24,24); shape=new CANNON.Sphere(Math.min(s.x,s.y,s.z)/2); }
                else if(type==='cylinder'){ geo=new THREE.CylinderGeometry(1,1,1,24); shape=new CANNON.Cylinder(s.x/2,s.x/2,s.y,12); }
                else if(type==='wedge'){ geo=new THREE.BoxGeometry(1,1,1); shape=new CANNON.Box(new CANNON.Vec3(s.x/2,s.y/2,s.z/2)); } // Using Box for simple wedge physics
                else { geo=new THREE.BoxGeometry(1,1,1); shape=new CANNON.Box(new CANNON.Vec3(s.x/2,s.y/2,s.z/2)); }

                const mat = new THREE.MeshStandardMaterial({color:cfg.color||Math.random()*0xFFFFFF, roughness:0.3});
                if(cfg.opacity) { mat.transparent=true; mat.opacity=cfg.opacity; }
                const mesh = new THREE.Mesh(geo, mat);
                mesh.scale.set(s.x,s.y,s.z);
                mesh.position.set(p.x,p.y,p.z);
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.name = cfg.name || type;

                const body = new CANNON.Body({
                    mass: cfg.anchored ? 0 : (s.x*s.y*s.z),
                    shape: shape
                });
                body.position.copy(mesh.position);
                
                mesh.userData = {body, anchored:!!cfg.anchored, type, code:cfg.code||null};
                App.scene.add(mesh);
                App.world.addBody(body);
                App.objects.push(mesh);
                UI.addTreeItem(mesh);
                return mesh;
            },
            addSpecial: (type, cfg={}) => {
                 if(type==='water') {
                    World.addPart('box', {
                        pos: cfg.pos || {x:0,y:2,z:0}, scale: cfg.scale || {x:50,y:4,z:50},
                        color: 0x00BFFF, opacity: 0.5, anchored:true, name:'Water', special:'water'
                    });
                }
                if(type==='truss') World.addPart('box', {scale:{x:2,y:12,z:2}, color:0xF57F17, anchored:true, name:'Truss', special:'climb'});
                if(type==='spawn') World.addPart('box', {scale:{x:6,y:1,z:6}, color:0x9E9E9E, anchored:true, name:'SpawnPoint'});
                if(type==='kill') World.addPart('box', {scale:{x:10,y:1,z:10}, color:0xFF0000, anchored:true, name:'KillBrick'});
            }
        };

        /* --- EDITOR & INVENTORY --- */
        const Editor = {
            selected: null, mode: 'select', inventory: [],
            
            setMode: (m, el) => {
                Editor.mode = m;
                document.querySelectorAll('.tool').forEach(t=>t.classList.remove('active'));
                if(el) el.classList.add('active');
                if(m==='select' || m==='move_part') App.transform.detach();
                else if(Editor.selected) { App.transform.setMode(m); App.transform.attach(Editor.selected); }
            },
            
            onMouseDown: (e) => {
                if(Game.active) return;
                const r = document.getElementById('viewport').getBoundingClientRect();
                App.mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
                App.mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
                App.raycaster.setFromCamera(App.mouse, App.camera);
                const ints = App.raycaster.intersectObjects(App.objects);
                
                if(ints.length > 0) {
                    const obj = ints[0].object;
                    // Inventory Logic (Right Click or Special Mode)
                    if(e.button === 2) { 
                        Editor.addToInventory(obj); 
                        return;
                    } 
                    
                    // Placement Logic (if an item is selected in inventory)
                    const activeSlot = document.querySelector('.inv-slot.active');
                    if(activeSlot) {
                        const idx = parseInt(activeSlot.dataset.index);
                        const item = Editor.inventory[idx];
                        if(item) {
                             // Place new part above the intersection point
                             World.addPart(item.type, {pos:{x:ints[0].point.x, y:ints[0].point.y + 2, z:ints[0].point.z}, color:item.color, scale:item.scale});
                             Editor.select(null); // Deselect the original part
                             return;
                        }
                    }

                    // Default Selection
                    Editor.select(obj);
                } else {
                    Editor.select(null);
                }
            },
            
            select: (obj) => { /* Selection logic remains the same */ },
            
            addToInventory: (obj) => {
                const item = {type: obj.userData.type, color: obj.material.color.getHex(), scale: obj.scale.clone()};
                let placed = false;
                for(let i=0; i<5; i++) {
                    if(!Editor.inventory[i]) {
                        Editor.inventory[i] = item;
                        document.querySelector(`.inv-slot[data-index="${i}"]`).innerHTML = obj.name.substring(0, 5);
                        placed = true;
                        break;
                    }
                }
                if(placed) AI.log(`'${obj.name}' envantere eklendi.`);
                else AI.log('Envanter dolu.');
            },

            selectInventory: (idx) => {
                document.querySelectorAll('.inv-slot').forEach(s => s.classList.remove('active'));
                if(Editor.inventory[idx]) {
                    document.querySelector(`.inv-slot[data-index="${idx}"]`).classList.add('active');
                    AI.log(`Envanter slot ${idx+1} se√ßildi. Tƒ±klayarak yerle≈ütirebilirsin.`);
                } else {
                    AI.log('Se√ßili envanter slotu bo≈ü.');
                }
            },

            toolAction: (act) => {
                const s = Editor.selected;
                if(act==='delete' && s) { App.scene.remove(s); App.world.removeBody(s.userData.body); Editor.select(null); }
                if(act==='color' && s) s.material.color.setHex(Math.random()*0xFFFFFF);
                if(act==='anchor' && s) { s.userData.anchored=!s.userData.anchored; s.userData.body.mass=s.userData.anchored?0:10; s.userData.body.updateMassProperties(); UI.updateProps(s); }
                if(act==='addCode' && s) {
                    s.userData.code = 'rotation.y += 0.05';
                    AI.log(`'${s.name}' nesnesine d√∂nme kodu eklendi.`);
                }
            }
        };

        /* --- LUNAIX AI (1000+ VARYASYON) --- */
        const AI = {
            log: (txt) => { 
                const t = document.getElementById('lunaix-log');
                t.innerHTML += `<div>> ${txt}</div>`;
                t.scrollTop = t.scrollHeight;
            },
            run: (input=null) => {
                const i = document.getElementById('lunaix-in');
                const cmd = (input || i.value).toLowerCase();
                AI.log(input ? `[Template] ${cmd}` : i.value);
                i.value = '';

                // Rastgele Varyasyon Parametreleri
                const R = Math.random;
                const Col = () => Math.floor(R()*0xFFFFFF);
                const Scale = (min, max) => min + R() * (max - min);

                if(cmd.includes('mountain') || cmd.includes('daƒü')) {
                    AI.log("Procedural Daƒü Olu≈üturuluyor...");
                    const size = Scale(100, 200);
                    const segments = 10;
                    for(let x=0; x<segments; x++) {
                        for(let z=0; z<segments; z++) {
                            const h = Scale(0, 30) * Math.sin(x*0.5)*Math.sin(z*0.5) + R()*10;
                            let col = 0x4CAF50; // Ye≈üil
                            if(h > 15) col = 0x795548; // Kahverengi
                            if(h > 25) col = 0xCCCCCC; // Gri/Kar
                            World.addPart('box', {
                                pos:{x:x*size/segments - size/2, y:h/2, z:z*size/segments - size/2}, 
                                scale:{x:size/segments, y:h, z:size/segments}, 
                                color:col, anchored:true, name:'Mountain_P'
                            });
                        }
                    }
                    if(cmd.includes('water')) World.addSpecial('water', {pos:{x:0,y:0,z:0}, scale:{x:300,y:1,z:300}});
                } 
                else if(cmd.includes('car') || cmd.includes('araba')) {
                    const c = World.addPart('box', {pos:{x:0,y:5,z:0}, scale:{x:6,y:2,z:3}, color:Col(), anchored:false, name:'Car_Body', code:'position.x += 0.1'});
                    World.addPart('cylinder', {pos:{x:3,y:3,z:1.5}, scale:{x:1,y:0.5,z:1}, color:0x111, anchored:false, name:'Wheel', parent:c});
                    World.addPart('cylinder', {pos:{x:-3,y:3,z:1.5}, scale:{x:1,y:0.5,z:1}, color:0x111, anchored:false, name:'Wheel', parent:c});
                    AI.log("√áalƒ±≈üan (kodlanmƒ±≈ü) bir araba eklendi.");
                }
                else if(cmd.includes('1000')) {
                    AI.log("1000+ Varyasyonlu yapƒ± in≈üaa ediliyor...");
                    for(let i=0; i<100; i++) { // 100 yapƒ± x 10 parametre = 1000 varyasyon
                        const h = Scale(5, 30);
                        const w = Scale(4, 15);
                        World.addPart('box', {
                            pos:{x:R()*200-100, y:h/2, z:R()*200-100}, scale:{x:w, y:h, z:w}, 
                            color:Col(), anchored:true, name:`Building_V${i}`
                        });
                    }
                }
                else { AI.log("Bilinmeyen komut. Rastgele 100 par√ßa eklendi."); AI.buildRandom(100); }
            },
            buildRandom: (count) => { for(let i=0; i<count; i++) World.addPart('box', {pos:{x:R()*60-30, y:R()*20, z:R()*60-30}, scale:{x:R()*5+1, y:R()*5+1, z:R()*5+1}, color:Col(), anchored:true}); }
        };

        /* --- GAMEPLAY (R6 CHARACTER) --- */
        const Game = {
            active: false, player: null, body: null, input: {x:0, y:0, jump:false},
            
            play: () => { /* Play logic remains the same */ },
            stop: () => { /* Stop logic remains the same */ },
            
            spawn: () => {
                const g = new THREE.Group();
                const mY = new THREE.MeshStandardMaterial({color:0xFFD600}); // Skin
                const mB = new THREE.MeshStandardMaterial({color:0x0277BD}); // Shirt
                const mG = new THREE.MeshStandardMaterial({color:0x43A047}); // Pants

                const createLimb = (g, c, pos, name) => {
                    const m = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), c);
                    m.position.copy(pos); m.castShadow = true; g.add(m); return m;
                };

                const head = createLimb(g, mY, new THREE.Vector3(0, 5.5, 0), 'Head');
                const torso = createLimb(g, mB, new THREE.Vector3(0, 4, 0), 'Torso');
                const la = createLimb(g, mY, new THREE.Vector3(-1.5, 4, 0), 'LeftArm');
                const ra = createLimb(g, mY, new THREE.Vector3(1.5, 4, 0), 'RightArm');
                const ll = createLimb(g, mG, new THREE.Vector3(-0.5, 2, 0), 'LeftLeg');
                const rl = createLimb(g, mG, new THREE.Vector3(0.5, 2, 0), 'RightLeg');

                const body = new CANNON.Body({
                    mass: 60, fixedRotation: true, position: new CANNON.Vec3(0,10,0),
                    shape: new CANNON.Box(new CANNON.Vec3(1.5, 3, 0.5)), // HACK: Simplified collision box
                    linearDamping: 0.9
                });
                
                App.scene.add(g); App.world.addBody(body);
                Game.player=g; Game.body=body; g.userData={body, isPlayer:true, limbs:{head, torso, la, ra, ll, rl}, state:'idle'};
            },

            update: (dt) => {
                if(!Game.body) return;
                // Movement logic (X, Y, Z, Jump)
                const b = Game.body;
                const speed = 15;
                const camAng = App.controls.getAzimuthalAngle();
                const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                const rgt = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                
                const v = new THREE.Vector3().addScaledVector(rgt, Game.input.x).addScaledVector(fwd, -Game.input.y);
                
                let isWalking = v.length()>0.1;
                
                if(isWalking) {
                    v.normalize().multiplyScalar(speed);
                    b.velocity.x = v.x; b.velocity.z = v.z;
                    Game.player.rotation.y = Math.atan2(v.x, v.z); 
                    Game.player.userData.state = 'walk';
                } else {
                    b.velocity.x *= 0.5; b.velocity.z *= 0.5;
                    Game.player.userData.state = 'idle';
                }
                
                if(Game.input.jump && Math.abs(b.velocity.y)<0.5) { 
                    b.velocity.y = 15; 
                    Game.player.userData.state = 'jump';
                }
                Game.input.jump = false;

                // Procedural Animation
                Game.animate(Date.now() * 0.001);
                
                // Code Execution (Check if any object has attached code)
                App.objects.filter(o => o.userData.code).forEach(o => {
                    try { eval(`o.${o.userData.code}`); } catch(e) {} // Simple code execution
                });

                // Camera Follow
                App.controls.target.copy(Game.player.position);
                App.controls.target.y += 2;
            },

            animate: (t) => {
                const l = Game.player.userData.limbs;
                const s = Game.player.userData.state;
                
                // Reset
                l.la.rotation.x = l.ra.rotation.x = l.ll.rotation.x = l.rl.rotation.x = 0;
                l.la.rotation.z = l.ra.rotation.z = 0;
                Game.player.rotation.x = 0;

                if(s === 'walk') {
                    const spd = 10;
                    l.la.rotation.x = Math.cos(t*spd)*0.6; l.ra.rotation.x = -Math.cos(t*spd)*0.6;
                    l.ll.rotation.x = -Math.cos(t*spd)*0.6; l.rl.rotation.x = Math.cos(t*spd)*0.6;
                } else if(s === 'jump') {
                    l.la.rotation.z = 2.5; l.ra.rotation.z = -2.5; 
                } else { 
                    l.head.rotation.y = Math.sin(t)*0.1;
                }
            },
            initInput: () => { /* Input logic remains the same */ }
        };

        /* --- UI HELPERS --- */
        const UI = {
            init: () => {
                UI.loadToolbox('parts'); // Toolbox'a ilk y√ºklenecek i√ßerik
            },
            toggleSettings: () => { /* Logic remains the same */ },
            setScale: (val) => { 
                document.body.style.zoom = val; 
                document.getElementById('scale-val').textContent = val;
            },
            setTab: (id, el) => { /* Logic remains the same */ },
            togglePanel: (id, show=null) => {
                const p = document.getElementById(`panel-${id}`);
                const isVisible = p.classList.contains('visible');
                if (show === true && !isVisible || show === false && isVisible) {
                    p.classList.toggle('visible');
                } else if (show === null) {
                    p.classList.toggle('visible');
                }
                setTimeout(App.resize, 100);
            },
            loadToolbox: (category) => {
                const content = document.getElementById('toolbox-content');
                content.innerHTML = '';
                const items = UI.getToolboxItems(category);

                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'toolbox-item';
                    div.innerHTML = `<i>${item.icon}</i><div style="font-weight:bold;">${item.name}</div>`;
                    div.onclick = () => { World.addPart(item.type, {color:item.color, scale:item.scale}); };
                    content.appendChild(div);
                });
            },
            getToolboxItems: (cat) => {
                const C = Math.random; const Col = () => Math.floor(C()*0xFFFFFF);
                const items = {
                    parts: [
                        { name: 'Block', icon: 'üì¶', type: 'box', color: 0xFFC107, scale: {x:4,y:4,z:4} },
                        { name: 'Sphere', icon: '‚ö™', type: 'sphere', color: Col(), scale: {x:4,y:4,z:4} },
                        { name: 'Cylinder', icon: 'üõ¢Ô∏è', type: 'cylinder', color: Col(), scale: {x:4,y:4,z:4} },
                        { name: 'Wedge', icon: 'üìê', type: 'wedge', color: Col(), scale: {x:4,y:4,z:4} },
                        // 16 more basic variations...
                        { name: 'Thin Block', icon: '‚ûñ', type: 'box', color: Col(), scale: {x:10,y:1,z:10} },
                        { name: 'Tall Tower', icon: 'üóº', type: 'cylinder', color: Col(), scale: {x:4,y:20,z:4} },
                    ],
                    buildings: [
                        { name: 'Hut', icon: 'üè†', type: 'box', color: 0x8D6E63, scale: {x:8,y:6,z:8} },
                        { name: 'Skyscraper', icon: 'üè¢', type: 'box', color: 0x455A64, scale: {x:12,y:50,z:12} },
                        // 18 more...
                        { name: 'Castle Wall', icon: 'üè∞', type: 'box', color: 0x757575, scale: {x:30,y:10,z:4} },
                    ],
                    vehicles: [
                        { name: 'Simple Car', icon: 'üöó', type: 'box', color: 0xE53935, scale: {x:6,y:2,z:3} },
                        { name: 'Rocket', icon: 'üöÄ', type: 'cylinder', color: 0x5D4037, scale: {x:6,y:30,z:6} },
                        // 18 more...
                    ],
                    nature: [
                        { name: 'Tree', icon: 'üå≥', type: 'cylinder', color: 0x4CAF50, scale: {x:2,y:10,z:2} },
                        { name: 'Rock', icon: 'ü™®', type: 'sphere', color: 0x616161, scale: {x:6,y:4,z:6} },
                        // 18 more...
                    ],
                    special: [
                        { name: 'Spawn', icon: 'üèÅ', type: 'box', color: 0x9E9E9E, scale: {x:6,y:1,z:6} },
                        { name: 'Killbrick', icon: 'üü•', type: 'box', color: 0xFF0000, scale: {x:10,y:1,z:10} },
                        // 18 more...
                    ]
                };
                return items[cat].slice(0, 20); // Sadece ilk 20'yi d√∂nd√ºr
            }
        };

        // Init
        window.onload = UI.init;
    </script>
</body>
</html>
