<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V10.0 - Joystick & Keylock Fix</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            /* TEMA: KIRMIZI & BEYAZ (Eski Kod Uyumu) */
            --bg-main: #f0f2f5;
            --bg-panel: #ffffff;
            --text-main: #333333;
            --accent-red: #ff3333;
            --accent-hover: #ffe6e6;
            --border: #e0e0e0;
            --toolbar-height: 120px;
            --panel-width: 260px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: var(--bg-main); color: var(--text-main); height: 100vh; width: 100vw; }

        /* --- ST√úDYO KAPSAYICISI (√ñL√áEK ƒ∞√áƒ∞N) --- */
        #studio-container {
            height: 100vh; width: 100vw; 
            display: flex; flex-direction: column;
            transform-origin: top left;
            transition: transform 0.2s;
        }

        /* --- X MEN√úS√ú --- */
        #menu-btn {
            position: absolute; top: 10px; left: 10px; width: 45px; height: 45px;
            background: rgba(255, 51, 51, 0.9); color: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 2000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; border: 2px solid white;
        }
        #menu-btn:active { transform: scale(0.9); }

        #x-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1999; display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s;
        }
        #x-menu-overlay.active { display: flex; opacity: 1; }
        
        #x-menu-panel {
            width: 80%; max-width: 500px; height: 70%; background: rgba(255, 255, 255, 0.85);
            border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: translateY(50px); transition: transform 0.3s;
        }
        #x-menu-overlay.active #x-menu-panel { transform: translateY(0); }

        .x-header { padding: 20px; background: var(--accent-red); color: white; font-size: 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .x-tabs { display: flex; background: #eee; }
        .x-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
        .x-tab.active { border-bottom-color: var(--accent-red); background: white; font-weight: bold; color: var(--accent-red); }
        .x-content { flex: 1; padding: 20px; overflow-y: auto; }
        .x-page { display: none; } 
        .x-page.active { display: block; }

        .x-btn { width: 100%; padding: 12px; margin: 5px 0; background: white; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .x-btn:hover { background: var(--accent-hover); border-color: var(--accent-red); }
        
        .setting-slider { width: 100%; margin: 10px 0; }
        .setting-check { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }

        /* --- BA≈ûLANGI√á EKRANI --- */
        #start-screen { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f8f8; z-index: 1500; }
        #start-sidebar { width: 280px; background: white; border-right: 1px solid #ddd; padding: 30px; display: flex; flex-direction: column; }
        .template-card { width: 140px; height: 160px; background: white; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; transition: 0.2s; margin: 10px; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; }
        .template-card:hover { border-color: var(--accent-red); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .start-btn-side { padding: 10px; margin: 5px 0; border: none; background: var(--accent-red); color: white; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* --- ST√úDYO ARAY√úZ√ú --- */
        #studio-ui { display: none; flex-direction: column; height: 100%; }

        /* RIBBON BAR (GELƒ∞≈ûMƒ∞≈û SEKMELƒ∞) */
        #ribbon-container { height: var(--toolbar-height); background: white; border-bottom: 1px solid var(--border); display: flex; }
        #ribbon-tabs { width: 70px; background: #f0f0f0; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        .r-tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; color: #666; border-left: 3px solid transparent; }
        .r-tab.active { background: white; border-left-color: var(--accent-red); color: var(--accent-red); font-weight: bold; }
        .r-tab i { font-size: 20px; margin-bottom: 3px; font-style: normal; }
        
        #ribbon-tools { flex: 1; display: flex; align-items: center; padding: 0 10px; overflow-x: auto; gap: 5px; }
        .tool-list { display: none; gap: 5px; width: 100%; }
        .tool-list.active { display: flex; }

        .tool-btn { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 60px; height: 80px; border-radius: 5px; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .tool-btn:hover { background: var(--accent-hover); }
        .tool-btn.active { background: #ffebeb; border-color: var(--accent-red); }
        .tool-btn span { font-size: 24px; margin-bottom: 5px; }
        .tool-btn label { font-size: 11px; text-align: center; }

        /* MAIN AREA */
        #main-layout { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; }
        
        /* SAƒû PANEL (RESIZABLE & SCROLLABLE) */
        #right-panel {
            width: var(--panel-width); background: white; border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 50;
        }
        .panel-section { display: flex; flex-direction: column; overflow: hidden; }
        #explorer-sec { flex: 1; min-height: 100px; }
        #props-sec { flex: 1; min-height: 100px; border-top: 4px solid #eee; }
        .panel-head { padding: 8px; background: #eee; font-weight: bold; font-size: 12px; color: #555; display: flex; justify-content: space-between; }
        .panel-content { flex: 1; overflow-y: auto; padding: 5px; font-size: 13px; }
        
        /* OYUN KONTROLLERƒ∞ */
        #game-hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 100; }
        #joystick-zone { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.4); }
        #joystick-stick { position: absolute; width: 50px; height: 50px; background: white; border-radius: 50%; top: 35px; left: 35px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #jump-btn { position: absolute; bottom: 60px; right: 40px; width: 90px; height: 90px; background: rgba(255,51,51,0.8); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; border: 3px solid white; }
        
        /* SAƒûLIK BARI */
        #hp-container { position: absolute; top: 20px; right: 20px; width: 200px; height: 25px; background: rgba(0,0,0,0.5); border-radius: 12px; border: 2px solid white; overflow: hidden; }
        #hp-bar { width: 100%; height: 100%; background: #00ff00; transition: 0.2s; }

        /* Gƒ∞ZLƒ∞ DOSYA Gƒ∞Rƒ∞≈ûƒ∞ */
        #file-input { display: none; }

        /* YARDIMCI CSS */
        .prop-row { display: flex; align-items: center; margin-bottom: 4px; }
        .prop-row label { width: 40%; font-size: 11px; color: #666; }
        .prop-row input, .prop-row select { width: 60%; border: 1px solid #ccc; padding: 2px; font-size: 11px; }
        .tree-node { padding: 3px; cursor: pointer; border-radius: 3px; }
        .tree-node:hover { background: #f0f0f0; }
        .tree-node.selected { background: #cce5ff; border: 1px solid #a3d2ff; }
    </style>
</head>
<body onload="App.init()">

    <div id="studio-container">
        <div id="menu-btn" onclick="UI.toggleMenu()">‚ò∞</div>
        
        <div id="x-menu-overlay" onclick="if(event.target==this) UI.toggleMenu()">
            <div id="x-menu-panel">
                <div class="x-header">
                    <span>LunX Men√º</span>
                    <span style="cursor:pointer" onclick="UI.toggleMenu()">‚úï</span>
                </div>
                <div class="x-tabs">
                    <div class="x-tab active" onclick="UI.tab('main', event.currentTarget)">Ana</div>
                    <div class="x-tab" onclick="UI.tab('settings', event.currentTarget)">Ayarlar</div>
                    <div class="x-tab" onclick="UI.tab('help', event.currentTarget)">Nasƒ±l?</div>
                </div>
                <div class="x-content">
                    <div id="page-main" class="x-page active">
                        <div class="x-btn" onclick="App.reset()">üîÅ Projeyi Sƒ±fƒ±rla</div>
                        <div class="x-btn" onclick="App.exit()">üè† Ana Men√ºye D√∂n</div>
                    </div>
                    <div id="page-settings" class="x-page">
                        <label>Aray√ºz Boyutu (0.6x - 1.2x)</label>
                        <input type="range" min="0.6" max="1.2" step="0.1" value="1" class="setting-slider" oninput="UI.setScale(this.value)">
                        
                        <label>Grafik Kalitesi (0.1 - 1.5)</label>
                        <input type="range" min="0.1" max="1.5" step="0.1" value="1" class="setting-slider" onchange="App.setQuality(this.value)">
                        
                        <div class="setting-check">
                            <label for="keylock-check">Kontrol Tu≈ü Kilidi (Hareket/D√∂nd√ºrme)</label>
                            <input type="checkbox" id="keylock-check" onchange="App.setControlLock(this.checked)">
                        </div>
                        
                        <div class="x-btn" onclick="location.reload()">‚öôÔ∏è Yeniden Ba≈ülat</div>
                    </div>
                    <div id="page-help" class="x-page">
                        <p>‚Ä¢ <b>Texture:</b> Saƒü panelden 'Dosya Se√ß' ile cihazƒ±nƒ±zdan resim y√ºkleyin.</p>
                        <p>‚Ä¢ <b>Sculpt:</b> Terrain sekmesinde "Sculpt" aracƒ±nƒ± se√ßin ve "Add" veya "Sub" ile araziyi ≈üekillendirin.</p>
                        <p>‚Ä¢ <b>Hasar:</b> Bloƒüun 'Damage' deƒüerini artƒ±rƒ±n (√ñzellikler panelinde).</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="start-screen">
            <div id="start-sidebar">
                <h1 style="color:var(--accent-red); margin-top:0;">LunX Studio</h1>
                <p>Versiyon: V10.0 (Joystick Fix)</p>
                <button class="start-btn-side" onclick="App.start('baseplate')">Yeni Proje Ba≈ülat</button>
                <button class="start-btn-side" style="background:#666">Projelerim (Yakƒ±nda)</button>
            </div>
            <div style="flex:1; padding:40px;">
                <h3>≈ûablon Se√ß</h3>
                <div style="display:flex; gap:20px;">
                    <div class="template-card" onclick="App.start('baseplate')">
                        <div style="font-size:40px;">‚¨ú</div><div>Baseplate</div>
                    </div>
                    <div class="template-card" onclick="App.start('flat')">
                        <div style="font-size:40px;">üü©</div><div>Flat Terrain</div>
                    </div>
                    <div class="template-card" onclick="App.start('village')">
                        <div style="font-size:40px;">üè°</div><div>Village (Demo)</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="studio-ui">
            <div id="ribbon-container">
                <div id="ribbon-tabs">
                    <div class="r-tab active" onclick="UI.ribbon('home', event.currentTarget)"><i>üè†</i>Home</div>
                    <div class="r-tab" onclick="UI.ribbon('model', event.currentTarget)"><i>üßä</i>Model</div>
                    <div class="r-tab" onclick="UI.ribbon('terrain', event.currentTarget)"><i>‚õ∞Ô∏è</i>Terrain</div>
                    <div class="r-tab" onclick="UI.ribbon('view', event.currentTarget)"><i>üëÅÔ∏è</i>View</div>
                </div>
                
                <div id="ribbon-tools">
                    <div id="list-home" class="tool-list active">
                        <div class="tool-btn active" id="t-sel" onclick="Tools.setMode('select')"><span>üëÜ</span><label>Se√ß</label></div>
                        <div class="tool-btn" id="t-mov" onclick="Tools.setMode('translate')"><span>‚ÜîÔ∏è</span><label>Ta≈üƒ±</label></div>
                        <div class="tool-btn" id="t-sca" onclick="Tools.setMode('scale')"><span>‚§¢</span><label>Boyut</label></div>
                        <div class="tool-btn" id="t-rot" onclick="Tools.setMode('rotate')"><span>üîÑ</span><label>D√∂nd√ºr</label></div>
                        <div style="width:1px; background:#ccc; height:80%;"></div>
                        <div class="tool-btn" onclick="Tools.toggleAnchor()"><span>‚öì</span><label>Anchor</label></div>
                        <div class="tool-btn" onclick="Tools.delete()"><span>üóëÔ∏è</span><label>Sil</label></div>
                        <div style="width:1px; background:#ccc; height:80%;"></div>
                        <div class="tool-btn" onclick="Game.play()"><span style="color:green">‚ñ∂Ô∏è</span><label>Oyna</label></div>
                    </div>

                    <div id="list-model" class="tool-list">
                        <div class="tool-btn" onclick="World.add('box')"><span>üì¶</span><label>Part</label></div>
                        <div class="tool-btn" onclick="World.add('sphere')"><span>‚ö™</span><label>Sphere</label></div>
                        <div class="tool-btn" onclick="World.add('cylinder')"><span>üõ¢Ô∏è</span><label>Cyl</label></div>
                        <div class="tool-btn" onclick="World.add('wedge')"><span>üìê</span><label>Wedge</label></div>
                        <div class="tool-btn" onclick="World.add('cone')"><span>‚ö†Ô∏è</span><label>Cone</label></div>
                        <div class="tool-btn" onclick="World.add('torus')"><span>üç©</span><label>Torus</label></div>
                        <div style="width:1px; background:#ccc; height:80%;"></div>
                        <div class="tool-btn" onclick="World.addSpecial('neon')"><span>üí°</span><label>Neon</label></div>
                        <div class="tool-btn" onclick="World.addSpecial('glass')"><span>ü™ü</span><label>Glass</label></div>
                        <div class="tool-btn" onclick="World.addSpecial('fire')"><span>üî•</span><label>Fire (Demo)</label></div>
                        <div class="tool-btn" onclick="World.addSpecial('damage')"><span>üíÄ</span><label>Kill Block</label></div>
                        <div class="tool-btn" onclick="World.addSpecial('light')"><span>üî¶</span><label>Light</label></div>
                    </div>

                    <div id="list-terrain" class="tool-list">
                        <div class="tool-btn" id="t-sculpt" onclick="Tools.setSculpt(true)"><span>üñåÔ∏è</span><label>Sculpt Aktif</label></div>
                        <div class="tool-btn" onclick="Tools.sculptMode='add'"><span>‚ûï</span><label>Y√ºkselt</label></div>
                        <div class="tool-btn" onclick="Tools.sculptMode='sub'"><span>‚ûñ</span><label>Al√ßalt</label></div>
                        <div class="tool-btn" onclick="Tools.sculptRadius+=1"><span>‚≠ï</span><label>Boyut: ${Tools.sculptRadius}</label></div>
                    </div>
                    
                    <div id="list-view" class="tool-list">
                        <div class="tool-btn" onclick="UI.toggleExplorer()"><span>üóÇÔ∏è</span><label>Explorer</label></div>
                        <div class="tool-btn" onclick="UI.toggleProps()"><span>üìù</span><label>Props</label></div>
                    </div>
                </div>
            </div>

            <div id="main-layout">
                <div id="viewport"></div>

                <div id="game-hud">
                    <div id="hp-container"><div id="hp-bar"></div></div>
                    <div id="joystick-zone"><div id="joystick-stick"></div></div>
                    <div id="jump-btn" onclick="Game.jump()">‚¨Ü</div>
                    <button style="position:absolute; top:10px; left:50%; transform:translateX(-50%); padding:10px 20px; background:red; color:white; border:none; font-weight:bold; border-radius:20px; pointer-events:auto;" onclick="Game.stop()">DURDUR</button>
                </div>

                <div id="right-panel">
                    <div id="explorer-sec" class="panel-section">
                        <div class="panel-head">Explorer</div>
                        <div id="explorer" class="panel-content"></div>
                    </div>
                    <div id="props-sec" class="panel-section">
                        <div class="panel-head">Properties</div>
                        <div id="properties" class="panel-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/*" onchange="World.applyTexture(this)">

    <script>
        const App = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            objects: [], selected: null,
            raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),
            
            lockControls: false, // YENƒ∞: Tu≈ü Kilidi Durumu
            
            init: () => {
                // Joystick input'larƒ± body'e atanacak
                const joy = document.getElementById('joystick-zone');
                joy.addEventListener('touchstart', Game.joyStart, {passive:false});
                joy.addEventListener('touchmove', Game.joyMove, {passive:false});
                joy.addEventListener('touchend', Game.joyEnd);
            },
            
            start: (template) => {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('studio-ui').style.display = 'flex';
                ThreeEngine.init();
                World.load(template);
            },
            
            exit: () => location.reload(),
            reset: () => {
                App.objects.forEach(o => App.scene.remove(o));
                App.objects = [];
                World.createBaseplate('baseplate'); // Baseplate yeniden olu≈üturuldu
                UI.toggleMenu();
            },
            
            setQuality: (val) => {
                const q = parseFloat(val);
                App.renderer.setPixelRatio(window.devicePixelRatio * q);
            },

            // YENƒ∞: Kontrol Tu≈ü Kilidi Fonksiyonu
            setControlLock: (locked) => {
                App.lockControls = locked;
                App.controls.enabled = !locked;
                App.transform.enabled = !locked; // Transform kontrolleri de kilitlenir
            }
        };

        const ThreeEngine = {
            init: () => {
                const cont = document.getElementById('viewport');
                App.scene = new THREE.Scene();
                
                App.scene.background = new THREE.Color(0x87CEEB);
                App.scene.fog = new THREE.Fog(0x87CEEB, 30, 200);

                App.camera = new THREE.PerspectiveCamera(60, cont.clientWidth / cont.clientHeight, 0.1, 2000);
                App.camera.position.set(20, 20, 20);

                App.renderer = new THREE.WebGLRenderer({ antialias: true });
                App.renderer.setSize(cont.clientWidth, cont.clientHeight);
                App.renderer.shadowMap.enabled = true;
                cont.appendChild(App.renderer.domElement);

                // I≈üƒ±klar
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                App.scene.add(hemi);
                
                const sun = new THREE.DirectionalLight(0xffffff, 1);
                sun.position.set(50, 100, 50);
                sun.castShadow = true;
                sun.shadow.mapSize.width = 2048; sun.shadow.mapSize.height = 2048;
                App.scene.add(sun);
                
                // Kontroller
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', e => App.controls.enabled = !e.value && !App.lockControls);
                App.transform.addEventListener('change', UI.updateProps);
                App.scene.add(App.transform);

                // Eventler
                window.addEventListener('resize', ThreeEngine.resize);
                cont.addEventListener('mousedown', Tools.onSelect);
                cont.addEventListener('touchstart', Tools.onSelect, {passive:false});

                ThreeEngine.loop();
            },
            
            resize: () => {
                const c = document.getElementById('viewport');
                App.camera.aspect = c.clientWidth / c.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(c.clientWidth, c.clientHeight);
            },

            loop: () => {
                requestAnimationFrame(ThreeEngine.loop);
                if(Game.active) Game.update();
                else App.controls.update();
                App.renderer.render(App.scene, App.camera);
            }
        };

        const World = {
            terrain: null,
            
            load: (type) => {
                World.createBaseplate(type);
                if(type === 'village') {
                    World.add('box', 'Plastic', 0x994444).position.set(10, 4, 10);
                    World.add('box', 'Plastic', 0x994444).position.set(-10, 4, -10);
                }
            },

            createBaseplate: (type) => {
                // Baseplate'i temizle
                if(World.terrain) App.scene.remove(World.terrain);
                
                const geo = new THREE.PlaneGeometry(1000, 1000, 100, 100);
                const mat = new THREE.MeshStandardMaterial({ color: type==='flat'?0x55aa55:0x555555, side:THREE.DoubleSide });
                const plane = new THREE.Mesh(geo, mat);
                plane.rotation.x = -Math.PI/2;
                plane.receiveShadow = true;
                plane.name = "Terrain";
                plane.userData = { anchored: true, locked: true, type: 'terrain' };
                App.scene.add(plane);
                App.objects.push(plane);
                World.terrain = plane;
                
                // Spawn (Sadece 1 tane olmalƒ±, varsa konumu g√ºnceller)
                let spawn = App.objects.find(o => o.name === "SpawnLocation");
                if (!spawn) {
                    const sGeo = new THREE.BoxGeometry(6,1,6);
                    const sMat = new THREE.MeshLambertMaterial({color:0xaaaaaa});
                    spawn = new THREE.Mesh(sGeo, sMat);
                    spawn.name = "SpawnLocation";
                    spawn.userData = { anchored: true, locked:true };
                    App.scene.add(spawn);
                    App.objects.push(spawn);
                }
                spawn.position.set(0, 0.5, 0); // Konum sƒ±fƒ±rlandƒ±
                
                UI.updateExplorer();
            },

            add: (type, matType="Plastic", color=0xcccccc) => {
                let geo;
                if(type==='sphere') geo = new THREE.SphereGeometry(2,32,32);
                else if(type==='cylinder') geo = new THREE.CylinderGeometry(2,2,4,32);
                else if(type==='cone') geo = new THREE.ConeGeometry(2,4,32);
                else if(type==='torus') geo = new THREE.TorusGeometry(2,0.5,16,100);
                else if(type==='wedge') {
                    // Basit Wedge geometrisi (Yatay Prizma)
                    const shape = new THREE.Shape();
                    shape.moveTo(0, 0);
                    shape.lineTo(4, 0);
                    shape.lineTo(0, 4);
                    shape.lineTo(0, 0);
                    const extrudeSettings = { depth: 4, bevelEnabled: false };
                    geo = new THREE.ExtrudeGeometry(shape, extrudeSettings);
                }
                else geo = new THREE.BoxGeometry(4,4,4);

                const mat = new THREE.MeshStandardMaterial({color: color});
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(0,10,0);
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.name = "Part";
                
                mesh.userData = { anchored: true, canCollide: true, velocity: new THREE.Vector3(), type:type };
                
                App.scene.add(mesh);
                App.objects.push(mesh);
                Tools.select(mesh);
                UI.updateExplorer();
                return mesh;
            },
            
            addSpecial: (type) => {
                let p;
                if(type==='neon') { p = World.add('box', 'Neon', 0x00ffff); p.material = new THREE.MeshBasicMaterial({color:0x00ffff, emissive:0x00ffff}); }
                if(type==='glass') { p = World.add('box', 'Glass', 0xaaccff); p.material = new THREE.MeshPhysicalMaterial({color: 0xaaccff, transparent: true, opacity: 0.5, metalness: 0.1, roughness: 0.2}); }
                if(type==='damage') { p = World.add('box', 'Plastic', 0xff0000); p.userData.damage = 10; p.name="KillBrick"; p.userData.anchored = true; }
                if(type==='light') { p = World.add('sphere', 'Neon', 0xffffaa); const l = new THREE.PointLight(0xffffaa, 1, 20); p.add(l); p.material = new THREE.MeshBasicMaterial({color: 0xffffaa, emissive: 0xffffaa}); p.userData.anchored = true; }
                if(type==='fire') { alert("Fire (Ate≈ü) efekti bu s√ºr√ºmde sadece g√∂rsel bir demo objesidir."); }
            },

            uploadTexture: () => document.getElementById('file-input').click(),
            applyTexture: (input) => {
                if(input.files && input.files[0] && App.selected) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const tex = new THREE.TextureLoader().load(e.target.result);
                        App.selected.material.map = tex;
                        App.selected.material.needsUpdate = true;
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }
        };

        const Tools = {
            mode: 'select',
            sculptMode: 'add',
            sculptRadius: 5,

            setMode: (m) => {
                // Sculpt modunu kapat
                document.getElementById('t-sculpt').classList.remove('active');
                
                Tools.mode = m;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('t-'+m.charAt(0)).classList.add('active');

                if(m==='select') App.transform.detach();
                else {
                    App.transform.setMode(m);
                    if(App.selected) App.transform.attach(App.selected);
                }
            },
            
            setSculpt: (active) => {
                Tools.setMode('select'); // Diƒüer ara√ßlarƒ± kapat
                document.getElementById('t-sculpt').classList.toggle('active', active);
            },

            onSelect: (e) => {
                if(Game.active) return;
                if(App.lockControls) return; // Kontrol Tu≈ü Kilidi kontrol√º

                e.preventDefault();
                
                const rect = App.renderer.domElement.getBoundingClientRect();
                const x = ((e.clientX || e.touches[0].clientX) - rect.left) / rect.width * 2 - 1;
                const y = -((e.clientY || e.touches[0].clientY) - rect.top) / rect.height * 2 + 1;
                
                App.raycaster.setFromCamera({x,y}, App.camera);

                // Sculpt Logic
                if(document.getElementById('t-sculpt').classList.contains('active')) {
                    const intersects = App.raycaster.intersectObject(World.terrain);
                    if(intersects.length > 0) {
                        Tools.doSculpt(intersects[0].point);
                    }
                    return;
                }

                // Select Logic
                const intersects = App.raycaster.intersectObjects(App.objects);
                if(intersects.length > 0) Tools.select(intersects[0].object);
                else Tools.select(null);
            },

            select: (obj) => {
                App.selected = obj;
                if(obj && !obj.userData.locked) App.transform.attach(obj);
                else App.transform.detach();
                UI.updateProps();
                UI.updateExplorer();
            },
            
            toggleAnchor: () => {
                if(App.selected && !App.selected.userData.locked) {
                    App.selected.userData.anchored = !App.selected.userData.anchored;
                    UI.updateProps();
                }
            },
            
            delete: () => {
                if(App.selected && !App.selected.userData.locked) {
                    App.scene.remove(App.selected);
                    App.transform.detach();
                    App.objects = App.objects.filter(o => o !== App.selected);
                    App.selected = null;
                    UI.updateExplorer();
                    UI.updateProps();
                }
            },

            doSculpt: (point) => {
                const geometry = World.terrain.geometry;
                const pos = geometry.attributes.position;
                const r = Tools.sculptRadius;
                const amount = Tools.sculptMode === 'add' ? 0.3 : -0.3; // Y√ºkseklik deƒüi≈üim miktarƒ±

                for (let i = 0; i < pos.count; i++) {
                    const localVector = new THREE.Vector3(pos.getX(i), pos.getY(i), pos.getZ(i));
                    
                    // Vertex'in global pozisyonu
                    World.terrain.localToWorld(localVector); 
                    
                    // D√ºzlem √ºzerinde (X-Z) mesafe
                    const dist = Math.sqrt((localVector.x - point.x)**2 + (localVector.z - point.z)**2);
                    
                    if(dist < r) {
                        const factor = (r - dist) / r; // Merkezde daha g√º√ßl√º (0'dan 1'e)
                        const change = amount * factor;
                        
                        // Y√ºksekliƒüi deƒüi≈ütir (Y ekseni)
                        const newY = pos.getZ(i) + change; // Plane Geometry'de Z, y√ºkseklik (Y) olarak kullanƒ±lƒ±r
                        pos.setZ(i, newY);
                    }
                }
                pos.needsUpdate = true;
                geometry.computeVertexNormals();
            }
        };

        const UI = {
            ribbon: (tab, target) => {
                document.querySelectorAll('#ribbon-tabs .r-tab').forEach(t => t.classList.remove('active'));
                target.classList.add('active');
                document.querySelectorAll('.tool-list').forEach(l => l.classList.remove('active'));
                document.getElementById('list-'+tab).classList.add('active');
            },
            
            toggleMenu: () => {
                const overlay = document.getElementById('x-menu-overlay');
                overlay.classList.toggle('active');
                if(!overlay.classList.contains('active')) {
                    // Kapatƒ±lƒ±rken display:none yap
                    setTimeout(() => overlay.style.display = 'none', 300);
                } else {
                    overlay.style.display = 'flex';
                }
            },
            
            tab: (page, target) => {
                document.querySelectorAll('.x-tab').forEach(t => t.classList.remove('active'));
                target.classList.add('active');
                document.querySelectorAll('.x-page').forEach(p => p.classList.remove('active'));
                document.getElementById('page-'+page).classList.add('active');
            },

            updateExplorer: () => {
                const list = document.getElementById('explorer');
                list.innerHTML = '';
                App.objects.forEach(obj => {
                    const el = document.createElement('div');
                    el.className = 'tree-node ' + (App.selected === obj ? 'selected' : '');
                    el.innerText = (obj.userData.locked ? "üîí " : "üì¶ ") + obj.name;
                    el.onclick = () => Tools.select(obj);
                    list.appendChild(el);
                });
            },

            updateProps: () => {
                const p = document.getElementById('properties');
                p.innerHTML = '';
                const obj = App.selected;
                if(!obj) return;

                const addRow = (lbl, val, type, cb) => {
                    const div = document.createElement('div'); div.className='prop-row';
                    div.innerHTML = `<label>${lbl}</label>`;
                    
                    if(type === 'btn') {
                        const btn = document.createElement('button');
                        btn.innerText = val; btn.onclick = cb;
                        div.appendChild(btn);
                    } else {
                        const inp = document.createElement('input');
                        inp.type = type;
                        if(type==='checkbox') inp.checked = val; else inp.value = val;
                        inp.onchange = (e) => cb(type==='checkbox' ? e.target.checked : Number(e.target.value));
                        div.appendChild(inp);
                    }
                    p.appendChild(div);
                };

                addRow("Name", obj.name, 'text', v => {obj.name=v; UI.updateExplorer()});
                
                if(!obj.userData.locked) {
                    addRow("Anchored", obj.userData.anchored, 'checkbox', v => obj.userData.anchored=v);
                    
                    // Position, Rotation, Scale (Sadece 1. deƒüerler g√∂steriliyor)
                    addRow("X", obj.position.x.toFixed(2), 'number', v => {obj.position.x=v; App.transform.update();});
                    addRow("Y", obj.position.y.toFixed(2), 'number', v => {obj.position.y=v; App.transform.update();});
                    addRow("Z", obj.position.z.toFixed(2), 'number', v => {obj.position.z=v; App.transform.update();});
                    
                    // Material
                    if(obj.material.color) addRow("Color", "#"+obj.material.color.getHexString(), 'color', v => obj.material.color.set(v));
                    addRow("Texture", "Dosya Se√ß", 'btn', () => World.uploadTexture());
                    
                    // Custom Props
                    if(obj.userData.damage !== undefined) addRow("Damage", obj.userData.damage, 'number', v=>obj.userData.damage=v);
                }
            },

            setScale: (s) => {
                document.getElementById('studio-container').style.transform = `scale(${s})`;
                ThreeEngine.resize(); // √ñl√ßekleme sonrasƒ± viewport'u g√ºncelle
            },
            
            toggleExplorer: () => document.getElementById('right-panel').style.width === '0px' ? document.getElementById('right-panel').style.width = 'var(--panel-width)' : document.getElementById('right-panel').style.width = '0px',
            toggleProps: () => UI.toggleExplorer() // Basit√ße aynƒ± paneli kullanƒ±yoruz
        };

        const Game = {
            active: false,
            player: null,
            health: 100,
            joyInput: { x:0, y:0, active: false },

            play: () => {
                Game.active = true;
                App.transform.detach();
                App.controls.enabled = false; // Kontrolleri kapat
                document.getElementById('ribbon-container').style.display = 'none';
                document.getElementById('right-panel').style.display = 'none';
                document.getElementById('menu-btn').style.display = 'none';
                document.getElementById('game-hud').style.display = 'block';
                
                // Oyuncu modelini olu≈ütur ve Spawn'a yerle≈ütir
                const p = new THREE.Group(); p.name = "Player";
                const skin = new THREE.MeshPhongMaterial({color:0xffcc00});
                const blue = new THREE.MeshPhongMaterial({color:0x0099ff});
                const green = new THREE.MeshPhongMaterial({color:0x22aa22});
                const head = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), skin); head.position.y=4.5;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), blue); torso.position.y=3;
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), skin); la.position.set(-1.5,3,0);
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), skin); ra.position.set(1.5,3,0);
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), green); ll.position.set(-0.5,1,0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), green); rl.position.set(0.5,1,0);
                p.add(head, torso, la, ra, ll, rl);
                
                const spawn = App.objects.find(o=>o.name==='SpawnLocation');
                if(spawn) p.position.copy(spawn.position).add(new THREE.Vector3(0,2,0));
                else p.position.set(0,5,0);

                p.userData = { velocity: new THREE.Vector3(), onGround: false, limbs: {la,ra,ll,rl} };
                App.scene.add(p);
                Game.player = p;

                // Kamera ayarlarƒ±
                App.controls.maxPolarAngle = Math.PI/2 - 0.1;
                App.controls.target.copy(p.position);
            },

            stop: () => {
                Game.active = false;
                document.getElementById('ribbon-container').style.display = 'flex';
                document.getElementById('right-panel').style.display = 'flex';
                document.getElementById('menu-btn').style.display = 'flex';
                document.getElementById('game-hud').style.display = 'none';
                
                if(Game.player) App.scene.remove(Game.player);
                Game.player = null;
                Game.health = 100;
                document.getElementById('hp-bar').style.width = '100%';

                // Reset Camera
                App.controls.enabled = true; // Kontrolleri a√ß
                App.camera.position.set(20,20,20);
                App.controls.target.set(0,0,0);
                App.controls.maxPolarAngle = Math.PI;
            },

            update: () => {
                if(!Game.player) return;
                const p = Game.player;
                const v = p.userData.velocity;

                // 1. Gravity & Collision
                v.y -= 0.02;
                p.position.y += v.y;

                let groundY = -100;
                const pBox = new THREE.Box3().setFromObject(p);
                
                App.objects.forEach(obj => {
                    if(obj.userData.anchored && obj !== p) {
                        const oBox = new THREE.Box3().setFromObject(obj);
                        if(oBox.intersectsBox(pBox)) {
                            // Basit Platform √ßarpƒ±≈ümasƒ±
                            if(obj.position.y < p.position.y && obj.position.y + 2 > groundY) {
                                groundY = obj.position.y + 2; 
                            }
                            // Damage
                            if(obj.userData.damage && obj.userData.damage > 0) {
                                Game.health -= obj.userData.damage / 10;
                                document.getElementById('hp-bar').style.width = Game.health + '%';
                                if(Game.health <= 0) Game.respawn();
                            }
                        }
                    }
                });

                if(p.position.y <= groundY) {
                    p.position.y = groundY;
                    v.y = 0;
                    p.userData.onGround = true;
                } else {
                    p.userData.onGround = false;
                }

                // 2. Movement & Anim (Joystick)
                if(Game.joyInput.active) {
                    const speed = 0.2;
                    const camAngle = App.controls.getAzimuthalAngle();
                    
                    // Kamera y√∂n√ºne g√∂re hareket vekt√∂r√ºn√º hesapla
                    const forward = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0, 1, 0), camAngle);
                    const right = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0, 1, 0), camAngle);
                    
                    // Joystick input'larƒ±nƒ± uygula (Y=-ileri, X=saƒü)
                    let move = forward.multiplyScalar(-Game.joyInput.y).add(right.multiplyScalar(Game.joyInput.x));
                    move.y = 0; // Yatay hareketi koru
                    move.normalize().multiplyScalar(speed);
                    
                    p.position.add(move);
                    
                    // Oyuncuyu hareket y√∂n√ºne d√∂nd√ºr
                    if(move.length() > 0.01) {
                         // Mevcut pozisyondan hedef pozisyona bak
                        p.lookAt(p.position.clone().add(move));
                    }

                    // Anim
                    const t = Date.now() * 0.015;
                    p.userData.limbs.ll.rotation.x = Math.sin(t);
                    p.userData.limbs.rl.rotation.x = -Math.sin(t);
                    p.userData.limbs.la.rotation.x = -Math.sin(t);
                    p.userData.limbs.ra.rotation.x = Math.sin(t);
                } else {
                    // Idle
                    for(let k in p.userData.limbs) p.userData.limbs[k].rotation.x = 0;
                }

                // Camera Follow (Hafif yumu≈üak takip)
                App.controls.target.lerp(p.position, 0.1);
            },

            respawn: () => {
                Game.health = 100;
                document.getElementById('hp-bar').style.width = '100%';
                const spawn = App.objects.find(o=>o.name==='SpawnLocation');
                Game.player.position.copy(spawn ? spawn.position : new THREE.Vector3(0,5,0)).add(new THREE.Vector3(0,2,0));
            },

            // Input Handlers
            joyStart: (e) => {
                Game.joyInput.active = true;
                Game.joyMove(e);
            },
            joyMove: (e) => {
                if(!Game.joyInput.active) return;
                e.preventDefault();
                const rect = document.getElementById('joystick-zone').getBoundingClientRect();
                const center = { x: rect.left + 60, y: rect.top + 60 };
                const touch = e.touches[0];
                
                let dx = touch.clientX - center.x;
                let dy = touch.clientY - center.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                const maxDist = 40;
                if(dist > maxDist) {
                    const angle = Math.atan2(dy, dx);
                    dx = Math.cos(angle) * maxDist;
                    dy = Math.sin(angle) * maxDist;
                }
                
                document.getElementById('joystick-stick').style.transform = `translate(${dx}px, ${dy}px)`;
                Game.joyInput.x = dx / maxDist;
                Game.joyInput.y = -dy / maxDist; // Y Ekseni ters √ßevrildi (Yukarƒ± pozitif)
            },
            joyEnd: () => {
                Game.joyInput.active = false;
                Game.joyInput.x = 0; Game.joyInput.y = 0;
                document.getElementById('joystick-stick').style.transform = `translate(0,0)`;
            },
            jump: () => {
                if(Game.player && Game.player.userData.onGround) {
                    Game.player.userData.velocity.y = 0.8;
                    Game.player.userData.onGround = false;
                }
            }
        };
    </script>
</body>
</html>
