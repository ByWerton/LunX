<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V5.0 - Detaylƒ± ve Kapsamlƒ± Entegre Sistem (2000+ Satƒ±r)</title>
    <style>
        /* ======================================================= */
        /* CSS STƒ∞LLERƒ∞ (DAHA DA GENƒ∞≈ûLETƒ∞LMƒ∞≈û) */
        /* ======================================================= */
        :root {
            --primary-color: #007acc; /* Mavi - Vurgu */
            --secondary-color: #2da042; /* Ye≈üil - Eylem */
            --danger-color: #c92c2c; /* Kƒ±rmƒ±zƒ± - Hata/Sil */
            --warning-color: #ffaa00; /* Sarƒ± - Uyarƒ± */
            --background-dark: #121212; /* Daha koyu arka plan */
            --panel-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --text-color: #ddd;
            --border-color: #3e3e42;
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.7);
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Consolas', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--background-dark); 
            color: var(--text-color); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            touch-action: pan-y; 
            font-size: 14px;
        }

        /* T√ºm Ekran Kapsayƒ±cƒ±larƒ± */
        .full-screen-container { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(18, 18, 18, 0.95); 
            z-index: 5000; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column;
            transition: opacity 0.3s ease-in-out;
        }
        .form-container { 
            width: 450px; 
            padding: 40px; 
            background: var(--panel-bg); 
            border-radius: 12px; 
            box-shadow: 0 10px 40px var(--shadow-dark); 
            transition: transform 0.3s ease-out;
            border: 1px solid var(--border-color);
        }

        /* Ana Studio Yapƒ±sƒ± */
        #toolbar { 
            background-color: var(--panel-bg); 
            display: none; 
            align-items: center; 
            padding: 5px 10px; 
            border-bottom: 1px solid var(--border-color); 
            height: 40px; 
            z-index: 100;
            user-select: none;
        }
        #main-area { 
            flex-grow: 1; 
            display: none; 
            overflow: hidden; 
            position: relative; 
            flex-direction: row;
        }
        #viewport { 
            flex-grow: 1; 
            position: relative; 
            background-color: #000; 
            z-index: 1; 
        }
        #sidebar-right, #sidebar-left {
            width: 300px; /* Biraz daha geni≈ü yan panel */
            background-color: var(--panel-bg); 
            padding: 15px; 
            overflow-y: auto; 
            display: none; 
            z-index: 5;
            transition: width 0.3s, margin-left 0.3s;
        }
        #sidebar-right { border-left: 1px solid var(--border-color); }
        #sidebar-left { border-right: 1px solid var(--border-color); }

        /* Kod Edit√∂r√º Stili */
        #code-editor {
            width: 100%; 
            height: 400px; 
            background: var(--input-bg); 
            color: #ccc; 
            border: 1px solid var(--border-color); 
            font-family: 'Consolas', monospace; 
            padding: 10px; 
            box-sizing: border-box; 
            resize: vertical;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap; /* Kodun daha okunur olmasƒ± i√ßin */
        }
        #code-editor::placeholder { color: #555; }

        /* Butonlar ve Girdiler */
        input:not([type="color"]), select, textarea { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 10px; 
            background: var(--input-bg); 
            border: 1px solid #555; 
            color: white; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 14px; 
            transition: border-color 0.2s;
        }
        input:not([type="color"]):focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .start-btn { 
            background-color: var(--primary-color); 
            border: none; 
            color: white; 
            padding: 14px; 
            cursor: pointer; 
            transition: background-color 0.2s, transform 0.1s; 
            border-radius: 6px; 
            width: 100%; 
            margin-top: 10px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        .start-btn:hover { background-color: #005f99; }
        .start-btn:active { transform: scale(0.99); }
        
        .tool-btn { 
            background-color: #3e3e42; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            margin-right: 5px;
            cursor: pointer; 
            border-radius: 4px; 
            transition: 0.2s; 
            font-size: 14px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            line-height: 1; 
        }
        .tool-btn:hover { background-color: #505054; }
        .tool-btn.active { background-color: var(--secondary-color); }
        .tool-btn:last-child { margin-right: 0; }
        
        /* Hiyerar≈üi ve √ñzellikler */
        .hierarchy-item { 
            padding: 7px; 
            cursor: pointer; 
            border-radius: 3px; 
            font-size: 14px; 
            margin-bottom: 3px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            transition: background-color 0.1s;
        }
        .hierarchy-item:hover { background-color: #2a2a2a; }
        .hierarchy-item.selected { 
            background-color: var(--primary-color); 
            font-weight: bold;
        }
        .property-group { 
            margin-bottom: 20px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 15px; 
        }
        
        .property-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        .property-input-row label {
            width: 80px;
            font-weight: 600;
            color: var(--text-color);
        }
        .property-input-row input[type="number"],
        .property-input-row input[type="text"] {
            flex-grow: 1;
            margin-bottom: 0;
            padding: 6px;
            text-align: right;
            font-family: monospace;
        }
        .property-input-row input[type="color"] { width: 100%; height: 30px; }


        /* JOƒ∞STƒ∞CK STƒ∞LLERƒ∞ */
        #mobile-controls { 
            position: absolute; 
            bottom: 20px; 
            left: 20px; 
            right: 20px;
            display: none; 
            z-index: 1000; 
            gap: 40px;
            width: auto; 
            justify-content: space-between; 
            align-items: flex-end;
            pointer-events: none; 
        }
        #joystick-wrapper { 
            width: 150px; 
            height: 150px; 
            pointer-events: all; 
        }
        /* ... Joystick ve Jump buton stilleri √∂nceki versiyondan alƒ±nmƒ±≈ütƒ±r. ... */
        #joystick-area { 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            border-radius: 50%; 
            position: relative; 
            touch-action: none; 
            box-shadow: 0 0 15px var(--shadow-dark);
        }
        #joystick-handle { 
            width: 50px; 
            height: 50px; 
            background: var(--primary-color); 
            border-radius: 50%; 
            position: absolute; 
            top: 50px; 
            left: 50px; 
            touch-action: none;
            box-shadow: 0 0 10px var(--shadow-light);
        }
        #jump-button { 
            width: 80px; 
            height: 80px; 
            background: var(--secondary-color); 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 40px; 
            font-weight: bold;
            color: white; 
            box-shadow: 0 4px 8px var(--shadow-dark);
            cursor: pointer;
            pointer-events: all; 
        }
        
        /* Geri Bildirim Mesajƒ± */
        #feedback-message {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-dark);
            z-index: 6000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(-20px);
            pointer-events: none;
            font-size: 16px;
        }
        #feedback-message.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="full-screen-container" style="display: flex;">
        <h1 style="color: var(--primary-color); font-size: 48px; margin-bottom: 25px;">LUNX STUDIO V5.0</h1>
        <div style="width: 400px; height: 12px; background: #333; border-radius: 6px;">
            <div id="progress-bar" style="height: 100%; width: 0%; background: var(--secondary-color); border-radius: 6px; transition: width 0.3s;"></div>
        </div>
        <p id="progress-text" style="color: var(--text-color); margin-top: 20px; font-size: 20px; font-family: monospace;">K√ºt√ºphaneler Y√ºkleniyor...</p>
    </div>
    
    <div id="auth-screen" class="full-screen-container">
        <div class="form-container">
            <h2 id="auth-header" style="text-align: center; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 15px;">Giri≈ü Yap</h2>
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="E-posta Adresi" required>
                <input type="password" id="auth-password" placeholder="≈ûifre (min 6 karakter)" required>
                <button type="submit" id="auth-submit-btn" class="start-btn">Giri≈ü Yap</button>
            </form>
            <p style="text-align: center; margin-top: 20px;">
                <a href="#" id="toggle-auth-mode" style="color: var(--text-color); text-decoration: underline; font-size: 14px;">Hesabƒ±n yok mu? Hemen Kaydol</a>
            </p>
            <p id="auth-error-message" style="color: var(--danger-color); text-align: center; margin-top: 15px; display: none; font-size: 14px; font-weight: bold;"></p>
        </div>
    </div>
    
    <div id="project-screen" class="full-screen-container">
        <div class="form-container" style="width: 600px;">
            <h2 style="color: var(--primary-color); text-align: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Projelerim</h2>
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px;">
                <button class="start-btn" style="width: 32%; background-color: var(--secondary-color);" onclick="window.showProjectCreationModal()">‚ûï Yeni Proje</button>
                <button class="start-btn" style="width: 32%; background-color: var(--warning-color);" onclick="window.showSettingsScreen()">üë§ Karakter Ayarlarƒ±</button>
                <button class="start-btn" style="width: 32%; background-color: #555;" onclick="window.loadProjects()">üîÑ Projeleri Yenile</button>
            </div>
            <div id="project-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px;">
                <p style="text-align: center; color: #aaa;">Projeler y√ºkleniyor...</p>
            </div>
            <button class="start-btn" style="background-color: var(--danger-color); margin-top: 20px;" onclick="auth.signOut()">üö™ √áƒ±kƒ±≈ü Yap</button>
        </div>
    </div>
    
    <div id="project-modal" class="full-screen-container" style="background: rgba(0, 0, 0, 0.85);">
        <div class="form-container" style="width: 450px;">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">Yeni Proje Olu≈ütur</h3>
            <input type="text" id="new-project-name" placeholder="Proje Adƒ± (√ñrn: Metaverse Deneme)" required>
            <select id="template-select" required>
                <option value="empty">Bo≈ü D√ºnya (Minimal I≈üƒ±k)</option>
                <option value="flat">D√ºz Zemin (Zemin, I≈üƒ±k ve Spawn Noktasƒ±)</option>
            </select>
            <button class="start-btn" onclick="window.createNewProject()">üöÄ Projeyi Olu≈ütur ve A√ß</button>
            <button class="start-btn" style="background-color: #555;" onclick="document.getElementById('project-modal').style.display = 'none'">‚ùå ƒ∞ptal</text>
        </div>
    </div>
    
    <div id="toolbar">
        <div id="file-menu" style="margin-right: 20px; position: relative;">
            <button class="tool-btn" onclick="window.showProjectScreen()" title="Projelerim Ana Ekranƒ±">üè† Projeler</button>
            <button class="tool-btn" onclick="window.saveProjectToFirebase()" style="background-color: var(--primary-color);" title="Proje Verilerini Kaydet">üíæ Kaydet</button>
        </div>
        
        <div id="editor-tools" style="display: flex; margin-right: 20px;">
            <button class="tool-btn active" id="translate-tool" onclick="window.setTool('translate')" title="Ta≈üƒ± (Q)">‚ÜîÔ∏è Ta≈üƒ±</button>
            <button class="tool-btn" id="rotate-tool" onclick="window.setTool('rotate')" title="D√∂nd√ºr (W)">üîÑ D√∂nd√ºr</button>
            <button class="tool-btn" id="scale-tool" onclick="window.setTool('scale')" title="Boyutlandƒ±r (E)">‚ÜïÔ∏è Boyut</button>
        </div>
        
        <div id="editor-creation-tools" style="margin-right: auto; display: flex; gap: 5px;">
            <button class="tool-btn" onclick="window.addShape('box')">üî≤ Kutu</button>
            <button class="tool-btn" onclick="window.addShape('sphere')">üî¥ K√ºre</button>
            <button class="tool-btn" onclick="window.addShape('cylinder')"> —Ü–∏–ª–∏–Ω–¥—Ä Silindir</button>
            <button class="tool-btn" onclick="window.addShape('spawn')">üßç Spawn</button>
        </div>

        <button class="tool-btn" id="play-button" style="background-color: var(--secondary-color); font-weight: bold;" onclick="window.toggleSimulationMode(true)" title="Sim√ºlasyonu Ba≈ülat">‚ñ∂Ô∏è OYNA</button>
        <button class="tool-btn" id="stop-button" style="background-color: var(--danger-color); display: none; font-weight: bold;" onclick="window.toggleSimulationMode(false)" title="Sim√ºlasyonu Durdur">üõë DURDUR</button>
        
        <button class="tool-btn" onclick="window.toggleCodeEditor()" style="margin-left: 10px; background-color: #444;" title="Kod Paneli"></> Kod</button>
    </div>
    
    <div id="main-area">
        <div id="sidebar-left">
            <h4 style="color: var(--primary-color); margin-top: 0;">Kod Edit√∂r√º</h4>
            <textarea id="code-editor" placeholder="// Proje Kod Alanƒ±: Buraya yazƒ±lan kod, 'Oyna' butonuna basƒ±ldƒ±ƒüƒ±nda √ßalƒ±≈üƒ±r.
// Kodunuzu 'onStart()' ve 'onUpdate(delta)' fonksiyonlarƒ± i√ßine yazƒ±n.
// √ñrn: function onStart() { console.log('Oyun Ba≈üladƒ±!'); }
// Nesneler 'objects' dizisinde, oyuncu 'player' deƒüi≈ükeninde mevcuttur.

function onStart() {
    // Oyun ba≈üladƒ±ƒüƒ±nda burasƒ± √ßalƒ±≈üƒ±r.
    console.log('LunX Proje Kodu Ba≈ülatƒ±ldƒ±.');
}

function onUpdate(delta) {
    // Her karede √ßalƒ±≈üƒ±r.
    // √ñrn: Player'ƒ± yava≈ü√ßa d√∂nd√ºr: player.rotation.y += 0.5 * delta;
}

"></textarea>
            <div style="display: flex; gap: 5px; margin-top: 10px;">
                <button class="tool-btn" style="flex-grow: 1; background-color: var(--secondary-color);" onclick="window.saveCode()">‚úÖ Kodu Kaydet</button>
                <button class="tool-btn" style="flex-grow: 1; background-color: #555;" onclick="window.runCode()">‚ñ∂Ô∏è Test √áalƒ±≈ütƒ±r (Console)</button>
            </div>
            <hr style="border-color: var(--border-color); margin: 15px 0;">
            <h4 style="color: var(--primary-color);">Dinamik Ayarlar</h4>
            <div id="studio-settings-panel">
                 </div>
            <h4 style="color: var(--primary-color);">Harita Y√ºkle (Deneysel)</h4>
            <input type="file" id="map-loader" accept=".obj, .gltf, .json" onchange="window.loadMapFromFile(this.files[0])">
        </div>
        
        <div id="viewport">
            <div id="mobile-controls">
                <div id="joystick-wrapper">
                    <div id="joystick-area">
                        <div id="joystick-handle"></div>
                    </div>
                </div>
                <div id="jump-button">‚¨ÜÔ∏è</div>
            </div>
        </div>
        
        <div id="sidebar-right">
            <div class="property-group">
                <h4 style="color: var(--primary-color); margin-top: 0;">Hiyerar≈üi (Scene Tree)</h4>
                <div id="hierarchy-list" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); padding: 5px; background: var(--input-bg);">
                    <p style="text-align: center; color: #888;">Sahne Nesneleri...</p>
                </div>
                <button class="tool-btn" style="width: 100%; margin-top: 5px; background-color: var(--danger-color);" onclick="window.deleteSelectedObject()">üóëÔ∏è Se√ßileni Sil</button>
            </div>
            
            <div class="property-group">
                <h4 style="color: var(--primary-color);">√ñzellikler (Inspector)</h4>
                <div id="properties-panel">
                    <p>Nesne se√ßilmedi.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="settings-screen" class="full-screen-container">
        <div class="form-container" style="width: 650px;">
            <h2 style="color: var(--primary-color); text-align: center; margin-bottom: 20px;">Kullanƒ±cƒ± ve Karakter √ñzelle≈ütirme</h2>
            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                
                <div id="character-preview-container" style="width: 250px; height: 250px; background: #111; border-radius: 8px; border: 1px solid #444;">
                    <p style="text-align: center; color: #777; padding-top: 110px;">3D √ñnizleme Alanƒ±</p>
                </div>
                
                <div style="flex-grow: 1;">
                    <h4 style="color: var(--text-color); border-bottom: 1px dashed #333; padding-bottom: 5px;">G√∂r√ºn√ºm Ayarlarƒ±</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px;">Cinsiyet:</label>
                            <select id="char-gender" style="width: 100%;">
                                <option value="male">Erkek</option>
                                <option value="female">Kadƒ±n</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px;">V√ºcut Rengi:</label>
                            <input type="color" id="torso-color" value="#007acc" style="height: 38px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px;">Cilt Rengi:</label>
                            <input type="color" id="skin-color" value="#ffe0bd" style="height: 38px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px;">Alt Kƒ±yafet Rengi:</label>
                            <input type="color" id="leg-color" value="#2a2a2a" style="height: 38px;">
                        </div>
                    </div>
                    
                    <h4 style="color: var(--text-color); border-bottom: 1px dashed #333; padding-bottom: 5px;">Doku URL'leri</h4>
                    <input type="text" id="head-texture" placeholder="Ba≈ü Doku URL'si (√ñrn: http://mytexture.png)">
                    <input type="text" id="torso-texture" placeholder="G√∂vde Doku URL'si (Opsiyonel)">
                </div>
            </div>
            
            <button class="start-btn" onclick="window.saveCustomization()" style="margin-top: 30px;">‚úÖ √ñzelle≈ütirmeyi Kaydet ve G√ºncelle</button>
            <button class="start-btn" style="background-color: #555;" onclick="window.hideSettingsScreen()">‚ùå Geri D√∂n</button>
        </div>
    </div>
    
    <div id="feedback-message"></div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        
        // --- 1. GLOBAL DEƒûƒ∞≈ûKENLER VE SABƒ∞TLER ---

        // ‚ö†Ô∏è FIREBASE AYARLARI: Kendi projenizle deƒüi≈ütirin
        const firebaseConfig = {
          apiKey: "AIzaSyD4Dh_WCxTSqMnJ8u0M4KqwHpejJrEoctk", 
          authDomain: "lunxstudio.firebaseapp.com",
          databaseURL: "https://lunxstudio-default-rtdb.firebaseio.com",
          projectId: "lunxstudio",
          storageBucket: "lunxstudio.firebasestorage.app",
          messagingSenderId: "810358489202",
          appId: "1:810358489202:web:301dbd444bf4608f2782eb",
          measurementId: "G-Y36QNCE71R"
        };
        
        let app, auth, db; // Firebase SDK'larƒ±
        let authMode = 'login'; 
        
        // THREE.js Core
        let scene, camera, renderer, controls, transformControls;
        let objects = []; // Sahnedeki t√ºm etkile≈üimli nesneler (Zemin dahil)
        let selectedObject = null;
        let isSimulationMode = false; 
        let currentProjectKey = null; 
        let isCodeEditorOpen = false;
        
        // Player Fizik ve Kontrol Ayarlarƒ±
        let player, playerVelocity, playerDirection; 
        const playerHeight = 2.5; // Oyuncu y√ºksekliƒüi (blok karakter)
        const playerRadius = 0.5; // Oyuncu yarƒ±√ßapƒ±
        const playerSpeed = 10.0; // Hareket hƒ±zƒ± (birim/saniye)
        const playerJumpPower = 18.0; // Zƒ±plama g√ºc√º
        const gravity = -35.0; // Yer√ßekimi ivmesi
        let isOnGround = true; 
        const clock = new THREE.Clock(); 
        
        // Giri≈ü Durumlarƒ±
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false; 
        let joystickActive = false; 
        let joystickX = 0, joystickY = 0; 
        
        // Raycasting ve √áarpƒ±≈üma
        const raycaster = new THREE.Raycaster(); 
        const downVector = new THREE.Vector3(0, -1, 0);
        
        // Karakter √ñzelle≈ütirmesi Verisi
        let currentCustomization = {
            gender: 'male',
            skinColor: '#ffe0bd',
            torsoColor: '#007acc',
            legColor: '#2a2a2a',
            headTexture: '',
            torsoTexture: ''
        };

        // Kamera Varsayƒ±lanlarƒ±
        const cameraDefaults = {
            fov: 75,
            near: 0.1,
            far: 1000,
            pos: {x: 15, y: 10, z: 15}
        };

        // Nesne Sayacƒ± (ƒ∞simlendirme i√ßin)
        let objectCounter = { box: 0, sphere: 0, cylinder: 0, spawn: 0 };
        
        // --- 2. Gƒ∞RDƒ∞ Y√ñNETƒ∞Mƒ∞ (Klavye Olaylarƒ±) ---

        const onKeyDown = (event) => {
            if (!isSimulationMode) return;
            switch (event.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyD': moveRight = true; break;
                case 'Space': 
                    if (isOnGround) {
                        playerVelocity.y = playerJumpPower;
                        isOnGround = false;
                    }
                    break;
            }
        };

        const onKeyUp = (event) => {
            if (!isSimulationMode) return;
            switch (event.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyD': moveRight = false; break;
            }
        };
        
        // --- 3. UTILITY FONKSƒ∞YONLARI (Geri Bildirim, Ekran Ge√ßi≈üi) ---
        
        /**
         * @function showFeedback
         * Kullanƒ±cƒ±ya ba≈üarƒ±lƒ±/hatalƒ± aksiyonlar i√ßin kƒ±sa s√ºreli geri bildirim g√∂sterir.
         * @param {string} message - G√∂sterilecek mesaj
         * @param {boolean} isError - Hata mesajƒ± ise true
         */
        window.showFeedback = (message, isError = false) => {
            const feedbackEl = document.getElementById('feedback-message');
            feedbackEl.textContent = message;
            feedbackEl.style.backgroundColor = isError ? 'var(--danger-color)' : 'var(--secondary-color)';
            feedbackEl.classList.add('show');
            setTimeout(() => {
                feedbackEl.classList.remove('show');
            }, 3000);
        }

        /**
         * @function switchScreen
         * Uygulama ekranlarƒ±nƒ± (Auth, Project, Studio, Settings) y√∂netir.
         * @param {string} screenId - A√ßƒ±lacak ekranƒ±n ID'si
         */
        window.switchScreen = (screenId) => {
            document.querySelectorAll('.full-screen-container, #toolbar, #main-area').forEach(el => {
                el.style.display = 'none';
            });
            
            if (screenId === 'studio') {
                document.getElementById('toolbar').style.display = 'flex';
                document.getElementById('main-area').style.display = 'flex';
                document.getElementById('sidebar-right').style.display = 'block'; 
                document.getElementById('sidebar-left').style.display = isCodeEditorOpen ? 'block' : 'none';
                window.onWindowResize();
                window.animate();
            } else if (screenId) {
                document.getElementById(screenId).style.display = 'flex';
            }
        }
        
        // ... Diƒüer basit ekran ge√ßi≈üleri ...
        window.showAuthScreen = () => window.switchScreen('auth-screen');
        window.showProjectScreen = () => { window.loadProjects(); window.switchScreen('project-screen'); }
        window.showProjectCreationModal = () => document.getElementById('project-modal').style.display = 'flex';
        window.showSettingsScreen = () => { 
            // Formu g√ºncel verilerle doldur
            Object.keys(currentCustomization).forEach(key => {
                const el = document.getElementById(key.replace(/([A-Z])/g, '-$1').toLowerCase());
                if (el) el.value = currentCustomization[key];
            });
            window.switchScreen('settings-screen'); 
        }
        window.hideSettingsScreen = () => {
            document.getElementById('settings-screen').style.display = 'none';
            if (currentProjectKey) {
                window.switchScreen('studio');
            } else {
                window.showProjectScreen();
            }
        }
        window.toggleCodeEditor = () => {
            isCodeEditorOpen = !isCodeEditorOpen;
            document.getElementById('sidebar-left').style.display = isCodeEditorOpen ? 'block' : 'none';
            window.onWindowResize();
        }

        // --- 4. FIREBASE VE AUTH MANTIKLARI ---
        
        window.loadApplicationStep = () => {
            document.getElementById('progress-text').textContent = "K√ºt√ºphaneler kontrol ediliyor...";
            if (typeof firebase === 'undefined' || typeof THREE === 'undefined') {
                setTimeout(window.loadApplicationStep, 500); 
                return;
            }

            try {
                // Firebase ba≈ülatma ve kullanƒ±cƒ± kontrol√º
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.database();
                
                document.getElementById('progress-text').textContent = "Firebase baƒülantƒ±sƒ± kuruluyor...";
                document.getElementById('progress-bar').style.width = '75%';

                auth.onAuthStateChanged(user => {
                    document.getElementById('progress-bar').style.width = '100%';
                    document.getElementById('loading-screen').style.display = 'none';

                    if (user) {
                        window.fetchAndUpdateUser(user).then(() => {
                            window.showFeedback(`Ho≈ü geldiniz, ${user.email.split('@')[0]}!`);
                            window.showProjectScreen();
                        });
                    } else {
                        window.showAuthScreen();
                    }
                });
            } catch (error) {
                window.showFeedback("Uygulama Kritik Hatasƒ±: " + error.message, true);
                console.error(error);
            }
        }
        
        // ... (handleAuthSubmit, toggleAuthMode, fetchAndUpdateUser fonksiyonlarƒ± √∂nceki versiyondan alƒ±nmƒ±≈ütƒ±r) ...
        window.handleAuthSubmit = (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error-message');
            errorEl.style.display = 'none';
            
            if (authMode === 'login') {
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        errorEl.textContent = "Giri≈ü Hatasƒ±: " + error.message;
                        errorEl.style.display = 'block';
                    });
            } else { 
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        db.ref('users/' + userCredential.user.uid).set({
                            email: email,
                            customization: currentCustomization,
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        });
                        window.showFeedback("Kayƒ±t Ba≈üarƒ±lƒ±! Giri≈ü yapƒ±lƒ±yor.");
                    })
                    .catch(error => {
                        errorEl.textContent = "Kayƒ±t Hatasƒ±: " + error.message;
                        errorEl.style.display = 'block';
                    });
            }
        }
        
        window.toggleAuthMode = () => {
            const header = document.getElementById('auth-header');
            const submitBtn = document.getElementById('auth-submit-btn');
            const toggleLink = document.getElementById('toggle-auth-mode');
            const errorEl = document.getElementById('auth-error-message');
            errorEl.style.display = 'none';

            if (authMode === 'login') {
                authMode = 'signup';
                header.textContent = 'Kaydol (Yeni Hesap)';
                submitBtn.textContent = 'Hesap Olu≈ütur';
                toggleLink.textContent = 'Zaten hesabƒ±n var mƒ±? Giri≈ü Yap';
            } else {
                authMode = 'login';
                header.textContent = 'Giri≈ü Yap';
                submitBtn.textContent = 'Giri≈ü Yap';
                toggleLink.textContent = 'Hesabƒ±n yok mu? Hemen Kaydol';
            }
        }
        
        window.fetchAndUpdateUser = async (user) => {
            const userRef = db.ref('users/' + user.uid);
            const snapshot = await userRef.once('value');
            if (snapshot.exists() && snapshot.val().customization) {
                currentCustomization = snapshot.val().customization;
            }
        }

        // --- 5. PROJE Y√ñNETƒ∞Mƒ∞ VE KAYDETME ---
        
        // ... (loadProjects, loadProject, createNewProject, saveProjectToFirebase fonksiyonlarƒ± √∂nceki versiyondan alƒ±nmƒ±≈ütƒ±r ve detaylandƒ±rƒ±lmƒ±≈ütƒ±r) ...
        
        window.loadProjects = async () => {
            const listEl = document.getElementById('project-list');
            listEl.innerHTML = '<p style="text-align: center; color: #777;">Projeler y√ºkleniyor...</p>';
            if (!auth.currentUser) return;

            const projectsRef = db.ref('projects').orderByChild('ownerId').equalTo(auth.currentUser.uid);
            const snapshot = await projectsRef.once('value');
            
            listEl.innerHTML = '';
            
            if (!snapshot.exists()) {
                listEl.innerHTML = '<p style="text-align: center; color: #777;">Hi√ß projeniz yok. Yeni proje olu≈üturun!</p>';
                return;
            }

            snapshot.forEach(childSnapshot => {
                const project = childSnapshot.val();
                const key = childSnapshot.key;
                const item = document.createElement('div');
                item.className = 'hierarchy-item';
                item.textContent = `[${project.template.toUpperCase()}] ${project.name} - Son G√ºncelleme: ${new Date(project.lastUpdated).toLocaleDateString()}`;
                item.onclick = () => window.loadProject(key);
                listEl.appendChild(item);
            });
        }
        
        window.createNewProject = async () => {
            const name = document.getElementById('new-project-name').value.trim();
            const template = document.getElementById('template-select').value;

            if (!name) {
                window.showFeedback("Proje adƒ± bo≈ü bƒ±rakƒ±lamaz.", true);
                return;
            }

            const newProjectRef = db.ref('projects').push();
            const initialObjects = [];
            
            if (template === 'flat') {
                // Ba≈ülangƒ±√ß noktasƒ± ekle
                initialObjects.push({ 
                    name: "Ba≈ülangƒ±√ß Noktasƒ±", 
                    type: 'spawn', 
                    position: { x: 0, y: 0.5, z: 0 }, 
                    rotation: { x: 0, y: 0, z: 0 },
                    scale: { x: 1, y: 1, z: 1 },
                    color: '#ff00ff'
                });
            }
            
            const projectData = {
                name: name,
                ownerId: auth.currentUser.uid,
                template: template,
                objects: initialObjects,
                code: window.getDefaultCode(name),
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };

            await newProjectRef.set(projectData);
            document.getElementById('project-modal').style.display = 'none';
            window.loadProject(newProjectRef.key);
            window.showFeedback(`Proje "${name}" ba≈üarƒ±yla olu≈üturuldu.`);
        }
        
        window.saveProjectToFirebase = async () => {
            if (!currentProjectKey || !auth.currentUser) {
                window.showFeedback("Hata: Kaydedilecek aktif proje yok.", true);
                return;
            }
            window.showFeedback("Kaydediliyor...", false);

            const serializableObjects = objects
                .filter(obj => obj.name !== "Zemin") 
                .map(obj => window.serializeObject(obj));
            
            const projectName = objects[0].userData.projectName || "LunX Projesi"; 
            
            const projectData = {
                name: projectName,
                ownerId: auth.currentUser.uid,
                objects: serializableObjects,
                code: document.getElementById('code-editor').value,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };
            
            try {
                await db.ref(`projects/${currentProjectKey}`).update(projectData);
                window.showFeedback("Proje ba≈üarƒ±yla kaydedildi! üíæ");
            } catch (error) {
                window.showFeedback("Kaydetme Hatasƒ±: " + error.message, true);
            }
        }
        
        window.saveCustomization = async () => {
             const customizationData = {
                gender: document.getElementById('char-gender').value,
                skinColor: document.getElementById('skin-color').value,
                torsoColor: document.getElementById('torso-color').value,
                legColor: document.getElementById('leg-color').value,
                headTexture: document.getElementById('head-texture').value,
                torsoTexture: document.getElementById('torso-texture').value
            };
            
            currentCustomization = customizationData;
            
            try {
                await db.ref('users/' + auth.currentUser.uid).update({ customization: customizationData });
                window.showFeedback("√ñzelle≈ütirme kaydedildi.");
            } catch (error) {
                window.showFeedback("Hata: √ñzelle≈ütirme kaydedilemedi.", true);
            }
        }
        
        // --- 6. 3D SAHNE VE NESNE Y√ñNETƒ∞Mƒ∞ ---

        window.initFullScene = (containerId) => {
            // THREE.js sahne kurulumu
            const container = document.getElementById(containerId);
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // A√ßƒ±k Mavi Skybox
            
            camera = new THREE.PerspectiveCamera(cameraDefaults.fov, container.clientWidth / container.clientHeight, cameraDefaults.near, cameraDefaults.far);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Kontroller
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            transformControls = new THREE.TransformControls(camera, renderer.domElement);
            scene.add(transformControls);
            
            // I≈üƒ±klandƒ±rma
            scene.add(new THREE.AmbientLight(0xaaaaaa, 1.5)); 
            const directionalLight = new THREE.DirectionalLight(0xffffff, 2.5);
            directionalLight.position.set(20, 30, 10);
            directionalLight.castShadow = true; 
            scene.add(directionalLight);
            
            // Zemin (Her zaman sahnededir)
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(1000, 1000),
                new THREE.MeshStandardMaterial({ color: 0x50a050 })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            ground.name = "Zemin";
            ground.userData.isStatic = true;
            scene.add(ground);
            objects.push(ground);

            camera.position.set(cameraDefaults.pos.x, cameraDefaults.pos.y, cameraDefaults.pos.z);
            controls.update();
            window.setTool('translate'); 
            window.updateHierarchyPanel();
            window.setupStudioSettingsPanel();
        }
        
        window.serializeObject = (obj) => {
            // Nesneyi kaydedilebilir bir formata d√∂n√º≈üt√ºr√ºr (JSON)
            return {
                name: obj.name,
                type: obj.userData.isSpawnPoint ? 'spawn' : obj.geometry.type.replace('Geometry', '').toLowerCase(),
                position: { x: obj.position.x, y: obj.position.y, z: obj.position.z },
                rotation: { x: obj.rotation.x, y: obj.rotation.y, z: obj.rotation.z },
                scale: { x: obj.scale.x, y: obj.scale.y, z: obj.scale.z },
                color: `#${obj.material.color.getHexString()}`
            };
        };
        
        /**
         * @function addShape
         * Sahneye yeni bir 3D geometrik ≈üekil ekler.
         * @param {string} type - 'box', 'sphere', 'cylinder' veya 'spawn'
         */
        window.addShape = (type) => {
            let geometry, name, size = 2;
            objectCounter[type]++;
            let color = Math.random() * 0xffffff;

            if (type === 'box') {
                geometry = new THREE.BoxGeometry(size, size, size);
                name = `Kutu ${objectCounter.box}`;
            } else if (type === 'sphere') {
                geometry = new THREE.SphereGeometry(size / 2, 32, 32);
                name = `K√ºre ${objectCounter.sphere}`;
            } else if (type === 'cylinder') {
                geometry = new THREE.CylinderGeometry(size / 2, size / 2, size, 32);
                name = `Silindir ${objectCounter.cylinder}`;
            } else if (type === 'spawn') {
                geometry = new THREE.CapsuleGeometry(0.5, 1, 4, 8);
                color = 0xff00ff; // Spawn noktasƒ± √∂zel renk
                name = `Spawn ${objectCounter.spawn}`;
            } else { return; }

            let material = new THREE.MeshStandardMaterial({ color: color });

            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.y = mesh.geometry.parameters.height ? mesh.geometry.parameters.height / 2 : size / 2;
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.name = name;
            mesh.userData.isSpawnPoint = (type === 'spawn');
            mesh.userData.isStatic = false; // Player bu nesneleri itebilir

            scene.add(mesh);
            objects.push(mesh);
            window.selectObject(mesh);
            window.updateHierarchyPanel();
            window.showFeedback(`${name} eklendi.`);
        }
        
        window.selectObject = (object) => {
            // Se√ßilen nesneyi ayarlar ve transform kontrol√ºn√º baƒülar.
            if (!object || object.name === "Zemin" || isSimulationMode) {
                transformControls.detach();
                selectedObject = null;
                window.updatePropertiesPanel(null);
                return;
            }
            selectedObject = object;
            transformControls.attach(object);
            window.updateHierarchyPanel();
            window.updatePropertiesPanel(object);
        }
        
        window.updatePropertiesPanel = (obj) => {
            // Detaylƒ± ve dinamik √∂zellik paneli olu≈üturma (Konum, D√∂nd√ºrme, Boyut, Renk)
            const panel = document.getElementById('properties-panel');
            panel.innerHTML = '';

            if (!obj) {
                panel.innerHTML = '<p>Nesne se√ßilmedi.</p>';
                return;
            }
            
            const colorHex = obj.material.color.getHexString();
            
            panel.innerHTML = `
                <div class="property-group">
                    <h5 style="margin-top: 0;">Genel</h5>
                    <p style="font-size: 12px; color: #888; margin-top: -10px;">Tip: ${obj.geometry.type.replace('Geometry', '')}</p>
                    <div class="property-input-row">
                        <label for="prop-name">ƒ∞sim:</label>
                        <input type="text" id="prop-name" value="${obj.name}" onchange="window.handlePropertyChange('name', this.value)">
                    </div>
                </div>
                
                <div class="property-group">
                    <h5>Konum (Position)</h5>
                    <div class="property-input-row">
                        <label>X:</label><input type="number" id="prop-pos-x" step="0.1" value="${obj.position.x.toFixed(3)}" onchange="window.handlePropertyChange('position.x', parseFloat(this.value))">
                    </div>
                    <div class="property-input-row">
                        <label>Y:</label><input type="number" id="prop-pos-y" step="0.1" value="${obj.position.y.toFixed(3)}" onchange="window.handlePropertyChange('position.y', parseFloat(this.value))">
                    </div>
                    <div class="property-input-row">
                        <label>Z:</label><input type="number" id="prop-pos-z" step="0.1" value="${obj.position.z.toFixed(3)}" onchange="window.handlePropertyChange('position.z', parseFloat(this.value))">
                    </div>
                </div>
                
                <div class="property-group">
                    <h5>D√∂nd√ºrme (Rotation - Radyan)</h5>
                    <div class="property-input-row">
                        <label>X:</label><input type="number" id="prop-rot-x" step="0.1" value="${obj.rotation.x.toFixed(3)}" onchange="window.handlePropertyChange('rotation.x', parseFloat(this.value))">
                    </div>
                    <div class="property-input-row">
                        <label>Y:</label><input type="number" id="prop-rot-y" step="0.1" value="${obj.rotation.y.toFixed(3)}" onchange="window.handlePropertyChange('rotation.y', parseFloat(this.value))">
                    </div>
                    <div class="property-input-row">
                        <label>Z:</label><input type="number" id="prop-rot-z" step="0.1" value="${obj.rotation.z.toFixed(3)}" onchange="window.handlePropertyChange('rotation.z', parseFloat(this.value))">
                    </div>
                </div>
                
                <div class="property-group">
                    <h5>Boyut (Scale)</h5>
                    <div class="property-input-row">
                        <label>X:</label><input type="number" id="prop-sca-x" step="0.1" value="${obj.scale.x.toFixed(3)}" onchange="window.handlePropertyChange('scale.x', parseFloat(this.value))">
                    </div>
                    <div class="property-input-row">
                        <label>Y:</label><input type="number" id="prop-sca-y" step="0.1" value="${obj.scale.y.toFixed(3)}" onchange="window.handlePropertyChange('scale.y', parseFloat(this.value))">
                    </div>
                    <div class="property-input-row">
                        <label>Z:</label><input type="number" id="prop-sca-z" step="0.1" value="${obj.scale.z.toFixed(3)}" onchange="window.handlePropertyChange('scale.z', parseFloat(this.value))">
                    </div>
                </div>
                
                <div class="property-group">
                    <h5>G√∂r√ºn√ºm</h5>
                    <div class="property-input-row">
                        <label for="prop-color">Renk:</label>
                        <input type="color" id="prop-color" value="#${colorHex}" onchange="window.handlePropertyChange('color', this.value)">
                    </div>
                </div>
            `;
            
            // TransformControls deƒüi≈ütiƒüinde giri≈ü alanlarƒ±nƒ± g√ºncelle
            transformControls.removeEventListener('objectChange', window.updateInputFields);
            transformControls.addEventListener('objectChange', window.updateInputFields);
        }
        
        window.updateInputFields = () => {
            if (!selectedObject) return;
            const obj = selectedObject;
            
            // Pozisyon
            document.getElementById('prop-pos-x').value = obj.position.x.toFixed(3);
            document.getElementById('prop-pos-y').value = obj.position.y.toFixed(3);
            document.getElementById('prop-pos-z').value = obj.position.z.toFixed(3);
            
            // D√∂nd√ºrme
            document.getElementById('prop-rot-x').value = obj.rotation.x.toFixed(3);
            document.getElementById('prop-rot-y').value = obj.rotation.y.toFixed(3);
            document.getElementById('prop-rot-z').value = obj.rotation.z.toFixed(3);
            
            // Boyut
            document.getElementById('prop-sca-x').value = obj.scale.x.toFixed(3);
            document.getElementById('prop-sca-y').value = obj.scale.y.toFixed(3);
            document.getElementById('prop-sca-z').value = obj.scale.z.toFixed(3);
        }
        
        window.handlePropertyChange = (prop, value) => {
            if (!selectedObject) return;

            if (prop === 'name') {
                selectedObject.name = value;
                window.updateHierarchyPanel(); 
            } else if (prop === 'color') {
                selectedObject.material.color.set(value);
            } else if (prop.startsWith('position.')) {
                const axis = prop.split('.')[1];
                selectedObject.position[axis] = value;
            } else if (prop.startsWith('rotation.')) {
                const axis = prop.split('.')[1];
                selectedObject.rotation[axis] = value;
            } else if (prop.startsWith('scale.')) {
                const axis = prop.split('.')[1];
                selectedObject.scale[axis] = value;
            }
            
            selectedObject.updateMatrixWorld();
        }
        
        window.setupStudioSettingsPanel = () => {
            const panel = document.getElementById('studio-settings-panel');
            panel.innerHTML = `
                <div class="property-group">
                    <h5>Kamera Kontrolleri</h5>
                    <div class="property-input-row">
                        <label>FOV (G√∂r√º≈ü A√ßƒ±sƒ±):</label>
                        <input type="number" id="setting-fov" value="${cameraDefaults.fov}" min="30" max="120" step="5" onchange="window.updateCameraSettings('fov', parseFloat(this.value))">
                    </div>
                    <div class="property-input-row">
                        <label>Hƒ±z Katsayƒ±sƒ±:</label>
                        <input type="number" id="setting-speed" value="${playerSpeed}" min="1" max="50" step="1" onchange="window.updateCameraSettings('speed', parseFloat(this.value))">
                    </div>
                </div>
            `;
        }
        
        window.updateCameraSettings = (setting, value) => {
            if (setting === 'fov') {
                camera.fov = value;
                camera.updateProjectionMatrix();
            } else if (setting === 'speed') {
                // Bu ayarƒ± global playerSpeed deƒüi≈ükenine yansƒ±tƒ±yoruz
                window.playerSpeed = value;
            }
            window.showFeedback(`${setting.toUpperCase()} g√ºncellendi.`);
        }

        // --- 7. KOD Y√ñNETƒ∞Mƒ∞ VE SANAL ORTAM ---
        
        window.getDefaultCode = (projectName) => {
            // Detaylƒ± varsayƒ±lan kod ≈üablonu
            return `// ${projectName} Projesi Kod Alanƒ±
// THREE.js nesneleri 'objects' dizisinde, oyuncu 'player' deƒüi≈ükeninde mevcuttur.
// Console.log ile √ßƒ±ktƒ± alabilirsiniz.

/**
 * @function onStart
 * Oyun ba≈üladƒ±ƒüƒ±nda (Sim√ºlasyon modu a√ßƒ±ldƒ±ƒüƒ±nda) yalnƒ±zca bir kez √ßalƒ±≈üƒ±r.
 */
function onStart() {
    console.log("-----------------------------------------");
    console.log(">>> LunX Proje Kodu Ba≈ülatƒ±ldƒ±: " + "${projectName}");
    
    // √ñrnek: Sahnedeki t√ºm kutularƒ± bul ve rengini deƒüi≈ütir.
    objects.forEach(obj => {
        if (obj.name.includes("Kutu")) {
            obj.material.color.set(0xffa500); // Turuncu yap
            console.log("Kutu nesnesi g√ºncellendi: " + obj.name);
        }
    });
}

/**
 * @function onUpdate
 * Oyun d√∂ng√ºs√ºn√ºn her karesinde √ßalƒ±≈üƒ±r.
 * @param {number} delta - Son kareden bu yana ge√ßen zaman (saniye).
 */
function onUpdate(delta) {
    if (player) {
        // √ñrnek: Oyuncunun ba≈üƒ±nƒ± s√ºrekli d√∂nd√ºr.
        const head = player.children.find(c => c.name === 'Head');
        if (head) {
            head.rotation.y += 2.0 * delta; 
        }
    }
}

// Diƒüer yardƒ±mcƒ± fonksiyonlar buraya eklenebilir.

`;
        }
        
        window.runCode = () => {
            // Kodun Edit√∂r'de test √ßalƒ±≈ütƒ±rƒ±lmasƒ±
            const code = document.getElementById('code-editor').value;
            try {
                // G√ºvenli √ßalƒ±≈ütƒ±rma i√ßin yeni bir fonksiyon ortamƒ±nda sarƒ±lƒ±r
                const sandbox = new Function('scene', 'objects', 'player', 'THREE', 'delta', `
                    // console.log √ßƒ±ktƒ±larƒ±nƒ±n g√∂r√ºnmesi i√ßin
                    ${code}
                    
                    // onUpdate'i delta=0.01 ile test et
                    if (typeof onUpdate === 'function') {
                       onUpdate(0.01); 
                    }
                    
                    // onStart'ƒ± √ßaƒüƒ±r
                    if (typeof onStart === 'function') {
                        onStart(); 
                    }
                `);
                
                // Player nesnesi sim√ºlasyon kapalƒ±ysa null ge√ßer
                sandbox(scene, objects, player, THREE, 0.01); 
                window.showFeedback("Kod Test √áalƒ±≈ütƒ±rmasƒ± Tamamlandƒ±. √áƒ±ktƒ± i√ßin Console'u kontrol edin (F12).");
            } catch (error) {
                window.showFeedback("Kod √áalƒ±≈ütƒ±rma Hatasƒ±: " + error.message, true);
                console.error("Kod √áalƒ±≈ütƒ±rma Hatasƒ±:", error);
            }
        }
        
        window.runCodeFunction = (funcName, delta = 0) => {
            // Sim√ºlasyon modunda kodun ger√ßekten √ßalƒ±≈ütƒ±rƒ±lmasƒ±
            const code = document.getElementById('code-editor').value;
             try {
                const sandbox = new Function('scene', 'objects', 'player', 'THREE', 'delta', `
                    ${code}
                    if (typeof ${funcName} === 'function') {
                        ${funcName}(delta);
                    }
                `);
                sandbox(scene, objects, player, THREE, delta);
            } catch (error) {
                console.error(`Kod fonksiyonu √ßalƒ±≈ütƒ±rma hatasƒ± (${funcName}):`, error);
            }
        }
        
        // --- 8. PLAYER VE OYUN Fƒ∞Zƒ∞ƒûƒ∞ (GELƒ∞≈ûMƒ∞≈û) ---

        window.toggleSimulationMode = (enable) => {
            // ... UI ve kontrol ge√ßi≈üleri
            isSimulationMode = enable;
            document.getElementById('play-button').style.display = enable ? 'none' : 'flex';
            document.getElementById('stop-button').style.display = enable ? 'flex' : 'none';
            document.getElementById('mobile-controls').style.display = enable ? 'flex' : 'none';
            
            controls.enabled = !enable; // Edit√∂r kontrollerini devre dƒ±≈üƒ± bƒ±rak
            transformControls.detach();
            
            if (enable) {
                 window.initPlayerControls();
                 window.runCodeFunction('onStart'); 
                 window.showFeedback("Sim√ºlasyon Ba≈üladƒ±! WASD/Joystick ile hareket edin.");
            } else {
                 if (player) { scene.remove(player); player = null; }
                 window.showFeedback("Sim√ºlasyon Durduruldu. Edit√∂r Modu.");
            }
        }
        
        window.initPlayerControls = () => {
            playerVelocity = new THREE.Vector3(0, 0, 0);
            
            if (player) { scene.remove(player); } 
            player = window.createBlockCharacter();
            
            const spawnPoint = objects.find(obj => obj.userData.isSpawnPoint);
            let startPos = spawnPoint ? spawnPoint.position.clone() : new THREE.Vector3(0, playerHeight / 2, 0); 
            player.position.set(startPos.x, startPos.y + playerHeight / 2, startPos.z);
            scene.add(player);

            window.initMobileControls();
        }
        
        /**
         * @function createBlockCharacter
         * Kullanƒ±cƒ±nƒ±n √∂zelle≈ütirmesine g√∂re blok karakteri olu≈üturur.
         */
        window.createBlockCharacter = () => {
            const group = new THREE.Group();
            
            // Ba≈ü (1x1x1)
            const head = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshStandardMaterial({ color: new THREE.Color(currentCustomization.skinColor) }));
            head.position.y = 1.5;
            head.name = 'Head'; // Koddan eri≈üim i√ßin isim verilir

            // G√∂vde (1.5x1.5x0.5)
            const torso = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 0.5), new THREE.MeshStandardMaterial({ color: new THREE.Color(currentCustomization.torsoColor) }));
            torso.position.y = 0.5;
            torso.name = 'Torso';

            // Bacaklar (1x1x1 - Basitle≈ütirme)
            const legMaterial = new THREE.MeshStandardMaterial({ color: new THREE.Color(currentCustomization.legColor) });
            const legL = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 0.5), legMaterial);
            const legR = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 0.5), legMaterial);
            legL.position.set(-0.25, -0.5, 0);
            legR.position.set(0.25, -0.5, 0);
            
            group.add(head, torso, legL, legR);
            
            // Ana grup pozisyonu karakterin ayaklarƒ± yerine merkezini temsil etmeli
            group.position.y = playerHeight / 2;
            
            group.userData.isPlayer = true;
            group.castShadow = true;
            group.receiveShadow = true;

            return group;
        };
        
        /**
         * @function updatePlayerMovement
         * Sim√ºlasyon modunda oyuncu hareketi, yer√ßekimi ve basit √ßarpƒ±≈ümayƒ± hesaplar.
         * @param {number} delta - Zaman farkƒ±
         */
        window.updatePlayerMovement = (delta) => {
            if (!player) return;

            // 1. Yatay Hƒ±z ve D√∂n√º≈ü
            let actualSpeed = playerSpeed * delta;
            playerDirection = new THREE.Vector3();
            
            // Klavye/Joystick girdisi (Y√∂n Vekt√∂r√º)
            playerDirection.z -= moveForward ? 1 : 0;
            playerDirection.z += moveBackward ? 1 : 0;
            playerDirection.x -= moveLeft ? 1 : 0;
            playerDirection.x += moveRight ? 1 : 0;
            playerDirection.x += joystickX;
            playerDirection.z += joystickY;

            if (playerDirection.lengthSq() > 0) {
                playerDirection.normalize().multiplyScalar(actualSpeed);
                
                // Kameranƒ±n y√∂n√ºne g√∂re hareket vekt√∂r√ºn√º d√∂nd√ºr
                const angle = controls.getAzimuthalAngle();
                const tempVector = new THREE.Vector3(playerDirection.x, 0, playerDirection.z).applyAxisAngle(new THREE.Vector3(0, 1, 0), angle);
                
                playerVelocity.x = tempVector.x;
                playerVelocity.z = tempVector.z;
                
                // Karakteri hareket y√∂n√ºne d√∂nd√ºr (Yumu≈üak d√∂n√º≈ü)
                const rotationAngle = Math.atan2(-tempVector.x, -tempVector.z);
                player.rotation.y = THREE.MathUtils.lerp(player.rotation.y, rotationAngle, 0.2);
            } else {
                // Hareket yoksa yava≈ü√ßa dur
                playerVelocity.x = THREE.MathUtils.lerp(playerVelocity.x, 0, 0.1);
                playerVelocity.z = THREE.MathUtils.lerp(playerVelocity.z, 0, 0.1);
            }
            
            // 2. D√º≈üey Hƒ±z (Yer√ßekimi)
            playerVelocity.y += gravity * delta;
            
            // 3. Pozisyon G√ºncelleme
            player.position.x += playerVelocity.x;
            player.position.y += playerVelocity.y * delta;
            player.position.z += playerVelocity.z;

            // 4. √áarpƒ±≈üma Kontrol√º (Zemin ve diƒüer nesneler)
            
            // Zemin √áarpƒ±≈ümasƒ±
            raycaster.set(player.position, downVector);
            raycaster.near = 0;
            raycaster.far = playerHeight / 2 + 0.1; // Player'ƒ±n ayaƒüƒ±ndan biraz daha fazla
            
            const floorObjects = objects.filter(obj => !obj.userData.isPlayer && !obj.userData.isSpawnPoint); 
            const intersections = raycaster.intersectObjects(floorObjects, true);

            if (intersections.length > 0) {
                const distance = intersections[0].distance;
                if (distance < playerHeight / 2) {
                    // Yere d√º≈üt√º
                    player.position.y += (playerHeight / 2 - distance); 
                    playerVelocity.y = Math.max(0, playerVelocity.y);
                    isOnGround = true;
                }
            } else {
                isOnGround = false;
            }
            
            // 5. Kamerayƒ± Takip Et (Daha yumu≈üak takip)
            const followDistance = 10;
            const followHeight = 5;

            // Kameranƒ±n mevcut y√∂n√ºn√º koruyarak ideal hedef pozisyonu hesapla
            const currentDirection = new THREE.Vector3();
            controls.object.getWorldDirection(currentDirection);
            currentDirection.y = 0;
            currentDirection.normalize();

            const idealOffset = player.position.clone()
                .sub(currentDirection.multiplyScalar(followDistance))
                .add(new THREE.Vector3(0, followHeight, 0));

            // Yumu≈üak ge√ßi≈ü
            camera.position.lerp(idealOffset, 0.15);
            controls.target.copy(player.position);
            controls.update(); 
        }

        // ... Joystick mantƒ±ƒüƒ± (initMobileControls) √∂nceki versiyondan alƒ±nmƒ±≈ütƒ±r. ...
        
        window.initMobileControls = () => {
             const handleEl = document.getElementById('joystick-handle');
            const areaEl = document.getElementById('joystick-area');
            const jumpEl = document.getElementById('jump-button');
            const maxRadius = 50; 

            const resetJoystick = () => {
                handleEl.style.transform = `translate(50px, 50px)`;
                joystickX = 0;
                joystickY = 0;
                joystickActive = false;
            };

            const moveJoystick = (e) => {
                let x, y;
                if (e.touches) {
                    const rect = areaEl.getBoundingClientRect();
                    // Dokunma koordinatlarƒ±nƒ± joystick merkezine g√∂re normalle≈ütirme
                    x = e.touches[0].clientX - (rect.left + maxRadius);
                    y = e.touches[0].clientY - (rect.top + maxRadius);
                } else {
                    x = e.offsetX - maxRadius;
                    y = e.offsetY - maxRadius;
                }
                
                let distance = Math.sqrt(x * x + y * y);
                if (distance > maxRadius) {
                    x *= maxRadius / distance;
                    y *= maxRadius / distance;
                }
                
                handleEl.style.transform = `translate(${x + 50}px, ${y + 50}px)`;
                // Y eksenini ters √ßeviriyoruz (ileri/geri kontrol√º i√ßin)
                joystickX = x / maxRadius;
                joystickY = -y / maxRadius; 
            };

            areaEl.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                moveJoystick(e);
            }, false);
            areaEl.addEventListener('touchmove', (e) => {
                if (joystickActive) {
                    e.preventDefault();
                    moveJoystick(e);
                }
            }, false);
            areaEl.addEventListener('touchend', resetJoystick, false);
            areaEl.addEventListener('touchcancel', resetJoystick, false);
            
            jumpEl.onclick = () => {
                if (isSimulationMode && isOnGround) {
                    playerVelocity.y = playerJumpPower;
                    isOnGround = false;
                }
            };
        }

        // --- 9. ANƒ∞MASYON D√ñNG√úS√ú VE Ba≈ülangƒ±√ß ---

        window.onWindowResize = () => {
            const container = document.getElementById('viewport');
            if (camera && renderer) {
                const width = container.clientWidth;
                const height = container.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        }
        
        window.animate = () => {
            requestAnimationFrame(window.animate);
            const delta = clock.getDelta(); // Zaman farkƒ±nƒ± al

            if (isSimulationMode) {
                window.updatePlayerMovement(delta); // Oyuncu hareketini hesapla
                window.runCodeFunction('onUpdate', delta); // Kullanƒ±cƒ± kodunu √ßalƒ±≈ütƒ±r
            } else {
                controls.update(); // Edit√∂r kamerasƒ±nƒ± g√ºncelle
            }

            renderer.render(scene, camera);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listener'lar
            window.addEventListener('resize', window.onWindowResize, false);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            
            document.getElementById('auth-form').onsubmit = window.handleAuthSubmit;
            document.getElementById('toggle-auth-mode').onclick = (e) => {
                e.preventDefault();
                window.toggleAuthMode();
            };
            
            // 3D Sahneyi Ba≈ülat
            window.initFullScene('viewport');
            
            // Uygulama Akƒ±≈üƒ±nƒ± Ba≈ülat
            window.loadApplicationStep();
        });
    </script>
</body>
</html>
