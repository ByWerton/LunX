<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V11 - R6 & AI Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

    <style>
        :root {
            --bg-app: #eef0f3;
            --bg-ribbon: #ffffff;
            --bg-panel: #fcfcfc;
            --border: #d1d1d1;
            --accent: #0078d7; /* Mavi Tema */
            --accent-hover: #eef6ff;
            --toolbar-height: 90px;
            --ui-scale: 1;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-app); color: #333; height: 100vh; display: flex; flex-direction: column; }

        /* --- √úST MEN√ú --- */
        #top-bar {
            height: 30px; background: #0078d7; color: white; display: flex; align-items: center; padding: 0 10px; font-size: 12px;
            padding-left: 50px;
        }
        #tab-container { display: flex; height: 100%; margin-left: 20px; }
        .tab-btn {
            padding: 0 20px; height: 100%; display: flex; align-items: center; cursor: pointer;
            border-right: 1px solid rgba(255,255,255,0.1); transition: 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.2); }
        .tab-btn.active { background: var(--bg-ribbon); color: #333; font-weight: bold; border-top: 3px solid white; }

        /* RIBBON (ARA√á √áUBUƒûU) */
        #ribbon {
            height: var(--toolbar-height); background: var(--bg-ribbon); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 5px 10px; overflow-x: auto; gap: 5px; flex-shrink: 0;
        }
        .tool-section { display: none; gap: 5px; height: 100%; align-items: center; }
        .tool-section.active { display: flex; }
        
        .ribbon-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 60px; height: 70px; border: 1px solid transparent; border-radius: 4px;
            cursor: pointer; transition: 0.2s; color: #444; position: relative;
        }
        .ribbon-btn:hover { background: var(--accent-hover); border-color: #cce4f7; }
        .ribbon-btn.active { background: #daebf9; border-color: var(--accent); }
        .ribbon-btn span { font-size: 24px; margin-bottom: 4px; }
        .ribbon-btn label { font-size: 11px; text-align: center; }

        /* --- ANA D√úZEN --- */
        #main-layout { flex: 1; display: flex; position: relative; overflow: hidden; width: 100%; }

        /* SOL PANEL (Toolbox) */
        #toolbox {
            width: 240px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20; transition: width 0.2s; flex-shrink: 0;
        }
        #toolbox.closed { width: 0; border: none; overflow: hidden; }
        .panel-head { padding: 8px; background: #f0f0f0; font-weight: bold; font-size: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        #toolbox-content { flex: 1; overflow-y: auto; padding: 5px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; align-content: start; }
        
        .tb-item { 
            aspect-ratio: 1; background: white; border: 1px solid #ddd; border-radius: 4px; 
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 11px; text-align: center; transition: 0.2s;
        }
        .tb-item:hover { border-color: var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tb-icon { width: 40px; height: 40px; margin-bottom: 5px; border-radius: 4px; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }

        /* ORTA EKRAN (Viewport) */
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; min-width: 0; }
        
        /* SAƒû PANEL (Properties) */
        #right-panel {
            width: 260px; background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20; flex-shrink: 0; transition: width 0.2s;
        }
        #right-panel.closed { width: 0; border: none; overflow: hidden; }
        
        .split-v { flex: 1; overflow-y: auto; display: flex; flex-direction: column; min-height: 100px; border-bottom: 1px solid var(--border); }
        #prop-content { padding: 10px; }
        .prop-row { display: flex; margin-bottom: 8px; align-items: center; font-size: 11px; }
        .prop-label { width: 45%; color: #555; }
        .prop-input { width: 55%; border: 1px solid #ccc; padding: 4px; border-radius: 3px; }
        .prop-chk { width: auto; }

        /* OYUN HUD */
        #game-hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 100; }
        #joystick-area { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.5); }
        #joystick-knob { width: 50px; height: 50px; background: white; border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #jump-btn { position: absolute; bottom: 50px; right: 30px; width: 80px; height: 80px; background: rgba(0,120,215,0.8); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        #jump-btn:active { transform: scale(0.95); }

        /* X BUTTON & MENU */
        #x-btn {
            position: absolute; top: 5px; left: 10px; width: 30px; height: 30px;
            background: #333; color: white; border: 2px solid white; border-radius: 5px;
            font-weight: bold; cursor: pointer; z-index: 2000; display: flex; align-items: center; justify-content: center;
        }
        #x-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            z-index: 2001; display: none; align-items: center; justify-content: center;
        }
        #x-settings-panel {
            width: 300px; background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); border-top: 5px solid var(--accent);
        }

        /* LUNAIX CHAT UI */
        #lunaix-chat {
            position: absolute; bottom: 10px; right: 10px; width: 320px; height: 400px;
            background: white; border: 1px solid #ccc; border-radius: 8px;
            display: none; flex-direction: column; z-index: 150; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #chat-header { background: var(--accent); color: white; padding: 10px; font-weight: bold; display:flex; justify-content:space-between; align-items: center; cursor: grab; }
        #chat-messages { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; font-size: 13px; }
        .chat-msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 85%; line-height: 1.4; }
        .chat-msg.ai { background: #fff; border: 1px solid #e0e0e0; color: #333; border-bottom-left-radius: 2px; }
        .chat-msg.user { background: #0078d7; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
        #chat-input-area { display: flex; padding: 10px; border-top: 1px solid #eee; background: white; }
        #chat-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; padding-left: 15px; }
        #chat-send { background: var(--accent); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; margin-left: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Explorer Item */
        .explorer-item { padding: 4px 8px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .explorer-item:hover { background: #f0f0f0; }
        .explorer-item.selected { background: #cce8ff; border-left: 3px solid var(--accent); }
        .exp-icon { margin-right: 6px; font-size: 14px; }

        /* Gizli Inputlar */
        #obj-input, #tex-input { display: none; }
    </style>
</head>
<body onload="LunX.init()">

    <div id="x-btn" onclick="Settings.toggle()">X</div>
    <div id="x-menu-overlay" onclick="if(event.target==this) Settings.toggle()">
        <div id="x-settings-panel">
            <h3 style="margin-top:0; color:var(--accent);">Ayarlar</h3>
            <div style="margin-bottom:15px;">
                <label>Aray√ºz √ñl√ßeƒüi</label>
                <input type="range" min="0.5" max="1.2" step="0.1" value="1" style="width:100%" onchange="document.documentElement.style.zoom=this.value">
            </div>
            <button onclick="location.reload()" style="width:100%; padding:10px; background:#333; color:white; border:none; border-radius:4px; cursor:pointer;">Sahneyi Sƒ±fƒ±rla</button>
        </div>
    </div>

    <div id="top-bar">
        <div style="font-weight:900; font-size:14px;">LUNX STUDIO <span style="opacity:0.7; font-weight:400;">V11</span></div>
        <div id="tab-container">
            <div class="tab-btn active" onclick="UI.setTab('home')">Giri≈ü</div>
            <div class="tab-btn" onclick="UI.setTab('model')">Model</div>
            <div class="tab-btn" onclick="UI.setTab('view')">G√∂r√ºn√ºm</div>
        </div>
    </div>

    <div id="ribbon">
        <div id="sec-home" class="tool-section active">
            <div class="ribbon-btn" onclick="Tools.setMode('select')"><span>üëÜ</span><label>Se√ß</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('translate')"><span>‚ÜîÔ∏è</span><label>Ta≈üƒ±</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('scale')"><span>‚§¢</span><label>Boyut</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('rotate')"><span>üîÑ</span><label>D√∂nd√ºr</label></div>
            <div style="width:1px; height:60%; background:#ddd; margin:0 5px;"></div>
            <div class="ribbon-btn" onclick="Game.play()"><span style="color:#2ecc71">‚ñ∂Ô∏è</span><label>Oyna</label></div>
            <div class="ribbon-btn" onclick="Game.stop()"><span style="color:#e74c3c">‚èπÔ∏è</span><label>Durdur</label></div>
        </div>
        
        <div id="sec-model" class="tool-section">
            <div class="ribbon-btn" onclick="World.add('box')"><span>üì¶</span><label>Part</label></div>
            <div class="ribbon-btn" onclick="World.add('sphere')"><span>‚ö™</span><label>Sphere</label></div>
            <div class="ribbon-btn" onclick="World.add('cylinder')"><span>üõ¢Ô∏è</span><label>Cyl</label></div>
            <div class="ribbon-btn" onclick="World.add('wedge')"><span>üìê</span><label>Wedge</label></div>
            <div style="width:1px; height:60%; background:#ddd; margin:0 5px;"></div>
            <div class="ribbon-btn" onclick="AI.toggle()"><span>üß†</span><label>AI Asistan</label></div>
            <div class="ribbon-btn" onclick="World.importOBJ()"><span>üìÇ</span><label>OBJ Ekle</label></div>
            <div class="ribbon-btn" onclick="World.add('spawn')"><span>üèÅ</span><label>Spawn</label></div>
        </div>
        
        <div id="sec-view" class="tool-section">
            <div class="ribbon-btn" onclick="UI.togglePanel('toolbox')"><span>üß∞</span><label>Toolbox</label></div>
            <div class="ribbon-btn" onclick="UI.togglePanel('right-panel')"><span>üìù</span><label>√ñzellikler</label></div>
        </div>
    </div>

    <div id="main-layout">
        
        <div id="toolbox">
            <div class="panel-head">Toolbox <span style="cursor:pointer; font-size:16px;" onclick="UI.togglePanel('toolbox')">√ó</span></div>
            <div id="toolbox-content"></div>
        </div>

        <div id="viewport">
            <div id="game-hud">
                <div id="joystick-area"><div id="joystick-knob"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>

            <div id="lunaix-chat">
                <div id="chat-header">
                    <span>ü§ñ LunAIX Asistan</span>
                    <span style="cursor:pointer" onclick="AI.toggle()">_</span>
                </div>
                <div id="chat-messages">
                    <div class="chat-msg ai">Merhaba! Bana "Kƒ±rmƒ±zƒ± tuƒüla duvar yap" veya "Rastgele kule olu≈ütur" diyebilirsin.</div>
                </div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Buraya yaz..." onkeydown="if(event.key==='Enter') AI.send()">
                    <button id="chat-send" onclick="AI.send()">‚û§</button>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div class="split-v" style="height:40%">
                <div class="panel-head">Explorer</div>
                <div id="explorer"></div>
            </div>
            <div class="split-v" style="height:60%; border-bottom:none;">
                <div class="panel-head">Properties</div>
                <div id="prop-content">
                    <div style="padding:10px; color:#999; text-align:center;">Bir nesne se√ßin</div>
                </div>
            </div>
        </div>

    </div>

    <input type="file" id="obj-input" accept=".obj">

    <script>
        /* --- Sƒ∞STEM √áEKƒ∞RDEƒûƒ∞ --- */
        const LunX = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            objects: [], selected: null, isPlaying: false,
            character: null,
            clock: new THREE.Clock(),
            keys: {},
            joy: { x:0, y:0, active:false },

            init: () => {
                Engine.init();
                UI.initToolbox();
                Events.setup();
                // Baseplate ekle
                World.add('baseplate');
            }
        };

        /* --- G√ñR√úNT√ú MOTORU (THREE.JS) --- */
        const Engine = {
            init: () => {
                const vp = document.getElementById('viewport');
                LunX.scene = new THREE.Scene();
                LunX.scene.background = new THREE.Color(0x87CEEB);
                LunX.scene.fog = new THREE.Fog(0x87CEEB, 30, 300);

                LunX.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                LunX.camera.position.set(15, 15, 15);

                LunX.renderer = new THREE.WebGLRenderer({ antialias: true });
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
                LunX.renderer.shadowMap.enabled = true;
                LunX.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                vp.appendChild(LunX.renderer.domElement);

                // I≈üƒ±klandƒ±rma
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                LunX.scene.add(hemi);
                
                const dir = new THREE.DirectionalLight(0xffffff, 0.8);
                dir.position.set(50, 80, 30);
                dir.castShadow = true;
                dir.shadow.camera.left = -50; dir.shadow.camera.right = 50;
                dir.shadow.camera.top = 50; dir.shadow.camera.bottom = -50;
                dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
                LunX.scene.add(dir);

                // Kontroller
                LunX.controls = new THREE.OrbitControls(LunX.camera, LunX.renderer.domElement);
                LunX.controls.enableDamping = true;
                LunX.controls.dampingFactor = 0.1;

                LunX.transform = new THREE.TransformControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform.addEventListener('dragging-changed', e => LunX.controls.enabled = !e.value);
                LunX.transform.addEventListener('change', UI.updateProps); // Transform deƒüi≈üince UI g√ºncelle
                LunX.scene.add(LunX.transform);

                window.addEventListener('resize', Engine.resize);
                Engine.loop();
            },
            resize: () => {
                const vp = document.getElementById('viewport');
                LunX.camera.aspect = vp.clientWidth / vp.clientHeight;
                LunX.camera.updateProjectionMatrix();
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },
            loop: () => {
                requestAnimationFrame(Engine.loop);
                const dt = LunX.clock.getDelta();
                
                if(LunX.isPlaying) Game.update(dt);
                
                LunX.controls.update();
                LunX.renderer.render(LunX.scene, LunX.camera);
            }
        };

        /* --- OYUN MANTIƒûI & R6 KARAKTERƒ∞ --- */
        const Game = {
            play: () => {
                if(LunX.isPlaying) return;
                LunX.isPlaying = true;
                
                // UI Deƒüi≈üimi
                LunX.transform.detach();
                document.getElementById('ribbon').style.display = 'none';
                ['toolbox', 'right-panel'].forEach(id => document.getElementById(id).classList.add('closed'));
                setTimeout(Engine.resize, 210); // Animasyon sonrasƒ± resize
                document.getElementById('game-hud').style.display = 'block';

                // Karakter Olu≈ütur (R6)
                Game.spawnCharacter();
            },
            spawnCharacter: () => {
                const spawn = LunX.objects.find(o=>o.name==="SpawnLocation");
                const startPos = spawn ? spawn.position.clone().add(new THREE.Vector3(0,5,0)) : new THREE.Vector3(0,10,0);

                const group = new THREE.Group();
                group.name = "Player";
                
                const matYellow = new THREE.MeshPhongMaterial({color:0xf1c40f});
                const matBlue = new THREE.MeshPhongMaterial({color:0x3498db});
                const matGreen = new THREE.MeshPhongMaterial({color:0x2ecc71});

                // R6 Par√ßalarƒ± (√ñl√ß√ºler yakla≈üƒ±k Roblox R6)
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), matBlue);
                torso.name = "Torso"; torso.position.y = 3; torso.castShadow = true;
                
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), matYellow); // Block Head
                head.name = "Head"; head.position.y = 4.6; head.castShadow = true;

                const leftArm = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), matYellow);
                leftArm.name = "LeftArm"; leftArm.position.set(-1.5, 3, 0); leftArm.userData = {origin: new THREE.Vector3(-1.5, 3, 0)};
                
                const rightArm = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), matYellow);
                rightArm.name = "RightArm"; rightArm.position.set(1.5, 3, 0); rightArm.userData = {origin: new THREE.Vector3(1.5, 3, 0)};

                const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), matGreen);
                leftLeg.name = "LeftLeg"; leftLeg.position.set(-0.5, 1, 0); leftLeg.userData = {origin: new THREE.Vector3(-0.5, 1, 0)};

                const rightLeg = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), matGreen);
                rightLeg.name = "RightLeg"; rightLeg.position.set(0.5, 1, 0); rightLeg.userData = {origin: new THREE.Vector3(0.5, 1, 0)};

                // Gruplama
                group.add(torso, head, leftArm, rightArm, leftLeg, rightLeg);
                group.position.copy(startPos);
                
                // Fizik Deƒüerleri
                group.userData = { 
                    velocity: new THREE.Vector3(), 
                    onGround: false,
                    speed: 15,
                    jumpPower: 25
                };

                LunX.scene.add(group);
                LunX.character = group;

                // Kamerayƒ± ayarla
                LunX.controls.enablePan = false;
                LunX.controls.maxDistance = 30;
                LunX.controls.minDistance = 5;
            },
            stop: () => {
                if(!LunX.isPlaying) return;
                LunX.isPlaying = false;
                
                // UI Geri Al
                document.getElementById('ribbon').style.display = 'flex';
                ['toolbox', 'right-panel'].forEach(id => document.getElementById(id).classList.remove('closed'));
                setTimeout(Engine.resize, 210);
                document.getElementById('game-hud').style.display = 'none';

                // Karakteri Sil
                if(LunX.character) LunX.scene.remove(LunX.character);
                LunX.character = null;

                // Kamera Reset
                LunX.controls.target.set(0,0,0);
                LunX.controls.enablePan = true;
                LunX.camera.position.set(15,15,15);

                // Objeleri resetle (physics reset)
                LunX.objects.forEach(o => { if(!o.userData.anchored) o.position.y = Math.max(o.position.y, 2); });
            },
            update: (dt) => {
                if(!LunX.character) return;
                const char = LunX.character;
                const data = char.userData;

                // 1. Yer√ßekimi ve Zemin Kontrol√º (Basit Fizik)
                if(!data.onGround) {
                    data.velocity.y -= 60 * dt; // Gravity
                }
                
                char.position.y += data.velocity.y * dt;
                
                // Basit zemin √ßarpƒ±≈ümasƒ± (y=2 zemin kabul edildi R6 pivot i√ßin)
                if(char.position.y <= 0) { // Pivot 0 noktasƒ±nda
                    char.position.y = 0;
                    data.velocity.y = 0;
                    data.onGround = true;
                } else {
                    data.onGround = false;
                }

                // 2. Hareket Mantƒ±ƒüƒ± (Kamera R√∂latif)
                let moveX = LunX.joy.x;
                let moveZ = LunX.joy.y;

                // Klavye
                if(LunX.keys['w']) moveZ = 1;
                if(LunX.keys['s']) moveZ = -1;
                if(LunX.keys['a']) moveX = -1;
                if(LunX.keys['d']) moveX = 1;

                const isMoving = Math.abs(moveX) > 0.1 || Math.abs(moveZ) > 0.1;

                if(isMoving) {
                    // Kamera y√∂n√ºn√º al (Y eksenini yoksay)
                    const camDir = new THREE.Vector3();
                    LunX.camera.getWorldDirection(camDir);
                    camDir.y = 0; camDir.normalize();
                    
                    const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x); // Saƒüa doƒüru vekt√∂r
                    
                    // Hareket vekt√∂r√º: ƒ∞leri/Geri * KameraY√∂n√º + Saƒü/Sol * KameraSaƒüƒ±
                    const moveDir = camDir.multiplyScalar(moveZ).add(camRight.multiplyScalar(moveX)).normalize();
                    
                    // Pozisyon g√ºncelle
                    char.position.add(moveDir.multiplyScalar(data.speed * dt));
                    
                    // Karakteri hareket y√∂n√ºne d√∂nd√ºr (Lerp ile yumu≈üak d√∂n√º≈ü)
                    const targetRotation = Math.atan2(moveDir.x, moveDir.z);
                    // Mevcut rotasyondan hedefe en kƒ±sa yoldan d√∂nmek i√ßin Quaternion kullanmak daha iyi ama burada basit tutuyoruz:
                    char.rotation.y = targetRotation; 

                    // 3. Y√ºr√ºme Animasyonu (Procedural)
                    const time = Date.now() * 0.01;
                    const angle = Math.sin(time) * 0.8; // Sallanma a√ßƒ±sƒ±

                    // Kollarƒ± ve Bacaklarƒ± Bul
                    const lArm = char.getObjectByName("LeftArm");
                    const rArm = char.getObjectByName("RightArm");
                    const lLeg = char.getObjectByName("LeftLeg");
                    const rLeg = char.getObjectByName("RightLeg");

                    // Pivot noktalarƒ± etrafƒ±nda d√∂nd√ºr (Basit√ße rotation.x oynatƒ±yoruz)
                    // Normalde pivot ayarƒ± gerekir ama burada yerel rotasyon yetecektir.
                    if(lArm) lArm.rotation.x = angle;
                    if(rArm) rArm.rotation.x = -angle;
                    if(lLeg) lLeg.rotation.x = -angle;
                    if(rLeg) rLeg.rotation.x = angle;

                } else {
                    // Duruyorsa kollarƒ± indir
                    ["LeftArm","RightArm","LeftLeg","RightLeg"].forEach(n => {
                        const p = char.getObjectByName(n);
                        if(p) p.rotation.x = 0; // Lerp eklenebilir
                    });
                }

                // 4. Kamera Takibi (Sadece Pozisyon, Rotasyon Manuel)
                LunX.controls.target.copy(char.position.clone().add(new THREE.Vector3(0, 3, 0))); 
                // controls.update loop i√ßinde √ßaƒürƒ±ldƒ±ƒüƒ± i√ßin kamera target'a bakmaya devam eder,
                // ama oyuncu mouse ile d√∂nd√ºrebilir.

                // 5. Diƒüer Objelerin Fiziƒüi (Basit)
                LunX.objects.forEach(obj => {
                    if(obj.userData.canCollide && !obj.userData.anchored && obj.position.y > 0.5) { // Baseplate hari√ß
                         // Basit d√º≈üme
                         obj.position.y -= 10 * dt;
                         if(obj.position.y < obj.scale.y/2) obj.position.y = obj.scale.y/2;
                    }
                });
            },
            jump: () => {
                if(LunX.character && LunX.character.userData.onGround) {
                    LunX.character.userData.velocity.y = LunX.character.userData.jumpPower;
                    LunX.character.userData.onGround = false;
                }
            }
        };

        /* --- WORLD & OLU≈ûTURMA --- */
        const World = {
            textures: {},
            
            // Procedural Texture Generator
            getTexture: (type, colorHex) => {
                const key = type + colorHex;
                if(World.textures[key]) return World.textures[key];

                const cvs = document.createElement('canvas');
                cvs.width = 128; cvs.height = 128;
                const ctx = cvs.getContext('2d');
                
                // Zemin Rengi
                ctx.fillStyle = '#' + new THREE.Color(colorHex).getHexString();
                ctx.fillRect(0,0,128,128);

                // Doku Efektleri
                if(type === 'brick') {
                    ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.lineWidth = 2;
                    for(let i=0; i<128; i+=32) {
                        ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(128,i); ctx.stroke();
                        for(let j=0; j<128; j+=32) {
                            let off = (i/32)%2===0 ? 0 : 16;
                            ctx.beginPath(); ctx.moveTo(j+off, i); ctx.lineTo(j+off, i+32); ctx.stroke();
                        }
                    }
                } else if(type === 'grass') {
                    ctx.fillStyle = "rgba(0,0,0,0.1)";
                    for(let i=0; i<400; i++) ctx.fillRect(Math.random()*128, Math.random()*128, 2, 2);
                } else if(type === 'wood') {
                    ctx.strokeStyle = "rgba(60,30,0,0.1)"; ctx.lineWidth = 3;
                    for(let i=0; i<128; i+=4) {
                        ctx.beginPath(); ctx.moveTo(0, i + Math.random()*10); 
                        ctx.bezierCurveTo(40, i, 80, i+10, 128, i); ctx.stroke();
                    }
                }

                const tex = new THREE.CanvasTexture(cvs);
                tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
                World.textures[key] = tex;
                return tex;
            },

            add: (type, opts={}) => {
                let geo, mat;
                const color = opts.color || 0xaaaaaa;
                const texType = opts.tex || 'smooth';

                // Materyal
                if(texType === 'neon') {
                    mat = new THREE.MeshBasicMaterial({color: color});
                } else {
                    const map = texType !== 'smooth' ? World.getTexture(texType, color) : null;
                    mat = new THREE.MeshStandardMaterial({color: color, map: map, roughness: 0.8});
                }

                // Geometri
                if(type==='baseplate') { geo = new THREE.BoxGeometry(200, 1, 200); mat.color.setHex(0x333333); mat.map=World.getTexture('grid', 0x333333); }
                else if(type==='sphere') geo = new THREE.SphereGeometry(2,32,32);
                else if(type==='cylinder') geo = new THREE.CylinderGeometry(2,2,4,32);
                else if(type==='wedge') geo = new THREE.ConeGeometry(2,4,4); // Basit wedge temsili
                else geo = new THREE.BoxGeometry(4,4,4);

                const mesh = new THREE.Mesh(geo, mat);
                
                // Varsayƒ±lan Pozisyon
                mesh.position.copy(opts.pos || new THREE.Vector3(0, 5, 0));
                
                // √ñzellikler
                if(type==='baseplate') { 
                    mesh.position.y = -0.5; 
                    mesh.name="Baseplate"; 
                    mesh.userData = { anchored: true, canCollide: true, locked: true };
                    mesh.receiveShadow = true;
                } else {
                    mesh.name = opts.name || "Part";
                    mesh.castShadow = true; mesh.receiveShadow = true;
                    mesh.userData = { 
                        anchored: opts.anchored !== undefined ? opts.anchored : true, 
                        canCollide: true 
                    };
                }

                if(type==='spawn') { 
                    mesh.scale.set(2, 0.1, 2); 
                    mesh.material.color.setHex(0x888888);
                    mesh.material.map = World.getTexture('grid', 0x888888);
                    mesh.name="SpawnLocation"; 
                    const decal = new THREE.Mesh(new THREE.PlaneGeometry(2,2), new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.5}));
                    decal.rotation.x = -Math.PI/2; decal.position.y=2.1; mesh.add(decal);
                }

                LunX.scene.add(mesh);
                LunX.objects.push(mesh);
                UI.refreshExplorer();
                return mesh;
            },
            importOBJ: () => document.getElementById('obj-input').click()
        };

        /* --- UI Y√ñNETƒ∞Mƒ∞ --- */
        const UI = {
            initToolbox: () => {
                const tb = document.getElementById('toolbox-content');
                // Doku √ñnizlemeleri ile Toolbox
                const items = [
                    {n:"Tuƒüla", t:'brick', c:0xcc5555},
                    {n:"√áim", t:'grass', c:0x55aa55},
                    {n:"Tahta", t:'wood', c:0x8B4513},
                    {n:"Metal", t:'smooth', c:0xaaaaaa},
                    {n:"Neon", t:'neon', c:0x00ffff},
                    {n:"Karanlƒ±k", t:'smooth', c:0x222222}
                ];

                items.forEach(it => {
                    const el = document.createElement('div');
                    el.className = 'tb-item';
                    
                    // Canvas ile ikon √ßiz
                    const cvs = document.createElement('canvas'); cvs.width=40; cvs.height=40;
                    const ctx = cvs.getContext('2d');
                    ctx.fillStyle = '#' + new THREE.Color(it.c).getHexString(); ctx.fillRect(0,0,40,40);
                    // Basit desen
                    if(it.t==='brick'){ ctx.fillStyle='rgba(0,0,0,0.2)'; ctx.fillRect(0,18,40,4); }
                    
                    const icon = document.createElement('img');
                    icon.src = cvs.toDataURL();
                    icon.className = 'tb-icon';

                    el.appendChild(icon);
                    el.innerHTML += `<span>${it.n}</span>`;
                    
                    el.onclick = () => World.add('box', {color:it.c, tex:it.t});
                    tb.appendChild(el);
                });
            },
            setTab: (id) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
                document.getElementById('sec-'+id).classList.add('active');
            },
            togglePanel: (id) => {
                const el = document.getElementById(id);
                el.classList.toggle('closed');
                setTimeout(Engine.resize, 210); // CSS transition bitince resize yap
            },
            refreshExplorer: () => {
                const ex = document.getElementById('explorer');
                ex.innerHTML = '';
                LunX.objects.forEach(obj => {
                    const div = document.createElement('div');
                    div.className = 'explorer-item' + (LunX.selected === obj ? ' selected' : '');
                    div.innerHTML = `<span class="exp-icon">üì¶</span> ${obj.name}`;
                    div.onclick = () => Tools.select(obj);
                    ex.appendChild(div);
                });
            },
            updateProps: () => {
                const p = document.getElementById('prop-content');
                p.innerHTML = '';
                const obj = LunX.selected;
                if(!obj) {
                    p.innerHTML = '<div style="padding:10px;color:#999">Se√ßili nesne yok.</div>';
                    return;
                }

                const createRow = (label, inputEl) => {
                    const r = document.createElement('div'); r.className='prop-row';
                    r.innerHTML = `<div class="prop-label">${label}</div>`;
                    r.appendChild(inputEl); p.appendChild(r);
                };

                // ƒ∞sim
                const inpName = document.createElement('input'); inpName.className='prop-input';
                inpName.value = obj.name;
                inpName.onchange = e => { obj.name = e.target.value; UI.refreshExplorer(); };
                createRow('Name', inpName);

                // Pozisyon (Basit√ße X g√∂sterimi)
                const inpX = document.createElement('input'); inpX.className='prop-input';
                inpX.value = obj.position.x.toFixed(2);
                inpX.onchange = e => { obj.position.x = parseFloat(e.target.value); };
                createRow('Pos X', inpX);

                // Renk
                const inpCol = document.createElement('input'); inpCol.type='color';
                inpCol.value = '#' + obj.material.color.getHexString();
                inpCol.onchange = e => { obj.material.color.set(e.target.value); };
                createRow('Color', inpCol);

                // Anchored (Checkbox)
                const chkAnch = document.createElement('input'); chkAnch.type='checkbox';
                chkAnch.checked = obj.userData.anchored;
                chkAnch.onchange = e => { obj.userData.anchored = e.target.checked; };
                createRow('Anchored', chkAnch);

                // CanCollide (Checkbox)
                const chkCol = document.createElement('input'); chkCol.type='checkbox';
                chkCol.checked = obj.userData.canCollide;
                chkCol.onchange = e => { obj.userData.canCollide = e.target.checked; };
                createRow('CanCollide', chkCol);
            }
        };

        /* --- ARA√áLAR --- */
        const Tools = {
            setMode: (mode) => {
                if(mode === 'select') LunX.transform.detach();
                else {
                    LunX.transform.setMode(mode);
                    if(LunX.selected) LunX.transform.attach(LunX.selected);
                }
                // Buton g√∂rsel g√ºncellemesi
                document.querySelectorAll('.ribbon-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
            },
            select: (obj) => {
                LunX.selected = obj;
                if(obj && !obj.userData.locked) LunX.transform.attach(obj);
                else LunX.transform.detach();
                UI.updateProps();
                UI.refreshExplorer();
            }
        };

        /* --- AI Sƒ∞STEMƒ∞ --- */
        const AI = {
            toggle: () => {
                const el = document.getElementById('lunaix-chat');
                el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            },
            log: (msg, type) => {
                const box = document.getElementById('chat-messages');
                const d = document.createElement('div');
                d.className = `chat-msg ${type}`;
                d.innerText = msg;
                box.appendChild(d);
                box.scrollTop = box.scrollHeight;
            },
            send: () => {
                const inp = document.getElementById('chat-input');
                const txt = inp.value.trim();
                if(!txt) return;
                AI.log(txt, 'user');
                inp.value = '';
                
                // Basit Komut ƒ∞≈üleme
                setTimeout(() => {
                    const ltxt = txt.toLowerCase();
                    let response = "Bunu hen√ºz yapamƒ±yorum.";
                    let acted = false;

                    let color = 0xaaaaaa;
                    if(ltxt.includes('kƒ±rmƒ±zƒ±')) color = 0xff0000;
                    if(ltxt.includes('mavi')) color = 0x0000ff;
                    if(ltxt.includes('ye≈üil')) color = 0x00ff00;

                    if(ltxt.includes('duvar')) {
                        const w = World.add('box', {pos:new THREE.Vector3(0,2,0), color:color, tex:'brick'});
                        w.scale.set(10, 4, 1);
                        response = "Duvar in≈üa edildi."; acted = true;
                    }
                    else if(ltxt.includes('kule')) {
                        for(let i=0; i<5; i++) World.add('box', {pos:new THREE.Vector3(5, 2+(i*4), 5), color:Math.random()*0xffffff});
                        response = "Kule dikildi."; acted = true;
                    }
                    else if(ltxt.includes('orman')) {
                        for(let i=0; i<5; i++) World.add('cylinder', {pos:new THREE.Vector3(Math.random()*20-10, 2, Math.random()*20-10), color:0x55aa55, tex:'wood'});
                        response = "Aƒüa√ßlar eklendi."; acted = true;
                    }

                    AI.log(response, 'ai');
                }, 600);
            }
        };

        /* --- OLAY Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞ --- */
        const Events = {
            setup: () => {
                // Klavye
                window.addEventListener('keydown', e => LunX.keys[e.key.toLowerCase()] = true);
                window.addEventListener('keyup', e => LunX.keys[e.key.toLowerCase()] = false);

                // Se√ßim (Raycaster)
                const vp = document.getElementById('viewport');
                vp.addEventListener('mousedown', e => {
                    if(LunX.isPlaying) return;
                    // UI'a tƒ±klanmadƒ±ysa (Joystick vb)
                    if(e.target !== LunX.renderer.domElement) return;

                    const rect = LunX.renderer.domElement.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    const ray = new THREE.Raycaster();
                    ray.setFromCamera({x,y}, LunX.camera);
                    const hits = ray.intersectObjects(LunX.objects);
                    
                    if(hits.length > 0) Tools.select(hits[0].object);
                    else Tools.select(null);
                });

                // Joystick
                const joy = document.getElementById('joystick-area');
                joy.addEventListener('touchstart', e => { LunX.joy.active=true; Events.joyMove(e); }, {passive:false});
                joy.addEventListener('touchmove', Events.joyMove, {passive:false});
                joy.addEventListener('touchend', () => { 
                    LunX.joy.active=false; LunX.joy.x=0; LunX.joy.y=0; 
                    document.getElementById('joystick-knob').style.transform='translate(0,0)'; 
                });

                // Zƒ±plama
                const btnJump = document.getElementById('jump-btn');
                btnJump.addEventListener('mousedown', Game.jump);
                btnJump.addEventListener('touchstart', Game.jump);

                // Dosya Y√ºkleme
                document.getElementById('obj-input').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const loader = new THREE.OBJLoader();
                        const obj = loader.parse(ev.target.result);
                        obj.position.set(0, 5, 0); obj.name = "Model";
                        LunX.scene.add(obj); LunX.objects.push(obj); UI.refreshExplorer();
                    };
                    reader.readAsText(file);
                });
            },
            joyMove: (e) => {
                e.preventDefault();
                const rect = document.getElementById('joystick-area').getBoundingClientRect();
                const cx = rect.left+60, cy=rect.top+60;
                const tx = e.touches[0].clientX, ty = e.touches[0].clientY;
                
                let dx = tx - cx;
                let dy = ty - cy;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if(dist > 40) {
                    const angle = Math.atan2(dy, dx);
                    dx = Math.cos(angle) * 40;
                    dy = Math.sin(angle) * 40;
                }

                document.getElementById('joystick-knob').style.transform = `translate(${dx}px, ${dy}px)`;
                LunX.joy.x = dx / 40; // Saƒü-Sol
                LunX.joy.y = dy / 40; // ƒ∞leri-Geri
            }
        };

        const Settings = {
            toggle: () => {
                const el = document.getElementById('x-menu-overlay');
                el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            }
        };

    </script>
</body>
</html>
