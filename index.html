<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Create Anything</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #D32F2F; /* LunX Kƒ±rmƒ±zƒ±sƒ± */
            --primary-hover: #B71C1C;
            --bg-light: #F5F5F5;
            --bg-panel: #FFFFFF;
            --border: #DADCE0;
            --text-main: #202124;
            --ribbon-height: 100px;
            --panel-width: 280px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-light); height: 100vh; display: flex; flex-direction: column; color: var(--text-main); }

        /* --- √úST MEN√ú (Quick Access) --- */
        #title-bar { height: 35px; background: #FFFFFF; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 10px; justify-content: space-between; z-index: 50; }
        .app-logo { font-weight: 900; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .app-logo span { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; }
        .quick-actions { display: flex; gap: 10px; }
        .qa-btn { background: none; border: none; cursor: pointer; font-size: 16px; color: #555; }

        /* --- MENU TABS --- */
        #menu-tabs { background: var(--primary); height: 30px; display: flex; padding-left: 10px; align-items: flex-end; }
        .tab-btn { padding: 5px 20px; color: rgba(255,255,255,0.8); cursor: pointer; font-size: 12px; border-top-left-radius: 5px; border-top-right-radius: 5px; transition: 0.2s; }
        .tab-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tab-btn.active { background: #F5F5F5; color: var(--text-main); font-weight: bold; }

        /* --- RIBBON BAR --- */
        #ribbon { height: var(--ribbon-height); background: #F5F5F5; border-bottom: 1px solid var(--border); display: flex; padding: 5px 10px; overflow-x: auto; align-items: center; }
        .ribbon-group { display: none; gap: 5px; height: 100%; align-items: center; padding-right: 10px; border-right: 1px solid #E0E0E0; margin-right: 10px; }
        .ribbon-group.active { display: flex; }
        
        .tool-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 50px; height: 70px; cursor: pointer; border-radius: 4px; color: #444; font-size: 11px;
            transition: 0.1s; border: 1px solid transparent; padding: 0 5px;
        }
        .tool-btn:hover { background: white; border-color: #DDD; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tool-btn.active { background: #E3F2FD; border-color: var(--primary); color: var(--primary); }
        .tool-icon { font-size: 24px; margin-bottom: 5px; }
        .tool-label { font-size: 10px; margin-top: 2px; text-align: center; }
        
        .play-btn { background: var(--primary); color: white !important; height: 50px; width: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.2); margin-left: auto; }
        .play-btn:hover { background: var(--primary-hover); transform: scale(1.05); }

        /* --- ANA D√úZEN --- */
        #layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* SOL PANEL (Explorer) */
        #explorer { width: var(--panel-width); background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; }
        
        /* SAƒû PANEL (Properties) */
        #properties { width: var(--panel-width); background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; }

        .panel-header { padding: 8px 10px; background: #F1F1F1; font-weight: bold; font-size: 12px; border-bottom: 1px solid #DDD; color: #555; display: flex; justify-content: space-between; }
        .panel-content { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; }
        .prop-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .prop-input { width: 60%; padding: 4px; border: 1px solid #DDD; border-radius: 3px; }

        /* ORTA (Viewport) */
        #viewport { flex: 1; position: relative; background: #A0D4F6; overflow: hidden; }

        /* --- MOBƒ∞L KONTROLLER --- */
        #game-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 100; }
        
        /* Joystick */
        #joystick-area { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(0,0,0,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); pointer-events: auto; }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* Jump Button */
        #jump-btn { position: absolute; bottom: 60px; right: 50px; width: 80px; height: 80px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); cursor: pointer; }
        #jump-btn:active { background: rgba(255,255,255,0.5); }
        #jump-icon { width: 40px; height: 40px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 4l-8 8h6v8h4v-8h6z"/></svg>') no-repeat center/contain; }

        /* Stop Button */
        #stop-btn { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 8px 20px; border-radius: 4px; font-weight: bold; font-size: 14px; border: 2px solid white; cursor: pointer; pointer-events: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px; }
        
        /* --- LunAIX MODAL --- */
        #lunaix-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: linear-gradient(135deg, #6200EA, #B388FF); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 5px 15px rgba(98, 0, 234, 0.4); z-index: 200; transition: 0.2s; }
        #lunaix-btn:hover { transform: scale(1.1); }

        #ai-panel { position: fixed; bottom: 80px; right: 20px; width: 300px; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 200; border: 1px solid #EEE; overflow: hidden; }
        #ai-header { background: linear-gradient(135deg, #6200EA, #B388FF); color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        #ai-content { height: 250px; overflow-y: auto; padding: 10px; background: #FAFAFA; font-size: 13px; }
        .msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; max-width: 85%; }
        .msg.bot { background: white; border: 1px solid #EEE; align-self: flex-start; color: #333; }
        .msg.user { background: #F3E5F5; color: #4A148C; align-self: flex-end; margin-left: auto; }
        #ai-input-box { padding: 10px; border-top: 1px solid #EEE; display: flex; gap: 5px; }
        #ai-in { flex: 1; border: 1px solid #DDD; padding: 8px; border-radius: 20px; font-size: 12px; }
        
        /* START SCREEN */
        #loader { position: fixed; inset: 0; background: #FFF; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body onload="App.init()">

    <div id="loader">
        <h1 style="color:var(--primary); font-size:30px; margin-bottom:10px;">LunX Studio</h1>
        <div class="spinner"></div>
        <p style="color:#888; font-size:12px; margin-top:10px;">Engine Loading...</p>
    </div>

    <div id="title-bar">
        <div class="app-logo"><span>LunX</span> Studio</div>
        <div class="quick-actions">
            <button class="qa-btn" title="Undo">‚Ü©</button>
            <button class="qa-btn" title="Redo">‚Ü™</button>
        </div>
    </div>

    <div id="menu-tabs">
        <div class="tab-btn active" onclick="UI.setTab('home')">HOME</div>
        <div class="tab-btn" onclick="UI.setTab('model')">MODEL</div>
        <div class="tab-btn" onclick="UI.setTab('view')">VIEW</div>
    </div>

    <div id="ribbon">
        <div id="tab-home" class="ribbon-group active">
            <div class="tool-btn active" onclick="Editor.setMode('select')"><div class="tool-icon">üëÜ</div><div class="tool-label">Se√ß</div></div>
            <div class="tool-btn" onclick="Editor.setMode('translate')"><div class="tool-icon">‚ÜîÔ∏è</div><div class="tool-label">Ta≈üƒ±</div></div>
            <div class="tool-btn" onclick="Editor.setMode('scale')"><div class="tool-icon">‚§°</div><div class="tool-label">√ñl√ßek</div></div>
            <div class="tool-btn" onclick="Editor.setMode('rotate')"><div class="tool-icon">üîÑ</div><div class="tool-label">D√∂nd√ºr</div></div>
            <div style="width:1px; height:40px; background:#DDD; margin:0 10px;"></div>
            <div class="tool-btn" onclick="World.addPart('box')"><div class="tool-icon">üì¶</div><div class="tool-label">Part</div></div>
            <div class="tool-btn" onclick="UI.toggleToolbox()"><div class="tool-icon">üß∞</div><div class="tool-label">Toolbox</div></div>
        </div>

        <div id="tab-model" class="ribbon-group">
            <div class="tool-btn" onclick="World.addPart('sphere')"><div class="tool-icon">‚ö™</div><div class="tool-label">K√ºre</div></div>
            <div class="tool-btn" onclick="World.addPart('cylinder')"><div class="tool-icon">üõ¢Ô∏è</div><div class="tool-label">Silindir</div></div>
            <div class="tool-btn" onclick="World.addPart('wedge')"><div class="tool-icon">üìê</div><div class="tool-label">Wedge</div></div>
            <div style="width:1px; height:40px; background:#DDD; margin:0 10px;"></div>
            <div class="tool-btn" onclick="Editor.material('neon')"><div class="tool-icon">üí°</div><div class="tool-label">Neon</div></div>
            <div class="tool-btn" onclick="Editor.material('glass')"><div class="tool-icon">ü™ü</div><div class="tool-label">Cam</div></div>
        </div>

        <div class="play-btn" onclick="Game.play()">‚ñ∂</div>
    </div>

    <div id="layout">
        <div id="explorer">
            <div class="panel-header">Explorer <span style="cursor:pointer">üîç</span></div>
            <div class="panel-content" id="explorer-list">
                <div style="padding:2px 5px;">üìÇ Workspace</div>
                </div>
        </div>

        <div id="viewport">
            <div id="game-hud">
                <div id="stop-btn" onclick="Game.stop()">‚èπ DURDUR</div>
                <div id="joystick-area"><div id="stick"></div></div>
                <div id="jump-btn"><div id="jump-icon"></div></div>
            </div>
        </div>

        <div id="properties">
            <div class="panel-header">Properties</div>
            <div class="panel-content" id="prop-content">
                <div style="text-align:center; color:#999; margin-top:20px;">Se√ßim Yok</div>
            </div>
        </div>
    </div>

    <div id="lunaix-btn" onclick="AI.toggle()">‚ú®</div>
    <div id="ai-panel">
        <div id="ai-header">LunAIX Asistan <span style="cursor:pointer" onclick="AI.toggle()">‚úï</span></div>
        <div id="ai-content">
            <div class="msg bot">Merhaba! "Ev yap", "K√∂pr√º kur" veya "Araba ekle" diyebilirsin.</div>
        </div>
        <div id="ai-input-box">
            <input type="text" id="ai-in" placeholder="LunAIX'e sor..." onkeydown="if(event.key==='Enter')AI.send()">
            <button onclick="AI.send()" style="border:none; background:none; cursor:pointer; color:#6200EA;">‚û§</button>
        </div>
    </div>

    <script>
        /* --- ENGINE CORE --- */
        const App = {
            scene: null, camera: null, renderer: null,
            world: null, // Physics
            controls: null, transform: null,
            clock: new THREE.Clock(),
            objects: [], // Visual & Physics sync
            raycaster: new THREE.Raycaster(),
            mouse: new THREE.Vector2(),

            init: () => {
                const vp = document.getElementById('viewport');
                
                // 1. THREE.JS SETUP
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0xA0D4F6); // Sky color
                App.scene.fog = new THREE.Fog(0xA0D4F6, 50, 500);

                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth / vp.clientHeight, 0.1, 2000);
                App.camera.position.set(15, 15, 20);

                App.renderer = new THREE.WebGLRenderer({ antialias: true });
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                // LIGHTS
                const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                App.scene.add(hemiLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(50, 100, 50);
                dirLight.castShadow = true;
                dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
                App.scene.add(dirLight);

                // 2. CANNON.JS SETUP
                App.world = new CANNON.World();
                App.world.gravity.set(0, -25, 0); // Roblox gravity is slightly heavy
                App.world.broadphase = new CANNON.NaiveBroadphase();
                
                // Materials
                const defMat = new CANNON.Material();
                const playMat = new CANNON.Material();
                const cm = new CANNON.ContactMaterial(defMat, playMat, { friction: 0.0, restitution: 0.0 });
                App.world.addContactMaterial(cm);

                // 3. CONTROLS (Editor)
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.controls.enableDamping = true;
                App.controls.dampingFactor = 0.05;

                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', (e) => { App.controls.enabled = !e.value; });
                App.transform.addEventListener('change', () => Editor.syncPhysics());
                App.scene.add(App.transform);

                // 4. EVENTS
                window.addEventListener('resize', App.resize);
                vp.addEventListener('pointerdown', Editor.onPointerDown);

                // 5. WORLD GENERATION
                World.initBaseplate();
                
                document.getElementById('loader').style.display = 'none';
                Game.initInput();
                App.loop();
            },

            resize: () => {
                const vp = document.getElementById('viewport');
                App.camera.aspect = vp.clientWidth / vp.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = Math.min(App.clock.getDelta(), 0.1);

                if(Game.active) {
                    App.world.step(1/60, dt, 3);
                    Game.update(dt);
                } else {
                    App.controls.update();
                }

                // Sync Visuals -> Physics
                App.objects.forEach(obj => {
                    if(obj.userData.body && !obj.userData.anchored && !obj.userData.isDragging) {
                        obj.position.copy(obj.userData.body.position);
                        obj.quaternion.copy(obj.userData.body.quaternion);
                        
                        // R6 Visual Offset (Fizik silindiri ortasƒ±ndan g√∂rseli a≈üaƒüƒ± √ßekiyoruz)
                        if(obj.userData.isPlayer) {
                            obj.position.y -= 3; 
                        }
                    }
                });

                App.renderer.render(App.scene, App.camera);
            }
        };

        /* --- WORLD MANAGER --- */
        const World = {
            initBaseplate: () => {
                // 1000x1000 Baseplate
                const geo = new THREE.BoxGeometry(1000, 4, 1000);
                const mat = new THREE.MeshStandardMaterial({ color: 0x666666 }); // Dark Grey Classic
                
                // Stud texture effect (Grid)
                const textureLoader = new THREE.TextureLoader();
                // Using a grid helper visual for classic look
                const grid = new THREE.GridHelper(1000, 250, 0x444444, 0x555555);
                grid.position.y = 2.05;
                App.scene.add(grid);

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.y = 0; // Center is 0, top is 2
                mesh.receiveShadow = true;
                mesh.name = "Baseplate";

                const shape = new CANNON.Box(new CANNON.Vec3(500, 2, 500));
                const body = new CANNON.Body({ mass: 0, shape: shape }); // Mass 0 = Static
                body.position.copy(mesh.position);
                
                mesh.userData = { body: body, anchored: true, type: 'Part' };
                App.world.addBody(body);
                App.scene.add(mesh);
                App.objects.push(mesh);

                // SpawnLocation
                World.addPart('box', { 
                    scale: [6, 1, 6], 
                    pos: new THREE.Vector3(0, 2.5, 0), 
                    color: 0x888888, 
                    anchored: true,
                    name: 'SpawnLocation'
                });
                // Spawn Decal
                const decal = new THREE.Mesh(new THREE.PlaneGeometry(4,4), new THREE.MeshBasicMaterial({color:0x333333}));
                decal.rotation.x = -Math.PI/2; decal.position.set(0, 3.1, 0); App.scene.add(decal);
            },

            addPart: (type, cfg={}) => {
                let geo, shape;
                const scale = cfg.scale || [4, 4, 4];
                const color = cfg.color || 0xAAAAAA; // Medium Stone Grey

                if(type === 'sphere') {
                    geo = new THREE.SphereGeometry(1, 32, 32);
                    shape = new CANNON.Sphere(scale[0]/2);
                } else if(type === 'cylinder') {
                    geo = new THREE.CylinderGeometry(1,1,1,32);
                    shape = new CANNON.Cylinder(scale[0]/2, scale[0]/2, scale[1], 12);
                } else {
                    geo = new THREE.BoxGeometry(1,1,1);
                    shape = new CANNON.Box(new CANNON.Vec3(scale[0]/2, scale[1]/2, scale[2]/2));
                }

                const mat = new THREE.MeshStandardMaterial({ color: color });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.scale.set(scale[0], scale[1], scale[2]);
                mesh.position.copy(cfg.pos || new THREE.Vector3(0, 10, 0));
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.name = cfg.name || "Part";

                const body = new CANNON.Body({
                    mass: cfg.anchored ? 0 : (scale[0]*scale[1]*scale[2]), // Volume based mass
                    shape: shape
                });
                body.position.copy(mesh.position);
                
                mesh.userData = { body: body, anchored: !!cfg.anchored, type: type, color: color };
                
                App.scene.add(mesh);
                App.world.addBody(body);
                App.objects.push(mesh);
                
                UI.updateExplorer();
                return mesh;
            }
        };

        /* --- GAMEPLAY & R6 CHARACTER --- */
        const Game = {
            active: false,
            player: null,
            body: null,
            input: { x:0, y:0, jump:false },
            limbs: {},

            play: () => {
                Game.active = true;
                Editor.select(null);
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('menu-tabs').style.display = 'none';
                document.getElementById('explorer').style.display = 'none';
                document.getElementById('properties').style.display = 'none';
                document.getElementById('game-hud').style.display = 'block';
                
                // Camera Logic
                App.controls.enablePan = false;
                App.controls.minDistance = 5;
                App.controls.maxDistance = 30;

                Game.spawnCharacter();
            },

            stop: () => {
                Game.active = false;
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('menu-tabs').style.display = 'flex';
                document.getElementById('explorer').style.display = 'flex';
                document.getElementById('properties').style.display = 'flex';
                document.getElementById('game-hud').style.display = 'none';

                if(Game.player) {
                    App.scene.remove(Game.player);
                    App.world.removeBody(Game.body);
                    App.objects = App.objects.filter(o => o !== Game.player);
                }

                App.controls.enablePan = true;
                App.controls.target.set(0,0,0);
                App.camera.position.set(15,15,20);
            },

            spawnCharacter: () => {
                const group = new THREE.Group();

                // R6 COLORS
                const yellow = new THREE.MeshStandardMaterial({color: 0xF5CD30}); // Bright Yellow
                const blue = new THREE.MeshStandardMaterial({color: 0x008DD5});   // Bright Blue
                const green = new THREE.MeshStandardMaterial({color: 0xA3BD62});  // Pastel Green

                // R6 PARTS (Visual)
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), yellow); head.position.y = 5.6;
                // Add Face Decal
                const face = new THREE.Mesh(new THREE.PlaneGeometry(0.8,0.8), new THREE.MeshBasicMaterial({color:0x000000})); // Simple face placeholder
                face.position.set(0, 0, 0.61); head.add(face);

                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), blue); torso.position.y = 4;
                
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), yellow); la.position.set(-1.5, 4, 0);
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), yellow); ra.position.set(1.5, 4, 0);
                
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), green); ll.position.set(-0.5, 2, 0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), green); rl.position.set(0.5, 2, 0);

                group.add(head, torso, la, ra, ll, rl);
                group.castShadow = true;

                // PHYSICS (Capsule-like Cylinder)
                const shape = new CANNON.Cylinder(1.5, 1.5, 6, 12); // Width, Width, Height, Segments
                const body = new CANNON.Body({
                    mass: 80,
                    fixedRotation: true, // Don't tip over
                    position: new CANNON.Vec3(0, 10, 0),
                    shape: shape,
                    linearDamping: 0.9 // Simulate friction/air resistance
                });
                
                // Find Spawn
                const spawn = App.scene.getObjectByName('SpawnLocation');
                if(spawn) body.position.set(spawn.position.x, spawn.position.y + 5, spawn.position.z);

                App.scene.add(group);
                App.world.addBody(body);

                Game.player = group;
                Game.body = body;
                Game.limbs = { la, ra, ll, rl };
                
                group.userData = { body: body, isPlayer: true };
                App.objects.push(group);
            },

            update: (dt) => {
                if(!Game.body) return;

                // 1. Movement (Camera Relative)
                const speed = 25;
                const camAngle = App.controls.getAzimuthalAngle();
                
                const forward = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), camAngle);
                const right = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), camAngle);

                // Input Mapping (WASD + Joystick)
                const moveVec = new THREE.Vector3()
                    .addScaledVector(right, Game.input.x)
                    .addScaledVector(forward, -Game.input.y);

                if(moveVec.length() > 0.1) {
                    moveVec.normalize().multiplyScalar(speed);
                    Game.body.velocity.x = moveVec.x;
                    Game.body.velocity.z = moveVec.z;
                    
                    // Rotate Character
                    Game.player.rotation.y = Math.atan2(moveVec.x, moveVec.z);
                    
                    // Walking Animation (Sine wave)
                    const t = Date.now() * 0.015;
                    Game.limbs.la.rotation.x = Math.sin(t);
                    Game.limbs.ra.rotation.x = -Math.sin(t);
                    Game.limbs.ll.rotation.x = -Math.sin(t);
                    Game.limbs.rl.rotation.x = Math.sin(t);
                } else {
                    // Stop
                    Game.body.velocity.x *= 0.5;
                    Game.body.velocity.z *= 0.5;
                    // Reset Anim
                    Game.limbs.la.rotation.x = Game.limbs.ra.rotation.x = 0;
                    Game.limbs.ll.rotation.x = Game.limbs.rl.rotation.x = 0;
                }

                // 2. Jump
                if(Game.input.jump) {
                    // Simple ground check (velocity y near 0)
                    if(Math.abs(Game.body.velocity.y) < 0.5) {
                        Game.body.velocity.y = 15;
                    }
                    Game.input.jump = false; // Reset trigger
                }

                // 3. Camera Follow
                App.controls.target.copy(Game.player.position);
                App.controls.target.y += 2;
                
                // 4. Void Check
                if(Game.body.position.y < -50) {
                    Game.body.position.set(0, 10, 0);
                    Game.body.velocity.set(0,0,0);
                }
            },

            initInput: () => {
                // --- JOYSTICK LOGIC ---
                const area = document.getElementById('joystick-area');
                const stick = document.getElementById('stick');
                let dragging = false;
                let start = {x:0, y:0};

                area.addEventListener('pointerdown', e => {
                    dragging = true;
                    start = {x: e.clientX, y: e.clientY};
                    stick.style.transition = 'none';
                });

                window.addEventListener('pointermove', e => {
                    if(!dragging) return;
                    const maxDist = 35;
                    let dx = e.clientX - start.x;
                    let dy = e.clientY - start.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if(dist > maxDist) {
                        const angle = Math.atan2(dy, dx);
                        dx = Math.cos(angle) * maxDist;
                        dy = Math.sin(angle) * maxDist;
                    }

                    stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                    
                    // Normalize -1 to 1
                    Game.input.x = dx / maxDist;
                    Game.input.y = dy / maxDist;
                });

                window.addEventListener('pointerup', () => {
                    dragging = false;
                    stick.style.transition = '0.2s';
                    stick.style.transform = 'translate(-50%, -50%)';
                    Game.input.x = 0; Game.input.y = 0;
                });

                // --- JUMP BUTTON ---
                document.getElementById('jump-btn').addEventListener('pointerdown', () => Game.input.jump = true);

                // --- KEYBOARD ---
                document.addEventListener('keydown', e => {
                    if(e.key==='w') Game.input.y = -1;
                    if(e.key==='s') Game.input.y = 1;
                    if(e.key==='a') Game.input.x = -1;
                    if(e.key==='d') Game.input.x = 1;
                    if(e.code==='Space') Game.input.jump = true;
                });
                document.addEventListener('keyup', e => {
                    if(e.key==='w' || e.key==='s') Game.input.y = 0;
                    if(e.key==='a' || e.key==='d') Game.input.x = 0;
                });
            }
        };

        /* --- EDITOR & UI --- */
        const Editor = {
            mode: 'select',
            selection: null,

            setMode: (m) => {
                Editor.mode = m;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                if(m === 'select') App.transform.detach();
                else if(Editor.selection) {
                    App.transform.setMode(m);
                    App.transform.attach(Editor.selection);
                }
            },

            onPointerDown: (e) => {
                if(Game.active) return;
                const vp = document.getElementById('viewport');
                App.mouse.x = ((e.clientX - vp.getBoundingClientRect().left) / vp.clientWidth) * 2 - 1;
                App.mouse.y = -((e.clientY - vp.getBoundingClientRect().top) / vp.clientHeight) * 2 + 1;
                
                App.raycaster.setFromCamera(App.mouse, App.camera);
                const intersects = App.raycaster.intersectObjects(App.objects);

                if(intersects.length > 0) {
                    Editor.select(intersects[0].object);
                } else {
                    Editor.select(null);
                }
            },

            select: (obj) => {
                Editor.selection = obj;
                const p = document.getElementById('prop-content');
                
                if(obj) {
                    if(Editor.mode !== 'select') App.transform.attach(obj);
                    p.innerHTML = `
                        <div class="prop-row"><b>Name</b> <input class="prop-input" value="${obj.name}"></div>
                        <div class="prop-row"><b>Pos X</b> <input class="prop-input" value="${obj.position.x.toFixed(2)}"></div>
                        <div class="prop-row"><b>Pos Y</b> <input class="prop-input" value="${obj.position.y.toFixed(2)}"></div>
                        <div class="prop-row"><b>Color</b> <div style="width:20px;height:20px;background:#${obj.material.color.getHexString()}"></div></div>
                        <div class="prop-row"><b>Anchored</b> <input type="checkbox" ${obj.userData.anchored?'checked':''}></div>
                        <button onclick="Editor.delete()" style="width:100%; margin-top:10px; background:#D32F2F; color:white; border:none; padding:5px; border-radius:4px;">Delete</button>
                    `;
                } else {
                    App.transform.detach();
                    p.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">Se√ßim Yok</div>';
                }
            },
            
            delete: () => {
                if(Editor.selection) {
                    App.scene.remove(Editor.selection);
                    App.world.removeBody(Editor.selection.userData.body);
                    Editor.select(null);
                }
            },

            syncPhysics: () => {
                if(Editor.selection && Editor.selection.userData.body) {
                    const b = Editor.selection.userData.body;
                    b.position.copy(Editor.selection.position);
                    b.quaternion.copy(Editor.selection.quaternion);
                    b.velocity.set(0,0,0);
                    b.angularVelocity.set(0,0,0);
                }
            }
        };

        /* --- UI LOGIC --- */
        const UI = {
            setTab: (id) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.ribbon-group').forEach(g => g.classList.remove('active'));
                document.getElementById('tab-'+id).classList.add('active');
            },
            
            updateExplorer: () => {
                const list = document.getElementById('explorer-list');
                list.innerHTML = '<div style="padding:2px 5px;">üìÇ Workspace</div>';
                App.objects.forEach(obj => {
                    if(obj.name === "Baseplate" || obj.name === "SpawnLocation") return; // Hide basics
                    const el = document.createElement('div');
                    el.style.padding = "2px 15px";
                    el.style.cursor = "pointer";
                    el.innerText = "üü¶ " + obj.name;
                    el.onclick = () => Editor.select(obj);
                    list.appendChild(el);
                });
            }
        };

        /* --- LunAIX (AI) --- */
        const AI = {
            toggle: () => {
                const p = document.getElementById('ai-panel');
                p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
            },
            send: () => {
                const i = document.getElementById('ai-in');
                const txt = i.value.toLowerCase();
                if(!txt) return;
                
                // User Msg
                const c = document.getElementById('ai-content');
                c.innerHTML += `<div class="msg user">${i.value}</div>`;
                i.value = "";
                
                setTimeout(() => {
                    let resp = "Bunu hen√ºz anlayamadƒ±m.";
                    
                    if(txt.includes('ev')) {
                        // Build House
                        World.addPart('box', {scale:[10,1,10], pos:new THREE.Vector3(0,1,0), color:0x8B4513, anchored:true});
                        World.addPart('box', {scale:[1,8,10], pos:new THREE.Vector3(-4.5,5,0), color:0xEEE, anchored:true});
                        World.addPart('box', {scale:[1,8,10], pos:new THREE.Vector3(4.5,5,0), color:0xEEE, anchored:true});
                        World.addPart('box', {scale:[10,8,1], pos:new THREE.Vector3(0,5,-4.5), color:0xEEE, anchored:true});
                        World.addPart('wedge', {scale:[12,4,12], pos:new THREE.Vector3(0,10,0), color:0xD32F2F, anchored:true}); 
                        // Note: Wedge func not implemented fully, using box logic visual
                        resp = "Basit bir ev in≈üa edildi.";
                    }
                    else if(txt.includes('k√∂pr√º')) {
                        for(let j=0; j<10; j++) {
                             World.addPart('box', {scale:[6,1,3], pos:new THREE.Vector3(0, 5, j*4), color:0x555, anchored:true});
                        }
                        resp = "Havada bir k√∂pr√º yolu olu≈üturdum.";
                    }
                    else if(txt.includes('araba')) {
                        World.addPart('box', {scale:[4,2,8], pos:new THREE.Vector3(5,5,0), color:0x1E88E5, anchored:false, name:"CarBody"});
                        resp = "Basit bir fiziksel ara√ß g√∂vdesi eklendi.";
                    }

                    c.innerHTML += `<div class="msg bot">${resp}</div>`;
                    c.scrollTop = c.scrollHeight;
                }, 600);
            }
        };

    </script>
</body>
</html>
