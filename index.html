<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunX Studio V2.22 - GeliÅŸmiÅŸ Ayarlar ve 3D Ã–zelleÅŸtirme</title>
    <style>
        /* Ana Stil */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1e1e1e; color: #ddd; display: flex; flex-direction: column; height: 100vh; }
        .full-screen-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e1e1e; z-index: 5000; justify-content: center; align-items: center; }
        
        /* Auth ve Loading Stil */
        #loading-screen { display: flex; flex-direction: column; color: #007acc; font-size: 24px; }
        .auth-container, .settings-panel { background: #252526; padding: 40px; width: 400px; max-height: 80vh; overflow-y: auto; border-radius: 8px; border: 2px solid #007acc; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .auth-container input[type="text"], .auth-container input[type="email"], .auth-container input[type="password"], #template-select, .auth-container textarea, .settings-panel input, .settings-panel select { width: 90%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box;}
        .auth-container textarea { height: 80px; resize: vertical; font-size: 10px; }
        #auth-error { color: #ff4444; font-size: 13px; margin-top: 15px; padding: 8px; border: 1px solid #ff4444; background: #301010; display: none; }
        .switch-auth { color: #007acc; cursor: pointer; font-size: 14px; margin-top: 15px; display: inline-block; }
        .start-btn { background-color: #007acc; width: 90%; padding: 12px; border: none; color: white; cursor: pointer; border-radius: 4px; margin-top: 20px; }

        /* Ãœst AraÃ§ Ã‡ubuÄŸu */
        #toolbar { background-color: #252526; display: none; align-items: center; padding: 5px 10px; border-bottom: 1px solid #3e3e42; height: 40px; }
        .logo { font-size: 20px; font-weight: bold; color: #007acc; margin-right: 20px; letter-spacing: 1px; }
        .tool-group { display: flex; gap: 5px; margin-right: 20px; }
        .tool-btn { background-color: #3e3e42; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; transition: 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .tool-btn:hover { background-color: #505050; }
        .tool-btn.active { background-color: #007acc; }

        /* YENÄ°: AYARLAR EKRANI */
        #settings-screen { flex-direction: row; align-items: flex-start; padding-top: 50px; }
        .settings-menu { width: 250px; background: #333; padding: 20px; border-radius: 8px 0 0 8px; }
        .settings-menu h3 { color: #007acc; margin-top: 0; }
        .menu-item { padding: 10px; cursor: pointer; border-radius: 4px; transition: background 0.1s; margin-bottom: 5px; }
        .menu-item:hover, .menu-item.active { background: #007acc; color: white; }
        
        /* Ã–zelleÅŸtirme AlanÄ± */
        #customize-editor { 
            flex-grow: 1; 
            background: #1e1e1e; 
            padding: 20px; 
            border-radius: 0 8px 8px 0; 
            display: none; 
            flex-direction: row;
            height: 80vh; 
            max-width: 700px;
        }
        .customize-panel { width: 50%; padding: 10px; }
        #customize-viewport { height: 100%; flex-grow: 1; background: #000; border: 1px solid #007acc; }

        /* Custom UI */
        .custom-preview { width: 50px; height: 50px; border: 1px solid #555; background-size: cover; background-position: center; display: inline-block; margin-left: 10px; vertical-align: middle; }
        .file-upload-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;}
        .file-upload-container .upload-btn { flex-shrink: 0; margin-left: 10px; padding: 6px 10px; font-size: 12px; }
        .file-upload-container label { font-weight: bold; font-size: 12px; }
        .file-upload-container input[type="file"] { display: none; }
        .color-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .color-row input[type="color"] { width: 50px; height: 30px; border: none; padding: 0; }
        
        /* 3D GÃ¶rÃ¼nÃ¼m Stil */
        #main-area { flex-grow: 1; display: none; overflow: hidden; }
        #viewport { flex-grow: 1; position: relative; background-color: #000; }

    </style>
</head>
<body>

    <div id="loading-screen" class="full-screen-container" style="display: flex;">
        LUNX STUDIO <br> âš™ï¸ YÃ¼kleniyor...
    </div>

    <div id="auth-screen" class="full-screen-container">
        <div id="auth-container" class="auth-container">
            <h1 class="logo" style="font-size: 36px; margin-bottom: 20px;">LUNX STUDIO</h1>
            <h2 id="auth-title" style="color:#007acc; margin-bottom: 20px;"></h2>
            <div id="auth-error" style="display: none;"></div>
            
            <input type="text" id="auth-username-input" placeholder="KullanÄ±cÄ± AdÄ± (Sadece KayÄ±t Ä°Ã§in)" style="display: none;">
            <input type="email" id="auth-email-input" placeholder="E-posta Adresi">
            <input type="password" id="auth-password-input" placeholder="Åifre">

            <div id="initial-settings" style="display: none;">
                <label style="margin-right: 15px; color: #007acc; font-weight: bold;">BaÅŸlangÄ±Ã§ Cinsiyeti:</label><br>
                <input type="radio" id="gender-male" name="gender-auth" value="male" checked> Erkek
                <input type="radio" id="gender-female" name="gender-auth" value="female" style="margin-left: 15px;"> KÄ±z
            </div>

            <button id="auth-submit-btn" class="tool-btn" style="width: 95%; background-color:#007acc;" onclick="window.handleAuthSubmit()"></button>
            <a id="auth-switch-link" class="switch-auth" onclick="window.switchAuthMode()"></a>
        </div>
    </div>

    <div id="project-screen" class="full-screen-container">
        <div class="project-header">
            <div class="logo">LunX Studio</div>
            <div class="user-panel">
                 <span id="project-user-email"></span>
                <button class="tool-btn" onclick="window.logoutUser()">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </div>
        <div class="project-content">
            <div class="template-area">
                <h3 style="color:#007acc;">BAÅLANGIÃ‡ ÅABLONLARI</h3>
                <p style="font-size: 12px; color: #aaa;">HÄ±zlÄ±ca bir projeye baÅŸlamak iÃ§in ÅŸablon seÃ§in:</p>
                
                <select id="template-select">
                    <option value="empty">BoÅŸ Sahne</option>
                    <option value="default_template">Zemin ve Grid</option>
                    <option value="simple_cube">Basit KÃ¼p Ã–rneÄŸi</option>
                </select>
                <button class="start-btn" onclick="window.startStudio(true)" style="background-color: #007acc;">Yeni Proje BaÅŸlat</button>
            </div>
            <div class="my-projects-area">
                <h3 style="color:#2da042;">KAYITLI PROJELERÄ°NÄ°Z</h3>
                <p style="font-size: 12px; color: #aaa; margin-bottom: 20px;">Buluttan kayÄ±tlÄ± son projenizi yÃ¼kleyin.</p>
                <button class="tool-btn" style="background-color: #2da042;" onclick="window.loadScene()">KayÄ±tlÄ± Projeyi YÃ¼kle (Bulut)</button>
            </div>
        </div>
    </div>
    
    <div id="toolbar">
        <div class="logo">LunX</div>
        <div class="tool-group">
            <button id="play-button" class="tool-btn" onclick="window.toggleSimulationMode(true)" title="Oyunu BaÅŸlat">â–¶ï¸ Oynat</button>
            <button id="stop-button" class="tool-btn" onclick="window.toggleSimulationMode(false)" title="Oyunu Durdur">ğŸ›‘ Durdur</button>
        </div>
        <div class="tool-group" id="editor-tools">
            <button id="tool-select" class="tool-btn active" onclick="window.setTool('select')" title="SeÃ§ (S)">ğŸ–±ï¸</button>
            <button id="tool-translate" class="tool-btn" onclick="window.setTool('translate')" title="TaÅŸÄ± (W)">â†”ï¸</button>
            <button id="tool-rotate" class="tool-btn" onclick="window.setTool('rotate')" title="Ã‡evir (Q)">ğŸ”„</button>
            <button id="tool-scale" class="tool-btn" onclick="window.setTool('scale')" title="BoyutlandÄ±r (E)">â†•ï¸</button>
        </div>
        <div class="tool-group" id="editor-creation-tools">
            <button class="tool-btn" onclick="window.addShape('cube')" title="KÃ¼p Ekle">ğŸŸ¦</button>
            <button class="tool-btn" onclick="window.addShape('sphere')" title="KÃ¼re Ekle">ğŸ”µ</button>
            <button class="tool-btn" onclick="window.addShape('spawn')" title="Karakter DoÄŸma AlanÄ± Ekle">â• BaÅŸlangÄ±Ã§</button>
        </div>
        <div class="tool-group">
            <button class="tool-btn" onclick="window.saveScene()" title="Kaydet">ğŸ’¾ Kaydet</button>
            <button class="tool-btn" onclick="window.showProjectScreen(auth.currentUser)" title="YÃ¼kle / Yeni Proje">ğŸ“‚ Projeler</button>
        </div>
        <div id="user-info" style="margin-left: auto;">
            <span id="status">HazÄ±r.</span>
            <span id="user-email" style="color:#4caf50; margin-left: 15px;"></span>
        </div>
        
        <button id="settings-btn" class="tool-btn" style="margin-left: 15px;" onclick="window.showSettingsScreen('profile')">âš™ï¸ Ayarlar</button>
        <button id="toggle-sidebar" class="tool-btn" style="margin-left: 15px; display: none;" onclick="window.toggleSidebar()">ğŸ‘ï¸</button>

    </div>
    
    <div id="main-area" style="display: none; position: relative;">
        <div id="viewport">
             <div id="mobile-controls">
                <div id="joystick-area">
                    <div id="joystick-handle"></div>
                </div>
                <div id="jump-button">+</div>
            </div>
        </div>
        <div id="sidebar-right">
            
            <div class="panel-section">
                <h4>HÄ°YERARÅÄ° (NESNELER) ğŸ“¦</h4>
                <div id="hierarchy-panel" style="overflow-y: auto; height: 150px; border: 1px solid #3e3e42; padding: 5px;">
                    </div>
            </div>
            
            <div class="panel-section" id="property-panel">
                <h4>Ã–ZELLÄ°KLER</h4>
                <div id="object-info">SeÃ§ili deÄŸil.</div>
            </div>

            <div class="panel-section" id="script-panel" style="display:none;">
                <h4>LUNX SCRIPT (JS)</h4>
                <textarea id="code-editor" placeholder="// object.rotation.y += 0.01;"></textarea>
                <button class="run-btn tool-btn" onclick="window.saveScript()" style="background-color: #2da042; width: 100%;">âš¡ Kodu Ã‡alÄ±ÅŸtÄ±r</button>
            </div>
        </div>
    </div>
    
    <div id="settings-screen" class="full-screen-container">
        <button class="tool-btn" style="position: absolute; top: 20px; right: 20px; background-color: #c92c2c;" onclick="window.closeSettingsScreen()">âŒ Kapat</button>
        
        <div class="settings-menu">
            <h3>AYARLAR</h3>
            <div class="menu-item active" data-view="profile" onclick="window.showSettingsView('profile')">ğŸ‘¤ KullanÄ±cÄ± Profili</div>
            <div class="menu-item" data-view="customize" onclick="window.showSettingsView('customize')">ğŸ¨ Karakter Ã–zelleÅŸtirme</div>
            <div class="menu-item" data-view="security" onclick="window.showSettingsView('security')">ğŸ”’ GÃ¼venlik</div>
        </div>

        <div id="settings-content" style="flex-grow: 1; padding: 0 40px; max-width: 900px; max-height: 80vh; overflow-y: auto;">

            <div id="settings-view-profile" class="settings-panel" style="width: 100%; display: none; text-align: left;">
                <h2>KullanÄ±cÄ± Profili</h2>
                <div style="margin-bottom: 15px;">
                    <label>KullanÄ±cÄ± AdÄ±:</label>
                    <input type="text" id="setting-username" oninput="window.updateUserProfile('username', this.value)">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>E-posta (DeÄŸiÅŸtirilemez):</label>
                    <input type="email" id="setting-email" disabled>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Karakter Cinsiyeti:</label>
                    <select id="setting-gender" onchange="window.updateUserProfile('gender', this.value)">
                        <option value="male">Erkek (Mavi)</option>
                        <option value="female">KÄ±z (Pembe)</option>
                    </select>
                </div>
                 <p style="color: #4caf50;">DeÄŸiÅŸiklikler otomatik olarak kaydedildi.</p>
            </div>

            <div id="settings-view-customize" style="display: flex; gap: 20px; width: 100%; height: 600px;">
                
                <div class="customize-panel settings-panel" style="width: 300px; text-align: left; padding: 20px;">
                    <h2>Renk AyarlarÄ±</h2>

                    <div class="color-row">
                        <label>GÃ¶vde Rengi:</label>
                        <input type="color" id="setting-torso-color" onchange="window.updateCustomizationView('torsoColor', this.value)">
                    </div>
                    <div class="color-row">
                        <label>Ayak/Bacak Rengi:</label>
                        <input type="color" id="setting-leg-color" onchange="window.updateCustomizationView('legColor', this.value)">
                    </div>
                    <div class="color-row">
                        <label>BaÅŸ Rengi (Ten/Deri):</label>
                        <input type="color" id="setting-skin-color" onchange="window.updateCustomizationView('skinColor', this.value)">
                    </div>
                    <p style="color: #4caf50; font-size: 14px; margin-top: 20px;">Renkler ve dokular anÄ±nda kaydedilir.</p>
                </div>

                <div id="customize-viewport" style="width: 350px; height: 100%;">
                    </div>

                <div class="customize-panel settings-panel" style="width: 300px; text-align: left; padding: 20px;">
                     <h2>Doku YÃ¼kleme (Base64/URL)</h2>
                     <p style="font-size: 11px; color: #aaa; margin: 5px 0 15px 0;">
                        GÃ¶rsel yÃ¼kleyerek karakterinizi kiÅŸiselleÅŸtirin. (Max 1MB).
                    </p>
                    
                    <div class="file-upload-container">
                        <label>Kafa Resmi:</label> 
                        <div style="display: flex; align-items: center;">
                            <div id="head-preview" class="custom-preview">BoÅŸ</div>
                            <input type="file" id="head-image-file" accept="image/*" onchange="window.handleImageUpload(this, 'headTexture')">
                            <button type="button" class="tool-btn upload-btn" onclick="document.getElementById('head-image-file').click()">
                                ğŸ–¼ï¸ YÃ¼kle
                            </button>
                        </div>
                    </div>
                    <textarea id="head-texture-input" placeholder="Kafa Base64 veya URL..." onchange="window.updateCustomizationView('headTexture', this.value)"></textarea>
                    
                    <div class="file-upload-container" style="margin-top: 20px;">
                        <label>GÃ¶vde Resmi:</label> 
                         <div style="display: flex; align-items: center;">
                            <div id="torso-preview" class="custom-preview">BoÅŸ</div>
                            <input type="file" id="torso-image-file" accept="image/*" onchange="window.handleImageUpload(this, 'torsoTexture')">
                            <button type="button" class="tool-btn upload-btn" onclick="document.getElementById('torso-image-file').click()">
                                ğŸ‘• YÃ¼kle
                            </button>
                        </div>
                    </div>
                    <textarea id="torso-texture-input" placeholder="GÃ¶vde Base64 veya URL..." onchange="window.updateCustomizationView('torsoTexture', this.value)"></textarea>
                </div>
            </div>

            <div id="settings-view-security" class="settings-panel" style="width: 100%; display: none; text-align: left;">
                <h2>GÃ¼venlik AyarlarÄ±</h2>
                <p style="color:#aaa;">Åifrenizi deÄŸiÅŸtirmek iÃ§in aÅŸaÄŸÄ±daki alanÄ± kullanÄ±n.</p>
                 <div style="margin-bottom: 15px;">
                    <label>Yeni Åifre:</label>
                    <input type="password" id="setting-new-password" placeholder="Yeni ÅŸifre (en az 6 karakter)">
                </div>
                <button class="tool-btn" style="background-color: #c92c2c; width: 100%;" onclick="window.updatePassword()">Åifreyi GÃ¼ncelle</button>
                <p id="security-status" style="color: #ff4444; margin-top: 10px;"></p>
            </div>
        </div>
    </div>


    <div id="context-menu" style="display: none; position: fixed; background: #3e3e42; border: 1px solid #007acc; border-radius: 4px; z-index: 9000; padding: 5px;">
        <div class="context-item tool-btn" onclick="window.runSelectedScript()" style="margin-bottom: 5px;">Kodu Ã‡alÄ±ÅŸtÄ±r</div>
        <div class="context-item tool-btn" onclick="window.deleteSelectedObject()" style="margin-bottom: 5px;">Sil</div>
        <div class="context-item tool-btn" onclick="window.duplicateSelectedObject()">Ã‡oÄŸalt</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/CapsuleGeometry.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- 1. FIREBASE BAÅLATMA VE GLOBAL DEÄÄ°ÅKENLER ---
        
        const firebaseConfig = {
          apiKey: "AIzaSyD4Dh_WCxTSqMnJ8u0M4KqwHpejJrEoctk", 
          authDomain: "lunxstudio.firebaseapp.com",
          databaseURL: "https://lunxstudio-default-rtdb.firebaseio.com",
          projectId: "lunxstudio",
          storageBucket: "lunxstudio.firebasestorage.app",
          messagingSenderId: "810358489202",
          appId: "1:810358489202:web:301dbd444bf4608f2782eb",
          measurementId: "G-Y36QNCE71R"
        };
        
        let app, auth, db;
        let scene, camera, renderer, controls, transformControls;
        let objects = []; 
        let selectedObject = null;
        let isSimulationMode = false; 
        let player, playerVelocity, playerDirection; 
        let moveForward, moveBackward, moveLeft, moveRight; 
        let joystickActive = false; 
        let joystickX = 0, joystickY = 0; 
        let authStateChecked = false; 
        
        // KRÄ°TÄ°K: Karakter Ã–zelleÅŸtirme Verisi
        let currentCustomization = {
            username: "",
            gender: "male",
            headTexture: "",
            torsoTexture: "",
            torsoColor: "#007acc",
            legColor: "#007acc",
            skinColor: "#f0c0b0"
        };
        
        // 3D Ã–zelleÅŸtirme EkranÄ± iÃ§in ayrÄ± deÄŸiÅŸkenler
        let customScene, customCamera, customRenderer, customControls, customCharacter;


        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let authMode = 'register'; 
        const clock = new THREE.Clock(); 

        // --- 2. GÄ°RÄ°Å / KAYIT / EKRAN YÃ–NETÄ°MÄ° ---
        
        window.hideAllScreens = () => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('project-screen').style.display = 'none';
            document.getElementById('toolbar').style.display = 'none';
            document.getElementById('main-area').style.display = 'none';
            document.getElementById('auth-error').style.display = 'none'; 
            document.getElementById('sidebar-right').classList.remove('open');
            document.getElementById('settings-screen').style.display = 'none'; // Yeni
        }

        window.showError = (msg, elementId = 'auth-error') => { 
            const errDiv = document.getElementById(elementId);
            if (!errDiv) { console.error("Hata elementi bulunamadÄ±: " + elementId); return; }
            // KullanÄ±cÄ± dostu hata mesajlarÄ±
            if (msg.includes("auth/email-already-in-use")) msg = "Bu e-posta adresi zaten kayÄ±tlÄ±.";
            else if (msg.includes("auth/user-not-found")) msg = "KullanÄ±cÄ± bulunamadÄ±. E-posta adresi hatalÄ±.";
            else if (msg.includes("auth/wrong-password")) msg = "Åifre hatalÄ±.";
            else if (msg.includes("auth/invalid-email")) msg = "GeÃ§ersiz e-posta formatÄ±.";
            else if (msg.includes("auth/weak-password")) msg = "Åifre en az 6 karakter olmalÄ±dÄ±r.";

            errDiv.innerText = "Hata: " + msg; 
            errDiv.style.display = 'block';
            window.log("Auth HatasÄ±: " + msg);
        }

        window.showAuth = (mode) => {
            window.hideAllScreens();
            document.getElementById('auth-screen').style.display = 'flex';
            
            const authTitle = document.getElementById('auth-title');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const authSwitchLink = document.getElementById('auth-switch-link');
            const usernameInput = document.getElementById('auth-username-input'); 
            const initialSettings = document.getElementById('initial-settings'); 

            if (mode === 'register') {
                authMode = 'register';
                authTitle.innerText = "HESAP OLUÅTUR";
                authSubmitBtn.innerText = "KayÄ±t Ol";
                authSwitchLink.innerText = "Bir hesabÄ±n var mÄ±? (GiriÅŸ Yap)";
                
                usernameInput.style.display = 'block'; 
                initialSettings.style.display = 'block'; 

            } else { 
                authMode = 'login';
                authTitle.innerText = "GÄ°RÄ°Å YAP";
                authSubmitBtn.innerText = "GiriÅŸ Yap";
                authSwitchLink.innerText = "HesabÄ±n yok mu? (KayÄ±t Ol)";

                usernameInput.style.display = 'none'; 
                initialSettings.style.display = 'none'; 
            }
            authStateChecked = true; 
        }
        
        window.switchAuthMode = () => { window.showAuth(authMode === 'register' ? 'login' : 'register'); }

        // Dosya yÃ¼kleme ve Base64'e dÃ¶nÃ¼ÅŸtÃ¼rme fonksiyonu
        window.handleImageUpload = (fileInput, textureKey) => {
            const file = fileInput.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024) { 
                 window.showError("GÃ¶rsel boyutu 1MB'dan kÃ¼Ã§Ã¼k olmalÄ±dÄ±r.", 'security-status'); 
                 fileInput.value = ''; 
                 return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const base64String = event.target.result;
                // Base64 stringini input alanÄ±na aktar ve 3D/DB gÃ¼ncelle
                document.getElementById(`${textureKey.toLowerCase().replace('texture', 'texture')}-input`).value = base64String;
                window.updateCustomizationView(textureKey, base64String);
                window.log(`Karakter resmi (${textureKey}) Base64'e dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼.`);
            };
            
            reader.onerror = (error) => {
                 window.showError("Dosya okuma hatasÄ±: " + error, 'security-status');
            };

            reader.readAsDataURL(file); 
        }

        window.showProjectScreen = (user) => {
            const userEmail = user ? user.email : "Misafir";
            window.fetchAndUpdateUser(user).then(() => {
                window.hideAllScreens();
                document.getElementById('project-screen').style.display = 'flex';
                document.getElementById('user-email').innerText = userEmail;
                
                if (window.innerWidth <= 768) {
                    document.getElementById('toggle-sidebar').style.display = 'block';
                }
            });
        }
        
        window.fetchAndUpdateUser = async (user) => {
            if (!user) return;
            const snapshot = await db.ref('users/' + user.uid).once('value');
            const userData = snapshot.val() || { 
                username: user.email.split('@')[0], 
                gender: 'male', 
                torsoColor: "#007acc",
                legColor: "#007acc",
                skinColor: "#f0c0b0"
            };
            
            // Global Ã¶zelleÅŸtirme verisini gÃ¼ncelle
            currentCustomization = {
                username: userData.username || user.email.split('@')[0],
                gender: userData.gender || 'male',
                headTexture: userData.headTexture || "",
                torsoTexture: userData.torsoTexture || "",
                torsoColor: userData.torsoColor || "#007acc",
                legColor: userData.legColor || "#007acc",
                skinColor: userData.skinColor || "#f0c0b0"
            };
            
            // KullanÄ±cÄ± Paneli GÃ¼ncelleme
            const userPanel = document.getElementById('project-user-email');
            userPanel.innerHTML = `
                 <span style="background-color: ${currentCustomization.gender === 'male' ? '#007acc' : '#ff4aff'}; 
                              padding: 5px 10px; border-radius: 4px; font-weight: bold; margin-right: 10px;">
                    ${currentCustomization.username.charAt(0).toUpperCase()}
                 </span> 
                 ${currentCustomization.username} (${user.email})
            `;
        }

        window.logoutUser = async () => { 
            if (!auth) return;
            await auth.signOut(); 
        };
        
        window.handleAuthSubmit = async () => {
            if (!auth) { window.showError("Firebase BaÄŸlantÄ±sÄ± Yok."); return; }
            
            const email = document.getElementById('auth-email-input').value;
            const pass = document.getElementById('auth-password-input').value;
            document.getElementById('auth-error').style.display = 'none';

            if (!email || !pass) {
                window.showError("LÃ¼tfen e-posta ve ÅŸifreyi girin.");
                return;
            }

            if (authMode === 'register') {
                const username = document.getElementById('auth-username-input').value;
                const gender = document.querySelector('input[name="gender-auth"]:checked').value;

                if (!username) { window.showError("LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin."); return; }
                
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                    // BaÅŸlangÄ±Ã§ renklerini cinsiyete gÃ¶re ayarla
                    const defaultColor = gender === 'male' ? "#007acc" : "#ff4aff";

                    await db.ref('users/' + userCredential.user.uid).set({
                        email: email,
                        username: username,
                        gender: gender,
                        headTexture: "", 
                        torsoTexture: "",
                        torsoColor: defaultColor,
                        legColor: defaultColor,
                        skinColor: "#f0c0b0"
                    });
                    window.log("KayÄ±t baÅŸarÄ±lÄ±. Oturum aÃ§Ä±lÄ±yor...");
                } catch (error) { 
                    window.showError(error.message); 
                }
            } else {
                try {
                    await auth.signInWithEmailAndPassword(email, pass);
                    window.log("GiriÅŸ baÅŸarÄ±lÄ±. YÃ¶nlendiriliyor...");
                } catch (error) { 
                    window.showError(error.message); 
                }
            }
        };

        // --- 3. AYARLAR VE Ã–ZELLEÅTÄ°RME YÃ–NETÄ°MÄ° ---

        window.showSettingsScreen = (initialView) => {
            window.hideAllScreens();
            document.getElementById('settings-screen').style.display = 'flex';
            window.showSettingsView(initialView);
        }

        window.closeSettingsScreen = () => {
            const currentView = document.querySelector('.menu-item.active').dataset.view;
            if (currentView === 'customize' && customRenderer) {
                // Ã–zelleÅŸtirme ekranÄ± kapatÄ±lÄ±rken 3D motoru durdur
                customRenderer.dispose();
                document.getElementById('customize-viewport').innerHTML = '';
                customScene = null;
                customCamera = null;
                customControls = null;
            }
            window.showProjectScreen(auth.currentUser); 
        }

        window.showSettingsView = (viewId) => {
            // MenÃ¼ aktifliÄŸini gÃ¼ncelle
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewId) item.classList.add('active');
            });

            // Ä°Ã§erikleri gizle/gÃ¶ster
            document.querySelectorAll('#settings-content > div').forEach(div => {
                div.style.display = 'none';
            });
            const targetDiv = document.getElementById(`settings-view-${viewId}`);
            if (targetDiv) targetDiv.style.display = 'block';

            // Ã–zelleÅŸtirme 3D motorunu baÅŸlat/durdur
            if (viewId === 'customize') {
                document.getElementById('settings-view-customize').style.display = 'flex';
                window.initCustomization3D();
                window.loadCustomizationData();
            } else {
                 if (customRenderer) {
                    customRenderer.dispose();
                    document.getElementById('customize-viewport').innerHTML = '';
                    customScene = null; customCamera = null; customControls = null;
                }
            }
             if (viewId === 'profile') {
                document.getElementById('setting-username').value = currentCustomization.username;
                document.getElementById('setting-email').value = auth.currentUser.email;
                document.getElementById('setting-gender').value = currentCustomization.gender;
            }
        }
        
        window.loadCustomizationData = () => {
            // UI elementlerini, Base64 inputlarÄ± ve Ã¶nizlemeleri global veriye gÃ¶re doldur
            document.getElementById('head-texture-input').value = currentCustomization.headTexture;
            document.getElementById('torso-texture-input').value = currentCustomization.torsoTexture;

            document.getElementById('setting-torso-color').value = currentCustomization.torsoColor;
            document.getElementById('setting-leg-color').value = currentCustomization.legColor;
            document.getElementById('setting-skin-color').value = currentCustomization.skinColor;

            window.updatePreview('headTexture', currentCustomization.headTexture);
            window.updatePreview('torsoTexture', currentCustomization.torsoTexture);

            // 3D karakteri, yÃ¼klenen verilerle oluÅŸtur/gÃ¼ncelle
            window.updateCustomCharacter();
        }

        window.updatePreview = (textureKey, data) => {
            const part = textureKey.toLowerCase().replace('texture', '');
            const preview = document.getElementById(`${part}-preview`);
            
            if (data && (data.startsWith('data:image/') || data.startsWith('http'))) {
                 preview.style.backgroundImage = `url('${data}')`;
                 preview.innerText = "";
            } else {
                 preview.style.backgroundImage = 'none';
                 preview.innerText = "BoÅŸ";
            }
        }
        
        window.updateCustomizationView = async (key, value) => {
            const user = auth.currentUser;
            if (!user) return;
            
            currentCustomization[key] = value;
            
            // Base64/URL ise Ã¶nizlemeyi gÃ¼ncelle
            if (key.includes('Texture')) {
                window.updatePreview(key, value);
            }
            
            // 3D karakteri gÃ¼ncelle
            window.updateCustomCharacter();

            // Firebase'e kaydet
            try {
                const update = {};
                update[key] = value;
                await db.ref('users/' + user.uid).update(update);
                window.log(`${key} ayarÄ± kaydedildi.`);
            } catch (e) {
                window.log(`Hata: ${key} kaydedilemedi.`);
            }
        }

        window.updateUserProfile = async (key, value) => {
            const user = auth.currentUser;
            if (!user) return;
            
            currentCustomization[key] = value;
            
            // Cinsiyet deÄŸiÅŸince renkleri de cinsiyetin varsayÄ±lanÄ±na Ã§ek
            if (key === 'gender') {
                 const defaultColor = value === 'male' ? "#007acc" : "#ff4aff";
                 currentCustomization.torsoColor = defaultColor;
                 currentCustomization.legColor = defaultColor;
                 
                 // Renk inputlarÄ±nÄ± da gÃ¼ncelle
                 document.getElementById('setting-torso-color').value = defaultColor;
                 document.getElementById('setting-leg-color').value = defaultColor;
                 window.updateCustomizationView('torsoColor', defaultColor);
                 window.updateCustomizationView('legColor', defaultColor);
            }

            // Firebase'e kaydet
            try {
                const update = {};
                update[key] = value;
                await db.ref('users/' + user.uid).update(update);
                window.log(`KullanÄ±cÄ± profili (${key}) gÃ¼ncellendi.`);
                
                // EÄŸer Studio aÃ§Ä±ksa user panelini de gÃ¼ncelle
                window.fetchAndUpdateUser(user);
            } catch (e) {
                window.log(`Hata: Profil gÃ¼ncellenemedi.`);
            }
        }
        
        window.updatePassword = async () => {
             const newPassword = document.getElementById('setting-new-password').value;
             const statusEl = document.getElementById('security-status');
             statusEl.style.display = 'none';
             
             if (!newPassword || newPassword.length < 6) {
                 window.showError("Åifre en az 6 karakter olmalÄ±dÄ±r.", 'security-status');
                 return;
             }
             
             try {
                 await auth.currentUser.updatePassword(newPassword);
                 statusEl.innerText = "Åifre baÅŸarÄ±yla gÃ¼ncellendi!";
                 statusEl.style.color = '#4caf50';
                 statusEl.style.display = 'block';
                 document.getElementById('setting-new-password').value = '';
             } catch (e) {
                 window.showError(e.message, 'security-status');
             }
        }

        // --- 4. 3D KARAKTER Ã–ZELLEÅTÄ°RME GÃ–RÃœNÃœMÃœ ---

        window.initCustomization3D = () => {
            const viewport = document.getElementById('customize-viewport');
            
            // EÄŸer motor zaten Ã§alÄ±ÅŸÄ±yorsa durdur
            if (customRenderer) {
                customRenderer.dispose();
                viewport.innerHTML = '';
            }

            customScene = new THREE.Scene();
            customCamera = new THREE.PerspectiveCamera(75, viewport.clientWidth / viewport.clientHeight, 0.1, 100);
            customCamera.position.set(0, 2, 3);
            customScene.background = new THREE.Color(0x333333); // Koyu gri arka plan

            customRenderer = new THREE.WebGLRenderer({ antialias: true });
            customRenderer.setSize(viewport.clientWidth, viewport.clientHeight);
            viewport.appendChild(customRenderer.domElement);

            customControls = new THREE.OrbitControls(customCamera, customRenderer.domElement);
            customControls.enableDamping = true; // YumuÅŸak hareket
            customControls.dampingFactor = 0.05;
            customControls.maxDistance = 6;
            customControls.minDistance = 2;
            customControls.target.set(0, 1, 0); // Karakterin merkezine odaklan

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            customScene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(2, 5, 4);
            customScene.add(dirLight);

            // Zemin ekle (opsiyonel)
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(5, 5),
                new THREE.MeshStandardMaterial({ color: 0x222222 })
            );
            ground.rotation.x = -Math.PI / 2;
            customScene.add(ground);

            window.updateCustomCharacter();
            window.animateCustomization();
        }

        window.updateCustomCharacter = () => {
            if (!customScene) return;

            if (customCharacter) {
                customScene.remove(customCharacter);
                customCharacter = null;
            }
            
            // Doku materyallerini gÃ¼ncellemek iÃ§in
            const headMaterial = window.getTextureMaterial(currentCustomization.headTexture, currentCustomization.skinColor);
            const torsoMaterial = window.getTextureMaterial(currentCustomization.torsoTexture, currentCustomization.torsoColor);
            
            // Karakteri oluÅŸtur
            customCharacter = window.createBlockCharacter(
                currentCustomization.gender,
                headMaterial, 
                torsoMaterial, 
                new THREE.MeshBasicMaterial({ color: currentCustomization.skinColor }), // Kol
                new THREE.MeshBasicMaterial({ color: currentCustomization.legColor })  // Bacak
            );
            
            customScene.add(customCharacter);
        }

        window.animateCustomization = () => {
            if (!customRenderer) return; 

            requestAnimationFrame(window.animateCustomization);
            customControls.update(); 
            customRenderer.render(customScene, customCamera);
        }

        window.getTextureMaterial = (textureData, defaultColor) => {
            const color = defaultColor ? new THREE.Color(defaultColor) : new THREE.Color(0xaaaaaa);
            
            // EÄŸer Base64/URL var ise doku yÃ¼kle
            if (textureData && (textureData.startsWith('data:image/') || textureData.startsWith('http'))) {
                 try {
                    const loader = new THREE.TextureLoader();
                    const texture = loader.load(textureData);
                    texture.wrapS = THREE.RepeatWrapping;
                    texture.wrapT = THREE.RepeatWrapping;
                    texture.repeat.set(1, 1); 
                    return new THREE.MeshStandardMaterial({ map: texture });
                } catch (e) {
                    console.error("Doku yÃ¼klenirken hata:", e);
                    return new THREE.MeshStandardMaterial({ color: color }); 
                }
            }
            
            // Doku yoksa renk materyali dÃ¶ndÃ¼r
            return new THREE.MeshStandardMaterial({ color: color });
        }
        
        // Karakter OluÅŸturucu Fonksiyonu (Hem Oyuncu hem Ã–zelleÅŸtirme iÃ§in kullanÄ±ldÄ±)
        window.createBlockCharacter = (gender = 'male', headMat = null, torsoMat = null, armMat = null, legMat = null) => {
            const group = new THREE.Group();
            
            const defaultTorsoColor = (gender === 'male') ? 0x007acc : 0xff4aff;
            const defaultSkinColor = 0xf0c0b0; 
            
            // Materyal varsayÄ±lanlarÄ±nÄ± ata
            const finalHeadMat = headMat || window.getTextureMaterial(currentCustomization.headTexture, currentCustomization.skinColor);
            const finalTorsoMat = torsoMat || window.getTextureMaterial(currentCustomization.torsoTexture, currentCustomization.torsoColor);
            const finalArmMat = armMat || new THREE.MeshBasicMaterial({ color: currentCustomization.skinColor || defaultSkinColor });
            const finalLegMat = legMat || new THREE.MeshBasicMaterial({ color: currentCustomization.legColor || defaultTorsoColor });
            

            const limbWidth = 0.4;
            const limbHeight = 1.0;
            const headSize = 0.8;
            const torsoHeight = 1.0;

            // BaÅŸ
            const head = new THREE.Mesh(new THREE.BoxGeometry(headSize, headSize, headSize), finalHeadMat);
            head.position.y = 1.7; 
            head.name = "Head";
            group.add(head);

            // GÃ¶vde (Torso)
            const torso = new THREE.Mesh(new THREE.BoxGeometry(0.8, torsoHeight, 0.4), finalTorsoMat);
            torso.position.y = 1.0;
            torso.name = "Torso";
            group.add(torso);
            
            // Kollar
            const createArm = (side) => {
                const arm = new THREE.Mesh(new THREE.BoxGeometry(limbWidth, limbHeight, limbWidth), finalArmMat);
                arm.position.set(side * 0.6, 1.5, 0); 
                arm.geometry.translate(0, -limbHeight / 2, 0); 
                arm.name = side === 0.6 ? "RightArm" : "LeftArm";
                return arm;
            };
            group.add(createArm(0.6));
            group.add(createArm(-0.6));

            // Bacaklar
            const createLeg = (side) => {
                const leg = new THREE.Mesh(new THREE.BoxGeometry(limbWidth, limbHeight, limbWidth), finalLegMat);
                leg.position.set(side * 0.2, 0.5, 0); 
                leg.geometry.translate(0, -limbHeight / 2, 0); 
                leg.name = side === 0.2 ? "RightLeg" : "LeftLeg";
                return leg;
            };
            group.add(createLeg(0.2));
            group.add(createLeg(-0.2));
            
            group.userData.totalHeight = 2.0; 
            group.userData.limbHeight = limbHeight;
            return group;
        };
        
        // --- DiÄŸer Studio/SimÃ¼lasyon FonksiyonlarÄ± (Ã–nceki Koddan Gelenler) ---
        
        window.startStudio = (isNew = false) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.setTool = (mode) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.initFullScene = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.setupEnvironment = (env) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.addShape = (type, existingData = null) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.clearScene = (showConfirm = true) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.saveScene = async () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.loadScene = async () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.selectObjectByName = (name) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.selectObject = (obj) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.updateHierarchyList = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.showContextMenu = (x, y) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.runSelectedScript = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.deleteSelectedObject = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.duplicateSelectedObject = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.onKeyDown = (event) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.onKeyUp = (event) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.onMouseDown = (event) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.updateSelectedObjectProperty = (property, value) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.saveScript = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.applyScript = (object, codeText) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.updateUI = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.log = (msg) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.onWindowResize = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.toggleSidebar = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.initPlayerControls = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.toggleSimulationMode = async (enable) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.startSimulation = async () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.stopSimulation = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.updatePlayerMovement = (delta) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.initMobileControls = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.updateJoystickPosition = (clientX, clientY, centerX, centerY, maxRadius, handle) => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.resetJoystick = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        window.animate = () => { /* ... (Kodu aynÄ± kaldÄ±) ... */ }
        
        // --- 5. UYGULAMA BAÅLANGICI ---
        const initializeApp = () => {
            if (typeof firebase === 'undefined' || typeof THREE === 'undefined') {
                window.showError("KRÄ°TÄ°K HATA: KÃ¼tÃ¼phaneler yÃ¼klenemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
                window.hideAllScreens();
                document.getElementById('auth-screen').style.display = 'flex';
                return;
            }

            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = app.auth(); 
                db = app.database(); 
                window.log("Firebase baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±. KullanÄ±cÄ± durumu kontrol ediliyor...");

                auth.onAuthStateChanged((user) => {
                    if (user) {
                        window.log("Oturum AÃ§Ä±k: " + user.email);
                        window.showProjectScreen(user); 
                    } else {
                        window.log("Oturum KapalÄ±. GiriÅŸ ekranÄ± aÃ§Ä±lÄ±yor.");
                        window.showAuth('login');
                    }
                });

            } catch(e) {
                window.hideAllScreens();
                window.showAuth('login');
                window.showError("KRÄ°TÄ°K HATA: Firebase yapÄ±landÄ±rma hatasÄ±.");
                console.error("Firebase BAÅLATMA KRÄ°TÄ°K HATASI:", e);
            }
        };

        document.addEventListener('DOMContentLoaded', initializeApp);
        window.onWindowResize();

    </script>
</body>
</html>
