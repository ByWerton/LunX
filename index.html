<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V8.0 - R6 & Full Tools</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    
    <style>
        /* ======================================================= */
        /* ROBLOX STUDIO TEMASI */
        /* ======================================================= */
        :root {
            --bg-app: #e6e6e6;
            --bg-ribbon: #f3f3f3;
            --bg-panel: #ffffff;
            --border-color: #dcdcdc;
            --text-main: #333333;
            --accent-blue: #007aff; 
            --accent-hover: #cce5ff; 
            --selection-bg: #cce5ff;
            --toolbar-height: 120px;
            
            /* JOYSTICK AYARI */
            --joystick-bottom-offset: 10vh;
        }

        * { 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            user-select: none;
            -webkit-user-select: none;
        }
        
        body { 
            margin: 0; 
            background: var(--bg-app); 
            color: var(--text-main); 
            height: 100vh; 
            width: 100vw; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* START SCREEN */
        #start-screen { 
            display: flex; 
            flex-direction: row; 
            flex: 1; 
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-app);
            z-index: 1000;
        }
        #start-sidebar { 
            width: 250px; 
            background: #ffffff; 
            border-right: 1px solid var(--border-color); 
            padding: 20px; 
            flex-shrink: 0;
        }
        .start-btn-side { 
            width: 100%; 
            padding: 12px; 
            background: var(--accent-blue); 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.2s; 
            border-radius: 4px; 
            margin: 5px 0;
            font-size: 14px;
        }
        .template-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 20px; 
            padding: 40px; 
            width: 100%;
        }
        .template-card { 
            background: white;
            border: 1px solid #ccc; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: 0.2s; 
            overflow: hidden;
        }
        .template-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            border-color: var(--accent-blue); 
        }
        .template-img { 
            height: 100px; 
            background: #ddd; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #888; 
            font-size: 40px; 
        }
        .template-name { 
            padding: 10px; 
            font-weight: bold; 
            font-size: 13px; 
            text-align: center; 
        }

        /* STUDIO UI */
        #studio-interface { 
            display: none; 
            height: 100vh; 
            flex-direction: column; 
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 100;
        }

        /* RIBBON BAR (GELƒ∞≈ûMƒ∞≈û MEN√ú) */
        #ribbon-bar { 
            height: var(--toolbar-height); 
            background: var(--bg-ribbon); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            align-items: flex-start; 
            padding: 5px;
            overflow-x: auto; 
            overflow-y: hidden;
            white-space: nowrap; 
            flex-shrink: 0; 
        }
        
        .tool-section { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            border-right: 1px solid #ccc; 
            padding: 0 10px; 
            height: 100%;
            justify-content: space-between;
            padding-bottom: 5px;
        }
        .section-label { font-size: 11px; color: #666; margin-top: 2px; }
        
        .ribbon-tab-content { 
            display: flex; 
            gap: 4px; 
            align-items: center; 
            height: 100%;
        }

        .ribbon-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: transparent; border: 1px solid transparent; border-radius: 3px;
            padding: 4px; cursor: pointer; min-width: 45px; height: 70px; color: #333;
            transition: background 0.1s;
            flex-shrink: 0; 
        }
        .ribbon-btn:hover { background: var(--accent-hover); border-color: #a3d1ff; }
        .ribbon-btn.active { background: #cce5ff; border-color: var(--accent-blue); }
        .ribbon-icon { font-size: 24px; margin-bottom: 5px; }
        .ribbon-text { font-size: 10px; text-align: center; white-space: normal; line-height: 1.1; }

        /* LAYOUT */
        #main-layout { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            width: 100%; 
            flex-direction: row; 
            position: relative; 
        }
        
        /* PANELS */
        #toolbox-panel, #right-panel {
            position: absolute; 
            z-index: 100; 
            top: 0; 
            height: 100%;
            transition: none; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            background: var(--bg-panel); 
            display: flex; 
            flex-direction: column;
        }
        
        #toolbox-panel { width: 250px; left: 0; display: none; }
        #toolbox-panel.open { display: flex; }

        #right-panel { width: 300px; right: 0; position: relative; border-left: 1px solid var(--border-color); }
        
        /* VIEWPORT */
        #viewport-container { 
            flex: 1; 
            position: relative; 
            background: #99ccff; 
            min-height: 200px; 
            overflow: hidden; 
        }
        #viewport canvas { width: 100% !important; height: 100% !important; display: block; touch-action: none; }
        
        .panel-header { 
            padding: 8px 10px; 
            background: #f0f0f0; 
            border-bottom: 1px solid #ddd; 
            font-weight: bold; 
            font-size: 12px; 
            color: #555; 
            cursor: default; 
        }
        #explorer, #properties { flex: 1; overflow-y: auto; background: white; padding: 5px; font-size: 12px; }

        /* OYUN KONTROLLERƒ∞ */
        #game-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            pointer-events: none; 
            z-index: 200;
            display: none; /* Play modunda a√ßƒ±lƒ±r */
        }
        
        #joystick-area {
            position: absolute;
            left: 20px;
            bottom: 20px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(0,0,0,0.2);
            pointer-events: auto; 
            touch-action: none; 
        }
        #joystick-handle {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            top: 35px;
            left: 35px;
            transform: translate(0px, 0px);
            border: 2px solid rgba(255,255,255,0.8);
        }
        
        #jump-button {
            position: absolute;
            right: 40px; /* Saƒüdan bo≈üluk */
            bottom: 80px; /* Biraz yukarƒ±da */
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255,255,255,0.6);
            color: white;
            font-size: 30px;
            text-align: center;
            line-height: 75px;
            pointer-events: auto;
            cursor: pointer;
        }
        #jump-button:active { background: rgba(255, 255, 255, 0.5); }
        
        /* MEN√ú BUTONU */
        #menu-button {
            position: absolute; top: 5px; left: 5px; width: 30px; height: 30px;
            background: var(--accent-blue); color: white; font-size: 18px;
            text-align: center; line-height: 30px; border-radius: 4px; cursor: pointer; z-index: 200;
        }

        /* PROPERTIES STYLES */
        .prop-row { display: flex; padding: 2px 0; border-bottom: 1px solid #eee; align-items: center; }
        .prop-name { width: 40%; padding-left: 5px; color: #333; overflow: hidden; text-overflow: ellipsis; }
        .prop-value { width: 60%; padding-right: 5px; }
        .prop-value input, .prop-value select { width: 100%; border: 1px solid #ccc; padding: 2px; font-size: 11px; }

        .panel-hidden #right-panel { display: none; }
    </style>
</head>
<body id="body" onload="LunX.init()">

    <div id="start-screen">
        <div id="start-sidebar">
            <h2 style="color:var(--accent-blue); margin:0 0 20px 0;">LunX Studio</h2>
            <div style="font-size:13px; color:#555; margin-bottom:20px;">Ho≈ü Geldin, <br><span id="username-display" style="font-weight:bold; font-size:16px;">Geli≈ütirici</span></div>
            <button class="start-btn-side active" onclick="alert('Yeni proje ekranƒ±')">+ Yeni</button>
            <button class="start-btn-side" onclick="alert('Projelerim')">Projelerim</button>
            <button class="start-btn-side" onclick="alert('Ayarlar')">Ayarlar</button>
        </div>
        <div style="flex:1; overflow-y:auto; padding:20px;">
            <h3 style="color:#333;">Yeni Olu≈ütur</h3>
            <div class="template-grid">
                <div class="template-card" onclick="LunX.manager.startStudio('baseplate')">
                    <div class="template-img">‚¨ú</div><div class="template-name">Baseplate</div>
                </div>
                <div class="template-card" onclick="LunX.manager.startStudio('flat')">
                    <div class="template-img">üü©</div><div class="template-name">Flat Terrain</div>
                </div>
                <div class="template-card" onclick="LunX.manager.startStudio('village')">
                    <div class="template-img">üè°</div><div class="template-name">Village</div>
                </div>
                <div class="template-card" onclick="LunX.manager.startStudio('castle')">
                    <div class="template-img">üè∞</div><div class="template-name">Castle</div>
                </div>
            </div>
        </div>
    </div>

    <div id="studio-interface">
        
        <div id="menu-button" onclick="LunX.manager.exitStudio()">X</div>
        
        <div id="ribbon-bar">
            <div class="tool-section">
                <div class="ribbon-tab-content">
                    <div class="ribbon-btn active" id="tool-select" onclick="LunX.tools.setMode('select')">
                        <div class="ribbon-icon">üëÜ</div><div class="ribbon-text">Se√ß</div>
                    </div>
                    <div class="ribbon-btn" id="tool-translate" onclick="LunX.tools.setMode('translate')">
                        <div class="ribbon-icon">‚ÜîÔ∏è</div><div class="ribbon-text">Ta≈üƒ±</div>
                    </div>
                    <div class="ribbon-btn" id="tool-scale" onclick="LunX.tools.setMode('scale')">
                        <div class="ribbon-icon">‚§¢</div><div class="ribbon-text">Boyut</div>
                    </div>
                    <div class="ribbon-btn" id="tool-rotate" onclick="LunX.tools.setMode('rotate')">
                        <div class="ribbon-icon">üîÑ</div><div class="ribbon-text">D√∂nd√ºr</div>
                    </div>
                </div>
                <div class="section-label">Ara√ßlar</div>
            </div>

            <div class="tool-section">
                <div class="ribbon-tab-content">
                    <div class="ribbon-btn" onclick="LunX.tools.toggleAnchor()">
                        <div class="ribbon-icon">‚öì</div><div class="ribbon-text">Anchor</div>
                    </div>
                    <div class="ribbon-btn" onclick="alert('Collision (Dummy)')">
                        <div class="ribbon-icon">üí•</div><div class="ribbon-text">Collisions</div>
                    </div>
                    <div class="ribbon-btn" onclick="LunX.tools.group()">
                        <div class="ribbon-icon">üîó</div><div class="ribbon-text">Group</div>
                    </div>
                    <div class="ribbon-btn" onclick="LunX.tools.ungroup()">
                        <div class="ribbon-icon">‚ùå</div><div class="ribbon-text">Ungroup</div>
                    </div>
                </div>
                <div class="section-label">Edit√∂r</div>
            </div>
            
             <div class="tool-section">
                <div class="ribbon-tab-content">
                     <div class="ribbon-btn" onclick="LunX.world.addPart('box')">
                        <div class="ribbon-icon">üì¶</div><div class="ribbon-text">Part</div>
                    </div>
                    <div class="ribbon-btn" onclick="LunX.world.addPart('sphere')">
                        <div class="ribbon-icon">‚ö™</div><div class="ribbon-text">Sphere</div>
                    </div>
                    <div class="ribbon-btn" onclick="LunX.world.addPart('cylinder')">
                        <div class="ribbon-icon">üõ¢Ô∏è</div><div class="ribbon-text">Cylinder</div>
                    </div>
                    <div class="ribbon-btn" onclick="LunX.world.addPart('wedge')">
                        <div class="ribbon-icon">üìê</div><div class="ribbon-text">Wedge</div>
                    </div>
                </div>
                <div class="section-label">Par√ßa Ekle</div>
            </div>
            
            <div class="tool-section">
                <div class="ribbon-tab-content">
                     <div class="ribbon-btn" onclick="alert('Material Manager')">
                        <div class="ribbon-icon">üé®</div><div class="ribbon-text">Material</div>
                    </div>
                    <div class="ribbon-btn" onclick="alert('Color Picker')">
                        <div class="ribbon-icon">üñåÔ∏è</div><div class="ribbon-text">Color</div>
                    </div>
                </div>
                <div class="section-label">G√∂r√ºn√ºm</div>
            </div>
            
            <div class="tool-section">
                <div class="ribbon-tab-content">
                    <div class="ribbon-btn" onclick="LunX.tools.toggleToolbox()">
                        <div class="ribbon-icon">üß∞</div><div class="ribbon-text">Toolbox</div>
                    </div>
                    <div class="ribbon-btn" onclick="alert('View Selector')">
                        <div class="ribbon-icon">üëÅÔ∏è</div><div class="ribbon-text">View</div>
                    </div>
                </div>
                <div class="section-label">Aray√ºz</div>
            </div>

            <div class="tool-section">
                <div class="ribbon-tab-content">
                    <div class="ribbon-btn" id="play-button" onclick="LunX.game.play()">
                        <div class="ribbon-icon" style="color:green;">‚ñ∂Ô∏è</div><div class="ribbon-text">Oyna</div>
                    </div>
                    <div class="ribbon-btn" id="stop-button" onclick="LunX.game.stop()" style="display:none;">
                        <div class="ribbon-icon" style="color:red;">‚èπÔ∏è</div><div class="ribbon-text">Durdur</div>
                    </div>
                </div>
                <div class="section-label">Test</div>
            </div>
        </div>

        <div id="main-layout">
            
            <div id="toolbox-panel">
                <div class="panel-header">Toolbox</div>
                <div class="toolbox-search-bar">
                    <input type="text" id="toolbox-search-input" placeholder="Ara: Models, Meshes...">
                </div>
                <div id="toolbox-content" style="padding:10px; font-size:12px; color:#666;">
                    <div class="toolbox-item" onclick="LunX.world.addPart('box', 0xff0000, 'Neon')">üí° Neon Part</div>
                    <div class="toolbox-item" onclick="LunX.world.addPart('box', 0x8B4513, 'Wood')">üå≤ Wood Plank</div>
                    <div class="toolbox-item" onclick="LunX.world.addPart('sphere', 0xaaaaaa, 'Metal')">‚öôÔ∏è Metal Ball</div>
                </div>
            </div>

            <div id="viewport-container">
                <div id="viewport"></div>
            </div>

            <div id="right-panel">
                <div class="panel-header">Explorer</div>
                <div id="explorer"></div>
                <div class="panel-header">Properties</div>
                <div id="properties"></div>
            </div>
            
            <div id="game-controls">
                <div id="joystick-area" 
                     onmousedown="LunX.game.startJoystick(event)" 
                     ontouchstart="LunX.game.startJoystick(event)">
                    <div id="joystick-handle"></div>
                </div>
                <div id="jump-button" 
                     onmousedown="LunX.game.jump()" 
                     ontouchstart="LunX.game.jump()">‚¨Ü</div>
            </div>
        </div>
    </div>

    <script>
        /**
         * LUNX STUDIO V8.0 - FULL INTEGRATION
         * - R6 Character
         * - Working Camera (Follows player, manual rotation via OrbitControls)
         * - Right Panel hides on Play
         * - Full Toolbar
         * - Anchored by default
         */
         
        const LunX = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            objects: [], selected: null, isPlaying: false,
            
            // Fizik & Oyun
            player: null,
            playerSpeed: 10, 
            joystick: { active: false, x: 0, y: 0, maxDist: 40 },
            GRAVITY: 0.5,
            
            // Kamera Ayarlarƒ±
            defaultCamPos: {x:10, y:10, z:10},
            
            init: () => {
                document.getElementById('start-screen').style.display = 'flex';
                window.addEventListener('resize', LunX.editor.onResize);
                
                // Global Input Listeners for Joystick
                document.addEventListener('mousemove', LunX.game.updateJoystick);
                document.addEventListener('touchmove', LunX.game.updateJoystick, {passive: false});
                document.addEventListener('mouseup', LunX.game.stopJoystick);
                document.addEventListener('touchend', LunX.game.stopJoystick);
            },
            
            manager: {
                startStudio: (template) => {
                    document.getElementById('start-screen').style.display = 'none';
                    document.getElementById('studio-interface').style.display = 'flex';
                    LunX.editor.init3D();
                    LunX.world.loadTemplate(template);
                },
                exitStudio: () => {
                    if(confirm("St√ºdyodan √ßƒ±kmak istediƒüinize emin misiniz?")) {
                         LunX.game.stop();
                         location.reload(); // En temiz √ßƒ±kƒ±≈ü
                    }
                }
            },

            editor: {
                init3D: () => {
                    const container = document.getElementById('viewport');
                    LunX.scene = new THREE.Scene();
                    LunX.scene.background = new THREE.Color(0x99ccff); 
                    LunX.scene.fog = new THREE.Fog(0x99ccff, 30, 150);

                    LunX.camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 1000);
                    LunX.camera.position.set(10, 10, 10);
                    LunX.camera.lookAt(0,0,0);

                    LunX.renderer = new THREE.WebGLRenderer({ antialias: true });
                    LunX.renderer.setSize(container.clientWidth, container.clientHeight);
                    LunX.renderer.shadowMap.enabled = true;
                    container.appendChild(LunX.renderer.domElement);
                    
                    // I≈üƒ±klar
                    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                    LunX.scene.add(hemiLight);
                    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    dirLight.position.set(20, 50, 20);
                    dirLight.castShadow = true;
                    dirLight.shadow.mapSize.width = 2048;
                    dirLight.shadow.mapSize.height = 2048;
                    LunX.scene.add(dirLight);

                    // Kontroller
                    LunX.controls = new THREE.OrbitControls(LunX.camera, LunX.renderer.domElement);
                    LunX.controls.enableDamping = true;
                    LunX.controls.dampingFactor = 0.05;

                    LunX.transform = new THREE.TransformControls(LunX.camera, LunX.renderer.domElement);
                    LunX.transform.addEventListener('dragging-changed', (e) => LunX.controls.enabled = !e.value);
                    LunX.transform.addEventListener('change', () => LunX.ui.updateProperties()); 
                    LunX.scene.add(LunX.transform);
                    
                    // Raycaster (Se√ßim i√ßin)
                    container.addEventListener('mousedown', LunX.editor.onMouseDown);
                    container.addEventListener('touchstart', LunX.editor.onMouseDown, {passive: false});
                    
                    LunX.editor.animate();
                },
                
                animate: () => {
                    requestAnimationFrame(LunX.editor.animate);
                    
                    if (LunX.isPlaying) {
                        LunX.game.updatePhysics();
                        LunX.game.updateCamera(); // Kamera karakteri takip eder
                    }
                    
                    LunX.controls.update(); // Orbit kontrolleri her zaman aktif (Zoom/Rotate i√ßin)
                    LunX.renderer.render(LunX.scene, LunX.camera);
                },
                
                onResize: () => {
                    const c = document.getElementById('viewport-container');
                    if (LunX.camera && LunX.renderer) {
                        LunX.camera.aspect = c.clientWidth / c.clientHeight;
                        LunX.camera.updateProjectionMatrix();
                        LunX.renderer.setSize(c.clientWidth, c.clientHeight);
                    }
                },
                
                onMouseDown: (e) => {
                    if (LunX.isPlaying) return; // Oyun modunda se√ßim yapma
                    
                    // Mobilde touch, masa√ºst√ºnde mouse
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    const rect = LunX.renderer.domElement.getBoundingClientRect();
                    
                    const mouse = new THREE.Vector2(
                        ((clientX - rect.left) / rect.width) * 2 - 1,
                        -((clientY - rect.top) / rect.height) * 2 + 1
                    );
                    
                    const raycaster = new THREE.Raycaster();
                    raycaster.setFromCamera(mouse, LunX.camera);
                    
                    const intersects = raycaster.intersectObjects(LunX.objects, false);
                    if (intersects.length > 0) {
                         LunX.editor.select(intersects[0].object);
                    } else {
                         LunX.editor.select(null);
                    }
                },
                
                select: (obj) => {
                    LunX.selected = obj;
                    if (obj && obj.userData.locked !== true) {
                        LunX.transform.attach(obj);
                    } else {
                        LunX.transform.detach();
                    }
                    LunX.ui.updateProperties();
                }
            },
            
            world: {
                loadTemplate: (template) => {
                    LunX.scene.background = new THREE.Color(0x99ccff); 
                    
                    // Baseplate
                    const size = template === 'flat' ? 200 : 100;
                    const color = template === 'flat' ? 0x4CAF50 : 0x666666;
                    const matName = template === 'flat' ? 'Grass' : 'Plastic';
                    
                    const base = LunX.world.addPart('box', color, matName, {x: size, y: 1, z: size}, {x:0, y:-0.5, z:0});
                    base.name = "Baseplate";
                    base.userData.locked = true;
                    base.userData.anchored = true;

                    // Spawn
                    const spawn = LunX.world.addPart('box', 0x888888, 'Plastic', {x:6, y:0.5, z:6}, {x:0, y:0.25, z:0});
                    spawn.name = "SpawnLocation";
                    spawn.userData.anchored = true;
                    // √úzerine logo eklenebilir (basitlik i√ßin gri)
                    
                    if(template === 'village') {
                         // Basit ev
                         const wall = LunX.world.addPart('box', 0xE8C39E, 'Wood', {x:10, y:10, z:1}, {x:0, y:5, z:-10});
                         wall.userData.anchored = true;
                    }

                    LunX.ui.refreshExplorer();
                },
                
                addPart: (type, color=0xcccccc, mat='Plastic', size={x:4,y:4,z:4}, pos={x:0,y:5,z:0}) => {
                    let geo;
                    if (type === 'sphere') geo = new THREE.SphereGeometry(size.x/2, 32, 32);
                    else if (type === 'cylinder') geo = new THREE.CylinderGeometry(size.x/2, size.x/2, size.y, 32);
                    else if (type === 'wedge') geo = new THREE.ConeGeometry(size.x/2, size.y, 4); // Basit wedge
                    else geo = new THREE.BoxGeometry(size.x, size.y, size.z);
                    
                    const material = LunX.ui.createMaterial(mat, color);
                    const mesh = new THREE.Mesh(geo, material);
                    
                    mesh.position.set(pos.x, pos.y, pos.z);
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.name = "Part";
                    
                    // VARSAYILAN OLARAK ANCHORED: TRUE
                    mesh.userData = { 
                        anchored: true, // ƒ∞STEK: Varsayƒ±lan true
                        canCollide: true, 
                        material: mat,
                        color: color,
                        velocity: new THREE.Vector3(0,0,0)
                    };
                    
                    LunX.scene.add(mesh);
                    LunX.objects.push(mesh);
                    LunX.editor.select(mesh);
                    LunX.ui.refreshExplorer();
                    return mesh;
                }
            },
            
            tools: {
                setMode: (mode) => {
                    if(mode === 'select') LunX.transform.detach();
                    else {
                        LunX.transform.setMode(mode);
                        if(LunX.selected) LunX.transform.attach(LunX.selected);
                    }
                    // UI g√ºncellemesi eklenebilir
                },
                
                toggleAnchor: () => {
                    if(LunX.selected) {
                        LunX.selected.userData.anchored = !LunX.selected.userData.anchored;
                        LunX.ui.updateProperties(); // Checkbox'ƒ± g√ºncelle
                    }
                },
                
                toggleToolbox: () => {
                    document.getElementById('toolbox-panel').classList.toggle('open');
                    LunX.editor.onResize();
                },
                
                group: () => alert("Grup √∂zelliƒüi bu versiyonda basitle≈ütirilmi≈ütir."),
                ungroup: () => alert("Ungroup √∂zelliƒüi bu versiyonda basitle≈ütirilmi≈ütir."),
                undo: () => {},
                redo: () => {}
            },
            
            game: {
                play: () => {
                    if (LunX.isPlaying) return;
                    LunX.isPlaying = true;
                    
                    // 1. UI Deƒüi≈üiklikleri
                    document.getElementById('play-button').style.display = 'none';
                    document.getElementById('stop-button').style.display = 'flex';
                    document.getElementById('game-controls').style.display = 'block';
                    document.getElementById('right-panel').style.display = 'none'; // ƒ∞STEK: Saƒü panel gizlensin
                    
                    LunX.transform.detach(); // Gizmo'yu kapat
                    
                    // 2. R6 Karakter Olu≈ütur
                    LunX.game.spawnCharacter();
                    
                    // 3. Kamera Ayarlarƒ± (Follow Mode)
                    LunX.controls.enabled = true; // Kullanƒ±cƒ± d√∂nd√ºrebilsin
                    LunX.controls.enablePan = false; // Saƒüa sola kaymasƒ±n, sadece d√∂ns√ºn
                    LunX.controls.minDistance = 5; // Zoom sƒ±nƒ±rlarƒ±
                    LunX.controls.maxDistance = 30;
                    
                    // Kamerayƒ± karaktere odakla
                    LunX.game.updateCamera();
                },
                
                stop: () => {
                    if (!LunX.isPlaying) return;
                    LunX.isPlaying = false;
                    
                    // 1. UI Geri Al
                    document.getElementById('play-button').style.display = 'flex';
                    document.getElementById('stop-button').style.display = 'none';
                    document.getElementById('game-controls').style.display = 'none';
                    document.getElementById('right-panel').style.display = 'flex'; // ƒ∞STEK: Saƒü panel geri gelsin
                    
                    // 2. Karakteri Sil
                    if(LunX.player) {
                        LunX.scene.remove(LunX.player);
                        LunX.player = null;
                    }
                    
                    // 3. Kamerayƒ± Resetle
                    LunX.camera.position.set(10, 10, 10);
                    LunX.controls.target.set(0, 0, 0);
                    LunX.controls.enablePan = true;
                    LunX.editor.select(null);
                },
                
                spawnCharacter: () => {
                    // R6 DUMMY YAPISI
                    const group = new THREE.Group();
                    
                    // Materyaller
                    const skinMat = new THREE.MeshPhongMaterial({color: 0xffcc00}); // Sarƒ± ten
                    const torsoMat = new THREE.MeshPhongMaterial({color: 0x0000ff}); // Mavi g√∂vde
                    const legMat = new THREE.MeshPhongMaterial({color: 0x00ff00});   // Ye≈üil bacak
                    
                    // Par√ßalar
                    const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), skinMat);
                    head.position.y = 4.6;
                    
                    const torso = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), torsoMat);
                    torso.position.y = 3;
                    
                    const leftArm = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), skinMat);
                    leftArm.position.set(-1.5, 3, 0);
                    
                    const rightArm = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), skinMat);
                    rightArm.position.set(1.5, 3, 0);
                    
                    const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), legMat);
                    leftLeg.position.set(-0.5, 1, 0);
                    
                    const rightLeg = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), legMat);
                    rightLeg.position.set(0.5, 1, 0);
                    
                    group.add(head, torso, leftArm, rightArm, leftLeg, rightLeg);
                    
                    // Spawn noktasƒ±na ta≈üƒ±
                    const spawn = LunX.objects.find(o => o.name === "SpawnLocation");
                    if(spawn) {
                        group.position.copy(spawn.position);
                        group.position.y += 2; // Biraz yukarƒ±
                    } else {
                        group.position.set(0, 5, 0);
                    }
                    
                    group.userData = { velocity: new THREE.Vector3(0,0,0), onGround: false };
                    
                    LunX.player = group;
                    LunX.scene.add(group);
                },
                
                startJoystick: (e) => { 
                    LunX.joystick.active = true; 
                    LunX.game.updateJoystick(e);
                },
                stopJoystick: () => { 
                    LunX.joystick.active = false; 
                    LunX.joystick.x = 0; 
                    LunX.joystick.y = 0;
                    const stick = document.getElementById('joystick-handle');
                    if(stick) stick.style.transform = `translate(0px, 0px)`;
                },
                updateJoystick: (e) => {
                    if (!LunX.joystick.active) return;
                    e.preventDefault();
                    
                    const area = document.getElementById('joystick-area');
                    const rect = area.getBoundingClientRect();
                    const centerX = rect.left + rect.width/2;
                    const centerY = rect.top + rect.height/2;
                    
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    let x = clientX - centerX;
                    let y = centerY - clientY; // Y ekseni yukarƒ± pozitif olsun diye ters
                    
                    const dist = Math.sqrt(x*x + y*y);
                    const maxDist = 35;
                    
                    if(dist > maxDist) {
                        const angle = Math.atan2(y, x);
                        x = Math.cos(angle) * maxDist;
                        y = Math.sin(angle) * maxDist;
                    }
                    
                    document.getElementById('joystick-handle').style.transform = `translate(${x}px, ${-y}px)`;
                    
                    // Normalize values (-1 to 1)
                    LunX.joystick.x = x / maxDist;
                    LunX.joystick.y = y / maxDist;
                },
                
                jump: () => {
                    if(LunX.player && LunX.player.userData.onGround) {
                        LunX.player.userData.velocity.y = 0.8; // Zƒ±plama g√ºc√º
                        LunX.player.userData.onGround = false;
                    }
                },
                
                updatePhysics: () => {
                    // 1. Player Physics
                    if (LunX.player) {
                        const p = LunX.player;
                        const v = p.userData.velocity;
                        
                        // Gravity
                        v.y -= 0.03; 
                        p.position.y += v.y;
                        
                        // Simple Floor Collision
                        if (p.position.y < 0) { // 0 seviyesinin altƒ± zemin kabul edelim
                            p.position.y = 0;
                            v.y = 0;
                            p.userData.onGround = true;
                        }
                        
                        // Movement Logic (Camera relative)
                        if (LunX.joystick.x !== 0 || LunX.joystick.y !== 0) {
                            // Kameranƒ±n baktƒ±ƒüƒ± y√∂n√ºn Y a√ßƒ±sƒ±nƒ± al
                            const camAngle = LunX.controls.getAzimuthalAngle(); 
                            
                            // Joystick girdisini 3D harekete √ßevir
                            // ƒ∞leri (y) -> -Z, Saƒü (x) -> +X
                            const forward = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0,1,0), camAngle);
                            const right = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0,1,0), camAngle);
                            
                            const moveDir = new THREE.Vector3()
                                .addScaledVector(forward, LunX.joystick.y)
                                .addScaledVector(right, LunX.joystick.x)
                                .normalize();
                                
                            p.position.addScaledVector(moveDir, 0.2); // Hƒ±z
                            
                            // Karakteri hareket y√∂n√ºne d√∂nd√ºr
                            const targetRot = Math.atan2(moveDir.x, moveDir.z);
                            p.rotation.y = targetRot;
                        }
                    }
                    
                    // 2. Object Physics (Falling Parts)
                    LunX.objects.forEach(obj => {
                        if (!obj.userData.anchored) {
                            // Basit yer√ßekimi
                            obj.position.y -= 0.1;
                            if(obj.position.y < (obj.geometry.parameters.height/2 || 1)) {
                                obj.position.y = (obj.geometry.parameters.height/2 || 1);
                            }
                        }
                    });
                },
                
                updateCamera: () => {
                    // Kamera sadece hedefi (oyuncuyu) takip eder
                    // D√∂n√º≈ü OrbitControls tarafƒ±ndan manuel yapƒ±lƒ±r
                    if(LunX.player) {
                        LunX.controls.target.copy(LunX.player.position);
                        LunX.controls.target.y += 3; // Karaktere biraz yukarƒ±dan bak
                    }
                }
            },
            
            ui: {
                refreshExplorer: () => {
                    const list = document.getElementById('explorer');
                    list.innerHTML = "";
                    LunX.objects.forEach(obj => {
                        const item = document.createElement('div');
                        item.style.padding = "2px 5px";
                        item.style.cursor = "pointer";
                        item.innerText = "üì¶ " + obj.name;
                        if(obj === LunX.selected) item.style.background = "#cce5ff";
                        item.onclick = () => LunX.editor.select(obj);
                        list.appendChild(item);
                    });
                },
                
                updateProperties: () => {
                    const props = document.getElementById('properties');
                    props.innerHTML = "";
                    if(!LunX.selected) return;
                    
                    const obj = LunX.selected;
                    
                    // ƒ∞sim
                    props.innerHTML += `<div class="prop-row"><div class="prop-name">Name</div><div class="prop-value"><input value="${obj.name}" onchange="LunX.selected.name=this.value; LunX.ui.refreshExplorer()"></div></div>`;
                    
                    // Anchored
                    if(obj.userData.hasOwnProperty('anchored')) {
                         props.innerHTML += `<div class="prop-row"><div class="prop-name">Anchored</div><div class="prop-value"><input type="checkbox" ${obj.userData.anchored ? 'checked' : ''} onchange="LunX.selected.userData.anchored=this.checked"></div></div>`;
                    }
                    
                    // Material
                    if(obj.material) {
                        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#888888', '#ffffff'];
                        // Basit renk se√ßici
                        let colorOpts = colors.map(c => `<div style="width:15px;height:15px;background:${c};display:inline-block;margin:1px;cursor:pointer;border:1px solid #333" onclick="LunX.ui.setColor('${c}')"></div>`).join('');
                        props.innerHTML += `<div class="prop-row"><div class="prop-name">Color</div><div class="prop-value">${colorOpts}</div></div>`;
                    }
                },
                
                setColor: (color) => {
                    if(LunX.selected && LunX.selected.material) {
                        LunX.selected.material.color.set(color);
                        LunX.selected.userData.color = parseInt(color.replace('#','0x'));
                    }
                },
                
                createMaterial: (type, color) => {
                    // Basit materyal yaratƒ±cƒ±
                    return new THREE.MeshStandardMaterial({color: color});
                }
            }
        };

        window.onload = LunX.init;

    </script>
</body>
</html>
