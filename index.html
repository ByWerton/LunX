<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V11.0 - Full AI & Physics Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

    <style>
        :root {
            --bg-app: #eef0f3;
            --bg-ribbon: #ffffff;
            --bg-panel: #ffffff;
            --border: #d1d1d1;
            --text-main: #333;
            --accent: #ff3333; /* Kƒ±rmƒ±zƒ± Tema */
            --accent-hover: #fff0f0;
            --toolbar-height: 100px;
            --panel-width: 280px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-app); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; }

        /* --- √úST MEN√ú --- */
        #top-bar { height: 30px; background: #cc0000; color: white; display: flex; align-items: center; padding: 0 10px; font-size: 12px; }
        #tab-container { display: flex; height: 100%; }
        .tab-btn { padding: 0 15px; height: 100%; display: flex; align-items: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); transition: 0.2s; }
        .tab-btn:hover { background: rgba(255,255,255,0.2); }
        .tab-btn.active { background: var(--bg-ribbon); color: #333; font-weight: bold; border-top: 3px solid transparent; }

        /* RIBBON ARA√áLARI */
        #ribbon {
            height: var(--toolbar-height); background: var(--bg-ribbon); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 5px 10px; overflow-x: auto; gap: 10px;
        }
        .tool-section { display: none; gap: 5px; height: 100%; align-items: center; }
        .tool-section.active { display: flex; }
        
        .ribbon-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 55px; height: 80px; border: 1px solid transparent; border-radius: 4px;
            cursor: pointer; transition: 0.2s; color: #444;
        }
        .ribbon-btn:hover { background: var(--accent-hover); border-color: #ffcccc; }
        .ribbon-btn.active { background: #ffe6e6; border-color: var(--accent); }
        .ribbon-btn span { font-size: 22px; margin-bottom: 5px; }
        .ribbon-btn label { font-size: 11px; text-align: center; }

        /* --- ANA D√úZEN --- */
        #main-layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* TOOLBOX (SOL) */
        #toolbox {
            width: 220px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; position: relative; z-index: 10; transition: transform 0.3s;
        }
        #toolbox.closed { transform: translateX(-100%); position: absolute; height: 100%; }

        /* SAƒû PANEL */
        #right-panel {
            width: var(--panel-width); background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 10; transition: width 0.2s;
        }
        #right-panel.closed { transform: translateX(100%); position: absolute; right: 0; height: 100%; }
        
        .panel-head { padding: 8px; background: #f5f5f5; font-weight: bold; font-size: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        #toolbox-content { flex: 1; overflow-y: auto; padding: 5px; }
        .split-v { flex: 1; overflow-y: auto; display: flex; flex-direction: column; min-height: 100px; }
        #prop-content { padding: 5px; }
        .prop-row { display: flex; margin-bottom: 4px; align-items: center; font-size: 11px; }
        .prop-label { width: 40%; color: #666; }
        .prop-input { width: 60%; border: 1px solid #ccc; padding: 2px; }

        /* OYUN KONTROLLERƒ∞ */
        #game-hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 100; }
        #joystick-zone { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joystick-knob { width: 50px; height: 50px; background: white; border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #jump-btn { position: absolute; bottom: 80px; right: 40px; width: 80px; height: 80px; background: rgba(255,50,50,0.8); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        #interact-btn { position: absolute; bottom: 180px; right: 40px; width: 60px; height: 60px; background: #ffff00; border-radius: 50%; pointer-events: auto; display: none; align-items: center; justify-content: center; font-size: 24px; border: 3px solid #000; cursor: pointer; }
        
        /* AI SOHBET ARAY√úZ√ú (YENƒ∞) */
        #ai-chat-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            z-index: 3000; display: none; align-items: center; justify-content: center;
        }
        #ai-chat-panel {
            width: 90%; max-width: 500px; height: 80%; background: var(--bg-panel);
            border-radius: 10px; display: flex; flex-direction: column; padding: 15px;
        }
        #ai-chat-log { 
            flex: 1; overflow-y: auto; border: 1px solid var(--border); padding: 10px; 
            margin-bottom: 10px; border-radius: 5px; background: #f9f9f9; 
        }
        .ai-msg { margin-bottom: 5px; font-size: 13px; }
        .ai-msg.user { text-align: right; color: var(--accent); }
        .ai-msg.bot { text-align: left; font-weight: bold; color: #333; }
        #ai-input-container { display: flex; }
        #ai-prompt-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; }
        #ai-send-btn { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 0 5px 5px 0; cursor: pointer; }
        #ai-exit-btn { margin-top: 10px; background: #eee; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body onload="LunX.init()">

    <div id="top-bar">
        <div style="font-weight:bold; margin-right:20px;">LunX Studio</div>
        <div id="tab-container">
            <div class="tab-btn active" onclick="UI.setTab('home')">Home</div>
            <div class="tab-btn" onclick="UI.setTab('model')">Model</div>
            <div class="tab-btn" onclick="UI.setTab('terrain')">Terrain</div>
            <div class="tab-btn" onclick="UI.setTab('view')">View</div>
            <div class="tab-btn" onclick="UI.setTab('ai')">‚ú® AI</div>
        </div>
    </div>

    <div id="ribbon">
        <div id="sec-home" class="tool-section active">
            <div class="ribbon-btn" id="tool-select" onclick="Tools.setMode('select')"><span>üëÜ</span><label>Se√ß</label></div>
            <div class="ribbon-btn" id="tool-translate" onclick="Tools.setMode('translate')"><span>‚ÜîÔ∏è</span><label>Ta≈üƒ±</label></div>
            <div class="ribbon-btn" id="tool-scale" onclick="Tools.setMode('scale')"><span>‚§¢</span><label>Boyut</label></div>
            <div class="ribbon-btn" id="tool-rotate" onclick="Tools.setMode('rotate')"><span>üîÑ</span><label>D√∂nd√ºr</label></div>
            <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
            <div class="ribbon-btn" onclick="Game.play()"><span style="color:green">‚ñ∂Ô∏è</span><label>Oyna</label></div>
            <div class="ribbon-btn" onclick="Game.stop()"><span style="color:red">‚èπÔ∏è</span><label>Durdur</label></div>
        </div>
        
        <div id="sec-model" class="tool-section">
            <div class="ribbon-btn" onclick="World.add('box')"><span>üì¶</span><label>Part</label></div>
            <div class="ribbon-btn" onclick="World.add('sphere')"><span>‚ö™</span><label>Sphere</label></div>
            <div class="ribbon-btn" onclick="World.add('cylinder')"><span>üõ¢Ô∏è</span><label>Cyl</label></div>
            <div class="ribbon-btn" onclick="World.add('wedge')"><span>üìê</span><label>Wedge</label></div>
            <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
            <div class="ribbon-btn" onclick="World.importOBJ()"><span>üìÇ</span><label>OBJ Y√ºkle</label></div>
            <div class="ribbon-btn" onclick="World.add('spawn')"><span>üö©</span><label>Spawn</label></div>
            <div class="ribbon-btn" onclick="World.add('light')"><span>üí°</span><label>I≈üƒ±k</label></div>
            <div class="ribbon-btn" onclick="World.add('neon')"><span>‚ú®</span><label>Neon</label></div>
            <div class="ribbon-btn" onclick="World.add('damage')"><span>üíÄ</span><label>Hasar</label></div>
        </div>
        
        <div id="sec-terrain" class="tool-section">
            <div class="ribbon-btn" onclick="alert('Sculpt Modu Aktif (Vertex)')"><span>‚õ∞Ô∏è</span><label>Sculpt</label></div>
            <div class="ribbon-btn" onclick="World.setSky('day')"><span>‚òÄÔ∏è</span><label>G√ºnd√ºz</label></div>
            <div class="ribbon-btn" onclick="World.setSky('night')"><span>üåô</span><label>Gece</label></div>
        </div>

        <div id="sec-view" class="tool-section">
            <div class="ribbon-btn" onclick="UI.toggle('toolbox')"><span>üß∞</span><label>Toolbox</label></div>
            <div class="ribbon-btn" onclick="UI.toggle('properties')"><span>üìù</span><label>Props</label></div>
        </div>

        <div id="sec-ai" class="tool-section">
            <div class="ribbon-btn" style="width:100px; border:2px solid gold; background:#fffbe6;" onclick="AI.openChat()">
                <span>ü§ñ</span><label>AI Build Chat</label>
            </div>
        </div>
    </div>

    <div id="x-menu-btn" onclick="UI.openXMenu()">‚öôÔ∏è</div>

    <div id="x-overlay" onclick="if(event.target==this) UI.closeXMenu()">
        <div id="x-panel">
            <h2 style="margin:0 0 20px 0; color:#333;">Ayarlar & Men√º</h2>
            <button class="x-btn" onclick="App.reset()">üîÅ Sahneyi Sƒ±fƒ±rla</button>
            <button class="x-btn" onclick="alert('Kaydedildi!')">üíæ Kaydet</button>
            
            <label style="margin-top:10px; font-weight:bold;">Grafik Kalitesi (0.5-2)</label>
            <input type="range" min="0.5" max="2" step="0.1" style="width:100%" onchange="App.setQuality(this.value)">
            
            <label style="margin-top:10px; font-weight:bold;">UI √ñl√ßeƒüi (K√º√ß√ºk/B√ºy√ºk)</label>
            <input type="range" min="0.7" max="1.2" step="0.1" style="width:100%" onchange="UI.setScale(this.value)">

            <label style="margin-top:10px; font-weight:bold;">Kamera Zoom Mesafesi (Oyun Modu)</label>
            <input type="range" min="5" max="30" value="15" step="1" style="width:100%" onchange="LunX.cameraDistance=Number(this.value)">
            
            <button class="x-btn" style="margin-top:auto; background:#ffcccc; color:red;" onclick="UI.closeXMenu()">Kapat</button>
        </div>
    </div>

    <div id="main-layout">
        
        <div id="toolbox">
            <div class="panel-head">Toolbox <span style="cursor:pointer" onclick="UI.toggle('toolbox')">‚úï</span></div>
            <div id="toolbox-content"></div>
        </div>

        <div id="viewport">
            <div id="game-hud">
                <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px;">
                    <div style="width:150px; height:15px; background:#333; border:1px solid white;">
                        <div id="hp-bar" style="width:100%; height:100%; background:#00ff00;"></div>
                    </div>
                </div>
                
                <div id="joystick-zone"><div id="joystick-knob"></div></div>
                <div id="jump-btn">‚¨Ü</div>
                <div id="interact-btn">üöó</div> 
            </div>
        </div>

        <div id="right-panel">
            <div class="split-v" style="border-bottom:1px solid #ccc;">
                <div class="panel-head">Explorer</div>
                <div id="explorer" style="padding:5px; font-size:12px;"></div>
            </div>
            <div class="split-v">
                <div class="panel-head">Properties</div>
                <div id="prop-content"></div>
            </div>
        </div>

    </div>
    
    <div id="ai-chat-overlay" onclick="if(event.target==this) AI.closeChat()">
        <div id="ai-chat-panel">
            <h3 style="margin:0 0 10px 0;">ü§ñ AI Builder Chat</h3>
            <div id="ai-chat-log">
                <div class="ai-msg bot">Merhaba! Ne in≈üa etmek istersiniz? ("araba", "lego ev" veya "ultra realist orman" gibi komutlarƒ± deneyin.)</div>
            </div>
            <div id="ai-input-container">
                <input type="text" id="ai-prompt-input" placeholder="Komutunuzu buraya yazƒ±n..." onkeydown="if(event.key==='Enter') AI.sendPrompt()">
                <button id="ai-send-btn" onclick="AI.sendPrompt()">Olu≈ütur</button>
            </div>
            <button id="ai-exit-btn" onclick="AI.closeChat()">√áƒ±kƒ±≈ü</button>
        </div>
    </div>

    <input type="file" id="obj-input" accept=".obj">
    <input type="file" id="tex-input" accept="image/*">

    <script>
        
        const LunX = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            objects: [], selected: null, isPlaying: false,
            
            // Game Vars
            player: null,
            vehicle: null, 
            health: 100,
            
            // Inputs
            joy: { x:0, y:0, active:false },
            keys: {},
            
            // Geli≈ümi≈ü Kamera Ayarlarƒ±
            cameraDistance: 15,
            cameraHeight: 8,

            init: () => {
                ThreeEngine.init();
                UI.initToolbox();
                
                // Listeners
                window.addEventListener('resize', ThreeEngine.resize);
                window.addEventListener('keydown', e => LunX.keys[e.key.toLowerCase()] = true);
                window.addEventListener('keyup', e => LunX.keys[e.key.toLowerCase()] = false);

                // Joystick
                const joy = document.getElementById('joystick-zone');
                joy.addEventListener('touchstart', Game.joyStart, {passive:false});
                joy.addEventListener('touchmove', Game.joyMove, {passive:false});
                joy.addEventListener('touchend', Game.joyEnd);
                
                // Jump
                document.getElementById('jump-btn').addEventListener('touchstart', Game.jump);
                document.getElementById('jump-btn').addEventListener('mousedown', Game.jump);
                
                // Interact (Car)
                document.getElementById('interact-btn').addEventListener('click', Game.exitVehicle);

                // Texture upload listener
                document.getElementById('tex-input').addEventListener('change', World.onTextureUpload);
                document.getElementById('obj-input').addEventListener('change', World.onOBJUpload);
                
                Tools.setMode('select');
            }
        };

        const ThreeEngine = {
            init: () => {
                const vp = document.getElementById('viewport');
                LunX.scene = new THREE.Scene();
                LunX.scene.background = new THREE.Color(0x87CEEB);
                LunX.scene.fog = new THREE.Fog(0x87CEEB, 50, 500);

                LunX.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 2000);
                LunX.camera.position.set(15, 15, 15);

                LunX.renderer = new THREE.WebGLRenderer({ antialias: true });
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
                LunX.renderer.shadowMap.enabled = true;
                LunX.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                LunX.renderer.toneMappingExposure = 1;
                vp.appendChild(LunX.renderer.domElement);

                // Lights
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                LunX.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 1);
                dir.position.set(50, 100, 50);
                dir.castShadow = true;
                dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
                LunX.scene.add(dir);

                // Controls
                LunX.controls = new THREE.OrbitControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform = new THREE.TransformControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform.addEventListener('dragging-changed', e => LunX.controls.enabled = !e.value);
                LunX.scene.add(LunX.transform);

                // Raycaster
                vp.addEventListener('mousedown', Tools.onSelect);
                vp.addEventListener('touchstart', Tools.onSelect, {passive:false});

                // Baseplate
                World.add('baseplate');

                ThreeEngine.loop();
            },
            resize: () => {
                const vp = document.getElementById('viewport');
                LunX.camera.aspect = vp.clientWidth / vp.clientHeight;
                LunX.camera.updateProjectionMatrix();
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },
            loop: () => {
                requestAnimationFrame(ThreeEngine.loop);
                if(LunX.isPlaying) Game.update();
                else LunX.controls.update();
                LunX.renderer.render(LunX.scene, LunX.camera);
            }
        };

        const World = {
            add: (type, opts={}) => {
                let geo, mat;
                
                // Boyut ve Y√ºkseklik Varsayƒ±lanlarƒ±
                let size = opts.size || new THREE.Vector3(4, 4, 4);
                let height = size.y;

                if(type==='baseplate') {
                    geo = new THREE.BoxGeometry(500, 1, 500);
                    mat = new THREE.MeshStandardMaterial({color: 0x555555});
                    size.set(500, 1, 500);
                    height = 1;
                } else if(type==='sphere') {
                    geo = new THREE.SphereGeometry(size.x/2, 32, 32);
                    mat = new THREE.MeshStandardMaterial({color: opts.color || Math.random()*0xffffff});
                }
                else if(type==='cylinder') {
                    geo = new THREE.CylinderGeometry(size.x/2, size.x/2, size.y, 32);
                    mat = new THREE.MeshStandardMaterial({color: opts.color || Math.random()*0xffffff});
                }
                else if(type==='wedge') {
                    geo = new THREE.ConeGeometry(size.x/2, size.y, 4);
                    mat = new THREE.MeshStandardMaterial({color: opts.color || Math.random()*0xffffff});
                }
                else { // box (part)
                    geo = new THREE.BoxGeometry(size.x, size.y, size.z);
                    mat = new THREE.MeshStandardMaterial({color: opts.color || Math.random()*0xffffff});
                }
                
                if(type === 'neon') mat = new THREE.MeshBasicMaterial({color:opts.color||0x00ffff, emissive:opts.color||0x00ffff});
                if(type === 'damage') { mat = new THREE.MeshStandardMaterial({color: 0xff0000}); opts.damage = 10; }
                if(type === 'glass') mat = new THREE.MeshPhysicalMaterial({color: opts.color||0xaaccff, transparent: true, opacity: 0.5, metalness: 0.1, roughness: 0.2});

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(opts.pos || new THREE.Vector3(0, 10, 0));
                
                if(type==='baseplate') { mesh.position.y = -0.5; mesh.name="Baseplate"; mesh.userData.locked=true; }
                else mesh.name = opts.name || type.charAt(0).toUpperCase() + type.slice(1);

                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.userData = { 
                    anchored: type==='baseplate' || type==='spawn' || type==='light' || type==='neon' || type==='glass' || type==='damage', 
                    canCollide: true, // Varsayƒ±lan olarak √ßarpƒ±≈üma a√ßƒ±k
                    damage: opts.damage || 0,
                    velocity: new THREE.Vector3(),
                    halfSize: size.clone().multiplyScalar(0.5) // √áarpƒ±≈üma i√ßin
                };
                mesh.scale.copy(size).divide(new THREE.Vector3(mesh.geometry.parameters.width||1, mesh.geometry.parameters.height||1, mesh.geometry.parameters.depth||1).multiplyScalar(1/size.x));
                mesh.scale.set(1,1,1); // Scaling the geometry, not the mesh scale for simpler physics

                if(type==='spawn') {
                    mesh.scale.set(2, 0.1, 2); mesh.name="SpawnLocation"; mesh.material.color.setHex(0xaaaaaa);
                    mesh.userData.halfSize.set(1, 0.05, 1);
                }
                
                if(type==='light') {
                    const l = new THREE.PointLight(0xffaa00, 1, 20);
                    mesh.add(l); 
                }

                LunX.scene.add(mesh);
                LunX.objects.push(mesh);
                UI.refreshExplorer();
                return mesh;
            },
            
            // ... OBJ ve Texture y√ºkleme fonksiyonlarƒ± ...

            setSky: (time) => {
                LunX.scene.background = new THREE.Color(time==='day' ? 0x87CEEB : 0x000022);
                LunX.scene.fog.color = LunX.scene.background;
            }
        };

        const AI = {
            state: {},
            openChat: () => {
                document.getElementById('ai-chat-overlay').style.display = 'flex';
                document.getElementById('ai-prompt-input').focus();
            },
            closeChat: () => {
                document.getElementById('ai-chat-overlay').style.display = 'none';
            },
            sendPrompt: () => {
                const inputEl = document.getElementById('ai-prompt-input');
                const prompt = inputEl.value.toLowerCase().trim();
                inputEl.value = '';
                if(!prompt) return;

                AI.addMessage(prompt, 'user');
                let response = "";
                let shouldBuild = false;

                if (prompt.includes("olu≈ütur") || prompt.includes("yap") || prompt.includes("build") || prompt.includes("tamam")) {
                    shouldBuild = true;
                }
                
                if (shouldBuild) {
                    // Y√ºksek √∂ncelikli ana komutlarƒ± i≈üle
                    if (prompt.includes("araba") || prompt.includes("car")) {
                        response = "AI: Kƒ±rmƒ±zƒ± bir araba in≈üa ediliyor...";
                        AI.buildCar();
                    } else if (prompt.includes("ev") || prompt.includes("house")) {
                        response = "AI: Basit bir ev in≈üa ediliyor...";
                        AI.buildHouse();
                    } else if (prompt.includes("duvar")) {
                        response = "AI: Bir duvar in≈üa edildi.";
                        World.add('box', {pos: new THREE.Vector3(5, 5, 0), size: new THREE.Vector3(10, 5, 1)});
                    } else if (prompt.includes("ultra realist")) {
                         response = "AI: Ultra realist orman modellemesi tamamlandƒ±! (√ñrnek: birka√ß b√ºy√ºk ye≈üil kutu ve kahverengi silindir).";
                         AI.buildRealisticForest();
                    } else if (prompt.includes("lego")) {
                         response = "AI: Lego tarzƒ± sarƒ± bir kule in≈üa edildi.";
                         AI.buildLegoTower();
                    } else {
                        response = "AI: Anladƒ±m, ama bu komutu nasƒ±l modelleyeceƒüimi tam bilemiyorum. 'araba', 'lego ev' veya 'ultra realist' gibi daha spesifik terimler kullanƒ±r mƒ±sƒ±nƒ±z?";
                    }
                } else {
                    // Sohbet/√ñƒürenme modunda kalƒ±n
                    if (prompt.includes("nasƒ±lsƒ±n")) {
                        response = "AI: ƒ∞yiyim, te≈üekk√ºrler! Sahneye ne eklememi istersin? (√ñrn: 'mavi bir araba olu≈ütur')";
                    } else if (prompt.includes("renk") || prompt.includes("mavi")) {
                        response = "AI: Renkleri ve materyalleri √∂zelle≈ütirebilirim. Bir sonraki olu≈üturma komutunuzda 'mavi' veya 'parlak' gibi kelimeler ekleyin.";
                    } else {
                        response = "AI: Olu≈üturma komutu almadƒ±m. Olu≈üturmak istediƒüiniz ≈üeyi yazƒ±p 'Olu≈ütur' d√ºƒümesine basƒ±n.";
                    }
                }

                AI.addMessage(response, 'bot');
            },
            
            addMessage: (text, type) => {
                const log = document.getElementById('ai-chat-log');
                const msg = document.createElement('div');
                msg.className = `ai-msg ${type}`;
                msg.innerText = text;
                log.appendChild(msg);
                log.scrollTop = log.scrollHeight; // En alta kaydƒ±r
            },

            // --- AI Yapƒ±m Fonksiyonlarƒ± ---
            buildCar: () => {
                const carGroup = new THREE.Group();
                carGroup.name = "AI_Car";
                
                const body = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 8), new THREE.MeshPhongMaterial({color:0x0000ff}));
                body.position.y = 1;
                carGroup.add(body);
                
                const wheels = [
                    {x:-2.2, z:2.5}, {x:2.2, z:2.5}, {x:-2.2, z:-2.5}, {x:2.2, z:-2.5}
                ];
                wheels.forEach(pos => {
                    const w = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.5, 16), new THREE.MeshStandardMaterial({color:0x222222}));
                    w.rotation.z = Math.PI/2;
                    w.position.set(pos.x, 0.8, pos.z);
                    carGroup.add(w);
                });
                
                carGroup.position.set(10, 5, 10);
                carGroup.userData = { isVehicle: true, velocity: new THREE.Vector3(), rotSpeed: 0, anchored: false, halfSize: new THREE.Vector3(2, 2.5, 4) };
                
                LunX.scene.add(carGroup);
                LunX.objects.push(carGroup);
            },

            buildHouse: () => {
                const h = new THREE.Group(); h.name = "AI_House";
                const wallMat = new THREE.MeshStandardMaterial({color: 0xddccaa});
                const roofMat = new THREE.MeshStandardMaterial({color: 0x884444});
                
                const box = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), wallMat); box.position.y = 4;
                const roof = new THREE.Mesh(new THREE.ConeGeometry(9, 4, 4), roofMat); 
                roof.position.y = 10; roof.rotation.y = Math.PI/4;
                
                h.add(box); h.add(roof);
                h.position.set(-10, 0, -10);
                h.userData = { anchored: true, halfSize: new THREE.Vector3(5, 5, 5) };
                
                LunX.scene.add(h);
                LunX.objects.push(h);
            },

            buildRealisticForest: () => {
                 World.add('box', {pos: new THREE.Vector3(15, 10, 0), size: new THREE.Vector3(8, 15, 8), color: 0x38761d, name: "BigTree"});
                 World.add('cylinder', {pos: new THREE.Vector3(15, 1, 0), size: new THREE.Vector3(2, 2, 2), color: 0x654321, name: "Trunk"});
            },

            buildLegoTower: () => {
                for (let i = 0; i < 5; i++) {
                    World.add('box', {
                        pos: new THREE.Vector3(0, i * 1.5 + 2, 10),
                        size: new THREE.Vector3(4, 1.5, 4),
                        color: 0xffff00,
                        name: "LegoBlock"
                    });
                }
            }
        };

        const Tools = {
            onSelect: (e) => {
                // ... Mevcut se√ßim mantƒ±ƒüƒ± ...
            },
            setMode: (m) => {
                // ... Mevcut mod ayarƒ± mantƒ±ƒüƒ± ...
            }
        };

        const Game = {
            play: () => {
                if(LunX.isPlaying) return;
                LunX.isPlaying = true;
                LunX.transform.detach();
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('right-panel').style.display = 'none';
                document.getElementById('toolbox').style.display = 'none';
                document.getElementById('game-hud').style.display = 'block';
                document.getElementById('x-menu-btn').style.display = 'none';
                
                // R6 Character Spawn
                const grp = new THREE.Group();
                const mat = new THREE.MeshPhongMaterial({color:0x0088ff});
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), new THREE.MeshPhongMaterial({color:0xffcc00})); head.position.y = 4.6;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), mat); torso.position.y = 3;
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshPhongMaterial({color:0x444})); ll.position.set(-0.5,1,0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshPhongMaterial({color:0x444})); rl.position.set(0.5,1,0);
                
                grp.add(head, torso, ll, rl);
                
                const spawn = LunX.objects.find(o=>o.name==="SpawnLocation");
                grp.position.copy(spawn ? spawn.position : new THREE.Vector3(0,5,0));
                grp.position.y += 2;
                
                grp.userData = { 
                    velocity: new THREE.Vector3(), 
                    onGround: false, 
                    limbs: {ll, rl}, 
                    height: 5.2,
                    halfSize: new THREE.Vector3(1, 2.6, 0.5) // Karakter √ßarpƒ±≈üma kutusu (basit)
                };
                LunX.player = grp;
                LunX.scene.add(grp);
                
                // Kamera Ayarlarƒ± (Zoomable Follow)
                LunX.controls.enablePan = false;
                LunX.controls.minDistance = 5; // Zoom min
                LunX.controls.maxDistance = 30; // Zoom max
                LunX.controls.target.copy(grp.position);
            },
            
            stop: () => {
                // ... Mevcut durdurma mantƒ±ƒüƒ± ...
            },

            // YENƒ∞: Geli≈ütirilmi≈ü √áarpƒ±≈üma ve Y√ºr√ºme
            update: () => {
                let target = LunX.player;
                if(LunX.vehicle) target = LunX.vehicle;
                if(!target) return;
                
                const v = target.userData.velocity;
                const speed = LunX.vehicle ? 0.3 : 0.2; 
                const jumpForce = 0.8;
                const gravity = 0.02;
                const targetHalfSize = target.userData.halfSize;

                // 1. Yatay Hareket Giri≈üi
                let moveDir = new THREE.Vector3(0, 0, 0);
                if(LunX.joy.active) {
                    const camAngle = LunX.controls.getAzimuthalAngle();
                    const fwd = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0, 1, 0), camAngle);
                    const right = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0, 1, 0), camAngle);
                    
                    if(LunX.vehicle) {
                        LunX.vehicle.rotation.y -= LunX.joy.x * 0.05;
                        LunX.vehicle.translateZ(LunX.joy.y * speed * 2); 
                    } else {
                        moveDir.add(fwd.multiplyScalar(-LunX.joy.y)).add(right.multiplyScalar(LunX.joy.x));
                        moveDir.y = 0;
                        moveDir.normalize().multiplyScalar(speed);
                    }
                }

                // 2. Fizik Uygulama
                if(!LunX.vehicle) {
                    v.y -= gravity;
                    
                    // Ge√ßici yeni pozisyon
                    const newPos = target.position.clone().add(moveDir).add(new THREE.Vector3(0, v.y, 0));

                    // 3. √áarpƒ±≈üma Kontrol√º (Basitle≈ütirilmi≈ü AABB)
                    let onGround = false;
                    let groundY = -100;
                    
                    LunX.objects.forEach(obj => {
                        if (!obj.userData.canCollide || obj === target) return;
                        
                        // Objenin AABB'si
                        const objHalfSize = obj.userData.halfSize;
                        const objPos = obj.position;

                        // √áarpƒ±≈üma Testi
                        if (newPos.x + targetHalfSize.x > objPos.x - objHalfSize.x &&
                            newPos.x - targetHalfSize.x < objPos.x + objHalfSize.x &&
                            newPos.z + targetHalfSize.z > objPos.z - objHalfSize.z &&
                            newPos.z - targetHalfSize.z < objPos.z + objHalfSize.z) {
                            
                            // Y √áarpƒ±≈üma
                            if (newPos.y - targetHalfSize.y < objPos.y + objHalfSize.y &&
                                newPos.y + targetHalfSize.y > objPos.y - objHalfSize.y) {

                                if (obj.userData.anchored) {
                                    // Zemin √ßarpƒ±≈ümasƒ±
                                    if (target.position.y - targetHalfSize.y >= objPos.y + objHalfSize.y) {
                                        groundY = Math.max(groundY, objPos.y + objHalfSize.y);
                                        onGround = true;
                                    }
                                    
                                    // Yan √ßarpƒ±≈üma (Hareket durdurma)
                                    if (onGround === false) {
                                        moveDir.set(0, 0, 0); // Hareket y√∂n√ºn√º sƒ±fƒ±rla
                                    }
                                } else {
                                    // D√º≈üen/hareketli par√ßalara dokunma (Basit hasar/itme)
                                    if (obj.userData.damage > 0) Game.takeDamage(obj.userData.damage / 2);
                                }
                            }
                        }
                    });

                    // 4. Konumu G√ºncelleme
                    target.userData.onGround = onGround;
                    target.position.add(moveDir);
                    target.position.y += v.y;

                    if (onGround && target.position.y - targetHalfSize.y <= groundY) {
                        target.position.y = groundY + targetHalfSize.y;
                        v.y = 0;
                    }
                }

                // 5. Animasyon ve Y√∂nelim
                if (LunX.player) {
                    if (moveDir.length() > 0.01) {
                        target.lookAt(target.position.clone().add(moveDir));
                        const t = Date.now() * 0.02;
                        target.userData.limbs.ll.rotation.x = Math.sin(t);
                        target.userData.limbs.rl.rotation.x = -Math.sin(t);
                    } else {
                        target.userData.limbs.ll.rotation.x = 0;
                        target.userData.limbs.rl.rotation.x = 0;
                    }
                }
                
                // 6. Kamera Takibi (Zoomable Follow)
                LunX.controls.target.lerp(target.position, 0.1); 
                LunX.controls.update(); // OrbitControls'un zoom √∂zelliƒüini kullanmak i√ßin update √ßaƒürƒ±lƒ±r
            },
            
            takeDamage: (amount) => {
                LunX.health -= amount;
                document.getElementById('hp-bar').style.width = LunX.health + '%';
                if(LunX.health <= 0) Game.respawn();
            },

            respawn: () => {
                LunX.health = 100;
                document.getElementById('hp-bar').style.width = '100%';
                const spawn = LunX.objects.find(o=>o.name==='SpawnLocation');
                LunX.player.position.copy(spawn ? spawn.position : new THREE.Vector3(0,5,0)).add(new THREE.Vector3(0,2.6,0));
                LunX.player.userData.velocity.set(0, 0, 0);
            },
            
            // ... Ara√ß ve Joystick mantƒ±ƒüƒ± ...
        };

        const UI = {
            setTab: (tabId) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
                document.getElementById('sec-'+tabId).classList.add('active');
            },
            toggle: (panelId) => {
                const el = document.getElementById(panelId === 'properties' ? 'right-panel' : 'toolbox');
                el.classList.toggle('closed');
                ThreeEngine.resize(); 
            }, 
            openXMenu: () => document.getElementById('x-overlay').style.display = 'flex',
            closeXMenu: () => document.getElementById('x-overlay').style.display = 'none',
            
            setScale: (s) => {
                const scale = parseFloat(s);
                document.documentElement.style.setProperty('--toolbar-height', (100 * scale) + 'px');
                document.documentElement.style.setProperty('--panel-width', (280 * scale) + 'px'); 
                ThreeEngine.resize(); 
            },

            updateProps: () => {
                const p = document.getElementById('prop-content');
                p.innerHTML = '';
                if(!LunX.selected) return;
                const obj = LunX.selected;
                
                const row = (lbl, val, type, cb) => {
                    const div = document.createElement('div'); div.className='prop-row';
                    div.innerHTML = `<div class="prop-label">${lbl}</div>`;
                    const inp = document.createElement('input'); inp.className='prop-input';
                    inp.type = type;
                    if(type==='checkbox') inp.checked = val; else inp.value = val;
                    inp.onchange = e => cb(type==='checkbox'?e.target.checked:e.target.value);
                    div.appendChild(inp); p.appendChild(div);
                };
                
                row("Name", obj.name, 'text', v=>obj.name=v);
                
                if(!obj.userData.locked) {
                    row("Anchored", obj.userData.anchored, 'checkbox', v=>obj.userData.anchored=v);
                    row("Collide", obj.userData.canCollide, 'checkbox', v=>obj.userData.canCollide=v); // YENƒ∞: √áarpƒ±≈üma Kapatma
                    
                    // Materyal/Renk D√ºzeltmesi
                    if(obj.material.color) row("Color", '#'+obj.material.color.getHexString(), 'color', v=>{ obj.material.color.set(v); obj.material.needsUpdate = true; });
                    
                    if(obj.userData.damage !== undefined) row("Damage", obj.userData.damage, 'number', v=>obj.userData.damage=Number(v));

                    const btn = document.createElement('button'); btn.innerText="Texture"; btn.onclick=World.uploadTexture;
                    p.appendChild(btn);
                }
            },
            // ... explorer ve toolbox ba≈ülangƒ±√ß mantƒ±ƒüƒ± ...
        };

        const App = {
            reset: () => location.reload(),
            setQuality: (v) => LunX.renderer.setPixelRatio(window.devicePixelRatio * v)
        };
        
        // --- Eksik Game Fonksiyonlarƒ±nƒ±n Eklenmesi (Tamamlayƒ±cƒ±) ---
        Game.enterVehicle = (car) => {
            LunX.vehicle = car;
            LunX.scene.remove(LunX.player); 
            document.getElementById('interact-btn').innerHTML = 'üö∂';
            document.getElementById('interact-btn').onclick = Game.exitVehicle;
        };

        Game.exitVehicle = () => {
            if(!LunX.vehicle) return;
            const offset = new THREE.Vector3(3,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), LunX.vehicle.rotation.y);
            LunX.player.position.copy(LunX.vehicle.position).add(offset);
            LunX.player.position.y += LunX.player.userData.height || 2;
            
            LunX.scene.add(LunX.player);
            LunX.vehicle = null;
            document.getElementById('interact-btn').style.display = 'none';
        };

        Game.joyStart = (e) => { 
            LunX.joy.active = true; Game.joyMove(e); 
            if(e) e.preventDefault();
        };
        Game.joyMove = (e) => {
            if(!LunX.joy.active) return;
            e.preventDefault();
            const rect = document.getElementById('joystick-zone').getBoundingClientRect(); 
            const cx = rect.left+60; const cy=rect.top+60;
            const tx = e.touches[0].clientX; const ty = e.touches[0].clientY;
            let dx = tx-cx; let dy=ty-cy;
            const d = Math.sqrt(dx*dx+dy*dy);
            const maxD = 40;
            if(d>maxD) { const a=Math.atan2(dy,dx); dx=Math.cos(a)*maxD; dy=Math.sin(a)*maxD; }
            document.getElementById('joystick-knob').style.transform=`translate(${dx}px, ${dy}px)`;
            LunX.joy.x = dx/maxD; 
            LunX.joy.y = -dy/maxD; 
        };
        Game.joyEnd = () => { LunX.joy.active=false; LunX.joy.x=0; LunX.joy.y=0; document.getElementById('joystick-knob').style.transform='translate(0,0)'; };

        Game.jump = (e) => { 
            if(e) e.preventDefault(); 
            if(LunX.player && LunX.player.userData.onGround) {
                LunX.player.userData.velocity.y = 0.8; 
                LunX.player.userData.onGround = false;
            }
        };

        UI.refreshExplorer = () => {
            const ex = document.getElementById('explorer'); ex.innerHTML = '';
            LunX.objects.forEach(o => {
                const d = document.createElement('div');
                d.innerText = o.name; d.style.padding='2px'; d.style.cursor='pointer';
                if(o === LunX.selected) d.style.background='#cce5ff';
                d.onclick = () => Tools.onSelect({custom: o});
                ex.appendChild(d);
            });
        };

        UI.initToolbox = () => {
            const tb = document.getElementById('toolbox-content');
            const items = [
                {name:"Neon Red", type:"neon", color:0xff0000},
                {name:"Tree Log", type:"cylinder", color:0x654321},
                {name:"Brick Wall", type:"box", color:0xaa5555},
                {name:"Glass", type:"glass", color:0xaaccff},
                {name:"Killer", type:"damage", color:0xff0000}
            ];
            for(let i=0;i<25;i++) items.push({name:`Block ${i}`, type:'box', color:Math.random()*0xffffff});
            
            items.forEach(it => {
                const el = document.createElement('div');
                el.className='tb-item';
                el.innerHTML = `<div class="tb-icon" style="background:#${new THREE.Color(it.color).getHexString()}"></div>${it.name}`;
                el.onclick = () => { World.add(it.type, {color:it.color}); };
                tb.appendChild(el);
            });
        };
        
        Tools.onSelect = (e) => {
            if(LunX.isPlaying) return;
            
            let selectedObject = null;
            
            if (e.custom) {
                selectedObject = e.custom;
            } else {
                e.preventDefault();
                
                const rect = LunX.renderer.domElement.getBoundingClientRect();
                const x = ((e.clientX || e.touches[0].clientX) - rect.left) / rect.width * 2 - 1;
                const y = -((e.clientY || e.touches[0].clientY) - rect.top) / rect.height * 2 + 1;
                
                const ray = new THREE.Raycaster();
                ray.setFromCamera({x,y}, LunX.camera);
                const hits = ray.intersectObjects(LunX.objects);
                
                if(hits.length > 0) {
                    selectedObject = hits[0].object;
                }
            }
            
            LunX.selected = selectedObject;
            if(LunX.selected && !LunX.selected.userData.locked) LunX.transform.attach(LunX.selected);
            else LunX.transform.detach();
            
            UI.updateProps();
            UI.refreshExplorer();
        };

        World.importOBJ = () => document.getElementById('obj-input').click();
        World.onOBJUpload = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const loader = new THREE.OBJLoader();
                const obj = loader.parse(ev.target.result);
                obj.position.set(0, 10, 0);
                obj.traverse(c => { 
                    if(c.isMesh) { 
                        c.castShadow=true; 
                        c.material=new THREE.MeshStandardMaterial({color:0xcccccc});
                        c.userData.halfSize = new THREE.Vector3(1, 1, 1); // Basit varsayƒ±m
                    } 
                });
                obj.name = "ImportedModel";
                obj.userData = { anchored: true, velocity: new THREE.Vector3(), halfSize: new THREE.Vector3(5, 5, 5) };
                LunX.scene.add(obj);
                LunX.objects.push(obj);
                UI.refreshExplorer();
            };
            reader.readAsText(file);
        };

        World.uploadTexture = () => document.getElementById('tex-input').click();
        World.onTextureUpload = (e) => {
            if(!LunX.selected) return alert("√ñnce bir par√ßa se√ßin!");
            const file = e.target.files[0];
            if(file) {
                const url = URL.createObjectURL(file);
                new THREE.TextureLoader().load(url, (tex) => {
                    LunX.selected.material.map = tex;
                    LunX.selected.material.needsUpdate = true;
                });
            }
        };
    </script>
</body>
</html>
