<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V3.1 - R6 & Skybox</title>
    <style>
        /* ======================================================= */
        /* TEMA VE GENEL STƒ∞LLER (A√áIK TEMA & KIRMIZI VURGU) */
        /* ======================================================= */
        :root {
            --primary-color: #e74c3c; /* Kƒ±rmƒ±zƒ± Vurgu */
            --secondary-color: #2ecc71; /* Ye≈üil */
            --background-light: #f5f5f5; /* Beyaz/A√ßƒ±k Arka Plan */
            --panel-bg: #ffffff;
            --text-color: #333;
            --border-color: #ccc;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--background-light); 
            color: var(--text-color); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            touch-action: none; 
        }

        /* Tam Ekran Overlayler */
        .full-screen-container { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(245, 245, 245, 0.95); 
            z-index: 5000; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column;
        }
        
        .form-container { 
            width: 380px; 
            padding: 40px; 
            background: var(--panel-bg); 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border-color);
            text-align: center;
        }

        /* Butonlar ve Girdiler */
        input, select { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            background: #eee; 
            border: 1px solid #ddd; 
            color: #333; 
            border-radius: 6px; 
            font-size: 14px; 
        }
        .btn { 
            background-color: var(--primary-color); 
            border: none; 
            color: white; 
            padding: 12px 20px; 
            cursor: pointer; 
            border-radius: 6px; 
            font-weight: bold; 
            transition: transform 0.1s;
            width: 100%;
        }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background-color: #555; }

        /* Toolbar ve Edit√∂r UI */
        #toolbar { 
            background-color: var(--panel-bg); 
            display: none; 
            align-items: center; 
            padding: 0 20px; 
            border-bottom: 1px solid var(--border-color); 
            height: 50px; 
            z-index: 100; 
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .tool-group { display: flex; gap: 10px; align-items: center; }
        
        .tool-btn { 
            background: transparent; 
            border: 1px solid transparent; 
            padding: 6px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 20px; 
            color: #555;
            transition: 0.2s;
        }
        .tool-btn:hover { background-color: #f0f0f0; }
        .tool-btn.active { background-color: #ffebee; color: var(--primary-color); border-color: var(--primary-color); }

        #main-area { flex-grow: 1; display: none; position: relative; overflow: hidden; }
        #viewport { flex-grow: 1; position: relative; background-color: #87ceeb; } /* Varsayƒ±lan Sky Rengi */

        #sidebar-right { 
            width: 260px; 
            background-color: var(--panel-bg); 
            border-left: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column;
            z-index: 10;
        }
        
        .panel-section { padding: 15px; border-bottom: 1px solid #eee; }
        .panel-title { font-size: 12px; font-weight: bold; color: #888; margin-bottom: 10px; letter-spacing: 1px; }
        
        .hierarchy-item { 
            padding: 8px; 
            cursor: pointer; 
            border-radius: 4px; 
            font-size: 13px; 
            margin-bottom: 2px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .hierarchy-item:hover { background-color: #f5f5f5; }
        .hierarchy-item.selected { background-color: #ffebee; color: var(--primary-color); font-weight: 600; }

        /* √ñzelle≈ütirilmi≈ü ƒ∞konlar (Emoji Yerine CSS ≈ûekiller) */
        .icon-move { display: inline-block; width: 18px; height: 18px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23e74c3c"><path d="M12 2L12 22M2 12L22 12" stroke="%23e74c3c" stroke-width="3"/></svg>') no-repeat center; }
        /* Basit emoji kullanƒ±mƒ± devam ediyor ancak stilize edildi */

        /* Mobil Kontroller */
        #mobile-controls { 
            position: absolute; bottom: 20px; left: 20px; right: 20px; 
            display: none; justify-content: space-between; pointer-events: none; z-index: 100;
        }
        #joystick-zone { width: 120px; height: 120px; background: rgba(0,0,0,0.1); border-radius: 50%; pointer-events: auto; position: relative; border: 2px solid rgba(255,255,255,0.3); }
        #joystick-knob { width: 50px; height: 50px; background: var(--primary-color); border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #jump-btn { width: 70px; height: 70px; background: rgba(0,0,0,0.5); border-radius: 50%; color: white; font-size: 24px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; border: 2px solid white; }
        #jump-btn:active { background: var(--primary-color); }
    </style>
</head>
<body>

    <div id="loading-screen" class="full-screen-container" style="display: flex;">
        <h1 style="color: var(--primary-color); margin-bottom: 10px;">LUNX STUDIO</h1>
        <div style="width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden;">
            <div id="progress-bar" style="width: 0%; height: 100%; background: var(--primary-color); transition: width 0.2s;"></div>
        </div>
        <p id="loading-text" style="margin-top: 10px; font-size: 12px; color: #888;">Ba≈ülatƒ±lƒ±yor...</p>
    </div>

    <div id="auth-screen" class="full-screen-container">
        <div class="form-container">
            <h2 style="color: var(--primary-color);">Giri≈ü Yap</h2>
            <input type="email" id="email" placeholder="E-posta">
            <input type="password" id="password" placeholder="≈ûifre">
            <button class="btn" onclick="app.auth.login()">Giri≈ü Yap</button>
            <p style="margin-top: 15px; font-size: 12px; cursor: pointer;" onclick="app.auth.toggle()">Hesabƒ±n yok mu? Kaydol</p>
        </div>
    </div>

    <div id="toolbar">
        <div class="tool-group">
            <span style="font-weight: bold; color: var(--primary-color); font-size: 18px;">LUNX</span>
        </div>
        <div class="tool-group">
            <button class="tool-btn active" id="tool-select" onclick="app.editor.setTool('select')" title="Se√ß">üñ±Ô∏è</button>
            <button class="tool-btn" id="tool-move" onclick="app.editor.setTool('translate')" title="Ta≈üƒ±">‚ÜîÔ∏è</button>
            <button class="tool-btn" id="tool-rotate" onclick="app.editor.setTool('rotate')" title="√áevir">üîÑ</button>
            <button class="tool-btn" id="tool-scale" onclick="app.editor.setTool('scale')" title="Boyut">‚§¢</button>
        </div>
        <div class="tool-group">
            <button class="tool-btn" onclick="app.editor.addShape('box')">üì¶</button>
            <button class="tool-btn" onclick="app.editor.addShape('sphere')">üîµ</button>
            <button class="tool-btn" onclick="app.editor.addShape('spawn')">üö©</button>
        </div>
        <div class="tool-group">
            <button class="btn" onclick="app.game.start()" style="padding: 8px 15px; font-size: 12px;">‚ñ∂ OYNA</button>
        </div>
    </div>

    <div id="main-area">
        <div id="viewport">
            <div id="mobile-controls">
                <div id="joystick-zone"><div id="joystick-knob"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>
            <button id="exit-play-btn" style="position: absolute; top: 20px; right: 20px; display: none; z-index: 200;" class="btn btn-secondary" onclick="app.game.stop()">EDƒ∞T√ñRE D√ñN</button>
        </div>
        
        <div id="sidebar-right">
            <div class="panel-section">
                <div class="panel-title">SAHNE (SCENE)</div>
                <div id="hierarchy-list"></div>
            </div>
            <div class="panel-section">
                <div class="panel-title">√ñZELLƒ∞KLER</div>
                <div id="properties-content">
                    <p style="color: #999; font-size: 12px; text-align: center;">Bir nesne se√ßin.</p>
                </div>
            </div>
            <div class="panel-section">
                <div class="panel-title">G√ñKY√úZ√ú (SKYBOX)</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                    <div onclick="app.editor.setSky('day')" style="height: 40px; background: #87ceeb; cursor: pointer; border-radius: 4px;"></div>
                    <div onclick="app.editor.setSky('sunset')" style="height: 40px; background: #fd5e53; cursor: pointer; border-radius: 4px;"></div>
                    <div onclick="app.editor.setSky('night')" style="height: 40px; background: #000022; cursor: pointer; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- YAPILANDIRMA ---
        const config = {
            firebase: {
                apiKey: "AIzaSyD4Dh_WCxTSqMnJ8u0M4KqwHpejJrEoctk", 
                authDomain: "lunxstudio.firebaseapp.com",
                databaseURL: "https://lunxstudio-default-rtdb.firebaseio.com",
                projectId: "lunxstudio",
                storageBucket: "lunxstudio.firebasestorage.app",
                messagingSenderId: "810358489202",
                appId: "1:810358489202:web:301dbd444bf4608f2782eb",
                measurementId: "G-Y36QNCE71R"
            }
        };

        // --- ANA UYGULAMA NESNESƒ∞ ---
        const app = {
            state: { user: null, mode: 'editor', selected: null },
            three: { scene: null, camera: null, renderer: null, controls: null, transform: null, objects: [], raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2() },
            game: { player: null, velocity: new THREE.Vector3(), speed: 0.15, jump: 0.3, gravity: 0.015, input: {x:0, y:0}, isGrounded: false },

            init: () => {
                // 1. Firebase Ba≈ülat
                try {
                    firebase.initializeApp(config.firebase);
                    firebase.auth().onAuthStateChanged(user => {
                        app.state.user = user;
                        document.getElementById('loading-screen').style.display = 'none';
                        if(user) app.ui.showEditor();
                        else app.ui.showAuth();
                    });
                } catch(e) { alert("Firebase Hatasƒ±: " + e.message); }

                // 2. 3D Sahneyi Kur
                app.editor.initScene();
            },

            // --- AUTH ---
            auth: {
                login: async () => {
                    const e = document.getElementById('email').value;
                    const p = document.getElementById('password').value;
                    try { await firebase.auth().signInWithEmailAndPassword(e, p); } 
                    catch(err) { alert(err.message); }
                },
                toggle: () => { /* Basitlik i√ßin sadece login ekranƒ± */ alert("Kayƒ±t √∂zelliƒüi ≈üu an kapalƒ±."); }
            },

            // --- UI ---
            ui: {
                showAuth: () => { document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('toolbar').style.display = 'none'; document.getElementById('main-area').style.display = 'none'; },
                showEditor: () => { document.getElementById('auth-screen').style.display = 'none'; document.getElementById('toolbar').style.display = 'flex'; document.getElementById('main-area').style.display = 'flex'; app.editor.onResize(); },
                updateHierarchy: () => {
                    const list = document.getElementById('hierarchy-list');
                    list.innerHTML = '';
                    app.three.objects.forEach(obj => {
                        const item = document.createElement('div');
                        item.className = `hierarchy-item ${app.state.selected === obj ? 'selected' : ''}`;
                        item.innerText = obj.userData.name || obj.name;
                        item.onclick = () => app.editor.select(obj);
                        list.appendChild(item);
                    });
                }
            },

            // --- EDƒ∞T√ñR ---
            editor: {
                initScene: () => {
                    const vp = document.getElementById('viewport');
                    
                    // Sahne
                    app.three.scene = new THREE.Scene();
                    app.three.scene.background = new THREE.Color(0x87ceeb); // Skybox Default
                    app.three.scene.fog = new THREE.Fog(0x87ceeb, 20, 100);

                    // Kamera
                    app.three.camera = new THREE.PerspectiveCamera(75, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                    app.three.camera.position.set(5, 5, 10);

                    // Renderer
                    app.three.renderer = new THREE.WebGLRenderer({ antialias: true });
                    app.three.renderer.setSize(vp.clientWidth, vp.clientHeight);
                    app.three.renderer.shadowMap.enabled = true;
                    vp.appendChild(app.three.renderer.domElement);

                    // I≈üƒ±klar
                    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                    app.three.scene.add(hemiLight);
                    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    dirLight.position.set(10, 20, 10);
                    dirLight.castShadow = true;
                    app.three.scene.add(dirLight);

                    // Zemin
                    const plane = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x999999 }));
                    plane.rotation.x = -Math.PI/2;
                    plane.receiveShadow = true;
                    app.three.scene.add(plane);

                    // Kontroller
                    app.three.controls = new THREE.OrbitControls(app.three.camera, app.three.renderer.domElement);
                    app.three.controls.enableDamping = true;
                    
                    app.three.transform = new THREE.TransformControls(app.three.camera, app.three.renderer.domElement);
                    app.three.transform.addEventListener('dragging-changed', (e) => app.three.controls.enabled = !e.value);
                    app.three.scene.add(app.three.transform);

                    // Event Listeners
                    window.addEventListener('resize', app.editor.onResize);
                    vp.addEventListener('mousedown', app.editor.onMouseDown);
                    vp.addEventListener('touchstart', app.editor.onTouchStart, {passive: false});

                    // Render Loop
                    app.editor.animate();
                },

                addShape: (type) => {
                    let geo, mat, mesh;
                    if (type === 'box') geo = new THREE.BoxGeometry(1, 1, 1);
                    else if (type === 'sphere') geo = new THREE.SphereGeometry(0.5, 32, 32);
                    else if (type === 'spawn') { geo = new THREE.CylinderGeometry(0.5, 0.5, 0.1, 32); mat = new THREE.MeshBasicMaterial({color:0xff0000, opacity:0.5, transparent:true}); }

                    if(!mat) mat = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
                    mesh = new THREE.Mesh(geo, mat);
                    mesh.position.y = 0.5;
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.name = type + "_" + app.three.objects.length;
                    mesh.userData = { name: mesh.name, type: type };

                    app.three.scene.add(mesh);
                    app.three.objects.push(mesh);
                    app.ui.updateHierarchy();
                    app.editor.select(mesh);
                },

                select: (obj) => {
                    app.state.selected = obj;
                    if (obj) {
                        app.three.transform.attach(obj);
                    } else {
                        app.three.transform.detach();
                    }
                    app.ui.updateHierarchy();
                },

                setTool: (mode) => {
                    if(mode === 'select') app.three.transform.detach();
                    else app.three.transform.setMode(mode);
                },

                setSky: (type) => {
                    if (type === 'day') {
                        app.three.scene.background = new THREE.Color(0x87ceeb);
                        app.three.scene.fog.color.set(0x87ceeb);
                    } else if (type === 'sunset') {
                        app.three.scene.background = new THREE.Color(0xfd5e53);
                        app.three.scene.fog.color.set(0xfd5e53);
                    } else {
                        app.three.scene.background = new THREE.Color(0x000022);
                        app.three.scene.fog.color.set(0x000022);
                    }
                },

                onResize: () => {
                    const vp = document.getElementById('viewport');
                    app.three.camera.aspect = vp.clientWidth / vp.clientHeight;
                    app.three.camera.updateProjectionMatrix();
                    app.three.renderer.setSize(vp.clientWidth, vp.clientHeight);
                },
                
                onMouseDown: (e) => {
                    if(app.state.mode === 'play') return;
                    const rect = app.three.renderer.domElement.getBoundingClientRect();
                    app.three.mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    app.three.mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    app.three.raycaster.setFromCamera(app.three.mouse, app.three.camera);
                    const intersects = app.three.raycaster.intersectObjects(app.three.objects);
                    
                    if (intersects.length > 0) app.editor.select(intersects[0].object);
                    else app.editor.select(null);
                },

                animate: () => {
                    requestAnimationFrame(app.editor.animate);
                    
                    if (app.state.mode === 'play') app.game.update();
                    else app.three.controls.update();
                    
                    app.three.renderer.render(app.three.scene, app.three.camera);
                }
            },

            // --- OYUN MOTORU (R6 KARAKTER) ---
            game: {
                start: () => {
                    app.state.mode = 'play';
                    app.editor.select(null);
                    document.getElementById('exit-play-btn').style.display = 'block';
                    document.getElementById('mobile-controls').style.display = 'flex';
                    
                    // R6 Karakter Olu≈ütur
                    app.game.createR6Character();
                    
                    // Spawn noktasƒ±na ta≈üƒ±
                    const spawn = app.three.objects.find(o => o.userData.type === 'spawn');
                    if(spawn) {
                        app.game.player.position.copy(spawn.position);
                        app.game.player.position.y += 2;
                    }
                },

                stop: () => {
                    app.state.mode = 'editor';
                    document.getElementById('exit-play-btn').style.display = 'none';
                    document.getElementById('mobile-controls').style.display = 'none';
                    
                    if(app.game.player) {
                        app.three.scene.remove(app.game.player);
                        app.game.player = null;
                    }
                    
                    // Kamerayƒ± resetle
                    app.three.camera.position.set(5, 5, 10);
                    app.three.camera.lookAt(0,0,0);
                },

                createR6Character: () => {
                    const group = new THREE.Group();
                    
                    // Materyaller (Varsayƒ±lan renkler)
                    const skinMat = new THREE.MeshStandardMaterial({color: 0xffccaa});
                    const torsoMat = new THREE.MeshStandardMaterial({color: 0x007acc});
                    const legMat = new THREE.MeshStandardMaterial({color: 0x333333});
                    
                    // R6 Par√ßalarƒ±
                    const head = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), skinMat);
                    head.position.y = 1.4;
                    
                    const torso = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 0.5), torsoMat);
                    torso.position.y = 0.5;
                    
                    const lArm = new THREE.Mesh(new THREE.BoxGeometry(0.4, 1, 0.4), skinMat);
                    lArm.position.set(-0.7, 0.5, 0);
                    
                    const rArm = new THREE.Mesh(new THREE.BoxGeometry(0.4, 1, 0.4), skinMat);
                    rArm.position.set(0.7, 0.5, 0);
                    
                    const lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.45, 1, 0.45), legMat);
                    lLeg.position.set(-0.25, -0.5, 0);
                    
                    const rLeg = new THREE.Mesh(new THREE.BoxGeometry(0.45, 1, 0.45), legMat);
                    rLeg.position.set(0.25, -0.5, 0);
                    
                    group.add(head, torso, lArm, rArm, lLeg, rLeg);
                    group.userData.parts = { lLeg, rLeg, lArm, rArm }; // Animasyon i√ßin referans
                    
                    app.three.scene.add(group);
                    app.game.player = group;
                },

                update: () => {
                    if (!app.game.player) return;
                    
                    const p = app.game.player;
                    const speed = app.game.speed;
                    
                    // Hareket Vekt√∂r√º Hesapla
                    let dx = app.game.input.x;
                    let dz = app.game.input.y;
                    
                    // Kamera y√∂n√ºne g√∂re hareket
                    const camDir = new THREE.Vector3();
                    app.three.camera.getWorldDirection(camDir);
                    camDir.y = 0; camDir.normalize();
                    const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x);
                    
                    const moveVec = new THREE.Vector3()
                        .addScaledVector(camRight, dx)
                        .addScaledVector(camDir, -dz); // Joystick Y ileri negatiftir
                        
                    if (moveVec.length() > 0) {
                        moveVec.normalize();
                        p.position.addScaledVector(moveVec, speed);
                        
                        // D√∂n√º≈ü (Y√ºr√ºd√ºƒü√º y√∂ne bak)
                        p.lookAt(p.position.clone().add(moveVec));
                        
                        // Basit Y√ºr√ºme Animasyonu (Sin√ºs dalgasƒ±)
                        const time = Date.now() * 0.01;
                        p.userData.parts.lLeg.rotation.x = Math.sin(time) * 0.5;
                        p.userData.parts.rLeg.rotation.x = -Math.sin(time) * 0.5;
                        p.userData.parts.lArm.rotation.x = -Math.sin(time) * 0.5;
                        p.userData.parts.rArm.rotation.x = Math.sin(time) * 0.5;
                    } else {
                        // Durma pozisyonu
                        p.userData.parts.lLeg.rotation.x = 0;
                        p.userData.parts.rLeg.rotation.x = 0;
                        p.userData.parts.lArm.rotation.x = 0;
                        p.userData.parts.rArm.rotation.x = 0;
                    }
                    
                    // Yer√ßekimi ve Zƒ±plama
                    app.game.velocity.y -= app.game.gravity;
                    if (p.position.y <= 1) { // Zemin seviyesi (basit kontrol)
                        p.position.y = 1;
                        app.game.velocity.y = 0;
                        app.game.isGrounded = true;
                    } else {
                        app.game.isGrounded = false;
                    }
                    p.position.y += app.game.velocity.y;
                    
                    // Kamera Takibi
                    const targetPos = p.position.clone().add(new THREE.Vector3(0, 3, 5)); // Ofset
                    app.three.camera.position.lerp(targetPos, 0.1);
                    app.three.camera.lookAt(p.position);
                }
            }
        };

        // --- JOYSTICK & INPUT ---
        const joystick = document.getElementById('joystick-knob');
        const zone = document.getElementById('joystick-zone');
        const jumpBtn = document.getElementById('jump-btn');
        let dragging = false;

        zone.addEventListener('mousedown', (e) => { dragging = true; updateJoystick(e.clientX, e.clientY); });
        zone.addEventListener('touchstart', (e) => { dragging = true; updateJoystick(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        
        window.addEventListener('mousemove', (e) => { if(dragging) updateJoystick(e.clientX, e.clientY); });
        window.addEventListener('touchmove', (e) => { if(dragging) updateJoystick(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        
        window.addEventListener('mouseup', releaseJoystick);
        window.addEventListener('touchend', releaseJoystick);

        function updateJoystick(cx, cy) {
            const rect = zone.getBoundingClientRect();
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            
            let dx = cx - centerX;
            let dy = cy - centerY;
            const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 35); // Max radius
            const angle = Math.atan2(dy, dx);
            
            const x = Math.cos(angle) * dist;
            const y = Math.sin(angle) * dist;
            
            joystick.style.transform = `translate(${x}px, ${y}px)`;
            
            // Input'u g√ºncelle (-1 ile 1 arasƒ±)
            app.game.input.x = x / 35;
            app.game.input.y = y / 35;
        }

        function releaseJoystick() {
            dragging = false;
            joystick.style.transform = `translate(0px, 0px)`;
            app.game.input.x = 0;
            app.game.input.y = 0;
        }
        
        jumpBtn.addEventListener('mousedown', () => { if(app.game.isGrounded) app.game.velocity.y = app.game.jump; });
        jumpBtn.addEventListener('touchstart', (e) => { e.preventDefault(); if(app.game.isGrounded) app.game.velocity.y = app.game.jump; });

        // Klavye Kontrolleri
        window.addEventListener('keydown', (e) => {
            if(e.key === 'w') app.game.input.y = -1;
            if(e.key === 's') app.game.input.y = 1;
            if(e.key === 'a') app.game.input.x = -1;
            if(e.key === 'd') app.game.input.x = 1;
            if(e.key === ' ' && app.game.isGrounded) app.game.velocity.y = app.game.jump;
        });
        window.addEventListener('keyup', (e) => {
            if(e.key === 'w' || e.key === 's') app.game.input.y = 0;
            if(e.key === 'a' || e.key === 'd') app.game.input.x = 0;
        });

        // Ba≈ülat
        window.onload = app.init;

    </script>
</body>
</html>
