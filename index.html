<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Ultimate Roblox Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #d32f2f;
            --bg-ui: #ffffff;
            --text: #333;
        }
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: none; font-family: 'Segoe UI', sans-serif; outline: none; }
        body { margin: 0; overflow: hidden; background: #f0f0f0; height: 100vh; display: flex; flex-direction: column; }

        /* --- UI ELEMANLARI --- */
        
        /* Sol √úst X Men√º Butonu (≈ûeffaf) */
        #x-menu-btn {
            position: fixed; top: 10px; left: 10px; z-index: 2000;
            width: 40px; height: 40px;
            background: transparent; color: var(--primary);
            font-size: 30px; font-weight: 900;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* X Men√ºs√º */
        #x-menu-panel {
            position: fixed; top: 60px; left: 10px; width: 250px;
            background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; flex-direction: column; padding: 15px; z-index: 2100; border: 1px solid #ccc;
        }
        .xm-row { margin-bottom: 15px; font-size: 12px; }
        .xm-btn { width: 100%; padding: 8px; margin-bottom: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #eee; }
        .xm-btn.red { background: var(--primary); color: white; }

        /* √úst Ribbon & Tablar */
        #top-bar { height: 40px; background: var(--primary); color: white; display: flex; padding-left: 60px; align-items: center; font-size: 13px; }
        .tab-btn { padding: 0 15px; cursor: pointer; height: 100%; display: flex; align-items: center; opacity: 0.7; }
        .tab-btn.active { opacity: 1; background: rgba(0,0,0,0.1); font-weight: bold; border-bottom: 2px solid white; }
        
        #ribbon { height: 90px; background: white; border-bottom: 1px solid #ddd; display: flex; overflow-x: auto; }
        .ribbon-content { display: none; gap: 10px; padding: 5px; height: 100%; align-items: center; width: 100%; }
        .ribbon-content.active { display: flex; }
        .tool-btn { display: flex; flex-direction: column; align-items: center; min-width: 60px; cursor: pointer; font-size: 11px; color: #444; padding: 5px; border-radius: 5px; }
        .tool-btn:hover { background: #fce4ec; }
        .tool-btn.active { background: #ffcdd2; border: 1px solid var(--primary); }
        .tool-icon { font-size: 24px; margin-bottom: 4px; }

        /* Ana Layout */
        #layout { flex: 1; display: flex; position: relative; }
        #toolbox { width: 200px; background: white; border-right: 1px solid #ddd; display: none; flex-direction: column; }
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; }
        #properties { width: 240px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }

        /* OYUN HUD (Play Mode) */
        #game-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 100; }
        
        /* Hasar Efekti (Kƒ±rmƒ±zƒ± Ekran) */
        #damage-overlay {
            position: absolute; inset: 0; background: red; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 90;
        }

        /* Can Barƒ± (Saƒü √úst) */
        #health-container {
            position: absolute; top: 15px; right: 15px; width: 200px; height: 25px;
            background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 4px; pointer-events: auto;
        }
        #health-fill { width: 100%; height: 100%; background: #00e676; transition: width 0.3s; }
        
        /* Kontroller */
        .control-el { position: absolute; pointer-events: auto; touch-action: none; }
        .control-el.draggable { border: 2px dashed yellow; background: rgba(255,255,0,0.2); }
        
        #joystick-zone { bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: white; border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 2px 5px black; pointer-events: none; }
        
        #jump-btn { bottom: 60px; right: 50px; width: 80px; height: 80px; background: rgba(255,255,255,0.6); border-radius: 50%; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 30px; color: var(--primary); cursor: pointer; }
        #jump-btn:active { background: white; transform: scale(0.95); }

        /* HOTBAR (Envanter) */
        #hotbar {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 8px;
            pointer-events: auto;
        }
        .slot {
            width: 50px; height: 50px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);
            border-radius: 4px; color: white; display: flex; align-items: center; justify-content: center;
            font-size: 10px; cursor: pointer; position: relative;
        }
        .slot.selected { border: 2px solid white; background: rgba(255,255,255,0.4); }
        .slot span { position: absolute; bottom: 2px; width: 100%; text-align: center; text-shadow: 1px 1px 1px black; }

        /* AI & Diƒüer Modallar */
        #ai-modal { position: fixed; bottom: 20px; right: 20px; width: 350px; height: 400px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 2200; }
        .ai-msg { padding: 8px; margin: 5px; border-radius: 5px; font-size: 12px; }
        .ai-msg.bot { background: #f0f0f0; align-self: flex-start; } .ai-msg.user { background: #ffebee; color: var(--primary); align-self: flex-end; }
    </style>
</head>
<body onload="App.init()">

    <div id="x-menu-btn" onclick="UI.toggleXMenu()">‚úï</div>
    <div id="x-menu-panel">
        <h3 style="margin-top:0; color:var(--primary)">Ayarlar</h3>
        <div class="xm-row">
            <label>UI √ñl√ßeƒüi</label>
            <input type="range" min="0.6" max="1.2" step="0.1" value="1" oninput="UI.setScale(this.value)" style="width:100%">
        </div>
        <div class="xm-row">
            <label>Kontrol D√ºzenleme (Tu≈ü Kilidi)</label>
            <button class="xm-btn" id="btn-lock" onclick="Game.toggleKeyLock()">üîí Kilitli</button>
        </div>
        <button class="xm-btn red" onclick="Game.stop()">Oyundan √áƒ±k (Edit√∂r)</button>
        <button class="xm-btn" onclick="UI.toggleXMenu()">Kapat</button>
    </div>

    <div id="top-bar">
        <div class="tab-btn active" onclick="UI.setTab('home')">Home</div>
        <div class="tab-btn" onclick="UI.setTab('model')">Model</div>
        <div class="tab-btn" onclick="UI.setTab('view')">View</div>
    </div>

    <div id="ribbon">
        <div id="tab-home" class="ribbon-content active">
            <div class="tool-btn" onclick="Editor.setMode('select')"><span class="tool-icon">üëÜ</span>Se√ß</div>
            <div class="tool-btn" onclick="Editor.setMode('translate')"><span class="tool-icon">‚ÜîÔ∏è</span>Ta≈üƒ±</div>
            <div class="tool-btn" onclick="Editor.setMode('scale')"><span class="tool-icon">‚§°</span>Boyut</div>
            <div class="tool-btn" onclick="Editor.setMode('rotate')"><span class="tool-icon">üîÑ</span>D√∂nd√ºr</div>
            <div style="width:1px; height:40px; background:#eee; margin:0 5px;"></div>
            <div class="tool-btn" onclick="World.addItem('Sword')"><span class="tool-icon">‚öîÔ∏è</span>Kƒ±lƒ±√ß Ekle</div>
            <div class="tool-btn" onclick="UI.toggleAI()"><span class="tool-icon">ü§ñ</span>LunAIX</div>
            <div class="tool-btn" onclick="Game.play()" style="margin-left:auto; color:green"><span class="tool-icon">‚ñ∂</span>OYNAT</div>
        </div>
        <div id="tab-model" class="ribbon-content">
            <div class="tool-btn" onclick="World.addPart('box')"><span class="tool-icon">üì¶</span>Kutu</div>
            <div class="tool-btn" onclick="World.addPart('sphere')"><span class="tool-icon">üîµ</span>K√ºre</div>
            <div class="tool-btn" onclick="World.addPart('cylinder')"><span class="tool-icon">üõ¢Ô∏è</span>Silindir</div>
        </div>
        <div id="tab-view" class="ribbon-content">
            <div class="tool-btn" onclick="UI.toggleToolbox()"><span class="tool-icon">üß∞</span>Toolbox</div>
            <div class="tool-btn" onclick="UI.toggleProperties()"><span class="tool-icon">üìù</span>√ñzellikler</div>
        </div>
    </div>

    <div id="layout">
        <div id="toolbox" style="display:none;">
            <div style="padding:10px; background:#eee; font-weight:bold;">Toolbox</div>
            </div>

        <div id="viewport">
            <div id="game-hud">
                <div id="damage-overlay"></div>
                
                <div id="health-container">
                    <div id="health-fill"></div>
                </div>

                <div id="joystick-zone" class="control-el"><div id="stick"></div></div>
                <div id="jump-btn" class="control-el">‚¨Ü</div>

                <div id="hotbar">
                    </div>
            </div>
        </div>

        <div id="properties">
            <div style="padding:10px; background:#eee; font-weight:bold;">√ñzellikler</div>
            <div id="prop-content" style="padding:10px; font-size:12px;">Se√ßim Yok</div>
        </div>
    </div>

    <div id="ai-modal">
        <div style="background:var(--primary); color:white; padding:10px; font-weight:bold; border-radius:8px 8px 0 0; display:flex; justify-content:space-between;">
            <span>LunAIX ƒ∞n≈üaat & Sohbet</span>
            <span style="cursor:pointer" onclick="UI.toggleAI()">‚úï</span>
        </div>
        <div id="ai-chat" style="flex:1; overflow-y:auto; padding:10px; background:#f9f9f9;">
            <div class="ai-msg bot">Merhaba! "Bana bir araba yap", "U√ßak in≈üa et" veya "Yol d√∂≈üe" diyebilirsin.</div>
        </div>
        <div style="padding:10px; display:flex; border-top:1px solid #ddd;">
            <input type="text" id="ai-input" style="flex:1; padding:5px;" placeholder="Ne in≈üa edeyim?" onkeydown="if(event.key==='Enter')AI.send()">
            <button onclick="AI.send()" style="margin-left:5px;">G√∂nder</button>
        </div>
    </div>

    <script>
        const App = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            world: null, clock: new THREE.Clock(), objects: [], items: [],
            init: () => {
                const vp = document.getElementById('viewport');
                
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0x87CEEB);
                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                App.camera.position.set(10, 10, 10);

                App.renderer = new THREE.WebGLRenderer({antialias:true});
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(20, 50, 20); light.castShadow = true;
                App.scene.add(light); App.scene.add(new THREE.AmbientLight(0x555));

                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', e => App.controls.enabled = !e.value);
                App.scene.add(App.transform);

                // Cannon Fizik
                App.world = new CANNON.World();
                App.world.gravity.set(0, -30, 0);
                
                // Zemin
                World.createBase();

                window.addEventListener('resize', () => {
                    App.camera.aspect = vp.clientWidth/vp.clientHeight;
                    App.camera.updateProjectionMatrix();
                    App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                });

                Game.initControls();
                App.loop();
            },
            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = App.clock.getDelta();
                
                if(Game.active) {
                    App.world.step(1/60, dt, 3);
                    Game.update(dt);
                } else {
                    App.controls.update();
                }

                // Fizik -> Grafik
                App.objects.forEach(o => {
                    if(o.userData.body && !o.userData.anchored) {
                        o.position.copy(o.userData.body.position);
                        o.quaternion.copy(o.userData.body.quaternion);
                    }
                });

                App.renderer.render(App.scene, App.camera);
            }
        };

        const World = {
            createBase: () => {
                const geo = new THREE.BoxGeometry(200, 2, 200);
                const mat = new THREE.MeshStandardMaterial({color: 0x4CAF50});
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.y = -1; mesh.receiveShadow = true;
                App.scene.add(mesh);
                
                const body = new CANNON.Body({mass: 0, shape: new CANNON.Box(new CANNON.Vec3(100, 1, 100))});
                body.position.set(0, -1, 0);
                App.world.addBody(body);
            },
            addPart: (type, config = {}) => {
                let geo, shape;
                const scale = config.scale || [2,2,2];
                const color = config.color || Math.random() * 0xffffff;
                
                if(type === 'sphere') {
                    geo = new THREE.SphereGeometry(1, 32, 32);
                    shape = new CANNON.Sphere(Math.max(scale[0],scale[1],scale[2])/2);
                } else if (type === 'cylinder') {
                    geo = new THREE.CylinderGeometry(1,1,1,32);
                    shape = new CANNON.Cylinder(scale[0]/2, scale[0]/2, scale[1], 12);
                } else {
                    geo = new THREE.BoxGeometry(1,1,1);
                    shape = new CANNON.Box(new CANNON.Vec3(scale[0]/2, scale[1]/2, scale[2]/2));
                }

                const mat = new THREE.MeshStandardMaterial({color: color});
                const mesh = new THREE.Mesh(geo, mat);
                mesh.scale.set(scale[0], scale[1], scale[2]);
                mesh.position.copy(config.pos || new THREE.Vector3(0, 5, 0));
                mesh.rotation.copy(config.rot || new THREE.Euler(0,0,0));
                mesh.castShadow = true; mesh.receiveShadow = true;
                
                const mass = config.anchored ? 0 : 10;
                const body = new CANNON.Body({mass: mass, shape: shape});
                body.position.copy(mesh.position);
                body.quaternion.copy(mesh.quaternion);
                
                mesh.userData = { body: body, anchored: config.anchored || false, damage: config.damage || 0 };
                App.world.addBody(body);
                App.scene.add(mesh);
                App.objects.push(mesh);
                return mesh;
            },
            addItem: (name) => {
                // Yere d√º≈üen e≈üya
                const mesh = World.addPart('box', {scale:[0.5,0.5,0.5], color:0xFFD700, anchored:false, pos:new THREE.Vector3(0,5,0)});
                mesh.userData.isItem = true;
                mesh.userData.itemName = name;
                App.items.push(mesh);
            }
        };

        const Game = {
            active: false, player: null, body: null, health: 100,
            inventory: [], equipped: null,
            inputs: {x:0, y:0}, controlsLocked: true,

            initControls: () => {
                const zone = document.getElementById('joystick-zone');
                const stick = document.getElementById('stick');
                const jump = document.getElementById('jump-btn');
                let drag = false;

                // Joystick Logic
                const moveStick = (cx, cy) => {
                    const rect = zone.getBoundingClientRect();
                    const cx0 = rect.left + rect.width/2;
                    const cy0 = rect.top + rect.height/2;
                    const dx = cx - cx0; const dy = cy - cy0;
                    const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                    const a = Math.atan2(dy, dx);
                    const x = Math.cos(a)*d; const y = Math.sin(a)*d;
                    stick.style.transform = `translate(${x}px, ${y}px)`;
                    Game.inputs.x = x/40; Game.inputs.y = y/40;
                };
                zone.addEventListener('pointerdown', e => { if(Game.controlsLocked) { drag=true; zone.setPointerCapture(e.pointerId); moveStick(e.clientX, e.clientY); } });
                zone.addEventListener('pointermove', e => { if(drag) moveStick(e.clientX, e.clientY); });
                zone.addEventListener('pointerup', () => { drag=false; stick.style.transform = `translate(0,0)`; Game.inputs={x:0,y:0}; });

                // Jump
                jump.addEventListener('pointerdown', () => { if(Game.controlsLocked && Game.body && Math.abs(Game.body.velocity.y) < 0.5) Game.body.velocity.y = 15; });

                // Draggable Controls
                [zone, jump].forEach(el => {
                    let isDragging = false, offX, offY;
                    el.addEventListener('mousedown', e => {
                        if(!Game.controlsLocked) { isDragging=true; offX=e.clientX-el.offsetLeft; offY=e.clientY-el.offsetTop; }
                    });
                    window.addEventListener('mousemove', e => {
                        if(isDragging) {
                            el.style.left = (e.clientX - offX) + 'px';
                            el.style.top = (e.clientY - offY) + 'px';
                            el.style.bottom = 'auto'; el.style.right = 'auto';
                        }
                    });
                    window.addEventListener('mouseup', () => isDragging=false);
                });

                // Use Item (Click Screen)
                document.getElementById('game-hud').addEventListener('pointerdown', e => {
                    if(e.target.id === 'game-hud' && Game.equipped) {
                        // Simple animation
                        Game.player.rotation.x += 0.5;
                        setTimeout(() => Game.player.rotation.x -= 0.5, 200);
                    }
                });
            },

            play: () => {
                if(Game.active) return;
                Game.active = true;
                Editor.select(null);
                
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('layout').style.top = '0';
                document.getElementById('properties').style.display = 'none';
                document.getElementById('toolbox').style.display = 'none';
                document.getElementById('game-hud').style.display = 'block';
                
                App.controls.enablePan = false;
                App.controls.enableZoom = true; 

                Game.spawnCharacter();
                Game.health = 100; Game.updateHealthUI();
                Game.updateHotbar();
            },

            stop: () => {
                Game.active = false;
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('properties').style.display = 'flex';
                document.getElementById('game-hud').style.display = 'none';

                if(Game.player) { App.scene.remove(Game.player); Game.player=null; }
                if(Game.body) { App.world.removeBody(Game.body); Game.body=null; }

                App.controls.enablePan = true;
                App.camera.position.set(10,10,10);
                App.controls.target.set(0,0,0);
            },

            spawnCharacter: () => {
                const rig = new THREE.Group();
                const matHead = new THREE.MeshStandardMaterial({color: 0xFBC02D});
                const matBody = new THREE.MeshStandardMaterial({color: 0x1976D2});
                const matLimb = new THREE.MeshStandardMaterial({color: 0x4CAF50});

                const head = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), matHead); head.position.y = 2;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), matBody); torso.position.y = 0.5;
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matHead); la.position.set(-1.5, 0.5, 0);
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matHead); ra.position.set(1.5, 0.5, 0);
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matLimb); ll.position.set(-0.5, -1.5, 0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matLimb); rl.position.set(0.5, -1.5, 0);

                rig.add(head, torso, la, ra, ll, rl);
                
                let pos = new THREE.Vector3(0,5,0);
                const body = new CANNON.Body({ mass: 50, fixedRotation: true });
                body.addShape(new CANNON.Cylinder(1.5, 1.5, 4.5, 12), new CANNON.Vec3(0,0.25,0));
                body.position.copy(pos);
                body.linearDamping = 0.9;
                App.world.addBody(body);

                // Contact listener for Damage
                body.addEventListener('collide', (e) => {
                    const obj = App.objects.find(o => o.userData.body === e.body);
                    if(obj && obj.userData.damage > 0) {
                        Game.takeDamage(obj.userData.damage);
                    }
                });

                App.scene.add(rig);
                Game.player = rig;
                Game.body = body;
                Game.limbs = {la, ra, ll, rl};
            },

            update: (dt) => {
                if(!Game.player || !Game.body) return;

                // Position Sync
                Game.player.position.copy(Game.body.position);
                
                // Movement
                const speed = 20;
                const camDir = new THREE.Vector3(); App.camera.getWorldDirection(camDir); camDir.y=0; camDir.normalize();
                const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x);
                
                const move = new THREE.Vector3();
                move.add(camRight.multiplyScalar(Game.inputs.x));
                move.add(camDir.multiplyScalar(-Game.inputs.y));

                if(move.length() > 0.1) {
                    move.normalize().multiplyScalar(speed);
                    Game.body.velocity.x = move.x;
                    Game.body.velocity.z = move.z;
                    Game.player.rotation.y = Math.atan2(move.x, move.z);

                    // Animation
                    const t = Date.now()*0.015;
                    Game.limbs.la.rotation.x = Math.sin(t); Game.limbs.ra.rotation.x = -Math.sin(t);
                    Game.limbs.ll.rotation.x = -Math.sin(t); Game.limbs.rl.rotation.x = Math.sin(t);
                } else {
                    Game.body.velocity.x *= 0.5; Game.body.velocity.z *= 0.5;
                    Game.limbs.la.rotation.x = 0; Game.limbs.ra.rotation.x = 0;
                    Game.limbs.ll.rotation.x = 0; Game.limbs.rl.rotation.x = 0;
                }

                // Camera Follow
                App.controls.target.copy(Game.player.position);

                // Item Pickup (Distance Check)
                App.items.forEach((item, idx) => {
                    if(item.position.distanceTo(Game.player.position) < 3) {
                        Game.inventory.push(item.userData.itemName);
                        App.scene.remove(item);
                        App.world.removeBody(item.userData.body);
                        App.items.splice(idx, 1);
                        Game.updateHotbar();
                    }
                });
            },

            takeDamage: (amount) => {
                Game.health -= amount;
                Game.updateHealthUI();
                
                // Red Flash
                const ol = document.getElementById('damage-overlay');
                ol.style.opacity = 0.5;
                setTimeout(() => ol.style.opacity = 0, 200);

                if(Game.health <= 0) {
                    // Reset
                    Game.body.position.set(0,10,0);
                    Game.body.velocity.set(0,0,0);
                    Game.health = 100;
                    Game.updateHealthUI();
                }
            },

            updateHealthUI: () => {
                document.getElementById('health-fill').style.width = Game.health + '%';
            },

            updateHotbar: () => {
                const hb = document.getElementById('hotbar');
                hb.innerHTML = '';
                Game.inventory.forEach((item, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    if(Game.equipped === item) slot.classList.add('selected');
                    slot.innerHTML = `<span>${i+1}</span>${item.charAt(0)}`;
                    slot.onclick = () => {
                        if(Game.equipped === item) {
                            Game.equipped = null;
                            // Remove from hand (Visual logic omitted for brevity)
                        } else {
                            Game.equipped = item;
                        }
                        Game.updateHotbar();
                    };
                    hb.appendChild(slot);
                });
            },

            toggleKeyLock: () => {
                Game.controlsLocked = !Game.controlsLocked;
                const btn = document.getElementById('btn-lock');
                const ctrls = document.querySelectorAll('.control-el');
                
                if(Game.controlsLocked) {
                    btn.innerText = "üîí Kilitli";
                    ctrls.forEach(c => c.classList.remove('draggable'));
                } else {
                    btn.innerText = "üîì D√ºzenle";
                    ctrls.forEach(c => c.classList.add('draggable'));
                }
            }
        };

        const AI = {
            send: () => {
                const inp = document.getElementById('ai-input');
                const txt = inp.value.trim();
                if(!txt) return;
                AI.addMsg(txt, 'user');
                inp.value = '';
                setTimeout(() => AI.process(txt), 800);
            },
            addMsg: (txt, type) => {
                const d = document.createElement('div'); d.className='ai-msg '+type; d.innerText=txt;
                const c = document.getElementById('ai-chat'); c.appendChild(d); c.scrollTop=c.scrollHeight;
            },
            process: (txt) => {
                const l = txt.toLowerCase();
                let reply = "";
                
                if(l.includes('u√ßak') || l.includes('plane')) {
                    const pos = new THREE.Vector3(0, 10, 0);
                    // G√∂vde
                    World.addPart('cylinder', {scale:[2,10,2], rot:new THREE.Euler(0,0,Math.PI/2), pos:pos, color:0xeeeeee, anchored:false});
                    // Kanatlar
                    World.addPart('box', {scale:[10,0.5,3], pos:pos, color:0x333, anchored:false});
                    // Kuyruk
                    World.addPart('box', {scale:[4,0.5,2], pos:pos.clone().add(new THREE.Vector3(-4,0,0)), color:0x333, anchored:false});
                    reply = "B√ºy√ºk bir u√ßak in≈üa ettim! Fizik kurallarƒ±na uygun.";
                } 
                else if (l.includes('araba') || l.includes('car')) {
                    const pos = new THREE.Vector3(5, 2, 5);
                    // ≈ûase
                    World.addPart('box', {scale:[4,1,8], pos:pos, color:0xd32f2f, anchored:false});
                    // Tekerler
                    World.addPart('cylinder', {scale:[1,1,1], pos:pos.clone().add(new THREE.Vector3(2,-0.5,2)), rot:new THREE.Euler(0,0,Math.PI/2), color:0x111, anchored:false});
                    World.addPart('cylinder', {scale:[1,1,1], pos:pos.clone().add(new THREE.Vector3(-2,-0.5,2)), rot:new THREE.Euler(0,0,Math.PI/2), color:0x111, anchored:false});
                    World.addPart('cylinder', {scale:[1,1,1], pos:pos.clone().add(new THREE.Vector3(2,-0.5,-2)), rot:new THREE.Euler(0,0,Math.PI/2), color:0x111, anchored:false});
                    World.addPart('cylinder', {scale:[1,1,1], pos:pos.clone().add(new THREE.Vector3(-2,-0.5,-2)), rot:new THREE.Euler(0,0,Math.PI/2), color:0x111, anchored:false});
                    reply = "ƒ∞≈üte araban! Par√ßalar fiziksel olarak etkile≈üimde.";
                }
                else if (l.includes('yol') || l.includes('road')) {
                    for(let i=0; i<10; i++) {
                        World.addPart('box', {scale:[6,0.2,6], pos:new THREE.Vector3(0,0.1,i*6), color:0x444, anchored:true});
                    }
                    reply = "Uzun bir yol d√∂≈üedim.";
                }
                else if (l.includes('hasar') || l.includes('kill')) {
                    World.addPart('box', {scale:[4,4,4], color:0xff0000, anchored:true, damage:20});
                    reply = "Kƒ±rmƒ±zƒ± blok dokunursan hasar verir.";
                }
                else {
                    reply = "Bunu tam anlamadƒ±m. 'U√ßak yap', 'Araba yap' veya 'Yol d√∂≈üe' diyebilirsin.";
                }
                AI.addMsg(reply, 'bot');
            }
        };

        const UI = {
            setTab: (id) => {
                document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                document.querySelectorAll('.ribbon-content').forEach(c=>c.classList.remove('active'));
                // Basit index mantƒ±ƒüƒ± veya ID e≈üle≈ümesi
                if(id==='home') { document.querySelectorAll('.tab-btn')[0].classList.add('active'); document.getElementById('tab-home').classList.add('active'); }
                if(id==='model') { document.querySelectorAll('.tab-btn')[1].classList.add('active'); document.getElementById('tab-model').classList.add('active'); }
                if(id==='view') { document.querySelectorAll('.tab-btn')[2].classList.add('active'); document.getElementById('tab-view').classList.add('active'); }
            },
            toggleXMenu: () => {
                const p = document.getElementById('x-menu-panel');
                p.style.display = p.style.display==='flex'?'none':'flex';
            },
            setScale: (val) => {
                document.body.style.zoom = val;
            },
            toggleAI: () => {
                const m = document.getElementById('ai-modal');
                m.style.display = m.style.display==='flex'?'none':'flex';
            },
            toggleToolbox: () => {
                const t = document.getElementById('toolbox');
                t.style.display = t.style.display==='flex'?'none':'flex';
                setTimeout(()=>App.renderer.setSize(document.getElementById('viewport').clientWidth, document.getElementById('viewport').clientHeight), 100);
            },
            toggleProperties: () => { /* √ñzellikler zaten a√ßƒ±k, opsiyonel gizleme eklenebilir */ }
        };

        const Editor = {
            setMode: (m) => App.transform.setMode(m),
            select: (obj) => {
                if(obj && !obj.userData.body) obj=null; // Sadece partlar se√ßilsin
                if(obj) {
                    App.transform.attach(obj);
                    document.getElementById('prop-content').innerHTML = `Se√ßili: ${obj.uuid.substr(0,6)}`;
                } else {
                    App.transform.detach();
                    document.getElementById('prop-content').innerHTML = 'Se√ßim Yok';
                }
            }
        };

    </script>
</body>
</html>
