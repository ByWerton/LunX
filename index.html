<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Professional Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #d32f2f; /* Roblox Kƒ±rmƒ±zƒ±sƒ± */
            --primary-dark: #b71c1c;
            --bg-light: #f5f5f5;
            --bg-panel: #ffffff;
            --border: #e0e0e0;
            --text: #333;
            --header-h: 40px;
            --ribbon-h: 100px;
            --ui-scale: 1;
        }

        * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-light); height: 100vh; display: flex; flex-direction: column; }
        
        /* UI SCALE WRAPPER */
        .ui-scaled { zoom: var(--ui-scale); }

        /* --- START SCREEN --- */
        #start-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #d32f2f, #ffCDD2);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .template-grid { display: flex; gap: 20px; margin-top: 30px; }
        .template-card {
            background: white; color: #333; width: 150px; height: 180px; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .template-card:hover { transform: translateY(-10px); }
        .t-icon { font-size: 40px; margin-bottom: 10px; }

        /* --- TOP BAR --- */
        #top-bar {
            height: var(--header-h); background: var(--primary); color: white; display: flex; align-items: center; padding: 0 10px;
            font-size: 14px; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #x-menu-btn {
            width: 30px; height: 30px; background: white; color: var(--primary); border-radius: 4px;
            display: flex; align-items: center; justify-content: center; font-weight: 900; cursor: pointer; margin-right: 15px;
        }
        .menu-item { padding: 0 15px; cursor: pointer; opacity: 0.9; } .menu-item:hover { opacity: 1; font-weight: bold; }

        /* --- RIBBON --- */
        #ribbon {
            height: var(--ribbon-h); background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; padding: 5px; overflow-x: auto; flex-shrink: 0;
        }
        .tool-group { display: flex; gap: 5px; padding: 0 10px; border-right: 1px solid #eee; align-items: center; }
        .r-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 60px; height: 80px; border-radius: 5px; cursor: pointer; transition: 0.2s; color: #444;
        }
        .r-btn:hover { background: #ffebee; }
        .r-btn.active { background: #ffcdd2; color: var(--primary-dark); border: 1px solid var(--primary); }
        .r-btn span { font-size: 24px; margin-bottom: 5px; }
        
        /* --- MAIN LAYOUT --- */
        #layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* TOOLBOX (LEFT) */
        #toolbox {
            width: 250px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20; transition: 0.3s; position: relative;
        }
        #toolbox.closed { width: 0; border: none; overflow: hidden; }
        .tab-header { display: flex; border-bottom: 1px solid #ddd; background: #f9f9f9; }
        .tab-btn { flex: 1; padding: 8px; text-align: center; font-size: 11px; cursor: pointer; }
        .tab-btn.active { background: white; border-bottom: 2px solid var(--primary); font-weight: bold; }
        #toolbox-list { flex: 1; overflow-y: auto; padding: 5px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; align-content: start; }
        .tool-item { 
            background: white; border: 1px solid #eee; padding: 5px; text-align: center; font-size: 10px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; border-radius: 4px;
        }
        .tool-item:hover { border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .t-preview { width: 30px; height: 30px; margin-bottom: 4px; border-radius: 3px; }

        /* VIEWPORT (CENTER) */
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; }
        
        /* PROPERTIES (RIGHT) */
        #properties {
            width: 280px; background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20;
        }
        .panel-h { padding: 8px; background: #eee; font-weight: bold; font-size: 12px; border-bottom: 1px solid #ddd; }
        #explorer { height: 35%; overflow-y: auto; border-bottom: 1px solid #ddd; }
        #prop-content { flex: 1; overflow-y: auto; padding: 10px; }
        .prop-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 11px; }
        .prop-lbl { width: 40%; color: #666; }
        .prop-inp { width: 60%; padding: 4px; border: 1px solid #ccc; }

        /* HUD & OVERLAYS */
        #game-overlay { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #stop-btn-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: #d32f2f; color: white; padding: 10px 30px; font-weight: bold;
            border-radius: 5px; cursor: pointer; pointer-events: auto; border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.5); }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: white; border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 2px 5px black; }
        #jump-btn { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 80px; background: rgba(255,255,255,0.8); border-radius: 50%; border: 4px solid var(--primary); pointer-events: auto; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 900; font-size: 24px; }

        /* X MENU */
        #x-menu {
            position: absolute; top: 40px; left: 10px; width: 250px; background: white; 
            border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none;
            flex-direction: column; padding: 15px; z-index: 2000; border: 1px solid #ddd;
        }
        .xm-row { margin-bottom: 15px; }
        .xm-btn { width: 100%; padding: 10px; margin-bottom: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-leave { background: #d32f2f; color: white; }
        .btn-reset { background: #ff9800; color: white; }
        .btn-close { background: #eee; color: #333; }

        /* AI CHAT */
        #lun-aix {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%);
            width: 400px; height: 300px; background: white; border-radius: 10px 10px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2); transition: 0.3s; display: flex; flex-direction: column;
            z-index: 1000; border: 1px solid #ccc;
        }
        #lun-aix.open { transform: translateX(-50%) translateY(0); }
        .ai-head { background: var(--primary); color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; cursor: pointer; }
        .ai-body { flex: 1; padding: 10px; overflow-y: auto; background: #f5f5f5; font-size: 12px; }
        .ai-in-area { padding: 10px; border-top: 1px solid #ddd; display: flex; }
        .ai-msg { padding: 8px; border-radius: 8px; margin-bottom: 5px; max-width: 80%; }
        .ai-msg.bot { background: white; border: 1px solid #ddd; } .ai-msg.user { background: #ffcdd2; margin-left: auto; }

        /* SCRIPT EDITOR MODAL */
        #script-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: none;
            align-items: center; justify-content: center;
        }
        #script-box { width: 600px; height: 400px; background: #222; border-radius: 8px; display: flex; flex-direction: column; border: 2px solid var(--primary); }
        #code-area { flex: 1; background: #1e1e1e; color: #0f0; font-family: monospace; padding: 10px; border: none; resize: none; }

        /* Explorer Tree */
        .tree-item { padding: 2px 5px; font-size: 12px; cursor: pointer; display: flex; align-items: center; }
        .tree-item:hover { background: #eee; }
        .tree-item.selected { background: #ffcdd2; border-left: 3px solid var(--primary); }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 40px; margin: 0;">LunX Studio</h1>
        <p>Select a template to begin</p>
        <div class="template-grid">
            <div class="template-card" onclick="World.loadTemplate('baseplate')">
                <div class="t-icon">‚¨ú</div>
                <div>Baseplate</div>
            </div>
            <div class="template-card" onclick="World.loadTemplate('grass')">
                <div class="t-icon">üü©</div>
                <div>Grass</div>
            </div>
            <div class="template-card" onclick="World.loadTemplate('village')">
                <div class="t-icon">üè°</div>
                <div>Village</div>
            </div>
        </div>
    </div>

    <div id="x-menu" class="ui-scaled">
        <h3 style="margin-top:0; color: var(--primary);">LunX Menu</h3>
        <div class="xm-row">
            <label>UI Scale</label>
            <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="UI.setScale(this.value)" style="width:100%">
        </div>
        <div class="xm-row">
            <label>Quality</label>
            <select style="width:100%" onchange="App.setQuality(this.value)">
                <option value="high">High</option>
                <option value="low">Low</option>
            </select>
        </div>
        <button class="xm-btn btn-reset" onclick="Game.respawn()">Reset Character</button>
        <button class="xm-btn btn-leave" onclick="Game.stop()">Stop Game (Leave)</button>
        <button class="xm-btn btn-close" onclick="UI.toggleXMenu()">Return</button>
    </div>

    <div id="top-bar" class="ui-scaled">
        <div id="x-menu-btn" onclick="UI.toggleXMenu()">X</div>
        <div style="font-weight:bold; margin-right:20px; font-size:16px;">LunX Studio</div>
        <div class="menu-item">Home</div>
        <div class="menu-item">Model</div>
        <div class="menu-item">View</div>
    </div>

    <div id="ribbon" class="ui-scaled">
        <div class="tool-group">
            <div class="r-btn active" onclick="Editor.setMode('select')" id="btn-select"><span>üëÜ</span>Select</div>
            <div class="r-btn" onclick="Editor.setMode('translate')" id="btn-translate"><span>‚ÜîÔ∏è</span>Move</div>
            <div class="r-btn" onclick="Editor.setMode('scale')" id="btn-scale"><span>‚§°</span>Scale</div>
            <div class="r-btn" onclick="Editor.setMode('rotate')" id="btn-rotate"><span>üîÑ</span>Rotate</div>
        </div>
        <div class="tool-group">
            <div class="r-btn" onclick="UI.toggleToolbox()" id="btn-toolbox"><span>üß∞</span>Toolbox</div>
            <div class="r-btn" onclick="UI.toggleAI()"><span>ü§ñ</span>LunAIX</div>
            <div class="r-btn" onclick="World.add('sculpt')"><span>üóø</span>Sculpt</div>
        </div>
        <div class="tool-group" style="border:none; flex:1; justify-content:center;">
            <div class="r-btn" onclick="Game.play()" style="color:green"><span>‚ñ∂</span>Play</div>
        </div>
    </div>

    <div id="layout" class="ui-scaled">
        
        <div id="toolbox" class="closed">
            <div class="panel-h">Toolbox <span style="float:right; cursor:pointer" onclick="UI.toggleToolbox()">‚úï</span></div>
            <div class="tab-header">
                <div class="tab-btn active" onclick="UI.setTab('basic')">Basic</div>
                <div class="tab-btn" onclick="UI.setTab('nature')">Nature</div>
                <div class="tab-btn" onclick="UI.setTab('struct')">Struct</div>
            </div>
            <div id="toolbox-list"></div>
        </div>

        <div id="viewport">
            <div id="game-overlay">
                <div id="stop-btn-hud" onclick="Game.stop()">‚èπ STOP</div>
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>

            <div id="lun-aix">
                <div class="ai-head" onclick="UI.toggleAI()">LunAIX Assistant <span>‚ñº</span></div>
                <div class="ai-body" id="ai-chat">
                    <div class="ai-msg bot">Hello! I can build structures or write scripts. Try "Build a house".</div>
                </div>
                <div class="ai-in-area">
                    <input type="text" id="ai-input" style="flex:1; padding:5px;" placeholder="Command...">
                    <button onclick="AI.send()" style="margin-left:5px;">Send</button>
                </div>
            </div>
        </div>

        <div id="properties">
            <div class="panel-h">Explorer</div>
            <div id="explorer"></div>
            <div class="panel-h">Properties</div>
            <div id="prop-content">
                <div style="color:#888; text-align:center">No selection</div>
            </div>
        </div>

    </div>

    <div id="script-modal">
        <div id="script-box">
            <div style="padding:10px; color:white; font-weight:bold; background:#333; border-bottom:1px solid #555; display:flex; justify-content:space-between;">
                <span>Script Editor</span>
                <span style="cursor:pointer" onclick="document.getElementById('script-modal').style.display='none'">‚úï</span>
            </div>
            <textarea id="code-area" spellcheck="false">print("Hello World")</textarea>
            <button onclick="UI.saveScript()" style="padding:10px; background:var(--primary); border:none; color:white; font-weight:bold; cursor:pointer">Apply Script</button>
        </div>
    </div>

    <script>
        /* --- APP CORE --- */
        const App = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            clock: new THREE.Clock(),
            
            init: () => {
                const vp = document.getElementById('viewport');
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0x87CEEB); // Roblox Sky Blue
                App.scene.fog = new THREE.Fog(0x87CEEB, 40, 300);

                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                App.camera.position.set(20, 20, 20);

                App.renderer = new THREE.WebGLRenderer({ antialias: true });
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                // Lights
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); App.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 0.8); 
                dir.position.set(50,100,50); dir.castShadow = true;
                dir.shadow.mapSize.width=2048; dir.shadow.mapSize.height=2048;
                App.scene.add(dir);

                // Controls
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', e => App.controls.enabled = !e.value);
                App.transform.addEventListener('change', () => UI.updateProps(Editor.selected));
                App.scene.add(App.transform);

                window.addEventListener('resize', App.resize);
                UI.initToolbox();
                Events.init();
                App.loop();
            },
            
            resize: () => {
                const vp = document.getElementById('viewport');
                App.camera.aspect = vp.clientWidth / vp.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            setQuality: (q) => {
                App.renderer.setPixelRatio(q==='high' ? window.devicePixelRatio : 0.5);
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = App.clock.getDelta();
                if(Game.active) Game.update(dt);
                else App.controls.update();
                App.renderer.render(App.scene, App.camera);
            }
        };

        /* --- WORLD & OBJECTS --- */
        const World = {
            objects: [],
            
            loadTemplate: (type) => {
                document.getElementById('start-screen').style.display = 'none';
                // Baseplate Texture (Small studs, Big plate)
                const cvs = document.createElement('canvas'); cvs.width=64; cvs.height=64;
                const ctx = cvs.getContext('2d');
                const color = type==='grass' ? '#4CAF50' : '#9E9E9E';
                ctx.fillStyle = color; ctx.fillRect(0,0,64,64);
                ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.beginPath(); ctx.arc(32,32,12,0,Math.PI*2); ctx.fill();
                const tex = new THREE.CanvasTexture(cvs);
                tex.wrapS=THREE.RepeatWrapping; tex.wrapT=THREE.RepeatWrapping;
                tex.repeat.set(100, 100); // Dense studs

                const geo = new THREE.BoxGeometry(400, 4, 400);
                const mat = new THREE.MeshStandardMaterial({map:tex});
                const base = new THREE.Mesh(geo, mat);
                base.position.y = -2;
                base.name = "Baseplate";
                base.userData = { anchored: true, canCollide: true, locked: true };
                base.receiveShadow = true;
                App.scene.add(base);
                World.objects.push(base);
                UI.addExplorer(base);

                if(type==='village') AI.build('house');
            },

            add: (config) => {
                let geo;
                if(config === 'sculpt') { config={name:"SculptTerrain", shape:'box', color:0x8D6E63, scale:[10,5,10], mat:'smooth'}; }

                switch(config.shape) {
                    case 'sphere': geo=new THREE.SphereGeometry(2,32,32); break;
                    case 'cylinder': geo=new THREE.CylinderGeometry(2,2,4,32); break;
                    case 'wedge': geo=new THREE.ConeGeometry(2,4,4); break;
                    default: geo=new THREE.BoxGeometry(4,4,4);
                }
                
                let mat;
                if(config.mat==='neon') mat = new THREE.MeshBasicMaterial({color:config.color});
                else mat = new THREE.MeshStandardMaterial({color:config.color, roughness:0.5});

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(config.pos || new THREE.Vector3(0, 10, 0));
                if(config.scale) mesh.scale.set(...config.scale);
                mesh.name = config.name || "Part";
                mesh.castShadow = true; mesh.receiveShadow = true;
                
                mesh.userData = {
                    anchored: config.anchored ?? true,
                    canCollide: config.canCollide ?? true,
                    script: "",
                    velocity: new THREE.Vector3()
                };

                App.scene.add(mesh);
                World.objects.push(mesh);
                UI.addExplorer(mesh);
                if(!Game.active) Editor.select(mesh);
                return mesh;
            }
        };

        /* --- GAME & PLAYER (R6 + X Logo) --- */
        const Game = {
            active: false, player: null, velocity: new THREE.Vector3(), onGround: false, inputs:{x:0,y:0},

            play: () => {
                if(Game.active) return;
                Game.active = true;
                Editor.deselect();
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('properties').style.display = 'none';
                document.getElementById('toolbox').classList.add('closed');
                document.getElementById('game-overlay').style.display = 'block';
                UI.toggleXMenu(false);
                setTimeout(App.resize, 350);
                Game.spawnPlayer();
            },

            stop: () => {
                Game.active = false;
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('properties').style.display = 'flex';
                document.getElementById('game-overlay').style.display = 'none';
                if(Game.player) App.scene.remove(Game.player);
                Game.player = null;
                App.camera.position.set(20,20,20); App.controls.target.set(0,0,0); App.controls.enablePan=true;
                // Reset Physics
                World.objects.forEach(o=>{
                    if(!o.userData.anchored && o.name!=="Baseplate") {
                        o.position.y = Math.max(o.position.y, 2);
                        o.userData.velocity.set(0,0,0);
                    }
                });
                setTimeout(App.resize, 350);
            },

            respawn: () => {
                if(Game.player) App.scene.remove(Game.player);
                Game.spawnPlayer();
            },

            spawnPlayer: () => {
                const g = new THREE.Group(); g.name = "Player";
                const mat = new THREE.MeshPhongMaterial({color:0xffcc80});
                const matTorso = new THREE.MeshPhongMaterial({color:0x333});

                // R6 Body
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), mat); head.position.y=4.6;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), matTorso); torso.position.y=3;
                
                // X Logo on Chest
                const xCvs = document.createElement('canvas'); xCvs.width=64; xCvs.height=64;
                const ctx = xCvs.getContext('2d');
                ctx.fillStyle = '#333'; ctx.fillRect(0,0,64,64);
                ctx.strokeStyle = 'white'; ctx.lineWidth=5; 
                ctx.moveTo(10,10); ctx.lineTo(54,54); ctx.moveTo(54,10); ctx.lineTo(10,54); ctx.stroke();
                const decal = new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(xCvs), transparent:true}));
                decal.position.set(0, 3, 0.51); g.add(decal);

                const lims = [
                    {n:'LA', x:-1.5, y:3, c:mat}, {n:'RA', x:1.5, y:3, c:mat},
                    {n:'LL', x:-0.5, y:1, c:0x555}, {n:'RL', x:0.5, y:1, c:0x555}
                ];
                lims.forEach(l => {
                    const m = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), l.c===0x555 ? new THREE.MeshPhongMaterial({color:0x555}) : l.c);
                    m.position.set(l.x, l.y, 0); m.name=l.n; g.add(m);
                });
                
                g.add(head, torso);
                g.position.set(0, 10, 0);
                App.scene.add(g);
                Game.player = g;
                Game.velocity.set(0,0,0);
                App.controls.enablePan = false;
            },

            update: (dt) => {
                if(!Game.player) return;
                const p = Game.player;

                // Gravity
                if(!Game.onGround) Game.velocity.y -= 60 * dt;
                p.position.y += Game.velocity.y * dt;

                // Floor & Void
                if(p.position.y <= 0) { p.position.y=0; Game.velocity.y=0; Game.onGround=true; }
                else Game.onGround=false;
                if(p.position.y < -50) Game.respawn();

                // Movement
                const camD = new THREE.Vector3(); App.camera.getWorldDirection(camD); camD.y=0; camD.normalize();
                const camR = new THREE.Vector3(-camD.z, 0, camD.x);
                
                if(Math.abs(Game.inputs.x)>0.1 || Math.abs(Game.inputs.y)>0.1) {
                    const move = camD.multiplyScalar(-Game.inputs.y).add(camR.multiplyScalar(Game.inputs.x));
                    p.position.add(move.multiplyScalar(20*dt));
                    p.rotation.y = Math.atan2(move.x, move.z);
                    
                    // Anim
                    const t = Date.now()*0.02;
                    p.getObjectByName('LA').rotation.x = Math.sin(t);
                    p.getObjectByName('RA').rotation.x = -Math.sin(t);
                    p.getObjectByName('LL').rotation.x = -Math.sin(t);
                    p.getObjectByName('RL').rotation.x = Math.sin(t);
                } else {
                    ['LA','RA','LL','RL'].forEach(n=>p.getObjectByName(n).rotation.x=0);
                }

                // Camera Follow
                App.controls.target.lerp(p.position.clone().add(new THREE.Vector3(0,4,0)), 0.1);
                App.controls.update();

                // Physics Objects
                World.objects.forEach(o=>{
                    if(!o.userData.anchored && o.name!=="Baseplate") {
                        if(o.position.y>2) o.position.y-=0.2;
                    }
                });
            },
            jump: () => { if(Game.onGround) Game.velocity.y = 25; }
        };

        /* --- UI & EDITOR --- */
        const Editor = {
            selected: null,
            setMode: (m) => {
                App.transform.setMode(m);
                document.querySelectorAll('.r-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('btn-'+m).classList.add('active');
            },
            select: (obj) => {
                Editor.selected = obj;
                if(obj && !obj.userData.locked) App.transform.attach(obj);
                else App.transform.detach();
                UI.updateProps(obj);
            },
            deselect: () => { Editor.selected=null; App.transform.detach(); UI.updateProps(null); }
        };

        const UI = {
            toggleToolbox: () => { 
                document.getElementById('toolbox').classList.toggle('closed'); 
                setTimeout(App.resize, 350);
            },
            toggleXMenu: (force) => {
                const el = document.getElementById('x-menu');
                if(force===false) el.style.display='none';
                else el.style.display = el.style.display==='flex'?'none':'flex';
            },
            setScale: (v) => document.documentElement.style.setProperty('--ui-scale', v),
            toggleAI: () => document.getElementById('lun-aix').classList.toggle('open'),
            
            initToolbox: () => {
                UI.setTab('basic');
            },
            setTab: (cat) => {
                document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                event && event.target.classList.add('active');
                const list = document.getElementById('toolbox-list');
                list.innerHTML = '';
                
                const items = [];
                if(cat==='basic') {
                    ['Part','Sphere','Cylinder','Wedge'].forEach(n=>items.push({n, s:n.toLowerCase(), c:0xeeeeee}));
                    items.push({n:'Spawn', s:'cylinder', c:0x888888, a:true});
                    for(let i=0; i<10; i++) items.push({n:'Block '+i, s:'box', c:Math.random()*0xffffff});
                } else if(cat==='nature') {
                    items.push({n:'Grass', s:'box', c:0x4CAF50});
                    items.push({n:'Wood', s:'box', c:0x795548});
                    items.push({n:'Water', s:'box', c:0x2196F3, a:true});
                    for(let i=0; i<10; i++) items.push({n:'Tree Part '+i, s:'cylinder', c:0x5D4037});
                } else {
                    items.push({n:'Wall', s:'box', c:0x9E9E9E, scale:[1,5,8]});
                    items.push({n:'Neon', s:'box', c:0x00FFFF, mat:'neon'});
                    for(let i=0; i<10; i++) items.push({n:'Struct '+i, s:'box', c:0x607D8B});
                }

                items.forEach(it => {
                    const el = document.createElement('div'); el.className='tool-item';
                    el.innerHTML = `<div class="t-preview" style="background:#${new THREE.Color(it.c).getHexString()}"></div>${it.n}`;
                    el.onclick = () => World.add({name:it.n, color:it.c, shape:it.s, mat:it.mat, scale:it.scale, anchored:it.a});
                    list.appendChild(el);
                });
            },

            addExplorer: (obj) => {
                const d = document.createElement('div'); d.className='tree-item';
                d.innerText = "üì¶ " + obj.name;
                d.onclick = () => Editor.select(obj);
                document.getElementById('explorer').appendChild(d);
            },

            updateProps: (obj) => {
                const p = document.getElementById('prop-content'); p.innerHTML = '';
                if(!obj) { p.innerHTML='<div style="color:#888">No selection</div>'; return; }

                const add = (lbl, el) => {
                    const r = document.createElement('div'); r.className='prop-row';
                    r.innerHTML=`<div class="prop-lbl">${lbl}</div>`; r.appendChild(el); p.appendChild(r);
                };

                const iName = document.createElement('input'); iName.className='prop-inp'; iName.value=obj.name;
                iName.oninput=e=>obj.name=e.target.value;
                add('Name', iName);

                const iAnch = document.createElement('input'); iAnch.type='checkbox'; iAnch.checked=obj.userData.anchored;
                iAnch.onchange=e=>obj.userData.anchored=e.target.checked;
                add('Anchored', iAnch);

                const iColl = document.createElement('input'); iColl.type='checkbox'; iColl.checked=obj.userData.canCollide;
                iColl.onchange=e=>obj.userData.canCollide=e.target.checked;
                add('CanCollide', iColl);

                const iSky = document.createElement('input'); iSky.type='color'; iSky.className='prop-inp';
                iSky.onchange=e=>App.scene.background.set(e.target.value);
                add('Sky Color', iSky);

                const btnScript = document.createElement('button');
                btnScript.innerText = "üìú Script"; btnScript.style.width='100%';
                btnScript.onclick = () => UI.openScript(obj);
                p.appendChild(btnScript);
            },

            openScript: (obj) => {
                document.getElementById('script-modal').style.display = 'flex';
                document.getElementById('code-area').value = obj.userData.script || 'print("Hello ' + obj.name + '")';
                window.currentScriptObj = obj;
            },
            saveScript: () => {
                if(window.currentScriptObj) window.currentScriptObj.userData.script = document.getElementById('code-area').value;
                document.getElementById('script-modal').style.display = 'none';
            }
        };

        /* --- AI --- */
        const AI = {
            send: () => {
                const i = document.getElementById('ai-input');
                const txt = i.value.trim();
                if(!txt) return;
                const d = document.createElement('div'); d.className='ai-msg user'; d.innerText=txt;
                document.getElementById('ai-chat').appendChild(d);
                i.value = '';
                setTimeout(() => AI.process(txt), 500);
            },
            process: (txt) => {
                const l = txt.toLowerCase();
                let r = "Done.";
                if(l.includes('house')) AI.build('house');
                else if(l.includes('tower')) AI.build('tower');
                else if(l.includes('code')) r = "Script generated.";
                else r = "I can build 'house' or 'tower'.";
                
                const d = document.createElement('div'); d.className='ai-msg bot'; d.innerText=r;
                document.getElementById('ai-chat').appendChild(d);
            },
            build: (type) => {
                if(type==='house') {
                    World.add({name:"Wall1", scale:[1,8,10], pos:new THREE.Vector3(-5,4,0), color:0x888});
                    World.add({name:"Wall2", scale:[1,8,10], pos:new THREE.Vector3(5,4,0), color:0x888});
                    World.add({name:"Roof", shape:'wedge', scale:[12,4,12], pos:new THREE.Vector3(0,9,0), color:0xA52A2A});
                } else if (type==='tower') {
                    for(let i=0; i<5; i++) World.add({name:"Floor", scale:[5,1,5], pos:new THREE.Vector3(10, i*4, 10), color:Math.random()*0xffffff});
                }
            }
        };

        /* --- EVENTS --- */
        const Events = {
            init: () => {
                const vp = document.getElementById('viewport');
                vp.addEventListener('pointerdown', e => {
                    if(Game.active) return;
                    const rect = App.renderer.domElement.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                    const ray = new THREE.Raycaster(); ray.setFromCamera({x,y}, App.camera);
                    const hits = ray.intersectObjects(World.objects);
                    if(hits.length > 0 && hits[0].object.name!=="Baseplate") Editor.select(hits[0].object);
                    else if(hits.length===0) Editor.deselect();
                });

                // Joystick
                const joy = document.getElementById('joystick-zone');
                joy.addEventListener('pointerdown', e => {
                    e.stopPropagation(); joy.setPointerCapture(e.pointerId);
                    joy.onpointermove = ev => {
                        ev.stopPropagation();
                        const r = joy.getBoundingClientRect();
                        const dx = ev.clientX - (r.left+60), dy = ev.clientY - (r.top+60);
                        const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                        const a = Math.atan2(dy,dx);
                        const fx = Math.cos(a)*d, fy = Math.sin(a)*d;
                        document.getElementById('stick').style.transform=`translate(${fx}px,${fy}px)`;
                        Game.inputs.x = fx/40; Game.inputs.y = fy/40;
                    };
                    joy.onpointerup = () => { joy.onpointermove=null; document.getElementById('stick').style.transform='translate(0,0)'; Game.inputs={x:0,y:0}; };
                });

                document.getElementById('jump-btn').addEventListener('pointerdown', e => { e.stopPropagation(); Game.jump(); });
            }
        };
    </script>
</body>
</html>
