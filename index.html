<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V10.0 - AI Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

    <style>
        :root {
            --bg-app: #eef0f3;
            --bg-ribbon: #ffffff;
            --bg-panel: #ffffff;
            --border: #d1d1d1;
            --text-main: #333;
            --accent: #ff3333; /* Kƒ±rmƒ±zƒ± Tema */
            --accent-hover: #fff0f0;
            --toolbar-height: 100px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-app); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; }

        /* --- √úST MEN√ú (YATAY & YAZILI) --- */
        #top-bar {
            height: 30px; background: #cc0000; color: white; display: flex; align-items: center; padding: 0 10px; font-size: 12px;
        }
        #tab-container {
            display: flex; height: 100%;
        }
        .tab-btn {
            padding: 0 15px; height: 100%; display: flex; align-items: center; cursor: pointer;
            border-right: 1px solid rgba(255,255,255,0.2); transition: 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.2); }
        .tab-btn.active { background: var(--bg-ribbon); color: #333; font-weight: bold; border-top: 3px solid transparent; }

        /* RIBBON ARA√áLARI */
        #ribbon {
            height: var(--toolbar-height); background: var(--bg-ribbon); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 5px 10px; overflow-x: auto; gap: 10px;
        }
        .tool-section { display: none; gap: 5px; height: 100%; align-items: center; }
        .tool-section.active { display: flex; }
        
        .ribbon-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 55px; height: 80px; border: 1px solid transparent; border-radius: 4px;
            cursor: pointer; transition: 0.2s; color: #444;
        }
        .ribbon-btn:hover { background: var(--accent-hover); border-color: #ffcccc; }
        .ribbon-btn.active { background: #ffe6e6; border-color: var(--accent); }
        .ribbon-btn span { font-size: 22px; margin-bottom: 5px; }
        .ribbon-btn label { font-size: 11px; text-align: center; }

        /* --- ANA D√úZEN --- */
        #main-layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* TOOLBOX (SOL) */
        #toolbox {
            width: 220px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; position: relative; z-index: 10;
            transition: transform 0.3s;
        }
        #toolbox.closed { transform: translateX(-100%); position: absolute; height: 100%; }
        .panel-head { padding: 8px; background: #f5f5f5; font-weight: bold; font-size: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        #toolbox-content { flex: 1; overflow-y: auto; padding: 5px; }
        .tb-item { padding: 6px; margin-bottom: 2px; cursor: pointer; display: flex; align-items: center; font-size: 12px; border-radius: 3px; }
        .tb-item:hover { background: #eee; }
        .tb-icon { width: 20px; height: 20px; border-radius: 3px; margin-right: 8px; border: 1px solid #ccc; }

        /* VIEWPORT (ORTA) */
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; }
        
        /* SAƒû PANEL (RESIZABLE) */
        #right-panel {
            width: 280px; background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 10;
        }
        .split-v { flex: 1; overflow-y: auto; display: flex; flex-direction: column; min-height: 100px; }
        #prop-content { padding: 5px; }
        .prop-row { display: flex; margin-bottom: 4px; align-items: center; font-size: 11px; }
        .prop-label { width: 40%; color: #666; }
        .prop-input { width: 60%; border: 1px solid #ccc; padding: 2px; }

        /* OYUN KONTROLLERƒ∞ (Gƒ∞ZLƒ∞) */
        #game-hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 100; }
        #joystick-area { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joystick-knob { width: 50px; height: 50px; background: white; border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #jump-btn { position: absolute; bottom: 80px; right: 40px; width: 80px; height: 80px; background: rgba(255,50,50,0.8); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        
        /* ARA√á ETKƒ∞LE≈ûƒ∞M BUTONU (Bƒ∞NMEK ƒ∞√áƒ∞N) */
        #interact-btn {
            position: absolute; bottom: 180px; right: 40px; width: 60px; height: 60px;
            background: #ffff00; border-radius: 50%; pointer-events: auto; display: none;
            align-items: center; justify-content: center; font-size: 24px; border: 3px solid #000; cursor: pointer;
        }

        /* X MENU (AYARLAR) */
        #x-menu-btn { 
            position: absolute; top: 60px; left: 10px; width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); color: white; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 200;
        }
        #x-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 2000; display: none; align-items: flex-end; justify-content: center;
        }
        #x-panel {
            width: 100%; max-width: 600px; height: 60%; background: rgba(255,255,255,0.95);
            border-radius: 20px 20px 0 0; padding: 20px; display: flex; flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .x-btn { width: 100%; padding: 12px; margin: 5px 0; background: #eee; border: none; border-radius: 8px; text-align: left; font-size: 16px; cursor: pointer; }
        .x-btn:hover { background: #ddd; }

        /* Gƒ∞ZLƒ∞ INPUTLAR */
        #obj-input { display: none; }
    </style>
</head>
<body onload="LunX.init()">

    <div id="top-bar">
        <div style="font-weight:bold; margin-right:20px;">LunX Studio</div>
        <div id="tab-container">
            <div class="tab-btn active" onclick="UI.setTab('home')">Home</div>
            <div class="tab-btn" onclick="UI.setTab('model')">Model</div>
            <div class="tab-btn" onclick="UI.setTab('terrain')">Terrain</div>
            <div class="tab-btn" onclick="UI.setTab('view')">View</div>
            <div class="tab-btn" onclick="UI.setTab('ai')">‚ú® AI</div>
        </div>
    </div>

    <div id="ribbon">
        <div id="sec-home" class="tool-section active">
            <div class="ribbon-btn" onclick="Tools.setMode('select')"><span>üëÜ</span><label>Se√ß</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('translate')"><span>‚ÜîÔ∏è</span><label>Ta≈üƒ±</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('scale')"><span>‚§¢</span><label>Boyut</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('rotate')"><span>üîÑ</span><label>D√∂nd√ºr</label></div>
            <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
            <div class="ribbon-btn" onclick="Game.play()"><span style="color:green">‚ñ∂Ô∏è</span><label>Oyna</label></div>
            <div class="ribbon-btn" onclick="Game.stop()"><span style="color:red">‚èπÔ∏è</span><label>Durdur</label></div>
        </div>
        
        <div id="sec-model" class="tool-section">
            <div class="ribbon-btn" onclick="World.add('box')"><span>üì¶</span><label>Part</label></div>
            <div class="ribbon-btn" onclick="World.add('sphere')"><span>‚ö™</span><label>Sphere</label></div>
            <div class="ribbon-btn" onclick="World.add('cylinder')"><span>üõ¢Ô∏è</span><label>Cyl</label></div>
            <div class="ribbon-btn" onclick="World.add('wedge')"><span>üìê</span><label>Wedge</label></div>
            <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
            <div class="ribbon-btn" onclick="World.importOBJ()"><span>üìÇ</span><label>OBJ Y√ºkle</label></div>
            <div class="ribbon-btn" onclick="World.add('spawn')"><span>üö©</span><label>Spawn</label></div>
            <div class="ribbon-btn" onclick="World.add('light')"><span>üí°</span><label>I≈üƒ±k</label></div>
            <div class="ribbon-btn" onclick="World.add('neon')"><span>‚ú®</span><label>Neon</label></div>
            <div class="ribbon-btn" onclick="World.add('damage')"><span>üíÄ</span><label>Hasar</label></div>
        </div>
        
        <div id="sec-terrain" class="tool-section">
            <div class="ribbon-btn" onclick="alert('Sculpt Modu Aktif (Vertex)')"><span>‚õ∞Ô∏è</span><label>Sculpt</label></div>
            <div class="ribbon-btn" onclick="World.setSky('day')"><span>‚òÄÔ∏è</span><label>G√ºnd√ºz</label></div>
            <div class="ribbon-btn" onclick="World.setSky('night')"><span>üåô</span><label>Gece</label></div>
        </div>

        <div id="sec-view" class="tool-section">
            <div class="ribbon-btn" onclick="UI.toggle('toolbox')"><span>üß∞</span><label>Toolbox</label></div>
            <div class="ribbon-btn" onclick="UI.toggle('properties')"><span>üìù</span><label>Props</label></div>
        </div>

        <div id="sec-ai" class="tool-section">
            <div class="ribbon-btn" style="width:100px; border:2px solid gold; background:#fffbe6;" onclick="AI.prompt()">
                <span>ü§ñ</span><label>AI Build</label>
            </div>
        </div>
    </div>

    <div id="x-menu-btn" onclick="UI.openXMenu()">‚öôÔ∏è</div>

    <div id="x-overlay" onclick="if(event.target==this) UI.closeXMenu()">
        <div id="x-panel">
            <h2 style="margin:0 0 20px 0; color:#333;">Ayarlar & Men√º</h2>
            <button class="x-btn" onclick="App.reset()">üîÅ Sahneyi Sƒ±fƒ±rla</button>
            <button class="x-btn" onclick="alert('Kaydedildi!')">üíæ Kaydet</button>
            
            <label style="margin-top:10px; font-weight:bold;">Grafik Kalitesi (1-15)</label>
            <input type="range" min="0.5" max="2" step="0.1" style="width:100%" onchange="App.setQuality(this.value)">
            
            <label style="margin-top:10px; font-weight:bold;">UI √ñl√ßeƒüi (K√º√ß√ºk/B√ºy√ºk)</label>
            <input type="range" min="0.7" max="1.2" step="0.1" style="width:100%" onchange="UI.setScale(this.value)">
            
            <button class="x-btn" style="margin-top:auto; background:#ffcccc; color:red;" onclick="UI.closeXMenu()">Kapat</button>
        </div>
    </div>

    <div id="main-layout">
        
        <div id="toolbox">
            <div class="panel-head">Toolbox <span style="cursor:pointer" onclick="UI.toggle('toolbox')">‚úï</span></div>
            <div id="toolbox-content">
                </div>
        </div>

        <div id="viewport">
            <div id="game-hud">
                <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px;">
                    <div style="width:150px; height:15px; background:#333; border:1px solid white;">
                        <div id="hp-bar" style="width:100%; height:100%; background:#00ff00;"></div>
                    </div>
                </div>
                
                <div id="joystick-area"><div id="joystick-knob"></div></div>
                <div id="jump-btn">‚¨Ü</div>
                <div id="interact-btn">üöó</div> </div>
        </div>

        <div id="right-panel">
            <div class="split-v" style="border-bottom:1px solid #ccc;">
                <div class="panel-head">Explorer</div>
                <div id="explorer" style="padding:5px; font-size:12px;"></div>
            </div>
            <div class="split-v">
                <div class="panel-head">Properties</div>
                <div id="prop-content"></div>
            </div>
        </div>

    </div>

    <input type="file" id="obj-input" accept=".obj">
    <input type="file" id="tex-input" accept="image/*">

    <script>
        /**
         * LunX Studio V10.0 - AI & Physics Edition
         * Features: R6 Char, Car Physics, AI Builder, OBJ Load, Full Tools
         */
        
        const LunX = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            objects: [], selected: null, isPlaying: false,
            
            // Game Vars
            player: null,
            vehicle: null, // Aktif ara√ß
            health: 100,
            
            // Inputs
            joy: { x:0, y:0, active:false },
            keys: {},

            init: () => {
                ThreeEngine.init();
                UI.initToolbox();
                
                // Listeners
                window.addEventListener('resize', ThreeEngine.resize);
                window.addEventListener('keydown', e => LunX.keys[e.key.toLowerCase()] = true);
                window.addEventListener('keyup', e => LunX.keys[e.key.toLowerCase()] = false);

                // Joystick
                const joy = document.getElementById('joystick-area');
                joy.addEventListener('touchstart', Game.joyStart, {passive:false});
                joy.addEventListener('touchmove', Game.joyMove, {passive:false});
                joy.addEventListener('touchend', Game.joyEnd);
                
                // Jump
                document.getElementById('jump-btn').addEventListener('touchstart', Game.jump);
                document.getElementById('jump-btn').addEventListener('mousedown', Game.jump);
                
                // Interact (Car)
                document.getElementById('interact-btn').addEventListener('click', Game.exitVehicle);

                // Texture upload listener
                document.getElementById('tex-input').addEventListener('change', World.onTextureUpload);
                document.getElementById('obj-input').addEventListener('change', World.onOBJUpload);
            }
        };

        const ThreeEngine = {
            init: () => {
                const vp = document.getElementById('viewport');
                LunX.scene = new THREE.Scene();
                LunX.scene.background = new THREE.Color(0x87CEEB);
                LunX.scene.fog = new THREE.Fog(0x87CEEB, 50, 500);

                LunX.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 2000);
                LunX.camera.position.set(15, 15, 15);

                LunX.renderer = new THREE.WebGLRenderer({ antialias: true });
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
                LunX.renderer.shadowMap.enabled = true;
                vp.appendChild(LunX.renderer.domElement);

                // Lights
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                LunX.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 1);
                dir.position.set(50, 100, 50);
                dir.castShadow = true;
                dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
                LunX.scene.add(dir);

                // Controls
                LunX.controls = new THREE.OrbitControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform = new THREE.TransformControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform.addEventListener('dragging-changed', e => LunX.controls.enabled = !e.value);
                LunX.scene.add(LunX.transform);

                // Raycaster
                vp.addEventListener('mousedown', Tools.onSelect);
                vp.addEventListener('touchstart', Tools.onSelect, {passive:false});

                // Baseplate
                World.add('baseplate');

                ThreeEngine.loop();
            },
            resize: () => {
                const vp = document.getElementById('viewport');
                LunX.camera.aspect = vp.clientWidth / vp.clientHeight;
                LunX.camera.updateProjectionMatrix();
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },
            loop: () => {
                requestAnimationFrame(ThreeEngine.loop);
                if(LunX.isPlaying) Game.update();
                else LunX.controls.update();
                LunX.renderer.render(LunX.scene, LunX.camera);
            }
        };

        const World = {
            add: (type, opts={}) => {
                let geo, mat = new THREE.MeshStandardMaterial({color: opts.color || Math.random()*0xffffff});
                
                if(type==='baseplate') {
                    geo = new THREE.BoxGeometry(500, 1, 500);
                    mat.color.setHex(0x555555);
                } else if(type==='sphere') geo = new THREE.SphereGeometry(2,32,32);
                else if(type==='cylinder') geo = new THREE.CylinderGeometry(2,2,4,32);
                else if(type==='wedge') geo = new THREE.ConeGeometry(2,4,4);
                else geo = new THREE.BoxGeometry(4,4,4);

                if(type === 'neon') mat = new THREE.MeshBasicMaterial({color:0x00ffff});
                if(type === 'damage') { mat.color.setHex(0xff0000); opts.damage = 10; }

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(opts.pos || new THREE.Vector3(0, 10, 0));
                if(type==='baseplate') { mesh.position.y = -0.5; mesh.name="Baseplate"; mesh.userData.locked=true; }
                else mesh.name = opts.name || "Part";

                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.userData = { 
                    anchored: type==='baseplate', // Varsayƒ±lan anchor kapalƒ± (d√º≈üs√ºn diye), baseplate hari√ß
                    canCollide: true,
                    damage: opts.damage || 0,
                    velocity: new THREE.Vector3()
                };

                if(type==='spawn') {
                    mesh.scale.set(2, 0.1, 2); mesh.userData.anchored=true; mesh.name="SpawnLocation"; mesh.material.color.setHex(0xaaaaaa);
                }
                
                // I≈üƒ±k eklentisi
                if(type==='light') {
                    const l = new THREE.PointLight(0xffaa00, 1, 20);
                    mesh.add(l); mesh.material.emissive = new THREE.Color(0xffaa00);
                    mesh.userData.anchored = true; // I≈üƒ±klar havada kalsƒ±n
                }

                LunX.scene.add(mesh);
                LunX.objects.push(mesh);
                UI.refreshExplorer();
                return mesh;
            },

            importOBJ: () => document.getElementById('obj-input').click(),
            onOBJUpload: (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const loader = new THREE.OBJLoader();
                    const obj = loader.parse(ev.target.result);
                    obj.position.set(0, 10, 0);
                    obj.traverse(c => { if(c.isMesh) { c.castShadow=true; c.material=new THREE.MeshStandardMaterial({color:0xcccccc}); } });
                    obj.name = "ImportedModel";
                    obj.userData = { anchored: true, velocity: new THREE.Vector3() };
                    LunX.scene.add(obj);
                    LunX.objects.push(obj);
                    UI.refreshExplorer();
                };
                reader.readAsText(file);
            },

            uploadTexture: () => document.getElementById('tex-input').click(),
            onTextureUpload: (e) => {
                if(!LunX.selected) return alert("√ñnce bir par√ßa se√ßin!");
                const file = e.target.files[0];
                if(file) {
                    const url = URL.createObjectURL(file);
                    new THREE.TextureLoader().load(url, (tex) => {
                        LunX.selected.material.map = tex;
                        LunX.selected.material.needsUpdate = true;
                    });
                }
            },

            setSky: (time) => {
                LunX.scene.background = new THREE.Color(time==='day' ? 0x87CEEB : 0x000022);
                LunX.scene.fog.color = LunX.scene.background;
            }
        };

        const AI = {
            prompt: () => {
                const req = prompt("Yapay Zeka Build: Ne olu≈üturmak istersin? (√ñrn: 'araba', 'ev', 'duvar')");
                if(!req) return;
                
                const text = req.toLowerCase();
                
                if(text.includes("araba") || text.includes("car")) {
                    AI.buildCar();
                } else if(text.includes("ev") || text.includes("house")) {
                    AI.buildHouse();
                } else if(text.includes("duvar")) {
                    const w = World.add('box', {pos: new THREE.Vector3(5, 5, 0)});
                    w.scale.set(10, 5, 1);
                } else {
                    alert("AI: Hen√ºz bunu yapmayƒ± √∂ƒürenmedim. 'araba' veya 'ev' dene.");
                }
            },

            buildCar: () => {
                // Basit bir araba grubu olu≈ütur
                const carGroup = new THREE.Group();
                carGroup.name = "AI_Car";
                
                const body = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 8), new THREE.MeshPhongMaterial({color:0xff0000}));
                body.position.y = 1;
                carGroup.add(body);
                
                const wheels = [
                    {x:-2.2, z:2.5}, {x:2.2, z:2.5}, {x:-2.2, z:-2.5}, {x:2.2, z:-2.5}
                ];
                wheels.forEach(pos => {
                    const w = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.5, 16), new THREE.MeshStandardMaterial({color:0x222222}));
                    w.rotation.z = Math.PI/2;
                    w.position.set(pos.x, 0.8, pos.z);
                    carGroup.add(w);
                });
                
                carGroup.position.set(10, 5, 10);
                carGroup.userData = { 
                    isVehicle: true, 
                    velocity: new THREE.Vector3(), 
                    rotSpeed: 0,
                    anchored: false // Fizikten etkilensin
                };
                
                LunX.scene.add(carGroup);
                LunX.objects.push(carGroup);
                alert("AI: Araba olu≈üturuldu! Yanƒ±na gidip 'Oyna' modunda binebilirsin.");
            },

            buildHouse: () => {
                // Basit ev
                const h = new THREE.Group(); h.name = "AI_House";
                const wallMat = new THREE.MeshStandardMaterial({color: 0xddccaa});
                const roofMat = new THREE.MeshStandardMaterial({color: 0x884444});
                
                const box = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), wallMat); box.position.y = 4;
                const roof = new THREE.Mesh(new THREE.ConeGeometry(9, 4, 4), roofMat); 
                roof.position.y = 10; roof.rotation.y = Math.PI/4;
                
                h.add(box); h.add(roof);
                h.position.set(-10, 0, -10);
                h.userData = { anchored: true };
                
                LunX.scene.add(h);
                LunX.objects.push(h);
            }
        };

        const Tools = {
            onSelect: (e) => {
                if(LunX.isPlaying) return;
                e.preventDefault();
                
                const rect = LunX.renderer.domElement.getBoundingClientRect();
                const x = ((e.clientX || e.touches[0].clientX) - rect.left) / rect.width * 2 - 1;
                const y = -((e.clientY || e.touches[0].clientY) - rect.top) / rect.height * 2 + 1;
                
                const ray = new THREE.Raycaster();
                ray.setFromCamera({x,y}, LunX.camera);
                const hits = ray.intersectObjects(LunX.objects);
                
                if(hits.length > 0) {
                    LunX.selected = hits[0].object;
                    if(!LunX.selected.userData.locked) LunX.transform.attach(LunX.selected);
                    else LunX.transform.detach();
                } else {
                    LunX.selected = null;
                    LunX.transform.detach();
                }
                UI.updateProps();
                UI.refreshExplorer();
            },
            setMode: (m) => {
                if(m==='select') LunX.transform.detach();
                else {
                    LunX.transform.setMode(m);
                    if(LunX.selected) LunX.transform.attach(LunX.selected);
                }
                document.querySelectorAll('.ribbon-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('tool-'+m).classList.add('active');
            }
        };

        const Game = {
            play: () => {
                if(LunX.isPlaying) return;
                LunX.isPlaying = true;
                LunX.transform.detach();
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('right-panel').style.display = 'none';
                document.getElementById('game-hud').style.display = 'block';
                
                // R6 Character Spawn
                const grp = new THREE.Group();
                const mat = new THREE.MeshPhongMaterial({color:0x0088ff});
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), new THREE.MeshPhongMaterial({color:0xffcc00})); head.position.y = 4.6;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), mat); torso.position.y = 3;
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshPhongMaterial({color:0x444})); ll.position.set(-0.5,1,0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshPhongMaterial({color:0x444})); rl.position.set(0.5,1,0);
                
                grp.add(head, torso, ll, rl);
                
                const spawn = LunX.objects.find(o=>o.name==="SpawnLocation");
                grp.position.copy(spawn ? spawn.position : new THREE.Vector3(0,5,0));
                grp.position.y += 2;
                
                grp.userData = { velocity: new THREE.Vector3(), onGround: false, limbs: {ll, rl} };
                LunX.player = grp;
                LunX.scene.add(grp);
                
                // Camera
                LunX.controls.enablePan = false;
                LunX.controls.maxDistance = 20;
                LunX.controls.minDistance = 4;
            },
            
            stop: () => {
                LunX.isPlaying = false;
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('right-panel').style.display = 'flex';
                document.getElementById('game-hud').style.display = 'none';
                document.getElementById('interact-btn').style.display = 'none';
                
                if(LunX.player) LunX.scene.remove(LunX.player);
                LunX.player = null;
                LunX.vehicle = null;
                
                LunX.camera.position.set(20,20,20);
                LunX.controls.target.set(0,0,0);
                LunX.controls.enablePan = true;
                
                // Reset objects position (simple way)
                LunX.objects.forEach(o => { if(!o.userData.anchored) o.position.set(0,10,0); }); // Reset falling parts
            },

            update: () => {
                // 1. Player Physics (or Vehicle)
                let target = LunX.player;
                let speed = 0.3;
                
                if(LunX.vehicle) {
                    target = LunX.vehicle;
                    speed = 1.0; // Car speed
                    // Car logic: move forward based on rotation
                }

                if(target) {
                    const v = target.userData.velocity;
                    
                    // Gravity
                    if(!LunX.vehicle || !target.userData.onGround) v.y -= 0.02;
                    target.position.y += v.y;
                    
                    // Floor Check (Baseplate)
                    if(target.position.y <= 2) { // Simple ground check
                        target.position.y = 2;
                        v.y = 0;
                        target.userData.onGround = true;
                    }

                    // Movement
                    if(LunX.joy.active) {
                        const camAng = LunX.controls.getAzimuthalAngle();
                        const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                        const right = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                        
                        if(LunX.vehicle) {
                            // Vehicle controls (Tank controls for simplicity)
                            target.translateX(LunX.joy.y * -speed);
                            target.rotation.y -= LunX.joy.x * 0.05;
                        } else {
                            // Character controls
                            const move = fwd.multiplyScalar(-LunX.joy.y).add(right.multiplyScalar(LunX.joy.x));
                            target.position.add(move.multiplyScalar(speed));
                            target.lookAt(target.position.clone().add(move));
                            
                            // Anim
                            const t = Date.now()*0.02;
                            target.userData.limbs.ll.rotation.x = Math.sin(t);
                            target.userData.limbs.rl.rotation.x = -Math.sin(t);
                        }
                    }
                    
                    // Vehicle interaction check
                    if(!LunX.vehicle) {
                        const cars = LunX.objects.filter(o => o.userData.isVehicle);
                        let nearCar = false;
                        cars.forEach(car => {
                            if(target.position.distanceTo(car.position) < 8) {
                                nearCar = true;
                                document.getElementById('interact-btn').style.display = 'flex';
                                document.getElementById('interact-btn').onclick = () => Game.enterVehicle(car);
                            }
                        });
                        if(!nearCar) document.getElementById('interact-btn').style.display = 'none';
                    }

                    // Camera Follow
                    LunX.controls.target.lerp(target.position, 0.1);
                }

                // 2. Object Physics (Falling parts)
                LunX.objects.forEach(obj => {
                    if(!obj.userData.anchored && obj !== LunX.vehicle) {
                        obj.position.y -= 0.1;
                        if(obj.position.y < 2) obj.position.y = 2;
                        
                        // Simple Player Collision (Push)
                        if(LunX.player && LunX.player.position.distanceTo(obj.position) < 3) {
                             const pushDir = obj.position.clone().sub(LunX.player.position).normalize();
                             obj.position.add(pushDir.multiplyScalar(0.2));
                        }
                    }
                    // Damage Logic
                    if(obj.userData.damage > 0 && LunX.player) {
                        if(LunX.player.position.distanceTo(obj.position) < 3) {
                            LunX.health -= 1;
                            document.getElementById('hp-bar').style.width = LunX.health + '%';
                        }
                    }
                });
            },

            enterVehicle: (car) => {
                LunX.vehicle = car;
                LunX.scene.remove(LunX.player); // Hide player inside car
                document.getElementById('interact-btn').innerHTML = 'üö∂';
                document.getElementById('interact-btn').onclick = Game.exitVehicle;
            },
            
            exitVehicle: () => {
                if(!LunX.vehicle) return;
                LunX.player.position.copy(LunX.vehicle.position).add(new THREE.Vector3(3,0,0));
                LunX.scene.add(LunX.player);
                LunX.vehicle = null;
                document.getElementById('interact-btn').innerHTML = 'üöó';
                document.getElementById('interact-btn').style.display = 'none';
            },

            // Inputs
            joyStart: (e) => { LunX.joy.active = true; Game.joyMove(e); },
            joyMove: (e) => {
                const rect = document.getElementById('joystick-zone').getBoundingClientRect();
                const cx = rect.left+60; const cy=rect.top+60;
                const tx = e.touches[0].clientX; const ty = e.touches[0].clientY;
                let dx = tx-cx; let dy=ty-cy;
                const d = Math.sqrt(dx*dx+dy*dy);
                if(d>40) { const a=Math.atan2(dy,dx); dx=Math.cos(a)*40; dy=Math.sin(a)*40; }
                document.getElementById('joystick-knob').style.transform=`translate(${dx}px, ${dy}px)`;
                LunX.joy.x = dx/40; LunX.joy.y = dy/40;
            },
            joyEnd: () => { LunX.joy.active=false; LunX.joy.x=0; LunX.joy.y=0; document.getElementById('joystick-knob').style.transform='translate(0,0)'; },
            jump: (e) => { if(e) e.preventDefault(); if(LunX.player) LunX.player.userData.velocity.y = 0.8; }
        };

        const UI = {
            setTab: (tabId) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
                document.getElementById('sec-'+tabId).classList.add('active');
            },
            toggle: (panelId) => document.getElementById(panelId).classList.toggle('closed'), // Toolbox slide
            openXMenu: () => document.getElementById('x-overlay').style.display = 'flex',
            closeXMenu: () => document.getElementById('x-overlay').style.display = 'none',
            
            updateProps: () => {
                const p = document.getElementById('prop-content');
                p.innerHTML = '';
                if(!LunX.selected) return;
                const obj = LunX.selected;
                
                const row = (lbl, val, type, cb) => {
                    const div = document.createElement('div'); div.className='prop-row';
                    div.innerHTML = `<div class="prop-label">${lbl}</div>`;
                    const inp = document.createElement('input'); inp.className='prop-input';
                    inp.type = type;
                    if(type==='checkbox') inp.checked = val; else inp.value = val;
                    inp.onchange = e => cb(type==='checkbox'?e.target.checked:e.target.value);
                    div.appendChild(inp); p.appendChild(div);
                };
                
                row("Name", obj.name, 'text', v=>obj.name=v);
                if(!obj.userData.locked) {
                    row("Anchored", obj.userData.anchored, 'checkbox', v=>obj.userData.anchored=v);
                    row("Color", '#'+obj.material.color.getHexString(), 'color', v=>obj.material.color.set(v));
                    const btn = document.createElement('button'); btn.innerText="Texture"; btn.onclick=World.uploadTexture;
                    p.appendChild(btn);
                }
            },
            refreshExplorer: () => {
                const ex = document.getElementById('explorer'); ex.innerHTML = '';
                LunX.objects.forEach(o => {
                    const d = document.createElement('div');
                    d.innerText = o.name; d.style.padding='2px'; d.style.cursor='pointer';
                    if(o === LunX.selected) d.style.background='#cce5ff';
                    d.onclick = () => Tools.onSelect({custom: o});
                    ex.appendChild(d);
                });
            },
            initToolbox: () => {
                const tb = document.getElementById('toolbox-content');
                const items = [
                    {name:"Neon Red", type:"neon", color:0xff0000},
                    {name:"Tree Log", type:"cylinder", color:0x654321},
                    {name:"Brick Wall", type:"box", color:0xaa5555},
                    {name:"Glass", type:"glass", color:0xaaccff},
                    {name:"Killer", type:"damage", color:0xff0000}
                ];
                // Generate 30 fake items
                for(let i=0;i<25;i++) items.push({name:`Block ${i}`, type:'box', color:Math.random()*0xffffff});
                
                items.forEach(it => {
                    const el = document.createElement('div');
                    el.className='tb-item';
                    el.innerHTML = `<div class="tb-icon" style="background:#${new THREE.Color(it.color).getHexString()}"></div>${it.name}`;
                    el.onclick = () => { if(it.type==='neon'||it.type==='glass'||it.type==='damage') World.addSpecial(it.type); else World.add(it.type, {color:it.color}); };
                    tb.appendChild(el);
                });
            }
        };

        const App = {
            reset: () => location.reload(),
            setQuality: (v) => LunX.renderer.setPixelRatio(window.devicePixelRatio * v)
        };
    </script>
</body>
</html>
