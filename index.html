<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V10.0 - AI & Fix Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

    <style>
        :root {
            --bg-app: #eef0f3;
            --bg-ribbon: #ffffff;
            --bg-panel: #ffffff;
            --border: #d1d1d1;
            --text-main: #333;
            --accent: #ff3333; /* Kƒ±rmƒ±zƒ± Tema */
            --accent-hover: #fff0f0;
            --toolbar-height: 100px;
            --ui-scale: 1; /* UI Boyutlandƒ±rma i√ßin */
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-app); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; }

        /* UI SCALING WRAPPER (Ayarlar i√ßin) */
        .ui-scalable { zoom: var(--ui-scale); }

        /* --- √úST MEN√ú --- */
        #top-bar {
            height: 30px; background: #cc0000; color: white; display: flex; align-items: center; padding: 0 10px; font-size: 12px;
            padding-left: 50px; /* X butonu i√ßin yer */
        }
        #tab-container { display: flex; height: 100%; }
        .tab-btn {
            padding: 0 15px; height: 100%; display: flex; align-items: center; cursor: pointer;
            border-right: 1px solid rgba(255,255,255,0.2); transition: 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.2); }
        .tab-btn.active { background: var(--bg-ribbon); color: #333; font-weight: bold; border-top: 3px solid transparent; }

        /* RIBBON */
        #ribbon {
            height: var(--toolbar-height); background: var(--bg-ribbon); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 5px 10px; overflow-x: auto; gap: 10px;
        }
        .tool-section { display: none; gap: 5px; height: 100%; align-items: center; }
        .tool-section.active { display: flex; }
        
        .ribbon-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 55px; height: 80px; border: 1px solid transparent; border-radius: 4px;
            cursor: pointer; transition: 0.2s; color: #444;
        }
        .ribbon-btn:hover { background: var(--accent-hover); border-color: #ffcccc; }
        .ribbon-btn.active { background: #ffe6e6; border-color: var(--accent); }
        .ribbon-btn span { font-size: 22px; margin-bottom: 5px; }
        .ribbon-btn label { font-size: 11px; text-align: center; }

        /* --- ANA D√úZEN --- */
        #main-layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* SOL PANEL */
        #toolbox {
            width: 220px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; position: relative; z-index: 10;
            transition: transform 0.3s;
        }
        #toolbox.closed { transform: translateX(-100%); position: absolute; height: 100%; }
        .panel-head { padding: 8px; background: #f5f5f5; font-weight: bold; font-size: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        #toolbox-content { flex: 1; overflow-y: auto; padding: 5px; }
        .tb-item { padding: 6px; margin-bottom: 2px; cursor: pointer; display: flex; align-items: center; font-size: 12px; border-radius: 3px; }
        .tb-item:hover { background: #eee; }
        .tb-icon { width: 20px; height: 20px; border-radius: 3px; margin-right: 8px; border: 1px solid #ccc; }

        /* ORTA EKRAN */
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; }
        
        /* SAƒû PANEL */
        #right-panel {
            width: 280px; background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 10;
        }
        .split-v { flex: 1; overflow-y: auto; display: flex; flex-direction: column; min-height: 100px; }
        #prop-content { padding: 5px; }
        .prop-row { display: flex; margin-bottom: 4px; align-items: center; font-size: 11px; }
        .prop-label { width: 40%; color: #666; }
        .prop-input { width: 60%; border: 1px solid #ccc; padding: 2px; }

        /* OYUN HUD */
        #game-hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 100; }
        #joystick-area { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.5); }
        #joystick-knob { width: 50px; height: 50px; background: white; border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #jump-btn { position: absolute; bottom: 80px; right: 40px; width: 80px; height: 80px; background: rgba(255,50,50,0.8); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        #interact-btn { position: absolute; bottom: 180px; right: 40px; width: 60px; height: 60px; background: #ffff00; border-radius: 50%; pointer-events: auto; display: none; align-items: center; justify-content: center; font-size: 24px; border: 3px solid #000; cursor: pointer; }

        /* X BUTTON & MENU */
        #x-btn {
            position: absolute; top: 5px; left: 10px; width: 30px; height: 30px;
            background: #333; color: white; border: 2px solid white; border-radius: 5px;
            font-weight: bold; cursor: pointer; z-index: 2000; display: flex; align-items: center; justify-content: center;
        }
        #x-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            z-index: 2001; display: none; align-items: center; justify-content: center;
        }
        #x-settings-panel {
            width: 300px; background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 3px solid var(--accent);
        }
        .setting-row { margin-bottom: 15px; }
        .setting-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .setting-range { width: 100%; }

        /* LUNAIX CHAT UI */
        #lunaix-chat {
            position: absolute; bottom: 10px; right: 10px; width: 300px; height: 350px;
            background: white; border: 2px solid var(--accent); border-radius: 10px 10px 0 0;
            display: flex; flex-direction: column; z-index: 150; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: 0.3s; transform: translateY(0);
        }
        #lunaix-chat.minimized { transform: translateY(310px); }
        #chat-header { background: var(--accent); color: white; padding: 10px; font-weight: bold; cursor: pointer; display:flex; justify-content:space-between; }
        #chat-messages { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; font-size: 12px; }
        .chat-msg { margin-bottom: 8px; padding: 8px; border-radius: 6px; max-width: 85%; }
        .chat-msg.ai { background: #eef; border: 1px solid #dde; color: #333; }
        .chat-msg.user { background: #ffdcdc; border: 1px solid #ffcccc; color: #333; margin-left: auto; }
        #chat-input-area { display: flex; padding: 5px; border-top: 1px solid #ccc; }
        #chat-input { flex: 1; padding: 5px; border: 1px solid #ddd; outline: none; }
        #chat-send { background: var(--accent); color: white; border: none; padding: 0 10px; cursor: pointer; }

        /* Gƒ∞ZLƒ∞LER */
        #obj-input, #tex-input { display: none; }
    </style>
</head>
<body onload="LunX.init()">

    <div id="x-btn" onclick="Settings.toggle()">X</div>

    <div id="x-menu-overlay" onclick="if(event.target==this) Settings.toggle()">
        <div id="x-settings-panel">
            <h3 style="margin-top:0; color:var(--accent);">Ayarlar</h3>
            
            <div class="setting-row">
                <label class="setting-label">UI Panel Boyutu</label>
                <input type="range" class="setting-range" min="0.5" max="1.5" step="0.1" value="1" onchange="Settings.setScale(this.value)">
            </div>

            <div class="setting-row">
                <label class="setting-label">Grafik Kalitesi</label>
                <input type="range" class="setting-range" min="0.5" max="2" step="0.5" value="1" onchange="Settings.setQuality(this.value)">
            </div>

            <div class="setting-row">
                <button onclick="location.reload()" style="width:100%; padding:10px; background:#333; color:white; border:none;">Sahneyi Sƒ±fƒ±rla</button>
            </div>
        </div>
    </div>

    <div id="top-bar" class="ui-scalable">
        <div style="font-weight:bold; margin-right:20px;">LunX Studio V10.0</div>
        <div id="tab-container">
            <div class="tab-btn active" onclick="UI.setTab('home')">Home</div>
            <div class="tab-btn" onclick="UI.setTab('model')">Model</div>
            <div class="tab-btn" onclick="UI.setTab('view')">View</div>
        </div>
    </div>

    <div id="ribbon" class="ui-scalable">
        <div id="sec-home" class="tool-section active">
            <div class="ribbon-btn" onclick="Tools.setMode('select')"><span>üëÜ</span><label>Se√ß</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('translate')"><span>‚ÜîÔ∏è</span><label>Ta≈üƒ±</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('scale')"><span>‚§¢</span><label>Boyut</label></div>
            <div class="ribbon-btn" onclick="Tools.setMode('rotate')"><span>üîÑ</span><label>D√∂nd√ºr</label></div>
            <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
            <div class="ribbon-btn" onclick="Game.play()"><span style="color:green">‚ñ∂Ô∏è</span><label>Oyna</label></div>
            <div class="ribbon-btn" onclick="Game.stop()"><span style="color:red">‚èπÔ∏è</span><label>Durdur</label></div>
        </div>
        
        <div id="sec-model" class="tool-section">
            <div class="ribbon-btn" onclick="World.add('box')"><span>üì¶</span><label>Part</label></div>
            <div class="ribbon-btn" onclick="World.add('sphere')"><span>‚ö™</span><label>Sphere</label></div>
            <div class="ribbon-btn" onclick="World.add('cylinder')"><span>üõ¢Ô∏è</span><label>Cyl</label></div>
            <div class="ribbon-btn" onclick="World.add('wedge')"><span>üìê</span><label>Wedge</label></div>
            <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
            <div class="ribbon-btn" onclick="World.importOBJ()"><span>üìÇ</span><label>OBJ</label></div>
            <div class="ribbon-btn" onclick="World.add('spawn')"><span>üö©</span><label>Spawn</label></div>
            <div class="ribbon-btn" onclick="World.add('light')"><span>üí°</span><label>I≈üƒ±k</label></div>
            <div class="ribbon-btn" onclick="World.add('neon')"><span>‚ú®</span><label>Neon</label></div>
        </div>
        
        <div id="sec-view" class="tool-section">
            <div class="ribbon-btn" onclick="UI.toggle('toolbox')"><span>üß∞</span><label>Toolbox</label></div>
            <div class="ribbon-btn" onclick="UI.toggle('right-panel')"><span>üìù</span><label>Props</label></div>
        </div>
    </div>

    <div id="main-layout" class="ui-scalable">
        
        <div id="toolbox">
            <div class="panel-head">Toolbox <span style="cursor:pointer" onclick="UI.toggle('toolbox')">‚úï</span></div>
            <div id="toolbox-content"></div>
        </div>

        <div id="viewport">
            <div id="game-hud">
                <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px;">
                    <div style="width:150px; height:15px; background:#333; border:1px solid white;">
                        <div id="hp-bar" style="width:100%; height:100%; background:#00ff00;"></div>
                    </div>
                </div>
                <div id="joystick-area"><div id="joystick-knob"></div></div>
                <div id="jump-btn">‚¨Ü</div>
                <div id="interact-btn">üöó</div> 
            </div>

            <div id="lunaix-chat">
                <div id="chat-header" onclick="document.getElementById('lunaix-chat').classList.toggle('minimized')">
                    <span>ü§ñ LunAIX Chat</span>
                    <span>‚ñº</span>
                </div>
                <div id="chat-messages">
                    <div class="chat-msg ai">Merhaba! Bana "Lego ev yap" veya "Kƒ±rmƒ±zƒ± araba olu≈ütur" diyebilirsin.</div>
                </div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Bir ≈üeyler yaz..." onkeydown="if(event.key==='Enter') AI.send()">
                    <button id="chat-send" onclick="AI.send()">‚û§</button>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div class="split-v" style="border-bottom:1px solid #ccc;">
                <div class="panel-head">Explorer</div>
                <div id="explorer" style="padding:5px; font-size:12px;"></div>
            </div>
            <div class="split-v">
                <div class="panel-head">Properties</div>
                <div id="prop-content"></div>
            </div>
        </div>

    </div>

    <input type="file" id="obj-input" accept=".obj">
    <input type="file" id="tex-input" accept="image/*">

    <script>
        // --- SETTINGS MODULE (X BUTTON) ---
        const Settings = {
            toggle: () => {
                const el = document.getElementById('x-menu-overlay');
                el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            },
            setScale: (val) => {
                document.documentElement.style.setProperty('--ui-scale', val);
            },
            setQuality: (val) => {
                LunX.renderer.setPixelRatio(window.devicePixelRatio * val);
            }
        };

        // --- AI MODULE (LUNAIX) ---
        const AI = {
            send: () => {
                const inp = document.getElementById('chat-input');
                const txt = inp.value.trim();
                if(!txt) return;
                AI.log(txt, 'user');
                inp.value = '';
                setTimeout(() => AI.process(txt.toLowerCase()), 500);
            },
            log: (msg, type) => {
                const box = document.getElementById('chat-messages');
                const d = document.createElement('div');
                d.className = `chat-msg ${type}`;
                d.innerText = msg;
                box.appendChild(d);
                box.scrollTop = box.scrollHeight;
            },
            process: (txt) => {
                let color = 0xcccccc;
                if(txt.includes('kƒ±rmƒ±zƒ±')) color = 0xff0000;
                if(txt.includes('mavi')) color = 0x0000ff;
                if(txt.includes('ye≈üil')) color = 0x00ff00;
                if(txt.includes('sarƒ±')) color = 0xffff00;
                if(txt.includes('siyah')) color = 0x111111;

                let isLego = txt.includes('lego');

                if(txt.includes('ev') || txt.includes('house')) {
                    AI.buildHouse(color, isLego);
                    AI.log(isLego ? "Lego ev in≈üa edildi!" : "Ev in≈üa edildi.", 'ai');
                } 
                else if(txt.includes('araba') || txt.includes('car')) {
                    AI.buildCar(color, isLego);
                    AI.log("Araba olu≈üturuldu.", 'ai');
                }
                else if(txt.includes('duvar')) {
                    const w = World.add('box', {pos:new THREE.Vector3(5,2,0), color:color, lego:isLego});
                    w.scale.set(10, 4, 1);
                    AI.log("Duvar √∂r√ºld√º.", 'ai');
                }
                else {
                    AI.log("Bunu hen√ºz anlamadƒ±m. 'Ev yap' veya 'Araba' deneyebilirsin.", 'ai');
                }
            },
            createLegoMat: (col) => {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#' + new THREE.Color(col).getHexString();
                ctx.fillRect(0,0,64,64);
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                ctx.beginPath(); ctx.arc(32,32,12,0,Math.PI*2); ctx.fill();
                const tex = new THREE.CanvasTexture(canvas);
                return new THREE.MeshStandardMaterial({map:tex, color:col});
            },
            buildHouse: (col, lego) => {
                const group = new THREE.Group(); group.name = "AI_House";
                // Duvar
                const boxMat = lego ? AI.createLegoMat(col) : new THREE.MeshStandardMaterial({color:col});
                const box = new THREE.Mesh(new THREE.BoxGeometry(10,8,10), boxMat);
                box.position.y=4; box.castShadow=true;
                // √áatƒ±
                const roofMat = lego ? AI.createLegoMat(0x8B4513) : new THREE.MeshStandardMaterial({color:0x8B4513});
                const roof = new THREE.Mesh(new THREE.ConeGeometry(9,4,4), roofMat);
                roof.position.y=10; roof.rotation.y=Math.PI/4;
                
                group.add(box, roof);
                group.position.set(Math.random()*10, 0, Math.random()*10);
                group.userData = {anchored:true};
                LunX.scene.add(group); LunX.objects.push(group); UI.refreshExplorer();
            },
            buildCar: (col, lego) => {
                const group = new THREE.Group(); group.name = "AI_Car";
                const mat = lego ? AI.createLegoMat(col) : new THREE.MeshPhongMaterial({color:col});
                const body = new THREE.Mesh(new THREE.BoxGeometry(4,1.5,8), mat); body.position.y=1.5;
                const top = new THREE.Mesh(new THREE.BoxGeometry(3,1.2,4), new THREE.MeshStandardMaterial({color:0x333})); top.position.y=2.8;
                
                group.add(body, top);
                [[2,2],[-2,2],[2,-2],[-2,-2]].forEach(p=>{
                    const w = new THREE.Mesh(new THREE.CylinderGeometry(0.8,0.8,0.5), new THREE.MeshStandardMaterial({color:0x111}));
                    w.rotation.z=Math.PI/2; w.position.set(p[0], 0.8, p[1]);
                    group.add(w);
                });
                group.position.set(5, 5, 5);
                group.userData = {isVehicle:true, velocity:new THREE.Vector3(), anchored:false};
                LunX.scene.add(group); LunX.objects.push(group); UI.refreshExplorer();
            }
        };

        // --- CORE ENGINE ---
        const LunX = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            objects: [], selected: null, isPlaying: false,
            player: null, vehicle: null, health: 100,
            joy: { x:0, y:0, active:false },
            keys: {},

            init: () => {
                ThreeEngine.init();
                UI.initToolbox();
                
                window.addEventListener('resize', ThreeEngine.resize);
                window.addEventListener('keydown', e => LunX.keys[e.key.toLowerCase()] = true);
                window.addEventListener('keyup', e => LunX.keys[e.key.toLowerCase()] = false);

                const joy = document.getElementById('joystick-area');
                joy.addEventListener('touchstart', Game.joyStart, {passive:false});
                joy.addEventListener('touchmove', Game.joyMove, {passive:false});
                joy.addEventListener('touchend', Game.joyEnd);
                
                document.getElementById('jump-btn').addEventListener('touchstart', Game.jump);
                document.getElementById('jump-btn').addEventListener('mousedown', Game.jump);
                document.getElementById('interact-btn').addEventListener('click', Game.exitVehicle);
                document.getElementById('tex-input').addEventListener('change', World.onTextureUpload);
                document.getElementById('obj-input').addEventListener('change', World.onOBJUpload);
            }
        };

        const ThreeEngine = {
            init: () => {
                const vp = document.getElementById('viewport');
                LunX.scene = new THREE.Scene();
                LunX.scene.background = new THREE.Color(0x87CEEB);
                LunX.scene.fog = new THREE.Fog(0x87CEEB, 50, 500);

                LunX.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 2000);
                LunX.camera.position.set(15, 15, 15);

                LunX.renderer = new THREE.WebGLRenderer({ antialias: true });
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
                LunX.renderer.shadowMap.enabled = true;
                vp.appendChild(LunX.renderer.domElement);

                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); LunX.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 1); dir.position.set(50, 100, 50);
                dir.castShadow = true; LunX.scene.add(dir);

                LunX.controls = new THREE.OrbitControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform = new THREE.TransformControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform.addEventListener('dragging-changed', e => LunX.controls.enabled = !e.value);
                LunX.scene.add(LunX.transform);

                vp.addEventListener('mousedown', Tools.onSelect);
                vp.addEventListener('touchstart', Tools.onSelect, {passive:false});

                World.add('baseplate');
                ThreeEngine.loop();
            },
            resize: () => {
                const vp = document.getElementById('viewport');
                LunX.camera.aspect = vp.clientWidth / vp.clientHeight;
                LunX.camera.updateProjectionMatrix();
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },
            loop: () => {
                requestAnimationFrame(ThreeEngine.loop);
                if(LunX.isPlaying) Game.update();
                else LunX.controls.update();
                LunX.renderer.render(LunX.scene, LunX.camera);
            }
        };

        const World = {
            add: (type, opts={}) => {
                let geo, mat;
                if(opts.lego) mat = AI.createLegoMat(opts.color || Math.random()*0xffffff);
                else mat = new THREE.MeshStandardMaterial({color: opts.color || Math.random()*0xffffff});
                
                if(type==='baseplate') { geo = new THREE.BoxGeometry(500, 1, 500); mat.color.setHex(0x555555); }
                else if(type==='sphere') geo = new THREE.SphereGeometry(2,32,32);
                else if(type==='cylinder') geo = new THREE.CylinderGeometry(2,2,4,32);
                else if(type==='wedge') geo = new THREE.ConeGeometry(2,4,4);
                else geo = new THREE.BoxGeometry(4,4,4);

                if(type === 'neon') mat = new THREE.MeshBasicMaterial({color:0x00ffff});

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(opts.pos || new THREE.Vector3(0, 10, 0));
                if(type==='baseplate') { mesh.position.y = -0.5; mesh.name="Baseplate"; mesh.userData.locked=true; }
                else mesh.name = opts.name || "Part";

                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.userData = { 
                    anchored: type==='baseplate', 
                    canCollide: true,
                    velocity: new THREE.Vector3()
                };

                if(type==='spawn') { mesh.scale.set(2, 0.1, 2); mesh.userData.anchored=true; mesh.name="SpawnLocation"; }
                if(type==='light') { const l = new THREE.PointLight(0xffaa00, 1, 20); mesh.add(l); mesh.userData.anchored=true; }

                LunX.scene.add(mesh);
                LunX.objects.push(mesh);
                UI.refreshExplorer();
                return mesh;
            },
            importOBJ: () => document.getElementById('obj-input').click(),
            onOBJUpload: (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const loader = new THREE.OBJLoader();
                    const obj = loader.parse(ev.target.result);
                    obj.position.set(0, 10, 0);
                    obj.name = "ImportedModel"; obj.userData={anchored:true, velocity:new THREE.Vector3()};
                    LunX.scene.add(obj); LunX.objects.push(obj); UI.refreshExplorer();
                };
                reader.readAsText(file);
            },
            onTextureUpload: (e) => {
                if(!LunX.selected) return alert("Par√ßa se√ßin!");
                const file = e.target.files[0];
                if(file) new THREE.TextureLoader().load(URL.createObjectURL(file), tex => LunX.selected.material.map = tex);
            }
        };

        const Tools = {
            onSelect: (e) => {
                if(LunX.isPlaying) return;
                if(e.target.id !== 'viewport') return;
                const rect = LunX.renderer.domElement.getBoundingClientRect();
                const x = ((e.clientX || e.touches[0].clientX) - rect.left) / rect.width * 2 - 1;
                const y = -((e.clientY || e.touches[0].clientY) - rect.top) / rect.height * 2 + 1;
                const ray = new THREE.Raycaster(); ray.setFromCamera({x,y}, LunX.camera);
                const hits = ray.intersectObjects(LunX.objects);
                if(hits.length > 0) {
                    LunX.selected = hits[0].object;
                    if(!LunX.selected.userData.locked) LunX.transform.attach(LunX.selected);
                    else LunX.transform.detach();
                } else {
                    LunX.selected = null; LunX.transform.detach();
                }
                UI.updateProps(); UI.refreshExplorer();
            },
            setMode: (m) => {
                if(m==='select') LunX.transform.detach();
                else { LunX.transform.setMode(m); if(LunX.selected) LunX.transform.attach(LunX.selected); }
                document.querySelectorAll('.ribbon-btn').forEach(b=>b.classList.remove('active'));
            }
        };

        const Game = {
            play: () => {
                if(LunX.isPlaying) return;
                LunX.isPlaying = true; LunX.transform.detach();
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('right-panel').style.display = 'none';
                document.getElementById('game-hud').style.display = 'block';
                
                const grp = new THREE.Group();
                const mat = new THREE.MeshPhongMaterial({color:0x0088ff});
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), new THREE.MeshPhongMaterial({color:0xffcc00})); head.position.y=4.6;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), mat); torso.position.y=3;
                grp.add(head, torso);
                
                const spawn = LunX.objects.find(o=>o.name==="SpawnLocation");
                grp.position.copy(spawn ? spawn.position : new THREE.Vector3(0,5,0)); grp.position.y+=2;
                grp.userData = { velocity: new THREE.Vector3(), onGround: false };
                LunX.player = grp; LunX.scene.add(grp);
                
                LunX.controls.enablePan = false; LunX.controls.maxDistance=20; LunX.controls.minDistance=4;
            },
            stop: () => {
                LunX.isPlaying = false;
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('right-panel').style.display = 'flex';
                document.getElementById('game-hud').style.display = 'none';
                if(LunX.player) LunX.scene.remove(LunX.player);
                LunX.player = null; LunX.vehicle = null;
                LunX.camera.position.set(20,20,20); LunX.controls.target.set(0,0,0); LunX.controls.enablePan=true;
                LunX.objects.forEach(o => { if(!o.userData.anchored) o.position.set(0,10,0); }); 
            },
            update: () => {
                let target = LunX.player;
                let speed = 0.3;
                if(LunX.vehicle) { target = LunX.vehicle; speed = 0.8; }

                if(target) {
                    const v = target.userData.velocity;
                    if(!LunX.vehicle || !target.userData.onGround) v.y -= 0.02;
                    target.position.y += v.y;
                    if(target.position.y <= 2) { target.position.y = 2; v.y = 0; target.userData.onGround = true; }

                    // --- D√úZELTƒ∞LMƒ∞≈û Y√úR√úME MANTIƒûI (CAMERA RELATIVE) ---
                    let inputX = LunX.joy.x;
                    let inputY = LunX.joy.y;
                    
                    // Klavye desteƒüi
                    if(LunX.keys['w']) inputY = 1;
                    if(LunX.keys['s']) inputY = -1;
                    if(LunX.keys['a']) inputX = -1;
                    if(LunX.keys['d']) inputX = 1;

                    if(Math.abs(inputX) > 0.1 || Math.abs(inputY) > 0.1) {
                        const camDir = new THREE.Vector3();
                        LunX.camera.getWorldDirection(camDir);
                        camDir.y = 0; camDir.normalize();
                        const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x);
                        
                        const move = camDir.multiplyScalar(inputY).add(camRight.multiplyScalar(inputX));
                        
                        if(LunX.vehicle) {
                             target.translateX(inputY * speed);
                             target.rotation.y -= inputX * 0.05;
                        } else {
                            target.position.add(move.multiplyScalar(speed));
                            target.lookAt(target.position.clone().add(move));
                        }
                    }

                    // Vehicle Check
                    if(!LunX.vehicle) {
                        const cars = LunX.objects.filter(o => o.userData.isVehicle);
                        let near = false;
                        cars.forEach(c => { if(target.position.distanceTo(c.position)<8) { near=true; document.getElementById('interact-btn').style.display='flex'; document.getElementById('interact-btn').onclick=()=>Game.enterVehicle(c); }});
                        if(!near) document.getElementById('interact-btn').style.display='none';
                    }
                    LunX.controls.target.lerp(target.position, 0.1);
                }
                LunX.objects.forEach(obj => {
                    if(!obj.userData.anchored && obj!==LunX.vehicle) {
                        obj.position.y-=0.1; if(obj.position.y<2) obj.position.y=2;
                    }
                });
            },
            enterVehicle: (c) => { LunX.vehicle=c; LunX.scene.remove(LunX.player); document.getElementById('interact-btn').innerHTML='üö∂'; document.getElementById('interact-btn').onclick=Game.exitVehicle; },
            exitVehicle: () => { if(!LunX.vehicle)return; LunX.player.position.copy(LunX.vehicle.position).add(new THREE.Vector3(3,0,0)); LunX.scene.add(LunX.player); LunX.vehicle=null; document.getElementById('interact-btn').innerHTML='üöó'; document.getElementById('interact-btn').style.display='none'; },
            joyStart: (e) => { LunX.joy.active=true; Game.joyMove(e); },
            joyMove: (e) => {
                const rect = document.getElementById('joystick-area').getBoundingClientRect();
                const cx = rect.left+60, cy=rect.top+60;
                const tx = e.touches[0].clientX, ty = e.touches[0].clientY;
                let dx = tx-cx, dy=cy-ty; // Y ekseni ters
                const d = Math.sqrt(dx*dx+dy*dy);
                if(d>40) { const a=Math.atan2(dy,dx); dx=Math.cos(a)*40; dy=Math.sin(a)*40; }
                document.getElementById('joystick-knob').style.transform=`translate(${dx}px, ${-dy}px)`;
                LunX.joy.x = dx/40; LunX.joy.y = dy/40;
            },
            joyEnd: () => { LunX.joy.active=false; LunX.joy.x=0; LunX.joy.y=0; document.getElementById('joystick-knob').style.transform='translate(0,0)'; },
            jump: (e) => { if(e)e.preventDefault(); if(LunX.player) LunX.player.userData.velocity.y=0.8; }
        };

        const UI = {
            setTab: (id) => { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('.tool-section').forEach(s=>s.classList.remove('active')); document.getElementById('sec-'+id).classList.add('active'); },
            toggle: (id) => { const el = document.getElementById(id); if(id==='toolbox') el.classList.toggle('closed'); else el.style.display=el.style.display==='none'?'flex':'none'; },
            updateProps: () => {
                const p = document.getElementById('prop-content'); p.innerHTML = '';
                if(!LunX.selected) return;
                const obj = LunX.selected;
                const row = (lbl,v,cb)=>{ const d=document.createElement('div'); d.className='prop-row'; d.innerHTML=`<div class="prop-label">${lbl}</div>`; const i=document.createElement('input'); i.className='prop-input'; i.value=v; i.onchange=e=>cb(e.target.value); d.appendChild(i); p.appendChild(d); };
                row("Name", obj.name, v=>obj.name=v);
            },
            refreshExplorer: () => {
                const ex = document.getElementById('explorer'); ex.innerHTML = '';
                LunX.objects.forEach(o => { const d = document.createElement('div'); d.innerText = o.name; d.style.padding='2px'; d.style.cursor='pointer'; d.onclick = () => Tools.onSelect({custom: o}); ex.appendChild(d); });
            },
            initToolbox: () => {
                const tb = document.getElementById('toolbox-content');
                const items = [{n:"Red Brick",c:0xff0000},{n:"Grass",c:0x00ff00},{n:"Wood",c:0x8B4513},{n:"Stone",c:0x888888}];
                items.forEach(it => { const el=document.createElement('div'); el.className='tb-item'; el.innerHTML=`<div class="tb-icon" style="background:#${new THREE.Color(it.c).getHexString()}"></div>${it.n}`; el.onclick=()=>World.add('box',{color:it.c}); tb.appendChild(el); });
            }
        };
    </script>
</body>
</html>
