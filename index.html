<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Roblox Clone Ultimate</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        /* --- ROBLOX STUDIO STYLE THEME --- */
        :root {
            --bg-dark: #232323;
            --bg-light: #FFFFFF;
            --ribbon-bg: #F5F6F7;
            --border: #DCE0E5;
            --primary: #00A2FF;
            --text: #333;
            --panel-bg: #FFF;
            --header-height: 40px;
            --ribbon-height: 100px;
        }
        
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', Tahoma, sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-dark); height: 100vh; display: flex; flex-direction: column; color: var(--text); }

        /* START SCREEN (TEMPLATES) */
        #start-screen { position: fixed; inset: 0; background: #ECEFF1; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .template-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-top: 30px; }
        .template-card { background: white; width: 160px; height: 180px; border: 1px solid #DDD; border-radius: 4px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; padding: 10px; }
        .template-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--primary); }
        .t-icon { width: 100%; height: 100px; background: #EEE; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; font-size: 40px; border-radius: 2px; }
        
        /* UI LAYOUT */
        #app-header { height: var(--header-height); background: #30404D; display: flex; align-items: center; padding: 0 10px; color: white; justify-content: space-between; }
        .logo { font-weight: 900; font-size: 14px; letter-spacing: 1px; display: flex; align-items: center; gap: 5px; }
        .logo span { background: #00A2FF; padding: 2px 6px; border-radius: 3px; }
        
        #ribbon-bar { height: var(--ribbon-height); background: var(--ribbon-bg); border-bottom: 1px solid #CCC; display: flex; padding: 5px; }
        .ribbon-tab { font-size: 12px; padding: 5px 15px; cursor: pointer; }
        .ribbon-tab.active { border-bottom: 3px solid var(--primary); font-weight: bold; color: var(--primary); }
        
        .tool-section { display: flex; border-right: 1px solid #DDD; padding-right: 10px; margin-right: 10px; align-items: center; gap: 4px; }
        .tool-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 55px; height: 70px; border-radius: 3px; cursor: pointer; font-size: 11px; color: #444; border: 1px solid transparent; transition: 0.1s; text-align: center; }
        .tool-btn:hover { background: #FFF; border-color: #CCC; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tool-btn.active { background: #E3F2FD; border-color: #90CAF9; }
        .tool-icon { font-size: 24px; margin-bottom: 4px; }

        #main-editor { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* PANELS */
        .panel { width: 250px; background: var(--panel-bg); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel-header { padding: 5px 10px; background: #F0F0F0; border-bottom: 1px solid #DDD; font-weight: bold; font-size: 12px; display: flex; justify-content: space-between; }
        .panel-content { flex: 1; overflow-y: auto; padding: 5px; font-size: 12px; }
        
        .explorer-item { padding: 2px 5px; cursor: pointer; display: flex; gap: 5px; }
        .explorer-item:hover { background: #EEE; }
        .explorer-item.selected { background: #CCE8FF; border: 1px solid #99D1FF; }

        /* VIEWPORT */
        #viewport { flex: 1; position: relative; background: #A0D4F6; overflow: hidden; }
        
        /* GAME HUD */
        #game-ui { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 100; }
        #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(0,0,0,0.2); border-radius: 50%; pointer-events: auto; }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #jump-btn { position: absolute; bottom: 60px; right: 60px; width: 80px; height: 80px; background: rgba(0, 162, 255, 0.8); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 3px solid white; font-size: 20px; cursor: pointer; }

        /* LUNAIX WINDOW */
        #lunaix-window { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 600px; height: 300px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 2000; display: none; flex-direction: column; border: 1px solid #999; }
        #lx-header { background: linear-gradient(90deg, #2196F3, #0D47A1); color: white; padding: 8px 15px; font-weight: bold; display: flex; justify-content: space-between; border-radius: 8px 8px 0 0; }
        #lx-body { flex: 1; background: #1E1E1E; color: #00FF00; font-family: 'Consolas', monospace; padding: 10px; overflow-y: auto; font-size: 12px; }
        #lx-input-line { display: flex; border-top: 1px solid #444; padding: 5px; background: #2D2D2D; }
        #lx-input { flex: 1; background: transparent; border: none; color: white; font-family: 'Consolas', monospace; }
    </style>
</head>
<body>

    <div id="start-screen">
        <div style="font-size:32px; font-weight:bold; color:#333; margin-bottom:10px;">LunX Studio <span style="color:#00A2FF; font-size:14px; vertical-align:super;">ULTIMATE</span></div>
        <div style="color:#666;">Bir ≈üablon se√ßerek olu≈üturmaya ba≈üla</div>
        <div class="template-grid">
            <div class="template-card" onclick="App.loadTemplate('baseplate')"><div class="t-icon">‚¨ú</div>Baseplate</div>
            <div class="template-card" onclick="App.loadTemplate('grass')"><div class="t-icon">üåø</div>Grass Village</div>
            <div class="template-card" onclick="App.loadTemplate('night')"><div class="t-icon">üåë</div>Night City</div>
            <div class="template-card" onclick="App.loadTemplate('obby')"><div class="t-icon">üèÉ</div>Obby Parkour</div>
            <div class="template-card" onclick="App.loadTemplate('sea')"><div class="t-icon">üåä</div>Pirate Sea</div>
        </div>
    </div>

    <div id="app-header">
        <div class="logo"><span>LunX</span> Studio</div>
        <div style="display:flex; gap:10px;">
            <button onclick="Game.play()" id="play-btn" style="background:#4CAF50; border:none; padding:5px 20px; color:white; font-weight:bold; border-radius:3px; cursor:pointer;">‚ñ∂ Oyna</button>
            <button onclick="Game.stop()" id="stop-btn" style="background:#F44336; border:none; padding:5px 20px; color:white; font-weight:bold; border-radius:3px; cursor:pointer; display:none;">‚èπ Durdur</button>
        </div>
    </div>

    <div id="ribbon-bar">
        <div class="tool-section">
            <div class="tool-btn active" onclick="Editor.setMode('select')"><div class="tool-icon">üëÜ</div>Se√ß</div>
            <div class="tool-btn" onclick="Editor.setMode('translate')"><div class="tool-icon">‚ÜîÔ∏è</div>Ta≈üƒ±</div>
            <div class="tool-btn" onclick="Editor.setMode('scale')"><div class="tool-icon">‚§°</div>Boyut</div>
            <div class="tool-btn" onclick="Editor.setMode('rotate')"><div class="tool-icon">üîÑ</div>D√∂nd√ºr</div>
        </div>
        <div class="tool-section">
            <div class="tool-btn" onclick="World.addPart('box')"><div class="tool-icon">üì¶</div>Part</div>
            <div class="tool-btn" onclick="World.addPart('sphere')"><div class="tool-icon">‚ö™</div>Sphere</div>
            <div class="tool-btn" onclick="World.addPart('wedge')"><div class="tool-icon">üìê</div>Wedge</div>
            <div class="tool-btn" onclick="World.addPart('cylinder')"><div class="tool-icon">üõ¢Ô∏è</div>Cylinder</div>
        </div>
        <div class="tool-section">
            <div class="tool-btn" onclick="UI.toggleAI()" style="color:#2196F3"><div class="tool-icon">ü§ñ</div>LunAIX</div>
            <div class="tool-btn" onclick="World.addSpecial('truss')"><div class="tool-icon">ü™ú</div>Truss</div>
            <div class="tool-btn" onclick="World.addSpecial('water')"><div class="tool-icon">üíß</div>Water</div>
        </div>
    </div>

    <div id="main-editor">
        <div class="panel" id="toolbox-panel">
            <div class="panel-header">Toolbox</div>
            <div class="panel-content" id="toolbox-items">
                </div>
        </div>

        <div id="viewport">
            <div id="game-ui">
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">ü†ï</div>
            </div>
        </div>

        <div class="panel" style="width: 280px;">
            <div style="height: 50%; display:flex; flex-direction:column; border-bottom:1px solid #DDD;">
                <div class="panel-header">Explorer</div>
                <div class="panel-content" id="explorer-list">
                    <div class="explorer-item">üìÇ Workspace</div>
                </div>
            </div>
            <div style="height: 50%; display:flex; flex-direction:column;">
                <div class="panel-header">Properties</div>
                <div class="panel-content" id="prop-list">
                    <div style="padding:10px; color:#999;">Se√ßim yok</div>
                </div>
            </div>
        </div>
    </div>

    <div id="lunaix-window">
        <div id="lx-header">LunAIX AI Assistant (Build & Code) <span onclick="UI.toggleAI()" style="cursor:pointer">x</span></div>
        <div id="lx-body">
            <div>LunAIX v2.0 Initialized...</div>
            <div>Sistem: "≈üehir kur", "dev bir kale yap", "orman olu≈ütur" gibi komutlarƒ± anlar.</div>
            <br>
        </div>
        <div id="lx-input-line">
            <span style="color:#00A2FF; font-weight:bold; margin-right:5px;">AI></span>
            <input type="text" id="lx-input" placeholder="Komut girin (√ñrn: Create Castle)..." onkeydown="if(event.key==='Enter') AI.execute()">
        </div>
    </div>

    <script>
        /* --- SYSTEM CORE --- */
        const App = {
            scene: null, camera: null, renderer: null, world: null,
            controls: null, transformer: null, clock: new THREE.Clock(),
            objects: [], raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),
            
            init: () => {
                const vp = document.getElementById('viewport');
                // Three.js
                App.scene = new THREE.Scene();
                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 4000);
                App.camera.position.set(20, 20, 20);
                
                App.renderer = new THREE.WebGLRenderer({antialias: true});
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                App.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                vp.appendChild(App.renderer.domElement);

                // Cannon.js
                App.world = new CANNON.World();
                App.world.gravity.set(0, -25, 0);
                App.world.broadphase = new CANNON.NaiveBroadphase();
                App.world.defaultContactMaterial.friction = 0.1;

                // Lights
                const ambient = new THREE.AmbientLight(0xffffff, 0.6);
                App.scene.add(ambient);
                const dir = new THREE.DirectionalLight(0xffffff, 0.8);
                dir.position.set(50, 100, 50);
                dir.castShadow = true;
                dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
                dir.shadow.camera.left = -100; dir.shadow.camera.right = 100;
                dir.shadow.camera.top = 100; dir.shadow.camera.bottom = -100;
                App.scene.add(dir);

                // Controls
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.controls.enableDamping = true;

                App.transformer = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transformer.addEventListener('dragging-changed', e => App.controls.enabled = !e.value);
                App.scene.add(App.transformer);

                // Events
                window.addEventListener('resize', App.resize);
                vp.addEventListener('pointerdown', Editor.onClick);
                
                Game.initInput();
                App.loop();
            },

            loadTemplate: (type) => {
                document.getElementById('start-screen').style.display = 'none';
                if(!App.scene) App.init();
                
                // Clear
                World.clear();

                if(type === 'baseplate') {
                    World.createBaseplate(0x999999);
                    App.scene.background = new THREE.Color(0xA0D4F6);
                }
                else if(type === 'grass') {
                    World.createBaseplate(0x4CAF50);
                    App.scene.background = new THREE.Color(0x87CEEB);
                    AI.build('ev'); AI.build('orman');
                }
                else if(type === 'night') {
                    World.createBaseplate(0x111111);
                    App.scene.background = new THREE.Color(0x050510);
                    App.scene.fog = new THREE.Fog(0x050510, 20, 100);
                    AI.build('≈üehir');
                }
                else if(type === 'obby') {
                    App.scene.background = new THREE.Color(0xFFEB3B);
                    World.createBaseplate(0xEEEEEE, 10); // Small platform
                    AI.build('obby');
                }
                else if(type === 'sea') {
                    World.addSpecial('water', {pos:{x:0,y:-2,z:0}, scale:{x:500,y:5,z:500}});
                    World.addPart('box', {pos:{x:0,y:1,z:0}, scale:{x:10,y:1,z:10}, anchored:true, color:0x8D6E63});
                }
            },

            resize: () => {
                const vp = document.getElementById('viewport');
                App.camera.aspect = vp.clientWidth / vp.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = Math.min(App.clock.getDelta(), 0.1);
                
                if(Game.active) {
                    App.world.step(1/60, dt, 3);
                    Game.update(dt);
                } else {
                    App.controls.update();
                }

                // Sync Physics
                App.objects.forEach(o => {
                    if(o.userData.body && !o.userData.dragging && !o.userData.anchored) {
                        o.position.copy(o.userData.body.position);
                        o.quaternion.copy(o.userData.body.quaternion);
                        
                        // Offset visuals for Character
                        if(o.userData.isPlayer) {
                             o.position.y -= 3.0; // Center fix
                        }
                    }
                    // Water Animation
                    if(o.userData.type==='water') {
                        o.material.opacity = 0.6 + Math.sin(Date.now()*0.002)*0.1;
                    }
                });

                App.renderer.render(App.scene, App.camera);
            }
        };

        /* --- WORLD BUILDING --- */
        const World = {
            clear: () => {
                // Remove all except core
                for(let i=App.objects.length-1; i>=0; i--) {
                    const o = App.objects[i];
                    App.scene.remove(o);
                    App.world.removeBody(o.userData.body);
                }
                App.objects = [];
                document.getElementById('explorer-list').innerHTML = '<div class="explorer-item">üìÇ Workspace</div>';
            },

            createBaseplate: (col, size=500) => {
                World.addPart('box', {
                    pos: {x:0, y:-2, z:0},
                    scale: {x:size, y:4, z:size},
                    color: col,
                    anchored: true,
                    name: 'Baseplate'
                });
                const grid = new THREE.GridHelper(size, size/4, 0x555555, 0x555555);
                grid.position.y = 0.05;
                App.scene.add(grid);
            },

            addPart: (type, cfg={}) => {
                let geo, shape;
                const s = cfg.scale || {x:4, y:4, z:4};
                const p = cfg.pos || {x:0, y:10, z:0};
                const col = cfg.color || Math.random() * 0xffffff;

                if(type==='sphere') { geo = new THREE.SphereGeometry(1,32,32); shape = new CANNON.Sphere(Math.min(s.x,s.y,s.z)/2); }
                else if(type==='cylinder') { geo = new THREE.CylinderGeometry(1,1,1,32); shape = new CANNON.Cylinder(s.x/2, s.x/2, s.y, 12); }
                else if(type==='wedge') { geo = new THREE.ConeGeometry(1,1,4); shape = new CANNON.Box(new CANNON.Vec3(s.x/2, s.y/2, s.z/2)); }
                else { geo = new THREE.BoxGeometry(1,1,1); shape = new CANNON.Box(new CANNON.Vec3(s.x/2, s.y/2, s.z/2)); }

                const mat = new THREE.MeshStandardMaterial({color:col, roughness:0.4});
                if(cfg.opacity) { mat.transparent=true; mat.opacity=cfg.opacity; }

                const mesh = new THREE.Mesh(geo, mat);
                mesh.scale.set(s.x, s.y, s.z);
                mesh.position.set(p.x, p.y, p.z);
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.name = cfg.name || type.charAt(0).toUpperCase() + type.slice(1);

                const body = new CANNON.Body({
                    mass: cfg.anchored ? 0 : (s.x*s.y*s.z),
                    shape: shape
                });
                body.position.copy(mesh.position);
                if(cfg.noCollide) body.collisionFilterGroup = 0;

                mesh.userData = {body, anchored: !!cfg.anchored, type, special: cfg.special};
                App.scene.add(mesh);
                App.world.addBody(body);
                App.objects.push(mesh);
                UI.addToExplorer(mesh);
                return mesh;
            },

            addSpecial: (type, cfg={}) => {
                if(type==='water') {
                    World.addPart('box', {
                        pos: cfg.pos || {x:0,y:2,z:0}, scale: cfg.scale || {x:20,y:6,z:20},
                        color: 0x0099FF, opacity: 0.5, noCollide: true, anchored:true, name:'Water', special:'water'
                    });
                }
                else if(type==='truss') {
                    World.addPart('box', {
                        pos: {x:0,y:10,z:0}, scale: {x:2,y:20,z:2},
                        color: 0xFFA000, anchored:true, name:'Truss', special:'climb'
                    });
                }
            }
        };

        /* --- GAMEPLAY & ANIMATIONS --- */
        const Game = {
            active: false, player: null, hp:100, body:null,
            limbs: {}, input: {x:0, y:0, jump:false},
            state: 'idle', // idle, walk, jump, swim, climb

            play: () => {
                Game.active = true;
                document.getElementById('play-btn').style.display='none';
                document.getElementById('stop-btn').style.display='inline-block';
                document.getElementById('ribbon-bar').style.display='none';
                document.getElementById('main-editor').style.top='40px';
                document.getElementById('game-ui').style.display='block';
                document.getElementById('toolbox-panel').style.display='none';
                App.resize();
                Game.spawn();
            },

            stop: () => {
                Game.active = false;
                document.getElementById('play-btn').style.display='inline-block';
                document.getElementById('stop-btn').style.display='none';
                document.getElementById('ribbon-bar').style.display='flex';
                document.getElementById('game-ui').style.display='none';
                document.getElementById('toolbox-panel').style.display='flex';
                
                if(Game.player) { App.scene.remove(Game.player); App.world.removeBody(Game.body); }
                App.controls.target.set(0,0,0);
                App.camera.position.set(20,20,20);
            },

            spawn: () => {
                const g = new THREE.Group();
                // R6 Avatar Construction
                const mY = new THREE.MeshStandardMaterial({color:0xFFD600}); // Skin
                const mB = new THREE.MeshStandardMaterial({color:0x0277BD}); // Shirt
                const mG = new THREE.MeshStandardMaterial({color:0x43A047}); // Pants

                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), mY); head.position.y=5.6;
                const face = new THREE.Mesh(new THREE.PlaneGeometry(0.8,0.8), new THREE.MeshBasicMaterial({color:0})); face.position.z=0.61; head.add(face);
                
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), mB); torso.position.y=4;
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mY); la.position.set(-1.5,4,0);
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mY); ra.position.set(1.5,4,0);
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mG); ll.position.set(-0.5,2,0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mG); rl.position.set(0.5,2,0);

                g.add(head, torso, la, ra, ll, rl);
                g.castShadow = true;

                const body = new CANNON.Body({
                    mass: 60, fixedRotation: true,
                    position: new CANNON.Vec3(0,10,0),
                    shape: new CANNON.Cylinder(1.5, 1.5, 6, 12),
                    linearDamping: 0.9
                });
                
                App.scene.add(g); App.world.addBody(body);
                Game.player = g; Game.body = body;
                Game.limbs = {head, la, ra, ll, rl};
                g.userData = {body, isPlayer:true};
            },

            update: (dt) => {
                if(!Game.body) return;
                const b = Game.body;
                
                // --- PHYSICS & COLLISION DETECTION ---
                let inWater = false;
                let canClimb = false;
                
                App.objects.forEach(o => {
                    if(o.userData.special) {
                        const dist = new THREE.Vector3().copy(b.position).distanceTo(o.position);
                        if(dist < (o.scale.x + o.scale.y)/2) { // Simple check
                            if(o.userData.special==='water') inWater = true;
                            if(o.userData.special==='climb') canClimb = true;
                        }
                    }
                });

                // --- MOVEMENT LOGIC ---
                const speed = inWater ? 15 : (canClimb ? 10 : 25);
                // Camera Direction
                const camAng = App.controls.getAzimuthalAngle();
                const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                const rgt = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                
                const move = new THREE.Vector3()
                    .addScaledVector(rgt, Game.input.x)
                    .addScaledVector(fwd, -Game.input.y);

                if(move.length() > 0.1) {
                    move.normalize().multiplyScalar(speed);
                    b.velocity.x = move.x;
                    b.velocity.z = move.z;
                    Game.player.rotation.y = Math.atan2(move.x, move.z); // Face direction
                    Game.state = inWater ? 'swim' : 'walk';
                } else {
                    b.velocity.x *= 0.5; b.velocity.z *= 0.5;
                    Game.state = inWater ? 'swim_idle' : 'idle';
                }

                // Vertical Movement
                if(inWater) {
                    b.velocity.y *= 0.9; // Float
                    if(Game.input.jump) b.velocity.y = 10;
                    Game.state = 'swim';
                } else if(canClimb) {
                    b.velocity.y = Game.input.jump ? 8 : 0;
                    Game.state = 'climb';
                } else {
                    if(Game.input.jump && Math.abs(b.velocity.y) < 0.1) {
                         b.velocity.y = 18;
                         Game.state = 'jump';
                    }
                }
                Game.input.jump = false; // Reset jump trigger

                // --- PROCEDURAL ANIMATION ---
                Game.animate(Date.now() * 0.001);

                // --- CAMERA ---
                const pPos = Game.player.position;
                App.controls.target.copy(pPos);
                App.controls.target.y += 2;
                // Don't force camera position, let OrbitControls handle it, just sync target
            },

            animate: (t) => {
                const l = Game.limbs;
                const s = Game.state;
                
                // Reset
                l.la.rotation.x = l.ra.rotation.x = l.ll.rotation.x = l.rl.rotation.x = 0;
                l.la.rotation.z = l.ra.rotation.z = 0;
                Game.player.rotation.x = 0;

                if(s === 'walk') {
                    const spd = 10;
                    l.la.rotation.x = Math.cos(t*spd)*0.6;
                    l.ra.rotation.x = -Math.cos(t*spd)*0.6;
                    l.ll.rotation.x = -Math.cos(t*spd)*0.6;
                    l.rl.rotation.x = Math.cos(t*spd)*0.6;
                }
                else if(s === 'jump') {
                    l.la.rotation.z = 2.5; l.ra.rotation.z = -2.5; // Arms up
                    l.ll.rotation.x = 0.5; l.rl.rotation.x = -0.5;
                }
                else if(s === 'climb') {
                    const spd = 8;
                    l.la.rotation.x = Math.sin(t*spd); l.ra.rotation.x = Math.cos(t*spd);
                    l.ll.rotation.x = -Math.sin(t*spd); l.rl.rotation.x = -Math.cos(t*spd);
                }
                else if(s === 'swim' || s === 'swim_idle') {
                    Game.player.rotation.x = -Math.PI / 2.5; // Horizontal
                    const spd = 5;
                    l.la.rotation.x = Math.sin(t*spd);
                    l.ra.rotation.x = Math.cos(t*spd);
                    l.ll.rotation.x = Math.sin(t*spd)*0.5;
                    l.rl.rotation.x = -Math.sin(t*spd)*0.5;
                }
                else { // Idle
                    l.head.rotation.y = Math.sin(t)*0.1;
                    l.la.rotation.z = 0.1; l.ra.rotation.z = -0.1; // Breathe
                }
            },

            initInput: () => {
                const zone = document.getElementById('joystick-zone');
                const stick = document.getElementById('stick');
                let drag = false;

                const move = (dx, dy) => {
                    const max = 40;
                    const dist = Math.sqrt(dx*dx+dy*dy);
                    const ang = Math.atan2(dy, dx);
                    const r = Math.min(dist, max);
                    stick.style.transform = `translate(calc(-50% + ${Math.cos(ang)*r}px), calc(-50% + ${Math.sin(ang)*r}px))`;
                    Game.input.x = Math.cos(ang)*r/max;
                    Game.input.y = Math.sin(ang)*r/max;
                };

                zone.addEventListener('pointerdown', e=>{drag=true;});
                window.addEventListener('pointermove', e=>{
                    if(!drag) return;
                    const rect = zone.getBoundingClientRect();
                    const cx = rect.left + rect.width/2;
                    const cy = rect.top + rect.height/2;
                    move(e.clientX-cx, e.clientY-cy);
                });
                window.addEventListener('pointerup', ()=>{
                    drag=false; stick.style.transform='translate(-50%, -50%)';
                    Game.input.x=0; Game.input.y=0;
                });
                
                document.getElementById('jump-btn').addEventListener('pointerdown', ()=>Game.input.jump=true);

                window.addEventListener('keydown', e=>{
                    if(e.key==='w') Game.input.y=-1;
                    if(e.key==='s') Game.input.y=1;
                    if(e.key==='a') Game.input.x=-1;
                    if(e.key==='d') Game.input.x=1;
                    if(e.code==='Space') Game.input.jump=true;
                });
                window.addEventListener('keyup', e=>{
                    if(['w','s'].includes(e.key)) Game.input.y=0;
                    if(['a','d'].includes(e.key)) Game.input.x=0;
                });
            }
        };

        /* --- LUNAIX AI (PROCEDURAL GENERATOR) --- */
        const AI = {
            log: (txt) => {
                const b = document.getElementById('lx-body');
                b.innerHTML += `<div>> ${txt}</div>`;
                b.scrollTop = b.scrollHeight;
            },
            execute: () => {
                const inp = document.getElementById('lx-input');
                const cmd = inp.value.toLowerCase();
                AI.log(inp.value);
                inp.value = '';
                AI.build(cmd);
            },
            build: (cmd) => {
                const rPos = () => Math.random()*100-50;
                
                if(cmd.includes('≈üehir')) {
                    AI.log("≈ûehir in≈üa ediliyor (100+ Yapƒ±)...");
                    for(let i=0; i<100; i++) {
                        const h = 10+Math.random()*40;
                        World.addPart('box', {
                            pos:{x:rPos(), y:h/2, z:rPos()},
                            scale:{x:5+Math.random()*5, y:h, z:5+Math.random()*5},
                            color: Math.random()>0.8 ? 0x222 : 0x555,
                            anchored:true
                        });
                    }
                } 
                else if(cmd.includes('kale')) {
                    AI.log("Kale olu≈üturuluyor...");
                    const p = {x:0, z:0};
                    // 4 Tower
                    [[10,10],[-10,10],[10,-10],[-10,-10]].forEach(c=>{
                        World.addPart('cylinder', {pos:{x:c[0],y:6,z:c[1]}, scale:{x:4,y:12}, color:0x888, anchored:true});
                    });
                    // Walls
                    World.addPart('box', {pos:{x:0,y:4,z:10}, scale:{x:20,y:8,z:2}, color:0x777, anchored:true});
                    World.addPart('box', {pos:{x:0,y:4,z:-10}, scale:{x:20,y:8,z:2}, color:0x777, anchored:true});
                    World.addPart('box', {pos:{x:10,y:4,z:0}, scale:{x:2,y:8,z:20}, color:0x777, anchored:true});
                    World.addPart('box', {pos:{x:-10,y:4,z:0}, scale:{x:2,y:8,z:20}, color:0x777, anchored:true});
                }
                else if(cmd.includes('orman')) {
                    AI.log("Orman ekiliyor...");
                    for(let i=0; i<50; i++) {
                        const x=rPos(), z=rPos();
                        World.addPart('cylinder', {pos:{x:x,y:3,z:z}, scale:{x:1,y:6}, color:0x5D4037, anchored:true});
                        World.addPart('sphere', {pos:{x:x,y:7,z:z}, scale:{x:4,y:4,z:4}, color:0x2E7D32, anchored:true});
                    }
                }
                else if(cmd.includes('obby')) {
                    AI.log("Parkour (Obby) √ºretiliyor...");
                    for(let i=0; i<20; i++) {
                        World.addPart('box', {
                            pos:{x:0, y:i*2, z:i*6},
                            scale:{x:4, y:1, z:4},
                            color: Math.random()*0xFFFFFF, anchored:true
                        });
                    }
                    World.addPart('box', {pos:{x:0, y:40, z:130}, scale:{x:10,y:1,z:10}, color:0xFFD700, anchored:true});
                }
                else {
                    AI.log("Komut anla≈üƒ±lamadƒ±. Rastgele yapƒ± deneniyor.");
                    World.addPart('box', {pos:{x:0,y:5,z:0}, anchored:false, color:0xFF0000});
                }
                AI.log("ƒ∞≈ülem Tamamlandƒ±.");
            }
        };

        /* --- UI HELPERS --- */
        const Editor = {
            selected: null, mode: 'select',
            setMode: (m) => {
                Editor.mode = m;
                document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                if(m==='select') App.transformer.detach();
                else if(Editor.selected) {
                    App.transformer.setMode(m);
                    App.transformer.attach(Editor.selected);
                }
            },
            onClick: (e) => {
                if(Game.active) return;
                const r = document.getElementById('viewport').getBoundingClientRect();
                App.mouse.x = ((e.clientX-r.left)/r.width)*2-1;
                App.mouse.y = -((e.clientY-r.top)/r.height)*2+1;
                App.raycaster.setFromCamera(App.mouse, App.camera);
                const ints = App.raycaster.intersectObjects(App.objects);
                if(ints.length>0) Editor.select(ints[0].object);
                else Editor.select(null);
            },
            select: (obj) => {
                Editor.selected = obj;
                if(obj && obj.name !== 'Baseplate') {
                    if(Editor.mode!=='select') App.transformer.attach(obj);
                    UI.showProps(obj);
                } else {
                    App.transformer.detach();
                    UI.showProps(null);
                }
            }
        };

        const UI = {
            toggleAI: () => {
                const w = document.getElementById('lunaix-window');
                w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
            },
            addToExplorer: (obj) => {
                const d = document.createElement('div');
                d.className = 'explorer-item';
                d.innerHTML = (obj.userData.anchored ? '‚öì ' : 'üì¶ ') + obj.name;
                d.onclick = () => Editor.select(obj);
                document.getElementById('explorer-list').appendChild(d);
            },
            showProps: (obj) => {
                const p = document.getElementById('prop-list');
                if(!obj) { p.innerHTML = '<div style="padding:10px;color:#999;">Se√ßim yok</div>'; return; }
                p.innerHTML = `
                    <div><b>Name:</b> ${obj.name}</div>
                    <div><b>Pos:</b> ${obj.position.x.toFixed(1)}, ${obj.position.y.toFixed(1)}, ${obj.position.z.toFixed(1)}</div>
                    <div><b>Color:</b> #${obj.material.color.getHexString()}</div>
                    <div style="margin-top:10px; font-size:10px; color:#666;">Deƒüi≈ütirmek i√ßin ara√ßlarƒ± kullanƒ±n.</div>
                `;
            }
        };

    </script>
</body>
</html>
