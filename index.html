<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - R6 Pro Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #0084ff; /* Roblox St√ºdyo Mavisi */
            --primary-dark: #005eb8;
            --bg-light: #f0f0f0;
            --bg-panel: #ffffff;
            --border: #dcdcdc;
            --text: #333;
            --header-h: 40px;
            --ribbon-h: 100px;
        }

        * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-light); height: 100vh; display: flex; flex-direction: column; }
        
        /* UI SCALE */
        .ui-scaled { zoom: 1; }

        #start-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #1e1e1e, #333);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .template-grid { display: flex; gap: 20px; margin-top: 30px; }
        .template-card {
            background: #444; color: white; width: 150px; height: 180px; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border: 2px solid transparent;
        }
        .template-card:hover { transform: translateY(-10px); border-color: var(--primary); }
        .t-icon { font-size: 40px; margin-bottom: 10px; }

        #top-bar {
            height: var(--header-h); background: #222; color: white; display: flex; align-items: center; padding: 0 10px;
            font-size: 14px; z-index: 100;
        }
        #x-menu-btn {
            width: 30px; height: 30px; background: var(--primary); color: white; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; font-weight: 900; cursor: pointer; margin-right: 15px;
        }
        .menu-item { padding: 0 15px; cursor: pointer; opacity: 0.8; height: 100%; display: flex; align-items: center; transition:0.2s; } 
        .menu-item:hover { opacity: 1; background: rgba(255,255,255,0.1); }
        .menu-item.active { background: #444; font-weight: bold; opacity:1; border-bottom: 3px solid var(--primary); }

        #ribbon {
            height: var(--ribbon-h); background: var(--bg-panel); border-bottom: 1px solid var(--border);
            padding: 5px; flex-shrink: 0; position: relative; overflow: hidden;
        }
        .ribbon-tab-content { display: flex; gap: 5px; height: 100%; overflow-x: auto; position: absolute; top: 0; left: 0; right: 0; padding: 5px; background: inherit; }
        .ribbon-tab-content.hidden { display: none; }
        .tool-group { display: flex; gap: 5px; padding: 0 10px; border-right: 1px solid #eee; align-items: center; }
        .r-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 60px; height: 80px; border-radius: 5px; cursor: pointer; transition: 0.2s; color: #444; font-size:11px;
        }
        .r-btn:hover { background: #e3f2fd; }
        .r-btn.active { background: #bbdefb; color: var(--primary-dark); border: 1px solid var(--primary); }
        .r-btn span { font-size: 24px; margin-bottom: 5px; }
        
        #game-controls { position: absolute; right: 10px; top: 5px; height: 90px; display: flex; gap: 5px; align-items: center; }

        #layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        #toolbox {
            width: 250px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20; transition: width 0.3s ease; position: relative;
        }
        #toolbox.closed { width: 0; border: none; overflow: hidden; }
        .tab-header { display: flex; border-bottom: 1px solid #ddd; background: #f9f9f9; }
        .tab-btn { flex: 1; padding: 8px; text-align: center; font-size: 11px; cursor: pointer; }
        .tab-btn.active { background: white; border-bottom: 2px solid var(--primary); font-weight: bold; }
        #toolbox-list { flex: 1; overflow-y: auto; padding: 5px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; align-content: start; }
        .tool-item { 
            background: white; border: 1px solid #eee; padding: 5px; text-align: center; font-size: 10px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; border-radius: 4px;
        }
        .tool-item:hover { border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .t-preview { width: 30px; height: 30px; margin-bottom: 4px; border-radius: 3px; }

        #viewport { flex: 1; position: relative; background: #b0e0e6; overflow: hidden; }
        
        #properties {
            width: 280px; background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20;
        }
        .panel-h { padding: 8px; background: #eee; font-weight: bold; font-size: 12px; border-bottom: 1px solid #ddd; }
        #explorer { height: 35%; overflow-y: auto; border-bottom: 1px solid #ddd; }
        #prop-content { flex: 1; overflow-y: auto; padding: 10px; }
        .prop-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 11px; }
        .prop-lbl { width: 40%; color: #666; }
        .prop-inp { width: 60%; padding: 4px; border: 1px solid #ccc; }
        .prop-inp[type="range"] { padding: 0; }

        /* HUD & OVERLAYS */
        #game-overlay { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #stop-btn-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: #d32f2f; color: white; padding: 10px 30px; font-weight: bold;
            border-radius: 5px; cursor: pointer; pointer-events: auto; border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.5); }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: white; border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 2px 5px black; }
        #jump-btn { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 80px; background: rgba(255,255,255,0.8); border-radius: 50%; border: 4px solid var(--primary); pointer-events: auto; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 900; font-size: 24px; transition:0.1s; }
        #jump-btn:active { transform: scale(0.9); background: white; }

        #health-bar-container {
            position: absolute; top: 20px; left: 20px;
            width: 200px; height: 20px;
            background: rgba(0,0,0,0.5);
            border: 2px solid white;
            border-radius: 5px;
            padding: 2px;
        }
        #health-bar {
            width: 100%; height: 100%;
            background: #4CAF50;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        #x-menu {
            position: absolute; top: 40px; left: 10px; width: 250px; background: white; 
            border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none;
            flex-direction: column; padding: 15px; z-index: 2000; border: 1px solid #ddd;
        }
        .xm-row { margin-bottom: 15px; }
        .xm-btn { width: 100%; padding: 10px; margin-bottom: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-leave { background: #d32f2f; color: white; }
        .btn-reset { background: #ff9800; color: white; }
        .btn-close { background: #eee; color: #333; }

        /* AI CHAT MODAL */
        #ai-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2900;
            display: none;
            align-items: center; justify-content: center;
        }
        #lun-aix {
            position: relative;
            width: 500px; height: 400px; background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            border: 1px solid #ccc;
        }
        .ai-head { background: var(--primary); color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; cursor: pointer; }
        .ai-body { flex: 1; padding: 10px; overflow-y: auto; background: #f5f5f5; font-size: 13px; line-height: 1.4; }
        .ai-in-area { padding: 10px; border-top: 1px solid #ddd; display: flex; }
        .ai-msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 5px; max-width: 85%; }
        .ai-msg.bot { background: white; border: 1px solid #ddd; color:#333; } .ai-msg.user { background: #e3f2fd; margin-left: auto; color:#0d47a1; }

        /* SCRIPT EDITOR MODAL */
        #script-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none;
            align-items: center; justify-content: center;
        }
        #script-box { width: 800px; height: 500px; background: #1e1e1e; border-radius: 8px; display: flex; flex-direction: column; border: 1px solid #444; box-shadow:0 20px 50px black; }
        #code-area { flex: 1; background: #1e1e1e; color: #dcdcdc; font-family: 'Consolas', monospace; padding: 15px; border: none; resize: none; font-size:14px; line-height:1.5; }
        #code-area:focus { outline:none; background:#252526; }
        
        /* Explorer Tree */
        .tree-item { padding: 4px 8px; font-size: 12px; cursor: pointer; display: flex; align-items: center; color:#444; }
        .tree-item:hover { background: #e3f2fd; }
        .tree-item.selected { background: #bbdefb; border-left: 3px solid var(--primary); font-weight:bold; }
    </style>
</head>
<body onload="App.init()">

    <div id="start-screen">
        <h1 style="font-size: 50px; margin: 0; font-weight:900; letter-spacing:-1px;">LunX Studio</h1>
        <p style="opacity:0.7">R6 Edition & AI Powered</p>
        <div class="template-grid">
            <div class="template-card" onclick="World.loadTemplate('baseplate')">
                <div class="t-icon">‚¨ú</div>
                <div>Baseplate</div>
            </div>
            <div class="template-card" onclick="World.loadTemplate('grass')">
                <div class="t-icon">üå≥</div>
                <div>Grass</div>
            </div>
            <div class="template-card" onclick="World.loadTemplate('village')">
                <div class="t-icon">üèòÔ∏è</div>
                <div>Village</div>
            </div>
        </div>
    </div>

    <div id="x-menu" class="ui-scaled">
        <h3 style="margin-top:0; color: var(--primary);">LunX Menu</h3>
        <div class="xm-row">
            <label>UI Scale</label>
            <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="UI.setScale(this.value)" style="width:100%">
        </div>
        <div class="xm-row">
            <label>Quality</label>
            <select style="width:100%" onchange="App.setQuality(this.value)">
                <option value="high">High</option>
                <option value="low">Low</option>
            </select>
        </div>
        <button class="xm-btn btn-reset" onclick="Game.respawn()">Reset Character</button>
        <button class="xm-btn btn-leave" onclick="Game.stop()">Leave Game (Edit√∂r)</button>
        <button class="xm-btn btn-close" onclick="UI.toggleXMenu()">Return</button>
    </div>

    <div id="top-bar" class="ui-scaled">
        <div id="x-menu-btn" onclick="UI.toggleXMenu()">‚ò∞</div>
        <div style="font-weight:bold; margin-right:20px; font-size:16px;">LunX Studio <span style="font-size:10px; opacity:0.6; font-weight:normal;">PRO</span></div>
        <div class="menu-item active" onclick="UI.setRibbonTab('Home')">Home</div>
        <div class="menu-item" onclick="UI.setRibbonTab('Model')">Model</div>
        <div class="menu-item" onclick="UI.setRibbonTab('View')">View</div>
    </div>

    <div id="ribbon" class="ui-scaled">
        
        <div id="ribbon-content-home" class="ribbon-tab-content">
            <div class="tool-group">
                <div class="r-btn active" onclick="Editor.setMode('select')" id="btn-select"><span>üëÜ</span>Select</div>
                <div class="r-btn" onclick="Editor.setMode('translate')" id="btn-translate"><span>‚ÜîÔ∏è</span>Move</div>
                <div class="r-btn" onclick="Editor.setMode('scale')" id="btn-scale"><span>‚§°</span>Scale</div>
                <div class="r-btn" onclick="Editor.setMode('rotate')" id="btn-rotate"><span>üîÑ</span>Rotate</div>
            </div>
            <div class="tool-group">
                <div class="r-btn" onclick="World.add({name:'Part', shape:'box', color:0xa0a0a0})"><span>üß±</span>Part</div>
                <div class="r-btn" onclick="UI.toggleToolbox()" id="btn-toolbox"><span>üß∞</span>Toolbox</div>
                <div class="r-btn" onclick="UI.toggleAI()"><span>ü§ñ</span>LunAIX</div>
            </div>
        </div>

        <div id="ribbon-content-model" class="ribbon-tab-content hidden">
            <div class="tool-group">
                <div class="r-btn" onclick="World.add({name:'Cylinder', shape:'cylinder', color:0x1565C0})"><span>‚≠ï</span>Cylinder</div>
                <div class="r-btn" onclick="World.add({name:'Wedge', shape:'wedge', color:0xFBC02D})"><span>üìê</span>Wedge</div>
                <div class="r-btn" onclick="World.add({name:'Sphere', shape:'sphere', color:0xFF5722})"><span>üü£</span>Sphere</div>
                <div class="r-btn" onclick="World.add({name:'Neon', shape:'box', color:0x00E5FF, mat:'neon', anchored:true})"><span>üí°</span>Neon</div>
            </div>
            <div class="tool-group">
                <div class="r-btn" onclick="Editor.deleteSelected()"><span>üóëÔ∏è</span>Delete</div>
                <div class="r-btn" onclick="World.add({name:'Spawn', shape:'cylinder', color:0x888888, anchored:true, scale:[4,0.5,4]})"><span>üéØ</span>SpawnLocation</div>
            </div>
        </div>

        <div id="ribbon-content-view" class="ribbon-tab-content hidden">
            <div class="tool-group">
                <div class="r-btn" onclick="App.controls.reset()"><span>üè†</span>Reset Cam</div>
                <div class="r-btn" onclick="App.scene.fog.color.set(0x111111); App.scene.background.set(0x111111)"><span>üåë</span>Night</div>
                <div class="r-btn" onclick="App.scene.fog.color.set(0xB0E0E6); App.scene.background.set(0xB0E0E6)"><span>‚òÄÔ∏è</span>Day</div>
            </div>
            <div class="tool-group">
                <div class="r-btn" onclick="document.getElementById('properties').style.display='none'; App.resize();"><span>‚ùå</span>Hide Props</div>
                <div class="r-btn" onclick="document.getElementById('properties').style.display='flex'; App.resize();"><span>‚úîÔ∏è</span>Show Props</div>
            </div>
        </div>

        <div id="game-controls">
            <div class="r-btn" onclick="Game.play()" style="color:#4CAF50; font-weight:bold;"><span>‚ñ∂</span>Play</div>
            <div class="r-btn" onclick="Game.stop()" style="color:#d32f2f; font-weight:bold;"><span>‚èπ</span>Stop</div>
        </div>

    </div>

    <div id="layout">
        
        <div id="toolbox" class="closed ui-scaled">
            <div class="panel-h">Toolbox <span style="float:right; cursor:pointer" onclick="UI.toggleToolbox()">‚úï</span></div>
            <div class="tab-header">
                <div class="tab-btn active" onclick="UI.setTab('basic', event)">Basic</div>
                <div class="tab-btn" onclick="UI.setTab('nature', event)">Nature</div>
                <div class="tab-btn" onclick="UI.setTab('struct', event)">Struct</div>
            </div>
            <div id="toolbox-list"></div>
        </div>

        <div id="viewport">
            <div id="game-overlay">
                <div id="health-bar-container"><div id="health-bar"></div></div>
                <div id="stop-btn-hud" onclick="Game.stop()">‚èπ STOP GAME</div>
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>
        </div>

        <div id="properties" class="ui-scaled">
            <div class="panel-h">Explorer</div>
            <div id="explorer"></div>
            <div class="panel-h">Properties</div>
            <div id="prop-content">
                <div style="color:#888; text-align:center; padding:20px;">Select an object</div>
            </div>
        </div>

    </div>

    <div id="ai-modal" class="ui-scaled">
        <div id="lun-aix">
            <div class="ai-head">
                <span>LunAIX Assistant (v2.0)</span>
                <span style="cursor:pointer;" onclick="UI.toggleAI()">‚úï</span>
            </div>
            <div class="ai-body" id="ai-chat">
                <div class="ai-msg bot">Merhaba! Ben LunAIX. ≈ûunlarƒ± deneyin:<br>
                - "Build a house"<br>
                - "Create a giant red wall"<br>
                - "Make a kill block with script"<br>
                - "Spawn a blue ball"</div>
            </div>
            <div class="ai-in-area">
                <input type="text" id="ai-input" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;" placeholder="LunAIX'e bir ≈üey yaptƒ±r..." onkeydown="if(event.key==='Enter') AI.send()">
                <button onclick="AI.send()" style="margin-left:5px; padding:0 15px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer;">Send</button>
            </div>
        </div>
    </div>

    <div id="script-modal" class="ui-scaled">
        <div id="script-box">
            <div style="padding:10px; color:white; font-weight:bold; background:#2d2d2d; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                <span>üìú Script Editor - <span id="script-name" style="color:var(--primary)"></span></span>
                <span style="cursor:pointer; font-size:18px;" onclick="document.getElementById('script-modal').style.display='none'">‚úï</span>
            </div>
            <textarea id="code-area" spellcheck="false"></textarea>
            <div style="padding:10px; background:#2d2d2d; text-align:right;">
                 <button onclick="UI.saveScript()" style="padding:8px 20px; background:var(--primary); border:none; color:white; font-weight:bold; cursor:pointer; border-radius:4px;">Apply Changes</button>
            </div>
        </div>
    </div>

    <script>
        /* --- CORE ENGINE --- */
        const App = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            clock: new THREE.Clock(),
            
            physicsWorld: null,
            physicsObjects: [], 
            allGameObjects: [], 
            
            init: () => {
                const vp = document.getElementById('viewport');
                
                // Three.js
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0xB0E0E6);
                App.scene.fog = new THREE.Fog(0xB0E0E6, 30, 200);

                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                App.camera.position.set(15, 15, 15);

                App.renderer = new THREE.WebGLRenderer({ antialias: true });
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                App.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                vp.appendChild(App.renderer.domElement);

                // I≈üƒ±klandƒ±rma
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); 
                App.scene.add(hemi);
                
                const dir = new THREE.DirectionalLight(0xffffff, 0.8); 
                dir.position.set(50,100,50); 
                dir.castShadow = true;
                dir.shadow.mapSize.width=2048; dir.shadow.mapSize.height=2048;
                dir.shadow.camera.left = -50; dir.shadow.camera.right = 50;
                dir.shadow.camera.top = 50; dir.shadow.camera.bottom = -50;
                App.scene.add(dir);

                // Kontroller (Orbit)
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.controls.enableDamping = true;
                App.controls.dampingFactor = 0.1;
                App.controls.maxDistance = 100;

                // Transform (Gizmo)
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', e => {
                    App.controls.enabled = !e.value;
                    if (!e.value && Editor.selected && Editor.selected.userData.body) {
                        // Fizik g√ºncelleme
                        const b = Editor.selected.userData.body;
                        b.velocity.set(0,0,0); b.angularVelocity.set(0,0,0);
                        World.updatePhysicsShape(Editor.selected);
                    }
                });
                App.transform.addEventListener('objectChange', () => {
                    if (!Editor.selected || !Editor.selected.userData.body) return;
                    const b = Editor.selected.userData.body;
                    const m = Editor.selected;
                    if (App.transform.mode !== 'scale') {
                        b.position.copy(m.position);
                        b.quaternion.copy(m.quaternion);
                    }
                    UI.updateProps(m);
                });
                App.scene.add(App.transform);

                // Cannon.js Fizik
                App.physicsWorld = new CANNON.World();
                App.physicsWorld.gravity.set(0, -30, 0);
                App.physicsWorld.broadphase = new CANNON.NaiveBroadphase();
                App.physicsWorld.defaultContactMaterial.friction = 0.0; // Oyuncu kaymasƒ± i√ßin

                window.addEventListener('resize', App.resize);
                UI.initToolbox();
                UI.setRibbonTab('Home');
                Events.init();
                App.loop();
            },
            
            resize: () => {
                const vp = document.getElementById('viewport');
                if (!vp) return;
                App.camera.aspect = vp.clientWidth / vp.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            setQuality: (q) => {
                App.renderer.setPixelRatio(q==='high' ? window.devicePixelRatio : 0.5);
                App.renderer.shadowMap.enabled = (q==='high');
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = App.clock.getDelta();

                if(Game.active) {
                    Game.update(dt);
                    App.physicsWorld.step(1/60, dt, 3);
                } else {
                    App.controls.update(); // Edit√∂r modu orbit
                }

                // Fizik -> Grafik Senkronizasyonu
                for (const mesh of App.physicsObjects) {
                    if (mesh.userData.body) {
                        mesh.position.copy(mesh.userData.body.position);
                        mesh.quaternion.copy(mesh.userData.body.quaternion);
                    }
                }
                
                App.renderer.render(App.scene, App.camera);
            }
        };

        /* --- WORLD & OBJECTS --- */
        const World = {
            loadTemplate: (type) => {
                document.getElementById('start-screen').style.display = 'none';
                
                // Zemin Kaplamasƒ±
                const cvs = document.createElement('canvas'); cvs.width=128; cvs.height=128;
                const ctx = cvs.getContext('2d');
                const color = type==='grass' || type==='village' ? '#5DA130' : '#9E9E9E';
                ctx.fillStyle = color; ctx.fillRect(0,0,128,128);
                // Stud efekti
                ctx.fillStyle = 'rgba(0,0,0,0.05)';
                for(let i=0;i<128;i+=16) for(let j=0;j<128;j+=16) ctx.fillRect(i,j,8,8);
                
                const tex = new THREE.CanvasTexture(cvs);
                tex.wrapS=THREE.RepeatWrapping; tex.wrapT=THREE.RepeatWrapping;
                tex.repeat.set(100, 100);
                tex.magFilter = THREE.NearestFilter;

                const geo = new THREE.BoxGeometry(400, 4, 400);
                const mat = new THREE.MeshStandardMaterial({map:tex});
                const baseMesh = new THREE.Mesh(geo, mat);
                baseMesh.name = "Baseplate";
                baseMesh.userData = { locked: true, anchored: true };
                baseMesh.receiveShadow = true;
                App.scene.add(baseMesh);
                UI.addExplorer(baseMesh);
                App.allGameObjects.push(baseMesh);

                // Fizik Zemin
                const baseShape = new CANNON.Box(new CANNON.Vec3(200, 2, 200));
                const baseBody = new CANNON.Body({ mass: 0 });
                baseBody.addShape(baseShape);
                baseBody.position.set(0, -2, 0);
                App.physicsWorld.addBody(baseBody);
                baseMesh.position.copy(baseBody.position);

                // Default Spawn
                World.add({
                    name:'SpawnLocation', shape:'cylinder', color:0x888888, anchored:true, scale:[6,0.5,6], pos: new THREE.Vector3(0, 0.25, 0)
                });
                
                if(type==='village') AI.build('village');
            },

            add: (config) => {
                let geo, shape;
                let scale = config.scale || [4,4,4];
                
                switch(config.shape) {
                    case 'sphere':
                        geo = new THREE.SphereGeometry(1, 24, 24);
                        shape = new CANNON.Sphere(0.5); // Yarƒ±√ßap
                        break;
                    case 'cylinder':
                        geo = new THREE.CylinderGeometry(1, 1, 1, 24);
                        shape = new CANNON.Cylinder(0.5, 0.5, 1, 12);
                        break;
                    case 'wedge':
                        geo = new THREE.ConeGeometry(1, 1, 4);
                        shape = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5)); // Basit kutu collider
                        break;
                    default: // Box
                        geo = new THREE.BoxGeometry(1, 1, 1);
                        shape = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5));
                }
                
                // Default anchored = true (Roblox stili yeni par√ßa)
                const isAnchored = config.anchored !== undefined ? config.anchored : true;
                const mass = isAnchored ? 0 : (config.mass || 5);

                let mat;
                if(config.mat==='neon') mat = new THREE.MeshBasicMaterial({color:config.color});
                else mat = new THREE.MeshStandardMaterial({color:config.color, roughness:0.3});
                
                if (config.op) { mat.transparent = true; mat.opacity = config.op; }

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(config.pos || new THREE.Vector3(0, 10, 0));
                mesh.scale.set(scale[0], scale[1], scale[2]);
                if(config.shape==='wedge') mesh.rotation.y=Math.PI/4;

                mesh.name = config.name || "Part";
                mesh.castShadow = true; mesh.receiveShadow = true;
                
                // Fizik Body
                const body = new CANNON.Body({ mass, material: App.physicsWorld.defaultMaterial });
                body.addShape(shape);
                body.position.copy(mesh.position);
                body.quaternion.copy(mesh.quaternion);
                
                World.updatePhysicsShape(mesh, body); // Kalƒ±bƒ± mesh scale'ine uydur
                App.physicsWorld.addBody(body);

                mesh.userData = {
                    body: body,
                    anchored: isAnchored,
                    canCollide: true,
                    script: config.script || "",
                    damage: config.damage || 0
                };
                body.userData = { mesh: mesh };

                App.scene.add(mesh);
                App.allGameObjects.push(mesh);
                if (!isAnchored) App.physicsObjects.push(mesh);
                
                UI.addExplorer(mesh);
                if(!Game.active) Editor.select(mesh);
                return mesh;
            },

            remove: (mesh) => {
                if (!mesh) return;
                if (mesh.userData.body) App.physicsWorld.removeBody(mesh.userData.body);
                
                let idx = App.physicsObjects.indexOf(mesh);
                if (idx > -1) App.physicsObjects.splice(idx, 1);
                
                idx = App.allGameObjects.indexOf(mesh);
                if (idx > -1) App.allGameObjects.splice(idx, 1);
                
                App.scene.remove(mesh);
                UI.removeExplorer(mesh);
            },
            
            updatePhysicsShape: (mesh, body = null) => {
                if (!body) body = mesh.userData.body;
                if (!body) return;
                
                const s = mesh.scale;
                const shape = body.shapes[0];
                
                // Cannon shape'i mesh scale'ine g√∂re g√ºncelle
                if (shape.type === CANNON.Shape.types.BOX) {
                    shape.halfExtents.set(s.x/2, s.y/2, s.z/2);
                } else if (shape.type === CANNON.Shape.types.SPHERE) {
                    shape.radius = Math.max(s.x, s.y, s.z) / 2;
                } else if (shape.type === CANNON.Shape.types.CYLINDER) {
                    shape.radiusTop = s.x/2; shape.radiusBottom = s.x/2; shape.height = s.y;
                }
                
                shape.updateBoundingSphereRadius();
                body.updateBoundingRadius();
                body.updateMassProperties();
            }
        };

        /* --- GAME & R6 PLAYER CONTROLLER --- */
        const Game = {
            active: false, 
            player: null, // Three Group (R6)
            playerBody: null, // Cannon Body (Capsule)
            onGround: false, 
            inputs: {x:0, y:0},
            health: 100, maxHealth: 100,
            
            // R6 Par√ßalarƒ± Referans
            limbs: { la:null, ra:null, ll:null, rl:null },

            play: () => {
                if(Game.active) return;
                Game.active = true;
                Editor.deselect();
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('properties').style.display = 'none';
                document.getElementById('toolbox').classList.add('closed');
                document.getElementById('game-overlay').style.display = 'block';
                UI.toggleXMenu(false);
                
                // Fiziƒüi senkronize et
                App.allGameObjects.forEach(m => {
                    if(m.userData.body) {
                        m.userData.body.position.copy(m.position);
                        m.userData.body.quaternion.copy(m.quaternion);
                        m.userData.body.velocity.set(0,0,0);
                        m.userData.body.angularVelocity.set(0,0,0);
                    }
                });
                
                Game.health = Game.maxHealth;
                Game.updateHealthHUD();
                Game.spawnPlayer();
                setTimeout(App.resize, 100);
            },

            stop: () => {
                Game.active = false;
                document.getElementById('ribbon').style.display = 'block';
                document.getElementById('properties').style.display = 'flex';
                document.getElementById('game-overlay').style.display = 'none';
                
                if(Game.player) { World.remove(Game.player); Game.player=null; Game.playerBody=null; }
                
                // Kamerayƒ± resetle
                App.controls.enabled = true;
                App.controls.enablePan = true;
                App.camera.position.set(15,15,15); 
                App.controls.target.set(0,0,0);
                
                setTimeout(App.resize, 100);
            },

            respawn: () => {
                if(Game.player) World.remove(Game.player);
                Game.health = Game.maxHealth;
                Game.updateHealthHUD();
                Game.spawnPlayer();
            },

            spawnPlayer: () => {
                // 1. Spawn Noktasƒ± Bul
                let spawnPos = new THREE.Vector3(0, 5, 0);
                const s = App.allGameObjects.find(o => o.name.includes("Spawn"));
                if (s) spawnPos.copy(s.position).add(new THREE.Vector3(0, 3, 0));

                // 2. R6 Rig Olu≈ütur (Grup)
                const rig = new THREE.Group();
                rig.name = "Player";
                
                const matSkin = new THREE.MeshPhongMaterial({color:0xFFCC80}); // Ten rengi
                const matTorso = new THREE.MeshPhongMaterial({color:0x0088FF}); // Mavi ti≈ü√∂rt
                const matLegs = new THREE.MeshPhongMaterial({color:0xA0A0A0}); // Gri pantolon

                // Par√ßa Boyutlarƒ± (Roblox Standardƒ±na yakƒ±n)
                // Head: 1x1x1, Torso: 2x2x1, Arms/Legs: 1x2x1
                
                // Head
                const head = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), matSkin);
                head.position.y = 1.5;
                rig.add(head);

                // Torso
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), matTorso);
                torso.position.y = 0;
                rig.add(torso);

                // Left Arm (Pivot noktasƒ± yukarƒ±da olsun diye parent group kullanabiliriz ama basitlik i√ßin direkt mesh ve animasyonda offset)
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matSkin);
                la.position.set(-1.5, 0, 0); 
                rig.add(la);

                // Right Arm
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matSkin);
                ra.position.set(1.5, 0, 0);
                rig.add(ra);

                // Left Leg
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matLegs);
                ll.position.set(-0.5, -2, 0);
                rig.add(ll);

                // Right Leg
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matLegs);
                rl.position.set(0.5, -2, 0);
                rig.add(rl);
                
                // Y√ºz Ekleme (Canvas)
                const fCanvas = document.createElement('canvas'); fCanvas.width=64; fCanvas.height=64;
                const fCtx = fCanvas.getContext('2d');
                fCtx.fillStyle='#333'; 
                fCtx.fillRect(15,20,10,10); fCtx.fillRect(40,20,10,10); // G√∂zler
                fCtx.beginPath(); fCtx.arc(32,45,10,0,Math.PI); fCtx.stroke(); // Aƒüƒ±z
                const face = new THREE.Mesh(new THREE.PlaneGeometry(0.8,0.8), new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(fCanvas), transparent:true}));
                face.position.set(0, 1.5, 0.51);
                rig.add(face);

                // Referanslarƒ± sakla
                Game.limbs = { la:la, ra:ra, ll:ll, rl:rl };

                // 3. Fizik Body (Kaps√ºl yerine Cylinder kullanƒ±yoruz daha stabil durmasƒ± i√ßin)
                const body = new CANNON.Body({ 
                    mass: 50, 
                    fixedRotation: true, 
                    material: App.physicsWorld.defaultMaterial 
                });
                // G√∂vde Collider
                body.addShape(new CANNON.Cylinder(1.5, 1.5, 5, 12), new CANNON.Vec3(0, -0.5, 0));
                body.position.copy(spawnPos);
                body.linearDamping = 0.9; // Hƒ±zlƒ± durmasƒ± i√ßin
                App.physicsWorld.addBody(body);

                body.addEventListener('collide', e => {
                    if(!Game.active) return;
                    const other = e.body.userData.mesh;
                    if(other && other.userData.damage) Game.takeDamage(other.userData.damage);
                });

                rig.userData.body = body;
                body.userData.mesh = rig;

                App.scene.add(rig);
                App.allGameObjects.push(rig);
                App.physicsObjects.push(rig);
                
                Game.player = rig;
                Game.playerBody = body;

                // Kamerayƒ± oyuncuya odakla ama kontrol√º serbest bƒ±rak (Zoom ve Orbit i√ßin)
                App.controls.enablePan = false; 
                App.controls.enableZoom = true;
            },
            
            takeDamage: (val) => {
                if(Game.health<=0) return;
                Game.health -= val;
                Game.updateHealthHUD();
                if(Game.health<=0) setTimeout(Game.respawn, 1000);
            },
            updateHealthHUD: () => {
                const b = document.getElementById('health-bar');
                b.style.width = (Game.health/Game.maxHealth)*100 + '%';
                b.style.background = Game.health<30 ? '#f44336' : '#4CAF50';
            },

            update: (dt) => {
                if(!Game.playerBody) return;
                const b = Game.playerBody;
                const m = Game.player;

                // 1. Zemin Kontrol√º
                Game.onGround = Math.abs(b.velocity.y) < 0.1;
                if(m.position.y < -50) Game.takeDamage(100);

                // 2. Kamera Y√∂n√º (OrbitControls y√∂n√ºne g√∂re)
                // Kameranƒ±n baktƒ±ƒüƒ± y√∂n√º al
                const camDir = new THREE.Vector3();
                App.camera.getWorldDirection(camDir);
                camDir.y = 0; camDir.normalize();
                const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x);

                // 3. Hareket Vekt√∂r√º
                const speed = 25;
                const inputVec = new THREE.Vector3(0,0,0);
                
                // Joystick Input
                if(Math.abs(Game.inputs.x)>0.1 || Math.abs(Game.inputs.y)>0.1) {
                    inputVec.add(camRight.clone().multiplyScalar(Game.inputs.x));
                    inputVec.add(camDir.clone().multiplyScalar(-Game.inputs.y));
                }

                // Keyboard Input (WASD)
                if(window.keys && (keys['w'] || keys['ArrowUp'])) inputVec.add(camDir);
                if(window.keys && (keys['s'] || keys['ArrowDown'])) inputVec.sub(camDir);
                if(window.keys && (keys['a'] || keys['ArrowLeft'])) inputVec.sub(camRight);
                if(window.keys && (keys['d'] || keys['ArrowRight'])) inputVec.add(camRight);

                // Hareket Uygula
                if(inputVec.lengthSq() > 0.1) {
                    inputVec.normalize();
                    b.velocity.x = inputVec.x * speed;
                    b.velocity.z = inputVec.z * speed;

                    // Karakter D√∂n√º≈ü√º (Kameradan baƒüƒ±msƒ±z, gittiƒüi y√∂ne bakar)
                    const targetRot = Math.atan2(inputVec.x, inputVec.z);
                    // Yumu≈üak d√∂n√º≈ü
                    const currentRot = m.rotation.y;
                    // A√ßƒ±yƒ± normalize et
                    let diff = targetRot - currentRot;
                    while(diff > Math.PI) diff -= Math.PI*2;
                    while(diff < -Math.PI) diff += Math.PI*2;
                    m.rotation.y += diff * 0.2;

                    // 4. R6 Animasyonu (Y√ºr√ºme)
                    const time = Date.now() * 0.015;
                    Game.limbs.la.rotation.x = Math.sin(time) * 0.8;
                    Game.limbs.ra.rotation.x = -Math.sin(time) * 0.8;
                    Game.limbs.ll.rotation.x = -Math.sin(time) * 0.8;
                    Game.limbs.rl.rotation.x = Math.sin(time) * 0.8;

                } else {
                    // Durma
                    b.velocity.x *= 0.8;
                    b.velocity.z *= 0.8;
                    
                    // Animasyon Sƒ±fƒ±rla
                    ['la','ra','ll','rl'].forEach(k => Game.limbs[k].rotation.x *= 0.8);
                }

                // 5. Kamera Takibi (Zoom ve Orbit'i bozmadan)
                // Hedefi oyuncunun √ºzerine ta≈üƒ±, b√∂ylece oyuncu etrafƒ±nda d√∂nebiliriz
                App.controls.target.lerp(m.position, 0.2);
                App.controls.update();
            },

            jump: () => {
                if(Game.onGround && Game.playerBody) Game.playerBody.velocity.y = 18;
            }
        };

        /* --- EDITOR --- */
        const Editor = {
            selected: null,
            setMode: (m) => {
                App.transform.setMode(m);
                document.querySelectorAll('.r-btn').forEach(b => b.classList.remove('active'));
                const btn = document.getElementById('btn-'+m);
                if(btn) btn.classList.add('active');
            },
            select: (obj) => {
                if(obj.userData.locked || obj.name==="Player") return;
                Editor.selected = obj;
                App.transform.attach(obj);
                UI.updateProps(obj);
            },
            deselect: () => {
                Editor.selected = null;
                App.transform.detach();
                UI.updateProps(null);
            },
            deleteSelected: () => {
                if(Editor.selected) {
                    const o = Editor.selected;
                    Editor.deselect();
                    World.remove(o);
                }
            }
        };

        /* --- UI MANAGER --- */
        const UI = {
            toggleToolbox: () => {
                document.getElementById('toolbox').classList.toggle('closed');
                setTimeout(App.resize, 300);
            },
            toggleXMenu: (force) => {
                const el = document.getElementById('x-menu');
                el.style.display = (force===false || el.style.display==='flex') ? 'none' : 'flex';
            },
            toggleAI: () => {
                const m = document.getElementById('ai-modal');
                m.style.display = (m.style.display==='flex') ? 'none' : 'flex';
            },
            setScale: (v) => document.documentElement.style.zoom = v,
            
            setRibbonTab: (tab) => {
                document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
                Array.from(document.querySelectorAll('.menu-item')).find(e => e.innerText===tab).classList.add('active');
                document.querySelectorAll('.ribbon-tab-content').forEach(e => e.classList.add('hidden'));
                document.getElementById('ribbon-content-'+tab.toLowerCase()).classList.remove('hidden');
            },

            initToolbox: () => UI.setTab('basic'),
            setTab: (cat, e) => {
                if(e) { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); }
                const list = document.getElementById('toolbox-list');
                list.innerHTML = '';
                
                const add = (n,c,s,a,d,m) => {
                    const div = document.createElement('div'); div.className='tool-item';
                    div.innerHTML = `<div class="t-preview" style="background:#${new THREE.Color(c).getHexString()}"></div>${n}`;
                    div.onclick = () => World.add({name:n, color:c, shape:s, anchored:a, damage:d, mat:m});
                    list.appendChild(div);
                };

                if(cat==='basic') {
                    add('Part', 0xeeeeee, 'box', true);
                    add('Sphere', 0xeeeeee, 'sphere', false);
                    add('Wedge', 0xFFEB3B, 'wedge', true);
                    add('Cylinder', 0x2196F3, 'cylinder', true);
                } else if(cat==='nature') {
                    add('Grass', 0x4CAF50, 'box', true);
                    add('Wood', 0x795548, 'box', true);
                    add('Leaves', 0x8BC34A, 'box', true);
                    add('Water', 0x03A9F4, 'box', true, 0, 'neon');
                } else {
                    add('Killbrick', 0xFF0000, 'box', true, 100, 'neon');
                    add('Lava', 0xFF5722, 'box', true, 10, 'neon');
                    add('Neon Light', 0xE0E0E0, 'box', true, 0, 'neon');
                }
            },

            addExplorer: (obj) => {
                const d = document.createElement('div'); d.className='tree-item';
                d.id = 'tree-'+obj.uuid;
                d.innerText = (obj.name==="Player"?"üë§ ":"üì¶ ") + obj.name;
                d.onclick = () => Editor.select(obj);
                document.getElementById('explorer').appendChild(d);
            },
            removeExplorer: (obj) => {
                const el = document.getElementById('tree-'+obj.uuid);
                if(el) el.remove();
            },

            updateProps: (obj) => {
                const p = document.getElementById('prop-content'); p.innerHTML='';
                if(!obj) { p.innerHTML='<div style="color:#888; text-align:center; margin-top:20px;">No Selection</div>'; return; }
                
                const row = (lbl, inp) => {
                    const d = document.createElement('div'); d.className='prop-row';
                    d.innerHTML = `<div class="prop-lbl">${lbl}</div>`; d.appendChild(inp); p.appendChild(d);
                };

                const iName = document.createElement('input'); iName.className='prop-inp'; iName.value=obj.name;
                iName.oninput=e=>{ obj.name=e.target.value; document.getElementById('tree-'+obj.uuid).innerText="üì¶ "+obj.name; };
                row('Name', iName);

                const iCol = document.createElement('input'); iCol.type='color'; iCol.value='#'+obj.material.color.getHexString();
                iCol.onchange=e=>obj.material.color.set(e.target.value);
                row('Color', iCol);

                const iAnch = document.createElement('input'); iAnch.type='checkbox'; iAnch.checked=obj.userData.anchored;
                iAnch.onchange=e=>{
                    const v = e.target.checked;
                    obj.userData.anchored=v;
                    if(v) {
                        obj.userData.body.mass=0; obj.userData.body.type=CANNON.Body.STATIC;
                        let i=App.physicsObjects.indexOf(obj); if(i>-1)App.physicsObjects.splice(i,1);
                    } else {
                        obj.userData.body.mass=5; obj.userData.body.type=CANNON.Body.DYNAMIC;
                        if(App.physicsObjects.indexOf(obj)===-1)App.physicsObjects.push(obj);
                    }
                    obj.userData.body.updateMassProperties();
                    obj.userData.body.velocity.set(0,0,0);
                };
                row('Anchored', iAnch);

                const btn = document.createElement('button'); btn.innerText='üìú Edit Script';
                btn.style.width='100%'; btn.style.marginTop='10px'; btn.style.padding='5px'; btn.style.cursor='pointer';
                btn.onclick = () => UI.openScript(obj);
                p.appendChild(btn);
            },

            openScript: (obj) => {
                document.getElementById('script-modal').style.display='flex';
                document.getElementById('script-name').innerText=obj.name;
                document.getElementById('code-area').value = obj.userData.script || 
`-- Script for ${obj.name}
function onTouch(otherPart)
    local humanoid = otherPart.Parent:FindFirstChild("Humanoid")
    if humanoid then
        print("Touched by player!")
    end
end
script.Parent.Touched:Connect(onTouch)
`;
                window.currScriptObj = obj;
            },
            saveScript: () => {
                if(window.currScriptObj) window.currScriptObj.userData.script = document.getElementById('code-area').value;
                document.getElementById('script-modal').style.display='none';
            }
        };

        /* --- LunAIX (Advanced AI) --- */
        const AI = {
            send: () => {
                const inp = document.getElementById('ai-input');
                const txt = inp.value.trim();
                if(!txt) return;
                
                const uMsg = document.createElement('div'); uMsg.className='ai-msg user'; uMsg.innerText = txt;
                document.getElementById('ai-chat').appendChild(uMsg);
                inp.value='';
                
                setTimeout(() => AI.process(txt), 600);
            },

            process: (txt) => {
                const l = txt.toLowerCase();
                let response = "Komutu tam anlayamadƒ±m. 'Build a red wall', 'Script kill block' gibi ≈üeyler deneyin.";
                
                // Renk Algƒ±lama
                let color = 0xeeeeee;
                if(l.includes('red') || l.includes('kƒ±rmƒ±zƒ±')) color=0xff0000;
                else if(l.includes('blue') || l.includes('mavi')) color=0x0000ff;
                else if(l.includes('green') || l.includes('ye≈üil')) color=0x00ff00;
                else if(l.includes('yellow') || l.includes('sarƒ±')) color=0xffff00;
                else if(l.includes('black') || l.includes('siyah')) color=0x111111;

                // Boyut Algƒ±lama
                let scale = [4,4,4];
                if(l.includes('big') || l.includes('giant') || l.includes('b√ºy√ºk')) scale=[10,10,10];
                if(l.includes('tall') || l.includes('uzun')) scale=[2,15,2];
                if(l.includes('flat') || l.includes('d√ºz')) scale=[10,0.5,10];

                // 1. BUILD Commands
                if(l.includes('build') || l.includes('make') || l.includes('create') || l.includes('spawn') || l.includes('yap')) {
                    const pos = new THREE.Vector3((Math.random()-0.5)*20, 5, (Math.random()-0.5)*20);
                    
                    if(l.includes('house') || l.includes('ev')) {
                        AI.buildPrefab('house', pos);
                        response = "Basit bir ev in≈üa edildi!";
                    } else if(l.includes('village') || l.includes('k√∂y')) {
                        AI.buildPrefab('village', pos);
                        response = "K√º√ß√ºk bir k√∂y olu≈üturuldu.";
                    } else if(l.includes('wall') || l.includes('duvar')) {
                        World.add({name:'AI_Wall', shape:'box', color:color, scale:[1,8,15], pos:pos, anchored:true});
                        response = "Bir duvar √∂r√ºld√º.";
                    } else if(l.includes('car') || l.includes('araba')) {
                        AI.buildPrefab('car', pos);
                        response = "Araba eklendi.";
                    } else if(l.includes('ball') || l.includes('sphere') || l.includes('top')) {
                        World.add({name:'AI_Ball', shape:'sphere', color:color, scale:scale, pos:pos, anchored:false});
                        response = "Fiziksel bir top eklendi.";
                    } else {
                        // Generic Part
                        let sName = l.includes('script') || l.includes('code') ? "ScriptedPart" : "AI_Part";
                        let dmg = (l.includes('kill') || l.includes('damage') || l.includes('√∂ld√ºr')) ? 100 : 0;
                        let scriptContent = "";

                        if(l.includes('kill') || l.includes('damage') || l.includes('script')) {
                            scriptContent = `-- AI Generated Script\nlocal part = script.Parent\nfunction onTouch(hit)\n  local h = hit.Parent:FindFirstChild("Humanoid")\n  if h then h:TakeDamage(100) end\nend\npart.Touched:Connect(onTouch)`;
                            if(dmg===0) dmg=100;
                            color = 0xff0000; // Tehlike rengi
                        }

                        const p = World.add({
                            name: sName, 
                            color: color, 
                            scale: scale, 
                            pos: pos, 
                            anchored: true, 
                            damage: dmg, 
                            script: scriptContent
                        });
                        
                        if(scriptContent) response = "Kodlu bir blok olu≈üturdum! √ñzelliklerden 'Edit Script' diyerek kodu g√∂rebilirsin.";
                        else response = "ƒ∞stediƒüin bloƒüu olu≈üturdum.";
                    }
                } 
                else if (l.includes('destroy') || l.includes('delete') || l.includes('sil')) {
                    if(Editor.selected) {
                        response = Editor.selected.name + " silindi.";
                        Editor.deleteSelected();
                    } else {
                        response = "Silmek i√ßin √∂nce bir nesne se√ßmelisin.";
                    }
                }

                const bMsg = document.createElement('div'); bMsg.className='ai-msg bot'; bMsg.innerText=response;
                const chat = document.getElementById('ai-chat');
                chat.appendChild(bMsg);
                chat.scrollTop = chat.scrollHeight;
            },

            buildPrefab: (type, center) => {
                if(type==='house') {
                    World.add({name:"Wall", scale:[1,8,10], pos:center.clone().add(new THREE.Vector3(-5,4,0)), color:0xC62828, anchored:true});
                    World.add({name:"Wall", scale:[1,8,10], pos:center.clone().add(new THREE.Vector3(5,4,0)), color:0xC62828, anchored:true});
                    World.add({name:"Wall", scale:[10,8,1], pos:center.clone().add(new THREE.Vector3(0,4,-5)), color:0xC62828, anchored:true});
                    World.add({name:"Roof", shape:'wedge', scale:[14,4,12], pos:center.clone().add(new THREE.Vector3(0,9,0)), color:0x3E2723, anchored:true});
                } else if(type==='car') {
                    World.add({name:"Chassis", scale:[4,1,8], pos:center.clone().add(new THREE.Vector3(0,1,0)), color:0x333, anchored:false});
                    World.add({name:"Body", scale:[4,2,5], pos:center.clone().add(new THREE.Vector3(0,2.5,-1)), color:0x1976D2, anchored:false});
                    // Tekerlekler basit√ße mesh olarak (Constraint yok bu basit demoda)
                    World.add({name:"W1", shape:'cylinder', scale:[1,1,1], pos:center.clone().add(new THREE.Vector3(2,0.5,2)), color:0x000, anchored:false});
                    World.add({name:"W2", shape:'cylinder', scale:[1,1,1], pos:center.clone().add(new THREE.Vector3(-2,0.5,2)), color:0x000, anchored:false});
                } else if(type==='village') {
                    AI.buildPrefab('house', center);
                    AI.buildPrefab('house', center.clone().add(new THREE.Vector3(20,0,0)));
                    AI.buildPrefab('house', center.clone().add(new THREE.Vector3(-20,0,0)));
                    World.add({name:"Well", shape:'cylinder', scale:[3,2,3], pos:center.clone().add(new THREE.Vector3(0,1,15)), color:0x555, anchored:true});
                }
            }
        };

        /* --- INPUT HANDLING --- */
        const Events = {
            init: () => {
                window.keys = {};
                document.addEventListener('keydown', e => window.keys[e.key] = true);
                document.addEventListener('keyup', e => window.keys[e.key] = false);

                // Raycasting (Selection)
                const vp = document.getElementById('viewport');
                vp.addEventListener('pointerdown', e => {
                    if(Game.active || e.target.id !== 'viewport' && e.target.tagName !== 'CANVAS') return;
                    if(App.transform.dragging) return;

                    const rect = vp.getBoundingClientRect();
                    const x = ((e.clientX - rect.left)/rect.width)*2 -1;
                    const y = -((e.clientY - rect.top)/rect.height)*2 +1;
                    
                    const ray = new THREE.Raycaster();
                    ray.setFromCamera({x,y}, App.camera);
                    const hits = ray.intersectObjects(App.allGameObjects, false); // False = sadece mesh
                    
                    if(hits.length>0) {
                        let target = hits[0].object;
                        // Eƒüer bir grup i√ßindeyse (√∂rn R6 karakter) en √ºst grubu bulma
                        // Ama edit√∂rde genelde tek mesh se√ßiyoruz. Baseplate kontrol√º:
                        if(!target.userData.locked) Editor.select(target);
                        else Editor.deselect();
                    } else Editor.deselect();
                });

                // Joystick
                const joy = document.getElementById('joystick-zone');
                const stick = document.getElementById('stick');
                let joyId = null;
                
                joy.addEventListener('pointerdown', e => {
                    e.preventDefault(); joyId = e.pointerId;
                    joy.setPointerCapture(e.pointerId);
                    
                    const updateStick = (cx, cy) => {
                        const r = joy.getBoundingClientRect();
                        const cX = r.left + r.width/2;
                        const cY = r.top + r.height/2;
                        const dx = cx - cX;
                        const dy = cy - cY;
                        const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                        const ang = Math.atan2(dy, dx);
                        const sx = Math.cos(ang)*dist;
                        const sy = Math.sin(ang)*dist;
                        stick.style.transform = `translate(${sx}px, ${sy}px)`;
                        Game.inputs.x = sx/40; 
                        Game.inputs.y = sy/40;
                    };
                    updateStick(e.clientX, e.clientY);

                    joy.onpointermove = ev => { if(ev.pointerId===joyId) updateStick(ev.clientX, ev.clientY); };
                    joy.onpointerup = () => {
                        joy.onpointermove = null; joyId=null;
                        stick.style.transform = `translate(0,0)`;
                        Game.inputs = {x:0, y:0};
                    };
                });

                // Jump
                document.getElementById('jump-btn').addEventListener('pointerdown', e => {
                    e.preventDefault(); Game.jump();
                });
            }
        };
    </script>
</body>
</html>
