<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunX Studio Pro | Mehmet Bey Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (IDE'ler için ideal) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <!-- Three.js ve OrbitControls -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/controls/OrbitControls.min.js"></script>
    
    <!-- İkon Seti: SVG Fonksiyonu -->
    <script>
        // Lucide SVG İkon fonksiyonu (Daha fazla ikon içerir)
        function Icon(name, classes = 'w-5 h-5', strokeWidth = '2') {
            const icons = {
                // Temel UI İkonları
                Home: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
                Layers: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m12 1.5 8.5 4.5L12 10.5 3.5 6 12 1.5Z"/><path d="m20.5 12-8.5 4.5-8.5-4.5"/><path d="m20.5 16.5-8.5 4.5-8.5-4.5"/></svg>`,
                Cube: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7.6 8.7 5.01 8.7-5.01"/><path d="M12 22V12.5"/></svg>`,
                Play: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" class="${classes}"><polygon points="5 3 19 12 5 21 5 3"/></svg>`,
                Square: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" class="${classes}"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>`,
                Plus: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
                Settings: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.75 1.3a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.55a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.75 1.3a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 1-1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.75-1.3a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.73v-.55a2 2 0 0 1 1-1.73l.15-.08a2 2 0 0 0 .73-2.73l-.75-1.3a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
                Move: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M5 9l-3 3 3 3"/><path d="M19 9l3 3-3 3"/><path d="M9 5l3-3 3 3"/><path d="M9 19l3 3 3-3"/><path d="M2 12h20"/><path d="M12 2v20"/></svg>`,
                Rotate: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M21 12a9 9 0 1 1-9-9c1 2.5 4.17 2.5 5 5v3"/><path d="M17 12V5h-3"/><path d="M14 17l-3-3 3-3"/></svg>`,
                Scale: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M4 7l2-2 2 2"/><path d="M14 18l2 2 2-2"/><path d="M8 10l-4 4"/><path d="M12 14l-4 4"/><path d="M16 6l4 4"/><path d="M20 10l-4 4"/><path d="M3 21l3-3"/><path d="M21 3l-3 3"/></svg>`,
                Code: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
                Database: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/><path d="M3 19A9 3 0 0 0 21 19"/></svg>`,
                Component: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m3 12 8-8 8 8-8 8-8-8Z"/><path d="m7 12 4 4 4-4-4-4-4 4Z"/></svg>`,
            };
            return icons[name] || '';
        }

        // Global Icon Injection Function
        function injectIcon(elementId, iconName, iconClass, strokeWidth = '2') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = Icon(iconName, iconClass, strokeWidth);
            }
        }
    </script>
    
    <!-- Firebase/Firestore (Zorunlu Global Değişkenler) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        window.firebaseReady = false;
        window.db = null;
        window.userId = null;
        
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        // ID'yi ve ikonunu düzgünce yerleştir
                        document.getElementById('user-id-display').innerHTML = Icon('Database', 'w-4 h-4 mr-1') + user.uid; 
                        window.firebaseReady = true;
                        console.log("Firebase ve Auth hazır. UID:", user.uid);
                    } else {
                        console.log("Kullanıcı anonim olarak oturum açtı veya oturum açma bekleniyor.");
                    }
                });
            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
            }
        };

        initFirebase();
    </script>

    <style>
        /* Profesyonel Koyu Tema ve IDE Düzeni (Daha Keskin Kontrast) */
        :root {
            --color-bg-primary: #121820; /* Koyu Mavi-Gri */
            --color-bg-panel: #1e293b;   /* Slate-800: Panel Arka Planı */
            --color-bg-header: #0a0e14;  /* Çok Koyu Başlık/Ribbon */
            --color-accent: #10b981;     /* Zümrüt Yeşili Vurgu (Profesyonel) */
            --color-text: #e2e8f0;       /* Açık Gri Metin */
            --color-border: #334155;     /* Sınır Çizgisi */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text);
            height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        /* RIBBON STYLES */
        .ribbon-tab {
            @apply px-4 py-2 text-sm font-semibold cursor-pointer border-b-2 border-transparent transition duration-150 hover:bg-slate-800/50;
        }
        .ribbon-tab.active {
            @apply border-emerald-400 text-white bg-slate-800;
        }
        .ribbon-btn {
            @apply flex flex-col items-center justify-center p-2 rounded-lg transition duration-150 text-xs font-medium hover:bg-slate-700/50 hover:text-white border-b-2 border-transparent;
            height: 75px; 
            min-width: 70px;
        }
        .ribbon-group {
            @apply border-r border-slate-700 p-2 h-full flex flex-row items-start;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 250px 1fr 300px; /* Belirlenmiş Boyutlar */
            height: calc(100vh - 150px - 50px); /* Başlık+Ribbon (150) + Footer (50) */
            gap: 0.5rem; 
            padding: 0.5rem;
        }
        .panel {
            background-color: var(--color-bg-panel);
            border-radius: 0.5rem; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            background-color: #1a2332; 
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text);
            font-size: 0.9rem;
            font-weight: 700;
        }
        #scene-container {
            height: 100%;
            width: 100%;
            background-color: #111827; 
            cursor: grab;
        }
        .entity-item {
            @apply p-2 cursor-pointer transition duration-100 border-l-4 border-transparent hover:bg-slate-700/40;
        }
        .entity-item.selected {
            @apply bg-slate-700/80 border-l-4 border-emerald-500 font-semibold;
        }
        .log-output {
            max-height: 50px; 
            overflow-y: scroll;
            font-family: monospace;
            background-color: #0c121e; 
            color: #94a3b8; 
            font-size: 0.75rem;
            padding: 0.5rem;
        }
        .input-field {
            background-color: #0f172a; /* Slate-900 */
            color: #f3f4f6;
            border: 1px solid #334155;
            padding: 0.25rem 0.5rem;
            @apply rounded-md focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition duration-150;
        }
        
        /* Mobil Düzen */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                height: auto;
                overflow-y: auto;
                padding-bottom: 50px; /* Footer için yer */
            }
            #scene-container { height: 60vh; }
            body { height: auto; overflow-y: auto; }
            .ribbon-tabs-bar { overflow-x: auto; white-space: nowrap; }
            .ribbon-content { flex-wrap: wrap; height: auto; }
            .ribbon-btn { height: 65px; min-width: 60px; }
            .ribbon-group { border-right: none; border-bottom: 1px solid var(--color-border); flex-wrap: wrap; }
            .panel { margin-bottom: 0.5rem; }
            footer { position: fixed; bottom: 0; left: 0; right: 0; }
        }
    </style>
</head>
<body>
    
    <!-- 1. Üst Araç Çubuğu (Ribbon Toolbar) -->
    <header class="bg-gray-900 shadow-2xl flex-none border-b border-gray-800">
        
        <!-- Başlık ve Çalıştır Butonları -->
        <div class="p-2 flex justify-between items-center border-b border-gray-800">
            <h1 class="text-xl font-extrabold text-white ml-2 flex items-center">
                <span class="text-emerald-500 mr-2" id="app-icon-placeholder"></span> LunX Studio <span class="text-xs text-slate-500 ml-1 font-medium">V3.0</span>
            </h1>
            
            <!-- Oyun Kontrolleri -->
            <div class="flex space-x-2">
                <button id="run-game-btn" class="flex items-center bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    <span id="play-icon-placeholder" class="mr-1"></span> OYUNU BAŞLAT
                </button>
                <button id="stop-game-btn" class="flex items-center bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 opacity-50 cursor-not-allowed" disabled>
                    <span id="square-icon-placeholder" class="mr-1"></span> DURDUR
                </button>
            </div>

            <!-- Kullanıcı ve Durum -->
            <div class="flex items-center text-slate-400 mr-2 text-sm">
                <span id="engine-status" class="text-yellow-400 mr-4 font-semibold">Motor: Yükleniyor... (C++)</span>
                <div id="user-id-display" class="flex items-center bg-slate-800 p-1 px-3 rounded-full text-xs">
                    <span id="user-icon-placeholder" class="mr-1"></span> Yükleniyor...
                </div>
            </div>
        </div>

        <!-- Ribbon Sekmeleri -->
        <div class="flex items-end bg-gray-900 text-slate-400 border-b border-gray-700 ribbon-tabs-bar">
            <div class="ribbon-tab active" data-tab="home-tab"><span class="tab-icon-placeholder" data-icon="Home" data-class="w-4 h-4 mr-2"></span> HOME</div>
            <div class="ribbon-tab" data-tab="model-tab"><span class="tab-icon-placeholder" data-icon="Cube" data-class="w-4 h-4 mr-2"></span> MODELLER</div>
            <div class="ribbon-tab" data-tab="script-tab"><span class="tab-icon-placeholder" data-icon="Code" data-class="w-4 h-4 mr-2"></span> SCRIPTLER</div>
            <div class="ribbon-tab" data-tab="settings-tab"><span class="tab-icon-placeholder" data-icon="Settings" data-class="w-4 h-4 mr-2"></span> AYARLAR</div>
        </div>

        <!-- Ribbon İçeriği -->
        <div id="ribbon-content-container" class="bg-gray-800/70 py-1 px-2 border-b border-gray-900 h-[100px] flex items-center">
            <div id="home-tab" class="ribbon-content flex space-x-2 items-center h-full">
                <!-- Varlık Düzenleme Araçları -->
                <div class="ribbon-group">
                    <button class="ribbon-btn">
                        <span class="ribbon-btn-icon" data-icon="Move" data-class="w-8 h-8"></span>
                        <span>Taşı (Move)</span>
                    </button>
                    <button class="ribbon-btn">
                        <span class="ribbon-btn-icon" data-icon="Rotate" data-class="w-8 h-8"></span>
                        <span>Döndür (Rotate)</span>
                    </button>
                    <button class="ribbon-btn">
                        <span class="ribbon-btn-icon" data-icon="Scale" data-class="w-8 h-8"></span>
                        <span>Ölçekle (Scale)</span>
                    </button>
                </div>
                <!-- Varlık Ekleme -->
                <div class="ribbon-group">
                     <button id="add-block-btn" class="ribbon-btn bg-emerald-600/30 text-emerald-300 hover:bg-emerald-700/50 border-emerald-500/50">
                        <span class="ribbon-btn-icon" data-icon="Plus" data-class="w-8 h-8" data-stroke="3"></span>
                        <span>Part Ekle (ECS)</span>
                    </button>
                </div>
            </div>
            <!-- Diğer tab içerikleri buraya eklenebilir -->
             <div id="model-tab" class="ribbon-content hidden p-4 text-sm text-slate-400">Yüksek Kaliteli Mesh İçe Aktarma ve LOD (Level of Detail) Araçları.</div>
             <div id="script-tab" class="ribbon-content hidden p-4 text-sm text-slate-400">C++ ECS Komponentleri için Lua/C# Script Bağlantıları Paneli.</div>
             <div id="settings-tab" class="ribbon-content hidden p-4 text-sm text-slate-400">Motor Ayarları, FPS Limitleme, Grafik Kalitesi Profilleri.</div>
        </div>
    </header>

    <!-- 2. Ana Çalışma Alanı (Grid) -->
    <main class="main-grid flex-grow">

        <!-- Sol Panel: Explorer (Hiyerarşi) -->
        <div class="panel">
            <div class="panel-header flex justify-between items-center" id="explorer-header">
                <span class="flex items-center" id="explorer-header-icon"></span> Hierarchy
            </div>
            <div id="hierarchy-list" class="flex flex-col space-y-0.5 text-sm flex-grow overflow-y-auto p-1">
                <p class="text-slate-500 p-2 text-sm">C++ Motoru, Varlıkları Yüklüyor...</p>
            </div>
        </div>

        <!-- Orta Panel: 3D Viewport (Su dahil) -->
        <div class="panel p-0">
            <div class="panel-header font-semibold text-center">3D Viewport (Sahne Görünümü) | <span id="fps-display" class="text-xs text-emerald-400 font-normal">FPS: 60</span></div>
            <div id="scene-container" class="flex-grow">
                <!-- Three.js Canvas Buraya Gelecek -->
            </div>
        </div>

        <!-- Sağ Panel: Properties (Özellikler) -->
        <div class="panel h-full flex flex-col">
            <div class="panel-header flex items-center">
                <span id="settings-icon-placeholder"></span> Özellikler: <span id="selected-entity-name" class="ml-2 text-emerald-400 font-extrabold">HIÇBIRI SEÇILI DEĞIL</span>
            </div>
            <div id="properties-panel" class="p-3 text-slate-300 space-y-4 flex-grow overflow-y-auto">
                <p id="property-placeholder" class="text-sm text-slate-500">ECS mimarisinden gelen Transform, Renderable ve diğer Component'ler burada görünecektir.</p>
            </div>
        </div>
    </main>

    <!-- 3. Alt Konsol (Footer/Output) -->
    <footer class="bg-gray-900 flex-none border-t border-gray-800 h-[50px]">
        <div class="log-output flex-grow" id="log-output">
            <p>LunX Studio V3.0 Başlatılıyor...</p>
        </div>
    </footer>

    <!-- WebAssembly (motor.js) ve THREE.js Entegrasyon Betiği -->
    <script>
        // ==========================================================
        // C++ Motoru İletişimi (Emscripten Module) ve UI Logic
        // ==========================================================
        let Module = {};
        window.Module = Module;

        const CppInterface = {
            selectedEntityId: null,
            entityObjects: new Map(), // Varlık ID'sini Three.js objesine eşler
            
            // -----------------------------------------------------
            // 1. C++'tan Geri Çağrılan Fonksiyonlar (JS_*)
            // -----------------------------------------------------

            // C++'tan gelen log mesajlarını konsola yazar
            JS_LogOutput: (messagePtr) => {
                if (!Module.UTF8ToString) return; 
                
                const message = Module.UTF8ToString(messagePtr);
                const log = document.getElementById('log-output');
                const p = document.createElement('p');
                p.className = message.includes("HATA") ? 'text-red-400' : (message.includes("ECS") ? 'text-emerald-400' : 'text-slate-400');
                p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                log.prepend(p);
            },
            
            // C++'tan gelen yeni varlığı Hiyerarşi listesine ekler
            JS_AddHierarchyItem: (namePtr, id) => {
                const name = Module.UTF8ToString(namePtr);
                const list = document.getElementById('hierarchy-list');
                const button = document.createElement('button');
                
                button.className = 'entity-item text-left flex items-center w-full';
                button.setAttribute('data-id', id);
                button.innerHTML = `${Icon('Component', 'w-4 h-4 mr-2 text-yellow-400')} <span>${name}</span>`;
                button.onclick = () => CppInterface.selectEntity(id, button);
                
                if (list.querySelector('p')) { list.innerHTML = ''; }
                list.appendChild(button);
                
                // İlk varlığı otomatik seç
                if (CppInterface.selectedEntityId === null) {
                    CppInterface.selectEntity(id, button);
                }
            },

            // C++'tan gelen varlık pozisyonu ve geometrisini 3D'de oluşturur
            JS_Spawn3DObject: (id, x, y, z, r, g, b) => {
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshPhongMaterial({ 
                    color: new THREE.Color(r, g, b),
                    specular: 0x333333,
                    shininess: 50,
                    emissive: 0x000000 
                });
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.set(x, y, z);
                mesh.userData.entityId = id; 
                scene.add(mesh);
                
                CppInterface.entityObjects.set(id, mesh);
            },
            
            // C++'tan gelen varlık transformasyonunu 3D'de günceller (Ana döngü)
            JS_UpdateObject: (id, x, y, z) => {
                const mesh = CppInterface.entityObjects.get(id);
                if (mesh) {
                    mesh.position.set(x, y, z);
                    
                    // Eğer güncellenen varlık seçiliyse, özellikler panelini güncel tut
                    if (CppInterface.selectedEntityId === id) {
                         // Bu, performansı düşürür, gerçek motorda sadece kullanıcı girişinde yapılır.
                         // Şu an sadece ECS döngüsünün çalıştığını göstermek için burada.
                         const propsPtr = Module.GetEntityProperties(id);
                         const propsJson = Module.UTF8ToString(propsPtr);
                         Module._free(propsPtr);
                         CppInterface.renderPropertiesPanel(id, JSON.parse(propsJson));
                    }
                }
            },
            
            // -----------------------------------------------------
            // 2. JS'ten C++'a Çağrılan Fonksiyonlar (Wrapperlar)
            // -----------------------------------------------------
            
            selectEntity: (id, button = null) => {
                if (!Module.GetEntityProperties) return;

                // UI Seçim Vurgusu
                document.querySelectorAll('.entity-item').forEach(el => el.classList.remove('selected'));
                const targetButton = button || document.querySelector(`[data-id="${id}"]`);
                if (targetButton) {
                    targetButton.classList.add('selected');
                }
                
                // 3D Seçim Vurgusu
                CppInterface.entityObjects.forEach(mesh => {
                    if (mesh.material && mesh.material.emissive) {
                       mesh.material.emissive.setHex(0x000000); 
                    }
                });
                const selectedMesh = CppInterface.entityObjects.get(id);
                if (selectedMesh) {
                    selectedMesh.material.emissive.setHex(0x10b981); // Emerald vurgu
                }

                CppInterface.selectedEntityId = id;
                const entityName = targetButton ? targetButton.querySelector('span').textContent : 'ID: ' + id;
                document.getElementById('selected-entity-name').textContent = entityName;

                // C++'tan güncel özellikleri al
                const propsPtr = Module.GetEntityProperties(id);
                const propsJson = Module.UTF8ToString(propsPtr);
                Module._free(propsPtr); 
                
                CppInterface.renderPropertiesPanel(id, JSON.parse(propsJson));
            },

            // Varlık Özelliklerini dinamik olarak Property Panel'e çiz
            renderPropertiesPanel: (id, data) => {
                const panel = document.getElementById('properties-panel');
                panel.innerHTML = '';
                document.getElementById('property-placeholder').style.display = 'none';

                if (data.error) {
                    panel.innerHTML = `<p class="text-red-400 p-2">${data.error}</p>`;
                    return;
                }
                
                // Her Component için bir kart oluştur
                for (const compType in data.components) {
                    const compData = data.components[compType];
                    const compDiv = document.createElement('details');
                    compDiv.className = 'bg-slate-800 p-3 rounded-xl shadow-xl border border-slate-700 open:bg-slate-900';
                    compDiv.open = true; // Varsayılan olarak açık
                    
                    compDiv.innerHTML = `<summary class="text-white font-bold text-base mb-2 cursor-pointer hover:text-emerald-400 transition duration-150 flex items-center">
                        ${Icon('Component', 'w-5 h-5 mr-2 text-emerald-400')} ${compType} Component</summary>`;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'pt-2 space-y-2 border-t border-slate-700/50 mt-2';

                    for (const propName in compData) {
                        const propValue = compData[propName];
                        const propDiv = document.createElement('div');
                        propDiv.className = 'flex items-center justify-between space-x-2 py-1 text-sm';

                        const label = document.createElement('label');
                        label.className = 'text-slate-400 w-2/5 truncate font-medium';
                        label.textContent = propName;
                        propDiv.appendChild(label);


                        // İki ana tür: Boolean (checkbox) ve Sayı/Metin (input)
                        if (typeof propValue === 'boolean' || propValue === 'true' || propValue === 'false') {
                             // Boolean (Checkbox)
                             const checkbox = document.createElement('input');
                             checkbox.type = 'checkbox';
                             checkbox.checked = propValue === 'true' || propValue === true;
                             checkbox.className = 'h-5 w-5 rounded text-emerald-600 border-gray-600 focus:ring-emerald-500 bg-gray-900';
                             checkbox.onchange = (e) => {
                                 CppInterface.updateProperty(id, compType, propName, e.target.checked ? 'true' : 'false');
                             };
                             propDiv.appendChild(checkbox);

                        } else {
                            // Sayı/Metin (Input)
                            const input = document.createElement('input');
                            const isNumber = !isNaN(parseFloat(propValue)) && isFinite(propValue);
                            
                            input.type = isNumber ? 'number' : 'text';
                            input.step = isNumber && ['x', 'y', 'z'].includes(propName) ? '0.01' : 'any'; // Daha hassas adım
                            input.className = 'input-field w-3/5 text-right';
                            input.value = propValue;
                            
                            // Kullanıcı girişini ECS'e gönder
                            input.onchange = (e) => {
                                CppInterface.updateProperty(id, compType, propName, e.target.value);
                            };
                            propDiv.appendChild(input);
                        }
                        
                        contentDiv.appendChild(propDiv);
                    }

                    compDiv.appendChild(contentDiv);
                    panel.appendChild(compDiv);
                }
            },
            
            // Property değişikliğini C++'a gönderir
            updateProperty: (id, compType, propName, propValue) => {
                 if (Module.SetEntityProperty) {
                    // String'leri C++ heap'ine kopyala
                    Module.SetEntityProperty(
                        id,
                        Module.stringToUTF8(compType),
                        Module.stringToUTF8(propName),
                        Module.stringToUTF8(String(propValue))
                    );
                 } else {
                     CppInterface.JS_LogOutput(Module.stringToUTF8("Hata: Motor SetEntityProperty hazır değil."));
                 }
            }
        };

        window.CppInterface = CppInterface;


        // ==========================================================
        // Three.js 3D Görünüm Kurulumu ve Gelişmiş Su Simülasyonu
        // ==========================================================

        let scene, camera, renderer, controls, raycaster, mouse;
        let water;
        let clock = new THREE.Clock();
        const WATER_LEVEL = -0.5; // Su seviyesi

        // Water Shader (Daha gerçekçi dalgalanma ve yansıma için)
        const waterVertexShader = `
            uniform float time;
            uniform float waveSpeed;
            uniform float waveHeight;
            uniform vec2 resolution;

            varying vec3 vWorldPosition;
            varying vec2 vUv;

            void main() {
                vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;
                vUv = uv;

                // İki katmanlı sinüs dalgası (Daha karmaşık yüzey için)
                float displacement = 0.0;
                displacement += sin(vWorldPosition.x * 2.5 + time * waveSpeed) * waveHeight * 0.5;
                displacement += cos(vWorldPosition.z * 3.0 - time * waveSpeed * 1.5) * waveHeight * 0.3;
                
                vec3 newPosition = position;
                newPosition.y += displacement; 
                
                gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
            }
        `;

        const waterFragmentShader = `
            uniform vec3 waterColor;
            uniform vec3 deepColor;
            uniform float time;
            uniform vec3 sunDirection;
            uniform vec3 cameraPosition;
            uniform vec3 skyColor;

            varying vec3 vWorldPosition;
            varying vec2 vUv;

            void main() {
                // 1. Derinlik Simülasyonu
                float depthFactor = clamp((-vWorldPosition.y - ${WATER_LEVEL.toFixed(1)}) * 0.2 + 0.5, 0.0, 1.0);
                vec3 baseColor = mix(waterColor, deepColor, depthFactor);

                // 2. Fresnel Yansıma (Kenarlara doğru artan yansıma)
                vec3 viewDirection = normalize(cameraPosition - vWorldPosition);
                vec3 normal = vec3(0.0, 1.0, 0.0);
                
                // Dinamik Normal: Yüzeyin hareketine bağlı normal değişimi (Basit Pırıltı)
                float wavePerturbationX = cos(vWorldPosition.x * 5.0 + time * 3.0) * 0.01;
                float wavePerturbationZ = sin(vWorldPosition.z * 5.0 + time * 4.0) * 0.01;
                normal.x += wavePerturbationX;
                normal.z += wavePerturbationZ;
                normal = normalize(normal);

                float fresnel = pow(1.0 - max(dot(viewDirection, normal), 0.0), 5.0);
                
                // Yansıma (Gökyüzü rengini yansıt)
                vec3 reflection = skyColor;
                
                // 3. Parlaklık (Specular)
                vec3 reflectedLight = reflect(-sunDirection, normal);
                float specular = pow(max(dot(viewDirection, reflectedLight), 0.0), 64.0) * 0.5;
                
                // Nihai Renk: Temel Renk + Fresnel Yansıma + Parlaklık
                vec3 finalColor = mix(baseColor, reflection, fresnel * 0.8) + vec3(specular);
                
                // Dalgalanma üzerinde hafif köpük/açıklık efekti
                float foam = smoothstep(0.9, 1.0, sin(time * 5.0 + vWorldPosition.x * 10.0 + vWorldPosition.z * 10.0));
                finalColor += vec3(foam * 0.05);

                gl_FragColor = vec4(finalColor, 0.9); // Hafif şeffaflık
            }
        `;


        function initWater() {
            const waterGeometry = new THREE.PlaneGeometry(200, 200, 128, 128); // Daha yüksek çözünürlük
            waterGeometry.rotateX(-Math.PI / 2); 

            const waterMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 0.0 },
                    waveSpeed: { value: 0.5 },
                    waveHeight: { value: 0.1 },
                    waterColor: { value: new THREE.Color(0x00aaff) }, // Açık Mavi
                    deepColor: { value: new THREE.Color(0x004488) },   // Koyu Mavi
                    sunDirection: { value: new THREE.Vector3(1.0, 1.0, 1.0).normalize() },
                    cameraPosition: { value: camera.position },
                    skyColor: { value: scene.background },
                    resolution: { value: new THREE.Vector2() }
                },
                vertexShader: waterVertexShader,
                fragmentShader: waterFragmentShader,
                transparent: true,
                lights: false, 
            });

            water = new THREE.Mesh(waterGeometry, waterMaterial);
            water.position.y = WATER_LEVEL;
            water.name = "Water";
            scene.add(water);
            
            // Su varlığını Hiyerarşi'ye ekle
            const list = document.getElementById('hierarchy-list');
            const button = document.createElement('button');
            button.className = 'entity-item text-left flex items-center w-full';
            button.setAttribute('data-id', 0); // Ground/Water ID'si
            button.innerHTML = `${Icon('Layers', 'w-4 h-4 mr-2 text-blue-400')} <span>World (Water, Terrain)</span>`;
            if (list.querySelector('p')) { list.innerHTML = ''; }
            list.appendChild(button);
        }

        function initThreeJS() {
            const container = document.getElementById('scene-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x7acfff); // Gökyüzü Mavisi
            
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(20, 15, 20); // Daha geniş bakış açısı

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.dampingFactor = 0.08;
            controls.mouseButtons = { 
                LEFT: THREE.MOUSE.PAN,      
                MIDDLE: THREE.MOUSE.DOLLY, 
                RIGHT: THREE.MOUSE.ROTATE   
            };

            // Lighting (Güneş Işığı)
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const sunLight = new THREE.DirectionalLight(0xffffee, 2.0); // Daha parlak güneş
            sunLight.position.set(50, 150, 50);
            scene.add(sunLight);
            
            initWater();

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('resize', onWindowResize, false);
            container.addEventListener('click', onCanvasClick, false);
            
            animate();
        }

        function onWindowResize() {
            const container = document.getElementById('scene-container');
            if (container) {
                const width = container.clientWidth;
                const height = container.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        }
        
        // FPS Hesaplama
        let frameCount = 0;
        let lastTime = performance.now();
        const fpsElement = document.getElementById('fps-display');

        function animate() {
            requestAnimationFrame(animate);
            controls.update(); 
            
            // FPS Güncelleme
            frameCount++;
            const currentTime = performance.now();
            const elapsed = currentTime - lastTime;
            if (elapsed > 1000) {
                const fps = Math.round((frameCount * 1000) / elapsed);
                fpsElement.textContent = `FPS: ${fps}`;
                frameCount = 0;
                lastTime = currentTime;
            }

            // Su animasyonunu güncelle
            if (water) {
                const delta = clock.getDelta();
                water.material.uniforms.time.value += delta;
                water.material.uniforms.cameraPosition.value.copy(camera.position);
            }
            
            renderer.render(scene, camera);
        }

        function onCanvasClick(event) {
            const container = document.getElementById('scene-container');
            const rect = container.getBoundingClientRect();
            
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            
            const intersectableObjects = Array.from(CppInterface.entityObjects.values());
            const intersects = raycaster.intersectObjects(intersectableObjects, true);

            if (intersects.length > 0) {
                const selectedMesh = intersects[0].object;
                const entityId = selectedMesh.userData.entityId;

                if (entityId) {
                    CppInterface.selectEntity(entityId);
                }
            } else {
                 // Boş alana tıklandı, seçimi sıfırla
                 CppInterface.selectedEntityId = null;
                 document.getElementById('selected-entity-name').textContent = 'HIÇBIRI SEÇILI DEĞIL';
                 document.getElementById('properties-panel').innerHTML = '<p id="property-placeholder" class="text-sm text-slate-500 p-2">Lütfen bir varlık seçin...</p>';
                 CppInterface.entityObjects.forEach(mesh => {
                    if (mesh.material && mesh.material.emissive) {
                        mesh.material.emissive.setHex(0x000000);
                    }
                 });
                 document.querySelectorAll('.entity-item').forEach(el => el.classList.remove('selected'));
            }
        }


        // ==========================================================
        // UI Olay Dinleyicileri ve Motor Başlatma
        // ==========================================================

        function setupIcons() {
            // 1. Üst Başlık İkonları
            injectIcon('app-icon-placeholder', 'Cube', 'w-6 h-6');
            injectIcon('play-icon-placeholder', 'Play', 'w-4 h-4 mr-1');
            injectIcon('square-icon-placeholder', 'Square', 'w-4 h-4 mr-1');

            // 2. Ribbon İkonları (Tab Başlıkları) ve Butonlar
            document.querySelectorAll('.tab-icon-placeholder, .ribbon-btn-icon').forEach(span => {
                const iconName = span.getAttribute('data-icon');
                const iconClass = span.getAttribute('data-class');
                const strokeWidth = span.getAttribute('data-stroke') || '2';
                span.innerHTML = Icon(iconName, iconClass, strokeWidth);
            });
            
            // 3. Panel Başlık İkonları
            document.getElementById('explorer-header-icon').innerHTML = Icon('Layers', 'w-5 h-5 mr-2 text-slate-400');
            document.getElementById('settings-icon-placeholder').innerHTML = Icon('Settings', 'w-5 h-5 mr-2 text-slate-400');
        }
        
        // Ribbon Tab Yönetimi
        function setupRibbonTabs() {
            const tabs = document.querySelectorAll('.ribbon-tab');
            const contents = document.querySelectorAll('.ribbon-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const targetId = tab.getAttribute('data-tab');
                    contents.forEach(content => {
                        content.style.display = content.id === targetId ? 'flex' : 'none';
                    });
                });
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            setupIcons(); 
            initThreeJS();
            setupRibbonTabs();
            
            // Yeni Varlık Ekle Butonu
            document.getElementById('add-block-btn').onclick = () => {
                if (Module.CreateNewBlockFromUI) {
                    Module.CreateNewBlockFromUI();
                } else {
                    CppInterface.JS_LogOutput(Module.stringToUTF8("Hata: C++ Motoru henüz yüklenmedi. Lütfen bekleyin."));
                }
            };
        });

        // Emscripten modülü yüklendiğinde (motor.js tarafından çağrılır)
        Module.onRuntimeInitialized = () => {
            document.getElementById('engine-status').textContent = 'Motor: Hazır (ECS Aktif)';
            document.getElementById('engine-status').classList.remove('text-yellow-400');
            document.getElementById('engine-status').classList.add('text-emerald-400');
            
            // C++ Başlatma Fonksiyonunu Çağır
            if (Module.InitializeEngine) {
                Module.InitializeEngine(); 
            } else {
                 CppInterface.JS_LogOutput(Module.stringToUTF8("KRİTİK HATA: InitializeEngine C++ fonksiyonu bulunamadı."));
            }
        };
        
        // Emscripten motor.js dosyasını yükle (Mock C++ derlenmiş dosyası)
        // **NOT: Bu, engine.cpp dosyasının tarayıcınız tarafından derlendiği varsayılan addır.**
        const script = document.createElement('script');
        script.src = 'motor.js';
        document.body.appendChild(script);

    </script>

</body>
</html>

