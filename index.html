
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - 3D Game Engine</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root { --primary: #007ACC; --bg: #1e1e1e; --panel: #252526; --text: #ffffff; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; color: var(--text); user-select: none; }
        
        /* UI Katmanları */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; }
        .pointer-events-auto { pointer-events: auto; }

        /* Üst Bar */
        #top-bar { height: 50px; background: #333; display: flex; align-items: center; padding: 0 20px; border-bottom: 2px solid #000; pointer-events: auto; justify-content: space-between; }
        .btn { background: var(--primary); border: none; padding: 8px 15px; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { filter: brightness(1.1); }
        .btn-stop { background: #d32f2f; display: none; }

        /* Oyun İçi HUD */
        #game-hud { display: none; position: absolute; bottom: 20px; left: 20px; pointer-events: auto; }
        .control-hint { background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; color: #fff; }

        /* Yükleme Ekranı */
        #loader { position: fixed; inset: 0; background: #1e1e1e; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loader">
        <h1 style="color:var(--primary); font-size:40px;">LunX 3D</h1>
        <p>Engine Loading...</p>
    </div>

    <div id="viewport"></div>

    <div id="ui-layer">
        <div id="top-bar">
            <div style="font-weight:bold; font-size:18px;">LunX Studio</div>
            <div>
                <button class="btn" onclick="World.addBlock()">+ Blok Ekle</button>
                <button class="btn" onclick="World.clear()">Temizle</button>
            </div>
            <div>
                <button id="btn-play" class="btn" style="background:#4CAF50;" onclick="Game.start()">▶ OYNA</button>
                <button id="btn-stop" class="btn btn-stop" onclick="Game.stop()">⏹ DURDUR</button>
            </div>
        </div>

        <div id="game-hud">
            <div class="control-hint">
                <b>Kontroller:</b><br>
                W, A, S, D : Hareket<br>
                SPACE : Zıpla<br>
                Mouse : Kamera
            </div>
        </div>
    </div>

    <script>
        // --- ANA YAPILANDIRMA ---
        const App = {
            scene: null, camera: null, renderer: null,
            world: null, // Fizik Dünyası
            clock: new THREE.Clock(),
            objects: [], // Görsel Nesneler ve Fizik Body Eşleşmeleri
            raycaster: new THREE.Raycaster(),
            mouse: new THREE.Vector2(),
            
            init: () => {
                // 1. Three.js Sahne Kurulumu
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0x87CEEB); // Gökyüzü Mavisi
                App.scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

                // Kamera
                App.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                App.camera.position.set(0, 10, 15);

                // Renderer
                App.renderer = new THREE.WebGLRenderer({ antialias: true });
                App.renderer.setSize(window.innerWidth, window.innerHeight);
                App.renderer.shadowMap.enabled = true;
                document.getElementById('viewport').appendChild(App.renderer.domElement);

                // Işıklandırma
                const ambient = new THREE.AmbientLight(0xffffff, 0.6);
                App.scene.add(ambient);
                const sun = new THREE.DirectionalLight(0xffffff, 0.8);
                sun.position.set(50, 100, 50);
                sun.castShadow = true;
                sun.shadow.camera.left = -50; sun.shadow.camera.right = 50;
                sun.shadow.camera.top = 50; sun.shadow.camera.bottom = -50;
                sun.shadow.mapSize.width = 2048; sun.shadow.mapSize.height = 2048;
                App.scene.add(sun);

                // 2. Cannon.js Fizik Kurulumu
                App.world = new CANNON.World();
                App.world.gravity.set(0, -20, 0); // Yerçekimi
                App.world.broadphase = new CANNON.NaiveBroadphase();
                App.world.defaultContactMaterial.friction = 0.3;

                // Zemin Materyali (Kayganlığı önlemek için)
                const groundMat = new CANNON.Material();
                const playerMat = new CANNON.Material();
                const contactMat = new CANNON.ContactMaterial(groundMat, playerMat, { friction: 0.0, restitution: 0.0 });
                App.world.addContactMaterial(contactMat);

                // 3. Kontroller (Editör Kamerası)
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.controls.enableDamping = true;

                // Olay Dinleyicileri
                window.addEventListener('resize', App.resize);
                document.getElementById('loader').style.display = 'none';

                // Dünyayı Oluştur
                World.init();

                // Döngüyü Başlat
                App.loop();
            },

            resize: () => {
                App.camera.aspect = window.innerWidth / window.innerHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(window.innerWidth, window.innerHeight);
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = Math.min(App.clock.getDelta(), 0.1);

                // Fizik Güncellemesi
                App.world.step(1/60, dt, 3);

                // Nesne Senkronizasyonu (Fizik -> Görsel)
                App.objects.forEach(obj => {
                    if (obj.body) {
                        obj.mesh.position.copy(obj.body.position);
                        obj.mesh.quaternion.copy(obj.body.quaternion);
                        
                        // Karakterin görseli fizik silindirinin merkezinden aşağıda olmalı (ayaklar yere bassın)
                        if (obj.isPlayer) {
                            obj.mesh.position.y -= 1.5; 
                        }
                    }
                });

                // Oyun Mantığı
                if (Game.active) Game.update();
                else App.controls.update();

                App.renderer.render(App.scene, App.camera);
            }
        };

        // --- DÜNYA YÖNETİMİ ---
        const World = {
            init: () => {
                // Zemin (Baseplate)
                const geo = new THREE.BoxGeometry(100, 1, 100);
                const mat = new THREE.MeshStandardMaterial({ color: 0x4CAF50 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.y = -0.5;
                mesh.receiveShadow = true;
                App.scene.add(mesh);

                // Zemin Fiziği
                const shape = new CANNON.Box(new CANNON.Vec3(50, 0.5, 50));
                const body = new CANNON.Body({ mass: 0, shape: shape });
                body.position.copy(mesh.position);
                App.world.addBody(body);

                // Birkaç Test Kutusu
                World.addBlock(0, 5, -10);
                World.addBlock(2, 5, -10);
                World.addBlock(1, 8, -10);
            },

            addBlock: (x=0, y=10, z=0) => {
                // Görsel
                const size = 2;
                const geo = new THREE.BoxGeometry(size, size, size);
                const mat = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.castShadow = true; mesh.receiveShadow = true;
                App.scene.add(mesh);

                // Fizik
                const shape = new CANNON.Box(new CANNON.Vec3(size/2, size/2, size/2));
                const body = new CANNON.Body({ mass: 5, shape: shape });
                body.position.set(Math.random()*10-5 + x, y, Math.random()*10-5 + z);
                App.world.addBody(body);

                App.objects.push({ mesh: mesh, body: body });
            },

            clear: () => {
                // Sadece dinamik objeleri sil
                App.objects.forEach(obj => {
                    App.scene.remove(obj.mesh);
                    App.world.removeBody(obj.body);
                });
                App.objects = [];
            }
        };

        // --- OYUN VE KARAKTER MANTIĞI ---
        const Game = {
            active: false,
            player: null,
            playerBody: null,
            input: { w: false, a: false, s: false, d: false, space: false },
            canJump: false,

            start: () => {
                Game.active = true;
                document.getElementById('btn-play').style.display = 'none';
                document.getElementById('btn-stop').style.display = 'inline-block';
                document.getElementById('game-hud').style.display = 'block';

                // Orbit Kontrolleri Ayarla (Karakter Takibi İçin)
                App.controls.enablePan = false;
                App.controls.minDistance = 5;
                App.controls.maxDistance = 20;

                Game.spawnPlayer();
                
                // Klavye Dinleyicileri
                document.addEventListener('keydown', Game.onKey);
                document.addEventListener('keyup', Game.onKey);
            },

            stop: () => {
                Game.active = false;
                document.getElementById('btn-play').style.display = 'inline-block';
                document.getElementById('btn-stop').style.display = 'none';
                document.getElementById('game-hud').style.display = 'none';

                // Karakteri Sil
                if(Game.player) {
                    App.scene.remove(Game.player);
                    App.world.removeBody(Game.playerBody);
                    // Arrayden temizle
                    App.objects = App.objects.filter(o => o.mesh !== Game.player);
                }

                // Kontrolleri Eski Haline Getir
                App.controls.target.set(0,0,0);
                App.controls.enablePan = true;

                document.removeEventListener('keydown', Game.onKey);
                document.removeEventListener('keyup', Game.onKey);
            },

            spawnPlayer: () => {
                // --- ROBLOX NOOB GÖRSELİ ---
                const playerGroup = new THREE.Group();

                // Renkler
                const yellow = new THREE.MeshStandardMaterial({ color: 0xFBC02D }); // Kafa, Kollar
                const blue = new THREE.MeshStandardMaterial({ color: 0x0D47A1 }); // Gövde
                const green = new THREE.MeshStandardMaterial({ color: 0x4CAF50 }); // Bacaklar

                // 1. Gövde (2x2x1)
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), blue);
                torso.position.y = 2; // Yerden yükseklik (Ayaklar 0'da ise)
                playerGroup.add(torso);

                // 2. Kafa (1.2x1.2x1.2)
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), yellow);
                head.position.y = 3.6;
                playerGroup.add(head);

                // 3. Kollar (1x2x1)
                const armGeo = new THREE.BoxGeometry(1, 2, 1);
                const lArm = new THREE.Mesh(armGeo, yellow); lArm.position.set(-1.5, 2, 0);
                const rArm = new THREE.Mesh(armGeo, yellow); rArm.position.set(1.5, 2, 0);
                playerGroup.add(lArm); playerGroup.add(rArm);

                // 4. Bacaklar (1x2x1)
                const legGeo = new THREE.BoxGeometry(0.9, 2, 1);
                const lLeg = new THREE.Mesh(legGeo, green); lLeg.position.set(-0.5, 0, 0); // Y merkezi 1, ama görsel grubu 0'a oturtacağız
                const rLeg = new THREE.Mesh(legGeo, green); rLeg.position.set(0.5, 0, 0);
                // Not: Bacakların merkezi (0,0,0) noktasına göre ayarlandı.
                // Aslında kutu geometrileri merkezden çizilir. O yüzden Y pozisyonlarını yukarı almamız lazım.
                lLeg.position.y = 0; // Bu bacağın ortası. Ayaklar -1'de kalır.
                rLeg.position.y = 0;
                // Düzeltme: Tüm grup Y ekseninde 1 birim yukarıda tanımlanmalı ki ayak tabanı 0 olsun.
                // Basitleştirmek için: Fizik body merkezi (0,1.5,0) olacak (yükseklik 3).
                
                // Grubun içindeki parçaların yerlerini düzeltiyoruz:
                // Body Center (Physics) yerden 1.5 yukarıda olacak.
                // Görselin merkezi de physics body'nin merkezine oturacak.
                // R6 Toplam Boy ~ 5-6 birim.
                
                lLeg.position.y = 1; rLeg.position.y = 1; // Ayaklar 0'da.
                torso.position.y = 3; 
                lArm.position.y = 3; rArm.position.y = 3;
                head.position.y = 4.6;

                playerGroup.castShadow = true;
                App.scene.add(playerGroup);
                Game.player = playerGroup;

                // --- FİZİK (HITBOX) ---
                // Kapsül yerine Silindir kullanıyoruz (R6 karakterler gibi)
                // Yarıçap: 1, Yükseklik: 3 (Gövde + Bacak)
                const shape = new CANNON.Cylinder(1, 1, 4, 12);
                const body = new CANNON.Body({
                    mass: 60, // Karakter ağırlığı
                    fixedRotation: true, // Top gibi yuvarlanmasını engeller
                    position: new CANNON.Vec3(0, 5, 0),
                    shape: shape,
                    linearDamping: 0.9 // Sürtünme simülasyonu (durması için)
                });
                
                // Silindir CannonJS'de farklı eksende olabilir, döndürmemiz gerekebilir.
                // CannonJS silindirleri varsayılan olarak diktir.
                
                App.world.addBody(body);
                Game.playerBody = body;

                // Listeye ekle ki loop döngüsü pozisyonunu güncellesin
                App.objects.push({ mesh: Game.player, body: Game.playerBody, isPlayer: true });
            },

            onKey: (e) => {
                const s = e.type === 'keydown';
                switch(e.key.toLowerCase()) {
                    case 'w': Game.input.w = s; break;
                    case 's': Game.input.s = s; break;
                    case 'a': Game.input.a = s; break;
                    case 'd': Game.input.d = s; break;
                    case ' ': Game.input.space = s; break;
                }
            },

            update: () => {
                if (!Game.playerBody) return;

                // 1. Hareket Vektörünü Hesapla
                const speed = 15;
                const inputVector = new THREE.Vector3(0, 0, 0);
                
                if (Game.input.w) inputVector.z -= 1;
                if (Game.input.s) inputVector.z += 1;
                if (Game.input.a) inputVector.x -= 1;
                if (Game.input.d) inputVector.x += 1;

                // 2. Kamera Açısına Göre Yönlendir
                // Kameranın Y eksenindeki dönüşünü al
                const angle = App.controls.getAzimuthalAngle();
                inputVector.applyAxisAngle(new THREE.Vector3(0, 1, 0), -angle);

                // 3. Fiziği Uygula
                if (inputVector.length() > 0) {
                    inputVector.normalize().multiplyScalar(speed);
                    Game.playerBody.velocity.x = inputVector.x;
                    Game.playerBody.velocity.z = inputVector.z;

                    // Karakteri gittiği yöne döndür
                    const targetRotation = Math.atan2(Game.playerBody.velocity.x, Game.playerBody.velocity.z);
                    Game.player.rotation.y = targetRotation;
                } else {
                    // Tuşa basılmıyorsa dur
                    Game.playerBody.velocity.x = 0;
                    Game.playerBody.velocity.z = 0;
                }

                // 4. Zıplama (Basit Raycast Zemin Kontrolü)
                // Karakterin merkezinden aşağıya ışın gönder
                const rayStart = new CANNON.Vec3(Game.playerBody.position.x, Game.playerBody.position.y, Game.playerBody.position.z);
                const rayEnd = new CANNON.Vec3(rayStart.x, rayStart.y - 2.1, rayStart.z); // 2 (yarı boy) + 0.1 tolerans
                
                // Raycast işlemi
                const rayResult = new CANNON.RaycastResult();
                // CannonJS World raycast biraz karmaşık olabilir, basit yükseklik kontrolü yapalım:
                
                // Zıplama Mantığı
                if (Game.input.space && Math.abs(Game.playerBody.velocity.y) < 0.1) {
                     Game.playerBody.velocity.y = 10; // Zıplama Gücü
                }

                // 5. Kamerayı Karaktere Odakla
                App.controls.target.copy(Game.player.position);
                App.controls.update();

                // 6. Karakter Düştü mü? (Void kontrolü)
                if (Game.playerBody.position.y < -20) {
                    Game.playerBody.position.set(0, 10, 0);
                    Game.playerBody.velocity.set(0,0,0);
                }
            }
        };

        // Başlat
        window.onload = App.init;

    </script>
</body>
</html>
