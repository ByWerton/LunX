<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Ultimate Mobile Engine</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #00A2FF; /* Roblox Studio Mavisi */
            --bg-dark: #232323;
            --bg-panel: #2D2D2D;
            --border: #111;
            --text: #FFF;
            --panel-width: 260px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', Tahoma, sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-dark); height: 100vh; display: flex; flex-direction: column; color: var(--text); }

        /* --- UI LAYOUT --- */
        #top-bar { height: 40px; background: #1E1E1E; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #000; z-index: 200; }
        .logo { font-weight: 900; font-size: 16px; display: flex; align-items: center; gap: 5px; color: white; }
        .logo span { background: linear-gradient(45deg, #00A2FF, #0066CC); padding: 2px 6px; border-radius: 4px; }

        #ribbon { height: 90px; background: #363636; border-bottom: 1px solid #000; display: flex; overflow-x: auto; padding: 5px; align-items: center; transition: 0.3s; z-index: 150; }
        .ribbon-section { display: flex; gap: 2px; border-right: 1px solid #555; padding-right: 5px; margin-right: 5px; align-items: center; }
        .tool-btn { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            width: 50px; height: 70px; cursor: pointer; border-radius: 3px; font-size: 10px; color: #ccc; 
            background: transparent; border: 1px solid transparent; transition: 0.1s; text-align: center;
        }
        .tool-btn:hover { background: #444; border-color: #555; }
        .tool-btn.active { background: #505050; border-color: var(--primary); color: var(--primary); }
        .tool-icon { font-size: 22px; margin-bottom: 4px; }
        .tool-lbl { font-size: 9px; opacity: 0.8; }

        /* MAIN WORKSPACE */
        #workspace { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        /* SOL PANEL (Toolbox) */
        #left-panel { width: var(--panel-width); background: var(--bg-panel); border-right: 2px solid #111; display: flex; flex-direction: column; transition: width 0.3s; z-index: 100; }
        
        /* SAƒû PANEL (Properties & Explorer) */
        #right-panel { width: var(--panel-width); background: var(--bg-panel); border-left: 2px solid #111; display: flex; flex-direction: column; transition: width 0.3s; z-index: 100; }
        
        .panel-header { background: #3A3A3A; padding: 8px; font-size: 12px; font-weight: bold; border-bottom: 1px solid #111; display: flex; justify-content: space-between; }
        .panel-content { flex: 1; overflow-y: auto; padding: 5px; }

        /* EXPLORER (Saƒü Alt) */
        #explorer-container { height: 50%; border-top: 4px solid #111; display: flex; flex-direction: column; }
        #prop-container { height: 50%; display: flex; flex-direction: column; }
        
        .explorer-item { padding: 4px 8px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: #ddd; }
        .explorer-item:hover { background: #444; }
        .explorer-item.selected { background: #005588; color: white; }

        /* VIEWPORT */
        #viewport { flex: 1; position: relative; background: #99C3E8; overflow: hidden; }
        
        /* MINIMIZE BUTTONS */
        .toggle-ui-btn { position: absolute; bottom: 10px; width: 20px; height: 20px; background: #222; color: white; border: 1px solid #555; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 101; font-size: 10px; }
        #toggle-left { left: 0; }
        #toggle-right { right: 0; }

        /* GAME HUD (Mobile Controls) */
        #game-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 500; }
        #joystick-zone { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(0,0,0,0.2); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); pointer-events: auto; }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #jump-btn { position: absolute; bottom: 40px; right: 30px; width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); pointer-events: auto; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #jump-btn:active { background: rgba(255,255,255,0.5); }
        
        /* X MENU (Settings) */
        #x-btn { position: absolute; top: 50px; left: 10px; width: 40px; height: 40px; background: #111; border-radius: 8px; border: 2px solid white; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; cursor: pointer; z-index: 600; pointer-events: auto; }
        #settings-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: #222; border: 2px solid #444; border-radius: 10px; padding: 20px; display: none; flex-direction: column; gap: 10px; z-index: 700; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .setting-row { display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; }
        
        /* LUNAIX AI */
        #lunaix-panel { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 400px; max-width: 90%; height: 250px; background: rgba(20,20,20,0.95); border: 1px solid #444; border-radius: 10px; display: none; flex-direction: column; z-index: 600; backdrop-filter: blur(5px); }
        #ai-chat { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; color: #ddd; }
        .ai-msg { margin-bottom: 5px; padding: 5px 10px; border-radius: 5px; width: fit-content; max-width: 80%; }
        .bot { background: #004466; align-self: flex-start; }
        .user { background: #333; align-self: flex-end; margin-left: auto; }

        /* TOOLBOX GRID */
        .tb-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .tb-item { background: #333; padding: 5px; border-radius: 4px; text-align: center; cursor: pointer; border: 1px solid #444; }
        .tb-item:hover { border-color: white; }
        .tb-img { width: 100%; height: 50px; background: #222; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; font-size: 24px; }

    </style>
</head>
<body onload="Engine.init()">

    <div id="x-btn" onclick="UI.toggleSettings()">X</div>
    <div id="settings-modal">
        <h3 style="margin:0 0 10px 0; color:white;">Ayarlar</h3>
        <div class="setting-row">
            <span>Grafik Kalitesi</span>
            <select id="gfx-sel" onchange="Engine.setGraphics(this.value)" style="background:#333; color:white; border:none; padding:5px;">
                <option value="low">D√º≈ü√ºk (Hƒ±zlƒ±)</option>
                <option value="high" selected>Y√ºksek (G√∂lgeli)</option>
            </select>
        </div>
        <div class="setting-row">
            <span>Sesler</span>
            <button onclick="Engine.toggleSound()" style="background:green; color:white; border:none; padding:5px 10px;" id="snd-btn">A√ßƒ±k</button>
        </div>
        <button onclick="UI.toggleSettings()" style="margin-top:10px; padding:8px; background:#444; color:white; border:none; cursor:pointer;">Kapat</button>
    </div>

    <div id="top-bar">
        <div class="logo"><span>LunX</span> Studio Mobile</div>
        <div>
            <button onclick="Game.play()" style="background:#00C853; color:white; border:none; padding:5px 15px; border-radius:3px; font-weight:bold; cursor:pointer;">‚ñ∂ OYNA</button>
            <button onclick="Game.stop()" style="background:#D32F2F; color:white; border:none; padding:5px 15px; border-radius:3px; font-weight:bold; cursor:pointer;">‚èπ DUR</button>
        </div>
    </div>

    <div id="ribbon">
        <div class="ribbon-section">
            <div class="tool-btn active" onclick="Editor.setMode('select')"><div class="tool-icon">üëÜ</div>Se√ß</div>
            <div class="tool-btn" onclick="Editor.setMode('translate')"><div class="tool-icon">‚ÜîÔ∏è</div>Ta≈üƒ±</div>
            <div class="tool-btn" onclick="Editor.setMode('scale')"><div class="tool-icon">‚§°</div>√ñl√ßek</div>
            <div class="tool-btn" onclick="Editor.setMode('rotate')"><div class="tool-icon">üîÑ</div>D√∂nd√ºr</div>
        </div>
        <div class="ribbon-section">
            <div class="tool-btn" onclick="World.addPart('box')"><div class="tool-icon">üßä</div>Part</div>
            <div class="tool-btn" onclick="World.addPart('sphere')"><div class="tool-icon">‚ö™</div>K√ºre</div>
            <div class="tool-btn" onclick="World.addPart('cylinder')"><div class="tool-icon">üõ¢Ô∏è</div>Silindir</div>
            <div class="tool-btn" onclick="World.addPart('wedge')"><div class="tool-icon">üìê</div>Wedge</div>
        </div>
        <div class="ribbon-section">
            <div class="tool-btn" onclick="Editor.setMat('plastic')"><div class="tool-icon">‚¨ú</div>Plastik</div>
            <div class="tool-btn" onclick="Editor.setMat('neon')"><div class="tool-icon">üí°</div>Neon</div>
            <div class="tool-btn" onclick="Editor.setMat('grass')"><div class="tool-icon">üåø</div>√áim</div>
            <div class="tool-btn" onclick="Editor.setMat('wood')"><div class="tool-icon">ü™µ</div>Odun</div>
            <div class="tool-btn" onclick="Editor.setMat('metal')"><div class="tool-icon">üîß</div>Metal</div>
        </div>
        <div class="ribbon-section">
            <div class="tool-btn" onclick="Editor.setColor('#D32F2F')"><div style="width:20px;height:20px;background:red;margin-bottom:5px;"></div>Kƒ±rmƒ±zƒ±</div>
            <div class="tool-btn" onclick="Editor.setColor('#1976D2')"><div style="width:20px;height:20px;background:blue;margin-bottom:5px;"></div>Mavi</div>
            <div class="tool-btn" onclick="Editor.setColor('#388E3C')"><div style="width:20px;height:20px;background:green;margin-bottom:5px;"></div>Ye≈üil</div>
            <div class="tool-btn" onclick="Editor.setColor('#FBC02D')"><div style="width:20px;height:20px;background:yellow;margin-bottom:5px;"></div>Sarƒ±</div>
        </div>
        <div class="ribbon-section">
            <div class="tool-btn" onclick="Editor.anchor()"><div class="tool-icon">‚öì</div>√áapa</div>
            <div class="tool-btn" onclick="Editor.collide()"><div class="tool-icon">üß±</div>√áarpƒ±≈üma</div>
            <div class="tool-btn" onclick="Editor.delete()"><div class="tool-icon">üóëÔ∏è</div>Sil</div>
            <div class="tool-btn" onclick="Editor.duplicate()"><div class="tool-icon">üìë</div>Kopya</div>
            <div class="tool-btn" onclick="World.clear()"><div class="tool-icon">üí£</div>Temizle</div>
        </div>
        <div class="ribbon-section">
            <div class="tool-btn" onclick="UI.toggleAI()"><div class="tool-icon">ü§ñ</div>LunAIX</div>
        </div>
    </div>

    <div id="workspace">
        <div id="left-panel">
            <div class="panel-header">Toolbox</div>
            <div class="panel-content">
                <div class="tb-grid" id="toolbox-grid">
                    </div>
            </div>
            <div class="toggle-ui-btn" id="toggle-left" onclick="UI.togglePanel('left')">‚óÄ</div>
        </div>

        <div id="viewport">
            <div id="game-hud">
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>
            
            <div id="lunaix-panel">
                <div class="panel-header">LunAIX Architect AI <span onclick="UI.toggleAI()" style="cursor:pointer">x</span></div>
                <div id="ai-chat"><div class="ai-msg bot">Merhaba! "Kale in≈üa et", "Stadyum yap" veya "G√∂kdelen kur" yazabilirsin.</div></div>
                <div style="padding:10px; display:flex;">
                    <input type="text" id="ai-input" style="flex:1; padding:5px; border-radius:4px; border:none;" placeholder="Ne in≈üa edeyim?">
                    <button onclick="AI.generate()" style="margin-left:5px; background:var(--primary); color:white; border:none; padding:5px 10px;">üî®</button>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div id="prop-container">
                <div class="panel-header">Properties</div>
                <div class="panel-content" id="properties-content">
                    <div style="color:#666; text-align:center; margin-top:20px;">Nesne se√ßilmedi</div>
                </div>
            </div>
            
            <div id="explorer-container">
                <div class="panel-header">Explorer</div>
                <div class="panel-content" id="explorer-list">
                    <div class="explorer-item">üìÇ Workspace</div>
                </div>
            </div>
            <div class="toggle-ui-btn" id="toggle-right" onclick="UI.togglePanel('right')">‚ñ∂</div>
        </div>
    </div>

    <script>
        /* --- CORE ENGINE --- */
        const Engine = {
            scene: null, camera: null, renderer: null, world: null,
            controls: null, transform: null, clock: new THREE.Clock(),
            objects: [], raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),
            settings: { shadows: true, sound: true },
            
            init: () => {
                // Scene
                const vp = document.getElementById('viewport');
                Engine.scene = new THREE.Scene();
                Engine.scene.background = new THREE.Color(0x99C3E8); // Sky Blue
                Engine.scene.fog = new THREE.Fog(0x99C3E8, 40, 200);

                // Camera
                Engine.camera = new THREE.PerspectiveCamera(60, vp.clientWidth / vp.clientHeight, 0.1, 1000);
                Engine.camera.position.set(15, 15, 15);

                // Renderer
                Engine.renderer = new THREE.WebGLRenderer({ antialias: true });
                Engine.renderer.setSize(vp.clientWidth, vp.clientHeight);
                Engine.renderer.shadowMap.enabled = true;
                Engine.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                vp.appendChild(Engine.renderer.domElement);

                // Physics
                Engine.world = new CANNON.World();
                Engine.world.gravity.set(0, -25, 0);
                Engine.world.broadphase = new CANNON.NaiveBroadphase();
                Engine.world.defaultContactMaterial.friction = 0.1;

                // Lights
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                Engine.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 0.8);
                dir.position.set(50, 100, 50);
                dir.castShadow = true;
                dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
                Engine.scene.add(dir);

                // Tools
                Engine.controls = new THREE.OrbitControls(Engine.camera, Engine.renderer.domElement);
                Engine.controls.enableDamping = true;
                
                Engine.transform = new THREE.TransformControls(Engine.camera, Engine.renderer.domElement);
                Engine.transform.addEventListener('dragging-changed', e => Engine.controls.enabled = !e.value);
                Engine.transform.addEventListener('change', () => Editor.updateProps());
                Engine.scene.add(Engine.transform);

                // Baseplate
                World.createBaseplate();
                
                // UI Init
                UI.initToolbox();
                Game.initInput();

                // Events
                window.addEventListener('resize', Engine.resize);
                vp.addEventListener('pointerdown', Editor.onSelect);

                Engine.loop();
            },

            resize: () => {
                const vp = document.getElementById('viewport');
                Engine.camera.aspect = vp.clientWidth / vp.clientHeight;
                Engine.camera.updateProjectionMatrix();
                Engine.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            setGraphics: (val) => {
                Engine.settings.shadows = (val === 'high');
                Engine.renderer.shadowMap.enabled = Engine.settings.shadows;
                Engine.scene.traverse(o => {
                    if(o.isMesh) {
                        o.castShadow = Engine.settings.shadows;
                        o.receiveShadow = Engine.settings.shadows;
                    }
                });
            },

            toggleSound: () => {
                Engine.settings.sound = !Engine.settings.sound;
                document.getElementById('snd-btn').innerText = Engine.settings.sound ? "A√ßƒ±k" : "Kapalƒ±";
                document.getElementById('snd-btn').style.background = Engine.settings.sound ? "green" : "red";
            },

            loop: () => {
                requestAnimationFrame(Engine.loop);
                const dt = Math.min(Engine.clock.getDelta(), 0.1);

                if(Game.active) {
                    Engine.world.step(1/60, dt, 3);
                    Game.update(dt);
                } else {
                    Engine.controls.update();
                }

                // Sync
                Engine.objects.forEach(o => {
                    if(o.userData.body && !o.userData.anchored) {
                        o.position.copy(o.userData.body.position);
                        o.quaternion.copy(o.userData.body.quaternion);
                        // R6 Karakter offset d√ºzeltmesi
                        if(o.userData.isPlayer) o.position.y -= 3.0; 
                    }
                });

                Engine.renderer.render(Engine.scene, Engine.camera);
            }
        };

        /* --- WORLD MANAGER --- */
        const World = {
            createBaseplate: () => {
                // 1000x1000 Baseplate
                const geo = new THREE.BoxGeometry(1000, 4, 1000);
                const mat = new THREE.MeshStandardMaterial({ color: 0x555555 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.y = -2; 
                mesh.receiveShadow = true;
                mesh.name = "Baseplate";
                
                const body = new CANNON.Body({ mass: 0, shape: new CANNON.Box(new CANNON.Vec3(500, 2, 500)) });
                body.position.copy(mesh.position);
                
                mesh.userData = { body: body, anchored: true };
                Engine.scene.add(mesh);
                Engine.world.addBody(body);
                
                // Grid & Spawn
                const grid = new THREE.GridHelper(1000, 250, 0x333333, 0x444444);
                grid.position.y = 0.05;
                Engine.scene.add(grid);

                World.addPart('box', {pos: new THREE.Vector3(0,0.5,0), scale:[6,1,6], color:0x888888, name:"SpawnLocation", anchored:true});
                const decal = new THREE.Mesh(new THREE.PlaneGeometry(4,4), new THREE.MeshBasicMaterial({color:0x222}));
                decal.rotation.x = -Math.PI/2; decal.position.set(0,1.1,0); Engine.scene.add(decal);
            },

            addPart: (type, cfg={}) => {
                let geo, shape;
                const scale = cfg.scale || [4,4,4];
                const color = cfg.color || 0xAAAAAA;
                
                if(type === 'sphere') {
                    geo = new THREE.SphereGeometry(0.5,32,32);
                    shape = new CANNON.Sphere(Math.max(scale[0],scale[1])/2);
                } else if (type === 'cylinder') {
                    geo = new THREE.CylinderGeometry(0.5,0.5,1,32);
                    shape = new CANNON.Cylinder(scale[0]/2,scale[0]/2,scale[1],12);
                } else if (type === 'wedge') {
                    geo = new THREE.ConeGeometry(0.5,1,4); // Basit wedge temsili
                    shape = new CANNON.Cylinder(0, scale[0]/2, scale[1], 4);
                } else {
                    geo = new THREE.BoxGeometry(1,1,1);
                    shape = new CANNON.Box(new CANNON.Vec3(scale[0]/2,scale[1]/2,scale[2]/2));
                }

                const mat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.3 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.scale.set(scale[0], scale[1], scale[2]);
                mesh.position.copy(cfg.pos || new THREE.Vector3(0, 10, 0));
                if(cfg.rot) mesh.rotation.copy(cfg.rot);
                
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.name = cfg.name || type.charAt(0).toUpperCase() + type.slice(1);

                const body = new CANNON.Body({
                    mass: cfg.anchored ? 0 : (scale[0]*scale[1]),
                    shape: shape
                });
                body.position.copy(mesh.position);
                if(cfg.rot) body.quaternion.copy(mesh.quaternion);

                mesh.userData = { body: body, anchored: !!cfg.anchored, color: color };
                
                Engine.scene.add(mesh);
                Engine.world.addBody(body);
                Engine.objects.push(mesh);
                
                UI.addToExplorer(mesh);
                return mesh;
            },

            clear: () => {
                Engine.objects.forEach(o => {
                    if(o.name !== "Baseplate" && o.name !== "SpawnLocation") {
                        Engine.scene.remove(o);
                        Engine.world.removeBody(o.userData.body);
                    }
                });
                Engine.objects = Engine.objects.filter(o => o.name === "Baseplate" || o.name === "SpawnLocation");
                document.getElementById('explorer-list').innerHTML = '<div class="explorer-item">üìÇ Workspace</div>';
            }
        };

        /* --- GAME & CHARACTER --- */
        const Game = {
            active: false, player: null, body: null,
            input: { x: 0, y: 0, jump: false },
            sounds: { walk: null, jump: null },

            play: () => {
                Game.active = true;
                Editor.setMode('none');
                document.getElementById('game-hud').style.display = 'block';
                // UI Gizle
                document.getElementById('left-panel').style.width = '0px';
                document.getElementById('right-panel').style.width = '0px';
                document.getElementById('ribbon').style.height = '0px';

                Engine.controls.enablePan = false;
                Engine.controls.minDistance = 5; Engine.controls.maxDistance = 25;

                Game.spawnPlayer();
            },

            stop: () => {
                Game.active = false;
                document.getElementById('game-hud').style.display = 'none';
                // UI Geri Getir
                document.getElementById('left-panel').style.width = 'var(--panel-width)';
                document.getElementById('right-panel').style.width = 'var(--panel-width)';
                document.getElementById('ribbon').style.height = '90px';

                if(Game.player) {
                    Engine.scene.remove(Game.player);
                    Engine.world.removeBody(Game.body);
                    Engine.objects = Engine.objects.filter(o => o !== Game.player);
                }
                Engine.controls.target.set(0,0,0);
                Engine.camera.position.set(15,15,15);
            },

            spawnPlayer: () => {
                const grp = new THREE.Group();
                
                // R6 G√∂rsel
                const matY = new THREE.MeshStandardMaterial({color: 0xFBC02D});
                const matB = new THREE.MeshStandardMaterial({color: 0x1976D2});
                const matG = new THREE.MeshStandardMaterial({color: 0x4CAF50});

                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), matY); head.position.y=5.6;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), matB); torso.position.y=4;
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matY); la.position.set(-1.5,4,0);
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matY); ra.position.set(1.5,4,0);
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matG); ll.position.set(-0.5,2,0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matG); rl.position.set(0.5,2,0);
                
                grp.add(head, torso, la, ra, ll, rl);
                grp.castShadow = true;

                // Fizik (Kaps√ºl/Silindir)
                const body = new CANNON.Body({
                    mass: 80, fixedRotation: true,
                    position: new CANNON.Vec3(0,10,0),
                    shape: new CANNON.Cylinder(1.5, 1.5, 6, 12),
                    linearDamping: 0.9
                });

                const spawn = Engine.scene.getObjectByName("SpawnLocation");
                if(spawn) body.position.set(spawn.position.x, spawn.position.y+5, spawn.position.z);

                Engine.scene.add(grp);
                Engine.world.addBody(body);
                Game.player = grp; Game.body = body;
                Game.limbs = {la, ra, ll, rl};
                
                grp.userData = { body: body, isPlayer: true };
                Engine.objects.push(grp);

                // Sesler (Sentetik, dosya y√ºklemeye gerek yok)
                Game.initAudio();
            },

            update: (dt) => {
                if(!Game.body) return;

                const speed = 20;
                const camAngle = Engine.controls.getAzimuthalAngle();
                
                // 3D Vekt√∂r D√∂n√º≈ü√ºm√º (Joystick -> Kamera Y√∂n√º)
                const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), camAngle);
                const rgt = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), camAngle);
                
                const move = new THREE.Vector3().addScaledVector(rgt, Game.input.x).addScaledVector(fwd, -Game.input.y);

                if(move.length() > 0.1) {
                    move.normalize().multiplyScalar(speed);
                    Game.body.velocity.x = move.x;
                    Game.body.velocity.z = move.z;
                    
                    // 360 Derece D√∂n√º≈ü
                    Game.player.rotation.y = Math.atan2(move.x, move.z);

                    // Animasyon
                    const t = Date.now() * 0.015;
                    Game.limbs.la.rotation.x = Math.sin(t); Game.limbs.ra.rotation.x = -Math.sin(t);
                    Game.limbs.ll.rotation.x = -Math.sin(t); Game.limbs.rl.rotation.x = Math.sin(t);

                    // Ses
                    if(Engine.settings.sound && Game.sounds.osc && Math.abs(Game.body.velocity.y) < 0.5) {
                         Game.playStep(); 
                    }
                } else {
                    Game.body.velocity.x *= 0.5; Game.body.velocity.z *= 0.5;
                    Game.limbs.la.rotation.x=0; Game.limbs.ra.rotation.x=0;
                    Game.limbs.ll.rotation.x=0; Game.limbs.rl.rotation.x=0;
                }

                if(Game.input.jump) {
                    if(Math.abs(Game.body.velocity.y) < 0.5) {
                        Game.body.velocity.y = 15;
                        if(Engine.settings.sound) Game.playJump();
                    }
                    Game.input.jump = false;
                }
                
                // Void Kontrol√º
                if(Game.body.position.y < -50) {
                    Game.body.position.set(0,10,0); Game.body.velocity.set(0,0,0);
                }

                Engine.controls.target.copy(Game.player.position);
                Engine.controls.target.y += 2;
            },

            initInput: () => {
                // Joystick
                const zone = document.getElementById('joystick-zone');
                const stick = document.getElementById('stick');
                let dragging = false, start = {x:0,y:0};

                zone.addEventListener('pointerdown', e => { dragging=true; start={x:e.clientX, y:e.clientY}; stick.style.transition='none'; });
                window.addEventListener('pointermove', e => {
                    if(!dragging) return;
                    const max = 40;
                    let dx = e.clientX - start.x, dy = e.clientY - start.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist > max) { const a = Math.atan2(dy,dx); dx = Math.cos(a)*max; dy = Math.sin(a)*max; }
                    stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                    Game.input.x = dx/max; Game.input.y = dy/max;
                });
                window.addEventListener('pointerup', () => { dragging=false; stick.style.transition='0.2s'; stick.style.transform='translate(-50%, -50%)'; Game.input.x=0; Game.input.y=0; });

                document.getElementById('jump-btn').addEventListener('pointerdown', ()=>Game.input.jump=true);
                
                // Klavye
                document.addEventListener('keydown', e => {
                    if(e.key==='w') Game.input.y=-1; if(e.key==='s') Game.input.y=1;
                    if(e.key==='a') Game.input.x=-1; if(e.key==='d') Game.input.x=1;
                    if(e.code==='Space') Game.input.jump=true;
                });
                document.addEventListener('keyup', e => {
                    if(e.key==='w'||e.key==='s') Game.input.y=0;
                    if(e.key==='a'||e.key==='d') Game.input.x=0;
                });
            },

            initAudio: () => {
                Game.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playStep: () => {
                if(Date.now() - (Game.lastStep||0) > 300) {
                    const osc = Game.ctx.createOscillator();
                    const gain = Game.ctx.createGain();
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, Game.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, Game.ctx.currentTime + 0.1);
                    osc.connect(gain); gain.connect(Game.ctx.destination);
                    osc.start(); osc.stop(Game.ctx.currentTime + 0.1);
                    Game.lastStep = Date.now();
                }
            },
            playJump: () => {
                const osc = Game.ctx.createOscillator();
                const gain = Game.ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(300, Game.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, Game.ctx.currentTime + 0.2);
                gain.gain.exponentialRampToValueAtTime(0.01, Game.ctx.currentTime + 0.2);
                osc.connect(gain); gain.connect(Game.ctx.destination);
                osc.start(); osc.stop(Game.ctx.currentTime + 0.2);
            }
        };

        /* --- EDITOR & UI --- */
        const Editor = {
            selected: null,
            
            setMode: (m) => {
                Engine.transform.detach();
                if(m !== 'select' && m !== 'none' && Editor.selected) {
                    Engine.transform.setMode(m);
                    Engine.transform.attach(Editor.selected);
                }
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                if(event && event.currentTarget) event.currentTarget.classList.add('active');
            },

            onSelect: (e) => {
                if(Game.active) return;
                const rect = document.getElementById('viewport').getBoundingClientRect();
                Engine.mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                Engine.mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                
                Engine.raycaster.setFromCamera(Engine.mouse, Engine.camera);
                const intersects = Engine.raycaster.intersectObjects(Engine.objects);
                
                if(intersects.length > 0) {
                    // Baseplate hari√ß se√ß
                    if(intersects[0].object.name !== "Baseplate") {
                        Editor.select(intersects[0].object);
                    } else {
                        Editor.select(null);
                    }
                } else {
                    Editor.select(null);
                }
            },

            select: (obj) => {
                Editor.selected = obj;
                if(obj) {
                    Engine.transform.attach(obj);
                    Editor.updateProps();
                    // Explorer highlight
                    document.querySelectorAll('.explorer-item').forEach(i => i.classList.remove('selected'));
                    const id = obj.id; // ThreeJS ID
                    // Basit e≈üle≈ütirme
                } else {
                    Engine.transform.detach();
                    document.getElementById('properties-content').innerHTML = '<div style="color:#666; text-align:center; margin-top:20px;">Nesne se√ßilmedi</div>';
                }
            },

            updateProps: () => {
                if(!Editor.selected) return;
                const o = Editor.selected;
                const col = '#' + o.material.color.getHexString();
                document.getElementById('properties-content').innerHTML = `
                    <div style="margin-bottom:5px"><b>Name:</b> ${o.name}</div>
                    <div style="margin-bottom:5px"><b>Pos:</b> ${o.position.x.toFixed(1)}, ${o.position.y.toFixed(1)}, ${o.position.z.toFixed(1)}</div>
                    <div style="margin-bottom:5px"><b>Size:</b> ${o.scale.x.toFixed(1)}, ${o.scale.y.toFixed(1)}, ${o.scale.z.toFixed(1)}</div>
                    <div style="margin-bottom:5px"><b>Color:</b> <input type="color" value="${col}" onchange="Editor.setColor(this.value)"></div>
                    <div><b>Anchored:</b> <input type="checkbox" ${o.userData.anchored?'checked':''} onclick="Editor.toggleAnchor()"></div>
                `;
                
                // Sync Physics
                if(o.userData.body) {
                    o.userData.body.position.copy(o.position);
                    o.userData.body.quaternion.copy(o.quaternion);
                }
            },

            setMat: (m) => { if(Editor.selected) { /* Basit materyal deƒüi≈üimi */ Editor.selected.material.roughness = m==='plastic'?0.5:0.1; } },
            setColor: (c) => { if(Editor.selected) Editor.selected.material.color.set(c); },
            toggleAnchor: () => { if(Editor.selected) { Editor.selected.userData.anchored = !Editor.selected.userData.anchored; Editor.selected.userData.body.mass = Editor.selected.userData.anchored?0:10; } },
            delete: () => { 
                if(Editor.selected) {
                    Engine.scene.remove(Editor.selected);
                    Engine.world.removeBody(Editor.selected.userData.body);
                    Engine.transform.detach();
                    Editor.select(null);
                    // UI update gerekli ama basit tutuyoruz
                }
            },
            duplicate: () => {
                if(Editor.selected) {
                    World.addPart(Editor.selected.name.toLowerCase(), {
                        pos: Editor.selected.position.clone().add(new THREE.Vector3(2,0,0)),
                        scale: [Editor.selected.scale.x, Editor.selected.scale.y, Editor.selected.scale.z],
                        color: Editor.selected.material.color.getHex(),
                        anchored: Editor.selected.userData.anchored
                    });
                }
            },
            anchor: () => Editor.toggleAnchor(),
            collide: () => alert("√áarpƒ±≈üma ayarƒ± deƒüi≈ütirildi (Sim√ºlasyon)"),
        };

        /* --- UI MANAGER --- */
        const UI = {
            initToolbox: () => {
                const items = [
                    {n:'Kƒ±lƒ±√ß', i:'‚öîÔ∏è', f:()=>World.addPart('box', {scale:[0.2,2,0.2], color:0x999, name:"Sword"})},
                    {n:'Aƒüa√ß', i:'üå≤', f:()=>World.addPart('cylinder', {scale:[2,6], color:0x006600, name:"Tree"})},
                    {n:'Lamba', i:'üí°', f:()=>World.addPart('sphere', {scale:[1,1], color:0xFFFF00, name:"Lamp", anchored:true})},
                    {n:'Duvar', i:'üß±', f:()=>World.addPart('box', {scale:[10,8,1], color:0xAA5555, name:"Wall", anchored:true})},
                    {n:'Koltuk', i:'ü™ë', f:()=>World.addPart('box', {scale:[2,1,2], color:0x663300, name:"Seat"})},
                    {n:'Araba', i:'üöó', f:()=>World.addPart('box', {scale:[4,2,6], color:0xFF0000, name:"Car"})},
                    {n:'Top', i:'‚öΩ', f:()=>World.addPart('sphere', {scale:[2,2], color:0xFFFFFF, name:"Ball"})},
                    {n:'Sandƒ±k', i:'üéÅ', f:()=>World.addPart('box', {scale:[2,2,2], color:0xCC9900, name:"Chest"})},
                    {n:'Zombi', i:'üßü', f:()=>World.addPart('box', {scale:[2,4,1], color:0x009900, name:"Zombie"})},
                    {n:'Kule', i:'üè∞', f:()=>AI.generateStructure('tower')}
                ];
                const g = document.getElementById('toolbox-grid');
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'tb-item';
                    el.innerHTML = `<div class="tb-img">${item.i}</div>${item.n}`;
                    el.onclick = item.f;
                    g.appendChild(el);
                });
            },
            
            addToExplorer: (obj) => {
                const list = document.getElementById('explorer-list');
                const el = document.createElement('div');
                el.className = 'explorer-item';
                el.innerText = (obj.userData.anchored ? '‚öì ' : 'üßä ') + obj.name;
                el.onclick = () => Editor.select(obj);
                list.appendChild(el);
            },

            togglePanel: (side) => {
                const p = document.getElementById(side + '-panel');
                const btn = document.getElementById('toggle-' + side);
                if(p.style.width === '0px') {
                    p.style.width = 'var(--panel-width)';
                    btn.innerText = side === 'left' ? '‚óÄ' : '‚ñ∂';
                } else {
                    p.style.width = '0px';
                    btn.innerText = side === 'left' ? '‚ñ∂' : '‚óÄ';
                }
                setTimeout(() => Engine.resize(), 310);
            },

            toggleSettings: () => {
                const s = document.getElementById('settings-modal');
                s.style.display = s.style.display === 'flex' ? 'none' : 'flex';
            },

            toggleAI: () => {
                const p = document.getElementById('lunaix-panel');
                p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
            }
        };

        /* --- LUNAIX AI (Advanced Builder) --- */
        const AI = {
            generate: () => {
                const val = document.getElementById('ai-input').value.toLowerCase();
                if(!val) return;
                
                const chat = document.getElementById('ai-chat');
                chat.innerHTML += `<div class="ai-msg user">${val}</div>`;
                document.getElementById('ai-input').value = "";

                setTimeout(() => {
                    let resp = "Anla≈üƒ±lamadƒ±.";
                    if(val.includes("kale") || val.includes("castle")) AI.generateStructure('castle');
                    else if(val.includes("stadyum") || val.includes("stadium")) AI.generateStructure('stadium');
                    else if(val.includes("g√∂kdelen") || val.includes("skyscraper")) AI.generateStructure('skyscraper');
                    else resp = "Bunu hen√ºz √∂ƒürenmedim.";

                    if(resp !== "Anla≈üƒ±lamadƒ±.") resp = "ƒ∞n≈üa ediliyor...";
                    chat.innerHTML += `<div class="ai-msg bot">${resp}</div>`;
                    chat.scrollTop = chat.scrollHeight;
                }, 500);
            },

            generateStructure: (type) => {
                const startPos = new THREE.Vector3(Math.random()*40-20, 0, Math.random()*40-20);
                
                if(type === 'castle') {
                    // 4 Kule + Duvarlar (100+ blok sim√ºlasyonu i√ßin d√∂ng√ºler)
                    const size = 40;
                    const h = 15;
                    // Duvarlar
                    for(let x=0; x<size; x+=4) {
                        World.addPart('box', {pos:startPos.clone().add(new THREE.Vector3(x, 4, 0)), scale:[4,8,2], color:0x555, anchored:true});
                        World.addPart('box', {pos:startPos.clone().add(new THREE.Vector3(x, 4, size)), scale:[4,8,2], color:0x555, anchored:true});
                        World.addPart('box', {pos:startPos.clone().add(new THREE.Vector3(0, 4, x)), scale:[2,8,4], color:0x555, anchored:true});
                        World.addPart('box', {pos:startPos.clone().add(new THREE.Vector3(size, 4, x)), scale:[2,8,4], color:0x555, anchored:true});
                    }
                    // Kuleler (K√∂≈üeler)
                    const corners = [[0,0], [size,0], [0,size], [size,size]];
                    corners.forEach(c => {
                        World.addPart('cylinder', {pos:startPos.clone().add(new THREE.Vector3(c[0], h/2, c[1])), scale:[6,h], color:0x333, anchored:true});
                    });
                }
                else if(type === 'skyscraper') {
                    const floors = 20;
                    for(let i=0; i<floors; i++) {
                        World.addPart('box', {pos:startPos.clone().add(new THREE.Vector3(0, i*4+2, 0)), scale:[15, 4, 15], color: i%2==0?0x88CCFF:0xAAAAAA, anchored:true});
                    }
                }
                else if(type === 'stadium') {
                    const radius = 30;
                    for(let angle=0; angle<Math.PI*2; angle+=0.2) {
                        const x = Math.cos(angle) * radius;
                        const z = Math.sin(angle) * radius;
                        // Trib√ºn basamaklarƒ±
                        for(let s=0; s<5; s++) {
                            World.addPart('box', {
                                pos:startPos.clone().add(new THREE.Vector3(x*(1+s*0.1), s*2, z*(1+s*0.1))), 
                                scale:[4, 1, 4], 
                                rot: new THREE.Euler(0, -angle, 0),
                                color:0xDD0000, anchored:true
                            });
                        }
                    }
                    // Saha
                    World.addPart('box', {pos:startPos.clone().add(new THREE.Vector3(0,0.1,0)), scale:[radius*1.5, 0.1, radius*1.5], color:0x00AA00, anchored:true});
                }
            }
        };

    </script>
</body>
</html>
