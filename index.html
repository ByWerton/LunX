<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Pro Edition</title>
    
    <!-- K√ºt√ºphaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #D32F2F; /* LunX Kƒ±rmƒ±zƒ± */
            --primary-hover: #B71C1C;
            --bg-light: #F9F9F9;
            --bg-panel: #FFFFFF;
            --border: #E0E0E0;
            --text: #333;
            --panel-width: 280px;
            --header-height: 40px;
            --ribbon-height: 100px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', Tahoma, sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-light); height: 100vh; display: flex; flex-direction: column; color: var(--text); }

        /* --- UI: BA≈ûLIK --- */
        #title-bar { height: var(--header-height); background: var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: white; z-index: 50; }
        .logo { font-weight: 900; font-size: 18px; display: flex; align-items: center; gap: 5px; }
        .logo span { background: white; color: var(--primary); padding: 2px 6px; border-radius: 4px; }
        
        /* --- UI: RIBBON MEN√ú (TABLI) --- */
        #ribbon-tabs { height: 30px; background: white; display: flex; padding-left: 10px; border-bottom: 1px solid var(--border); }
        .tab-btn { padding: 0 20px; font-size: 12px; display: flex; align-items: center; cursor: pointer; color: #666; border-right: 1px solid #EEE; transition: 0.2s; }
        .tab-btn:hover { background: #F5F5F5; color: var(--primary); }
        .tab-btn.active { background: #FFEBEE; color: var(--primary); font-weight: bold; border-bottom: 3px solid var(--primary); }

        #ribbon-content { height: var(--ribbon-height); background: #F5F5F5; border-bottom: 1px solid #CCC; display: flex; align-items: center; padding: 0 10px; overflow-x: auto; transition: height 0.3s; }
        .toolbar-group { display: none; gap: 5px; height: 100%; align-items: center; padding-right: 10px; border-right: 1px solid #DDD; margin-right: 10px; }
        .toolbar-group.active { display: flex; }

        .tool-btn { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            min-width: 50px; height: 70px; cursor: pointer; border-radius: 4px; font-size: 10px; color: #444; 
            transition: 0.1s; border: 1px solid transparent; text-align: center; padding: 0 2px;
        }
        .tool-btn:hover { background: white; border-color: #CCC; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tool-btn.active { background: #FFCDD2; border-color: var(--primary); color: var(--primary-dark); }
        .tool-icon { font-size: 22px; margin-bottom: 5px; }

        /* --- UI: ANA D√úZEN --- */
        #layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* SOL & SAƒû PANELLER */
        .panel { background: var(--bg-panel); display: flex; flex-direction: column; z-index: 20; transition: width 0.3s ease; overflow: hidden; }
        #left-panel { width: 0; border-right: 1px solid var(--border); } /* Ba≈ülangƒ±√ßta kapalƒ± */
        #right-panel { width: var(--panel-width); border-left: 1px solid var(--border); }

        .panel-header { background: #EEE; padding: 8px 10px; font-weight: bold; font-size: 12px; border-bottom: 1px solid #DDD; display: flex; justify-content: space-between; align-items: center; color: #444; }
        .panel-content { flex: 1; overflow-y: auto; padding: 5px; }

        /* EXPLORER & PROPERTIES */
        .exp-item { padding: 4px 8px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; border-radius: 3px; }
        .exp-item:hover { background: #F0F0F0; }
        .exp-item.selected { background: #E3F2FD; color: #1976D2; border: 1px solid #90CAF9; }

        .prop-row { display: flex; align-items: center; margin-bottom: 5px; font-size: 11px; }
        .prop-label { width: 80px; color: #666; }
        .prop-input { flex: 1; padding: 3px; border: 1px solid #DDD; border-radius: 3px; }

        /* VIEWPORT */
        #viewport { flex: 1; position: relative; background: #A0D4F6; overflow: hidden; }

        /* OYUN KONTROLLERƒ∞ (HUD) */
        #game-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 100; }
        #health-bar { position: absolute; top: 10px; right: 10px; width: 200px; height: 20px; background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 10px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: #00E676; transition: width 0.2s; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; pointer-events: auto; }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #jump-btn { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 80px; background: rgba(211, 47, 47, 0.6); border: 2px solid white; border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* LUNAIX AI PANEL */
        #lunaix-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 2000; overflow: hidden; border: 1px solid #CCC; }
        #ai-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        #ai-log { height: 200px; overflow-y: auto; padding: 10px; background: #F9F9F9; border-bottom: 1px solid #EEE; font-size: 12px; }
        .msg { padding: 6px 10px; border-radius: 6px; margin-bottom: 6px; width: fit-content; max-width: 85%; }
        .bot { background: white; border: 1px solid #DDD; align-self: flex-start; color: #333; }
        .user { background: #FFEBEE; align-self: flex-end; margin-left: auto; color: var(--primary); }
        #ai-controls { padding: 10px; display: flex; gap: 5px; background: white; }
        
        /* Dƒ∞ƒûER BUTONLAR */
        .toggle-panel-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 20px; height: 40px; background: white; border: 1px solid #CCC; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; font-size: 10px; color: #666; }
        #toggle-left { left: 0; border-radius: 0 4px 4px 0; }
        #toggle-right { right: 0; border-radius: 4px 0 0 4px; }

    </style>
</head>
<body onload="App.init()">

    <!-- √úST KISIM -->
    <div id="title-bar">
        <div class="logo"><span>LunX</span> Studio Pro</div>
        <div style="display:flex; gap:10px;">
            <button onclick="Game.play()" id="btn-play" style="background:#4CAF50; color:white; border:none; padding:5px 15px; border-radius:4px; font-weight:bold; cursor:pointer;">‚ñ∂ OYNA</button>
            <button onclick="Game.stop()" id="btn-stop" style="background:#F44336; color:white; border:none; padding:5px 15px; border-radius:4px; font-weight:bold; cursor:pointer; display:none;">‚èπ DURDUR</button>
        </div>
    </div>

    <!-- TAB MEN√ú -->
    <div id="ribbon-tabs">
        <div class="tab-btn active" onclick="UI.setTab('home')">Home</div>
        <div class="tab-btn" onclick="UI.setTab('model')">Model</div>
        <div class="tab-btn" onclick="UI.setTab('view')">View</div>
    </div>

    <!-- RIBBON ARA√áLARI -->
    <div id="ribbon-content">
        <!-- HOME TAB -->
        <div id="tab-home" class="toolbar-group active">
            <div class="tool-btn active" onclick="Editor.setMode('select')"><span class="tool-icon">üëÜ</span>Se√ß</div>
            <div class="tool-btn" onclick="Editor.setMode('translate')"><span class="tool-icon">‚ÜîÔ∏è</span>Ta≈üƒ±</div>
            <div class="tool-btn" onclick="Editor.setMode('scale')"><span class="tool-icon">‚§°</span>Boyut</div>
            <div class="tool-btn" onclick="Editor.setMode('rotate')"><span class="tool-icon">üîÑ</span>D√∂nd√ºr</div>
            <div style="width:1px; height:50px; background:#DDD; margin:0 5px;"></div>
            <div class="tool-btn" onclick="UI.toggleAI()"><span class="tool-icon">ü§ñ</span>LunAIX</div>
            <div class="tool-btn" onclick="Editor.setTool('sculpt')"><span class="tool-icon">‚õ∞Ô∏è</span>Sculpt</div>
            <div class="tool-btn" onclick="Editor.delete()"><span class="tool-icon">üóëÔ∏è</span>Sil</div>
        </div>

        <!-- MODEL TAB -->
        <div id="tab-model" class="toolbar-group">
            <div class="tool-btn" onclick="World.addPart('box')"><span class="tool-icon">üì¶</span>Blok</div>
            <div class="tool-btn" onclick="World.addPart('sphere')"><span class="tool-icon">‚ö™</span>K√ºre</div>
            <div class="tool-btn" onclick="World.addPart('cylinder')"><span class="tool-icon">üõ¢Ô∏è</span>Silindir</div>
            <div class="tool-btn" onclick="World.addPart('wedge')"><span class="tool-icon">üìê</span>Wedge</div>
            <div style="width:1px; height:50px; background:#DDD; margin:0 5px;"></div>
            <div class="tool-btn" onclick="Editor.setColor('#D32F2F')"><span style="background:red; width:15px; height:15px; border-radius:50%; margin-bottom:5px;"></span>Kƒ±rmƒ±zƒ±</div>
            <div class="tool-btn" onclick="Editor.setColor('#1976D2')"><span style="background:blue; width:15px; height:15px; border-radius:50%; margin-bottom:5px;"></span>Mavi</div>
            <div class="tool-btn" onclick="Editor.setColor('#388E3C')"><span style="background:green; width:15px; height:15px; border-radius:50%; margin-bottom:5px;"></span>Ye≈üil</div>
            <div class="tool-btn" onclick="Editor.setMaterial('neon')"><span class="tool-icon">üí°</span>Neon</div>
            <div class="tool-btn" onclick="Editor.setMaterial('glass')"><span class="tool-icon">ü™ü</span>Cam</div>
            <div class="tool-btn" onclick="World.addSpecial('water')"><span class="tool-icon">üåä</span>Su</div>
            <div class="tool-btn" onclick="World.addSpecial('fire')"><span class="tool-icon">üî•</span>Ate≈ü</div>
        </div>

        <!-- VIEW TAB -->
        <div id="tab-view" class="toolbar-group">
            <div class="tool-btn" onclick="UI.togglePanel('left')"><span class="tool-icon">üß∞</span>Toolbox</div>
            <div class="tool-btn" onclick="UI.togglePanel('right')"><span class="tool-icon">‚öôÔ∏è</span>√ñzellikler</div>
            <div class="tool-btn" onclick="Editor.toggleGrid()"><span class="tool-icon">üåê</span>Grid</div>
            <div class="tool-btn" onclick="Editor.view('top')"><span class="tool-icon">‚¨ÜÔ∏è</span>√úst</div>
        </div>
    </div>

    <!-- √áALI≈ûMA ALANI -->
    <div id="layout">
        <!-- TOOLBOX (SOL) -->
        <div id="left-panel" class="panel">
            <div class="panel-header">Toolbox <span onclick="UI.togglePanel('left')" style="cursor:pointer">‚úï</span></div>
            <div class="panel-content" id="toolbox-content">
                <!-- JS ile dolar -->
            </div>
        </div>

        <!-- VIEWPORT (ORTA) -->
        <div id="viewport">
            <div class="toggle-panel-btn" id="toggle-left" onclick="UI.togglePanel('left')">‚ñ∂</div>
            <div class="toggle-panel-btn" id="toggle-right" onclick="UI.togglePanel('right')">‚óÄ</div>

            <!-- GAME HUD -->
            <div id="game-hud">
                <div id="health-bar"><div id="health-fill"></div></div>
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>
        </div>

        <!-- SAƒû PANEL (Explorer + Properties) -->
        <div id="right-panel" class="panel">
            <div style="height:50%; display:flex; flex-direction:column; border-bottom:1px solid #DDD;">
                <div class="panel-header">Explorer</div>
                <div class="panel-content" id="explorer-list">
                    <div class="exp-item">üìÇ Workspace</div>
                </div>
            </div>
            <div style="height:50%; display:flex; flex-direction:column;">
                <div class="panel-header">Properties</div>
                <div class="panel-content" id="properties-content">
                    <div style="text-align:center; color:#999; margin-top:20px">Se√ßim Yok</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LUNAIX AI -->
    <div id="lunaix-panel">
        <div id="ai-header">LunAIX Asistan <span onclick="UI.toggleAI()" style="cursor:pointer">‚úï</span></div>
        <div id="ai-log">
            <div class="msg bot">Merhaba! "G√∂nder" ile sohbet edebilir, "Olu≈ütur" ile in≈üaat yapabilirsin.</div>
        </div>
        <div id="ai-controls">
            <input type="text" id="ai-input" style="flex:1; padding:8px; border:1px solid #CCC; border-radius:4px;" placeholder="Mesaj yaz...">
            <button onclick="AI.chat()" style="padding:0 15px; background:#1976D2; color:white; border:none; border-radius:4px; cursor:pointer;">G√∂nder</button>
            <button onclick="AI.build()" style="padding:0 15px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer;">Olu≈ütur</button>
        </div>
    </div>

    <script>
        /* --- CORE ENGINE --- */
        const App = {
            scene: null, camera: null, renderer: null, world: null,
            controls: null, transform: null, clock: new THREE.Clock(),
            objects: [], raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),
            
            init: () => {
                const vp = document.getElementById('viewport');
                
                // Scene & Cam
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0xA0D4F6);
                App.scene.fog = new THREE.Fog(0xA0D4F6, 40, 300);

                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 2000);
                App.camera.position.set(15, 15, 20);

                // Renderer
                App.renderer = new THREE.WebGLRenderer({antialias: true});
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                // Physics
                App.world = new CANNON.World();
                App.world.gravity.set(0, -25, 0);
                App.world.broadphase = new CANNON.NaiveBroadphase();
                App.world.defaultContactMaterial.friction = 0.1;

                // Light
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                App.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 0.8);
                dir.position.set(50, 100, 50);
                dir.castShadow = true;
                dir.shadow.mapSize.width=2048; dir.shadow.mapSize.height=2048;
                App.scene.add(dir);

                // Controls
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.controls.enableDamping = true;
                
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', e=>App.controls.enabled=!e.value);
                App.transform.addEventListener('change', ()=>Editor.updatePropertiesPanel());
                App.scene.add(App.transform);

                // Events
                window.addEventListener('resize', App.resize);
                vp.addEventListener('pointerdown', Editor.onSelect);

                World.init();
                UI.initToolbox();
                Game.initInput();
                
                App.loop();
            },

            resize: () => {
                const vp = document.getElementById('viewport');
                App.camera.aspect = vp.clientWidth/vp.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = Math.min(App.clock.getDelta(), 0.1);

                if(Game.active) {
                    App.world.step(1/60, dt, 3);
                    Game.update(dt);
                } else {
                    App.controls.update();
                }

                // Sync Visuals
                App.objects.forEach(o => {
                    if(o.userData.body && !o.userData.anchored) {
                        o.position.copy(o.userData.body.position);
                        o.quaternion.copy(o.userData.body.quaternion);
                        
                        // Character R6 Fix (Offsetting visual mesh from physics center)
                        if(o.userData.isPlayer) o.position.y -= 3.0;
                    }
                    if(o.userData.type==='water') o.material.opacity = 0.4 + Math.sin(Date.now()*0.002)*0.1;
                });

                App.renderer.render(App.scene, App.camera);
            }
        };

        /* --- WORLD MANAGER --- */
        const World = {
            init: () => {
                // Baseplate 1000x1000
                const geo = new THREE.BoxGeometry(1000, 4, 1000);
                const mat = new THREE.MeshStandardMaterial({color: 0x666666});
                const mesh = new THREE.Mesh(geo, mat);
                // Surface at Y=0. Height=4 -> Center at Y=-2
                mesh.position.y = -2; 
                mesh.receiveShadow = true;
                mesh.name = "Baseplate";
                
                const body = new CANNON.Body({mass:0, shape:new CANNON.Box(new CANNON.Vec3(500, 2, 500))});
                body.position.copy(mesh.position);
                
                mesh.userData = {body, anchored:true, type:'baseplate'};
                App.scene.add(mesh);
                App.world.addBody(body);
                
                const grid = new THREE.GridHelper(1000, 250, 0x444444, 0x555555);
                grid.position.y = 0.05;
                App.scene.add(grid);

                World.addPart('box', {pos:new THREE.Vector3(0,0.5,0), scale:[6,1,6], color:0xAAAAAA, name:'SpawnLocation', anchored:true});
            },

            addPart: (type, cfg={}) => {
                const scale = cfg.scale || [4,4,4];
                let geo, shape;
                
                if(type==='sphere'){ geo=new THREE.SphereGeometry(1,32,32); shape=new CANNON.Sphere(Math.min(...scale)/2); }
                else if(type==='cylinder'){ geo=new THREE.CylinderGeometry(1,1,1,32); shape=new CANNON.Cylinder(scale[0]/2,scale[0]/2,scale[1],12); }
                else if(type==='wedge'){ geo=new THREE.ConeGeometry(1,1,4); shape=new CANNON.Box(new CANNON.Vec3(scale[0]/2,scale[1]/2,scale[2]/2)); } // Simplified
                else { geo=new THREE.BoxGeometry(1,1,1); shape=new CANNON.Box(new CANNON.Vec3(scale[0]/2,scale[1]/2,scale[2]/2)); }

                const mat = new THREE.MeshStandardMaterial({
                    color: cfg.color || 0xEEEEEE, 
                    transparent: !!cfg.opacity, 
                    opacity: cfg.opacity||1, 
                    roughness: 0.3
                });
                
                const mesh = new THREE.Mesh(geo, mat);
                mesh.scale.set(scale[0], scale[1], scale[2]);
                mesh.position.copy(cfg.pos || new THREE.Vector3(0, 10, 0));
                if(cfg.rot) mesh.rotation.copy(cfg.rot);
                mesh.castShadow = !cfg.opacity; mesh.receiveShadow = !cfg.opacity;
                mesh.name = cfg.name || type.charAt(0).toUpperCase() + type.slice(1);

                const body = new CANNON.Body({
                    mass: cfg.anchored ? 0 : (scale[0]*scale[1]*scale[2]),
                    shape: shape,
                    collisionFilterGroup: cfg.noCollide ? 2 : 1,
                    collisionFilterMask: cfg.noCollide ? 2 : 1 | 2
                });
                body.position.copy(mesh.position);
                if(cfg.rot) body.quaternion.copy(mesh.quaternion);

                mesh.userData = {body, anchored:!!cfg.anchored, type, special:cfg.special};
                
                App.scene.add(mesh);
                App.world.addBody(body);
                App.objects.push(mesh);
                
                UI.addToExplorer(mesh);
                return mesh;
            },

            addSpecial: (type) => {
                if(type==='water') World.addPart('box', {name:'Water', color:0x00A2FF, opacity:0.5, scale:[20,8,20], pos:new THREE.Vector3(10,4,0), noCollide:true, anchored:true, special:'water', type:'water'});
                else if(type==='fire') World.addPart('box', {name:'Lava', color:0xFF0000, scale:[10,1,10], anchored:true, special:'damage'});
            }
        };

        /* --- CHARACTER & GAMEPLAY --- */
        const Game = {
            active: false, player: null, body: null, hp: 100,
            input: {x:0, y:0, jump:false}, limbs: {},
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            
            play: () => {
                Game.active = true;
                Editor.select(null);
                document.getElementById('game-hud').style.display='block';
                document.getElementById('ribbon-content').style.height='0';
                document.getElementById('btn-play').style.display='none';
                document.getElementById('btn-stop').style.display='inline-block';
                
                // Hide panels
                document.getElementById('left-panel').style.width='0';
                document.getElementById('right-panel').style.width='0';
                App.resize();

                App.controls.enablePan = false;
                App.controls.minDistance=5; App.controls.maxDistance=30;
                Game.spawn();
                Game.hp=100; Game.updateHP();
            },

            stop: () => {
                Game.active = false;
                document.getElementById('game-hud').style.display='none';
                document.getElementById('ribbon-content').style.height='100px';
                document.getElementById('btn-play').style.display='inline-block';
                document.getElementById('btn-stop').style.display='none';
                
                // Show panels
                document.getElementById('right-panel').style.width='280px';
                App.resize();

                if(Game.player) { App.scene.remove(Game.player); App.world.removeBody(Game.body); }
                App.controls.target.set(0,0,0); App.camera.position.set(15,15,20);
            },

            spawn: () => {
                const grp = new THREE.Group();
                const mY = new THREE.MeshStandardMaterial({color:0xFBC02D});
                const mB = new THREE.MeshStandardMaterial({color:0x0D47A1});
                const mG = new THREE.MeshStandardMaterial({color:0x4CAF50});

                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), mY); head.position.y=5.6;
                const face = new THREE.Mesh(new THREE.PlaneGeometry(0.8,0.8), new THREE.MeshBasicMaterial({color:0})); face.position.z=0.61; head.add(face);
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), mB); torso.position.y=4;
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mY); la.position.set(-1.5,4,0);
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mY); ra.position.set(1.5,4,0);
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mG); ll.position.set(-0.5,2,0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mG); rl.position.set(0.5,2,0);

                grp.add(head, torso, la, ra, ll, rl);
                grp.castShadow = true;
                
                // Feet alignment: Total visual height ~6. Center ~3.
                // Physics Cylinder H=6, R=1.5.
                const body = new CANNON.Body({
                    mass:80, fixedRotation:true,
                    position:new CANNON.Vec3(0,10,0),
                    shape:new CANNON.Cylinder(1.5,1.5,6,12),
                    linearDamping:0.9
                });
                
                const sp = App.scene.getObjectByName("SpawnLocation");
                if(sp) body.position.set(sp.position.x, sp.position.y+3.1, sp.position.z); // Sit exactly on top

                App.scene.add(grp); App.world.addBody(body);
                Game.player=grp; Game.body=body; Game.limbs={la,ra,ll,rl};
                grp.userData = {body, isPlayer:true};
            },

            update: (dt) => {
                if(!Game.body) return;
                
                // 1. Checks
                let inWater = false;
                App.objects.forEach(o => {
                    if(o.userData.special) {
                        const p = Game.body.position;
                        const op = o.position;
                        const os = o.scale;
                        if(Math.abs(p.x-op.x)<os.x/2 && Math.abs(p.y-op.y)<os.y/2 && Math.abs(p.z-op.z)<os.z/2) {
                            if(o.userData.special==='water') inWater=true;
                            if(o.userData.special==='damage') Game.damage(1);
                        }
                    }
                });

                // 2. Movement
                const speed = inWater?15:25;
                const ang = App.controls.getAzimuthalAngle();
                const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0),ang);
                const rgt = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0),ang);
                
                const move = new THREE.Vector3().addScaledVector(rgt, Game.input.x).addScaledVector(fwd, -Game.input.y);

                if(move.length()>0.1) {
                    move.normalize().multiplyScalar(speed);
                    Game.body.velocity.x = move.x; Game.body.velocity.z = move.z;
                    Game.player.rotation.y = Math.atan2(move.x, move.z);
                    
                    // Anim
                    const t = Date.now()*0.015;
                    const m = inWater?0.5:1;
                    Game.limbs.la.rotation.x = Math.sin(t)*m; Game.limbs.ra.rotation.x = -Math.sin(t)*m;
                    Game.limbs.ll.rotation.x = -Math.sin(t)*m; Game.limbs.rl.rotation.x = Math.sin(t)*m;
                    
                    if(!inWater && Math.abs(Game.body.velocity.y)<0.1) Game.sfx('step');
                } else {
                    Game.body.velocity.x*=0.5; Game.body.velocity.z*=0.5;
                    Game.limbs.la.rotation.x=0; Game.limbs.ra.rotation.x=0;
                }

                // 3. Jump / Swim
                if(inWater) {
                    Game.body.velocity.y*=0.9;
                    if(Game.input.jump) Game.body.velocity.y=10;
                } else {
                    if(Game.input.jump && Math.abs(Game.body.velocity.y)<0.5) {
                        Game.body.velocity.y=18; Game.sfx('jump');
                    }
                }
                Game.input.jump=false;

                // 4. Void
                if(Game.body.position.y < -50) Game.damage(100);

                // 5. Camera
                App.controls.target.copy(Game.player.position);
                App.controls.target.y+=2;
            },

            damage: (amt) => {
                Game.hp -= amt; Game.updateHP();
                if(Game.hp<=0) {
                    const sp = App.scene.getObjectByName("SpawnLocation");
                    Game.body.position.set(sp.position.x, sp.position.y+4, sp.position.z);
                    Game.body.velocity.set(0,0,0); Game.hp=100; Game.updateHP();
                }
            },
            updateHP: () => document.getElementById('health-fill').style.width = Game.hp+'%',
            
            sfx: (type) => {
                if(Date.now()-(Game['last'+type]||0) < (type==='step'?300:1000)) return;
                Game['last'+type]=Date.now();
                const o = Game.ctx.createOscillator(); const g = Game.ctx.createGain();
                o.connect(g); g.connect(Game.ctx.destination);
                if(type==='step') { o.frequency.setValueAtTime(100, Game.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, Game.ctx.currentTime+0.1); o.start(); o.stop(Game.ctx.currentTime+0.1); }
                else { o.frequency.setValueAtTime(300, Game.ctx.currentTime); o.frequency.linearRampToValueAtTime(500, Game.ctx.currentTime+0.2); g.gain.exponentialRampToValueAtTime(0.01, Game.ctx.currentTime+0.2); o.start(); o.stop(Game.ctx.currentTime+0.2); }
            },
            initInput: () => {
                const z = document.getElementById('joystick-zone'); const s = document.getElementById('stick');
                let d = false;
                z.addEventListener('pointerdown', ()=>{d=true; s.style.transition='none'});
                window.addEventListener('pointermove', e=>{
                    if(!d) return;
                    const r = z.getBoundingClientRect();
                    const dx = e.clientX-(r.left+r.width/2); const dy = e.clientY-(r.top+r.height/2);
                    const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                    const ang = Math.atan2(dy,dx);
                    const fx = Math.cos(ang)*dist; const fy = Math.sin(ang)*dist;
                    s.style.transform = `translate(calc(-50% + ${fx}px), calc(-50% + ${fy}px))`;
                    Game.input.x = fx/40; Game.input.y = fy/40;
                });
                window.addEventListener('pointerup', ()=>{d=false; s.style.transition='0.2s'; s.style.transform='translate(-50%,-50%)'; Game.input.x=0; Game.input.y=0;});
                document.getElementById('jump-btn').addEventListener('pointerdown', ()=>Game.input.jump=true);
            }
        };

        /* --- EDITOR & TOOLS --- */
        const Editor = {
            selected: null, tool: 'select',
            
            setMode: (m) => {
                Editor.tool = m;
                if(m==='select') App.transform.detach();
                else if(Editor.selected) { App.transform.setMode(m); App.transform.attach(Editor.selected); }
                document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
                if(event && event.currentTarget) event.currentTarget.classList.add('active');
            },

            setTool: (t) => {
                Editor.tool = t;
                App.transform.detach();
                alert("Sculpt Aracƒ± Se√ßildi. Yere tƒ±klayarak tepe olu≈ütur.");
            },

            onSelect: (e) => {
                if(Game.active) return;
                const rect = document.getElementById('viewport').getBoundingClientRect();
                App.mouse.x = ((e.clientX-rect.left)/rect.width)*2-1;
                App.mouse.y = -((e.clientY-rect.top)/rect.height)*2+1;
                App.raycaster.setFromCamera(App.mouse, App.camera);
                const ints = App.raycaster.intersectObjects(App.objects);

                if(ints.length>0) {
                    const hit = ints[0];
                    if(Editor.tool === 'sculpt' && hit.object.name==='Baseplate') {
                        // SCULPT LOGIC (Simple Voxel Add)
                        World.addPart('sphere', {pos:hit.point, scale:[4,2,4], color:0x4CAF50, anchored:true, name:'Terrain'});
                        return;
                    }
                    if(hit.object.name!=='Baseplate') Editor.select(hit.object);
                    else Editor.select(null);
                } else Editor.select(null);
            },

            select: (obj) => {
                Editor.selected = obj;
                document.querySelectorAll('.exp-item').forEach(el => el.classList.remove('selected'));
                
                if(obj) {
                    App.transform.attach(obj);
                    Editor.updatePropertiesPanel();
                } else {
                    App.transform.detach();
                    document.getElementById('properties-content').innerHTML = '<div style="text-align:center;color:#999;margin-top:20px">Se√ßim Yok</div>';
                }
            },

            updatePropertiesPanel: () => {
                if(!Editor.selected) return;
                const o = Editor.selected;
                const p = document.getElementById('properties-content');
                p.innerHTML = `
                    <div class="prop-row"><div class="prop-label">Name</div><input class="prop-input" value="${o.name}" onchange="Editor.propChange('name', this.value)"></div>
                    <div class="prop-row"><div class="prop-label">Pos X</div><input class="prop-input" value="${o.position.x.toFixed(2)}" onchange="Editor.propChange('x', this.value)"></div>
                    <div class="prop-row"><div class="prop-label">Pos Y</div><input class="prop-input" value="${o.position.y.toFixed(2)}" onchange="Editor.propChange('y', this.value)"></div>
                    <div class="prop-row"><div class="prop-label">Pos Z</div><input class="prop-input" value="${o.position.z.toFixed(2)}" onchange="Editor.propChange('z', this.value)"></div>
                    <div class="prop-row"><div class="prop-label">Color</div><input type="color" value="#${o.material.color.getHexString()}" onchange="Editor.setColor(this.value)"></div>
                    <div class="prop-row"><div class="prop-label">Anchored</div><input type="checkbox" ${o.userData.anchored?'checked':''} onchange="Editor.toggleAnchor()"></div>
                `;
                // Sync Physics visual
                if(o.userData.body) {
                    o.userData.body.position.copy(o.position);
                    o.userData.body.quaternion.copy(o.quaternion);
                }
            },

            propChange: (key, val) => {
                if(!Editor.selected) return;
                const o = Editor.selected;
                if(key==='name') o.name = val;
                if(key==='x') o.position.x = parseFloat(val);
                if(key==='y') o.position.y = parseFloat(val);
                if(key==='z') o.position.z = parseFloat(val);
                if(o.userData.body) {
                    o.userData.body.position.copy(o.position);
                    o.userData.body.velocity.set(0,0,0);
                }
            },

            setColor: (c) => { if(Editor.selected) Editor.selected.material.color.set(c); },
            toggleAnchor: () => { 
                if(Editor.selected) {
                    Editor.selected.userData.anchored = !Editor.selected.userData.anchored;
                    Editor.selected.userData.body.mass = Editor.selected.userData.anchored ? 0 : 10;
                    Editor.selected.userData.body.updateMassProperties();
                }
            },
            delete: () => { if(Editor.selected) { App.scene.remove(Editor.selected); App.world.removeBody(Editor.selected.userData.body); Editor.select(null); } },
            toggleGrid: () => { /* ... */ },
            view: (t) => { if(t==='top') { App.camera.position.set(0,50,0); App.controls.target.set(0,0,0); } }
        };

        /* --- UI & AI --- */
        const UI = {
            setTab: (id) => {
                document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.toolbar-group').forEach(g=>g.classList.remove('active'));
                document.getElementById('tab-'+id).classList.add('active');
            },
            togglePanel: (side) => {
                const p = document.getElementById(side+'-panel');
                const btn = document.getElementById('toggle-'+side);
                if(side==='left') {
                    p.style.width = p.style.width==='0px'?'280px':'0px';
                    btn.innerText = p.style.width==='0px'?'‚ñ∂':'‚óÄ';
                } else {
                    p.style.width = p.style.width==='0px'?'280px':'0px';
                    btn.innerText = p.style.width==='0px'?'‚óÄ':'‚ñ∂';
                }
                setTimeout(App.resize, 310);
            },
            toggleAI: () => {
                const p = document.getElementById('lunaix-panel');
                p.style.display = p.style.display==='flex'?'none':'flex';
            },
            addToExplorer: (obj) => {
                const l = document.getElementById('explorer-list');
                const el = document.createElement('div');
                el.className = 'exp-item';
                el.innerText = (obj.userData.anchored?'‚öì ':'üì¶ ') + obj.name;
                el.onclick = () => Editor.select(obj);
                l.appendChild(el);
            },
            initToolbox: () => {
                const items = [
                    {n:'Kƒ±lƒ±√ß',i:'‚öîÔ∏è',f:()=>World.addPart('box',{scale:[0.2,2,0.2],color:0x999,name:'Sword'})},
                    {n:'Aƒüa√ß',i:'üå≤',f:()=>World.addPart('cylinder',{scale:[2,6],color:0x2E7D32,anchored:true,name:'Tree'})},
                    {n:'Araba',i:'üöó',f:()=>World.addPart('box',{scale:[4,2,7],color:0xD32F2F,name:'Car'})},
                    {n:'Lamba',i:'üí°',f:()=>World.addPart('sphere',{scale:[1,1],color:0xFFEB3B,anchored:true,name:'Lamp'})},
                ];
                const t = document.getElementById('toolbox-content');
                items.forEach(x=>{
                    const d = document.createElement('div');
                    d.style.padding='10px'; d.style.borderBottom='1px solid #EEE'; d.style.cursor='pointer';
                    d.innerText = x.i + " " + x.n; d.onclick = x.f; t.appendChild(d);
                });
            }
        };

        const AI = {
            log: (txt, type) => {
                const c = document.getElementById('ai-log');
                c.innerHTML += `<div class="msg ${type}">${txt}</div>`;
                c.scrollTop = c.scrollHeight;
            },
            chat: () => {
                const i = document.getElementById('ai-input');
                const v = i.value; if(!v) return;
                AI.log(v, 'user');
                setTimeout(()=>AI.log("Bunu not ettim. 'Olu≈ütur' butonuna basarsan in≈üa etmeyi denerim.", 'bot'), 500);
                i.value='';
            },
            build: () => {
                const msgs = document.querySelectorAll('.msg.user');
                if(msgs.length===0) return;
                const txt = msgs[msgs.length-1].innerText.toLowerCase();
                AI.log("ƒ∞n≈üa ediliyor: " + txt, 'bot');
                
                const sp = new THREE.Vector3(Math.random()*20-10, 0, Math.random()*20-10);
                
                if(txt.includes('kale')) {
                    for(let x=0; x<=20; x+=2) {
                        World.addPart('box', {pos:sp.clone().add(new THREE.Vector3(x,2,0)), scale:[2,4,1], color:0x555, anchored:true});
                        World.addPart('box', {pos:sp.clone().add(new THREE.Vector3(x,2,20)), scale:[2,4,1], color:0x555, anchored:true});
                        World.addPart('box', {pos:sp.clone().add(new THREE.Vector3(0,2,x)), scale:[1,4,2], color:0x555, anchored:true});
                        World.addPart('box', {pos:sp.clone().add(new THREE.Vector3(20,2,x)), scale:[1,4,2], color:0x555, anchored:true});
                    }
                    [[0,0],[20,0],[0,20],[20,20]].forEach(p=>World.addPart('cylinder', {pos:sp.clone().add(new THREE.Vector3(p[0],4,p[1])), scale:[3,8], color:0x333, anchored:true}));
                }
                else if(txt.includes('≈üehir')) {
                    for(let i=0; i<10; i++) {
                        World.addPart('box', {pos:new THREE.Vector3(Math.random()*60-30, Math.random()*10+5, Math.random()*60-30), scale:[6, 10+Math.random()*20, 6], color:0x777, anchored:true});
                    }
                }
                else {
                    AI.log("Karma≈üƒ±k bir yapƒ± olu≈üturdum.", 'bot');
                    for(let i=0; i<20; i++) World.addPart('box', {pos:sp.clone().add(new THREE.Vector3(Math.random()*10, i, Math.random()*10)), scale:[2,2,2], color:Math.random()*0xFFFFFF, anchored:true});
                }
            }
        };

    </script>
</body>
</html>
