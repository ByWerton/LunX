<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V4.0 Ultimate - R6 Edition</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --bg-input: #333333;
            --accent: #007acc; /* Mavi */
            --accent-hover: #0098ff;
            --text: #cccccc;
            --border: #3e3e42;
            --selection: #094771;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; }
        
        body { margin: 0; padding: 0; background: var(--bg-dark); color: var(--text); overflow: hidden; height: 100vh; width: 100vw; display: flex; flex-direction: column; }

        /* --- ÖZEL CSS İKONLAR (UNICODE YOK) --- */
        .icon { display: inline-block; width: 16px; height: 16px; position: relative; }
        
        /* Play Icon */
        .icon-play { background: #2da042; clip-path: polygon(20% 0%, 100% 50%, 20% 100%); width: 12px; height: 12px; }
        /* Stop Icon */
        .icon-stop { background: #d32f2f; width: 12px; height: 12px; border-radius: 2px; }
        /* Cube Icon */
        .icon-cube { border: 2px solid #ddd; width: 14px; height: 14px; background: transparent; }
        /* Script Icon */
        .icon-script { background: #f1c40f; width: 10px; height: 14px; position: relative; }
        .icon-script::after { content:''; position:absolute; bottom:2px; left:2px; width:6px; height:1px; background:#000; box-shadow: 0 -2px 0 #000, 0 -4px 0 #000; }
        /* Folder Icon */
        .icon-folder { background: #e67e22; width: 16px; height: 12px; clip-path: polygon(0 0, 40% 0, 50% 20%, 100% 20%, 100% 100%, 0 100%); }
        /* Settings X Icon */
        .icon-x { width: 20px; height: 20px; position: relative; }
        .icon-x::before, .icon-x::after { content: ''; position: absolute; width: 100%; height: 2px; background: white; top: 50%; left: 0; }
        .icon-x::before { transform: rotate(45deg); }
        .icon-x::after { transform: rotate(-45deg); }

        /* --- LAYOUT --- */
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        /* Login & Loading */
        .auth-box { width: 350px; padding: 30px; background: var(--bg-panel); border: 1px solid var(--accent); border-radius: 8px; text-align: center; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: var(--bg-input); border: 1px solid var(--border); color: white; outline: none; }
        button { width: 100%; padding: 10px; background: var(--accent); border: none; color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: var(--accent-hover); }
        .loading-bar { width: 300px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; overflow: hidden; }
        .loading-progress { width: 0%; height: 100%; background: var(--accent); transition: width 0.2s; }

        /* Studio UI */
        #studio-ui { display: none; flex-direction: column; height: 100%; width: 100%; }
        
        #toolbar { height: 40px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 10px; gap: 10px; }
        .tool-btn { width: auto; padding: 5px 15px; background: #333; font-size: 12px; display: flex; align-items: center; gap: 5px; border-radius: 4px; }
        .tool-btn:active { transform: scale(0.95); }
        
        #workspace { display: flex; flex: 1; position: relative; overflow: hidden; }
        
        #viewport { flex: 1; background: #000; position: relative; }
        
        /* Resizable Sidebar */
        #sidebar { width: 300px; background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; min-width: 150px; max-width: 600px; position: relative; }
        #resizer { width: 5px; cursor: col-resize; position: absolute; left: 0; top: 0; bottom: 0; z-index: 10; background: transparent; }
        #resizer:hover { background: var(--accent); opacity: 0.5; }

        /* Explorer & Properties */
        .panel-header { background: #333; padding: 5px 10px; font-size: 12px; font-weight: bold; border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); }
        .tree-view { flex: 1; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; }
        .tree-item { padding: 2px 5px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .tree-item:hover { background: #3e3e40; }
        .tree-item.selected { background: var(--selection); color: white; }
        
        .properties-view { height: 40%; border-top: 1px solid var(--border); overflow-y: auto; padding: 10px; }
        .prop-row { display: flex; margin-bottom: 5px; align-items: center; font-size: 11px; }
        .prop-label { width: 80px; color: #aaa; }
        .prop-input { flex: 1; background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 2px; }

        /* Script Editor Modal */
        #script-editor { position: absolute; top: 40px; left: 0; right: 300px; bottom: 0; background: #1e1e1e; z-index: 50; display: none; flex-direction: column; }
        #code-area { flex: 1; background: #141414; color: #dcdcdc; border: none; padding: 10px; font-family: 'Consolas', monospace; font-size: 14px; resize: none; outline: none; }
        .script-toolbar { height: 30px; background: #252526; display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid var(--border); }

        /* --- OYUN İÇİ UI (GAME UI) --- */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 100; }
        
        /* X Menu Button */
        #menu-btn { 
            position: absolute; top: 15px; left: 15px; width: 36px; height: 36px; 
            background: rgba(0,0,0,0.8); border-radius: 8px; pointer-events: auto; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 2px solid #444;
        }
        #menu-btn:hover { background: #000; border-color: var(--accent); }

        /* X Menu Panel */
        #ingame-menu {
            position: absolute; top: 60px; left: 15px; width: 200px; 
            background: rgba(30,30,30,0.95); border-radius: 8px; pointer-events: auto;
            display: none; flex-direction: column; padding: 10px; gap: 10px;
            border: 1px solid #444;
        }
        
        /* Joystick */
        #joystick-container { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; pointer-events: auto; }
        #joystick-bg { width: 100%; height: 100%; background: rgba(255,255,255,0.1); border-radius: 50%; position: relative; }
        #joystick-stick { width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 2px 5px black;}

        /* Jump Button */
        #jump-btn { 
            position: absolute; bottom: 60px; right: 60px; width: 70px; height: 70px; 
            background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; 
            display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.5);
        }
        #jump-btn:active { background: rgba(255,255,255,0.5); }
        .jump-icon { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid white; }

    </style>
</head>
<body>

    <div id="loading-screen" class="full-screen">
        <div style="font-size: 24px; font-weight: bold; color: var(--accent);">LUNX ENGINE</div>
        <div style="font-size: 12px; color: #666;">R6 CHARACTER SYSTEM</div>
        <div class="loading-bar"><div class="loading-progress" id="progress"></div></div>
        <div id="loading-text" style="margin-top: 10px; font-size: 12px;">Sistem Başlatılıyor...</div>
    </div>

    <div id="auth-screen" class="full-screen" style="display:none;">
        <div class="auth-box">
            <h2 style="color: var(--accent);">Giriş Yap</h2>
            <input type="email" id="login-email" placeholder="E-posta">
            <input type="password" id="login-pass" placeholder="Şifre">
            <button onclick="App.auth.login()">GİRİŞ</button>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">Misafir girişi için bilgileri boş bırakıp basabilirsiniz.</p>
        </div>
    </div>

    <div id="studio-ui">
        <div id="toolbar">
            <div style="font-weight: bold; color: var(--accent); margin-right: 10px;">FILE</div>
            <button class="tool-btn" onclick="App.editor.runGame()"><div class="icon icon-play"></div> OYNA</button>
            <button class="tool-btn" style="background:#444;" onclick="App.editor.stopGame()"><div class="icon icon-stop"></div> DURDUR</button>
            <div style="width: 1px; height: 20px; background: #444; margin: 0 10px;"></div>
            <button class="tool-btn" onclick="App.editor.addPart()"> <div class="icon icon-cube"></div> Part</button>
            <button class="tool-btn" onclick="App.editor.addScript()"> <div class="icon icon-script"></div> Script</button>
        </div>

        <div id="workspace">
            <div id="viewport">
                <div id="game-ui">
                    <div id="menu-btn" onclick="App.game.toggleMenu()">
                        <div class="icon icon-x"></div>
                    </div>
                    <div id="ingame-menu">
                        <div style="font-weight: bold; margin-bottom: 5px;">AYARLAR</div>
                        <button onclick="App.game.resetCharacter()">Karakteri Sıfırla</button>
                        <div style="font-size:12px;">UI Ölçeği</div>
                        <input type="range" min="0.5" max="1.5" step="0.1" onchange="document.body.style.zoom = this.value">
                    </div>

                    <div id="joystick-container">
                        <div id="joystick-bg"><div id="joystick-stick"></div></div>
                    </div>
                    <div id="jump-btn"><div class="jump-icon"></div></div>
                </div>
            </div>

            <div id="resizer"></div>
            <div id="sidebar">
                <div class="panel-header">EXPLORER</div>
                <div class="tree-view" id="explorer-list">
                    </div>
                <div class="panel-header">PROPERTIES</div>
                <div class="properties-view" id="properties-list">
                    </div>
            </div>

            <div id="script-editor">
                <div class="script-toolbar">
                    <button style="width: auto; padding: 2px 10px; font-size: 11px;" onclick="App.editor.closeScript()">KAPAT</button>
                    <span id="script-name" style="margin-left: 10px; color: #aaa;">script.js</span>
                </div>
                <textarea id="code-area"></textarea>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        /**
         * LUNX ENGINE CORE V4.0 - R6 EDITION
         */
        
        // 1. Firebase Yapılandırması
        const firebaseConfig = {
            apiKey: "AIzaSyD4Dh_WCxTSqMnJ8u0M4KqwHpejJrEoctk", // Kullanıcının sağladığı key
            authDomain: "lunxstudio.firebaseapp.com",
            projectId: "lunxstudio"
        };

        const App = {
            state: { mode: 'edit', selectedId: null, dragging: false },
            world: { scene: null, camera: null, renderer: null, objects: [] },
            player: { mesh: null, velocity: {x:0, y:0, z:0}, isGrounded: false, animTime: 0 },
            input: { fwd:0, bwd:0, lft:0, rgt:0, jump: false, joy: {x:0, y:0} },
            
            // Başlatma
            init: () => {
                App.ui.updateProgress(20);
                try {
                    firebase.initializeApp(firebaseConfig);
                    console.log("Firebase OK.");
                } catch(e) { console.warn("Firebase uyarısı (Local modda olabilir):", e); }
                
                setTimeout(() => {
                    App.ui.updateProgress(100);
                    document.getElementById('loading-screen').style.display = 'none';
                    // Otomatik olarak auth ekranını göster
                    document.getElementById('auth-screen').style.display = 'flex';
                }, 1000);

                // 3D Sahneyi Arka Planda Kur
                App.engine.init3D();
                App.ui.setupResizer();
                App.input.setup();
            },

            auth: {
                login: () => {
                    // Basit geçiş (Gerçek auth mantığı eklenebilir)
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('studio-ui').style.display = 'flex';
                    App.engine.resize(); // Canvas boyutunu düzelt
                    App.hierarchy.refresh();
                }
            },

            engine: {
                init3D: () => {
                    const vp = document.getElementById('viewport');
                    const scene = new THREE.Scene();
                    scene.background = new THREE.Color(0x87ceeb); // Gerçekçi gökyüzü mavisi
                    
                    // Zemin ve Işık
                    const groundGeo = new THREE.PlaneGeometry(100, 100);
                    const groundMat = new THREE.MeshStandardMaterial({ color: 0x555555 });
                    const ground = new THREE.Mesh(groundGeo, groundMat);
                    ground.rotation.x = -Math.PI / 2;
                    ground.name = "Baseplate";
                    ground.userData = { type: 'Part', locked: true };
                    scene.add(ground);
                    App.world.objects.push(ground);

                    const light = new THREE.DirectionalLight(0xffffff, 1);
                    light.position.set(20, 50, 10);
                    scene.add(light);
                    scene.add(new THREE.AmbientLight(0x404040, 1.5));

                    const camera = new THREE.PerspectiveCamera(70, vp.clientWidth / vp.clientHeight, 0.1, 1000);
                    camera.position.set(0, 10, 15);
                    camera.lookAt(0, 0, 0);

                    const renderer = new THREE.WebGLRenderer({ antialias: true });
                    renderer.setSize(vp.clientWidth, vp.clientHeight);
                    vp.appendChild(renderer.domElement);

                    App.world.scene = scene;
                    App.world.camera = camera;
                    App.world.renderer = renderer;

                    // Ana Döngü
                    const clock = new THREE.Clock();
                    const loop = () => {
                        requestAnimationFrame(loop);
                        const dt = clock.getDelta();

                        if (App.state.mode === 'play') {
                            App.physics.update(dt);
                        } else {
                            // Editör kamerasını basitçe hareket ettir (Orbit yerine basit look)
                            // (Gelişmiş orbit bu örnekte kod kalabalığı olmasın diye basitleştirildi)
                        }
                        renderer.render(scene, camera);
                    };
                    loop();
                },

                resize: () => {
                    const vp = document.getElementById('viewport');
                    if (App.world.camera) {
                        App.world.camera.aspect = vp.clientWidth / vp.clientHeight;
                        App.world.camera.updateProjectionMatrix();
                        App.world.renderer.setSize(vp.clientWidth, vp.clientHeight);
                    }
                },

                addPart: () => {
                    const geo = new THREE.BoxGeometry(2, 2, 2);
                    const mat = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.y = 1;
                    mesh.name = "Part";
                    mesh.userData = { type: 'Part', script: '' };
                    
                    App.world.scene.add(mesh);
                    App.world.objects.push(mesh);
                    App.hierarchy.refresh();
                },
                
                addScript: () => {
                    // Sahneye görünmez bir script objesi ekle
                    const dummy = { name: "Script", userData: { type: 'Script', code: 'print("Hello World")' }, uuid: THREE.MathUtils.generateUUID() };
                    App.world.objects.push(dummy);
                    App.hierarchy.refresh();
                }
            },

            // --- R6 KARAKTER VE FİZİK ---
            physics: {
                createR6: () => {
                    // Roblox R6 Yapısı: Head, Torso, LeftArm, RightArm, LeftLeg, RightLeg
                    const group = new THREE.Group();
                    
                    const matSkin = new THREE.MeshStandardMaterial({color: 0xffcc99}); // Ten
                    const matTorso = new THREE.MeshStandardMaterial({color: 0x3498db}); // Mavi Tişört
                    const matLegs = new THREE.MeshStandardMaterial({color: 0x2c3e50}); // Siyah Pantolon

                    // 1. KAFA (Silindir istendi)
                    const headGeo = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
                    const head = new THREE.Mesh(headGeo, matSkin);
                    head.position.y = 4.5;
                    head.name = "Head";
                    group.add(head);

                    // 2. GÖVDE (Kare, X Logolu)
                    const torsoGeo = new THREE.BoxGeometry(2, 2, 1);
                    const torso = new THREE.Mesh(torsoGeo, matTorso);
                    torso.position.y = 3;
                    torso.name = "Torso";
                    
                    // X Logosu Çizimi (Canvas Texture)
                    const canvas = document.createElement('canvas');
                    canvas.width = 64; canvas.height = 64;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#3498db'; ctx.fillRect(0,0,64,64); // Arkaplan
                    ctx.strokeStyle = 'white'; ctx.lineWidth = 5;
                    ctx.beginPath(); ctx.moveTo(10,10); ctx.lineTo(54,54); ctx.moveTo(54,10); ctx.lineTo(10,54); ctx.stroke();
                    const tex = new THREE.CanvasTexture(canvas);
                    // Sadece ön yüze uygula (Materyal dizisi ile yapılabilir ama basitlik için genel atıyoruz)
                    torso.material = new THREE.MeshStandardMaterial({map: tex}); 
                    
                    group.add(torso);

                    // 3. KOLLAR (Dikdörtgen)
                    const armGeo = new THREE.BoxGeometry(1, 2, 1);
                    const lArm = new THREE.Mesh(armGeo, matSkin);
                    lArm.position.set(-1.5, 3, 0); lArm.name = "LeftArm";
                    group.add(lArm);
                    
                    const rArm = new THREE.Mesh(armGeo, matSkin);
                    rArm.position.set(1.5, 3, 0); rArm.name = "RightArm";
                    group.add(rArm);

                    // 4. BACAKLAR (Dikdörtgen)
                    const legGeo = new THREE.BoxGeometry(1, 2, 1);
                    const lLeg = new THREE.Mesh(legGeo, matLegs);
                    lLeg.position.set(-0.5, 1, 0); lLeg.name = "LeftLeg";
                    group.add(lLeg);

                    const rLeg = new THREE.Mesh(legGeo, matLegs);
                    rLeg.position.set(0.5, 1, 0); rLeg.name = "RightLeg";
                    group.add(rLeg);

                    App.world.scene.add(group);
                    App.player.mesh = group;
                    
                    // Spawn Konumu
                    group.position.set(0, 0, 0);
                },

                update: (dt) => {
                    if (!App.player.mesh) return;

                    const p = App.player.mesh;
                    const speed = 10;
                    const jumpForce = 15;
                    const gravity = -30;

                    // Girdileri Hesapla
                    let dx = 0; let dz = 0;
                    
                    // Klavye
                    /* (Klavye listener eklenebilir, ancak odak mobilde) */
                    
                    // Joystick
                    if (App.input.joy.x !== 0 || App.input.joy.y !== 0) {
                        dx = App.input.joy.x;
                        dz = App.input.joy.y;
                    }

                    // Hareket Vektörü
                    const moveVec = new THREE.Vector3(dx, 0, dz).normalize();
                    
                    // Animasyon (Basit kol/bacak sallanması)
                    if (moveVec.length() > 0.1) {
                        App.player.animTime += dt * 10;
                        const angle = Math.sin(App.player.animTime) * 0.5;
                        
                        const lArm = p.getObjectByName("LeftArm");
                        const rArm = p.getObjectByName("RightArm");
                        const lLeg = p.getObjectByName("LeftLeg");
                        const rLeg = p.getObjectByName("RightLeg");
                        
                        if(lArm) lArm.rotation.x = angle;
                        if(rArm) rArm.rotation.x = -angle;
                        if(lLeg) lLeg.rotation.x = -angle;
                        if(rLeg) rLeg.rotation.x = angle;
                        
                        // Karakteri hareket yönüne döndür
                        const targetRot = Math.atan2(dx, dz);
                        p.rotation.y = targetRot;
                        
                        p.position.x += Math.sin(targetRot) * speed * dt;
                        p.position.z += Math.cos(targetRot) * speed * dt;
                    } else {
                         // Durma pozu
                         ["LeftArm", "RightArm", "LeftLeg", "RightLeg"].forEach(name => {
                             const part = p.getObjectByName(name);
                             if(part) part.rotation.x = 0;
                         });
                    }

                    // Fizik (Yerçekimi & Zıplama)
                    App.player.velocity.y += gravity * dt;
                    
                    if (App.player.isGrounded && App.input.jump) {
                        App.player.velocity.y = jumpForce;
                        App.player.isGrounded = false;
                        App.input.jump = false;
                    }

                    p.position.y += App.player.velocity.y * dt;

                    // Basit Zemin Çarpışması
                    if (p.position.y < 0) {
                        p.position.y = 0;
                        App.player.velocity.y = 0;
                        App.player.isGrounded = true;
                    }

                    // Kamera Takibi (Third Person)
                    const camOffset = new THREE.Vector3(0, 8, -10); // Arkadan ve yukarıdan
                    // Kamera açısını karakterin arkasına sabitlemek istemiyorsak sabit offset kullanırız
                    // Eğer karakterle dönsün istiyorsak: camOffset.applyAxisAngle(new THREE.Vector3(0,1,0), p.rotation.y);
                    
                    const targetPos = p.position.clone().add(new THREE.Vector3(0, 2, 0));
                    App.world.camera.position.lerp(p.position.clone().add(new THREE.Vector3(0, 8, 12)), 0.1);
                    App.world.camera.lookAt(targetPos);
                }
            },

            // --- HİYERARŞİ & ÖZELLİKLER ---
            hierarchy: {
                refresh: () => {
                    const list = document.getElementById('explorer-list');
                    list.innerHTML = '';
                    
                    App.world.objects.forEach((obj, index) => {
                        const el = document.createElement('div');
                        el.className = 'tree-item';
                        let iconClass = 'icon-cube';
                        if (obj.userData.type === 'Script') iconClass = 'icon-script';
                        if (obj.name === 'Baseplate') iconClass = 'icon-folder'; // Sembolik
                        
                        el.innerHTML = `<div class="icon ${iconClass}"></div> ${obj.name}`;
                        el.onclick = () => App.editor.select(obj);
                        list.appendChild(el);
                    });
                }
            },

            editor: {
                select: (obj) => {
                    App.state.selectedId = obj.uuid;
                    // UI Güncelle
                    document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
                    // Özellikler panelini doldur
                    const props = document.getElementById('properties-content');
                    if (obj.userData.type === 'Script') {
                        props.innerHTML = `<button onclick="App.editor.openScript('${obj.uuid}')">Kodu Düzenle</button>`;
                    } else {
                        props.innerHTML = `
                            <div class="prop-row"><div class="prop-label">Name</div><input class="prop-input" value="${obj.name}"></div>
                            <div class="prop-row"><div class="prop-label">Position</div><input class="prop-input" value="${obj.position.x.toFixed(1)}, ${obj.position.y.toFixed(1)}, ${obj.position.z.toFixed(1)}"></div>
                        `;
                    }
                },
                openScript: (uuid) => {
                    document.getElementById('script-editor').style.display = 'flex';
                    // Normalde UUID ile kod bulunur, şimdilik dummy
                },
                closeScript: () => {
                    document.getElementById('script-editor').style.display = 'none';
                },
                
                // OYUN MODU YÖNETİMİ
                runGame: () => {
                    App.state.mode = 'play';
                    document.getElementById('game-ui').style.display = 'block';
                    // Kamerayı sıfırla veya ayarla
                    App.physics.createR6();
                },
                stopGame: () => {
                    App.state.mode = 'edit';
                    document.getElementById('game-ui').style.display = 'none';
                    if(App.player.mesh) {
                        App.world.scene.remove(App.player.mesh);
                        App.player.mesh = null;
                    }
                    // Kamerayı eski yerine al
                    App.world.camera.position.set(0, 10, 15);
                    App.world.camera.lookAt(0,0,0);
                }
            },
            
            // --- GİRİŞ YÖNETİMİ (Joystick & UI) ---
            game: {
                toggleMenu: () => {
                    const menu = document.getElementById('ingame-menu');
                    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
                },
                resetCharacter: () => {
                    if(App.player.mesh) {
                        App.player.mesh.position.set(0, 10, 0);
                        App.player.velocity.y = 0;
                    }
                    document.getElementById('ingame-menu').style.display = 'none';
                }
            },

            ui: {
                updateProgress: (val) => document.getElementById('progress').style.width = val + '%',
                
                setupResizer: () => {
                    const resizer = document.getElementById('resizer');
                    const sidebar = document.getElementById('sidebar');
                    
                    resizer.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        document.addEventListener('mousemove', resize);
                        document.addEventListener('mouseup', stopResize);
                    });
                    
                    function resize(e) {
                        const width = document.body.clientWidth - e.clientX;
                        sidebar.style.width = width + 'px';
                        App.engine.resize();
                    }
                    function stopResize() {
                        document.removeEventListener('mousemove', resize);
                        document.removeEventListener('mouseup', stopResize);
                    }
                }
            },
            
            input: {
                setup: () => {
                    const stick = document.getElementById('joystick-stick');
                    const zone = document.getElementById('joystick-zone');
                    const maxDist = 35;
                    
                    const handleMove = (clientX, clientY) => {
                        const rect = zone.getBoundingClientRect();
                        const centerX = rect.left + rect.width/2;
                        const centerY = rect.top + rect.height/2;
                        
                        let dx = clientX - centerX;
                        let dy = clientY - centerY;
                        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), maxDist);
                        const angle = Math.atan2(dy, dx);
                        
                        const finalX = Math.cos(angle) * dist;
                        const finalY = Math.sin(angle) * dist;
                        
                        stick.style.transform = `translate(calc(-50% + ${finalX}px), calc(-50% + ${finalY}px))`;
                        
                        // Normalize Input (-1 to 1)
                        App.input.joy.x = finalX / maxDist;
                        App.input.joy.y = finalY / maxDist;
                    };
                    
                    const endMove = () => {
                        stick.style.transform = `translate(-50%, -50%)`;
                        App.input.joy.x = 0;
                        App.input.joy.y = 0;
                    };

                    zone.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
                    zone.addEventListener('touchend', endMove);
                    // PC testi için mouse desteği
                    let dragging = false;
                    zone.addEventListener('mousedown', () => dragging = true);
                    document.addEventListener('mousemove', (e) => { if(dragging) handleMove(e.clientX, e.clientY); });
                    document.addEventListener('mouseup', () => { dragging = false; endMove(); });

                    // Jump
                    const jumpBtn = document.getElementById('jump-btn');
                    const doJump = (e) => { e.preventDefault(); App.input.jump = true; };
                    jumpBtn.addEventListener('touchstart', doJump);
                    jumpBtn.addEventListener('mousedown', doJump);
                }
            }
        };

        // Uygulamayı Başlat
        window.onload = App.init;

    </script>
</body>
</html>
