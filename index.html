<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunX Studio V2.9 - Birle≈ütirilmi≈ü Tek Dosya (Geli≈ümi≈ü Mobil Kontrol)</title>
    <style>
        /* ==================================================================== */
        /* CSS Stilleri - TAMAMI BURADA Bƒ∞RLE≈ûTƒ∞Rƒ∞LDƒ∞ */
        /* ==================================================================== */
        :root {
            --primary-color: #007acc;
            --secondary-color: #2da042;
            --background-dark: #1e1e1e;
            --panel-bg: #252526;
            --text-color: #ddd;
            --border-color: #3e3e42;
        }

        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--background-dark); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; }
        
        /* Genel Konteyner Stilleri */
        .full-screen-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30, 30, 30, 0.95); z-index: 5000; justify-content: center; align-items: center; }
        
        /* Loading Screen Styles */
        #loading-screen { flex-direction: column; background: var(--background-dark); z-index: 9999; }
        #progress-bar { height: 100%; width: 0%; background: var(--primary-color); transition: width 0.3s; border-radius: 5px; }
        #restart-button { background-color: #c92c2c; }

        /* Auth/Modal Container Styles */
        .auth-container, .settings-panel, .project-container { 
            background: var(--panel-bg); padding: 40px; width: 400px; max-width: 90%; 
            max-height: 80vh; overflow-y: auto; border-radius: 8px; border: 2px solid var(--primary-color); 
            text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: flex; 
            flex-direction: column; align-items: center; gap: 15px; box-sizing: border-box; 
            transition: width 0.3s; 
        }
        .logo { font-size: 20px; font-weight: bold; color: var(--primary-color); margin-right: 20px; letter-spacing: 1px; }

        /* Input & Button Styles */
        input[type="text"], input[type="email"], input[type="password"], #template-select, textarea, select, .start-btn { 
            width: 100%; padding: 12px; background: #333; border: 1px solid #555; 
            color: white; border-radius: 4px; box-sizing: border-box; font-size: 14px; 
        }
        .start-btn { background-color: var(--primary-color); border: none; color: white; cursor: pointer; transition: background-color 0.2s; }
        .start-btn:hover { background-color: #006bbd; }
        #auth-error, #security-status { color: #ff4444; font-size: 13px; padding: 8px; border: 1px solid #ff4444; background: #301010; display: none; width: 100%; box-sizing: border-box;}
        .switch-auth { color: var(--primary-color); cursor: pointer; font-size: 14px; display: inline-block; }
        
        /* Editor/Studio Styles */
        #toolbar { background-color: var(--panel-bg); display: none; align-items: center; padding: 5px 10px; border-bottom: 1px solid var(--border-color); height: 40px; }
        .tool-group { display: flex; gap: 5px; margin-right: 20px; }
        .tool-btn { background-color: #3e3e42; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; transition: 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .tool-btn:hover { background-color: #505050; }
        .tool-btn.active { background-color: var(--primary-color); }
        
        #main-area { flex-grow: 1; display: none; overflow: hidden; position: relative; }
        #viewport { flex-grow: 1; position: relative; background-color: #000; }
        #sidebar-right { width: 250px; background-color: var(--panel-bg); padding: 10px; border-left: 1px solid var(--border-color); overflow-y: auto; }
        .hierarchy-item { padding: 5px; cursor: pointer; border-radius: 3px; font-size: 14px; margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .hierarchy-item.selected { background-color: var(--primary-color); }
        .prop-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .prop-row input { width: 60%; }
        
        /* Customization Styles */
        .settings-menu { display: flex; flex-direction: column; gap: 5px; margin-right: 20px; }
        .settings-menu .menu-item { padding: 10px; cursor: pointer; background: var(--panel-bg); border-radius: 4px; transition: 0.2s; border: 1px solid transparent;}
        .settings-menu .menu-item:hover { background: #3e3e42; }
        .settings-menu .menu-item.active { background: var(--primary-color); border-color: var(--primary-color); }

        .color-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 14px; }
        .color-row input[type="color"] { width: 50px; height: 30px; border: none; padding: 0; }
        .custom-preview { width: 50px; height: 50px; border: 1px solid #555; background-size: cover; background-position: center; display: inline-block; margin-left: 10px; vertical-align: middle; line-height: 50px; text-align: center; font-size: 10px;}
        .file-upload-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;}
        
        /* Mobile Controls */
        #mobile-controls { 
            position: absolute; bottom: 10px; left: 10px; display: none; z-index: 10; gap: 20px;
            pointer-events: none; width: calc(100% - 20px); justify-content: space-between;
        }
        #mobile-controls.active { pointer-events: auto; }
        #joystick-wrapper { 
            width: 100px; height: 100px; 
            /* Mobil cihazlarda sol alt k√∂≈üeye sabitlenmesi i√ßin */
            position: fixed; 
            bottom: 20px; 
            left: 20px;
        }
        #joystick-area { 
            width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.4); 
            border-radius: 50%; 
            position: relative; 
            touch-action: none;
        }
        #joystick-handle { 
            width: 40px; height: 40px; 
            background: var(--primary-color); 
            border-radius: 50%; 
            position: absolute; 
            top: 30px; left: 30px; 
            touch-action: none; 
        }
        #jump-button { 
            width: 60px; height: 60px; 
            background: var(--secondary-color); 
            border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 30px; color: white; z-index: 10; 
            /* Mobil cihazlarda saƒü alt k√∂≈üeye sabitlenmesi i√ßin */
            position: fixed; 
            bottom: 30px; 
            right: 30px;
            pointer-events: auto; /* Tƒ±klanabilir olmasƒ±nƒ± saƒüla */
        }
        
        /* Skybox Panel Stilleri */
        #skybox-gallery { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; 
            margin-top: 10px; padding: 5px; max-height: 300px; overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        .skybox-thumbnail {
            width: 100%; padding-top: 100%; position: relative; cursor: pointer;
            border: 2px solid transparent; transition: border-color 0.2s; overflow: hidden;
            background-color: #333;
        }
        .skybox-thumbnail.selected { border-color: var(--primary-color); }
        .skybox-thumbnail img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="loading-screen" class="full-screen-container" style="display: flex;">
        <h1 style="color: var(--primary-color); font-size: 40px; margin-bottom: 20px;">LUNX STUDIO</h1>
        <div style="width: 300px; height: 10px; background: #333; border-radius: 5px;">
            <div id="progress-bar"></div>
        </div>
        <p id="progress-text" style="color: var(--text-color); margin-top: 15px; font-size: 18px;">Y√ºkleniyor...</p>
        <button id="restart-button" class="start-btn" style="display: none; background-color: #c92c2c; margin-top: 20px;" onclick="window.restartLoad()">Ba≈ütan Y√ºkle</button>
    </div>
    
    <div id="auth-screen" class="full-screen-container">
        <div id="auth-container" class="auth-container">
            <h1 class="logo" style="font-size: 36px; margin-bottom: 10px;">LUNX STUDIO</h1>
            <h2 id="auth-title" style="color:var(--primary-color); margin-bottom: 10px;">Gƒ∞Rƒ∞≈û YAP</h2>
            <div id="auth-error" style="display: none;"></div>
            
            <input type="text" id="auth-username-input" placeholder="Kullanƒ±cƒ± Adƒ±" style="display: none;">
            <input type="email" id="auth-email-input" placeholder="E-posta Adresi">
            <input type="password" id="auth-password-input" placeholder="≈ûifre">
            
            <div id="initial-settings" style="display: none; width: 100%; text-align: left; padding-left: 5px;">
                <label style="color: var(--primary-color); font-weight: bold;">Ba≈ülangƒ±√ß Cinsiyeti:</label><br>
                <input type="radio" id="gender-male" name="gender-auth" value="male" checked> Erkek
                <input type="radio" id="gender-female" name="gender-auth" value="female" style="margin-left: 15px;"> Kƒ±z
            </div>
            
            <button id="auth-submit-btn" class="start-btn" onclick="window.handleAuthSubmit()">Giri≈ü Yap</button>
            <a id="auth-switch-link" class="switch-auth" onclick="window.switchAuthMode()">Hesabƒ±n yok mu? (Kayƒ±t Ol)</a>
        </div>
    </div>
    
    <div id="project-screen" class="full-screen-container">
        <div class="project-container" style="width: 90%; max-width: 800px; padding: 30px; display: flex; flex-direction: column;">
            <div class="project-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                <div class="logo" style="font-size: 28px;">LUNX PROJELER</div>
                <div class="user-panel" style="display: flex; align-items: center; gap: 10px;">
                    <span id="project-user-email" style="font-size: 14px;"></span>
                    <button id="settings-btn" class="tool-btn" onclick="window.showSettingsScreen('profile')">‚öôÔ∏è Ayarlar</button>
                    <button class="tool-btn" onclick="window.logoutUser()">√áƒ±kƒ±≈ü Yap</button>
                </div>
            </div>
            
            <h3 style="color:var(--primary-color); text-align: left; margin-bottom: 15px;">YENƒ∞ PROJE OLU≈ûTUR</h3>
            <div class="template-area" style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                <select id="template-select" style="flex-grow: 1;">
                    <option value="empty">Bo≈ü Sahne (Sadece G√∂ky√ºz√º)</option>
                    <option value="default_template">Zemin ve Grid</option>
                    <option value="simple_cube">Basit K√ºp √ñrneƒüi</option>
                </select>
                <button class="start-btn" onclick="window.startStudio(true)" style="width: 200px; background-color: var(--secondary-color);">Yeni Ba≈ülat</button>
            </div>
            
            <h3 style="color:var(--secondary-color); text-align: left; margin-bottom: 15px; border-top: 1px solid var(--border-color); padding-top: 20px;">KAYITLI PROJELER</h3>
            <button class="start-btn" onclick="window.loadScene()" style="background-color: #3e3e42;">Buluttan Proje Y√ºkle</button>
        </div>
    </div>
    
    <div id="toolbar">
        <div class="logo">LunX</div>
        <div class="tool-group">
            <button id="play-button" class="tool-btn active" onclick="window.toggleSimulationMode(true)" title="Oyunu Ba≈ülat">‚ñ∂Ô∏è Oynat</button>
            <button id="stop-button" class="tool-btn" onclick="window.toggleSimulationMode(false)" title="Oyunu Durdur">üõë Durdur</button>
        </div>
        <div class="tool-group" id="editor-tools">
            <button id="tool-select" class="tool-btn active" onclick="window.setTool('select')" title="Se√ß (S)">üñ±Ô∏è</button>
            <button id="tool-translate" class="tool-btn" onclick="window.setTool('translate')" title="Ta≈üƒ± (W)">‚ÜîÔ∏è</button>
            <button id="tool-rotate" class="tool-btn" onclick="window.setTool('rotate')" title="√áevir (Q)">üîÑ</button>
            <button id="tool-scale" class="tool-btn" onclick="window.setTool('scale')" title="Boyutlandƒ±r (E)">‚ÜïÔ∏è</button>
        </div>
        <div class="tool-group" id="editor-creation-tools">
            <button class="tool-btn" onclick="window.addShape('cube')" title="K√ºp Ekle">üü¶</button>
            <button class="tool-btn" onclick="window.addShape('sphere')" title="K√ºre Ekle">üîµ</button>
            <button class="tool-btn" onclick="window.addShape('spawn')" title="Karakter Doƒüma Alanƒ± Ekle">‚ûï Ba≈ülangƒ±√ß</button>
        </div>
        <div class="tool-group">
            <button class="tool-btn" onclick="window.saveScene()" title="Kaydet">üíæ Kaydet</button>
            <button class="tool-btn" onclick="window.showProjectScreen(auth.currentUser)" title="Y√ºkle / Yeni Proje">üìÇ Projeler</button>
        </div>
        <div id="user-info" style="margin-left: auto;">
            <span id="status">Hazƒ±r.</span>
            <span id="user-email" style="color:#4caf50; margin-left: 15px;"></span>
        </div>
    </div>
    <div id="main-area" style="display: none; flex-direction: row;">
        <div id="viewport">
             <div id="mobile-controls" style="display: none; align-items: flex-end;">
                <div id="joystick-wrapper">
                    <div id="joystick-area">
                        <div id="joystick-handle"></div>
                    </div>
                </div>
                <div id="jump-button" style="margin-left: auto;">^</div>
            </div>
        </div>
        <div id="sidebar-right">
            <div class="panel-section">
                <h4>Hƒ∞YERAR≈ûƒ∞ (NESNELER) üì¶</h4>
                <div id="hierarchy-panel" style="overflow-y: auto; height: 150px; border: 1px solid var(--border-color); padding: 5px;"></div>
            </div>
            <div class="panel-section" id="property-panel" style="margin-top: 20px;">
                <h4>√ñZELLƒ∞KLER</h4>
                <div id="object-info">Se√ßili deƒüil.</div>
            </div>
            <div class="panel-section" id="skybox-panel" style="display:none; margin-top: 20px;">
                <h4>G√ñKY√úZ√ú (SKY) AYARLARI üåÑ</h4>
                <input type="file" id="skybox-upload-file" accept="image/*" style="display: none;" onchange="window.handleSkyboxUpload(this)">
                <button class="start-btn" onclick="document.getElementById('skybox-upload-file').click()" style="width: 100%;">Galeriden K√ºp Doku Y√ºkle</button>
                <button class="start-btn" onclick="window.setSkybox('default_sky')" style="width: 100%; margin-top: 5px; background-color: #3e3e42;">Varsayƒ±lan Renge D√∂n</button>
                
                <div id="skybox-gallery">
                    <div class="skybox-thumbnail" data-sky="default_sky" onclick="window.setSkybox('default_sky')"><span style="color:white; font-weight:bold; position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">RENK</span></div>
                    <div class="skybox-thumbnail" data-sky="ocean_sky" onclick="window.setSkybox('ocean_sky')"><img src="https://via.placeholder.com/100/1e88e5/ffffff?text=Ocean" alt="Okyanus"></div>
                    <div class="skybox-thumbnail" data-sky="star_sky" onclick="window.setSkybox('star_sky')"><img src="https://via.placeholder.com/100/212121/ffffff?text=Star" alt="Yƒ±ldƒ±z"></div>
                </div>
            </div>
            <div class="panel-section" id="script-panel" style="display:none; margin-top: 20px;">
                <h4>LUNX SCRIPT (JS)</h4>
                <textarea id="code-editor" placeholder="// object.rotation.y += 0.01;"></textarea>
                <button class="run-btn start-btn" onclick="window.saveScript()" style="background-color: var(--secondary-color); margin-top: 5px;">‚ö° Kodu Kaydet</button>
                <button class="run-btn start-btn" onclick="window.runSelectedScript()" style="background-color: #f7931e; margin-top: 5px;">‚ñ∂Ô∏è Kodu Test Et</button>
            </div>
        </div>
    </div>
    
    <div id="settings-screen" class="full-screen-container">
        <button class="tool-btn" style="position: absolute; top: 20px; right: 20px; background-color: #c92c2c;" onclick="window.closeSettingsScreen()">‚ùå Kapat</button>
        <div style="display: flex; gap: 40px; align-items: flex-start;">
            <div class="settings-menu" style="width: 200px;">
                <h3>AYARLAR</h3>
                <div class="menu-item active" data-view="profile" onclick="window.showSettingsView('profile')">üë§ Kullanƒ±cƒ± Profili</div>
                <div class="menu-item" data-view="customize" onclick="window.showSettingsView('customize')">üé® Karakter √ñzelle≈ütirme</div>
                <div class="menu-item" data-view="security" onclick="window.showSettingsView('security')">üîí G√ºvenlik</div>
            </div>
            <div id="settings-content" style="flex-grow: 1; max-width: 650px; max-height: 80vh; overflow-y: auto;">
                <div id="settings-view-profile" class="settings-panel" style="width: 100%; display: block; text-align: left;">
                    <h2>Kullanƒ±cƒ± Profili</h2>
                    <input type="text" id="setting-username" oninput="window.updateUserProfile('username', this.value)" placeholder="Kullanƒ±cƒ± Adƒ±">
                    <input type="email" id="setting-email" disabled placeholder="E-posta">
                    <select id="setting-gender" onchange="window.updateUserProfile('gender', this.value)">
                        <option value="male">Erkek (Mavi)</option>
                        <option value="female">Kƒ±z (Pembe)</option>
                    </select>
                </div>
                <div id="settings-view-customize" style="display: none; gap: 20px; width: 100%; height: 600px; justify-content: space-between;">
                    <div class="customize-panel settings-panel" style="width: 300px; text-align: left; padding: 20px;">
                        <h2>Renk Ayarlarƒ±</h2>
                        <div class="color-row"><label>G√∂vde Rengi:</label><input type="color" id="setting-torso-color" onchange="window.updateCustomizationView('torsoColor', this.value)"></div>
                        <div class="color-row"><label>Ayak/Bacak Rengi:</label><input type="color" id="setting-leg-color" onchange="window.updateCustomizationView('legColor', this.value)"></div>
                        <div class="color-row"><label>Ba≈ü Rengi (Ten/Deri):</label><input type="color" id="setting-skin-color" onchange="window.updateCustomizationView('skinColor', this.value)"></div>
                    </div>
                    <div id="customize-viewport" style="width: 350px; height: 100%;"></div>
                    <div class="customize-panel settings-panel" style="width: 300px; text-align: left; padding: 20px;">
                        <h2>Doku Y√ºkleme</h2>
                        <div class="file-upload-container">
                            <label>Kafa Resmi:</label> 
                            <div style="display: flex; align-items: center;">
                                <div id="head-preview" class="custom-preview">Bo≈ü</div>
                                <input type="file" id="head-image-file" accept="image/*" onchange="window.handleImageUpload(this, 'headTexture')" style="display: none;">
                                <button type="button" class="tool-btn upload-btn" onclick="document.getElementById('head-image-file').click()">üñºÔ∏è Y√ºkle</button>
                            </div>
                        </div>
                        <textarea id="head-texture-input" placeholder="Kafa Base64 veya URL..." onchange="window.updateCustomizationView('headTexture', this.value)"></textarea>
                        <div class="file-upload-container" style="margin-top: 20px;">
                            <label>G√∂vde Resmi:</label> 
                            <div style="display: flex; align-items: center;">
                                <div id="torso-preview" class="custom-preview">Bo≈ü</div>
                                <input type="file" id="torso-image-file" accept="image/*" onchange="window.handleImageUpload(this, 'torsoTexture')" style="display: none;">
                                <button type="button" class="tool-btn upload-btn" onclick="document.getElementById('torso-image-file').click()">üëï Y√ºkle</button>
                            </div>
                        </div>
                        <textarea id="torso-texture-input" placeholder="G√∂vde Base64 veya URL..." onchange="window.updateCustomizationView('torsoTexture', this.value)"></textarea>
                    </div>
                </div>
                <div id="settings-view-security" class="settings-panel" style="width: 100%; display: none; text-align: left;">
                    <h2>G√ºvenlik Ayarlarƒ±</h2>
                    <input type="password" id="setting-new-password" placeholder="Yeni ≈üifre (en az 6 karakter)">
                    <button class="start-btn" style="background-color: #c92c2c; width: 100%;" onclick="window.updatePassword()">≈ûifreyi G√ºncelle</button>
                    <p id="security-status" style="color: #4caf50; margin-top: 10px;"></p>
                </div>
            </div>
        </div>
    </div>
    <div id="context-menu" style="display: none; position: fixed; background: #3e3e42; border: 1px solid var(--primary-color); border-radius: 4px; z-index: 9000; padding: 5px;">
        <div class="context-item tool-btn" onclick="window.runSelectedScript()" style="margin-bottom: 5px;">Kodu √áalƒ±≈ütƒ±r</div>
        <div class="context-item tool-btn" onclick="window.deleteSelectedObject()" style="margin-bottom: 5px;">Sil</div>
        <div class="context-item tool-btn" onclick="window.duplicateSelectedObject()">√áoƒüalt</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/CapsuleGeometry.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/WebGL.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/tween.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/objects/Reflector.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        
        // ====================================================================
        // JAVASCRIPT KODU - TAMAMI BURADA Bƒ∞RLE≈ûTƒ∞Rƒ∞LDƒ∞
        // ====================================================================
        
        // --- 1. FIREBASE BA≈ûLATMA VE GLOBAL DEƒûƒ∞≈ûKENLER ---
        
        // **√ñNEMLƒ∞:** Buradaki API Anahtarƒ±nƒ± kendi Firebase projenizinkiyle deƒüi≈ütirin.
        const firebaseConfig = {
          apiKey: "AIzaSyD4Dh_WCxTSqMnJ8u0M4KqwHpejJrEoctk", 
          authDomain: "lunxstudio.firebaseapp.com",
          databaseURL: "https://lunxstudio-default-rtdb.firebaseio.com",
          projectId: "lunxstudio",
          storageBucket: "lunxstudio.firebasestorage.app",
          messagingSenderId: "810358489202",
          appId: "1:810358489202:web:301dbd444bf4608f2782eb",
          measurementId: "G-Y36QNCE71R"
        };
        
        let app, auth, db;
        let scene, camera, renderer, controls, transformControls;
        let objects = []; 
        let selectedObject = null;
        let isSimulationMode = false; 
        
        // YENƒ∞ SKYBOX DEƒûƒ∞≈ûKENƒ∞
        let skyboxMesh = null; 
        let currentSkybox = {
             type: 'color', 
             value: 0x87ceeb // Varsayƒ±lan mavi renk
        }; 
        
        // PLAYER VE ANƒ∞MASYON DEƒûƒ∞≈ûKENLERƒ∞ (G√úNCELLENDƒ∞)
        let player, playerVelocity, playerDirection; 
        const playerHeight = 1.0; 
        let isOnGround = true; 
        const PLAYER_SPEED = 5.0; // Karakter hareket hƒ±zƒ±
        const PLAYER_JUMP_FORCE = 8; // Zƒ±plama g√ºc√º
        
        let playerMixer = null; // Animasyon Karƒ±≈ütƒ±rƒ±cƒ±sƒ±
        let animationActions = {}; // Animasyonlar i√ßin aksiyonlar
        let currentAction = 'idle'; // Varsayƒ±lan animasyon durumu
        const WALK_SPEED_THRESHOLD = 0.05; // Y√ºr√ºme animasyonuna ge√ßi≈ü e≈üiƒüi

        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false; 
        
        let joystickActive = false; 
        let joystickX = 0, joystickY = 0; 
        
        let currentCustomization = {
            username: "", gender: "male", headTexture: "", torsoTexture: "",
            torsoColor: "#007acc", legColor: "#007acc", skinColor: "#f0c0b0"
        };
        
        // Galeriden se√ßilebilecek Skybox dokularƒ± (Placeholder/√ñrnek)
        const skyboxTextures = {
            'ocean_sky': { 
                type: 'cube', 
                value: 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/textures/cube/Bridge2/' 
            },
            'star_sky': { 
                type: 'cube', 
                value: 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/textures/cube/pisa/' 
            },
            'default_sky': { 
                type: 'color', 
                value: 0x87ceeb 
            }
        };

        let customScene, customCamera, customRenderer, customControls, customCharacter;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let authMode = 'login'; 
        const clock = new THREE.Clock(); 

        // --- 2. YARDIMCI FONKSƒ∞YONLAR ---
        
        window.log = (msg) => { console.log(`[LunX] ${msg}`); document.getElementById('status').innerText = msg; }

        window.showError = (msg, elementId = 'auth-error') => { 
            const errDiv = document.getElementById(elementId);
            if (!errDiv) { console.error("Hata elementi bulunamadƒ±: " + elementId); return; }

            let displayMsg = msg;
            if (msg.includes("auth/email-already-in-use")) displayMsg = "Bu e-posta adresi zaten kayƒ±tlƒ±.";
            else if (msg.includes("auth/user-not-found") || msg.includes("auth/wrong-password")) displayMsg = "E-posta veya ≈üifre hatalƒ±.";
            else if (msg.includes("auth/invalid-email")) displayMsg = "Ge√ßersiz e-posta formatƒ±.";
            else if (msg.includes("auth/weak-password")) displayMsg = "≈ûifre en az 6 karakter olmalƒ±dƒ±r.";
            else if (msg.includes("Failed to fetch")) displayMsg = "Baƒülantƒ± Hatasƒ±: ƒ∞nternet baƒülantƒ±nƒ±zƒ± veya Firebase ayarlarƒ±nƒ±zƒ± kontrol edin.";
            else if (msg.includes("auth/requires-recent-login")) displayMsg = "Bu i≈ülem i√ßin tekrar giri≈ü yapmanƒ±z gerekiyor.";
            else if (msg.includes("auth/missing-email")) displayMsg = "L√ºtfen e-posta ve ≈üifreyi girin.";
            else if (msg.includes("KRƒ∞Tƒ∞K HATA:")) displayMsg = msg.replace("KRƒ∞Tƒ∞K HATA: ", "");
            else if (msg.includes("Skybox y√ºkleme hatasƒ±:")) displayMsg = "Skybox y√ºklenirken hata olu≈ütu, varsayƒ±lana d√∂n√ºl√ºyor.";
            else if (msg.includes("Cannot read properties of undefined (reading 'isWebGLAvailable')")) displayMsg = "Three.js k√ºt√ºphanesi tam y√ºklenemedi. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.";


            errDiv.innerText = "Hata: " + displayMsg; 
            errDiv.style.display = 'block';
            errDiv.style.color = '#ff4444';
            errDiv.style.backgroundColor = '#301010';
            window.log("Hata: " + msg);
        }

        window.showSuccess = (msg, elementId = 'security-status') => {
             const successDiv = document.getElementById(elementId);
             successDiv.innerText = msg;
             successDiv.style.color = '#4caf50';
             successDiv.style.backgroundColor = '#103010';
             successDiv.style.display = 'block';
        }

        window.hideAllScreens = () => {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('project-screen').style.display = 'none';
            document.getElementById('toolbar').style.display = 'none';
            document.getElementById('main-area').style.display = 'none';
            document.getElementById('settings-screen').style.display = 'none';
            document.getElementById('auth-error').style.display = 'none'; 
            document.getElementById('security-status').style.display = 'none';
        }

        // --- 3. Y√úKLEME EKRANI Y√ñNETƒ∞Mƒ∞ ---
        
        // K√ºt√ºphanelerin y√ºklenip y√ºklenmediƒüini kontrol eden ana fonskiyon
        const checkLibraries = () => {
             if (typeof firebase === 'undefined') {
                  throw new Error("KRƒ∞Tƒ∞K HATA: Firebase k√ºt√ºphaneleri y√ºklenemedi.");
             }
             if (typeof THREE === 'undefined') {
                  throw new Error("KRƒ∞Tƒ∞K HATA: Three.js k√ºt√ºphanesi y√ºklenemedi.");
             }
             if (!THREE.WEBGL.isWebGLAvailable()) {
                  throw new Error("KRƒ∞Tƒ∞K HATA: Cihazƒ±nƒ±z WebGL'i desteklemiyor.");
             }
        };


        const loadSteps = [
            { name: "K√ºt√ºphane Kontrol√º", duration: 1000, percentage: 30, action: () => {
                return new Promise((resolve, reject) => {
                     // K√ºt√ºphanelerin asenkron y√ºklenmesini beklemek i√ßin bir gecikme ekleyelim
                     setTimeout(() => {
                          try {
                              checkLibraries();
                              resolve();
                          } catch (error) {
                              reject(error);
                          }
                     }, 500); // 500ms bekleme
                });
            }},
            { name: "Firebase Baƒülantƒ±sƒ±", duration: 1500, percentage: 60, action: () => {
                app = firebase.initializeApp(firebaseConfig);
                auth = app.auth(); 
                db = app.database(); 
                if (!auth) throw new Error("Firebase Auth ba≈ülatƒ±lamadƒ±.");
            }},
            { name: "Kullanƒ±cƒ± Durumu Kontrol√º", duration: 1000, percentage: 95, action: async () => {
                return new Promise((resolve) => {
                    const TIMEOUT_MS = 2000; 
                    let resolved = false;

                    const unsubscribe = auth.onAuthStateChanged(user => {
                        if (!resolved) {
                            resolved = true;
                            if (user) {
                                window.fetchAndUpdateUser(user).then(() => window.log("Kullanƒ±cƒ± verisi g√ºncellendi."));
                            }
                            if (unsubscribe) unsubscribe(); 
                            resolve(); 
                        }
                    });

                    setTimeout(() => {
                        if (!resolved) {
                            resolved = true;
                            if (unsubscribe) unsubscribe();
                            window.log("Oturum kontrol√º zaman a≈üƒ±mƒ±na uƒüradƒ±, devam ediliyor.");
                            resolve();
                        }
                    }, TIMEOUT_MS); 
                });
            }},
        ];

        let currentStep = 0;
        let progressValue = 0;
        let loadingInterval = null;

        window.updateProgress = (percentage, text) => {
            progressValue = percentage;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').innerText = `${text} ${percentage.toFixed(0)}%`;
        }

        window.finishLoading = (user) => {
            clearInterval(loadingInterval);
            window.updateProgress(100, "Hazƒ±r.");
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('restart-button').style.display = 'none';

            if (auth.currentUser) {
                window.showProjectScreen(auth.currentUser); 
            } else {
                window.showAuth('login');
            }
        }

        window.failLoading = (error) => {
            clearInterval(loadingInterval);
            window.updateProgress(10, "Y√ºkleme Hatasƒ±!");
            
            const progressTextEl = document.getElementById('progress-text');
            progressTextEl.innerText = "Hata: " + (error.message || "Bilinmeyen Hata."); 
            progressTextEl.style.color = '#ff4444';
            progressTextEl.style.backgroundColor = '#301010'; 
            
            document.getElementById('progress-bar').style.width = '10%';
            document.getElementById('restart-button').style.display = 'block'; 
            window.log("Y√ºkleme ba≈üarƒ±sƒ±z oldu. Yeniden ba≈ülatma bekleniyor.");
            
            // Hata mesajƒ±nƒ± konsola da yaz
            console.error("KRƒ∞Tƒ∞K BA≈ûLATMA HATASI:", error);
        }

        window.restartLoad = () => {
            window.log("Y√ºkleme yeniden ba≈ülatƒ±lƒ±yor...");
            currentStep = 0;
            progressValue = 0;
            clearInterval(loadingInterval);
            
            document.getElementById('restart-button').style.display = 'none';
            const progressTextEl = document.getElementById('progress-text');
            progressTextEl.style.color = 'var(--text-color)';
            progressTextEl.style.backgroundColor = 'transparent';
            
            document.getElementById('loading-screen').style.display = 'flex'; 
            
            loadApplicationStep();
        }

        const loadApplicationStep = async () => {
            if (currentStep >= loadSteps.length) {
                window.finishLoading(auth.currentUser);
                return;
            }

            const step = loadSteps[currentStep];
            const initialProgress = progressValue;
            const targetProgress = step.percentage;
            const duration = step.duration;
            const startTime = Date.now();
            
            window.log(`${step.name} ba≈ülatƒ±lƒ±yor...`);

            loadingInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                let p = (elapsed / duration) * (targetProgress - initialProgress) + initialProgress;
                
                if (p >= targetProgress) {
                    p = targetProgress;
                }
                window.updateProgress(p, step.name);
            }, 50);

            try {
                await step.action();
                
                clearInterval(loadingInterval); 
                progressValue = targetProgress; 
                currentStep++;
                loadApplicationStep(); 
            } catch (error) {
                clearInterval(loadingInterval);
                window.failLoading(error);
            }
        }

        // --- 4. Gƒ∞Rƒ∞≈û / KAYIT Y√ñNETƒ∞Mƒ∞ ---
        
        window.showAuth = (mode) => {
            window.hideAllScreens();
            document.getElementById('auth-screen').style.display = 'flex';
            
            const authTitle = document.getElementById('auth-title');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const authSwitchLink = document.getElementById('auth-switch-link');
            const usernameInput = document.getElementById('auth-username-input'); 
            const initialSettings = document.getElementById('initial-settings'); 

            if (mode === 'register') {
                authMode = 'register';
                authTitle.innerText = "HESAP OLU≈ûTUR";
                authSubmitBtn.innerText = "Kayƒ±t Ol";
                authSwitchLink.innerText = "Bir hesabƒ±n var mƒ±? (Giri≈ü Yap)";
                
                usernameInput.style.display = 'block'; 
                initialSettings.style.display = 'block'; 
            } else { 
                authMode = 'login';
                authTitle.innerText = "Gƒ∞Rƒ∞≈û YAP";
                authSubmitBtn.innerText = "Giri≈ü Yap";
                authSwitchLink.innerText = "Hesabƒ±n yok mu? (Kayƒ±t Ol)";

                usernameInput.style.display = 'none'; 
                initialSettings.style.display = 'none'; 
            }
        }
        
        window.switchAuthMode = () => { window.showAuth(authMode === 'register' ? 'login' : 'register'); }

        window.handleAuthSubmit = async () => {
            if (!auth) { window.showError("Firebase Baƒülantƒ±sƒ± Yok."); return; }
            const email = document.getElementById('auth-email-input').value.trim();
            const pass = document.getElementById('auth-password-input').value.trim();
            document.getElementById('auth-error').style.display = 'none';
            
            if (!email || !pass) { window.showError("L√ºtfen e-posta ve ≈üifreyi girin."); return; }
            
            if (authMode === 'register') {
                const username = document.getElementById('auth-username-input').value.trim();
                const gender = document.querySelector('input[name="gender-auth"]:checked').value;
                if (!username) { window.showError("L√ºtfen bir kullanƒ±cƒ± adƒ± girin."); return; }
                
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                    const user = userCredential.user;
                    const defaultColor = gender === 'male' ? "#007acc" : "#ff4aff";
                    
                    await db.ref('users/' + user.uid).set({
                        email: email, username: username, gender: gender, headTexture: "", torsoTexture: "",
                        torsoColor: defaultColor, legColor: defaultColor, skinColor: "#f0c0b0"
                    });
                    window.log("Kayƒ±t ba≈üarƒ±lƒ±. Oturum a√ßƒ±lƒ±yor...");
                    window.finishLoading(user); 
                } catch (error) { window.showError(error.message); }
            } else {
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, pass);
                    const user = userCredential.user;
                    window.log("Giri≈ü ba≈üarƒ±lƒ±. Y√∂nlendiriliyor...");
                    window.finishLoading(user); 
                } catch (error) { window.showError(error.message); }
            }
        };

        window.logoutUser = async () => { 
            if (!auth) return;
            try {
                await auth.signOut(); 
                window.log("√áƒ±kƒ±≈ü yapƒ±ldƒ±.");
                window.showAuth('login'); 
            } catch (error) {
                window.log("√áƒ±kƒ±≈ü yapma hatasƒ±: " + error.message);
            }
        };

        // --- 5. EKRAN VE MOD Y√ñNETƒ∞Mƒ∞ ---

        window.fetchAndUpdateUser = async (user) => {
            if (!user) return;
            try {
                 const snapshot = await db.ref('users/' + user.uid).once('value');
                 const userData = snapshot.val() || { username: user.email.split('@')[0], gender: 'male', torsoColor: "#007acc", legColor: "#007acc", skinColor: "#f0c0b0" };
            
                currentCustomization = {
                    username: userData.username || user.email.split('@')[0],
                    gender: userData.gender || 'male',
                    headTexture: userData.headTexture || "",
                    torsoTexture: userData.torsoTexture || "",
                    torsoColor: userData.torsoColor || "#007acc",
                    legColor: userData.legColor || "#007acc",
                    skinColor: userData.skinColor || "#f0c0b0"
                };
                
                const userPanel = document.getElementById('project-user-email');
                if (userPanel) {
                     userPanel.innerHTML = `
                         <span style="background-color: ${currentCustomization.gender === 'male' ? '#007acc' : '#ff4aff'}; 
                                      padding: 5px 10px; border-radius: 4px; font-weight: bold; margin-right: 10px;">
                            ${currentCustomization.username.charAt(0).toUpperCase()}
                         </span> 
                         ${currentCustomization.username} (${user.email})
                    `;
                }
            } catch(e) {
                 window.log("Kullanƒ±cƒ± verisi √ßekilemedi: " + e.message);
            }
        }
        
        window.showProjectScreen = (user) => {
            if (!user) { window.showAuth('login'); return; }
            window.fetchAndUpdateUser(user).then(() => {
                window.hideAllScreens();
                document.getElementById('project-screen').style.display = 'flex';
                const userEmailEl = document.getElementById('user-email');
                if (userEmailEl) userEmailEl.innerText = user.email;
            });
        }
        
        // --- 6. AYARLAR VE √ñZELLE≈ûTƒ∞RME FONKSƒ∞YONLARI ---

        window.showSettingsScreen = (initialView) => {
            window.hideAllScreens();
            document.getElementById('settings-screen').style.display = 'flex';
            window.showSettingsView(initialView);
        }

        window.closeSettingsScreen = () => {
            const activeMenuItem = document.querySelector('.settings-menu .menu-item.active');
            const currentView = activeMenuItem ? activeMenuItem.dataset.view : null;

            if (currentView === 'customize' && customRenderer) {
                customRenderer.dispose();
                document.getElementById('customize-viewport').innerHTML = '';
                customScene = null; customCamera = null; customControls = null;
            }
            window.showProjectScreen(auth.currentUser); 
        }

        window.showSettingsView = (viewId) => {
            document.querySelectorAll('.settings-menu .menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewId) item.classList.add('active');
            });
            document.querySelectorAll('#settings-content > div').forEach(div => {
                div.style.display = 'none';
            });
            const targetDiv = document.getElementById(`settings-view-${viewId}`);
            if (targetDiv) targetDiv.style.display = viewId === 'customize' ? 'flex' : 'block';

            if (viewId === 'customize') {
                window.loadCustomizationData();
                window.initCustomization3D();
            } else {
                 if (customRenderer) {
                    customRenderer.dispose();
                    document.getElementById('customize-viewport').innerHTML = '';
                    customScene = null; customCamera = null; customControls = null;
                }
            }
             if (viewId === 'profile') {
                document.getElementById('setting-username').value = currentCustomization.username;
                document.getElementById('setting-email').value = auth.currentUser.email;
                document.getElementById('setting-gender').value = currentCustomization.gender;
            }
            if (viewId === 'security') {
                document.getElementById('security-status').style.display = 'none';
                document.getElementById('setting-new-password').value = '';
            }
        }
        
        window.loadCustomizationData = () => {
            document.getElementById('head-texture-input').value = currentCustomization.headTexture;
            document.getElementById('torso-texture-input').value = currentCustomization.torsoTexture;
            document.getElementById('setting-torso-color').value = currentCustomization.torsoColor;
            document.getElementById('setting-leg-color').value = currentCustomization.legColor;
            document.getElementById('setting-skin-color').value = currentCustomization.skinColor;
            window.updatePreview('headTexture', currentCustomization.headTexture);
            window.updatePreview('torsoTexture', currentCustomization.torsoTexture);
        }

        window.updatePreview = (textureKey, data) => {
            const part = textureKey.toLowerCase().replace('texture', '');
            const preview = document.getElementById(`${part}-preview`);
            if (data && (data.startsWith('data:image/') || data.startsWith('http'))) {
                 preview.style.backgroundImage = `url('${data}')`;
                 preview.innerText = "";
            } else {
                 preview.style.backgroundImage = 'none';
                 preview.innerText = "Bo≈ü";
            }
        }
        
        window.updateCustomizationView = async (key, value) => {
            const user = auth.currentUser;
            if (!user) return;
            currentCustomization[key] = value;
            if (key.includes('Texture')) { window.updatePreview(key, value); }
            window.updateCustomCharacter(); 
            
            // Sim√ºlasyon modunda karakteri anƒ±nda g√ºncelle
            if (player && isSimulationMode) {
                window.updatePlayerModel();
            }
            
            try {
                const update = {};
                update[key] = value;
                await db.ref('users/' + user.uid).update(update);
            } catch (e) { window.log(`Hata: ${key} kaydedilemedi.`); }
        }

        window.updateUserProfile = async (key, value) => {
            const user = auth.currentUser;
            if (!user) return;
            currentCustomization[key] = value;
            
            if (key === 'gender') {
                 const defaultColor = value === 'male' ? "#007acc" : "#ff4aff";
                 currentCustomization.torsoColor = defaultColor;
                 currentCustomization.legColor = defaultColor;
                 
                 document.getElementById('setting-torso-color').value = defaultColor;
                 document.getElementById('setting-leg-color').value = defaultColor;
                 await window.updateCustomizationView('torsoColor', defaultColor);
                 await window.updateCustomizationView('legColor', defaultColor);
            }

            try {
                const update = {};
                update[key] = value;
                await db.ref('users/' + user.uid).update(update);
                window.fetchAndUpdateUser(user); 
                window.showSuccess("Profil bilgisi g√ºncellendi.");
            } catch (e) { window.showError("Profil g√ºncellenemedi.", 'security-status'); }
        }
        
        window.updatePassword = async () => {
             const newPassword = document.getElementById('setting-new-password').value;
             const statusEl = document.getElementById('security-status');
             statusEl.style.display = 'none';
             if (!newPassword || newPassword.length < 6) {
                 window.showError("≈ûifre en az 6 karakter olmalƒ±dƒ±r.", 'security-status'); return;
             }
             try {
                 await auth.currentUser.updatePassword(newPassword);
                 window.showSuccess("≈ûifre ba≈üarƒ±yla g√ºncellendi!", 'security-status');
                 document.getElementById('setting-new-password').value = '';
             } catch (e) {
                 window.showError(e.message, 'security-status');
             }
        }
        
        window.handleImageUpload = (fileInput, textureKey) => {
            const file = fileInput.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024) { 
                 window.showError("G√∂rsel boyutu 1MB'dan k√º√ß√ºk olmalƒ±dƒ±r.", 'security-status'); 
                 fileInput.value = ''; 
                 return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const base64String = event.target.result;
                document.getElementById(`${textureKey.toLowerCase().replace('texture', 'texture')}-input`).value = base64String;
                window.updateCustomizationView(textureKey, base64String);
            };
            
            reader.onerror = (error) => {
                 window.showError("Dosya okuma hatasƒ±: " + error, 'security-status');
            };

            reader.readAsDataURL(file); 
        }

        window.initCustomization3D = () => {
            const viewport = document.getElementById('customize-viewport');
            
            if (customRenderer) { customRenderer.dispose(); viewport.innerHTML = ''; } 

            customScene = new THREE.Scene();
            customCamera = new THREE.PerspectiveCamera(75, viewport.clientWidth / viewport.clientHeight, 0.1, 100);
            customCamera.position.set(0, 2, 3);
            customScene.background = new THREE.Color(0x333333);

            customRenderer = new THREE.WebGLRenderer({ antialias: true });
            customRenderer.setSize(viewport.clientWidth, viewport.clientHeight);
            customRenderer.shadowMap.enabled = true; 
            viewport.appendChild(customRenderer.domElement);

            customControls = new THREE.OrbitControls(customCamera, customRenderer.domElement);
            customControls.enableDamping = true;
            customControls.dampingFactor = 0.05;
            customControls.maxDistance = 6;
            customControls.minDistance = 2;
            customControls.target.set(0, 1, 0);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            customScene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(2, 5, 4);
            dirLight.castShadow = true;
            customScene.add(dirLight);

            const ground = new THREE.Mesh( new THREE.PlaneGeometry(5, 5), new THREE.MeshStandardMaterial({ color: 0x222222 }) );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            customScene.add(ground);

            window.updateCustomCharacter();
            window.animateCustomization();
        }

        window.updateCustomCharacter = () => {
            if (!customScene) return;

            if (customCharacter) { customScene.remove(customCharacter); customCharacter = null; }
            
            customCharacter = window.createBlockCharacter(currentCustomization.gender);
            
            customScene.add(customCharacter);
        }

        window.animateCustomization = () => {
            if (!customRenderer) return; 
            requestAnimationFrame(window.animateCustomization);
            customControls.update(); 
            customRenderer.render(customScene, customCamera);
        }

        window.getTextureMaterial = (textureData, defaultColor) => {
            const color = defaultColor ? new THREE.Color(defaultColor) : new THREE.Color(0xaaaaaa);
            
            if (textureData && (textureData.startsWith('data:image/') || textureData.startsWith('http'))) {
                 try {
                    const loader = new THREE.TextureLoader();
                    const texture = loader.load(textureData);
                    texture.wrapS = THREE.RepeatWrapping;
                    texture.wrapT = THREE.RepeatWrapping;
                    texture.repeat.set(1, 1); 
                    return new THREE.MeshStandardMaterial({ map: texture, side: THREE.DoubleSide }); 
                } catch (e) {
                    console.error("Doku y√ºklenirken hata:", e);
                    return new THREE.MeshStandardMaterial({ color: color }); 
                }
            }
            return new THREE.MeshStandardMaterial({ color: color });
        }
        
        // G√úNCELLENDƒ∞: Animasyona uygun hale getirildi (Kollar/Bacaklar ayrƒ± gruplar i√ßinde)
        window.createBlockCharacter = (gender = 'male') => {
            const group = new THREE.Group();
            
            const finalHeadMat = window.getTextureMaterial(currentCustomization.headTexture, currentCustomization.skinColor);
            const finalTorsoMat = window.getTextureMaterial(currentCustomization.torsoTexture, currentCustomization.torsoColor);
            const finalArmMat = new THREE.MeshStandardMaterial({ color: new THREE.Color(currentCustomization.skinColor) });
            const finalLegMat = new THREE.MeshStandardMaterial({ color: new THREE.Color(currentCustomization.legColor) });
            
            const limbWidth = 0.4;
            const limbHeight = 1.0;
            const headSize = 0.8;
            const torsoHeight = 1.0;

            const head = new THREE.Mesh(new THREE.BoxGeometry(headSize, headSize, headSize), finalHeadMat);
            head.position.y = 1.7; 
            head.name = "Head";
            head.castShadow = true;
            group.add(head);

            const torso = new THREE.Mesh(new THREE.BoxGeometry(0.8, torsoHeight, 0.4), finalTorsoMat);
            torso.position.y = 1.0; 
            torso.name = "Torso";
            torso.castShadow = true;
            group.add(torso);
            
            const createLimb = (isArm, side) => {
                const height = limbHeight;
                const width = limbWidth;
                const mat = isArm ? finalArmMat : finalLegMat;
                const name = (isArm ? (side > 0 ? "RightArm" : "LeftArm") : (side > 0 ? "RightLeg" : "LeftLeg"));
                
                // 1. Kapsayƒ±cƒ± Grubu (D√∂n√º≈ü Merkezi)
                const limbGroup = new THREE.Group();
                
                // 2. Mesh (Grup i√ßinde a≈üaƒüƒ± kaydƒ±rƒ±lmƒ±≈ü)
                const limbMesh = new THREE.Mesh(new THREE.BoxGeometry(width, height, width), mat);
                // √ñNEMLƒ∞: Mesh'i merkezin altƒ±na kaydƒ±r, b√∂ylece rotasyon doƒüru pivot noktasƒ±nda olur (omuz/kal√ßa).
                limbMesh.position.y = -height / 2; 
                limbMesh.castShadow = true;

                limbGroup.add(limbMesh);
                limbGroup.name = name + "Group";
                
                if (isArm) {
                    // Kol ba≈ülangƒ±√ß pozisyonu
                    limbGroup.position.set(side * 0.6, 1.5, 0); 
                } else {
                    // Bacak ba≈ülangƒ±√ß pozisyonu
                    limbGroup.position.set(side * 0.2, 0.5, 0);
                }
                
                return limbGroup;
            };
            
            const rightArm = createLimb(true, 1);
            const leftArm = createLimb(true, -1);
            const rightLeg = createLimb(false, 1);
            const leftLeg = createLimb(false, -1);

            group.add(rightArm, leftArm, rightLeg, leftLeg);
            
            group.position.y = 0.5; 
            
            return group;
        };
        
        // Yeni: Sim√ºlasyon modundayken karakter modelini g√ºncelle
        window.updatePlayerModel = () => {
            if (player) {
                const pos = player.position.clone();
                const rot = player.rotation.clone();
                
                scene.remove(player); 
                
                // Yeni karakteri olu≈ütur
                player = window.createBlockCharacter(currentCustomization.gender);
                
                player.position.copy(pos);
                player.rotation.copy(rot);
                
                scene.add(player); 
                window.log("Oyuncu karakteri g√ºncellendi. Animasyonlar sƒ±fƒ±rlandƒ±.");
                
                // Animasyonlarƒ± sƒ±fƒ±rla ve yeniden ba≈ülat
                window.initPlayerControls(true);
            }
        }

        // --- 7. 3D STUDIO VE Sƒ∞M√úLASYON FONKSƒ∞YONLARI ---
        
        window.onWindowResize = () => {
            const isMobile = window.innerWidth <= 768;
            const mobileControls = document.getElementById('mobile-controls');

            if (renderer && camera) {
                const viewport = document.getElementById('viewport');
                const width = viewport.clientWidth;
                const height = viewport.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
            if (customRenderer && customCamera) {
                const viewport = document.getElementById('customize-viewport');
                customCamera.aspect = viewport.clientWidth / viewport.clientHeight;
                customCamera.updateProjectionMatrix();
                customRenderer.setSize(viewport.clientWidth, viewport.clientHeight);
            }
            
            // Mobile Controls g√ºncellemeleri
            if (mobileControls) {
                if (isMobile && isSimulationMode) {
                    mobileControls.style.display = 'flex';
                    mobileControls.classList.add('active');
                } else {
                    mobileControls.style.display = 'none';
                    mobileControls.classList.remove('active');
                }
            }
            
            // Sim√ºlasyon modunda kontrolleri doƒüru ayarla
            if (isSimulationMode) {
                 if (controls) controls.enabled = false;
                 if (transformControls) transformControls.enabled = false;
            } else {
                 if (controls) controls.enabled = !isMobile;
                 if (transformControls) transformControls.enabled = !isMobile;
            }

        }
        
        // 3D SAHNE ƒ∞LK BA≈ûLATMA
        window.initFullScene = () => {
            window.log("3D Sahne (initFullScene) ba≈ülatƒ±lƒ±yor...");
            const viewport = document.getElementById('viewport');
            
            try {
                checkLibraries(); // Tekrar kontrol

                scene = new THREE.Scene();
                
                camera = new THREE.PerspectiveCamera(75, viewport.clientWidth / viewport.clientHeight, 0.1, 1000);
                camera.position.set(5, 5, 5);
                
                scene.add(new THREE.AmbientLight(0xffffff, 0.5));
                
                const dirLight = new THREE.DirectionalLight(0xffffff, 1.5); 
                dirLight.position.set(10, 15, 10);
                dirLight.castShadow = true;
                dirLight.shadow.mapSize.width = 2048; 
                dirLight.shadow.mapSize.height = 2048; 
                dirLight.shadow.camera.near = 0.5;
                dirLight.shadow.camera.far = 50;
                dirLight.shadow.camera.left = -20;
                dirLight.shadow.camera.right = 20;
                dirLight.shadow.camera.top = 20;
                dirLight.shadow.camera.bottom = -20;
                scene.add(dirLight);

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(viewport.clientWidth, viewport.clientHeight);
                renderer.shadowMap.enabled = true; 
                renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
                
                if (viewport.children.length > 0) {
                     const existingCanvas = viewport.querySelector('canvas');
                     if (existingCanvas) viewport.removeChild(existingCanvas);
                }
                viewport.appendChild(renderer.domElement);
                
                window.log("Renderer ve Canvas eklendi.");
                
            } catch(e) {
                 window.showError(`Renderer Ba≈ülatma Hatasƒ±: ${e.message}`, 'status');
                 return;
            }

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 0, 0);
            
            transformControls = new THREE.TransformControls(camera, renderer.domElement);
            transformControls.addEventListener('change', () => renderer.render(scene, camera));
            scene.add(transformControls);
            transformControls.addEventListener('mouseUp', () => { window.updateSelectedObjectProperty(); });

            // Kontrol olaylarƒ±nƒ± sadece bir kere ekle
            document.removeEventListener('keydown', window.onKeyDown, false);
            document.removeEventListener('keyup', window.onKeyUp, false);
            document.removeEventListener('mousedown', window.onMouseDown, false);
            window.removeEventListener('resize', window.onWindowResize, false);
            
            document.addEventListener('keydown', window.onKeyDown, false);
            document.addEventListener('keyup', window.onKeyUp, false);
            document.addEventListener('mousedown', window.onMouseDown, false);
            document.addEventListener('contextmenu', (e) => e.preventDefault()); 
            window.addEventListener('resize', window.onWindowResize, false);
            
            window.onWindowResize(); 
            window.log("3D Sahne Hazƒ±r ve Kontroller kuruldu.");
        }

        // YENƒ∞: Skybox D√ºzeltmesi ve Ayarlamasƒ±
        window.setSkybox = (skyKey, customBase64 = null) => {
            let skyConfig;

            if (customBase64) {
                 window.showError("Base64 y√ºkleme, 6 ayrƒ± y√ºz resmi gerektirir. √ñrnek dokular veya URL kullanƒ±n.", 'status');
                 skyKey = 'default_sky';
                 skyConfig = skyboxTextures[skyKey];
                 document.getElementById('skybox-upload-file').value = '';
            } else {
                 skyConfig = skyboxTextures[skyKey] || skyboxTextures['default_sky'];
            }

            currentSkybox.type = skyConfig.type;
            currentSkybox.value = skyConfig.value;
            
            if (skyConfig.type === 'color') {
                scene.background = new THREE.Color(skyConfig.value);
            } else if (skyConfig.type === 'cube') {
                 const loader = new THREE.CubeTextureLoader();
                 loader.setPath(skyConfig.value); 

                 const textureUrls = [ 'px.jpg', 'nx.jpg', 'py.jpg', 'ny.jpg', 'pz.jpg', 'nz.jpg' ];
                 
                 const cubeTexture = loader.load(textureUrls, () => {
                     // Y√ºkleme ba≈üarƒ±lƒ±
                     scene.background = cubeTexture;
                     window.log(`G√∂ky√ºz√º temasƒ± ${skyKey} olarak ayarlandƒ±.`);
                 }, undefined, (err) => {
                    // Y√ºkleme hatasƒ±
                    console.error("Skybox y√ºkleme hatasƒ±:", err);
                    window.showError("Skybox y√ºklenirken hata olu≈ütu, varsayƒ±lana d√∂n√ºl√ºyor.", 'status');
                    window.setSkybox('default_sky');
                 });
            }
            
            const skyObject = objects.find(obj => obj.name === "G√∂ky√ºz√º");
            if (skyObject) {
                 skyObject.userData.skyboxKey = skyKey;
            }
            
            if (skyConfig.type === 'color') {
                window.log(`G√∂ky√ºz√º temasƒ± ${skyKey} olarak ayarlandƒ± (Renk).`);
            }
            window.updateSkyboxPanel(skyKey);
            window.updateSelectedObjectProperty();
        }
        
        window.updateSkyboxPanel = (selectedKey) => {
             document.querySelectorAll('.skybox-thumbnail').forEach(thumb => {
                 thumb.classList.remove('selected');
                 if (thumb.dataset.sky === selectedKey) {
                      thumb.classList.add('selected');
                 }
             });
        }
        
        window.handleSkyboxUpload = (fileInput) => {
             // Tek bir resim y√ºklemesi i√ßin kƒ±sƒ±t (CubeTextureLoader 6 resim ister)
             window.showError("Tek bir resim y√ºklenmesi ≈üu an i√ßin sadece renk olarak uygulanabilir. Skybox i√ßin 6 y√ºzey gereklidir. L√ºtfen galeriden se√ßin.", 'status');
             fileInput.value = '';
        }
        
        window.setupEnvironment = (env) => {
            window.clearScene(false);
            
            let skyObject = objects.find(obj => obj.name === "G√∂ky√ºz√º");
            
            if (!skyObject) {
                skyObject = new THREE.Object3D(); 
                skyObject.name = "G√∂ky√ºz√º";
                skyObject.userData.isEnvironment = true;
                skyObject.userData.isSkybox = true;
                skyObject.userData.skyboxKey = 'default_sky';
                objects.push(skyObject);
            }
            
            window.setSkybox(skyObject.userData.skyboxKey); 

            if (env === 'default_template' || env === 'simple_cube' || env === 'empty') {
                // Zemin ve Grid'i sadece empty template deƒüilse ekle
                if (env !== 'empty') {
                    const plane = new THREE.Mesh(new THREE.PlaneGeometry(50, 50), new THREE.MeshStandardMaterial({ color: 0x444444, side: THREE.DoubleSide }));
                    plane.rotation.x = -Math.PI / 2;
                    plane.receiveShadow = true;
                    plane.name = "Zemin";
                    plane.userData.isEnvironment = true;
                    scene.add(plane);
                    objects.push(plane);
                    
                    const gridHelper = new THREE.GridHelper(50, 50, 0x888888, 0x444444);
                    gridHelper.name = "Grid";
                    gridHelper.userData.isEnvironment = true;
                    scene.add(gridHelper);
                }
                
                // Ba≈ülangƒ±√ß noktasƒ±nƒ± her zaman ekle (Karakterin nerede doƒüacaƒüƒ±nƒ± bilmek i√ßin)
                const spawnMesh = window.createSpawnPointMesh(new THREE.Vector3(0, 0.05, 0));
                scene.add(spawnMesh);
                objects.push(spawnMesh);
                
                if (env === 'simple_cube') {
                    window.addShape('cube', { position: { x: 0, y: 0.5, z: 0 }, name: "K√ºp_1" });
                }
            }
        }
        
        window.createSpawnPointMesh = (position) => {
            const spawnGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.1, 32);
            const spawnMat = new THREE.MeshBasicMaterial({ color: 0x2da042, transparent: true, opacity: 0.5 });
            const spawnMesh = new THREE.Mesh(spawnGeo, spawnMat);
            spawnMesh.name = "OyuncuBa≈ülangƒ±√ßNoktasƒ±";
            spawnMesh.position.copy(position);
            spawnMesh.userData.isSpawnPoint = true;
            spawnMesh.userData.isEnvironment = false; 
            return spawnMesh;
        }

        window.startStudio = (isNew = false) => {
            if (!renderer) {
                 window.initFullScene();
            }
            
            if (!renderer) {
                 window.log("3D Renderer olu≈üturulamadƒ±ƒüƒ± i√ßin Studio ba≈ülatƒ±lamƒ±yor.");
                 return; 
            }
            
            window.hideAllScreens();
            document.getElementById('toolbar').style.display = 'flex';
            document.getElementById('main-area').style.display = 'flex';
            
            if (isNew) {
                const template = document.getElementById('template-select').value;
                window.setupEnvironment(template);
            } else if (objects.length === 0) {
                 window.setupEnvironment('default_template');
            }
            
            window.animate(); 
            window.onWindowResize(); 
            window.updateHierarchyList();
            window.log("LunX Studio ba≈üarƒ±yla ba≈ülatƒ±ldƒ±.");
        }
        
        window.setTool = (mode) => {
            if (isSimulationMode) return;
            transformControls.mode = mode;
            document.querySelectorAll('#editor-tools .tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tool-${mode}`).classList.add('active');
            window.log(`Ara√ß: ${mode.toUpperCase()} se√ßildi.`);
        }
        
        window.addShape = (type, existingData = null) => {
            let geometry, material;
            let name = existingData ? existingData.name : `${type}_${objects.length + 1}`;
            
            switch (type) {
                case 'cube':
                    geometry = new THREE.BoxGeometry(1, 1, 1);
                    material = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
                    break;
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.5, 32, 32);
                    material = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
                    break;
                case 'spawn':
                    const spawnMesh = window.createSpawnPointMesh(new THREE.Vector3(0, 0.05, 0));
                    spawnMesh.position.set(existingData ? existingData.position.x : 0, existingData ? existingData.position.y : 0.05, existingData ? existingData.position.z : 0);
                    spawnMesh.name = name; // ƒ∞sim bilgisini koru
                    scene.add(spawnMesh);
                    objects.push(spawnMesh);
                    window.updateHierarchyList();
                    window.log("Ba≈ülangƒ±√ß noktasƒ± eklendi.");
                    return;
                default:
                    return;
            }
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.name = name;
            mesh.userData.script = existingData ? existingData.script : '';
            
            if (existingData) {
                mesh.position.set(existingData.position.x, existingData.position.y, existingData.position.z);
                mesh.rotation.set(existingData.rotation.x, existingData.rotation.y, existingData.rotation.z);
                mesh.scale.set(existingData.scale.x, existingData.scale.y, existingData.scale.z);
                if (existingData.color) mesh.material.color.set(existingData.color);
            } else {
                mesh.position.y = 0.5;
            }
            
            scene.add(mesh);
            objects.push(mesh);
            window.updateHierarchyList();
            window.log(`${name} eklendi.`);
            window.selectObject(mesh);
        }
        
        window.clearScene = (showConfirm = true) => {
            if (showConfirm && !confirm("Mevcut sahne temizlensin mi? Kayƒ±tlƒ± olmayan veriler silinecektir.")) return;
            
            if (isSimulationMode) window.stopSimulation();

            transformControls.detach();
            // Skybox'ƒ± da temizle
            window.setSkybox('default_sky'); 

            objects.forEach(obj => scene.remove(obj));
            objects = [];
            
            selectedObject = null;
            window.updateHierarchyList();
            window.selectObject(null);
            window.log("Sahne temizlendi.");
        }
        
        window.saveScene = async () => {
            if (!auth.currentUser) { window.showError("Kaydetmek i√ßin oturum a√ßmalƒ±sƒ±nƒ±z."); return; }
            
            const sceneData = objects.map(obj => {
                let type;
                if (obj.userData.isSkybox) {
                    type = 'sky';
                } else if (obj.userData.isSpawnPoint) {
                    type = 'spawn';
                } else if (obj.geometry) {
                    type = obj.geometry.type.replace('Geometry', '').toLowerCase();
                } else {
                    return null; 
                }

                if (type === 'sky') {
                    return {
                        name: obj.name,
                        type: type,
                        skyboxKey: obj.userData.skyboxKey || 'default_sky'
                    };
                }
                
                // Oyuncu ba≈ülangƒ±√ß noktasƒ± i√ßin material/color kaydetmeye gerek yok
                if (type === 'spawn') {
                    return {
                        name: obj.name,
                        type: type,
                        position: obj.position.toJSON(),
                    }
                }

                return {
                    name: obj.name,
                    type: type,
                    position: obj.position.toJSON(),
                    rotation: obj.rotation.toJSON(),
                    scale: obj.scale.toJSON(),
                    color: obj.material && obj.material.color ? `#${obj.material.color.getHexString()}` : '#ffffff',
                    script: obj.userData.script || ''
                };
            }).filter(data => data !== null && data.name !== "Zemin" && data.name !== "Grid"); // Zemin ve Grid'i kaydetmeyi atla
            
            try {
                await db.ref('users/' + auth.currentUser.uid + '/scene').set(sceneData);
                window.log("Sahne verisi Firebase'e ba≈üarƒ±yla kaydedildi! üíæ");
            } catch (e) {
                window.log("Kaydetme hatasƒ±: " + e.message);
            }
        }
        
        window.loadScene = async () => {
            if (!auth.currentUser) { window.showError("Y√ºklemek i√ßin oturum a√ßmalƒ±sƒ±nƒ±z."); return; }
            
            try {
                const snapshot = await db.ref('users/' + auth.currentUser.uid + '/scene').once('value');
                const sceneData = snapshot.val();
                
                window.clearScene(false);
                window.startStudio(false); 
                
                const objectsToRecreate = [];
                let skyboxKeyToSet = 'default_sky';

                if (sceneData) {
                    sceneData.forEach(data => {
                        if (data.type === 'sky') {
                            skyboxKeyToSet = data.skyboxKey || 'default_sky';
                        } else {
                            objectsToRecreate.push(data);
                        }
                    });
                    
                    // √ñnce varsayƒ±lan ortamƒ± kur
                    window.setupEnvironment('default_template');
                    
                    // Ardƒ±ndan skybox'ƒ± ayarla
                    const skyObject = window.objects.find(obj => obj.name === "G√∂ky√ºz√º");
                    if (skyObject) {
                        skyObject.userData.skyboxKey = skyboxKeyToSet;
                    }
                    window.setSkybox(skyboxKeyToSet);
                    
                    // Sonra diƒüer nesneleri y√ºkle
                    objectsToRecreate.forEach(data => {
                        if (data.type === 'spawn' || data.type === 'cube' || data.type === 'sphere') {
                             // Zemin ve Grid'i yeniden olu≈üturmayƒ± engellemek i√ßin, sadece spawn, cube, sphere y√ºkle
                             if (data.name !== "Zemin" && data.name !== "Grid") {
                                 window.addShape(data.type, data);
                             }
                        }
                    });
                    
                    // Hierarchy'yi yeniden g√ºncelle
                    window.updateHierarchyList();
                    
                    window.log("Kayƒ±tlƒ± sahne ba≈üarƒ±yla y√ºklendi! üìÇ");
                } else {
                    window.log("Kayƒ±tlƒ± sahne verisi bulunamadƒ±. Varsayƒ±lan ≈üablon y√ºklendi.");
                    window.setupEnvironment('default_template');
                }
            } catch (e) {
                window.log("Y√ºkleme hatasƒ±: " + e.message);
                window.setupEnvironment('default_template');
            }
        }
        
        window.selectObject = (obj) => {
            if (selectedObject) {
                if (!selectedObject.userData.isSpawnPoint && !selectedObject.userData.isEnvironment && selectedObject.material && selectedObject.material.color) {
                    if (selectedObject.userData.originalColor) {
                        selectedObject.material.color.set(selectedObject.userData.originalColor);
                    }
                }
            }
            
            selectedObject = obj;
            
            const skyPanel = document.getElementById('skybox-panel');
            const scriptPanel = document.getElementById('script-panel');
            
            skyPanel.style.display = 'none';
            scriptPanel.style.display = 'none';

            if (obj) {
                 if (obj.userData.isSkybox) {
                    transformControls.detach();
                    skyPanel.style.display = 'block';
                    window.updateSkyboxPanel(obj.userData.skyboxKey);
                } else if (obj.userData.isEnvironment && obj.name !== "OyuncuBa≈ülangƒ±√ßNoktasƒ±") {
                     transformControls.detach();
                } else {
                    transformControls.attach(obj);
                    if (!obj.userData.isSpawnPoint && !obj.userData.isEnvironment) {
                        scriptPanel.style.display = 'block';
                        document.getElementById('code-editor').value = obj.userData.script || '';
                    } else if (obj.userData.isSpawnPoint) {
                        transformControls.mode = 'translate';
                    }
                }
                
                if (!obj.userData.isSkybox && !obj.userData.isEnvironment && !obj.userData.isSpawnPoint && obj.material && obj.material.color) {
                    if (!obj.userData.originalColor) {
                         obj.userData.originalColor = obj.material.color.getHex();
                    }
                    obj.material.color.set(0x00ff00); // Se√ßili nesneyi ye≈üil yap
                }
            } else {
                transformControls.detach();
            }
            
            window.updateSelectedObjectProperty();
            window.updateHierarchyList();
        }

        window.updateHierarchyList = () => {
            const panel = document.getElementById('hierarchy-panel');
            if (!panel) return;
            panel.innerHTML = '';
            
            objects.forEach(obj => {
                const div = document.createElement('div');
                div.className = 'hierarchy-item' + (obj === selectedObject ? ' selected' : '');
                
                let icon = 'üì¶';
                if (obj.userData.isSkybox) icon = 'üåå';
                else if (obj.userData.isSpawnPoint) icon = 'üë∂';
                else if (obj.userData.isEnvironment) icon = 'üåê';
                
                div.innerText = `${icon} ${obj.name}`;
                div.onclick = () => window.selectObject(obj);
                panel.appendChild(div);
            });
        }
        
        window.showContextMenu = (x, y) => {
            const menu = document.getElementById('context-menu');
            
            if (selectedObject && (selectedObject.userData.isEnvironment || selectedObject.userData.isSkybox)) {
                 menu.style.display = 'none';
                 return;
            }

            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';
        }
        
        window.runSelectedScript = () => {
             if (selectedObject && selectedObject.userData.script) {
                try {
                    const func = new Function('object', selectedObject.userData.script);
                    func(selectedObject);
                    window.log(`${selectedObject.name} kodu √ßalƒ±≈ütƒ±rƒ±ldƒ±.`);
                    window.updateSelectedObjectProperty();
                } catch (e) {
                    window.log(`Kod √ßalƒ±≈ütƒ±rma hatasƒ±: ${e.message}`);
                }
            }
        }
        
        window.deleteSelectedObject = () => {
            if (selectedObject && !selectedObject.userData.isEnvironment && !selectedObject.userData.isSkybox) {
                scene.remove(selectedObject);
                transformControls.detach();
                
                const index = objects.indexOf(selectedObject);
                if (index > -1) {
                    objects.splice(index, 1);
                }
                
                window.selectObject(null);
                window.log(`${selectedObject.name} silindi.`);
                window.updateHierarchyList();
            }
        }
        
        window.duplicateSelectedObject = () => {
            if (selectedObject && !selectedObject.userData.isSpawnPoint && !selectedObject.userData.isEnvironment && !selectedObject.userData.isSkybox) {
                const newObj = selectedObject.clone();
                newObj.name = selectedObject.name + "_Kopya";
                newObj.position.x += 1;
                scene.add(newObj);
                objects.push(newObj);
                window.selectObject(newObj);
                window.log(`${newObj.name} √ßoƒüaltƒ±ldƒ±.`);
            }
        }
        
        window.onKeyDown = (event) => {
            if (isSimulationMode) {
                switch (event.code) {
                    case 'KeyW': moveForward = true; break;
                    case 'KeyS': moveBackward = true; break;
                    case 'KeyA': moveLeft = true; break;
                    case 'KeyD': moveRight = true; break;
                    case 'Space': 
                        if (isOnGround) { 
                            playerVelocity.y = PLAYER_JUMP_FORCE; 
                            isOnGround = false; 
                        } 
                        break; 
                }
            } else {
                 switch (event.code) {
                    case 'KeyW': window.setTool('translate'); break;
                    case 'KeyS': window.setTool('select'); break; 
                    case 'KeyQ': window.setTool('rotate'); break;
                    case 'KeyE': window.setTool('scale'); break;
                    case 'Delete': window.deleteSelectedObject(); break;
                 }
            }
        }

        window.onKeyUp = (event) => {
            if (isSimulationMode) {
                switch (event.code) {
                    case 'KeyW': moveForward = false; break;
                    case 'KeyS': moveBackward = false; break;
                    case 'KeyA': moveLeft = false; break;
                    case 'KeyD': moveRight = false; break;
                }
            }
        }
        
        window.onMouseDown = (event) => {
            document.getElementById('context-menu').style.display = 'none';
            if (event.button === 2) { 
                if (selectedObject && !isSimulationMode) window.showContextMenu(event.clientX, event.clientY);
                event.preventDefault(); 
                return;
            }

            if (transformControls.dragging) return;
            if (event.target !== renderer.domElement || isSimulationMode) return;

            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objects, true);

            if (intersects.length > 0) {
                let hitObject = intersects[0].object;
                
                while (hitObject.parent !== scene && hitObject.parent) {
                    hitObject = hitObject.parent; 
                }
                
                if (hitObject && objects.includes(hitObject)) {
                    window.selectObject(hitObject);
                } else {
                    window.selectObject(null);
                }
            } else {
                window.selectObject(null);
            }
        }

        window.updateSelectedObjectProperty = (property, value) => {
            const infoPanel = document.getElementById('object-info');
            if (!infoPanel) return;
            if (!selectedObject) { infoPanel.innerHTML = 'Se√ßili deƒüil.'; return; }
            if (selectedObject.userData.isSkybox) { 
                infoPanel.innerHTML = `<strong>${selectedObject.name}</strong> <br> Skybox Durumu: <strong>${selectedObject.userData.skyboxKey}</strong>`; 
                return; 
            }
            if (selectedObject.userData.isEnvironment) { infoPanel.innerHTML = `<strong>${selectedObject.name}</strong> - Ortam Nesnesi`; return; }


            if (property && selectedObject) {
                const [category, prop] = property.split('.');
                if (category === 'position') selectedObject.position[prop] = parseFloat(value);
                else if (category === 'rotation') selectedObject.rotation[prop] = parseFloat(value);
                else if (category === 'scale') selectedObject.scale[prop] = parseFloat(value);
            }

            infoPanel.innerHTML = `
                <strong>${selectedObject.name}</strong> <br><br>
                <div class="prop-row"><span>Pozisyon X:</span> <input type="number" step="0.1" value="${selectedObject.position.x.toFixed(2)}" onchange="window.updateSelectedObjectProperty('position.x', this.value)"></div>
                <div class="prop-row"><span>Pozisyon Y:</span> <input type="number" step="0.1" value="${selectedObject.position.y.toFixed(2)}" onchange="window.updateSelectedObjectProperty('position.y', this.value)"></div>
                <div class="prop-row"><span>Pozisyon Z:</span> <input type="number" step="0.1" value="${selectedObject.position.z.toFixed(2)}" onchange="window.updateSelectedObjectProperty('position.z', this.value)"></div>
                
                <div class="prop-row"><span>D√∂n√º≈ü X:</span> <input type="number" step="0.1" value="${selectedObject.rotation.x.toFixed(2)}" onchange="window.updateSelectedObjectProperty('rotation.x', this.value)"></div>
                <div class="prop-row"><span>D√∂n√º≈ü Y:</span> <input type="number" step="0.1" value="${selectedObject.rotation.y.toFixed(2)}" onchange="window.updateSelectedObjectProperty('rotation.y', this.value)"></div>
                <div class="prop-row"><span>D√∂n√º≈ü Z:</span> <input type="number" step="0.1" value="${selectedObject.rotation.z.toFixed(2)}" onchange="window.updateSelectedObjectProperty('rotation.z', this.value)"></div>
                
                <div class="prop-row"><span>√ñl√ßek X:</span> <input type="number" step="0.1" value="${selectedObject.scale.x.toFixed(2)}" onchange="window.updateSelectedObjectProperty('scale.x', this.value)"></div>
                <div class="prop-row"><span>√ñl√ßek Y:</span> <input type="number" step="0.1" value="${selectedObject.scale.y.toFixed(2)}" onchange="window.updateSelectedObjectProperty('scale.y', this.value)"></div>
                <div class="prop-row"><span>√ñl√ßek Z:</span> <input type="number" step="0.1" value="${selectedObject.scale.z.toFixed(2)}" onchange="window.updateSelectedObjectProperty('scale.z', this.value)"></div>
            `;
            if (renderer) renderer.render(scene, camera);
        }

        window.saveScript = () => {
            if (selectedObject) {
                selectedObject.userData.script = document.getElementById('code-editor').value;
                window.log(`${selectedObject.name} scripti kaydedildi.`);
            }
        }
        
        window.applyScript = (object, codeText) => {
            try {
                const func = new Function('object', codeText);
                func(object);
            } catch (e) {}
        }
        
        // G√úNCELLENDƒ∞: Animasyon ba≈ülatma mantƒ±ƒüƒ± eklendi
        window.setAnimation = (name) => {
            if (currentAction === name || !animationActions[name]) return;

            const newAction = animationActions[name];
            const oldAction = animationActions[currentAction];
            
            newAction.enabled = true;
            newAction.setEffectiveTimeScale(1);
            newAction.setEffectiveWeight(1);
            
            oldAction.fadeOut(0.2); // Yumu≈üak ge√ßi≈ü s√ºresi
            newAction.fadeIn(0.2); 
            
            newAction.play();
            currentAction = name;
        }

        // G√úNCELLENDƒ∞: Animasyon kurulumu ve player'ƒ±n sahneye eklenmesi
        window.initPlayerControls = (isUpdate = false) => {
            playerVelocity = new THREE.Vector3(0, 0, 0);
            playerDirection = new THREE.Vector3(0, 0, 0);
            
            const spawnPoint = objects.find(obj => obj.userData.isSpawnPoint);
            let startPos = spawnPoint ? spawnPoint.position.clone() : new THREE.Vector3(0, 1.5, 0); 
            
            if (!isUpdate) {
                if (player) { scene.remove(player); } 
                player = window.createBlockCharacter(currentCustomization.gender);
                player.position.copy(startPos);
                player.position.y = startPos.y + playerHeight * 0.5; 
                scene.add(player);
            }

            // --- YENƒ∞: Animasyon Ba≈ülatma ---
            playerMixer = new THREE.AnimationMixer(player);
            animationActions = {};
            currentAction = 'idle';
            
            const rightArm = player.getObjectByName("RightArmGroup");
            const leftArm = player.getObjectByName("LeftArmGroup");
            const rightLeg = player.getObjectByName("RightLegGroup");
            const leftLeg = player.getObjectByName("LeftLegGroup");
            
            if (rightArm && leftArm && rightLeg && leftLeg) {
                // Y√ºr√ºme Animasyonu (Walk)
                const walkClip = new THREE.AnimationClip('walk', -1, [
                    new THREE.KeyframeTrack(`${rightArm.name}.rotation[x]`, [0, 0.5, 1], [0, Math.PI * 0.3, 0]),
                    new THREE.KeyframeTrack(`${leftArm.name}.rotation[x]`, [0, 0.5, 1], [0, -Math.PI * 0.3, 0]),
                    new THREE.KeyframeTrack(`${rightLeg.name}.rotation[x]`, [0, 0.5, 1], [0, -Math.PI * 0.3, 0]),
                    new THREE.KeyframeTrack(`${leftLeg.name}.rotation[x]`, [0, 0.5, 1], [0, Math.PI * 0.3, 0]),
                ]);
                animationActions['walk'] = playerMixer.clipAction(walkClip);
                animationActions['walk'].loop = THREE.LoopRepeat;
                animationActions['walk'].timeScale = 1.5; // Daha hƒ±zlƒ± y√ºr√ºme
                
                // Durma Animasyonu (Idle) - Kollarƒ± hafif√ße sallama
                const idleClip = new THREE.AnimationClip('idle', -1, [
                    new THREE.KeyframeTrack(`${rightArm.name}.rotation[x]`, [0, 1], [0, 0.05]),
                    new THREE.KeyframeTrack(`${leftArm.name}.rotation[x]`, [0, 1], [0, -0.05]),
                ]);
                animationActions['idle'] = playerMixer.clipAction(idleClip);
                animationActions['idle'].loop = THREE.LoopPingPong;
                animationActions['idle'].timeScale = 0.5;
                
                // Zƒ±plama Animasyonu (Jump) - Basit bir poz (kollar yukarƒ±)
                 const jumpClip = new THREE.AnimationClip('jump', 0.5, [
                    new THREE.KeyframeTrack(`${rightArm.name}.rotation[x]`, [0, 0.25], [0, -Math.PI * 0.2]),
                    new THREE.KeyframeTrack(`${leftArm.name}.rotation[x]`, [0, 0.25], [0, Math.PI * 0.2]),
                ]);
                animationActions['jump'] = playerMixer.clipAction(jumpClip);
                animationActions['jump'].loop = THREE.LoopOnce;
                animationActions['jump'].clampWhenFinished = true;
            } else {
                window.log("UYARI: Animasyon i√ßin gerekli kollar/bacaklar bulunamadƒ±.");
            }
            
            window.setAnimation('idle'); // Ba≈ülangƒ±√ß animasyonunu ayarla
            // --- Animasyon Ba≈ülatma Sonu ---

            // Kamera pozisyonunu oyuncudan biraz geriye ve yukarƒ±ya ayarla (Third Person)
            camera.position.set(player.position.x - 3, player.position.y + 2, player.position.z - 3);
            controls.target.copy(player.position);
            controls.update();

            isOnGround = true; 
            window.initMobileControls();
        }

        window.initMobileControls = () => {
            const isMobile = window.innerWidth <= 768;
            const mobileControls = document.getElementById('mobile-controls');
            
            // √ñnceki ayarlarƒ± temizle
            const joystickArea = document.getElementById('joystick-area');
            const jumpButton = document.getElementById('jump-button');

            // Olay dinleyicilerini temizle (Birden fazla √ßaƒürƒ±lmamasƒ± i√ßin)
            if (window.joystickStartHandler) {
                joystickArea.removeEventListener('mousedown', window.joystickStartHandler);
                joystickArea.removeEventListener('touchstart', window.joystickStartHandler);
            }
            if (window.jumpClickHandler) {
                 jumpButton.removeEventListener('click', window.jumpClickHandler);
                 jumpButton.removeEventListener('touchstart', window.jumpClickHandler);
            }
            
            if (!isMobile) {
                mobileControls.style.display = 'none';
                return;
            }

            mobileControls.style.display = isSimulationMode ? 'flex' : 'none';
            if (isSimulationMode) mobileControls.classList.add('active'); else mobileControls.classList.remove('active');
            
            const joystickHandle = document.getElementById('joystick-handle');
            
            // Zƒ±plama Butonu i√ßin yeni handler
            window.jumpClickHandler = (e) => {
                 e.preventDefault();
                 if (isSimulationMode && isOnGround) { 
                     playerVelocity.y = PLAYER_JUMP_FORCE; 
                     isOnGround = false; 
                 }
            };
            jumpButton.addEventListener('click', window.jumpClickHandler);
            jumpButton.addEventListener('touchstart', window.jumpClickHandler, { passive: false });

            // Joystick i√ßin yeni handler
            window.joystickStartHandler = (e) => {
                e.preventDefault();
                joystickActive = true;
                
                const touch = e.touches ? e.touches[0] : e;
                const rect = joystickArea.getBoundingClientRect();
                
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const maxDistance = rect.width / 2;
                const handleSizeHalf = 20;

                const updateJoystick = (cClientX, cClientY) => {
                    let dx = cClientX - centerX;
                    let dy = cClientY - centerY;
                    
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance > maxDistance) {
                        dx = (dx / distance) * maxDistance;
                        dy = (dy / distance) * maxDistance;
                    }

                    joystickHandle.style.left = `${dx + maxDistance - handleSizeHalf}px`; 
                    joystickHandle.style.top = `${dy + maxDistance - handleSizeHalf}px`;

                    joystickX = dx / maxDistance; 
                    joystickY = dy / maxDistance; 
                    
                    return (moveEvent) => {
                        moveEvent.preventDefault();
                        const moveTouch = moveEvent.touches ? moveEvent.touches[0] : moveEvent;
                        
                        // Mobil cihazlarda dokunma pozisyonunu kullan
                        const moveClientX = moveTouch.clientX;
                        const moveClientY = moveTouch.clientY;
                        
                        const newDx = moveClientX - centerX;
                        const newDy = moveClientY - centerY;
                        const newDistance = Math.sqrt(newDx * newDx + newDy * newDy);
                        
                        let finalDx = newDx;
                        let finalDy = newDy;
                        
                        if (newDistance > maxDistance) {
                            finalDx = (newDx / newDistance) * maxDistance;
                            finalDy = (newDy / newDistance) * maxDistance;
                        }
                        
                        joystickHandle.style.left = `${finalDx + maxDistance - handleSizeHalf}px`;
                        joystickHandle.style.top = `${finalDy + maxDistance - handleSizeHalf}px`;
                        
                        joystickX = finalDx / maxDistance;
                        joystickY = finalDy / maxDistance;
                    };
                };

                let moveListener = updateJoystick(touch.clientX, touch.clientY);
                const handleMove = (e) => moveListener(e);
                
                const handleEnd = (e) => {
                    joystickActive = false;
                    joystickX = 0;
                    joystickY = 0;
                    joystickHandle.style.left = '30px'; 
                    joystickHandle.style.top = '30px'; 
                    
                    document.removeEventListener('mousemove', handleMove);
                    document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchmove', handleMove);
                    document.removeEventListener('touchend', handleEnd);
                };

                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleEnd);
                joystickArea.addEventListener('touchmove', handleMove, { passive: false });
                joystickArea.addEventListener('touchend', handleEnd);
            };

            joystickArea.addEventListener('mousedown', window.joystickStartHandler);
            joystickArea.addEventListener('touchstart', window.joystickStartHandler, { passive: false });
        }


        
        window.startSimulation = () => {
            window.initPlayerControls(false); 
            document.getElementById('editor-tools').style.display = 'none';
            document.getElementById('editor-creation-tools').style.display = 'none';
            document.getElementById('sidebar-right').style.display = 'none';
            document.getElementById('play-button').classList.remove('active');
            document.getElementById('stop-button').classList.add('active');
            window.onWindowResize(); 
            window.log("Sim√ºlasyon Modu: AKTƒ∞F");
        }

        window.stopSimulation = () => {
            if (player) {
                scene.remove(player);
                player = null;
                playerMixer = null; 
            }
            document.getElementById('editor-tools').style.display = 'flex';
            document.getElementById('editor-creation-tools').style.display = 'flex';
            document.getElementById('sidebar-right').style.display = 'block';
            document.getElementById('play-button').classList.add('active');
            document.getElementById('stop-button').classList.remove('active');
            window.onWindowResize(); 
            window.log("Sim√ºlasyon Modu: PASƒ∞F");
        }

        window.toggleSimulationMode = async (enable) => {
            if (!auth.currentUser) {
                window.showError("Sim√ºlasyonu ba≈ülatmak i√ßin giri≈ü yapmanƒ±z gerekiyor.");
                return;
            }

            if (!renderer) {
                 window.showError("3D Sahne ba≈ülatƒ±lmadƒ±. L√ºtfen Studio'yu yeniden ba≈ülatmayƒ± deneyin.", 'status');
                 return;
            }

            isSimulationMode = enable;
            transformControls.detach();
            
            if (enable) {
                await window.fetchAndUpdateUser(auth.currentUser); 
                window.startSimulation();
            } else {
                window.stopSimulation(); 
                window.setTool('select');
            }
             window.onWindowResize(); // Kontrollerin durumunu g√ºncelle
        }


        // G√úNCELLENDƒ∞: Animasyon ve Third Person Kamera Takibi eklendi
        window.updatePlayer = (delta) => {
            if (!player) return;
            
            const GRAVITY = 9.8 * 2; 
            
            // Animasyon karƒ±≈ütƒ±rƒ±cƒ±sƒ±nƒ± g√ºncelle
            if (playerMixer) playerMixer.update(delta);
            
            playerDirection.z = 0;
            playerDirection.x = 0;

            let inputX = 0;
            let inputZ = 0;

            if (joystickActive) {
                inputX = joystickX;
                inputZ = -joystickY; // Mobil joystick'te Y ters olabilir.
            } else {
                if (moveForward) inputZ += 1;
                if (moveBackward) inputZ -= 1;
                if (moveLeft) inputX -= 1;
                if (moveRight) inputX += 1;
            }
            
            if (inputX !== 0 || inputZ !== 0) {
                playerDirection.x = inputX;
                playerDirection.z = inputZ;
                playerDirection.normalize(); 
            }
            
            const cameraDirection = new THREE.Vector3();
            camera.getWorldDirection(cameraDirection);
            cameraDirection.y = 0; 
            cameraDirection.normalize();

            const right = new THREE.Vector3().crossVectors(cameraDirection, new THREE.Vector3(0, 1, 0));
            
            const moveVector = new THREE.Vector3();
            moveVector.addScaledVector(cameraDirection, playerDirection.z); 
            moveVector.addScaledVector(right, playerDirection.x); 
            moveVector.normalize();

            // Yatay hƒ±z
            playerVelocity.x = moveVector.x * PLAYER_SPEED;
            playerVelocity.z = moveVector.z * PLAYER_SPEED;
            
            // --- Animasyon Kontrol√º ---
            const isMoving = playerDirection.lengthSq() > WALK_SPEED_THRESHOLD;
            
            if (isOnGround) {
                if (isMoving) {
                    window.setAnimation('walk');
                } else {
                    window.setAnimation('idle');
                }
            } else {
                if (playerVelocity.y < 0) {
                    // Yere inerken zƒ±plama animasyonunu sabit tut
                     if (currentAction !== 'jump') window.setAnimation('jump');
                }
            }
            // --- Animasyon Kontrol√º Sonu ---

            // Karakteri d√∂nd√ºrme (sadece hareket varsa)
            if (moveVector.lengthSq() > 0.01) {
                const targetRotation = Math.atan2(moveVector.x, moveVector.z);
                
                // Yumu≈üak d√∂n√º≈ü
                let rotationDifference = targetRotation - player.rotation.y;
                const TWO_PI = Math.PI * 2;
                if (rotationDifference > Math.PI) rotationDifference -= TWO_PI;
                if (rotationDifference < -Math.PI) rotationDifference += TWO_PI;
                player.rotation.y += rotationDifference * 0.15; 
            } else {
                // Hareket yoksa yatay hƒ±z sƒ±fƒ±rlanƒ±r
                playerVelocity.x = 0;
                playerVelocity.z = 0;
            }

            // Yer√ßekimi ve D√º≈üme
            if (!isOnGround) {
                playerVelocity.y -= GRAVITY * delta;
            } else {
                playerVelocity.y = 0;
            }
            
            const newY = player.position.y + playerVelocity.y * delta;
            
            // Basit √ßarpƒ±≈üma (Y ekseni zemin)
            if (newY < playerHeight * 0.5) { 
                playerVelocity.y = 0;
                player.position.y = playerHeight * 0.5;
                if (!isOnGround) {
                     isOnGround = true;
                     window.setAnimation(isMoving ? 'walk' : 'idle'); // Yere indiƒüinde animasyonu d√ºzelt
                }
            } else {
                player.position.y = newY;
                isOnGround = false;
            }
            
            // Zƒ±plama tu≈üuna basƒ±ldƒ±ƒüƒ±nda animasyonu ayarla (zƒ±plama kuvveti uygulandƒ±ysa)
            if (playerVelocity.y > 0.1 && currentAction !== 'jump') {
                 window.setAnimation('jump');
            }


            player.position.x += playerVelocity.x * delta;
            player.position.z += playerVelocity.z * delta;

            // Kamera takibi (Third Person Takip)
            // ƒ∞deal offset: Oyuncunun arkasƒ±nda, hafif yukarƒ±, kameranƒ±n baktƒ±ƒüƒ± y√∂ne g√∂re.
            const idealOffset = new THREE.Vector3(-3, 2, -3); 
            idealOffset.applyQuaternion(controls.object.quaternion); // Mevcut kamera rotasyonunu uygula
            idealOffset.add(player.position);

            const idealLookat = new THREE.Vector3(0, playerHeight * 0.8, 0); // Karakterin kafasƒ±na odaklan
            idealLookat.add(player.position);
            
            // Kamerayƒ± yumu≈üak bir ≈üekilde takip et
            camera.position.lerp(idealOffset, 0.1); 
            controls.target.lerp(idealLookat, 0.1); 
            
            controls.update(); 
        }

        window.animate = () => {
            if (!renderer) return;

            requestAnimationFrame(window.animate);
            
            const delta = clock.getDelta();

            if (!isSimulationMode) {
                // D√ºzenleme Modu
                const isMobile = window.innerWidth <= 768;
                controls.enabled = !isMobile;
                if (controls.enabled) controls.update(); 
                if (transformControls) transformControls.update();
            } else {
                // Sim√ºlasyon Modu
                controls.enabled = true; // Third person kamera i√ßin kontrolleri a√ßƒ±k bƒ±rak
                controls.enablePan = false; // Kaydƒ±rmayƒ± kapat
                controls.enableZoom = false; // Zoom'u kapat (isteƒüe baƒülƒ±)
                controls.maxDistance = 6; // Kameranƒ±n ne kadar uzakta olabileceƒüi
                controls.minDistance = 2; // Kameranƒ±n ne kadar yakƒ±nda olabileceƒüi
                
                window.updatePlayer(delta);
                
                objects.forEach(obj => {
                    if (obj.userData.script) {
                        window.applyScript(obj, obj.userData.script);
                    }
                });
            }

            renderer.render(scene, camera);
        }
        
        // --- Ba≈ülatma ---
        window.onload = loadApplicationStep;
    </script>
</body>
</html>
