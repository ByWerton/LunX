<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio V12.0 - UI Fix & AI Core</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

    <style>
        :root {
            --bg-app: #eef0f3;
            --bg-ribbon: #ffffff;
            --bg-panel: #ffffff;
            --border: #d1d1d1;
            --text-main: #333;
            --accent: #ff3333;
            --accent-hover: #fff0f0;
            --toolbar-height: 100px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; }
        body { 
            margin: 0; 
            overflow: hidden; 
            background: var(--bg-app); 
            color: var(--text-main); 
            height: 100vh; 
            width: 100vw; /* Tam Ekran */
        }

        /* --- UI SCALE FIX: T√ºm i√ßeriƒüi √∂l√ßekler --- */
        #studio-container { 
            height: 100vh; 
            width: 100vw; 
            display: flex; 
            flex-direction: column; 
            transform-origin: top left; 
            transition: transform 0.2s;
            position: absolute; /* √ñl√ßeklenme i√ßin mutlak konum */
        }

        /* --- TOP BAR (YATAY SEKMELER) --- */
        #top-bar {
            height: 30px; background: var(--accent); color: white; display: flex; align-items: center; padding: 0 10px; font-size: 12px;
        }
        #tab-container { display: flex; height: 100%; }
        .tab-btn {
            padding: 0 15px; height: 100%; display: flex; align-items: center; cursor: pointer;
            border-right: 1px solid rgba(255,255,255,0.2); transition: 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.2); }
        .tab-btn.active { background: var(--bg-ribbon); color: #333; font-weight: bold; border-top: 3px solid transparent; border-bottom: 1px solid var(--bg-ribbon); }

        /* RIBBON ARA√áLARI */
        #ribbon {
            height: var(--toolbar-height); background: var(--bg-ribbon); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 5px 10px; overflow-x: auto; gap: 10px;
        }
        .tool-section { display: none; gap: 5px; height: 100%; align-items: center; }
        .tool-section.active { display: flex; }
        
        .ribbon-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 55px; height: 80px; border: 1px solid transparent; border-radius: 4px;
            cursor: pointer; transition: 0.2s; color: #444;
        }
        .ribbon-btn:hover { background: var(--accent-hover); border-color: #ffcccc; }
        .ribbon-btn.active { background: #ffe6e6; border-color: var(--accent); }
        .ribbon-btn span { font-size: 22px; margin-bottom: 5px; }
        .ribbon-btn label { font-size: 11px; text-align: center; }

        /* --- ANA D√úZEN --- */
        #main-layout { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        /* TOOLBOX & SAƒû PANEL (Gizleme CSS'i) */
        #toolbox, #right-panel {
            z-index: 10; background: var(--bg-panel); border: 1px solid var(--border); transition: transform 0.3s;
        }
        #toolbox { width: 220px; border-right: none; }
        #right-panel { width: 280px; border-left: none; }
        #toolbox.closed { transform: translateX(-100%); }
        #right-panel.closed { transform: translateX(100%); }

        .panel-head { padding: 8px; background: #f5f5f5; font-weight: bold; font-size: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        
        /* --- X MENU (ORTADAN GELEN) --- */
        #x-menu-btn { 
            position: absolute; top: calc(30px + 10px); left: 10px; width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); color: white; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 200;
        }
        #x-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        #x-overlay.active { display: flex; }
        #x-panel {
            width: 90%; max-width: 700px; height: auto; background: rgba(255, 255, 255, 0.95);
            border-radius: 15px; padding: 25px; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(0.8) translateY(100vh); /* Ba≈ülangƒ±√ßta k√º√ß√ºk ve altta */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Yaylƒ± Efekt */
        }
        #x-overlay.active #x-panel { transform: scale(1) translateY(0); }
        
        .x-btn { width: 100%; padding: 12px; margin: 5px 0; background: #eee; border: none; border-radius: 8px; text-align: left; font-size: 16px; cursor: pointer; }
        .x-btn:hover { background: #ddd; }
        
        /* OYUN KONTROLLERƒ∞ */
        #game-hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 100; }
        #joystick-area { position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joystick-knob { width: 50px; height: 50px; background: white; border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transform: translate(0,0); }
        #jump-btn { position: absolute; bottom: 80px; right: 40px; width: 80px; height: 80px; background: rgba(255,50,50,0.8); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; border: 3px solid white; cursor: pointer; }
        #interact-btn { position: absolute; bottom: 180px; right: 40px; width: 60px; height: 60px; background: #ffff00; border-radius: 50%; pointer-events: auto; display: none; align-items: center; justify-content: center; font-size: 24px; border: 3px solid #000; cursor: pointer; }

        /* Gƒ∞ZLƒ∞ INPUTLAR */
        #obj-input, #tex-input { display: none; }
    </style>
</head>
<body onload="LunX.init()">
    <div id="studio-container">
        <div id="top-bar">
            <div style="font-weight:bold; margin-right:20px;">LunX Studio</div>
            <div id="tab-container">
                <div class="tab-btn active" onclick="UI.setTab('home')">Home</div>
                <div class="tab-btn" onclick="UI.setTab('model')">Model</div>
                <div class="tab-btn" onclick="UI.setTab('terrain')">Terrain</div>
                <div class="tab-btn" onclick="UI.setTab('view')">View</div>
                <div class="tab-btn" onclick="UI.setTab('ai')">‚ú® AI Core</div>
            </div>
        </div>
        
        <div id="ribbon">
            <div id="sec-home" class="tool-section active">
                <div class="ribbon-btn" id="tool-select" onclick="Tools.setMode('select')"><span>üëÜ</span><label>Se√ß</label></div>
                <div class="ribbon-btn" id="tool-translate" onclick="Tools.setMode('translate')"><span>‚ÜîÔ∏è</span><label>Ta≈üƒ±</label></div>
                <div class="ribbon-btn" id="tool-scale" onclick="Tools.setMode('scale')"><span>‚§¢</span><label>Boyut</label></div>
                <div class="ribbon-btn" id="tool-rotate" onclick="Tools.setMode('rotate')"><span>üîÑ</span><label>D√∂nd√ºr</label></div>
                <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
                <div class="ribbon-btn" onclick="Tools.toggleAnchor()"><span>‚öì</span><label>Anchor</label></div>
                <div class="ribbon-btn" onclick="Tools.deleteObject()"><span>üóëÔ∏è</span><label>Sil</label></div>
                <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
                <div class="ribbon-btn" onclick="Game.play()"><span style="color:green">‚ñ∂Ô∏è</span><label>Oyna</label></div>
                <div class="ribbon-btn" onclick="Game.stop()"><span style="color:red">‚èπÔ∏è</span><label>Durdur</label></div>
            </div>
            
            <div id="sec-model" class="tool-section">
                <div class="ribbon-btn" onclick="World.add('box')"><span>üì¶</span><label>Part</label></div>
                <div class="ribbon-btn" onclick="World.add('sphere')"><span>‚ö™</span><label>Sphere</label></div>
                <div class="ribbon-btn" onclick="World.add('cylinder')"><span>üõ¢Ô∏è</span><label>Cyl</label></div>
                <div class="ribbon-btn" onclick="World.add('wedge')"><span>üìê</span><label>Wedge</label></div>
                <div style="width:1px; height:60%; background:#ccc; margin:0 5px;"></div>
                <div class="ribbon-btn" onclick="World.importOBJ()"><span>üìÇ</span><label>OBJ Y√ºkle</label></div>
                <div class="ribbon-btn" onclick="World.add('spawn')"><span>üö©</span><label>Spawn</label></div>
                <div class="ribbon-btn" onclick="World.add('light')"><span>üí°</span><label>I≈üƒ±k</label></div>
                <div class="ribbon-btn" onclick="World.add('neon')"><span>‚ú®</span><label>Neon</label></div>
                <div class="ribbon-btn" onclick="World.add('damage')"><span>üíÄ</span><label>Hasar</label></div>
            </div>
            
            <div id="sec-terrain" class="tool-section">
                <div class="ribbon-btn" onclick="alert('Terrain Sculpting Mode: Active')"><span>‚õ∞Ô∏è</span><label>Sculpt</label></div>
                <div class="ribbon-btn" onclick="World.setSky('day')"><span>‚òÄÔ∏è</span><label>G√ºnd√ºz</label></div>
                <div class="ribbon-btn" onclick="World.setSky('night')"><span>üåô</span><label>Gece</label></div>
            </div>

            <div id="sec-view" class="tool-section">
                <div class="ribbon-btn" onclick="UI.toggle('toolbox')"><span>üß∞</span><label>Toolbox</label></div>
                <div class="ribbon-btn" onclick="UI.toggle('right-panel')"><span>üìù</span><label>Props</label></div>
            </div>

            <div id="sec-ai" class="tool-section">
                <div class="ribbon-btn" style="width:100px; border:2px solid gold; background:#fffbe6;" onclick="AI.prompt()">
                    <span>ü§ñ</span><label>AI Core Prompt</label>
                </div>
            </div>
        </div>

        <div id="x-menu-btn" onclick="UI.openXMenu()">‚öôÔ∏è</div>

        <div id="x-overlay" onclick="if(event.target==this) UI.closeXMenu()">
            <div id="x-panel">
                <h2 style="margin:0 0 20px 0; color:#333;">LunX Studio Ayarlar & Men√º</h2>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:250px;">
                        <button class="x-btn" onclick="App.reset()">üîÅ Projeyi Sƒ±fƒ±rla</button>
                        <button class="x-btn" onclick="alert('Kaydedildi!')">üíæ Projeyi Kaydet (Sim√ºlasyon)</button>
                    </div>
                    <div style="flex:1; min-width:250px;">
                        <label style="margin-top:10px; font-weight:bold;">Aray√ºz √ñl√ßeƒüi (UI Scale)</label>
                        <input type="range" min="0.8" max="1.2" step="0.05" value="1" style="width:100%" onchange="UI.setScale(this.value)">
                        
                        <label style="margin-top:10px; font-weight:bold;">Grafik Kalitesi (1-15)</label>
                        <input type="range" min="0.5" max="2" step="0.1" value="1" style="width:100%" onchange="App.setQuality(this.value)">
                    </div>
                </div>
                <button class="x-btn" style="margin-top:20px; background:#ffcccc; color:red;" onclick="UI.closeXMenu()">Kapat</button>
            </div>
        </div>

        <div id="main-layout">
            
            <div id="toolbox">
                <div class="panel-head">Toolbox <span style="cursor:pointer" onclick="UI.toggle('toolbox')">‚úï</span></div>
                <div id="toolbox-content" style="overflow-y:auto; padding:5px;">
                    </div>
            </div>

            <div id="viewport">
                <div id="game-hud">
                    <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px;">
                        <div style="width:150px; height:15px; background:#333; border:1px solid white;">
                            <div id="hp-bar" style="width:100%; height:100%; background:#00ff00;"></div>
                        </div>
                    </div>
                    
                    <div id="joystick-area"><div id="joystick-knob"></div></div>
                    <div id="jump-btn">‚¨Ü</div>
                    <div id="interact-btn">üöó</div> </div>
            </div>

            <div id="right-panel">
                <div class="split-v" style="border-bottom:1px solid #ccc; flex:1;">
                    <div class="panel-head">Explorer</div>
                    <div id="explorer" style="padding:5px; font-size:12px; overflow-y:auto; flex:1;"></div>
                </div>
                <div class="split-v" style="flex:1;">
                    <div class="panel-head">Properties</div>
                    <div id="prop-content" style="padding:5px; overflow-y:auto;"></div>
                </div>
            </div>

        </div>

        <input type="file" id="obj-input" accept=".obj">
        <input type="file" id="tex-input" accept="image/*">
    </div>

    <script>
        /**
         * LunX Studio V12.0 - Final UI/Physics/AI Integration
         * D√ºzeltmeler: UI Scale Fix, Men√º/3D Sahne G√∂r√ºn√ºrl√ºƒü√º
         */
        
        const LunX = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            objects: [], selected: null, isPlaying: false,
            
            player: null,
            vehicle: null, 
            health: 100,
            
            joy: { x:0, y:0, active:false },
            
            init: () => {
                ThreeEngine.init();
                UI.initToolbox();
                
                // Men√ºlerin g√∂r√ºnd√ºƒü√ºnden emin olmak i√ßin varsayƒ±lan durumu ayarla
                document.getElementById('studio-container').style.display = 'flex';
                document.getElementById('top-bar').style.display = 'flex';
                document.getElementById('ribbon').style.display = 'flex';

                window.addEventListener('resize', ThreeEngine.resize);

                // Joystick & Controls
                const joy = document.getElementById('joystick-area');
                joy.addEventListener('touchstart', Game.joyStart, {passive:false});
                joy.addEventListener('touchmove', Game.joyMove, {passive:false});
                joy.addEventListener('touchend', Game.joyEnd);
                
                document.getElementById('jump-btn').addEventListener('touchstart', Game.jump);
                document.getElementById('jump-btn').addEventListener('mousedown', Game.jump);
                
                document.getElementById('interact-btn').addEventListener('click', Game.exitVehicle);

                document.getElementById('tex-input').addEventListener('change', World.onTextureUpload);
                document.getElementById('obj-input').addEventListener('change', World.onOBJUpload);
            }
        };

        const ThreeEngine = {
            init: () => {
                const vp = document.getElementById('viewport');
                LunX.scene = new THREE.Scene();
                LunX.scene.background = new THREE.Color(0x87CEEB);
                LunX.scene.fog = new THREE.Fog(0x87CEEB, 50, 500);

                LunX.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 2000);
                LunX.camera.position.set(15, 15, 15);

                LunX.renderer = new THREE.WebGLRenderer({ antialias: true });
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
                LunX.renderer.shadowMap.enabled = true;
                vp.appendChild(LunX.renderer.domElement);

                // Lights
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                LunX.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 1);
                dir.position.set(50, 100, 50);
                dir.castShadow = true;
                dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
                LunX.scene.add(dir);

                // Controls
                LunX.controls = new THREE.OrbitControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform = new THREE.TransformControls(LunX.camera, LunX.renderer.domElement);
                LunX.transform.addEventListener('dragging-changed', e => LunX.controls.enabled = !e.value);
                LunX.transform.addEventListener('change', UI.updateProps); 
                LunX.scene.add(LunX.transform);

                // Raycaster
                vp.addEventListener('mousedown', Tools.onSelect);
                vp.addEventListener('touchstart', Tools.onSelect, {passive:false});

                World.add('baseplate');

                ThreeEngine.loop();
            },
            resize: () => {
                const vp = document.getElementById('viewport');
                LunX.camera.aspect = vp.clientWidth / vp.clientHeight;
                LunX.camera.updateProjectionMatrix();
                LunX.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },
            loop: () => {
                requestAnimationFrame(ThreeEngine.loop);
                if(LunX.isPlaying) Game.update();
                else LunX.controls.update();
                LunX.renderer.render(LunX.scene, LunX.camera);
            }
        };

        // --- WORLD, TOOLS, AI, GAME, UI, APP Objects are kept from V11.0 to ensure functionality ---

        const World = {
            add: (type, opts={}) => {
                let geo, mat = new THREE.MeshStandardMaterial({color: opts.color || Math.random()*0xffffff});
                
                if(type==='baseplate') {
                    geo = new THREE.BoxGeometry(500, 1, 500);
                    mat.color.setHex(0x555555);
                } else if(type==='sphere') geo = new THREE.SphereGeometry(2,32,32);
                else if(type==='cylinder') geo = new THREE.CylinderGeometry(2,2,4,32);
                else if(type==='wedge') geo = new THREE.ConeGeometry(2,4,4);
                else geo = new THREE.BoxGeometry(4,4,4);

                if(type === 'neon') mat = new THREE.MeshBasicMaterial({color:0x00ffff, emissive:0x00ffff});
                if(type === 'damage') { mat.color.setHex(0xff0000); opts.damage = 10; }

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(opts.pos || new THREE.Vector3(0, 10, 0));
                if(type==='baseplate') { mesh.position.y = -0.5; mesh.name="Baseplate"; mesh.userData.locked=true; }
                else mesh.name = opts.name || "Part";

                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.userData = { 
                    anchored: type==='baseplate' || type==='light' || type==='spawn',
                    canCollide: true,
                    damage: opts.damage || 0,
                    velocity: new THREE.Vector3(),
                    type: type
                };

                if(type==='spawn') {
                    mesh.scale.set(2, 0.1, 2); mesh.material.color.setHex(0xaaaaaa); mesh.name="SpawnLocation";
                }
                if(type==='light') {
                    const l = new THREE.PointLight(0xffaa00, 1, 20); mesh.add(l); mesh.material.emissive.setHex(0xffaa00); mesh.name="PointLight";
                }

                LunX.scene.add(mesh);
                LunX.objects.push(mesh);
                UI.refreshExplorer();
                return mesh;
            },
            addSpecial: (type) => { 
                if(type==='neon') World.add('neon');
                if(type==='damage') World.add('damage');
                if(type==='light') World.add('light');
            },

            importOBJ: () => document.getElementById('obj-input').click(),
            onOBJUpload: (e) => { /* OBJ Loader Logic */ },

            uploadTexture: () => document.getElementById('tex-input').click(),
            onTextureUpload: (e) => {
                if(!LunX.selected) return alert("√ñnce bir par√ßa se√ßin!");
                const file = e.target.files[0];
                if(file) {
                    const url = URL.createObjectURL(file);
                    new THREE.TextureLoader().load(url, (tex) => {
                        LunX.selected.material.map = tex;
                        LunX.selected.material.needsUpdate = true;
                    });
                }
            },
            setSky: (time) => {
                LunX.scene.background = new THREE.Color(time==='day' ? 0x87CEEB : 0x000022);
                LunX.scene.fog.color = LunX.scene.background;
            }
        };

        const Tools = {
            onSelect: (e) => {
                if(LunX.isPlaying) return;
                e.preventDefault();
                
                const rect = LunX.renderer.domElement.getBoundingClientRect();
                const x = ((e.clientX || e.touches[0].clientX) - rect.left) / rect.width * 2 - 1;
                const y = -((e.clientY || e.touches[0].clientY) - rect.top) / rect.height * 2 + 1;
                
                const ray = new THREE.Raycaster();
                ray.setFromCamera({x,y}, LunX.camera);
                const hits = ray.intersectObjects(LunX.objects, true);
                
                if(hits.length > 0) {
                    LunX.selected = hits[0].object;
                    while(LunX.selected.parent && LunX.selected.parent !== LunX.scene && LunX.selected.parent.userData.isAI) {
                        LunX.selected = LunX.selected.parent;
                    }
                    
                    if(!LunX.selected.userData.locked) LunX.transform.attach(LunX.selected);
                    else LunX.transform.detach();
                } else {
                    LunX.selected = null;
                    LunX.transform.detach();
                }
                UI.updateProps();
                UI.refreshExplorer();
            },
            setMode: (m) => {
                LunX.transform.detach();
                if(m!=='select') {
                    LunX.transform.setMode(m);
                    if(LunX.selected) LunX.transform.attach(LunX.selected);
                }
                document.querySelectorAll('.ribbon-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('tool-'+m).classList.add('active');
            },
            toggleAnchor: () => {
                if(LunX.selected && !LunX.selected.userData.locked) {
                    LunX.selected.userData.anchored = !LunX.selected.userData.anchored;
                    UI.updateProps();
                }
            },
            deleteObject: () => {
                if(LunX.selected && !LunX.selected.userData.locked) {
                    LunX.scene.remove(LunX.selected);
                    LunX.transform.detach();
                    LunX.objects = LunX.objects.filter(o => o !== LunX.selected);
                    LunX.selected = null;
                    UI.refreshExplorer();
                    UI.updateProps();
                }
            }
        };

        const AI = {
            prompt: () => {
                const req = prompt("‚ú® AI Core: Ne in≈üa etmek istersin? (√ñrn: 'u√ßak', 'tank', 'SpawnLocation y√ºr√ºme kodu ekle')");
                if(!req) return;
                
                const text = req.toLowerCase().trim();
                
                if(text.includes("kodu ekle")) {
                    const parts = text.split(" ");
                    const objName = parts.slice(0, parts.indexOf("kodu")).join(" ");
                    AI.addScriptTo(objName, text);
                    return;
                }
                
                if(text.includes("u√ßak") || text.includes("plane")) {
                    AI.buildPlane();
                } else if(text.includes("araba") || text.includes("car")) {
                    AI.buildCar();
                } else if(text.includes("ev") || text.includes("house")) {
                    AI.buildHouse();
                } else if(text.includes("kule") || text.includes("tower")) {
                    AI.buildTower();
                } else {
                    alert("AI: Bu isteƒüi i≈ülemek i√ßin yeterli parametrik bilgiye sahip deƒüilim. Yeni model olu≈üturma denemesi ba≈üarƒ±sƒ±z oldu.");
                }
            },

            buildPlane: () => {
                const group = new THREE.Group(); group.name = "AI_Plane";
                
                const body = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 15), new THREE.MeshStandardMaterial({color: 0xcccccc}));
                const wing = new THREE.Mesh(new THREE.BoxGeometry(18, 0.5, 3), new THREE.MeshStandardMaterial({color: 0x999999}));
                wing.position.z = 2;

                group.add(body, wing);
                
                group.position.set(0, 30, 0);
                group.userData = { 
                    isVehicle: true, 
                    isFlying: true, 
                    anchored: false,
                    velocity: new THREE.Vector3(), 
                    rotSpeed: 0,
                    thrust: 0.1,
                    isAI: true 
                };
                
                LunX.scene.add(group);
                LunX.objects.push(group);
                alert("AI: Jet U√ßaƒüƒ± Olu≈üturuldu! Oyna modunda binebilirsin.");
            },
            
            buildCar: () => { 
                const group = new THREE.Group(); group.name = "AI_Car";
                const body = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 8), new THREE.MeshStandardMaterial({color:0xff0000}));
                body.position.y = 1;
                group.add(body);
                
                const wheels = [ {x:-2.2, z:2.5}, {x:2.2, z:2.5}, {x:-2.2, z:-2.5}, {x:2.2, z:-2.5} ];
                wheels.forEach(pos => {
                    const w = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.5, 16), new THREE.MeshStandardMaterial({color:0x222222}));
                    w.rotation.z = Math.PI/2; w.position.set(pos.x, 0.8, pos.z);
                    group.add(w);
                });
                
                group.position.set(10, 5, 10);
                group.userData = { isVehicle: true, anchored: false, velocity: new THREE.Vector3(), isAI: true };
                
                LunX.scene.add(group);
                LunX.objects.push(group);
                alert("AI: Araba Olu≈üturuldu! Oyna modunda binebilirsin.");
            },
            
            buildHouse: () => {
                const h = new THREE.Group(); h.name = "AI_House";
                const wallMat = new THREE.MeshStandardMaterial({color: 0xddccaa});
                const roofMat = new THREE.MeshStandardMaterial({color: 0x884444});
                
                const box = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), wallMat); box.position.y = 4;
                const roof = new THREE.Mesh(new THREE.ConeGeometry(9, 4, 4), roofMat); 
                roof.position.y = 10; roof.rotation.y = Math.PI/4;
                
                h.add(box); h.add(roof);
                h.position.set(-10, 0, -10);
                h.userData = { anchored: true, isAI: true };
                
                LunX.scene.add(h);
                LunX.objects.push(h);
            },
            
            buildTower: () => {
                const group = new THREE.Group(); group.name = "AI_Tower";
                const mat = new THREE.MeshStandardMaterial({color: 0x9999aa});
                for(let i=0; i<15; i++) {
                    const block = new THREE.Mesh(new THREE.BoxGeometry(5, 2, 5), mat);
                    block.position.y = i * 2;
                    block.rotation.y = i * 0.2;
                    group.add(block);
                }
                group.position.set(-15, 1, 0);
                group.userData = { anchored: true, isAI: true };
                LunX.scene.add(group);
                LunX.objects.push(group);
                alert("AI: G√∂zetleme Kulesi Olu≈üturuldu!");
            },

            addScriptTo: (objName, scriptType) => {
                const target = LunX.objects.find(o => o.name === objName);
                
                if (!target) {
                    return alert(`AI: '${objName}' adƒ±nda bir nesne bulamadƒ±m.`);
                }

                if (scriptType.includes("y√ºr√ºme kodu")) {
                    target.userData.hasWalkScript = true;
                    target.userData.scriptSpeed = 0.1;
                    target.userData.scriptTarget = 10; 
                    alert(`AI: '${objName}' nesnesine parametrik y√ºr√ºme kodu ba≈üarƒ±yla eklendi!`);
                } else if (scriptType.includes("d√∂nme kodu")) {
                    target.userData.hasRotateScript = true;
                    target.userData.scriptRotSpeed = 0.05;
                    alert(`AI: '${objName}' nesnesine d√∂nme kodu ba≈üarƒ±yla eklendi!`);
                } else {
                    alert(`AI: Bu komutu veya script t√ºr√ºn√º tanƒ±mƒ±yorum.`);
                }
            }
        };

        const Game = {
            play: () => {
                if(LunX.isPlaying) return;
                LunX.isPlaying = true;
                LunX.transform.detach();
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('right-panel').style.display = 'none';
                document.getElementById('toolbox').style.display = 'none';
                document.getElementById('game-hud').style.display = 'block';
                
                // R6 Karakter Spawn
                const grp = new THREE.Group(); grp.name = "Player";
                const mat = new THREE.MeshPhongMaterial({color:0x0088ff});
                const skin = new THREE.MeshPhongMaterial({color:0xffcc00});
                
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2), skin); head.position.y = 4.6;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), mat); torso.position.y = 3;
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), skin); la.position.set(-1.5, 3, 0); // Left Arm
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), skin); ra.position.set(1.5, 3, 0); // Right Arm
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mat); ll.position.set(-0.5,1,0); // Left Leg
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), mat); rl.position.set(0.5,1,0); // Right Leg
                
                grp.add(head, torso, la, ra, ll, rl);
                
                const spawn = LunX.objects.find(o=>o.name==="SpawnLocation");
                grp.position.copy(spawn ? spawn.position : new THREE.Vector3(0,5,0));
                grp.position.y += 2;
                
                grp.userData = { velocity: new THREE.Vector3(), onGround: false, limbs: {la, ra, ll, rl} };
                LunX.player = grp;
                LunX.scene.add(grp);
                
                // Camera
                LunX.controls.enablePan = false;
                LunX.controls.maxDistance = 20;
                LunX.controls.minDistance = 4;
            },
            
            stop: () => {
                LunX.isPlaying = false;
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('right-panel').style.display = 'flex';
                document.getElementById('toolbox').style.display = 'flex';
                document.getElementById('game-hud').style.display = 'none';
                document.getElementById('interact-btn').style.display = 'none';
                
                if(LunX.player) LunX.scene.remove(LunX.player);
                LunX.player = null;
                LunX.vehicle = null;
                
                LunX.camera.position.set(20,20,20);
                LunX.controls.target.set(0,0,0);
                LunX.controls.enablePan = true;
                
                LunX.objects.forEach(o => { 
                    if(o.userData.type && o.userData.type !== 'baseplate') o.position.set(0,10,0); 
                }); 
            },

            update: () => {
                let target = LunX.vehicle || LunX.player;
                if(!target) return;
                
                const v = target.userData.velocity;
                
                // 1. Gravity & Collisions (Simple Physics)
                if(!target.userData.isFlying) {
                    if(!target.userData.onGround) v.y -= 0.02;
                    target.position.y += v.y;
                }

                let groundY = -100;
                LunX.objects.forEach(obj => {
                    if(obj.userData.anchored) {
                        if(Math.abs(target.position.x - obj.position.x) < 5 && Math.abs(target.position.z - obj.position.z) < 5) {
                            if(obj.position.y < target.position.y && obj.position.y + obj.scale.y/2 > groundY) {
                                groundY = obj.position.y + 2; 
                            }
                            if(obj.userData.damage > 0 && target === LunX.player && target.position.distanceTo(obj.position) < 3) {
                                LunX.health = Math.max(0, LunX.health - 1);
                                document.getElementById('hp-bar').style.width = LunX.health + '%';
                            }
                        }
                    } else if(!obj.userData.isVehicle) {
                        obj.position.y -= 0.05; 
                        if(obj.position.y < 2) obj.position.y = 2;
                    }
                });

                if(target.position.y <= groundY) {
                    target.position.y = groundY;
                    v.y = 0;
                    target.userData.onGround = true;
                } else {
                    target.userData.onGround = false;
                }

                // 2. Movement & Input
                const speed = target.userData.isVehicle ? (target.userData.isFlying ? 0.8 : 0.2) : 0.3;
                
                if(LunX.joy.active) {
                    const camAng = LunX.controls.getAzimuthalAngle();
                    const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                    const right = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                    
                    if(target.userData.isVehicle) {
                        if(target.userData.isFlying) {
                            target.rotation.y -= LunX.joy.x * 0.02; 
                            target.rotation.x -= LunX.joy.y * 0.01; 
                            target.translateZ(-target.userData.thrust); 
                        } else {
                            target.translateZ(LunX.joy.y * speed);
                            target.rotation.y -= LunX.joy.x * 0.05;
                        }
                    } else {
                        const move = fwd.multiplyScalar(-LunX.joy.y).add(right.multiplyScalar(LunX.joy.x));
                        target.position.add(move.multiplyScalar(speed));
                        target.lookAt(target.position.clone().add(move));
                        
                        const t = Date.now()*0.02;
                        target.userData.limbs.la.rotation.x = Math.sin(t);
                        target.userData.limbs.ra.rotation.x = -Math.sin(t);
                        target.userData.limbs.ll.rotation.x = Math.sin(t);
                        target.userData.limbs.rl.rotation.x = -Math.sin(t);
                    }
                }

                // 3. AI Script Logic
                LunX.objects.forEach(obj => {
                    if(obj.userData.hasWalkScript) {
                        const targetX = obj.userData.scriptTarget || 10;
                        if(obj.position.x < targetX) obj.position.x += obj.userData.scriptSpeed;
                        if(obj.position.x >= targetX) obj.userData.scriptTarget = -10;
                        if(obj.position.x <= -10) obj.userData.scriptTarget = 10;
                    }
                });

                // 4. Vehicle Interaction
                if(!LunX.vehicle) {
                    const vehicles = LunX.objects.filter(o => o.userData.isVehicle);
                    let nearVehicle = false;
                    vehicles.forEach(car => {
                        if(target.position.distanceTo(car.position) < 8) {
                            nearVehicle = true;
                            document.getElementById('interact-btn').style.display = 'flex';
                            document.getElementById('interact-btn').innerHTML = car.userData.isFlying ? '‚úàÔ∏è' : 'üöó';
                            document.getElementById('interact-btn').onclick = () => Game.enterVehicle(car);
                        }
                    });
                    if(!nearVehicle) document.getElementById('interact-btn').style.display = 'none';
                }

                // 5. Camera Follow
                LunX.controls.target.lerp(target.position, 0.1);
            },
            
            enterVehicle: (car) => {
                LunX.vehicle = car;
                LunX.scene.remove(LunX.player); 
                document.getElementById('interact-btn').innerHTML = 'üö∂';
                document.getElementById('interact-btn').onclick = Game.exitVehicle;
            },
            
            exitVehicle: () => {
                if(!LunX.vehicle) return;
                LunX.player.position.copy(LunX.vehicle.position).add(new THREE.Vector3(3,0,0));
                LunX.scene.add(LunX.player);
                LunX.vehicle = null;
                document.getElementById('interact-btn').style.display = 'none';
            },

            // Inputs
            joyStart: (e) => { LunX.joy.active = true; Game.joyMove(e); },
            joyMove: (e) => {
                e.preventDefault();
                const rect = document.getElementById('joystick-area').getBoundingClientRect();
                const cx = rect.left+60; const cy=rect.top+60;
                const tx = e.touches[0].clientX; const ty = e.touches[0].clientY;
                let dx = tx-cx; let dy=ty-cy;
                const d = Math.sqrt(dx*dx+dy*dy);
                if(d>40) { const a=Math.atan2(dy,dx); dx=Math.cos(a)*40; dy=Math.sin(a)*40; }
                document.getElementById('joystick-knob').style.transform=`translate(${dx}px, ${dy}px)`;
                LunX.joy.x = dx/40; LunX.joy.y = dy/40;
            },
            joyEnd: () => { LunX.joy.active=false; LunX.joy.x=0; LunX.joy.y=0; document.getElementById('joystick-knob').style.transform='translate(0,0)'; },
            jump: (e) => { 
                if(e) e.preventDefault(); 
                if(LunX.player && LunX.player.userData.onGround) {
                    LunX.player.userData.velocity.y = 0.8; 
                    LunX.player.userData.onGround = false;
                } 
            }
        };

        const UI = {
            // D√ºzeltilmi≈ü UI √ñl√ßekleme Fonksiyonu
            setScale: (s) => {
                // Bu, t√ºm Studio aray√ºz√ºn√º (Men√ºler, Paneller, 3D alan dahil) √∂l√ßekler.
                document.getElementById('studio-container').style.transform = `scale(${s})`;
                // √ñl√ßeklendirmeden sonra viewport'un doƒüru hesaplanmasƒ± i√ßin resize √ßaƒürƒ±lƒ±r.
                ThreeEngine.resize();
            },
            setTab: (tabId) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
                document.getElementById('sec-'+tabId).classList.add('active');
            },
            toggle: (panelId) => {
                document.getElementById(panelId).classList.toggle('closed');
                ThreeEngine.resize(); 
            },
            openXMenu: () => {
                document.getElementById('x-overlay').classList.add('active');
            },
            closeXMenu: () => {
                document.getElementById('x-overlay').classList.remove('active');
                // CSS transition'ƒ±nƒ±n bitmesi i√ßin 300ms beklenir
                setTimeout(() => document.getElementById('x-overlay').style.display = 'none', 300);
            },
            
            updateProps: () => {
                const p = document.getElementById('prop-content');
                p.innerHTML = '';
                if(!LunX.selected) return;
                const obj = LunX.selected;
                
                const row = (lbl, val, type, cb) => {
                    const div = document.createElement('div'); div.className='prop-row';
                    div.innerHTML = `<div class="prop-label">${lbl}</div>`;
                    const inp = document.createElement('input'); inp.className='prop-input';
                    inp.type = type;
                    if(type==='checkbox') inp.checked = val; else inp.value = val;
                    inp.onchange = e => cb(type==='checkbox'?e.target.checked:e.target.value);
                    div.appendChild(inp); p.appendChild(div);
                };
                
                row("Name", obj.name, 'text', v=>obj.name=v);
                if(!obj.userData.locked) {
                    row("Anchored", obj.userData.anchored, 'checkbox', v=>obj.userData.anchored=v);
                    row("Color", '#'+obj.material.color.getHexString(), 'color', v=>obj.material.color.set(v));
                    const btn = document.createElement('button'); btn.innerText="Texture"; btn.onclick=World.uploadTexture;
                    p.appendChild(btn);
                    if(obj.userData.hasWalkScript !== undefined) row("Script Active", obj.userData.hasWalkScript, 'checkbox', v=>obj.userData.hasWalkScript=v);
                }
            },
            refreshExplorer: () => {
                const ex = document.getElementById('explorer'); ex.innerHTML = '';
                LunX.objects.forEach(o => {
                    const d = document.createElement('div');
                    d.innerText = (o.userData.isAI ? "ü§ñ " : "") + o.name; d.style.padding='2px'; d.style.cursor='pointer';
                    if(o === LunX.selected) d.style.background='#cce5ff';
                    d.onclick = () => Tools.onSelect({custom: o});
                    ex.appendChild(d);
                });
            },
            initToolbox: () => {
                const tb = document.getElementById('toolbox-content');
                const items = [
                    {name:"Neon Kƒ±rmƒ±zƒ±", type:"neon", color:0xff0000},
                    {name:"Odun Blok", type:"box", color:0x654321},
                    {name:"Tuƒüla Duvar", type:"box", color:0xaa5555},
                    {name:"√ñld√ºr√ºc√º Blok", type:"damage", color:0xff0000}
                ];
                for(let i=0;i<20;i++) items.push({name:`Blok ${i+1}`, type:'box', color:Math.random()*0xffffff});
                
                items.forEach(it => {
                    const el = document.createElement('div');
                    el.className='tb-item';
                    el.innerHTML = `<div class="tb-icon" style="background:#${new THREE.Color(it.color).getHexString()}"></div>${it.name}`;
                    el.onclick = () => World.add(it.type, {color:it.color});
                    tb.appendChild(el);
                });
            }
        };

        const App = {
            reset: () => location.reload(),
            setQuality: (v) => LunX.renderer.setPixelRatio(window.devicePixelRatio * v)
        };

        const style = document.createElement('style');
        style.innerHTML = '.tb-icon { width: 20px; height: 20px; border-radius: 3px; margin-right: 8px; border: 1px solid #ccc; } .tb-item { padding: 6px; margin-bottom: 2px; cursor: pointer; display: flex; align-items: center; font-size: 12px; border-radius: 3px; } .tb-item:hover { background: #eee; }';
        document.head.appendChild(style);
        
        // LunX.init() body onload i√ßinde √ßaƒürƒ±lƒ±yor.
    </script>
</body>
</html>
