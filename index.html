<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Red Classic & R6 AI</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #d32f2f; /* ƒ∞stenen Eski Kƒ±rmƒ±zƒ± */
            --primary-dark: #b71c1c;
            --bg-light: #f5f5f5;
            --bg-panel: #ffffff;
            --border: #e0e0e0;
            --text: #333;
            --header-h: 45px;
            --ribbon-h: 90px;
        }

        * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-light); height: 100vh; display: flex; flex-direction: column; }
        
        /* UI Ba≈ülangƒ±√ß */
        #start-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #d32f2f, #ff8a80);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .template-card {
            background: white; color: #333; width: 140px; height: 160px; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; margin: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition:0.2s;
        }
        .template-card:hover { transform: scale(1.05); }

        /* √úst Bar */
        #top-bar {
            height: var(--header-h); background: var(--primary); color: white; display: flex; align-items: center; padding: 0 10px;
            font-size: 14px; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #menu-btn { font-weight:bold; font-size:18px; margin-right:15px; cursor:pointer; padding:5px; }
        .tab-btn { padding: 0 15px; cursor: pointer; opacity: 0.8; height: 100%; display: flex; align-items: center; transition:0.2s; }
        .tab-btn:hover { background: rgba(255,255,255,0.2); opacity:1; }
        .tab-btn.active { background: rgba(0,0,0,0.2); font-weight: bold; opacity:1; border-bottom: 3px solid white; }

        /* Ribbon (Ara√ßlar) */
        #ribbon {
            height: var(--ribbon-h); background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display:flex; align-items:center; padding:0 10px; overflow-x: auto;
        }
        .tool-group { display: flex; gap: 5px; padding: 0 10px; border-right: 1px solid #eee; align-items: center; height:100%; }
        .r-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 60px; height: 70px; border-radius: 4px; cursor: pointer; color: #444; font-size:11px;
        }
        .r-btn:hover { background: #ffcdd2; color: var(--primary); }
        .r-btn.active { background: #ffCDD2; color: var(--primary-dark); border: 1px solid var(--primary); }
        .r-btn span { font-size: 22px; margin-bottom: 5px; }

        /* Ana D√ºzen */
        #layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* Sol Panel (Toolbox) */
        #toolbox { width: 220px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel-head { background: #eee; padding: 8px; font-weight: bold; font-size: 12px; border-bottom: 1px solid #ddd; }
        #toolbox-items { flex:1; overflow-y:auto; padding:5px; display:grid; grid-template-columns:1fr 1fr; gap:5px; align-content:start; }
        .t-item { border:1px solid #eee; padding:5px; text-align:center; font-size:10px; cursor:pointer; border-radius:4px; }
        .t-item:hover { border-color: var(--primary); background:#fafafa; }

        /* Orta (Viewport) */
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; }

        /* Saƒü Panel (Properties) */
        #properties { width: 250px; background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        #explorer-list { height: 40%; overflow-y: auto; border-bottom: 1px solid #ddd; }
        #prop-list { flex: 1; overflow-y: auto; padding: 10px; }
        .prop-row { margin-bottom:8px; display:flex; align-items:center; font-size:11px; }
        .prop-lbl { width:80px; color:#666; }
        .prop-val { flex:1; padding:4px; border:1px solid #ccc; border-radius:2px; }

        /* OYUN ARAY√úZ√ú (HUD) */
        #game-overlay { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #stop-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 8px 20px; font-weight: bold;
            border-radius: 4px; cursor: pointer; pointer-events: auto; border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.5); }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: white; border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 2px 5px black; }
        #jump-btn { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 80px; background: rgba(255,255,255,0.8); border-radius: 50%; border: 4px solid var(--primary); pointer-events: auto; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 900; font-size: 24px; transition:0.1s; }
        #jump-btn:active { transform: scale(0.9); background: white; }

        /* LunAIX Chat */
        #ai-modal {
            position: fixed; bottom: 20px; right: 20px; width: 350px; height: 450px;
            background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; flex-direction: column; z-index: 2000; border: 1px solid #ccc;
        }
        .ai-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; border-radius: 10px 10px 0 0; display:flex; justify-content:space-between; }
        .ai-content { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; font-size: 12px; }
        .ai-input-area { padding: 10px; border-top: 1px solid #ddd; display: flex; }
        .msg { padding: 8px 12px; border-radius: 15px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; }
        .msg.bot { background: white; border: 1px solid #ddd; color: #333; align-self: flex-start; }
        .msg.user { background: #ffcdd2; color: #b71c1c; margin-left: auto; }

    </style>
</head>
<body onload="App.init()">

    <div id="start-screen">
        <h1 style="font-size: 50px; margin: 0;">LunX Studio</h1>
        <p>Classic Edition</p>
        <div style="display:flex;">
            <div class="template-card" onclick="World.load('baseplate')">Baseplate</div>
            <div class="template-card" onclick="World.load('grass')">Grass</div>
        </div>
    </div>

    <div id="top-bar">
        <div id="menu-btn">‚ò∞</div>
        <div style="font-weight:bold; margin-right:20px; font-size:16px;">LunX Studio</div>
        <div class="tab-btn active">Home</div>
        <div class="tab-btn">Model</div>
        <div class="tab-btn">View</div>
    </div>

    <div id="ribbon">
        <div class="tool-group">
            <div class="r-btn active" onclick="Editor.setMode('select')" id="btn-select"><span>üëÜ</span>Se√ß</div>
            <div class="r-btn" onclick="Editor.setMode('translate')" id="btn-translate"><span>‚ÜîÔ∏è</span>Ta≈üƒ±</div>
            <div class="r-btn" onclick="Editor.setMode('scale')" id="btn-scale"><span>‚§°</span>Boyut</div>
            <div class="r-btn" onclick="Editor.setMode('rotate')" id="btn-rotate"><span>üîÑ</span>D√∂nd√ºr</div>
        </div>
        <div class="tool-group">
            <div class="r-btn" onclick="World.addPart({})"><span>üß±</span>Par√ßa</div>
            <div class="r-btn" onclick="UI.toggleAI()"><span>ü§ñ</span>LunAIX</div>
            <div class="r-btn" onclick="Editor.delete()"><span>üóëÔ∏è</span>Sil</div>
        </div>
        <div class="tool-group" style="margin-left:auto; border:none;">
            <div class="r-btn" onclick="Game.play()" style="color:green;"><span>‚ñ∂</span>Oynat</div>
        </div>
    </div>

    <div id="layout">
        <div id="toolbox">
            <div class="panel-head">Toolbox</div>
            <div id="toolbox-items"></div>
        </div>

        <div id="viewport">
            <div id="game-overlay">
                <div id="stop-hud" onclick="Game.stop()">‚èπ DUDUR</div>
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>
        </div>

        <div id="properties">
            <div class="panel-head">Explorer</div>
            <div id="explorer-list"></div>
            <div class="panel-head">Properties</div>
            <div id="prop-list"></div>
        </div>
    </div>

    <div id="ai-modal">
        <div class="ai-header">
            <span>LunAIX Sohbet & ƒ∞n≈üa</span>
            <span style="cursor:pointer" onclick="UI.toggleAI()">‚úï</span>
        </div>
        <div class="ai-content" id="chat-history">
            <div class="msg bot">Merhaba! Ben LunAIX. Seninle sohbet edebilirim veya bir ≈üeyler in≈üa edebilirim.<br>√ñrnek: "Kƒ±rmƒ±zƒ± b√ºy√ºk bir duvar in≈üa et" veya sadece "Nasƒ±lsƒ±n?"</div>
        </div>
        <div class="ai-input-area">
            <input type="text" id="ai-input" style="flex:1; padding:5px;" placeholder="Mesaj yaz..." onkeydown="if(event.key==='Enter') AI.send()">
            <button onclick="AI.send()" style="margin-left:5px;">G√∂nder</button>
        </div>
    </div>

    <script>
        // --- TEMEL MOTOR ---
        const App = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            clock: new THREE.Clock(),
            world: null, // Fizik D√ºnyasƒ±
            objects: [], // G√∂rsel ve Fiziksel nesneler
            
            init: () => {
                const vp = document.getElementById('viewport');
                
                // Three.js
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0x87CEEB);
                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                App.camera.position.set(10, 10, 10);

                App.renderer = new THREE.WebGLRenderer({ antialias: true });
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(20, 50, 20);
                light.castShadow = true;
                light.shadow.mapSize.width = 2048; light.shadow.mapSize.height = 2048;
                App.scene.add(light);
                App.scene.add(new THREE.AmbientLight(0x404040));

                // Kontroller
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', e => App.controls.enabled = !e.value);
                App.scene.add(App.transform);

                // Cannon Fizik
                App.world = new CANNON.World();
                App.world.gravity.set(0, -30, 0);
                App.world.broadphase = new CANNON.NaiveBroadphase();
                
                // Zemin Malzemesi
                const mat = new CANNON.Material();
                const contactMat = new CANNON.ContactMaterial(mat, mat, { friction: 0.0, restitution: 0.3 });
                App.world.addContactMaterial(contactMat);

                window.addEventListener('resize', () => {
                    App.camera.aspect = vp.clientWidth / vp.clientHeight;
                    App.camera.updateProjectionMatrix();
                    App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                });

                UI.init();
                Game.initInput();
                App.loop();
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = App.clock.getDelta();
                
                if(Game.active) {
                    Game.update(dt);
                    App.world.step(1/60, dt, 3);
                } else {
                    App.controls.update();
                }

                // Fizik -> G√∂rsel E≈üleme
                App.objects.forEach(obj => {
                    if(obj.userData.body && !obj.userData.anchored) {
                        obj.position.copy(obj.userData.body.position);
                        obj.quaternion.copy(obj.userData.body.quaternion);
                    }
                });

                App.renderer.render(App.scene, App.camera);
            }
        };

        // --- D√úNYA Y√ñNETƒ∞Mƒ∞ ---
        const World = {
            load: (type) => {
                document.getElementById('start-screen').style.display = 'none';
                
                // Zemin
                const color = type==='grass' ? 0x4CAF50 : 0x9E9E9E;
                const floorGeo = new THREE.BoxGeometry(200, 2, 200);
                const floorMat = new THREE.MeshStandardMaterial({color: color});
                const floor = new THREE.Mesh(floorGeo, floorMat);
                floor.position.y = -1;
                floor.receiveShadow = true;
                floor.name = "Baseplate";
                floor.userData = { locked: true, anchored: true };
                App.scene.add(floor);
                
                // Fizik Zemin
                const floorShape = new CANNON.Box(new CANNON.Vec3(100, 1, 100));
                const floorBody = new CANNON.Body({ mass: 0 });
                floorBody.addShape(floorShape);
                floorBody.position.set(0, -1, 0);
                App.world.addBody(floorBody);

                // Spawn Point
                World.addPart({name:"SpawnLocation", shape:'cylinder', color:0x888888, scale:[4,0.5,4], anchored:true});
            },

            addPart: (cfg) => {
                const geo = cfg.shape==='cylinder' ? new THREE.CylinderGeometry(1,1,1,32) : 
                            cfg.shape==='sphere' ? new THREE.SphereGeometry(1,32,32) : 
                            new THREE.BoxGeometry(1,1,1);
                
                const mat = new THREE.MeshStandardMaterial({color: cfg.color || 0xd32f2f});
                const mesh = new THREE.Mesh(geo, mat);
                
                const scale = cfg.scale || [4,4,4];
                mesh.scale.set(scale[0], scale[1], scale[2]);
                mesh.position.copy(cfg.pos || new THREE.Vector3(0, 5, 0));
                mesh.name = cfg.name || "Par√ßa";
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.userData = { anchored: cfg.anchored!==undefined ? cfg.anchored : false };

                // Fizik
                let shape;
                if(cfg.shape==='sphere') shape = new CANNON.Sphere(Math.max(scale[0],scale[1],scale[2])/2);
                else if(cfg.shape==='cylinder') shape = new CANNON.Cylinder(scale[0]/2, scale[0]/2, scale[1], 12);
                else shape = new CANNON.Box(new CANNON.Vec3(scale[0]/2, scale[1]/2, scale[2]/2));

                const body = new CANNON.Body({
                    mass: mesh.userData.anchored ? 0 : 10,
                    shape: shape
                });
                body.position.copy(mesh.position);
                App.world.addBody(body);
                
                mesh.userData.body = body;
                App.scene.add(mesh);
                App.objects.push(mesh);
                
                UI.addToExplorer(mesh);
                return mesh;
            }
        };

        // --- LUNAIX (GELƒ∞≈ûMƒ∞≈û YAPAY ZEKA) ---
        const AI = {
            send: () => {
                const inp = document.getElementById('ai-input');
                const txt = inp.value.trim();
                if(!txt) return;
                
                AI.addMsg(txt, 'user');
                inp.value = '';
                
                setTimeout(() => AI.process(txt), 600); // D√º≈ü√ºnme s√ºresi
            },
            
            addMsg: (txt, type) => {
                const div = document.createElement('div');
                div.className = 'msg ' + type;
                div.innerText = txt;
                const area = document.getElementById('chat-history');
                area.appendChild(div);
                area.scrollTop = area.scrollHeight;
            },

            process: (txt) => {
                const l = txt.toLowerCase();
                let reply = "";

                // 1. ƒ∞N≈ûAAT KOMUTLARI ALGILAMA
                const buildKeywords = ['yap', 'olu≈ütur', 'in≈üa', 'build', 'create', 'koy', 'ekle'];
                const isBuilding = buildKeywords.some(k => l.includes(k));

                if (isBuilding) {
                    // Renk Algƒ±lama
                    let color = 0x999999; // Varsayƒ±lan gri
                    if(l.includes('kƒ±rmƒ±zƒ±') || l.includes('red')) color = 0xd32f2f;
                    if(l.includes('mavi') || l.includes('blue')) color = 0x1976D2;
                    if(l.includes('ye≈üil') || l.includes('green')) color = 0x388E3C;
                    if(l.includes('sarƒ±') || l.includes('yellow')) color = 0xFBC02D;
                    if(l.includes('siyah') || l.includes('black')) color = 0x212121;
                    if(l.includes('beyaz') || l.includes('white')) color = 0xffffff;

                    // ≈ûekil Algƒ±lama
                    let shape = 'box';
                    if(l.includes('top') || l.includes('k√ºre') || l.includes('sphere')) shape = 'sphere';
                    if(l.includes('silindir') || l.includes('direk') || l.includes('cylinder')) shape = 'cylinder';

                    // Boyut Algƒ±lama
                    let scale = [4,4,4];
                    if(l.includes('b√ºy√ºk') || l.includes('kocaman') || l.includes('big')) scale = [10,10,10];
                    if(l.includes('k√º√ß√ºk') || l.includes('minik') || l.includes('small')) scale = [2,2,2];
                    if(l.includes('duvar') || l.includes('wall')) scale = [1, 8, 12];
                    if(l.includes('zemin') || l.includes('floor')) scale = [20, 1, 20];
                    if(l.includes('kule') || l.includes('tower')) scale = [5, 20, 5];

                    // Nesne Tipi (√ñzel)
                    if(l.includes('ev') || l.includes('house')) {
                        // Basit ev prosed√ºrel
                        const pos = new THREE.Vector3((Math.random()-0.5)*20, 4, (Math.random()-0.5)*20);
                        World.addPart({name:"Duvar1", pos: pos.clone().add(new THREE.Vector3(-4,0,0)), scale:[1,6,8], color:0xd32f2f, anchored:true});
                        World.addPart({name:"Duvar2", pos: pos.clone().add(new THREE.Vector3(4,0,0)), scale:[1,6,8], color:0xd32f2f, anchored:true});
                        World.addPart({name:"√áatƒ±", pos: pos.clone().add(new THREE.Vector3(0,4,0)), scale:[10,2,10], color:0x333, anchored:true});
                        reply = "ƒ∞stediƒüin gibi bir ev in≈üa ettim!";
                    } else {
                        // Standart Par√ßa
                        const pos = new THREE.Vector3((Math.random()-0.5)*10, 5, (Math.random()-0.5)*10);
                        World.addPart({
                            name: "LunAIX_Parca",
                            color: color,
                            shape: shape,
                            scale: scale,
                            pos: pos,
                            anchored: false // Fiziksel olsun
                        });
                        reply = `Anla≈üƒ±ldƒ±! Sahneye bir par√ßa ekledim. (Renk: ${l.includes('kƒ±rmƒ±zƒ±')?'Kƒ±rmƒ±zƒ±':'Standart'})`;
                    }

                } else {
                    // 2. SOHBET MODU
                    if(l.includes('merhaba') || l.includes('selam')) reply = "Merhaba! LunX Studio'ya ho≈ü geldin. Ne yapmamƒ± istersin?";
                    else if(l.includes('nasƒ±lsƒ±n')) reply = "Ben bir yapay zekayƒ±m, duygularƒ±m yok ama kodlarƒ±m gayet iyi √ßalƒ±≈üƒ±yor! Sen nasƒ±lsƒ±n?";
                    else if(l.includes('ne yapabilirsin')) reply = "Senin i√ßin haritaya bloklar koyabilirim, ev yapabilirim, duvar √∂rebilirim. Sadece s√∂ylemen yeterli.";
                    else if(l.includes('adƒ±n ne')) reply = "Benim adƒ±m LunAIX. LunX Studio'nun akƒ±llƒ± asistanƒ±yƒ±m.";
                    else if(l.includes('oyun')) reply = "Oynat butonuna basarak RobloxR6 karakterinle haritada gezebilirsin.";
                    else reply = "Bunu tam anlamadƒ±m. Bana 'kƒ±rmƒ±zƒ± bir kutu yap' veya 'b√ºy√ºk bir duvar olu≈ütur' gibi komutlar verebilirsin.";
                }

                AI.addMsg(reply, 'bot');
            }
        };

        // --- OYUN VE R6 KARAKTER ---
        const Game = {
            active: false,
            player: null,
            body: null,
            inputs: { x:0, y:0 },
            
            initInput: () => {
                // Joystick
                const zone = document.getElementById('joystick-zone');
                const stick = document.getElementById('stick');
                let drag = false;
                
                const moveStick = (cx, cy) => {
                    const rect = zone.getBoundingClientRect();
                    const cx0 = rect.left + rect.width/2;
                    const cy0 = rect.top + rect.height/2;
                    const dx = cx - cx0; const dy = cy - cy0;
                    const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                    const a = Math.atan2(dy, dx);
                    const x = Math.cos(a)*d; const y = Math.sin(a)*d;
                    stick.style.transform = `translate(${x}px, ${y}px)`;
                    Game.inputs.x = x/40; Game.inputs.y = y/40;
                };

                zone.addEventListener('pointerdown', e => { drag=true; moveStick(e.clientX, e.clientY); });
                window.addEventListener('pointermove', e => { if(drag) moveStick(e.clientX, e.clientY); });
                window.addEventListener('pointerup', () => { 
                    drag=false; stick.style.transform = `translate(0,0)`; Game.inputs={x:0,y:0}; 
                });

                // Zƒ±plama
                document.getElementById('jump-btn').addEventListener('pointerdown', () => {
                    if(Game.body && Math.abs(Game.body.velocity.y) < 0.1) Game.body.velocity.y = 15;
                });
            },

            spawnR6: () => {
                // R6 Karakter Grubu (Classic Roblox Colors)
                const rig = new THREE.Group();
                rig.name = "Player";

                const matHead = new THREE.MeshStandardMaterial({color: 0xFBC02D}); // Sarƒ±
                const matTorso = new THREE.MeshStandardMaterial({color: 0x1976D2}); // Mavi
                const matLegs = new THREE.MeshStandardMaterial({color: 0x4CAF50}); // Ye≈üil

                const head = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), matHead); head.position.y = 1.5;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), matTorso); torso.position.y = 0;
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matHead); la.position.set(-1.5, 0, 0);
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matHead); ra.position.set(1.5, 0, 0);
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matLegs); ll.position.set(-0.5, -2, 0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matLegs); rl.position.set(0.5, -2, 0);

                rig.add(head, torso, la, ra, ll, rl);
                
                // Spawn noktasƒ± bul
                let pos = new THREE.Vector3(0,5,0);
                const spawn = App.scene.getObjectByName("SpawnLocation");
                if(spawn) pos.copy(spawn.position).add(new THREE.Vector3(0,3,0));

                // Fizik Kaps√ºl√º
                const body = new CANNON.Body({ mass: 50, fixedRotation: true });
                const shape = new CANNON.Cylinder(1, 1, 4, 12);
                body.addShape(shape, new CANNON.Vec3(0,-0.5,0));
                body.position.copy(pos);
                body.linearDamping = 0.9;
                App.world.addBody(body);

                App.scene.add(rig);
                Game.player = rig;
                Game.body = body;
                Game.limbs = { la, ra, ll, rl }; // Animasyon i√ßin referans
            },

            play: () => {
                if(Game.active) return;
                Game.active = true;
                
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('layout').style.top = '0'; // Fullscreen
                document.getElementById('properties').style.display = 'none';
                document.getElementById('toolbox').style.display = 'none';
                document.getElementById('game-overlay').style.display = 'block';

                // Edit√∂r kamerasƒ±nƒ± devredƒ±≈üƒ± bƒ±rak
                App.controls.enablePan = false;
                App.controls.enableZoom = true;
                
                Game.spawnR6();
            },

            stop: () => {
                Game.active = false;
                
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('properties').style.display = 'flex';
                document.getElementById('toolbox').style.display = 'flex';
                document.getElementById('game-overlay').style.display = 'none';

                if(Game.player) { App.scene.remove(Game.player); Game.player=null; }
                if(Game.body) { App.world.removeBody(Game.body); Game.body=null; }

                App.controls.enablePan = true;
                App.camera.position.set(10,10,10);
                App.controls.target.set(0,0,0);
            },

            update: (dt) => {
                if(!Game.player || !Game.body) return;
                
                // Karakter Pozisyonu E≈üle
                Game.player.position.copy(Game.body.position);
                
                // Hareket Mantƒ±ƒüƒ±
                const speed = 20;
                const camDir = new THREE.Vector3(); App.camera.getWorldDirection(camDir); camDir.y=0; camDir.normalize();
                const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x);
                
                const move = new THREE.Vector3();
                move.add(camRight.multiplyScalar(Game.inputs.x));
                move.add(camDir.multiplyScalar(-Game.inputs.y));

                if(move.length() > 0.1) {
                    move.normalize().multiplyScalar(speed);
                    Game.body.velocity.x = move.x;
                    Game.body.velocity.z = move.z;

                    // D√∂n√º≈ü
                    const angle = Math.atan2(move.x, move.z);
                    Game.player.rotation.y = angle;

                    // Basit R6 Animasyonu
                    const t = Date.now() * 0.015;
                    Game.limbs.la.rotation.x = Math.sin(t);
                    Game.limbs.ra.rotation.x = -Math.sin(t);
                    Game.limbs.ll.rotation.x = -Math.sin(t);
                    Game.limbs.rl.rotation.x = Math.sin(t);
                } else {
                    Game.body.velocity.x *= 0.5;
                    Game.body.velocity.z *= 0.5;
                    Game.limbs.la.rotation.x = 0;
                    Game.limbs.ra.rotation.x = 0;
                    Game.limbs.ll.rotation.x = 0;
                    Game.limbs.rl.rotation.x = 0;
                }

                // Kamera Takibi
                App.controls.target.copy(Game.player.position);
            }
        };

        // --- UI YARDIMCILARI ---
        const UI = {
            init: () => {
                const list = document.getElementById('toolbox-items');
                const items = [
                    {n:'Par√ßa', c:0xeeeeee}, {n:'Duvar', c:0xd32f2f},
                    {n:'Top', c:0x2196F3}, {n:'Silindir', c:0xFFEB3B}
                ];
                items.forEach(i => {
                    const el = document.createElement('div'); el.className='t-item';
                    el.innerText = i.n;
                    el.style.borderLeft = `4px solid #${i.c.toString(16)}`;
                    el.onclick = () => {
                        const s = i.n==='Top'?'sphere':i.n==='Silindir'?'cylinder':'box';
                        World.addPart({name:i.n, color:i.c, shape:s});
                    };
                    list.appendChild(el);
                });
            },
            addToExplorer: (mesh) => {
                const list = document.getElementById('explorer-list');
                const el = document.createElement('div');
                el.style.padding = '2px 5px'; el.style.fontSize='11px'; el.style.cursor='pointer';
                el.innerText = 'üì¶ ' + mesh.name;
                el.onclick = () => { Editor.select(mesh); };
                list.appendChild(el);
            },
            toggleAI: () => {
                const el = document.getElementById('ai-modal');
                el.style.display = el.style.display==='flex' ? 'none' : 'flex';
            }
        };

        // --- EDƒ∞T√ñR ---
        const Editor = {
            selected: null,
            setMode: (m) => {
                App.transform.setMode(m);
                document.querySelectorAll('.r-btn').forEach(b=>b.classList.remove('active'));
                const btn = document.getElementById('btn-'+m);
                if(btn) btn.classList.add('active');
            },
            select: (mesh) => {
                if(mesh.userData.locked) return;
                Editor.selected = mesh;
                App.transform.attach(mesh);
                // √ñzellikleri G√∂ster
                const p = document.getElementById('prop-list');
                p.innerHTML = `
                    <div class="prop-row"><div class="prop-lbl">ƒ∞sim</div><input class="prop-val" value="${mesh.name}"></div>
                    <div class="prop-row"><div class="prop-lbl">Sabit</div><input type="checkbox" ${mesh.userData.anchored?'checked':''}></div>
                `;
            },
            delete: () => {
                if(!Editor.selected) return;
                App.scene.remove(Editor.selected);
                App.transform.detach();
                Editor.selected = null;
            }
        };

    </script>
</body>
</html>
