<script type="module">
    // --- 1. FIREBASE SDK KURULUMU (Düzeltilmiş Import Yolları) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // Senin LunX Studio projenin güncel yapılandırması
    const firebaseConfig = {
        apiKey: "AIzaSyD4Dh_WCxTSqMnJ8u0M4KqwHpejJrEoctk",
        authDomain: "lunxstudio.firebaseapp.com",
        databaseURL: "https://lunxstudio-default-rtdb.firebaseio.com", 
        projectId: "lunxstudio",
        storageBucket: "lunxstudio.firebasestorage.app",
        messagingSenderId: "810358489202",
        appId: "1:810358489202:web:301dbd444bf4608f2782eb",
        measurementId: "G-Y36QNCE71R"
    };
    
    let app, auth, db; 
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app); 
        db = getDatabase(app); 
        console.log("Firebase Auth ve RTDB başarıyla bağlandı!");
    } catch(e) {
        console.error("Firebase başlatma hatası:", e);
        log("HATA: Firebase bağlantısı kurulamadı. Konsolu kontrol et.");
    }

    // --- 2. GLOBAL DURUMLAR VE DEĞİŞKENLER ---

    let scene, camera, renderer, controls, transformControls;
    let objects = []; 
    let selectedObject = null;
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let currentProjectName = "Yeni Proje";

    // --- 3. ANA MENÜ VE PROJE AKIŞI ---
    
    function showMainMenu() {
        document.getElementById('main-menu-modal').style.display = 'flex';
        document.getElementById('sidebar-left').style.display = 'none';
        document.getElementById('sidebar-right').style.display = 'none';
    }

    window.checkLoginAndOpenProjectName = () => {
        if (auth && auth.currentUser) {
            document.getElementById('main-menu-buttons').style.display = 'none';
            document.getElementById('project-naming-section').style.display = 'block';
            document.getElementById('login-warning').style.display = 'none';
            document.getElementById('project-name-input').focus();
        } else {
            document.getElementById('login-warning').style.display = 'block';
            log("Yeni proje oluşturmak için giriş yapın.");
        }
    }
    
    window.selectEnvironment = (env) => {
        document.querySelectorAll('.env-btn').forEach(btn => btn.classList.remove('selected'));
        document.querySelector(`[onclick="selectEnvironment('${env}')"]`).classList.add('selected');
    }

    window.startProject = () => {
        if (!auth.currentUser) {
            log("Hata: Giriş yapılmadan proje başlatılamaz.");
            return;
        }
        
        const projectNameInput = document.getElementById('project-name-input');
        const projectName = projectNameInput.value.trim();
        
        if (projectName) {
            currentProjectName = projectName;
        }
        
        document.getElementById('main-menu-modal').style.display = 'none';
        document.getElementById('sidebar-left').style.display = 'flex';
        document.getElementById('sidebar-right').style.display = 'flex';
        document.title = `LunX Studio - ${currentProjectName}`;
        
        if (!renderer) { 
            init();
        }
        
        window.clearScene(false); 
        setupEnvironment('default_template');
        log(`Proje başlatıldı: ${currentProjectName}`);
    }

    function setupEnvironment(env) {
        scene.background = new THREE.Color(0x87CEEB); 
        scene.children = scene.children.filter(child => child.isLight || child.isTransformControls || child.isMesh && objects.includes(child));

        const groundGeometry = new THREE.BoxGeometry(30, 0.1, 30); 
        const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x555555, transparent: false, opacity: 1.0 }); 
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.position.y = -0.05; 
        scene.add(ground);
        
        const gridHelper = new THREE.GridHelper(30, 30, 0x999999, 0x777777); 
        scene.add(gridHelper);
    }
    
    // --- 4. KİMLİK DOĞRULAMA (Giriş/Kayıt) ---
    
    window.registerUser = async () => {
        const email = document.getElementById('email-input').value;
        const pass = document.getElementById('password-input').value;
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            document.getElementById('auth-modal').style.display = 'none';
            log("Kayıt başarılı. Giriş yapıldı.");
            showMainMenu(); 
        } catch (error) { showError(error.message); }
    };
    window.loginUser = async () => {
        const email = document.getElementById('email-input').value;
        const pass = document.getElementById('password-input').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            document.getElementById('auth-modal').style.display = 'none';
            log("Giriş başarılı.");
            showMainMenu(); 
        } catch (error) { showError(error.message); }
    };
    window.logoutUser = async () => { 
        await signOut(auth); 
        showMainMenu(); 
    };
    function showError(msg) { 
        const errDiv = document.getElementById('auth-error');
        errDiv.innerText = msg; errDiv.style.display = 'block';
    }

    if(auth) {
        onAuthStateChanged(auth, (user) => {
            const userEmailSpan = document.getElementById('user-email');
            const loginBtn = document.getElementById('login-btn-sidebar');
            const logoutBtn = document.getElementById('logout-btn-sidebar');
            if (user) {
                userEmailSpan.innerText = user.email;
                userEmailSpan.style.color = "#4caf50";
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                document.getElementById('login-warning').style.display = 'none';
                log(user.email + " giriş yaptı.");
            } else {
                userEmailSpan.innerText = "Misafir Modu";
                userEmailSpan.style.color = "#fff";
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                log("Misafir modundasınız.");
            }
        });
    }
    
    // --- 5. VERİTABANI VE 3D İŞLEMLERİ (Aynı Kalır) ---

    window.saveScene = async () => {
        const user = auth.currentUser;
        if (!user) {
            log("Hata: Sahneyi kaydetmek için giriş yapmalısınız!");
            return;
        }
        const sceneData = objects.map(obj => ({
            type: obj.userData.type,
            position: obj.position.clone(),
            color: obj.material.color.getHex(),
            script: obj.userData.script || ""
        }));
        try {
            const sceneRef = ref(db, 'scenes/' + user.uid);
            await set(sceneRef, sceneData);
            log("Sahne başarıyla buluta kaydedildi!");
        } catch (error) {
            log("Hata (Kaydetme): " + error.message);
        }
    }

    window.loadScene = async () => {
        const user = auth.currentUser;
        if (!user) {
            log("Hata: Yüklemek için giriş yapmalısınız!");
            return;
        }
        try {
            const sceneRef = ref(db, 'scenes/' + user.uid);
            const snapshot = await get(sceneRef);
            if (snapshot.exists()) {
                const savedObjects = snapshot.val();
                window.clearScene(false); 
                document.getElementById('main-menu-modal').style.display = 'none';
                document.getElementById('sidebar-left').style.display = 'flex';
                document.getElementById('sidebar-right').style.display = 'flex';
                if (!renderer) init();
                setupEnvironment('default_template');
                savedObjects.forEach(data => {
                    window.addShape(data.type, data);
                });
                log("Sahne buluttan yüklendi!");
            } else {
                log("Bulutta kayıtlı sahne bulunamadı.");
            }
        } catch (error) {
            log("Hata (Yükleme): " + error.message);
        }
    }
    
    function init() {
        const viewport = document.getElementById('viewport');
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, viewport.clientWidth / viewport.clientHeight, 0.1, 1000);
        camera.position.set(5, 5, 5);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        viewport.appendChild(renderer.domElement);
        
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        
        transformControls = new THREE.TransformControls(camera, renderer.domElement);
        scene.add(transformControls);

        transformControls.addEventListener('dragging-changed', function (event) {
            controls.enabled = !event.value;
        });
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        window.addEventListener('resize', onWindowResize);
        viewport.addEventListener('mousedown', onMouseDown);
        window.addEventListener('keydown', onKeyDown); 
        animate();
    }
    
    window.addShape = (type, existingData = null) => {
        let geometry, material, mesh;
        let color, position, script;

        if (existingData) {
            color = existingData.color;
            position = existingData.position;
            script = existingData.script;
        } else {
            color = Math.random() * 0xffffff;
            position = { x: (Math.random() - 0.5) * 4, y: 1.5, z: (Math.random() - 0.5) * 4 }; 
            script = "";
        }

        material = new THREE.MeshStandardMaterial({ color: color });
        if (type === 'cube') geometry = new THREE.BoxGeometry(1, 1, 1);
        else if (type === 'sphere') geometry = new THREE.SphereGeometry(0.6, 32, 16);
        else if (type === 'cylinder') geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
        
        mesh = new THREE.Mesh(geometry, material);
        mesh.position.set(position.x, position.y, position.z);
        mesh.name = "LunX_" + type + "_" + objects.length;
        mesh.userData = { script: script, compiled: null, type: type };

        if (script) applyScript(mesh, script);

        scene.add(mesh);
        objects.push(mesh);
        
        if(!existingData) selectObject(mesh);
    }

    window.clearScene = (showConfirm = true) => {
        if (showConfirm && !confirm("Tüm sahne silinecek! Emin misiniz?")) return;
        objects.forEach(obj => scene.remove(obj));
        objects = [];
        selectObject(null);
        log("Sahne temizlendi.");
    }

    // --- 6. KONTROL VE YARDIMCI FONKSİYONLAR ---

    function onKeyDown(event) {
        const key = event.key.toLowerCase();
        
        if (key === 'delete' && selectedObject) {
            if (confirm(`'${selectedObject.name}' nesnesini silmek istediğinize emin misiniz?`)) {
                scene.remove(selectedObject);
                objects = objects.filter(obj => obj !== selectedObject);
                selectObject(null);
                log("Nesne silindi.");
            }
        } 
        else if (key === 'q') { 
            transformControls.setMode("rotate");
            log("Gizmo modu: Çevirme (Rotate)");
        }
        else if (key === 'w') { 
            transformControls.setMode("translate");
            log("Gizmo modu: Taşıma (Translate)");
        }
        else if (key === 'e') { 
            transformControls.setMode("scale");
            log("Gizmo modu: Boyutlandırma (Scale)");
        }
    }

    function onMouseDown(event) {
        const viewport = document.getElementById('viewport');
        const rect = renderer.domElement.getBoundingClientRect();
        
        if (transformControls && transformControls.dragging) return;

        mouse.x = ((event.clientX - rect.left) / viewport.clientWidth) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / viewport.clientHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        
        const intersects = raycaster.intersectObjects(objects); 

        if (intersects.length > 0) {
            selectObject(intersects[0].object);
        } else if (transformControls && !transformControls.dragging) {
            selectObject(null); 
        }
    }
    
    function selectObject(obj) {
        if (selectedObject && selectedObject.material.emissive) selectedObject.material.emissive.setHex(0x000000);
        selectedObject = obj;
        updateUI();
        
        if (obj) {
            obj.material.emissive.setHex(0x333333);
            transformControls.attach(obj); 
            transformControls.setMode("translate"); 
        } else {
            if(transformControls) transformControls.detach(); 
        }
    }

    window.saveScript = () => {
        if (!selectedObject) return;
        const codeText = document.getElementById('code-editor').value;
        applyScript(selectedObject, codeText);
    }
    
    function applyScript(object, codeText) {
        object.userData.script = codeText;
        try {
            object.userData.compiled = new Function('object', 'time', codeText);
            log(object.name + " için script çalışıyor!");
        } catch (e) {
            log("Script Hatası: " + e.message);
            object.userData.compiled = null;
        }
    }

    function updateUI() { 
        const infoDiv = document.getElementById('object-info');
        const scriptPanel = document.getElementById('script-panel');
        const editor = document.getElementById('code-editor');
        if (selectedObject) {
            infoDiv.innerHTML = `<strong>${selectedObject.name}</strong><br>Pozisyon: x${selectedObject.position.x.toFixed(1)} y${selectedObject.position.y.toFixed(1)} z${selectedObject.position.z.toFixed(1)}`;
            scriptPanel.style.display = 'block';
            editor.value = selectedObject.userData.script || "";
        } else {
            infoDiv.innerHTML = "Seçili değil.";
            scriptPanel.style.display = 'none';
        }
    }
    function log(msg) { 
        const statusEl = document.getElementById('status');
        statusEl.innerText = msg; 
        console.log(msg); 
    }
    function onWindowResize() {
        const viewport = document.getElementById('viewport');
        camera.aspect = viewport.clientWidth / viewport.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
    }
    function animate() {
        requestAnimationFrame(animate);
        const time = performance.now();
        objects.forEach(obj => {
            if (obj.userData && obj.userData.compiled) {
                try { obj.userData.compiled(obj, time); } catch (err) {}
            }
        });
        controls.update();
        renderer.render(scene, camera);
        if (selectedObject) { updateUI(); }
    }

    window.onload = () => {
        showMainMenu();
        log("LunX Studio V0.2 hazır. Giriş yapın veya Kaydolun.");
    };
</script>
