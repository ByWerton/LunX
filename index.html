<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Ultimate Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #d32f2f; /* ƒ∞stenen Eski Kƒ±rmƒ±zƒ± */
            --primary-dark: #b71c1c;
            --bg-light: #f5f5f5;
            --bg-panel: #ffffff;
            --border: #e0e0e0;
            --text: #333;
            --header-h: 45px;
            --ribbon-h: 90px;
        }

        * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', sans-serif; outline: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: var(--bg-light); height: 100vh; display: flex; flex-direction: column; }
        
        /* Ba≈ülangƒ±√ß Ekranƒ± */
        #start-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #d32f2f, #ff8a80);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .template-container { display: flex; gap: 20px; margin-top:20px; }
        .template-card {
            background: white; color: #333; width: 140px; height: 160px; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition:0.2s;
        }
        .template-card:hover { transform: scale(1.05); }

        /* √úst Bar */
        #top-bar {
            height: var(--header-h); background: var(--primary); color: white; display: flex; align-items: center; padding: 0 10px;
            font-size: 14px; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #menu-btn { font-weight:bold; font-size:18px; margin-right:15px; cursor:pointer; padding:5px; }
        .tab-btn { padding: 0 15px; cursor: pointer; opacity: 0.8; height: 100%; display: flex; align-items: center; transition:0.2s; }
        .tab-btn:hover { background: rgba(255,255,255,0.2); opacity:1; }
        .tab-btn.active { background: rgba(0,0,0,0.2); font-weight: bold; opacity:1; border-bottom: 3px solid white; }

        /* Ribbon (Ara√ßlar) */
        #ribbon {
            height: var(--ribbon-h); background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display:flex; align-items:center; padding:0 10px; overflow-x: auto;
        }
        .tool-group { display: flex; gap: 5px; padding: 0 10px; border-right: 1px solid #eee; align-items: center; height:100%; }
        .r-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 60px; height: 70px; border-radius: 4px; cursor: pointer; color: #444; font-size:11px;
        }
        .r-btn:hover { background: #ffcdd2; color: var(--primary); }
        .r-btn.active { background: #ffCDD2; color: var(--primary-dark); border: 1px solid var(--primary); }
        .r-btn span { font-size: 22px; margin-bottom: 5px; }

        /* Ana D√ºzen */
        #layout { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* Sol Panel (Toolbox - Ba≈ülangƒ±√ßta Kapalƒ±) */
        #toolbox { 
            width: 220px; background: var(--bg-panel); border-right: 1px solid var(--border); 
            display: none; /* KAPALI BA≈ûLAR */
            flex-direction: column; 
        }
        .panel-head { background: #eee; padding: 8px; font-weight: bold; font-size: 12px; border-bottom: 1px solid #ddd; display:flex; justify-content:space-between; }
        #toolbox-items { flex:1; overflow-y:auto; padding:5px; display:grid; grid-template-columns:1fr 1fr; gap:5px; align-content:start; }
        .t-item { border:1px solid #eee; padding:5px; text-align:center; font-size:10px; cursor:pointer; border-radius:4px; display:flex; flex-direction:column; align-items:center; }
        .t-item:hover { border-color: var(--primary); background:#fafafa; }
        .t-color { width:30px; height:30px; border-radius:3px; margin-bottom:5px; border:1px solid #ccc; }

        /* Orta (Viewport) */
        #viewport { flex: 1; position: relative; background: #87CEEB; overflow: hidden; }

        /* Saƒü Panel (Properties) */
        #properties { width: 250px; background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        #explorer-list { height: 40%; overflow-y: auto; border-bottom: 1px solid #ddd; }
        #prop-list { flex: 1; overflow-y: auto; padding: 10px; }
        .prop-row { margin-bottom:8px; display:flex; align-items:center; font-size:11px; }
        .prop-lbl { width:80px; color:#666; }
        .prop-val { flex:1; padding:4px; border:1px solid #ccc; border-radius:2px; }
        .prop-btn { width:100%; padding:5px; background:var(--primary); color:white; border:none; cursor:pointer; margin-top:5px; border-radius:3px; }

        /* OYUN ARAY√úZ√ú (HUD) */
        #game-overlay { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 50; }
        #stop-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 8px 20px; font-weight: bold;
            border-radius: 4px; cursor: pointer; pointer-events: auto; border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.5); }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: white; border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 2px 5px black; }
        #jump-btn { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 80px; background: rgba(255,255,255,0.8); border-radius: 50%; border: 4px solid var(--primary); pointer-events: auto; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 900; font-size: 24px; transition:0.1s; }
        #jump-btn:active { transform: scale(0.9); background: white; }

        /* LunAIX Chat */
        #ai-modal {
            position: fixed; bottom: 20px; right: 20px; width: 350px; height: 400px;
            background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; flex-direction: column; z-index: 2000; border: 1px solid #ccc;
        }
        .ai-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; border-radius: 10px 10px 0 0; display:flex; justify-content:space-between; }
        .ai-content { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; font-size: 12px; }
        .ai-input-area { padding: 10px; border-top: 1px solid #ddd; display: flex; }
        .msg { padding: 8px 12px; border-radius: 15px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; }
        .msg.bot { background: white; border: 1px solid #ddd; color: #333; align-self: flex-start; }
        .msg.user { background: #ffcdd2; color: #b71c1c; margin-left: auto; }

        /* Script Edit√∂r Modal */
        #script-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none;
            align-items: center; justify-content: center;
        }
        #script-box { width: 70%; height: 70%; background: #222; border-radius: 8px; display: flex; flex-direction: column; border: 2px solid var(--primary); }
        #code-area { flex: 1; background: #1e1e1e; color: #0f0; font-family: monospace; padding: 10px; border: none; resize: none; }

    </style>
</head>
<body onload="App.init()">

    <div id="start-screen">
        <h1 style="font-size: 50px; margin: 0;">LunX Studio</h1>
        <p>Ultimate Edition (R6 & LunAIX)</p>
        <div class="template-container">
            <div class="template-card" onclick="World.load('baseplate')">
                <div style="font-size:30px">‚¨ú</div>
                <div>Baseplate</div>
            </div>
            <div class="template-card" onclick="World.load('grass')">
                <div style="font-size:30px">üå≥</div>
                <div>Grass</div>
            </div>
            <div class="template-card" onclick="World.load('village')">
                <div style="font-size:30px">üèòÔ∏è</div>
                <div>Village</div>
            </div>
        </div>
    </div>

    <div id="top-bar">
        <div id="menu-btn">‚ò∞</div>
        <div style="font-weight:bold; margin-right:20px; font-size:16px;">LunX Studio</div>
        <div class="tab-btn active">Home</div>
        <div class="tab-btn">Model</div>
        <div class="tab-btn">View</div>
    </div>

    <div id="ribbon">
        <div class="tool-group">
            <div class="r-btn active" onclick="Editor.setMode('select')" id="btn-select"><span>üëÜ</span>Se√ß</div>
            <div class="r-btn" onclick="Editor.setMode('translate')" id="btn-translate"><span>‚ÜîÔ∏è</span>Ta≈üƒ±</div>
            <div class="r-btn" onclick="Editor.setMode('scale')" id="btn-scale"><span>‚§°</span>Boyut</div>
            <div class="r-btn" onclick="Editor.setMode('rotate')" id="btn-rotate"><span>üîÑ</span>D√∂nd√ºr</div>
        </div>
        <div class="tool-group">
            <div class="r-btn" onclick="World.addPart({})"><span>üß±</span>Par√ßa</div>
            <div class="r-btn" onclick="UI.toggleToolbox()"><span>üß∞</span>Toolbox</div>
            <div class="r-btn" onclick="UI.toggleAI()"><span>ü§ñ</span>LunAIX</div>
            <div class="r-btn" onclick="Editor.delete()"><span>üóëÔ∏è</span>Sil</div>
        </div>
        <div class="tool-group" style="margin-left:auto; border:none;">
            <div class="r-btn" onclick="Game.play()" style="color:green;"><span>‚ñ∂</span>Oynat</div>
        </div>
    </div>

    <div id="layout">
        <div id="toolbox">
            <div class="panel-head">Toolbox <span style="cursor:pointer" onclick="UI.toggleToolbox()">‚úï</span></div>
            <div id="toolbox-items"></div>
        </div>

        <div id="viewport">
            <div id="game-overlay">
                <div id="stop-hud" onclick="Game.stop()">‚èπ DURDUR</div>
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>
        </div>

        <div id="properties">
            <div class="panel-head">Explorer</div>
            <div id="explorer-list"></div>
            <div class="panel-head">Properties</div>
            <div id="prop-list"></div>
        </div>
    </div>

    <div id="ai-modal">
        <div class="ai-header">
            <span>LunAIX Asistan</span>
            <span style="cursor:pointer" onclick="UI.toggleAI()">‚úï</span>
        </div>
        <div class="ai-content" id="chat-history">
            <div class="msg bot">Merhaba! Ben LunAIX. Hem sohbet edebilirim hem de in≈üa edebilirim. "Kƒ±rmƒ±zƒ± bir ev yap", "B√ºy√ºk mavi bir top olu≈ütur" diyebilirsin. Nasƒ±lsƒ±n?</div>
        </div>
        <div class="ai-input-area">
            <input type="text" id="ai-input" style="flex:1; padding:5px;" placeholder="Mesaj yaz..." onkeydown="if(event.key==='Enter') AI.send()">
            <button onclick="AI.send()" style="margin-left:5px;">G√∂nder</button>
        </div>
    </div>

    <div id="script-modal">
        <div id="script-box">
            <div style="padding:10px; color:white; font-weight:bold; border-bottom:1px solid #555; display:flex; justify-content:space-between;">
                <span>Script Editor</span>
                <span style="cursor:pointer" onclick="document.getElementById('script-modal').style.display='none'">‚úï</span>
            </div>
            <textarea id="code-area" spellcheck="false">print("Hello World")</textarea>
            <button onclick="UI.saveScript()" style="padding:10px; background:var(--primary); border:none; color:white; font-weight:bold; cursor:pointer">Kaydet</button>
        </div>
    </div>

    <script>
        // --- TEMEL MOTOR (Three.js & Cannon.js) ---
        const App = {
            scene: null, camera: null, renderer: null, controls: null, transform: null,
            clock: new THREE.Clock(),
            world: null, // Fizik
            objects: [], // Nesneler
            
            init: () => {
                const vp = document.getElementById('viewport');
                
                // Three.js Sahne
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0x87CEEB);
                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                App.camera.position.set(10, 10, 10);

                App.renderer = new THREE.WebGLRenderer({ antialias: true });
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                // I≈üƒ±klar
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(20, 50, 20);
                light.castShadow = true;
                light.shadow.mapSize.width = 2048; light.shadow.mapSize.height = 2048;
                App.scene.add(light);
                App.scene.add(new THREE.AmbientLight(0x404040));

                // Kontroller
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                
                // Gizmo s√ºr√ºklerken kamerayƒ± kitle, fiziƒüi g√ºncelle
                App.transform.addEventListener('dragging-changed', e => {
                    App.controls.enabled = !e.value;
                    if(!e.value && Editor.selected && Editor.selected.userData.body) {
                        // S√ºr√ºkleme bitince fiziksel hƒ±zƒ± sƒ±fƒ±rla
                        const body = Editor.selected.userData.body;
                        body.velocity.set(0,0,0);
                        body.angularVelocity.set(0,0,0);
                        World.updatePhysicsShape(Editor.selected);
                    }
                });
                // Gizmo hareket ederken g√∂rsel -> fizik senkronu (sadece static/kinematic i√ßin anlƒ±k, dynamic i√ßin loopta)
                App.transform.addEventListener('objectChange', () => {
                    if(Editor.selected && Editor.selected.userData.body) {
                        const m = Editor.selected;
                        const b = m.userData.body;
                        b.position.copy(m.position);
                        b.quaternion.copy(m.quaternion);
                    }
                });

                App.scene.add(App.transform);

                // Cannon Fizik
                App.world = new CANNON.World();
                App.world.gravity.set(0, -30, 0);
                App.world.broadphase = new CANNON.NaiveBroadphase();
                const mat = new CANNON.Material();
                const contactMat = new CANNON.ContactMaterial(mat, mat, { friction: 0.0, restitution: 0.1 });
                App.world.addContactMaterial(contactMat);

                window.addEventListener('resize', () => {
                    if(!vp) return;
                    App.camera.aspect = vp.clientWidth / vp.clientHeight;
                    App.camera.updateProjectionMatrix();
                    App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                });

                UI.init();
                Game.initInput();
                App.loop();
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = App.clock.getDelta();
                
                if(Game.active) {
                    Game.update(dt);
                    App.world.step(1/60, dt, 3);
                } else {
                    App.controls.update();
                }

                // Fizik -> G√∂rsel E≈üleme (Dinamik nesneler i√ßin)
                App.objects.forEach(obj => {
                    if(obj.userData.body && !obj.userData.anchored) {
                        obj.position.copy(obj.userData.body.position);
                        obj.quaternion.copy(obj.userData.body.quaternion);
                    }
                });

                App.renderer.render(App.scene, App.camera);
            }
        };

        // --- D√úNYA Y√ñNETƒ∞Mƒ∞ ---
        const World = {
            load: (type) => {
                document.getElementById('start-screen').style.display = 'none';
                
                // Zemin
                const color = type==='grass' ? 0x4CAF50 : (type==='village' ? 0x5DA130 : 0x9E9E9E);
                const floorGeo = new THREE.BoxGeometry(200, 2, 200);
                const floorMat = new THREE.MeshStandardMaterial({color: color});
                const floor = new THREE.Mesh(floorGeo, floorMat);
                floor.position.y = -1;
                floor.receiveShadow = true;
                floor.name = "Baseplate";
                floor.userData = { locked: true, anchored: true };
                App.scene.add(floor);
                
                // Fizik Zemin
                const floorShape = new CANNON.Box(new CANNON.Vec3(100, 1, 100));
                const floorBody = new CANNON.Body({ mass: 0 });
                floorBody.addShape(floorShape);
                floorBody.position.set(0, -1, 0);
                App.world.addBody(floorBody);

                // Spawn
                World.addPart({name:"SpawnLocation", shape:'cylinder', color:0x888888, scale:[4,0.5,4], anchored:true});

                if(type==='village') {
                    World.addPart({name:"House1", color:0xA1887F, scale:[6,6,6], pos:new THREE.Vector3(-10,3,0), anchored:true});
                    World.addPart({name:"House2", color:0xA1887F, scale:[6,6,6], pos:new THREE.Vector3(10,3,0), anchored:true});
                }
            },

            addPart: (cfg) => {
                const scale = cfg.scale || [4,4,4];
                let geo, shape;

                if(cfg.shape==='sphere') {
                    geo = new THREE.SphereGeometry(1,32,32);
                    shape = new CANNON.Sphere(Math.max(scale[0],scale[1],scale[2])/2);
                } else if(cfg.shape==='cylinder') {
                    geo = new THREE.CylinderGeometry(1,1,1,32);
                    shape = new CANNON.Cylinder(scale[0]/2, scale[0]/2, scale[1], 12);
                } else {
                    geo = new THREE.BoxGeometry(1,1,1);
                    shape = new CANNON.Box(new CANNON.Vec3(scale[0]/2, scale[1]/2, scale[2]/2));
                }
                
                const mat = new THREE.MeshStandardMaterial({
                    color: cfg.color || 0xd32f2f,
                    transparent: !!cfg.opacity,
                    opacity: cfg.opacity || 1
                });
                const mesh = new THREE.Mesh(geo, mat);
                
                mesh.scale.set(scale[0], scale[1], scale[2]);
                mesh.position.copy(cfg.pos || new THREE.Vector3(0, 5, 0));
                mesh.name = cfg.name || "Part";
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.userData = { 
                    anchored: cfg.anchored!==undefined ? cfg.anchored : false,
                    script: cfg.script || ""
                };

                const body = new CANNON.Body({
                    mass: mesh.userData.anchored ? 0 : 10,
                    shape: shape
                });
                body.position.copy(mesh.position);
                App.world.addBody(body);
                
                mesh.userData.body = body;
                App.scene.add(mesh);
                App.objects.push(mesh);
                
                UI.addToExplorer(mesh);
                return mesh;
            },

            updatePhysicsShape: (mesh) => {
                if(!mesh.userData.body) return;
                const b = mesh.userData.body;
                const s = mesh.scale;
                // Basit√ße ≈üekli g√ºncelle (Box i√ßin) - Sphere/Cylinder daha kompleks olabilir, demo i√ßin box varsayƒ±yoruz veya basit scale
                const shape = b.shapes[0];
                if(shape.type === CANNON.Shape.types.BOX) {
                    shape.halfExtents.set(s.x/2, s.y/2, s.z/2);
                } else if(shape.type === CANNON.Shape.types.SPHERE) {
                    shape.radius = Math.max(s.x, s.y, s.z)/2;
                }
                shape.updateBoundingSphereRadius();
                b.updateBoundingRadius();
                b.updateMassProperties();
            }
        };

        // --- LUNAIX (GELƒ∞≈ûMƒ∞≈û DOƒûAL YAPAY ZEKA) ---
        const AI = {
            send: () => {
                const inp = document.getElementById('ai-input');
                const txt = inp.value.trim();
                if(!txt) return;
                
                AI.addMsg(txt, 'user');
                inp.value = '';
                
                setTimeout(() => AI.process(txt), 800); // D√º≈ü√ºnme s√ºresi
            },
            
            addMsg: (txt, type) => {
                const div = document.createElement('div');
                div.className = 'msg ' + type;
                div.innerText = txt;
                const area = document.getElementById('chat-history');
                area.appendChild(div);
                area.scrollTop = area.scrollHeight;
            },

            // Doƒüal cevap √ºretici
            naturalResponse: (intent, detail) => {
                const phrases = {
                    build: [
                        `Hemen hallediyorum, i≈üte ${detail}.`,
                        `Anla≈üƒ±ldƒ±, sahneye ${detail} ekliyorum.`,
                        `ƒ∞n≈üaat ba≈ülƒ±yor... ${detail} hazƒ±r!`,
                        `Bunu yapmak benim i√ßin √ßocuk oyuncaƒüƒ±: ${detail}.`
                    ],
                    chat: [
                        `Sohbet etmek harika! Ba≈üka ne yapabiliriz?`,
                        `Ben sanal bir asistanƒ±m ama kodlarƒ±m ger√ßek. Sen nasƒ±lsƒ±n?`,
                        `LunX Studio'da her ≈üey m√ºmk√ºn. Yaratƒ±cƒ±lƒ±ƒüƒ±nƒ± kullan!`,
                        `Buradayƒ±m ve seni dinliyorum.`
                    ],
                    error: [
                        `Bunu tam anlayamadƒ±m, "Kƒ±rmƒ±zƒ± kutu yap" gibi deneyebilirsin.`,
                        `Hmm, bu komut veri tabanƒ±mda yok. Ba≈üka bir ≈üey dene istersen.`,
                        `Seni duydum ama ne yapmam gerektiƒüini √ß√∂zemedim.`
                    ]
                };
                const arr = phrases[intent] || phrases.error;
                return arr[Math.floor(Math.random() * arr.length)];
            },

            process: (txt) => {
                const l = txt.toLowerCase();
                let reply = "";
                
                // Anahtar kelimeler
                const isBuild = ['yap', 'olu≈ütur', 'in≈üa', 'build', 'create', 'koy', 'ekle'].some(k => l.includes(k));
                const isDelete = ['sil', 'kaldƒ±r', 'delete', 'yok et'].some(k => l.includes(k));
                
                if (isDelete && Editor.selected) {
                     Editor.delete();
                     reply = "Se√ßili nesneyi sildim. Tertemiz oldu!";
                } 
                else if (isBuild) {
                    // Parametre Analizi
                    let color = 0x999999;
                    let colorName = "gri";
                    if(l.includes('kƒ±rmƒ±zƒ±') || l.includes('red')) { color = 0xd32f2f; colorName="kƒ±rmƒ±zƒ±"; }
                    if(l.includes('mavi') || l.includes('blue')) { color = 0x1976D2; colorName="mavi"; }
                    if(l.includes('ye≈üil') || l.includes('green')) { color = 0x388E3C; colorName="ye≈üil"; }
                    if(l.includes('sarƒ±') || l.includes('yellow')) { color = 0xFBC02D; colorName="sarƒ±"; }
                    if(l.includes('siyah') || l.includes('black')) { color = 0x212121; colorName="siyah"; }
                    
                    let shape = 'box';
                    let objName = "kutu";
                    if(l.includes('top') || l.includes('k√ºre')) { shape = 'sphere'; objName="top"; }
                    if(l.includes('silindir')) { shape = 'cylinder'; objName="silindir"; }
                    
                    let scale = [4,4,4];
                    if(l.includes('b√ºy√ºk') || l.includes('kocaman')) scale = [10,10,10];
                    if(l.includes('k√º√ß√ºk') || l.includes('minik')) scale = [2,2,2];
                    if(l.includes('duvar')) { scale = [1, 8, 15]; objName="duvar"; }
                    if(l.includes('zemin')) { scale = [20, 1, 20]; objName="zemin"; }

                    // √ñzel Nesne: Ev
                    if(l.includes('ev') || l.includes('house')) {
                         const pos = new THREE.Vector3((Math.random()-0.5)*20, 4, (Math.random()-0.5)*20);
                         World.addPart({name:"DuvarSol", pos: pos.clone().add(new THREE.Vector3(-4,0,0)), scale:[1,6,8], color:0xd32f2f, anchored:true});
                         World.addPart({name:"DuvarSag", pos: pos.clone().add(new THREE.Vector3(4,0,0)), scale:[1,6,8], color:0xd32f2f, anchored:true});
                         World.addPart({name:"Cati", pos: pos.clone().add(new THREE.Vector3(0,4,0)), scale:[10,2,10], color:0x333, anchored:true});
                         reply = AI.naturalResponse('build', "g√ºzel bir ev");
                    } 
                    // √ñzel Nesne: Script Block
                    else if(l.includes('script') || l.includes('kod') || l.includes('√∂ld√ºren')) {
                        World.addPart({
                            name: "KillBlock",
                            color: 0xFF0000,
                            scale: scale,
                            anchored: true,
                            script: `-- Kill Script\nprint("Bu blok oldurucudur")`
                        });
                        reply = AI.naturalResponse('build', "kodlu bir √∂ld√ºr√ºc√º blok");
                    }
                    else {
                        World.addPart({
                            name: "LunAIX_" + objName,
                            color: color,
                            shape: shape,
                            scale: scale,
                            anchored: false,
                            pos: new THREE.Vector3((Math.random()-0.5)*10, 5, (Math.random()-0.5)*10)
                        });
                        reply = AI.naturalResponse('build', `${colorName} bir ${objName}`);
                    }
                } else {
                    // Sohbet
                    if(l.includes('merhaba') || l.includes('selam')) reply = "Selam! Seni g√∂rmek g√ºzel. Bug√ºn ne in≈üa ediyoruz?";
                    else if(l.includes('nasƒ±lsƒ±n')) reply = "Kodlarƒ±m tƒ±kƒ±rƒ±nda √ßalƒ±≈üƒ±yor, te≈üekk√ºrler! Sen nasƒ±lsƒ±n?";
                    else if(l.includes('ne yapabilirsin')) reply = "Ben LunAIX, senin ki≈üisel asistanƒ±nƒ±m. 'Kƒ±rmƒ±zƒ± bir top yap' de, hemen yapayƒ±m!";
                    else reply = AI.naturalResponse('error', null);
                }

                AI.addMsg(reply, 'bot');
            }
        };

        // --- OYUN VE R6 KARAKTER ---
        const Game = {
            active: false,
            player: null,
            body: null,
            inputs: { x:0, y:0 },
            limbs: {},
            
            initInput: () => {
                // Joystick
                const zone = document.getElementById('joystick-zone');
                const stick = document.getElementById('stick');
                let drag = false;
                
                const moveStick = (cx, cy) => {
                    const rect = zone.getBoundingClientRect();
                    const cx0 = rect.left + rect.width/2;
                    const cy0 = rect.top + rect.height/2;
                    const dx = cx - cx0; const dy = cy - cy0;
                    const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                    const a = Math.atan2(dy, dx);
                    const x = Math.cos(a)*d; const y = Math.sin(a)*d;
                    stick.style.transform = `translate(${x}px, ${y}px)`;
                    Game.inputs.x = x/40; Game.inputs.y = y/40;
                };

                zone.addEventListener('pointerdown', e => { drag=true; zone.setPointerCapture(e.pointerId); moveStick(e.clientX, e.clientY); });
                zone.addEventListener('pointermove', e => { if(drag) moveStick(e.clientX, e.clientY); });
                zone.addEventListener('pointerup', () => { 
                    drag=false; stick.style.transform = `translate(0,0)`; Game.inputs={x:0,y:0}; 
                });

                // Zƒ±plama
                document.getElementById('jump-btn').addEventListener('pointerdown', () => {
                    if(Game.body && Math.abs(Game.body.velocity.y) < 0.5) Game.body.velocity.y = 15;
                });

                // Klavye Desteƒüi (Ekstra)
                window.addEventListener('keydown', e => {
                    if(e.key==='w') Game.inputs.y = 1;
                    if(e.key==='s') Game.inputs.y = -1;
                    if(e.key==='a') Game.inputs.x = -1;
                    if(e.key==='d') Game.inputs.x = 1;
                    if(e.key===' ') if(Game.body && Math.abs(Game.body.velocity.y) < 0.5) Game.body.velocity.y = 15;
                });
                window.addEventListener('keyup', e => {
                    if(e.key==='w' || e.key==='s') Game.inputs.y = 0;
                    if(e.key==='a' || e.key==='d') Game.inputs.x = 0;
                });
            },

            spawnR6: () => {
                const rig = new THREE.Group(); rig.name = "Player";
                // Klasik Roblox Renkleri
                const matHead = new THREE.MeshStandardMaterial({color: 0xFBC02D}); // Sarƒ±
                const matTorso = new THREE.MeshStandardMaterial({color: 0x1976D2}); // Mavi
                const matLegs = new THREE.MeshStandardMaterial({color: 0x4CAF50}); // Ye≈üil

                const head = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), matHead); head.position.y = 1.5;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), matTorso); torso.position.y = 0;
                const la = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matHead); la.position.set(-1.5, 0, 0);
                const ra = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matHead); ra.position.set(1.5, 0, 0);
                const ll = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matLegs); ll.position.set(-0.5, -2, 0);
                const rl = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), matLegs); rl.position.set(0.5, -2, 0);

                // Y√ºz (Basit)
                const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
                const ctx = canvas.getContext('2d'); ctx.fillStyle='black';
                ctx.fillRect(15,20,10,10); ctx.fillRect(39,20,10,10); ctx.fillRect(20,45,24,5);
                const face = new THREE.Mesh(new THREE.PlaneGeometry(0.8,0.8), new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(canvas), transparent:true}));
                face.position.set(0, 1.5, 0.51);

                rig.add(head, torso, la, ra, ll, rl, face);
                
                let pos = new THREE.Vector3(0,5,0);
                const spawn = App.scene.getObjectByName("SpawnLocation");
                if(spawn) pos.copy(spawn.position).add(new THREE.Vector3(0,3,0));

                const body = new CANNON.Body({ mass: 50, fixedRotation: true });
                body.addShape(new CANNON.Cylinder(1, 1, 4, 12), new CANNON.Vec3(0,-0.5,0));
                body.position.copy(pos);
                body.linearDamping = 0.9;
                App.world.addBody(body);

                App.scene.add(rig);
                Game.player = rig;
                Game.body = body;
                Game.limbs = { la, ra, ll, rl };
            },

            play: () => {
                if(Game.active) return;
                Game.active = true;
                Editor.select(null); // Se√ßimi kaldƒ±r
                
                document.getElementById('ribbon').style.display = 'none';
                document.getElementById('properties').style.display = 'none';
                document.getElementById('toolbox').style.display = 'none'; // Toolbox kapanƒ±r
                document.getElementById('game-overlay').style.display = 'block';

                App.controls.enablePan = false;
                App.controls.enableZoom = true; // Zoom serbest
                
                Game.spawnR6();
            },

            stop: () => {
                Game.active = false;
                
                document.getElementById('ribbon').style.display = 'flex';
                document.getElementById('properties').style.display = 'flex';
                // Toolbox kapalƒ± kalƒ±r, kullanƒ±cƒ± isterse a√ßar
                document.getElementById('game-overlay').style.display = 'none';

                if(Game.player) { App.scene.remove(Game.player); Game.player=null; }
                if(Game.body) { App.world.removeBody(Game.body); Game.body=null; }

                App.controls.enablePan = true;
                App.camera.position.set(10,10,10);
                App.controls.target.set(0,0,0);
            },

            update: (dt) => {
                if(!Game.player || !Game.body) return;
                
                Game.player.position.copy(Game.body.position);
                
                const speed = 20;
                const camDir = new THREE.Vector3(); App.camera.getWorldDirection(camDir); camDir.y=0; camDir.normalize();
                const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x);
                
                const move = new THREE.Vector3();
                move.add(camRight.multiplyScalar(Game.inputs.x));
                move.add(camDir.multiplyScalar(-Game.inputs.y));

                if(move.length() > 0.1) {
                    move.normalize().multiplyScalar(speed);
                    Game.body.velocity.x = move.x;
                    Game.body.velocity.z = move.z;

                    const angle = Math.atan2(move.x, move.z);
                    Game.player.rotation.y = angle;

                    // R6 Y√ºr√ºme Animasyonu
                    const t = Date.now() * 0.015;
                    Game.limbs.la.rotation.x = Math.sin(t);
                    Game.limbs.ra.rotation.x = -Math.sin(t);
                    Game.limbs.ll.rotation.x = -Math.sin(t);
                    Game.limbs.rl.rotation.x = Math.sin(t);
                } else {
                    Game.body.velocity.x *= 0.5;
                    Game.body.velocity.z *= 0.5;
                    Game.limbs.la.rotation.x = 0; Game.limbs.ra.rotation.x = 0;
                    Game.limbs.ll.rotation.x = 0; Game.limbs.rl.rotation.x = 0;
                }
                App.controls.target.copy(Game.player.position);
            }
        };

        // --- UI YARDIMCILARI ---
        const UI = {
            init: () => {
                const list = document.getElementById('toolbox-items');
                const items = [
                    {n:'Par√ßa', c:0xeeeeee}, {n:'Duvar', c:0xd32f2f},
                    {n:'Top', c:0x2196F3}, {n:'Silindir', c:0xFFEB3B},
                    {n:'Zemin', c:0x4CAF50}, {n:'KillBrick', c:0xFF0000}
                ];
                items.forEach(i => {
                    const el = document.createElement('div'); el.className='t-item';
                    el.innerHTML = `<div class="t-color" style="background:#${i.c.toString(16)}"></div>${i.n}`;
                    el.onclick = () => {
                        if(i.n==='KillBrick') {
                            World.addPart({name:'KillBrick', color:0xff0000, anchored:true, script:'-- Kill'});
                        } else {
                            const s = i.n==='Top'?'sphere':i.n==='Silindir'?'cylinder':'box';
                            const sc = i.n==='Duvar'?[1,6,8]:(i.n==='Zemin'?[20,1,20]:[4,4,4]);
                            World.addPart({name:i.n, color:i.c, shape:s, scale:sc, anchored:true});
                        }
                    };
                    list.appendChild(el);
                });
            },
            addToExplorer: (mesh) => {
                const list = document.getElementById('explorer-list');
                const el = document.createElement('div');
                el.style.padding = '4px'; el.style.fontSize='11px'; el.style.cursor='pointer'; el.style.borderBottom='1px solid #eee';
                el.innerText = 'üì¶ ' + mesh.name;
                el.onclick = () => Editor.select(mesh);
                list.appendChild(el);
            },
            toggleAI: () => {
                const el = document.getElementById('ai-modal');
                el.style.display = el.style.display==='flex' ? 'none' : 'flex';
            },
            toggleToolbox: () => {
                const el = document.getElementById('toolbox');
                el.style.display = el.style.display==='flex' ? 'none' : 'flex';
                setTimeout(() => { if(App.renderer) App.renderer.setSize(document.getElementById('viewport').clientWidth, document.body.clientHeight - 90); }, 100);
            },
            saveScript: () => {
                if(window.scriptObj) window.scriptObj.userData.script = document.getElementById('code-area').value;
                document.getElementById('script-modal').style.display = 'none';
            }
        };

        // --- EDƒ∞T√ñR ---
        const Editor = {
            selected: null,
            setMode: (m) => {
                App.transform.setMode(m);
                document.querySelectorAll('.r-btn').forEach(b=>b.classList.remove('active'));
                const btn = document.getElementById('btn-'+m);
                if(btn) btn.classList.add('active');
            },
            select: (mesh) => {
                if(mesh && mesh.userData.locked) return;
                Editor.selected = mesh;
                
                if(!mesh) {
                    App.transform.detach();
                    document.getElementById('prop-list').innerHTML = '<div style="color:#999; text-align:center">Se√ßim yok</div>';
                    return;
                }
                
                App.transform.attach(mesh);
                // √ñzellikleri G√∂ster
                const p = document.getElementById('prop-list');
                p.innerHTML = `
                    <div class="prop-row"><div class="prop-lbl">ƒ∞sim</div><input class="prop-val" value="${mesh.name}" onchange="Editor.selected.name=this.value"></div>
                    <div class="prop-row"><div class="prop-lbl">Sabit</div><input type="checkbox" ${mesh.userData.anchored?'checked':''} onchange="Editor.toggleAnchor(this.checked)"></div>
                    <div class="prop-row"><div class="prop-lbl">Renk</div><input type="color" value="#${mesh.material.color.getHexString()}" onchange="Editor.selected.material.color.set(this.value)"></div>
                    <button class="prop-btn" onclick="Editor.openScript()">üìú Script D√ºzenle</button>
                `;
            },
            toggleAnchor: (val) => {
                if(!Editor.selected) return;
                Editor.selected.userData.anchored = val;
                const b = Editor.selected.userData.body;
                if(val) { b.mass = 0; b.type = CANNON.Body.STATIC; b.velocity.set(0,0,0); }
                else { b.mass = 10; b.type = CANNON.Body.DYNAMIC; b.wakeUp(); }
                b.updateMassProperties();
            },
            openScript: () => {
                if(!Editor.selected) return;
                window.scriptObj = Editor.selected;
                document.getElementById('code-area').value = Editor.selected.userData.script || 'print("Hello")';
                document.getElementById('script-modal').style.display = 'flex';
            },
            delete: () => {
                if(!Editor.selected) return;
                // Fizik sil
                App.world.removeBody(Editor.selected.userData.body);
                // G√∂rsel sil
                App.scene.remove(Editor.selected);
                App.transform.detach();
                Editor.selected = null;
                document.getElementById('prop-list').innerHTML = '';
            }
        };

    </script>
</body>
</html>
