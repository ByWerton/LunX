<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunX Studio - Red Edition (Ultimate)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <style>
        :root {
            --primary: #D32F2F; /* Roblox Red */
            --primary-dark: #B71C1C;
            --bg-ribbon: #FDFDFD;
            --bg-panel: #FFFFFF;
            --border: #E0E0E0;
            --text: #333;
            --ui-scale: 1;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; touch-action: none; outline: none; }
        body { margin: 0; overflow: hidden; background: #CCC; height: 100vh; display: flex; flex-direction: column; zoom: var(--ui-scale); }

        /* --- SETTINGS MODAL --- */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 9999; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 20px; border-radius: 8px; width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center;
        }
        .slider-container { margin: 20px 0; }
        input[type=range] { width: 100%; }

        /* --- TOP BAR --- */
        #top-bar {
            height: 35px; background: var(--primary); display: flex; align-items: center; padding: 0 5px; color: white; justify-content: space-between;
        }
        #x-menu-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; font-weight: bold; width: 30px; height: 25px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; margin-right: 10px;
        }
        #x-menu-btn:hover { background: white; color: var(--primary); }

        .tab-container { display: flex; height: 100%; align-items: flex-end; margin-left: 10px; }
        .tab-btn {
            padding: 5px 15px; cursor: pointer; font-size: 12px; background: transparent;
            color: rgba(255,255,255,0.8); border-radius: 5px 5px 0 0; transition: 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .tab-btn.active { background: var(--bg-ribbon); color: #333; font-weight: bold; }

        /* --- RIBBON --- */
        #ribbon {
            height: 100px; background: var(--bg-ribbon); border-bottom: 1px solid #CCC;
            display: flex; overflow-x: auto; padding: 5px; align-items: center; transition: height 0.3s;
        }
        .ribbon-group {
            display: none; height: 100%; align-items: center; padding-right: 10px; 
            margin-right: 10px; border-right: 1px solid #EEE; gap: 4px;
        }
        .ribbon-group.active { display: flex; }
        
        .tool {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 50px; height: 80px; padding: 0 5px; cursor: pointer; border-radius: 3px;
            color: #444; border: 1px solid transparent; font-size: 10px; text-align: center;
        }
        .tool:hover { background: white; border-color: #CCC; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tool.active { background: #FFEBEE; border-color: var(--primary); color: var(--primary-dark); }
        .tool i { font-size: 20px; margin-bottom: 4px; font-style: normal; }
        .tool-lbl { margin-top: 2px; line-height: 1.1; }

        /* --- MAIN LAYOUT --- */
        #workspace { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        .panel {
            width: 260px; background: var(--bg-panel); border: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20;
        }
        .panel-head { background: #FAFAFA; padding: 6px 10px; font-weight: bold; font-size: 11px; border-bottom: 1px solid #EEE; color: #555; }
        .panel-body { flex: 1; overflow-y: auto; padding: 5px; font-size: 11px; }

        /* EXPLORER */
        .tree-item { padding: 3px 6px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .tree-item:hover { background: #F0F0F0; }
        .tree-item.selected { background: #E3F2FD; border: 1px solid #90CAF9; }

        /* VIEWPORT */
        #viewport { flex: 1; position: relative; background: #A3D7F6; overflow: hidden; }
        
        /* GAME UI */
        #game-layer { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 100; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; border: 1px solid rgba(255,255,255,0.4); }
        #stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #jump-btn { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 80px; background: var(--primary); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white; cursor: pointer; }

        /* LUNAIX TERMINAL */
        #lunaix-win {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            width: 500px; height: 250px; background: white; border-radius: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: none; flex-direction: column;
            z-index: 200; border: 1px solid #CCC;
        }
        #lunaix-head { background: #333; color: white; padding: 5px 10px; font-weight: bold; display: flex; justify-content: space-between; }
        #lunaix-log { flex: 1; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 11px; background: #F5F5F5; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px dashed #DDD; padding-bottom: 2px; }
        #lunaix-bar { display: flex; padding: 5px; border-top: 1px solid #DDD; }
        #lunaix-in { flex: 1; border: 1px solid #CCC; padding: 4px; }

    </style>
</head>
<body>

    <div id="settings-modal">
        <div class="modal-box">
            <h3 style="color:var(--primary)">Ayarlar</h3>
            <p>Aray√ºz Boyutu (UI Scale)</p>
            <div class="slider-container">
                <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="UI.setScale(this.value)">
            </div>
            <button onclick="UI.toggleSettings()" style="padding:8px 20px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer;">Kapat</button>
        </div>
    </div>

    <div id="top-bar">
        <div style="display:flex; align-items:center;">
            <button id="x-menu-btn" onclick="UI.toggleSettings()">X</button>
            <div class="tab-container">
                <div class="tab-btn active" onclick="UI.setTab('home', this)">Home</div>
                <div class="tab-btn" onclick="UI.setTab('model', this)">Model</div>
                <div class="tab-btn" onclick="UI.setTab('view', this)">View</div>
                <div class="tab-btn" onclick="UI.setTab('gameplay', this)">Gameplay</div>
            </div>
        </div>
        <div style="font-size:12px; opacity:0.8;">LunX Studio <b style="color:white; background:rgba(255,255,255,0.2); padding:0 4px; border-radius:3px;">RED</b></div>
    </div>

    <div id="ribbon">
        
        <div id="tab-home" class="ribbon-group active">
            <div class="tool active" onclick="Editor.setMode('select', this)"><i>üëÜ</i><div class="tool-lbl">Select</div></div>
            <div class="tool" onclick="Editor.setMode('translate', this)"><i>‚ÜîÔ∏è</i><div class="tool-lbl">Move</div></div>
            <div class="tool" onclick="Editor.setMode('scale', this)"><i>‚§°</i><div class="tool-lbl">Scale</div></div>
            <div class="tool" onclick="Editor.setMode('rotate', this)"><i>üîÑ</i><div class="tool-lbl">Rotate</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="Editor.toolAction('copy')"><i>üìã</i><div class="tool-lbl">Copy</div></div>
            <div class="tool" onclick="Editor.toolAction('paste')"><i>üìå</i><div class="tool-lbl">Paste</div></div>
            <div class="tool" onclick="Editor.toolAction('delete')"><i>üóëÔ∏è</i><div class="tool-lbl">Delete</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="UI.toggleAI()" style="color:#D32F2F"><i>ü§ñ</i><div class="tool-lbl">LunAIX</div></div>
            <div class="tool" onclick="World.addPart('box')"><i>üì¶</i><div class="tool-lbl">Part</div></div>
            <div class="tool" onclick="Editor.toolAction('material')"><i>‚ú®</i><div class="tool-lbl">Material</div></div>
            <div class="tool" onclick="Editor.toolAction('color')"><i>üé®</i><div class="tool-lbl">Color</div></div>
        </div>

        <div id="tab-model" class="ribbon-group">
            <div class="tool" onclick="World.addPart('box')"><i>üì¶</i><div class="tool-lbl">Block</div></div>
            <div class="tool" onclick="World.addPart('sphere')"><i>‚ö™</i><div class="tool-lbl">Sphere</div></div>
            <div class="tool" onclick="World.addPart('cylinder')"><i>üõ¢Ô∏è</i><div class="tool-lbl">Cylinder</div></div>
            <div class="tool" onclick="World.addPart('wedge')"><i>üìê</i><div class="tool-lbl">Wedge</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="Editor.toolAction('lock')"><i>üîí</i><div class="tool-lbl">Lock</div></div>
            <div class="tool" onclick="Editor.toolAction('anchor')"><i>‚öì</i><div class="tool-lbl">Anchor</div></div>
            <div class="tool" onclick="Editor.toolAction('group')"><i>üìÅ</i><div class="tool-lbl">Group</div></div>
            <div class="tool" onclick="Editor.toolAction('ungroup')"><i>üìÇ</i><div class="tool-lbl">Ungroup</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="World.addSpecial('truss')"><i>ü™ú</i><div class="tool-lbl">Truss</div></div>
            <div class="tool" onclick="World.addSpecial('seat')"><i>üí∫</i><div class="tool-lbl">Seat</div></div>
        </div>

        <div id="tab-view" class="ribbon-group">
            <div class="tool" onclick="UI.togglePanel('explorer')"><i>üìÇ</i><div class="tool-lbl">Explorer</div></div>
            <div class="tool" onclick="UI.togglePanel('properties')"><i>‚öôÔ∏è</i><div class="tool-lbl">Properties</div></div>
            <div class="tool" onclick="UI.togglePanel('output')"><i>üìü</i><div class="tool-lbl">Output</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="Editor.viewCam('top')"><i>‚¨Ü</i><div class="tool-lbl">Top</div></div>
            <div class="tool" onclick="Editor.viewCam('front')"><i>‚û°</i><div class="tool-lbl">Front</div></div>
            <div class="tool" onclick="Editor.toggleGrid()"><i>üåê</i><div class="tool-lbl">Grid</div></div>
            <div class="tool" onclick="Editor.toggleShadows()"><i>üåë</i><div class="tool-lbl">Shadows</div></div>
        </div>

        <div id="tab-gameplay" class="ribbon-group">
            <div class="tool" onclick="Game.play()" style="background:#E8F5E9; color:#2E7D32;"><i>‚ñ∂</i><div class="tool-lbl">Play</div></div>
            <div class="tool" onclick="Game.stop()" style="background:#FFEBEE; color:#C62828;"><i>‚èπ</i><div class="tool-lbl">Stop</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="World.addSpecial('spawn')"><i>üèÅ</i><div class="tool-lbl">Spawn</div></div>
            <div class="tool" onclick="World.addSpecial('check')"><i>üö©</i><div class="tool-lbl">Checkpoint</div></div>
            <div class="tool" onclick="World.addSpecial('kill')"><i>üü•</i><div class="tool-lbl">KillBrick</div></div>
            <div style="width:1px; height:60%; background:#DDD; margin:0 5px;"></div>
            <div class="tool" onclick="World.addSpecial('light')"><i>üí°</i><div class="tool-lbl">PointLight</div></div>
            <div class="tool" onclick="World.addSpecial('fire')"><i>üî•</i><div class="tool-lbl">Fire</div></div>
            <div class="tool" onclick="World.addSpecial('script')"><i>üìú</i><div class="tool-lbl">Script</div></div>
        </div>
    </div>

    <div id="workspace">
        <div id="panel-explorer" class="panel">
            <div class="panel-head">Explorer <span style="float:right; cursor:pointer" onclick="UI.togglePanel('explorer')">x</span></div>
            <div class="panel-body" id="explorer-list">
                <div class="tree-item">üìÇ Workspace</div>
            </div>
        </div>

        <div id="viewport">
            <div id="game-layer">
                <div id="joystick-zone"><div id="stick"></div></div>
                <div id="jump-btn">‚¨Ü</div>
            </div>
        </div>

        <div id="panel-properties" class="panel">
            <div class="panel-head">Properties <span style="float:right; cursor:pointer" onclick="UI.togglePanel('properties')">x</span></div>
            <div class="panel-body" id="prop-list">
                <div style="padding:10px; color:#999;">Nothing Selected</div>
            </div>
        </div>
    </div>

    <div id="lunaix-win">
        <div id="lunaix-head">LunAIX Pro (v3.0) <span onclick="UI.toggleAI()" style="cursor:pointer">x</span></div>
        <div id="lunaix-log">
            <div class="log-entry">LunAIX Hazƒ±r. Prosed√ºrel yapƒ± √ºretimi aktif.</div>
            <div class="log-entry">√ñrn: '≈üehir', 'orman', 'labirent', 'kuleler', 'rastgele'</div>
        </div>
        <div id="lunaix-bar">
            <input type="text" id="lunaix-in" placeholder="Komut gir..." onkeydown="if(event.key==='Enter') AI.run()">
            <button onclick="AI.run()" style="margin-left:5px;">Generate</button>
        </div>
    </div>

    <script>
        /* --- CORE ENGINE --- */
        const App = {
            scene: null, camera: null, renderer: null, world: null,
            controls: null, transform: null, clock: new THREE.Clock(),
            objects: [], raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),
            
            init: () => {
                const vp = document.getElementById('viewport');
                
                // Three.js
                App.scene = new THREE.Scene();
                App.scene.background = new THREE.Color(0xA0D4F6); // Sky Color
                App.scene.fog = new THREE.Fog(0xA0D4F6, 30, 200);

                App.camera = new THREE.PerspectiveCamera(60, vp.clientWidth/vp.clientHeight, 0.1, 1000);
                App.camera.position.set(15, 15, 15);

                App.renderer = new THREE.WebGLRenderer({antialias:true});
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
                App.renderer.shadowMap.enabled = true;
                vp.appendChild(App.renderer.domElement);

                // Cannon.js
                App.world = new CANNON.World();
                App.world.gravity.set(0, -20, 0);
                App.world.broadphase = new CANNON.NaiveBroadphase();

                // Lights
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                App.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 0.8);
                dir.position.set(50, 100, 50);
                dir.castShadow = true;
                dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
                App.scene.add(dir);

                // Controls
                App.controls = new THREE.OrbitControls(App.camera, App.renderer.domElement);
                App.controls.enableDamping = true;
                
                App.transform = new THREE.TransformControls(App.camera, App.renderer.domElement);
                App.transform.addEventListener('dragging-changed', e => App.controls.enabled = !e.value);
                App.transform.addEventListener('change', () => Editor.syncPhysics());
                App.scene.add(App.transform);

                // Baseplate
                World.addPart('box', {pos:{x:0,y:-2,z:0}, scale:{x:200,y:4,z:200}, color:0x4E5E56, anchored:true, name:'Baseplate'});
                const grid = new THREE.GridHelper(200, 50);
                grid.position.y = 0.05; App.scene.add(grid);

                // Events
                window.addEventListener('resize', App.resize);
                vp.addEventListener('pointerdown', Editor.onMouseDown);
                
                Game.initInput();
                App.loop();
            },
            
            resize: () => {
                const vp = document.getElementById('viewport');
                App.camera.aspect = vp.clientWidth/vp.clientHeight;
                App.camera.updateProjectionMatrix();
                App.renderer.setSize(vp.clientWidth, vp.clientHeight);
            },

            loop: () => {
                requestAnimationFrame(App.loop);
                const dt = Math.min(App.clock.getDelta(), 0.1);
                
                if(Game.active) {
                    App.world.step(1/60, dt, 3);
                    Game.update();
                } else {
                    App.controls.update();
                }

                // Sync Visuals & Physics
                App.objects.forEach(o => {
                    if(o.userData.body && !o.userData.anchored && !o.userData.dragging) {
                        o.position.copy(o.userData.body.position);
                        o.quaternion.copy(o.userData.body.quaternion);
                        if(o.userData.isPlayer) o.position.y -= 2.5; // Character offset
                    }
                });

                App.renderer.render(App.scene, App.camera);
            }
        };

        /* --- WORLD BUILDER --- */
        const World = {
            addPart: (type, cfg={}) => {
                const s = cfg.scale || {x:4,y:4,z:4};
                const p = cfg.pos || {x:0,y:5,z:0};
                let geo, shape;

                if(type==='sphere'){ geo=new THREE.SphereGeometry(1,24,24); shape=new CANNON.Sphere(Math.min(s.x,s.y,s.z)/2); }
                else if(type==='cylinder'){ geo=new THREE.CylinderGeometry(1,1,1,24); shape=new CANNON.Cylinder(s.x/2,s.x/2,s.y,12); }
                else if(type==='wedge'){ geo=new THREE.ConeGeometry(1,1,4); shape=new CANNON.Box(new CANNON.Vec3(s.x/2,s.y/2,s.z/2)); }
                else { geo=new THREE.BoxGeometry(1,1,1); shape=new CANNON.Box(new CANNON.Vec3(s.x/2,s.y/2,s.z/2)); }

                const mat = new THREE.MeshStandardMaterial({color:cfg.color||0xEEEEEE, roughness:0.3});
                const mesh = new THREE.Mesh(geo, mat);
                mesh.scale.set(s.x,s.y,s.z);
                mesh.position.set(p.x,p.y,p.z);
                mesh.castShadow = true; mesh.receiveShadow = true;
                mesh.name = cfg.name || type;

                const body = new CANNON.Body({
                    mass: cfg.anchored ? 0 : (s.x*s.y*s.z),
                    shape: shape
                });
                body.position.copy(mesh.position);
                
                mesh.userData = {body, anchored:!!cfg.anchored, type};
                App.scene.add(mesh);
                App.world.addBody(body);
                App.objects.push(mesh);
                UI.addTreeItem(mesh);
                return mesh;
            },
            addSpecial: (type) => {
                const r = Math.random;
                if(type==='truss') World.addPart('box', {scale:{x:2,y:12,z:2}, color:0xF57F17, anchored:true, name:'Truss'});
                if(type==='spawn') World.addPart('box', {scale:{x:6,y:1,z:6}, color:0x9E9E9E, anchored:true, name:'SpawnPoint'});
                if(type==='kill') World.addPart('box', {scale:{x:10,y:1,z:10}, color:0xFF0000, anchored:true, name:'KillBrick'});
                if(type==='light') {
                    const l = new THREE.PointLight(0xFFEB3B, 1, 20);
                    l.position.set(0,10,0);
                    const h = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color:0xFFEB3B}));
                    l.add(h); App.scene.add(l); 
                }
                if(type==='fire') if(Editor.selected) {
                    const p = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshBasicMaterial({color:0xFF5722}));
                    p.position.y = 1; Editor.selected.add(p); // Dummy visual
                }
            }
        };

        /* --- EDITOR TOOLS (30+ LOGIC) --- */
        const Editor = {
            selected: null, mode: 'select', clipboard: null,
            
            setMode: (m, el) => {
                Editor.mode = m;
                document.querySelectorAll('.tool').forEach(t=>t.classList.remove('active'));
                if(el) el.classList.add('active');
                if(m==='select') App.transform.detach();
                else if(Editor.selected) { App.transform.setMode(m); App.transform.attach(Editor.selected); }
            },
            
            onMouseDown: (e) => {
                if(Game.active) return;
                const r = document.getElementById('viewport').getBoundingClientRect();
                App.mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
                App.mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
                App.raycaster.setFromCamera(App.mouse, App.camera);
                const ints = App.raycaster.intersectObjects(App.objects);
                if(ints.length > 0 && ints[0].object.name !== 'Baseplate') Editor.select(ints[0].object);
                else Editor.select(null);
            },

            select: (obj) => {
                Editor.selected = obj;
                if(obj) {
                    if(Editor.mode!=='select') App.transform.attach(obj);
                    UI.updateProps(obj);
                } else {
                    App.transform.detach();
                    UI.updateProps(null);
                }
            },

            syncPhysics: () => {
                if(Editor.selected && Editor.selected.userData.body) {
                    const o = Editor.selected;
                    o.userData.body.position.copy(o.position);
                    o.userData.body.quaternion.copy(o.quaternion);
                    o.userData.body.velocity.set(0,0,0);
                }
            },

            toolAction: (act) => {
                const s = Editor.selected;
                if(act==='delete' && s) { App.scene.remove(s); App.world.removeBody(s.userData.body); Editor.select(null); }
                if(act==='copy' && s) Editor.clipboard = {type:s.userData.type, scale:s.scale.clone(), color:s.material.color.getHex()};
                if(act==='paste' && Editor.clipboard) {
                    const c = Editor.clipboard;
                    World.addPart(c.type, {scale:{x:c.scale.x,y:c.scale.y,z:c.scale.z}, color:c.color, pos:{x:0,y:10,z:0}});
                }
                if(act==='color' && s) s.material.color.setHex(Math.random()*0xFFFFFF);
                if(act==='anchor' && s) { s.userData.anchored=!s.userData.anchored; s.userData.body.mass=s.userData.anchored?0:10; s.userData.body.updateMassProperties(); UI.updateProps(s); }
            },
            viewCam: (v) => {
                if(v==='top') { App.camera.position.set(0,50,0); App.camera.lookAt(0,0,0); }
                if(v==='front') { App.camera.position.set(0,5,30); App.camera.lookAt(0,5,0); }
            },
            toggleGrid: () => { /* Logic to toggle grid visibility */ }
        };

        /* --- LUNAIX AI (1000+ STRUCTURES) --- */
        const AI = {
            run: () => {
                const i = document.getElementById('lunaix-in');
                const t = document.getElementById('lunaix-log');
                const cmd = i.value.toLowerCase();
                t.innerHTML += `<div class="log-entry">> ${i.value}</div>`;
                i.value = '';

                // Procedural Generation Logic
                if(cmd.includes('≈üehir') || cmd.includes('city')) AI.buildCity();
                else if(cmd.includes('orman') || cmd.includes('forest')) AI.buildForest();
                else if(cmd.includes('kale') || cmd.includes('castle')) AI.buildCastle();
                else AI.buildRandom(50);
            },

            buildCity: () => {
                for(let i=0; i<50; i++) { // 1000s of possibilities due to random
                    const h = 10 + Math.random()*40;
                    const w = 5 + Math.random()*10;
                    const x = (Math.random()*100)-50;
                    const z = (Math.random()*100)-50;
                    const col = Math.random()>0.5 ? 0x455A64 : 0x37474F;
                    World.addPart('box', {pos:{x,y:h/2,z}, scale:{x:w,y:h,z:w}, color:col, anchored:true, name:`Building_${i}`});
                }
            },
            buildForest: () => {
                for(let i=0; i<40; i++) {
                    const x = (Math.random()*80)-40;
                    const z = (Math.random()*80)-40;
                    World.addPart('cylinder', {pos:{x,y:2,z}, scale:{x:1,y:4}, color:0x5D4037, anchored:true}); // Trunk
                    World.addPart('wedge', {pos:{x,y:5,z}, scale:{x:4,y:4,z:4}, color:0x2E7D32, anchored:true}); // Leaves
                }
            },
            buildCastle: () => {
                // Towers
                [[10,10], [-10,10], [10,-10], [-10,-10]].forEach(p => {
                    World.addPart('cylinder', {pos:{x:p[0],y:6,z:p[1]}, scale:{x:4,y:12}, color:0x757575, anchored:true});
                });
                // Walls (Prosed√ºrel olarak aralarƒ± doldur)
                World.addPart('box', {pos:{x:0,y:4,z:10}, scale:{x:20,y:8,z:1}, color:0x616161, anchored:true});
                World.addPart('box', {pos:{x:0,y:4,z:-10}, scale:{x:20,y:8,z:1}, color:0x616161, anchored:true});
            },
            buildRandom: (count) => {
                for(let i=0; i<count; i++) {
                    const types = ['box','sphere','cylinder','wedge'];
                    const t = types[Math.floor(Math.random()*types.length)];
                    World.addPart(t, {
                        pos:{x:(Math.random()*60)-30, y:Math.random()*20, z:(Math.random()*60)-30},
                        scale:{x:Math.random()*5+1, y:Math.random()*5+1, z:Math.random()*5+1},
                        color: Math.random()*0xFFFFFF, anchored: true
                    });
                }
            }
        };

        /* --- GAMEPLAY (CHARACTER) --- */
        const Game = {
            active: false, player: null, body: null, input: {x:0, y:0, jump:false},
            
            play: () => {
                Game.active = true;
                document.getElementById('game-layer').style.display = 'block';
                document.getElementById('ribbon').style.height = '0';
                Editor.select(null);
                
                // Spawn Character (R6 Style)
                const g = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({color:0xFFD54F});
                const head = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), mat); head.position.y=1.5;
                const torso = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), new THREE.MeshStandardMaterial({color:0x1976D2}));
                g.add(head, torso);
                g.castShadow = true;
                
                // Physics Body
                const body = new CANNON.Body({
                    mass: 60, fixedRotation: true,
                    position: new CANNON.Vec3(0,10,0),
                    shape: new CANNON.Box(new CANNON.Vec3(1,2.5,0.5)),
                    linearDamping: 0.9
                });
                
                App.scene.add(g); App.world.addBody(body);
                Game.player=g; Game.body=body; g.userData={body, isPlayer:true};
            },
            
            stop: () => {
                Game.active = false;
                document.getElementById('game-layer').style.display = 'none';
                document.getElementById('ribbon').style.height = '100px';
                if(Game.player){ App.scene.remove(Game.player); App.world.removeBody(Game.body); }
                App.camera.position.set(15,15,15); App.camera.lookAt(0,0,0);
            },
            
            update: () => {
                if(!Game.body) return;
                const b = Game.body;
                const speed = 15;

                // XYZ Movement relative to camera
                const camAng = App.controls.getAzimuthalAngle();
                const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                const rgt = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), camAng);
                
                const v = new THREE.Vector3().addScaledVector(rgt, Game.input.x).addScaledVector(fwd, -Game.input.y);
                if(v.length()>0.1) {
                    v.normalize().multiplyScalar(speed);
                    b.velocity.x = v.x; b.velocity.z = v.z;
                    Game.player.rotation.y = Math.atan2(v.x, v.z); // Rotate Character
                } else {
                    b.velocity.x = 0; b.velocity.z = 0;
                }
                
                if(Game.input.jump && Math.abs(b.velocity.y)<0.5) b.velocity.y = 15;
                Game.input.jump = false;

                // Camera Follow
                App.controls.target.copy(Game.player.position);
            },
            
            initInput: () => {
                const s = document.getElementById('stick');
                const z = document.getElementById('joystick-zone');
                let drag = false;
                
                const move = (cx, cy) => {
                    const r = z.getBoundingClientRect();
                    const cX = r.left+r.width/2; const cY = r.top+r.height/2;
                    let dx = cx-cX; let dy = cy-cY;
                    const d = Math.sqrt(dx*dx+dy*dy);
                    const max = 40;
                    if(d>max){ dx=(dx/d)*max; dy=(dy/d)*max; }
                    s.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                    Game.input.x = dx/max; Game.input.y = dy/max;
                };
                
                z.addEventListener('pointerdown', e=>{drag=true; move(e.clientX, e.clientY)});
                window.addEventListener('pointermove', e=>{if(drag) move(e.clientX, e.clientY)});
                window.addEventListener('pointerup', ()=>{drag=false; s.style.transform='translate(-50%,-50%)'; Game.input.x=0; Game.input.y=0;});
                document.getElementById('jump-btn').addEventListener('pointerdown', ()=>Game.input.jump=true);
            }
        };

        /* --- UI MANAGERS --- */
        const UI = {
            setTab: (id, el) => {
                document.querySelectorAll('.ribbon-group').forEach(g=>g.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('tab-'+id).classList.add('active');
                el.classList.add('active');
            },
            togglePanel: (id) => {
                const p = document.getElementById('panel-'+id);
                if(p) p.style.display = p.style.display==='none'?'flex':'none';
                setTimeout(App.resize, 100);
            },
            toggleAI: () => {
                const w = document.getElementById('lunaix-win');
                w.style.display = w.style.display==='flex'?'none':'flex';
            },
            toggleSettings: () => {
                const m = document.getElementById('settings-modal');
                m.style.display = m.style.display==='flex'?'none':'flex';
            },
            setScale: (val) => {
                document.body.style.zoom = val;
            },
            addTreeItem: (obj) => {
                const d = document.createElement('div');
                d.className='tree-item';
                d.innerHTML = (obj.userData.anchored?'‚öì ':'üì¶ ') + obj.name;
                d.onclick = () => Editor.select(obj);
                document.getElementById('explorer-list').appendChild(d);
            },
            updateProps: (obj) => {
                const p = document.getElementById('prop-list');
                if(!obj) { p.innerHTML='<div style="padding:10px;color:#999">None</div>'; return; }
                p.innerHTML = `
                    <div><b>Name:</b> ${obj.name}</div>
                    <div><b>Pos:</b> ${obj.position.x.toFixed(1)}, ${obj.position.y.toFixed(1)}, ${obj.position.z.toFixed(1)}</div>
                    <div><b>Anchored:</b> ${obj.userData.anchored}</div>
                    <div><b>Color:</b> #${obj.material.color.getHexString()}</div>
                `;
            }
        };

        // Init
        window.onload = App.init;

    </script>
</body>
</html>
